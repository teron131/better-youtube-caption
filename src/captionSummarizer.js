(()=>{var bP=Object.create;var Pl=Object.defineProperty;var yP=Object.getOwnPropertyDescriptor;var _P=Object.getOwnPropertyNames;var wP=Object.getPrototypeOf,vP=Object.prototype.hasOwnProperty;var xP=(r,e,t)=>e in r?Pl(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var _=(r,e)=>()=>(r&&(e=r(r=0)),e);var B=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Sl=(r,e)=>{for(var t in e)Pl(r,t,{get:e[t],enumerable:!0})},AP=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of _P(e))!vP.call(r,s)&&s!==t&&Pl(r,s,{get:()=>e[s],enumerable:!(n=yP(e,s))||n.enumerable});return r};var yr=(r,e,t)=>(t=r!=null?bP(wP(r)):{},AP(e||!r||!r.__esModule?Pl(t,"default",{value:r,enumerable:!0}):t,r));var kn=(r,e,t)=>xP(r,typeof e!="symbol"?e+"":e,t);var le,Kd,R,Jr,Iu=_(()=>{(function(r){r.assertEqual=s=>{};function e(s){}r.assertIs=e;function t(s){throw new Error}r.assertNever=t,r.arrayToEnum=s=>{let i={};for(let a of s)i[a]=a;return i},r.getValidEnumValues=s=>{let i=r.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(let o of i)a[o]=s[o];return r.objectValues(a)},r.objectValues=s=>r.objectKeys(s).map(function(i){return s[i]}),r.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{let i=[];for(let a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},r.find=(s,i)=>{for(let a of s)if(i(a))return a},r.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&Number.isFinite(s)&&Math.floor(s)===s;function n(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}r.joinValues=n,r.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(le||(le={}));(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(Kd||(Kd={}));R=le.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Jr=r=>{switch(typeof r){case"undefined":return R.undefined;case"string":return R.string;case"number":return Number.isNaN(r)?R.nan:R.number;case"boolean":return R.boolean;case"function":return R.function;case"bigint":return R.bigint;case"symbol":return R.symbol;case"object":return Array.isArray(r)?R.array:r===null?R.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?R.promise:typeof Map<"u"&&r instanceof Map?R.map:typeof Set<"u"&&r instanceof Set?R.set:typeof Date<"u"&&r instanceof Date?R.date:R.object;default:return R.unknown}}});var O,EP,$t,Il=_(()=>{Iu();O=le.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),EP=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:"),$t=class r extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(i){return i.message},n={_errors:[]},s=i=>{for(let a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)n._errors.push(t(a));else{let o=n,u=0;for(;u<a.path.length;){let c=a.path[u];u===a.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(a))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return s(this),n}static assert(e){if(!(e instanceof r))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,le.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},n=[];for(let s of this.issues)if(s.path.length>0){let i=s.path[0];t[i]=t[i]||[],t[i].push(e(s))}else n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}};$t.create=r=>new $t(r)});var OP,Cn,Hd=_(()=>{Il();Iu();OP=(r,e)=>{let t;switch(r.code){case O.invalid_type:r.received===R.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case O.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,le.jsonStringifyReplacer)}`;break;case O.unrecognized_keys:t=`Unrecognized key(s) in object: ${le.joinValues(r.keys,", ")}`;break;case O.invalid_union:t="Invalid input";break;case O.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${le.joinValues(r.options)}`;break;case O.invalid_enum_value:t=`Invalid enum value. Expected ${le.joinValues(r.options)}, received '${r.received}'`;break;case O.invalid_arguments:t="Invalid function arguments";break;case O.invalid_return_type:t="Invalid function return type";break;case O.invalid_date:t="Invalid date";break;case O.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:le.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case O.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="bigint"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case O.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case O.custom:t="Invalid input";break;case O.invalid_intersection_types:t="Intersection results could not be merged";break;case O.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case O.not_finite:t="Number must be finite";break;default:t=e.defaultError,le.assertNever(r)}return{message:t}},Cn=OP});function PP(r){By=r}function Ra(){return By}var By,Tl=_(()=>{Hd();By=Cn});function T(r,e){let t=Ra(),n=Tu({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===Cn?void 0:Cn].filter(s=>!!s)});r.common.issues.push(n)}var Tu,SP,tt,q,ci,ut,kl,Cl,ds,Na,Wd=_(()=>{Tl();Hd();Tu=r=>{let{data:e,path:t,errorMaps:n,issueData:s}=r,i=[...t,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="",u=n.filter(c=>!!c).slice().reverse();for(let c of u)o=c(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}},SP=[];tt=class r{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let n=[];for(let s of t){if(s.status==="aborted")return q;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){let n=[];for(let s of t){let i=await s.key,a=await s.value;n.push({key:i,value:a})}return r.mergeObjectSync(e,n)}static mergeObjectSync(e,t){let n={};for(let s of t){let{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return q;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}},q=Object.freeze({status:"aborted"}),ci=r=>({status:"dirty",value:r}),ut=r=>({status:"valid",value:r}),kl=r=>r.status==="aborted",Cl=r=>r.status==="dirty",ds=r=>r.status==="valid",Na=r=>typeof Promise<"u"&&r instanceof Promise});var Vy=_(()=>{});var U,Gy=_(()=>{(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e?.message})(U||(U={}))});function ie(r){if(!r)return{};let{errorMap:e,invalid_type_error:t,required_error:n,description:s}=r;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{let{message:u}=r;return a.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:u??n??o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:u??t??o.defaultError}},description:s}}function Hy(r){let e="[0-5]\\d";r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`);let t=r.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function GP(r){return new RegExp(`^${Hy(r)}$`)}function Wy(r){let e=`${Ky}T${Hy(r)}`,t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function ZP(r,e){return!!((e==="v4"||!e)&&zP.test(r)||(e==="v6"||!e)&&DP.test(r))}function qP(r,e){if(!NP.test(r))return!1;try{let[t]=r.split(".");if(!t)return!1;let n=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||"typ"in s&&s?.typ!=="JWT"||!s.alg||e&&s.alg!==e)}catch{return!1}}function KP(r,e){return!!((e==="v4"||!e)&&LP.test(r)||(e==="v6"||!e)&&FP.test(r))}function HP(r,e){let t=(r.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=t>n?t:n,i=Number.parseInt(r.toFixed(s).replace(".","")),a=Number.parseInt(e.toFixed(s).replace(".",""));return i%a/10**s}function $a(r){if(r instanceof jt){let e={};for(let t in r.shape){let n=r.shape[t];e[t]=Qt.create($a(n))}return new jt({...r._def,shape:()=>e})}else return r instanceof $n?new $n({...r._def,type:$a(r.element)}):r instanceof Qt?Qt.create($a(r.unwrap())):r instanceof Xr?Xr.create($a(r.unwrap())):r instanceof Yr?Yr.create(r.items.map(e=>$a(e))):r}function Yd(r,e){let t=Jr(r),n=Jr(e);if(r===e)return{valid:!0,data:r};if(t===R.object&&n===R.object){let s=le.objectKeys(e),i=le.objectKeys(r).filter(o=>s.indexOf(o)!==-1),a={...r,...e};for(let o of i){let u=Yd(r[o],e[o]);if(!u.valid)return{valid:!1};a[o]=u.data}return{valid:!0,data:a}}else if(t===R.array&&n===R.array){if(r.length!==e.length)return{valid:!1};let s=[];for(let i=0;i<r.length;i++){let a=r[i],o=e[i],u=Yd(a,o);if(!u.valid)return{valid:!1};s.push(u.data)}return{valid:!0,data:s}}else return t===R.date&&n===R.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}function Jy(r,e){return new wi({values:r,typeName:v.ZodEnum,...ie(e)})}function qy(r,e){let t=typeof r=="function"?r(e):typeof r=="string"?{message:r}:r;return typeof t=="string"?{message:t}:t}function Yy(r,e={},t){return r?ms.create().superRefine((n,s)=>{let i=r(n);if(i instanceof Promise)return i.then(a=>{if(!a){let o=qy(e,n),u=o.fatal??t??!0;s.addIssue({code:"custom",...o,fatal:u})}});if(!i){let a=qy(e,n),o=a.fatal??t??!0;s.addIssue({code:"custom",...a,fatal:o})}}):ms.create()}var er,Zy,ae,IP,TP,kP,CP,RP,NP,$P,jP,MP,Jd,zP,LP,DP,FP,UP,BP,Ky,VP,hs,li,fi,pi,di,ja,hi,mi,ms,Nn,_r,Ma,$n,jt,gi,Rn,Rl,bi,Yr,Nl,za,La,$l,yi,_i,wi,vi,gs,tr,Qt,Xr,xi,Ai,Da,WP,ku,Cu,Ei,JP,v,YP,wr,jl,XP,QP,Ml,eS,tS,rS,nS,Xd,sS,iS,aS,zl,Fa,oS,uS,cS,lS,fS,pS,dS,hS,mS,gS,bS,Qd,yS,_S,wS,vS,xS,AS,ES,OS,PS,SS,IS,TS,Xy=_(()=>{Il();Tl();Gy();Wd();Iu();er=class{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Zy=(r,e)=>{if(ds(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new $t(r.common.issues);return this._error=t,this._error}}};ae=class{get description(){return this._def.description}_getType(e){return Jr(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Jr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new tt,ctx:{common:e.parent.common,data:e.data,parsedType:Jr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(Na(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){let n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Jr(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Zy(n,s)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Jr(e)};if(!this["~standard"].async)try{let n=this._parseSync({data:e,path:[],parent:t});return ds(n)?{value:n.value}:{issues:t.common.issues}}catch(n){n?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(n=>ds(n)?{value:n.value}:{issues:t.common.issues})}async parseAsync(e,t){let n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){let n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Jr(e)},s=this._parse({data:e,path:n.path,parent:n}),i=await(Na(s)?s:Promise.resolve(s));return Zy(n,i)}refine(e,t){let n=s=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,i)=>{let a=e(s),o=()=>i.addIssue({code:O.custom,...n(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(u=>u?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,t){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof t=="function"?t(n,s):t),!1))}_refinement(e){return new tr({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Qt.create(this,this._def)}nullable(){return Xr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return $n.create(this)}promise(){return gs.create(this,this._def)}or(e){return gi.create([this,e],this._def)}and(e){return bi.create(this,e,this._def)}transform(e){return new tr({...ie(this._def),schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new xi({...ie(this._def),innerType:this,defaultValue:t,typeName:v.ZodDefault})}brand(){return new ku({typeName:v.ZodBranded,type:this,...ie(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new Ai({...ie(this._def),innerType:this,catchValue:t,typeName:v.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Cu.create(this,e)}readonly(){return Ei.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},IP=/^c[^\s-]{8,}$/i,TP=/^[0-9a-z]+$/,kP=/^[0-9A-HJKMNP-TV-Z]{26}$/i,CP=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,RP=/^[a-z0-9_-]{21}$/i,NP=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,$P=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,jP=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,MP="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",zP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,LP=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,DP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,FP=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,UP=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,BP=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ky="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",VP=new RegExp(`^${Ky}$`);hs=class r extends ae{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==R.string){let i=this._getOrReturnCtx(e);return T(i,{code:O.invalid_type,expected:R.string,received:i.parsedType}),q}let n=new tt,s;for(let i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),T(s,{code:O.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),T(s,{code:O.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){let a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?T(s,{code:O.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&T(s,{code:O.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")jP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"email",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")Jd||(Jd=new RegExp(MP,"u")),Jd.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"emoji",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")CP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"uuid",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")RP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"nanoid",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")IP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"cuid",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")TP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"cuid2",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")kP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"ulid",code:O.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),T(s,{validation:"url",code:O.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"regex",code:O.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?Wy(i).test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?VP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?GP(i).test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{code:O.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?$P.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"duration",code:O.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?ZP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"ip",code:O.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?qP(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"jwt",code:O.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?KP(e.data,i.version)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"cidr",code:O.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?UP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"base64",code:O.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?BP.test(e.data)||(s=this._getOrReturnCtx(e,s),T(s,{validation:"base64url",code:O.invalid_string,message:i.message}),n.dirty()):le.assertNever(i);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(s=>e.test(s),{validation:t,code:O.invalid_string,...U.errToObj(n)})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...U.errToObj(e)})}url(e){return this._addCheck({kind:"url",...U.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...U.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...U.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...U.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...U.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...U.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...U.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...U.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...U.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...U.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...U.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...U.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...U.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...U.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...U.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...U.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...U.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...U.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...U.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...U.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...U.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...U.errToObj(t)})}nonempty(e){return this.min(1,U.errToObj(e))}trim(){return new r({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new r({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new r({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};hs.create=r=>new hs({checks:[],typeName:v.ZodString,coerce:r?.coerce??!1,...ie(r)});li=class r extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==R.number){let i=this._getOrReturnCtx(e);return T(i,{code:O.invalid_type,expected:R.number,received:i.parsedType}),q}let n,s=new tt;for(let i of this._def.checks)i.kind==="int"?le.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),T(n,{code:O.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?HP(e.data,i.value)!==0&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),T(n,{code:O.not_finite,message:i.message}),s.dirty()):le.assertNever(i);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,U.toString(t))}gt(e,t){return this.setLimit("min",e,!1,U.toString(t))}lte(e,t){return this.setLimit("max",e,!0,U.toString(t))}lt(e,t){return this.setLimit("max",e,!1,U.toString(t))}setLimit(e,t,n,s){return new r({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:U.toString(s)}]})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:U.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:U.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:U.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:U.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:U.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:U.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:U.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:U.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:U.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&le.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}};li.create=r=>new li({checks:[],typeName:v.ZodNumber,coerce:r?.coerce||!1,...ie(r)});fi=class r extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==R.bigint)return this._getInvalidInput(e);let n,s=new tt;for(let i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),T(n,{code:O.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):le.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return T(t,{code:O.invalid_type,expected:R.bigint,received:t.parsedType}),q}gte(e,t){return this.setLimit("min",e,!0,U.toString(t))}gt(e,t){return this.setLimit("min",e,!1,U.toString(t))}lte(e,t){return this.setLimit("max",e,!0,U.toString(t))}lt(e,t){return this.setLimit("max",e,!1,U.toString(t))}setLimit(e,t,n,s){return new r({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:U.toString(s)}]})}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:U.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:U.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:U.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:U.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:U.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};fi.create=r=>new fi({checks:[],typeName:v.ZodBigInt,coerce:r?.coerce??!1,...ie(r)});pi=class extends ae{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==R.boolean){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.boolean,received:n.parsedType}),q}return ut(e.data)}};pi.create=r=>new pi({typeName:v.ZodBoolean,coerce:r?.coerce||!1,...ie(r)});di=class r extends ae{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==R.date){let i=this._getOrReturnCtx(e);return T(i,{code:O.invalid_type,expected:R.date,received:i.parsedType}),q}if(Number.isNaN(e.data.getTime())){let i=this._getOrReturnCtx(e);return T(i,{code:O.invalid_date}),q}let n=new tt,s;for(let i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),T(s,{code:O.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),T(s,{code:O.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):le.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new r({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:U.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:U.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};di.create=r=>new di({checks:[],coerce:r?.coerce||!1,typeName:v.ZodDate,...ie(r)});ja=class extends ae{_parse(e){if(this._getType(e)!==R.symbol){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.symbol,received:n.parsedType}),q}return ut(e.data)}};ja.create=r=>new ja({typeName:v.ZodSymbol,...ie(r)});hi=class extends ae{_parse(e){if(this._getType(e)!==R.undefined){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.undefined,received:n.parsedType}),q}return ut(e.data)}};hi.create=r=>new hi({typeName:v.ZodUndefined,...ie(r)});mi=class extends ae{_parse(e){if(this._getType(e)!==R.null){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.null,received:n.parsedType}),q}return ut(e.data)}};mi.create=r=>new mi({typeName:v.ZodNull,...ie(r)});ms=class extends ae{constructor(){super(...arguments),this._any=!0}_parse(e){return ut(e.data)}};ms.create=r=>new ms({typeName:v.ZodAny,...ie(r)});Nn=class extends ae{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ut(e.data)}};Nn.create=r=>new Nn({typeName:v.ZodUnknown,...ie(r)});_r=class extends ae{_parse(e){let t=this._getOrReturnCtx(e);return T(t,{code:O.invalid_type,expected:R.never,received:t.parsedType}),q}};_r.create=r=>new _r({typeName:v.ZodNever,...ie(r)});Ma=class extends ae{_parse(e){if(this._getType(e)!==R.undefined){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.void,received:n.parsedType}),q}return ut(e.data)}};Ma.create=r=>new Ma({typeName:v.ZodVoid,...ie(r)});$n=class r extends ae{_parse(e){let{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==R.array)return T(t,{code:O.invalid_type,expected:R.array,received:t.parsedType}),q;if(s.exactLength!==null){let a=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(a||o)&&(T(t,{code:a?O.too_big:O.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(T(t,{code:O.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(T(t,{code:O.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((a,o)=>s.type._parseAsync(new er(t,a,t.path,o)))).then(a=>tt.mergeArray(n,a));let i=[...t.data].map((a,o)=>s.type._parseSync(new er(t,a,t.path,o)));return tt.mergeArray(n,i)}get element(){return this._def.type}min(e,t){return new r({...this._def,minLength:{value:e,message:U.toString(t)}})}max(e,t){return new r({...this._def,maxLength:{value:e,message:U.toString(t)}})}length(e,t){return new r({...this._def,exactLength:{value:e,message:U.toString(t)}})}nonempty(e){return this.min(1,e)}};$n.create=(r,e)=>new $n({type:r,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...ie(e)});jt=class r extends ae{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=le.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==R.object){let c=this._getOrReturnCtx(e);return T(c,{code:O.invalid_type,expected:R.object,received:c.parsedType}),q}let{status:n,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof _r&&this._def.unknownKeys==="strip"))for(let c in s.data)a.includes(c)||o.push(c);let u=[];for(let c of a){let l=i[c],f=s.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new er(s,f,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof _r){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(c==="strict")o.length>0&&(T(s,{code:O.unrecognized_keys,keys:o}),n.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of o){let f=s.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new er(s,f,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let f=await l.key,p=await l.value;c.push({key:f,value:p,alwaysSet:l.alwaysSet})}return c}).then(c=>tt.mergeObjectSync(n,c)):tt.mergeObjectSync(n,u)}get shape(){return this._def.shape()}strict(e){return U.errToObj,new r({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{let s=this._def.errorMap?.(t,n).message??n.defaultError;return t.code==="unrecognized_keys"?{message:U.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new r({...this._def,unknownKeys:"strip"})}passthrough(){return new r({...this._def,unknownKeys:"passthrough"})}extend(e){return new r({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new r({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:v.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new r({...this._def,catchall:e})}pick(e){let t={};for(let n of le.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new r({...this._def,shape:()=>t})}omit(e){let t={};for(let n of le.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new r({...this._def,shape:()=>t})}deepPartial(){return $a(this)}partial(e){let t={};for(let n of le.objectKeys(this.shape)){let s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new r({...this._def,shape:()=>t})}required(e){let t={};for(let n of le.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof Qt;)i=i._def.innerType;t[n]=i}return new r({...this._def,shape:()=>t})}keyof(){return Jy(le.objectKeys(this.shape))}};jt.create=(r,e)=>new jt({shape:()=>r,unknownKeys:"strip",catchall:_r.create(),typeName:v.ZodObject,...ie(e)});jt.strictCreate=(r,e)=>new jt({shape:()=>r,unknownKeys:"strict",catchall:_r.create(),typeName:v.ZodObject,...ie(e)});jt.lazycreate=(r,e)=>new jt({shape:r,unknownKeys:"strip",catchall:_r.create(),typeName:v.ZodObject,...ie(e)});gi=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),n=this._def.options;function s(i){for(let o of i)if(o.result.status==="valid")return o.result;for(let o of i)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let a=i.map(o=>new $t(o.ctx.common.issues));return T(t,{code:O.invalid_union,unionErrors:a}),q}if(t.common.async)return Promise.all(n.map(async i=>{let a={...t,common:{...t.common,issues:[]},parent:null};return{result:await i._parseAsync({data:t.data,path:t.path,parent:a}),ctx:a}})).then(s);{let i,a=[];for(let u of n){let c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!i&&(i={result:l,ctx:c}),c.common.issues.length&&a.push(c.common.issues)}if(i)return t.common.issues.push(...i.ctx.common.issues),i.result;let o=a.map(u=>new $t(u));return T(t,{code:O.invalid_union,unionErrors:o}),q}}get options(){return this._def.options}};gi.create=(r,e)=>new gi({options:r,typeName:v.ZodUnion,...ie(e)});Rn=r=>r instanceof yi?Rn(r.schema):r instanceof tr?Rn(r.innerType()):r instanceof _i?[r.value]:r instanceof wi?r.options:r instanceof vi?le.objectValues(r.enum):r instanceof xi?Rn(r._def.innerType):r instanceof hi?[void 0]:r instanceof mi?[null]:r instanceof Qt?[void 0,...Rn(r.unwrap())]:r instanceof Xr?[null,...Rn(r.unwrap())]:r instanceof ku||r instanceof Ei?Rn(r.unwrap()):r instanceof Ai?Rn(r._def.innerType):[],Rl=class r extends ae{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.object)return T(t,{code:O.invalid_type,expected:R.object,received:t.parsedType}),q;let n=this.discriminator,s=t.data[n],i=this.optionsMap.get(s);return i?t.common.async?i._parseAsync({data:t.data,path:t.path,parent:t}):i._parseSync({data:t.data,path:t.path,parent:t}):(T(t,{code:O.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),q)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){let s=new Map;for(let i of t){let a=Rn(i.shape[e]);if(!a.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of a){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,i)}}return new r({typeName:v.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...ie(n)})}};bi=class extends ae{_parse(e){let{status:t,ctx:n}=this._processInputParams(e),s=(i,a)=>{if(kl(i)||kl(a))return q;let o=Yd(i.value,a.value);return o.valid?((Cl(i)||Cl(a))&&t.dirty(),{status:t.value,value:o.data}):(T(n,{code:O.invalid_intersection_types}),q)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}};bi.create=(r,e,t)=>new bi({left:r,right:e,typeName:v.ZodIntersection,...ie(t)});Yr=class r extends ae{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.array)return T(n,{code:O.invalid_type,expected:R.array,received:n.parsedType}),q;if(n.data.length<this._def.items.length)return T(n,{code:O.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),q;!this._def.rest&&n.data.length>this._def.items.length&&(T(n,{code:O.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let i=[...n.data].map((a,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new er(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>tt.mergeArray(t,a)):tt.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new r({...this._def,rest:e})}};Yr.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Yr({items:r,typeName:v.ZodTuple,rest:null,...ie(e)})};Nl=class r extends ae{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.object)return T(n,{code:O.invalid_type,expected:R.object,received:n.parsedType}),q;let s=[],i=this._def.keyType,a=this._def.valueType;for(let o in n.data)s.push({key:i._parse(new er(n,o,n.path,o)),value:a._parse(new er(n,n.data[o],n.path,o)),alwaysSet:o in n.data});return n.common.async?tt.mergeObjectAsync(t,s):tt.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof ae?new r({keyType:e,valueType:t,typeName:v.ZodRecord,...ie(n)}):new r({keyType:hs.create(),valueType:e,typeName:v.ZodRecord,...ie(t)})}},za=class extends ae{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.map)return T(n,{code:O.invalid_type,expected:R.map,received:n.parsedType}),q;let s=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,u],c)=>({key:s._parse(new er(n,o,n.path,[c,"key"])),value:i._parse(new er(n,u,n.path,[c,"value"]))}));if(n.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of a){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return q;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of a){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return q;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}};za.create=(r,e,t)=>new za({valueType:e,keyType:r,typeName:v.ZodMap,...ie(t)});La=class r extends ae{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==R.set)return T(n,{code:O.invalid_type,expected:R.set,received:n.parsedType}),q;let s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&(T(n,{code:O.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&(T(n,{code:O.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());let i=this._def.valueType;function a(u){let c=new Set;for(let l of u){if(l.status==="aborted")return q;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}let o=[...n.data.values()].map((u,c)=>i._parse(new er(n,u,n.path,c)));return n.common.async?Promise.all(o).then(u=>a(u)):a(o)}min(e,t){return new r({...this._def,minSize:{value:e,message:U.toString(t)}})}max(e,t){return new r({...this._def,maxSize:{value:e,message:U.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};La.create=(r,e)=>new La({valueType:r,minSize:null,maxSize:null,typeName:v.ZodSet,...ie(e)});$l=class r extends ae{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.function)return T(t,{code:O.invalid_type,expected:R.function,received:t.parsedType}),q;function n(o,u){return Tu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ra(),Cn].filter(c=>!!c),issueData:{code:O.invalid_arguments,argumentsError:u}})}function s(o,u){return Tu({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Ra(),Cn].filter(c=>!!c),issueData:{code:O.invalid_return_type,returnTypeError:u}})}let i={errorMap:t.common.contextualErrorMap},a=t.data;if(this._def.returns instanceof gs){let o=this;return ut(async function(...u){let c=new $t([]),l=await o._def.args.parseAsync(u,i).catch(d=>{throw c.addIssue(n(u,d)),c}),f=await Reflect.apply(a,this,l);return await o._def.returns._def.type.parseAsync(f,i).catch(d=>{throw c.addIssue(s(f,d)),c})})}else{let o=this;return ut(function(...u){let c=o._def.args.safeParse(u,i);if(!c.success)throw new $t([n(u,c.error)]);let l=Reflect.apply(a,this,c.data),f=o._def.returns.safeParse(l,i);if(!f.success)throw new $t([s(l,f.error)]);return f.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new r({...this._def,args:Yr.create(e).rest(Nn.create())})}returns(e){return new r({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new r({args:e||Yr.create([]).rest(Nn.create()),returns:t||Nn.create(),typeName:v.ZodFunction,...ie(n)})}},yi=class extends ae{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};yi.create=(r,e)=>new yi({getter:r,typeName:v.ZodLazy,...ie(e)});_i=class extends ae{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return T(t,{received:t.data,code:O.invalid_literal,expected:this._def.value}),q}return{status:"valid",value:e.data}}get value(){return this._def.value}};_i.create=(r,e)=>new _i({value:r,typeName:v.ZodLiteral,...ie(e)});wi=class r extends ae{_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),n=this._def.values;return T(t,{expected:le.joinValues(n),received:t.parsedType,code:O.invalid_type}),q}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let t=this._getOrReturnCtx(e),n=this._def.values;return T(t,{received:t.data,code:O.invalid_enum_value,options:n}),q}return ut(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return r.create(e,{...this._def,...t})}exclude(e,t=this._def){return r.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}};wi.create=Jy;vi=class extends ae{_parse(e){let t=le.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==R.string&&n.parsedType!==R.number){let s=le.objectValues(t);return T(n,{expected:le.joinValues(s),received:n.parsedType,code:O.invalid_type}),q}if(this._cache||(this._cache=new Set(le.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let s=le.objectValues(t);return T(n,{received:n.data,code:O.invalid_enum_value,options:s}),q}return ut(e.data)}get enum(){return this._def.values}};vi.create=(r,e)=>new vi({values:r,typeName:v.ZodNativeEnum,...ie(e)});gs=class extends ae{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==R.promise&&t.common.async===!1)return T(t,{code:O.invalid_type,expected:R.promise,received:t.parsedType}),q;let n=t.parsedType===R.promise?t.data:Promise.resolve(t.data);return ut(n.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}};gs.create=(r,e)=>new gs({type:r,typeName:v.ZodPromise,...ie(e)});tr=class extends ae{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{T(n,a),a.fatal?t.abort():t.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){let a=s.transform(n.data,i);if(n.common.async)return Promise.resolve(a).then(async o=>{if(t.value==="aborted")return q;let u=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return u.status==="aborted"?q:u.status==="dirty"?ci(u.value):t.value==="dirty"?ci(u.value):u});{if(t.value==="aborted")return q;let o=this._def.schema._parseSync({data:a,path:n.path,parent:n});return o.status==="aborted"?q:o.status==="dirty"?ci(o.value):t.value==="dirty"?ci(o.value):o}}if(s.type==="refinement"){let a=o=>{let u=s.refinement(o,i);if(n.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){let o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?q:(o.status==="dirty"&&t.dirty(),a(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?q:(o.status==="dirty"&&t.dirty(),a(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){let a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!ds(a))return q;let o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>ds(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:t.value,value:o})):q);le.assertNever(s)}};tr.create=(r,e,t)=>new tr({schema:r,typeName:v.ZodEffects,effect:e,...ie(t)});tr.createWithPreprocess=(r,e,t)=>new tr({schema:e,effect:{type:"preprocess",transform:r},typeName:v.ZodEffects,...ie(t)});Qt=class extends ae{_parse(e){return this._getType(e)===R.undefined?ut(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Qt.create=(r,e)=>new Qt({innerType:r,typeName:v.ZodOptional,...ie(e)});Xr=class extends ae{_parse(e){return this._getType(e)===R.null?ut(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Xr.create=(r,e)=>new Xr({innerType:r,typeName:v.ZodNullable,...ie(e)});xi=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),n=t.data;return t.parsedType===R.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};xi.create=(r,e)=>new xi({innerType:r,typeName:v.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...ie(e)});Ai=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Na(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new $t(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new $t(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}};Ai.create=(r,e)=>new Ai({innerType:r,typeName:v.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...ie(e)});Da=class extends ae{_parse(e){if(this._getType(e)!==R.nan){let n=this._getOrReturnCtx(e);return T(n,{code:O.invalid_type,expected:R.nan,received:n.parsedType}),q}return{status:"valid",value:e.data}}};Da.create=r=>new Da({typeName:v.ZodNaN,...ie(r)});WP=Symbol("zod_brand"),ku=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}},Cu=class r extends ae{_parse(e){let{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{let i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?q:i.status==="dirty"?(t.dirty(),ci(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{let s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?q:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,t){return new r({in:e,out:t,typeName:v.ZodPipeline})}},Ei=class extends ae{_parse(e){let t=this._def.innerType._parse(e),n=s=>(ds(s)&&(s.value=Object.freeze(s.value)),s);return Na(t)?t.then(s=>n(s)):n(t)}unwrap(){return this._def.innerType}};Ei.create=(r,e)=>new Ei({innerType:r,typeName:v.ZodReadonly,...ie(e)});JP={object:jt.lazycreate};(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(v||(v={}));YP=(r,e={message:`Input not instance of ${r.name}`})=>Yy(t=>t instanceof r,e),wr=hs.create,jl=li.create,XP=Da.create,QP=fi.create,Ml=pi.create,eS=di.create,tS=ja.create,rS=hi.create,nS=mi.create,Xd=ms.create,sS=Nn.create,iS=_r.create,aS=Ma.create,zl=$n.create,Fa=jt.create,oS=jt.strictCreate,uS=gi.create,cS=Rl.create,lS=bi.create,fS=Yr.create,pS=Nl.create,dS=za.create,hS=La.create,mS=$l.create,gS=yi.create,bS=_i.create,Qd=wi.create,yS=vi.create,_S=gs.create,wS=tr.create,vS=Qt.create,xS=Xr.create,AS=tr.createWithPreprocess,ES=Cu.create,OS=()=>wr().optional(),PS=()=>jl().optional(),SS=()=>Ml().optional(),IS={string:r=>hs.create({...r,coerce:!0}),number:r=>li.create({...r,coerce:!0}),boolean:r=>pi.create({...r,coerce:!0}),bigint:r=>fi.create({...r,coerce:!0}),date:r=>di.create({...r,coerce:!0})},TS=q});var Se={};Sl(Se,{BRAND:()=>WP,DIRTY:()=>ci,EMPTY_PATH:()=>SP,INVALID:()=>q,NEVER:()=>TS,OK:()=>ut,ParseStatus:()=>tt,Schema:()=>ae,ZodAny:()=>ms,ZodArray:()=>$n,ZodBigInt:()=>fi,ZodBoolean:()=>pi,ZodBranded:()=>ku,ZodCatch:()=>Ai,ZodDate:()=>di,ZodDefault:()=>xi,ZodDiscriminatedUnion:()=>Rl,ZodEffects:()=>tr,ZodEnum:()=>wi,ZodError:()=>$t,ZodFirstPartyTypeKind:()=>v,ZodFunction:()=>$l,ZodIntersection:()=>bi,ZodIssueCode:()=>O,ZodLazy:()=>yi,ZodLiteral:()=>_i,ZodMap:()=>za,ZodNaN:()=>Da,ZodNativeEnum:()=>vi,ZodNever:()=>_r,ZodNull:()=>mi,ZodNullable:()=>Xr,ZodNumber:()=>li,ZodObject:()=>jt,ZodOptional:()=>Qt,ZodParsedType:()=>R,ZodPipeline:()=>Cu,ZodPromise:()=>gs,ZodReadonly:()=>Ei,ZodRecord:()=>Nl,ZodSchema:()=>ae,ZodSet:()=>La,ZodString:()=>hs,ZodSymbol:()=>ja,ZodTransformer:()=>tr,ZodTuple:()=>Yr,ZodType:()=>ae,ZodUndefined:()=>hi,ZodUnion:()=>gi,ZodUnknown:()=>Nn,ZodVoid:()=>Ma,addIssueToContext:()=>T,any:()=>Xd,array:()=>zl,bigint:()=>QP,boolean:()=>Ml,coerce:()=>IS,custom:()=>Yy,date:()=>eS,datetimeRegex:()=>Wy,defaultErrorMap:()=>Cn,discriminatedUnion:()=>cS,effect:()=>wS,enum:()=>Qd,function:()=>mS,getErrorMap:()=>Ra,getParsedType:()=>Jr,instanceof:()=>YP,intersection:()=>lS,isAborted:()=>kl,isAsync:()=>Na,isDirty:()=>Cl,isValid:()=>ds,late:()=>JP,lazy:()=>gS,literal:()=>bS,makeIssue:()=>Tu,map:()=>dS,nan:()=>XP,nativeEnum:()=>yS,never:()=>iS,null:()=>nS,nullable:()=>xS,number:()=>jl,object:()=>Fa,objectUtil:()=>Kd,oboolean:()=>SS,onumber:()=>PS,optional:()=>vS,ostring:()=>OS,pipeline:()=>ES,preprocess:()=>AS,promise:()=>_S,quotelessJson:()=>EP,record:()=>pS,set:()=>hS,setErrorMap:()=>PP,strictObject:()=>oS,string:()=>wr,symbol:()=>tS,transformer:()=>wS,tuple:()=>fS,undefined:()=>rS,union:()=>uS,unknown:()=>sS,util:()=>le,void:()=>aS});var Ru=_(()=>{Tl();Wd();Vy();Iu();Xy();Il()});var Ll=_(()=>{Ru();Ru()});var e_=B((sz,Qy)=>{function rr(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Qy.exports=rr;rr.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};rr.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};rr.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};rr.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};rr.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};rr.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};rr.prototype.start=rr.prototype.try;rr.prototype.errors=function(){return this._errors};rr.prototype.attempts=function(){return this._attempts};rr.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var s=this._errors[n],i=s.message,a=(r[i]||0)+1;r[i]=a,a>=t&&(e=s,t=a)}return e}});var t_=B(Oi=>{var kS=e_();Oi.operation=function(r){var e=Oi.timeouts(r);return new kS(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};Oi.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],s=0;s<e.retries;s++)n.push(this.createTimeout(s,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(s,e)),n.sort(function(i,a){return i-a}),n};Oi.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};Oi.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var s=0;s<t.length;s++){var i=t[s],a=r[i];r[i]=function(u){var c=Oi.operation(e),l=Array.prototype.slice.call(arguments,1),f=l.pop();l.push(function(p){c.retry(p)||(p&&(arguments[0]=c.mainError()),f.apply(this,arguments))}),c.attempt(function(){u.apply(r,l)})}.bind(r,a),r[i].options=e}}});var n_=B((az,r_)=>{r_.exports=t_()});var Ul=B((oz,Fl)=>{"use strict";var CS=n_(),RS=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Dl=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},NS=(r,e,t)=>{let n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r},$S=r=>RS.includes(r),s_=(r,e)=>new Promise((t,n)=>{e={onFailedAttempt:()=>{},retries:10,...e};let s=CS.operation(e);s.attempt(async i=>{try{t(await r(i))}catch(a){if(!(a instanceof Error)){n(new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`));return}if(a instanceof Dl)s.stop(),n(a.originalError);else if(a instanceof TypeError&&!$S(a.message))s.stop(),n(a);else{NS(a,i,e);try{await e.onFailedAttempt(a)}catch(o){n(o);return}s.retry(a)||n(s.mainError())}}})});Fl.exports=s_;Fl.exports.default=s_;Fl.exports.AbortError=Dl});var i_,a_=_(()=>{i_=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function jS(r){return typeof r=="string"&&i_.test(r)}var Gt,eh=_(()=>{a_();Gt=jS});function MS(r){if(!Gt(r))throw TypeError("Invalid UUID");var e,t=new Uint8Array(16);return t[0]=(e=parseInt(r.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(r.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(r.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(r.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(r.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}var Bl,th=_(()=>{eh();Bl=MS});function Qr(r,e=0){return(rt[r[e+0]]+rt[r[e+1]]+rt[r[e+2]]+rt[r[e+3]]+"-"+rt[r[e+4]]+rt[r[e+5]]+"-"+rt[r[e+6]]+rt[r[e+7]]+"-"+rt[r[e+8]]+rt[r[e+9]]+"-"+rt[r[e+10]]+rt[r[e+11]]+rt[r[e+12]]+rt[r[e+13]]+rt[r[e+14]]+rt[r[e+15]]).toLowerCase()}var rt,Vl,Ua=_(()=>{rt=[];for(Vl=0;Vl<256;++Vl)rt.push((Vl+256).toString(16).slice(1))});function Nu(){if(!Gl&&(Gl=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Gl))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Gl(zS)}var Gl,zS,rh=_(()=>{zS=new Uint8Array(16)});function LS(r,e,t){var n=e&&t||0,s=e||new Array(16);r=r||{};var i=r.node,a=r.clockseq;if(r._v6||(i||(i=nh),a==null&&(a=Zl)),i==null||a==null){var o=r.random||(r.rng||Nu)();i==null&&(i=[o[0],o[1],o[2],o[3],o[4],o[5]],!nh&&!r._v6&&(i[0]|=1,nh=i)),a==null&&(a=(o[6]<<8|o[7])&16383,Zl===void 0&&!r._v6&&(Zl=a))}var u=r.msecs!==void 0?r.msecs:Date.now(),c=r.nsecs!==void 0?r.nsecs:ih+1,l=u-sh+(c-ih)/1e4;if(l<0&&r.clockseq===void 0&&(a=a+1&16383),(l<0||u>sh)&&r.nsecs===void 0&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");sh=u,ih=c,Zl=a,u+=122192928e5;var f=((u&268435455)*1e4+c)%4294967296;s[n++]=f>>>24&255,s[n++]=f>>>16&255,s[n++]=f>>>8&255,s[n++]=f&255;var p=u/4294967296*1e4&268435455;s[n++]=p>>>8&255,s[n++]=p&255,s[n++]=p>>>24&15|16,s[n++]=p>>>16&255,s[n++]=a>>>8|128,s[n++]=a&255;for(var d=0;d<6;++d)s[n+d]=i[d];return e||Qr(s)}var nh,Zl,sh,ih,o_,u_=_(()=>{rh();Ua();sh=0,ih=0;o_=LS});function ah(r){var e=typeof r=="string"?Bl(r):r,t=DS(e);return typeof r=="string"?Qr(t):t}function DS(r,e=!1){return Uint8Array.of((r[6]&15)<<4|r[7]>>4&15,(r[7]&15)<<4|(r[4]&240)>>4,(r[4]&15)<<4|(r[5]&240)>>4,(r[5]&15)<<4|(r[0]&240)>>4,(r[0]&15)<<4|(r[1]&240)>>4,(r[1]&15)<<4|(r[2]&240)>>4,96|r[2]&15,r[3],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}var c_=_(()=>{th();Ua()});function FS(r){r=unescape(encodeURIComponent(r));for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e}function oh(r,e,t){function n(s,i,a,o){var u;if(typeof s=="string"&&(s=FS(s)),typeof i=="string"&&(i=Bl(i)),((u=i)===null||u===void 0?void 0:u.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+s.length);if(c.set(i),c.set(s,i.length),c=t(c),c[6]=c[6]&15|e,c[8]=c[8]&63|128,a){o=o||0;for(var l=0;l<16;++l)a[o+l]=c[l];return a}return Qr(c)}try{n.name=r}catch{}return n.DNS=US,n.URL=BS,n}var US,BS,l_=_(()=>{Ua();th();US="6ba7b810-9dad-11d1-80b4-00c04fd430c8",BS="6ba7b811-9dad-11d1-80b4-00c04fd430c8"});var VS,uh,f_=_(()=>{VS=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),uh={randomUUID:VS}});function GS(r,e,t){if(uh.randomUUID&&!e&&!r)return uh.randomUUID();r=r||{};var n=r.random||(r.rng||Nu)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(var s=0;s<16;++s)e[t+s]=n[s];return e}return Qr(n)}var ve,p_=_(()=>{f_();rh();Ua();ve=GS});function ZS(r,e,t,n){switch(r){case 0:return e&t^~e&n;case 1:return e^t^n;case 2:return e&t^e&n^t&n;case 3:return e^t^n}}function ch(r,e){return r<<e|r>>>32-e}function qS(r){var e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof r=="string"){var n=unescape(encodeURIComponent(r));r=[];for(var s=0;s<n.length;++s)r.push(n.charCodeAt(s))}else Array.isArray(r)||(r=Array.prototype.slice.call(r));r.push(128);for(var i=r.length/4+2,a=Math.ceil(i/16),o=new Array(a),u=0;u<a;++u){for(var c=new Uint32Array(16),l=0;l<16;++l)c[l]=r[u*64+l*4]<<24|r[u*64+l*4+1]<<16|r[u*64+l*4+2]<<8|r[u*64+l*4+3];o[u]=c}o[a-1][14]=(r.length-1)*8/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=(r.length-1)*8&4294967295;for(var f=0;f<a;++f){for(var p=new Uint32Array(80),d=0;d<16;++d)p[d]=o[f][d];for(var h=16;h<80;++h)p[h]=ch(p[h-3]^p[h-8]^p[h-14]^p[h-16],1);for(var m=t[0],g=t[1],y=t[2],b=t[3],w=t[4],x=0;x<80;++x){var A=Math.floor(x/20),P=ch(m,5)+ZS(A,g,y,b)+w+e[A]+p[x]>>>0;w=b,b=y,y=ch(g,30)>>>0,g=m,m=P}t[0]=t[0]+m>>>0,t[1]=t[1]+g>>>0,t[2]=t[2]+y>>>0,t[3]=t[3]+b>>>0,t[4]=t[4]+w>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var d_,h_=_(()=>{d_=qS});var KS,Ba,m_=_(()=>{l_();h_();KS=oh("v5",80,d_),Ba=KS});function g_(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,n)}return t}function b_(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?g_(Object(t),!0).forEach(function(n){HS(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):g_(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}function HS(r,e,t){return(e=WS(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function WS(r){var e=JS(r,"string");return typeof e=="symbol"?e:e+""}function JS(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function ql(r={},e,t=0){var n=o_(b_(b_({},r),{},{_v6:!0}),new Uint8Array(16));if(n=ah(n),e){for(var s=0;s<16;s++)e[t+s]=n[s];return e}return Qr(n)}var y_=_(()=>{Ua();u_();c_()});var vr=_(()=>{p_();m_();y_();eh()});function __(r=!1){let e=XS.getInstance().getStore();if(!r&&e===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function Kl(r){return typeof r=="function"&&"langsmith:traceable"in r}var ph,fh,YS,dh,XS,Uz,w_=_(()=>{ph=class{getStore(){}run(e,t){return t()}},fh=Symbol.for("ls:tracing_async_local_storage"),YS=new ph,dh=class{getInstance(){return globalThis[fh]??YS}initializeGlobalInstance(e){globalThis[fh]===void 0&&(globalThis[fh]=e)}},XS=new dh;Uz=Symbol.for("langsmith:traceable:root")});var hh=_(()=>{w_()});function Wl(r,e){return QS.call(r,e)}function Jl(r){if(Array.isArray(r)){let t=new Array(r.length);for(let n=0;n<t.length;n++)t[n]=""+n;return t}if(Object.keys)return Object.keys(r);let e=[];for(let t in r)Wl(r,t)&&e.push(t);return e}function ct(r){switch(typeof r){case"object":return JSON.parse(JSON.stringify(r));case"undefined":return null;default:return r}}function Yl(r){let e=0,t=r.length,n;for(;e<t;){if(n=r.charCodeAt(e),n>=48&&n<=57){e++;continue}return!1}return!0}function en(r){return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}function $u(r){return r.replace(/~1/g,"/").replace(/~0/g,"~")}function Hl(r){if(r===void 0)return!0;if(r){if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(Hl(r[t]))return!0}else if(typeof r=="object"){let t=Jl(r),n=t.length;for(var e=0;e<n;e++)if(Hl(r[t[e]]))return!0}}return!1}function v_(r,e){let t=[r];for(let n in e){let s=typeof e[n]=="object"?JSON.stringify(e[n],null,2):e[n];typeof s<"u"&&t.push(`${n}: ${s}`)}return t.join(`
`)}var QS,Pi,ju=_(()=>{QS=Object.prototype.hasOwnProperty;Pi=class extends Error{constructor(e,t,n,s,i){super(v_(e,{name:t,index:n,operation:s,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=v_(e,{name:t,index:n,operation:s,tree:i})}}});var mh={};Sl(mh,{JsonPatchError:()=>ke,_areEquals:()=>Mu,applyOperation:()=>Si,applyPatch:()=>bs,applyReducer:()=>rI,deepClone:()=>eI,getValueByPointer:()=>Xl,validate:()=>x_,validator:()=>Ql});function Xl(r,e){if(e=="")return r;var t={op:"_get",path:e};return Si(r,t),t.value}function Si(r,e,t=!1,n=!0,s=!0,i=0){if(t&&(typeof t=="function"?t(e,0,r,e.path):Ql(e,0)),e.path===""){let a={newDocument:r};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=r,a;if(e.op==="move"||e.op==="copy")return a.newDocument=Xl(r,e.from),e.op==="move"&&(a.removed=r),a;if(e.op==="test"){if(a.test=Mu(r,e.value),a.test===!1)throw new ke("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return a.newDocument=r,a}else{if(e.op==="remove")return a.removed=r,a.newDocument=null,a;if(e.op==="_get")return e.value=r,a;if(t)throw new ke("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,r);return a}}else{n||(r=ct(r));let o=(e.path||"").split("/"),u=r,c=1,l=o.length,f,p,d;for(typeof t=="function"?d=t:d=Ql;;){if(p=o[c],p&&p.indexOf("~")!=-1&&(p=$u(p)),s&&(p=="__proto__"||p=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[p]===void 0?f=o.slice(0,c).join("/"):c==l-1&&(f=e.path),f!==void 0&&d(e,0,r,f)),c++,Array.isArray(u)){if(p==="-")p=u.length;else{if(t&&!Yl(p))throw new ke("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,r);Yl(p)&&(p=~~p)}if(c>=l){if(t&&e.op==="add"&&p>u.length)throw new ke("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,r);let h=tI[e.op].call(e,u,p,r);if(h.test===!1)throw new ke("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return h}}else if(c>=l){let h=Va[e.op].call(e,u,p,r);if(h.test===!1)throw new ke("Test operation failed","TEST_OPERATION_FAILED",i,e,r);return h}if(u=u[p],t&&c<l&&(!u||typeof u!="object"))throw new ke("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,r)}}}function bs(r,e,t,n=!0,s=!0){if(t&&!Array.isArray(e))throw new ke("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(r=ct(r));let i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=Si(r,e[a],t,!0,s,a),r=i[a].newDocument;return i.newDocument=r,i}function rI(r,e,t){let n=Si(r,e);if(n.test===!1)throw new ke("Test operation failed","TEST_OPERATION_FAILED",t,e,r);return n.newDocument}function Ql(r,e,t,n){if(typeof r!="object"||r===null||Array.isArray(r))throw new ke("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,r,t);if(Va[r.op]){if(typeof r.path!="string")throw new ke("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,r,t);if(r.path.indexOf("/")!==0&&r.path.length>0)throw new ke('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,r,t);if((r.op==="move"||r.op==="copy")&&typeof r.from!="string")throw new ke("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&r.value===void 0)throw new ke("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,r,t);if((r.op==="add"||r.op==="replace"||r.op==="test")&&Hl(r.value))throw new ke("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,r,t);if(t){if(r.op=="add"){var s=r.path.split("/").length,i=n.split("/").length;if(s!==i+1&&s!==i)throw new ke("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,r,t)}else if(r.op==="replace"||r.op==="remove"||r.op==="_get"){if(r.path!==n)throw new ke("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,r,t)}else if(r.op==="move"||r.op==="copy"){var a={op:"_get",path:r.from,value:void 0},o=x_([a],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new ke("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,r,t)}}}else throw new ke("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,r,t)}function x_(r,e,t){try{if(!Array.isArray(r))throw new ke("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)bs(ct(e),ct(r),t||!0);else{t=t||Ql;for(var n=0;n<r.length;n++)t(r[n],n,e,void 0)}}catch(s){if(s instanceof ke)return s;throw s}}function Mu(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){var t=Array.isArray(r),n=Array.isArray(e),s,i,a;if(t&&n){if(i=r.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!Mu(r[s],e[s]))return!1;return!0}if(t!=n)return!1;var o=Object.keys(r);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!Mu(r[a],e[a]))return!1;return!0}return r!==r&&e!==e}var ke,eI,Va,tI,ef=_(()=>{ju();ke=Pi,eI=ct,Va={add:function(r,e,t){return r[e]=this.value,{newDocument:t}},remove:function(r,e,t){var n=r[e];return delete r[e],{newDocument:t,removed:n}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:function(r,e,t){let n=Xl(t,this.path);n&&(n=ct(n));let s=Si(t,{op:"remove",path:this.from}).removed;return Si(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:n}},copy:function(r,e,t){let n=Xl(t,this.from);return Si(t,{op:"add",path:this.path,value:ct(n)}),{newDocument:t}},test:function(r,e,t){return{newDocument:t,test:Mu(r[e],this.value)}},_get:function(r,e,t){return this.value=r[e],{newDocument:t}}},tI={add:function(r,e,t){return Yl(e)?r.splice(e,0,this.value):r[e]=this.value,{newDocument:t,index:e}},remove:function(r,e,t){var n=r.splice(e,1);return{newDocument:t,removed:n[0]}},replace:function(r,e,t){var n=r[e];return r[e]=this.value,{newDocument:t,removed:n}},move:Va.move,copy:Va.copy,test:Va.test,_get:Va._get}});function A_(r,e,t,n,s){if(e!==r){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=Jl(e),a=Jl(r),o=!1,u=!1,c=a.length-1;c>=0;c--){var l=a[c],f=r[l];if(Wl(e,l)&&!(e[l]===void 0&&f!==void 0&&Array.isArray(e)===!1)){var p=e[l];typeof f=="object"&&f!=null&&typeof p=="object"&&p!=null&&Array.isArray(f)===Array.isArray(p)?A_(f,p,t,n+"/"+en(l),s):f!==p&&(o=!0,s&&t.push({op:"test",path:n+"/"+en(l),value:ct(f)}),t.push({op:"replace",path:n+"/"+en(l),value:ct(p)}))}else Array.isArray(r)===Array.isArray(e)?(s&&t.push({op:"test",path:n+"/"+en(l),value:ct(f)}),t.push({op:"remove",path:n+"/"+en(l)}),u=!0):(s&&t.push({op:"test",path:n,value:r}),t.push({op:"replace",path:n,value:e}),o=!0)}if(!(!u&&i.length==a.length))for(var c=0;c<i.length;c++){var l=i[c];!Wl(r,l)&&e[l]!==void 0&&t.push({op:"add",path:n+"/"+en(l),value:ct(e[l])})}}}function tf(r,e,t=!1){var n=[];return A_(r,e,n,"",t),n}var E_=_(()=>{ju();ef();});var Yz,gh=_(()=>{ef();E_();ju();ef();ju();Yz={...mh,JsonPatchError:Pi,deepClone:ct,escapePathComponent:en,unescapePathComponent:$u}});var O_,P_,bh,S_,yh,_h,wh,I_,T_,k_,C_,R_,N_,$_,j_,M_,z_,L_,D_,F_,U_,B_,V_,G_,Z_,q_,K_,H_,W_,J_,vh,Y_,X_,Q_=_(()=>{O_="gen_ai.operation.name",P_="gen_ai.system",bh="gen_ai.request.model",S_="gen_ai.response.model",yh="gen_ai.usage.input_tokens",_h="gen_ai.usage.output_tokens",wh="gen_ai.usage.total_tokens",I_="gen_ai.request.max_tokens",T_="gen_ai.request.temperature",k_="gen_ai.request.top_p",C_="gen_ai.request.frequency_penalty",R_="gen_ai.request.presence_penalty",N_="gen_ai.response.finish_reasons",$_="gen_ai.prompt",j_="gen_ai.completion",M_="gen_ai.request.extra_query",z_="gen_ai.request.extra_body",L_="gen_ai.serialized.name",D_="gen_ai.serialized.signature",F_="gen_ai.serialized.doc",U_="gen_ai.response.id",B_="gen_ai.response.service_tier",V_="gen_ai.response.system_fingerprint",G_="gen_ai.usage.input_token_details",Z_="gen_ai.usage.output_token_details",q_="langsmith.trace.session_id",K_="langsmith.trace.session_name",H_="langsmith.span.kind",W_="langsmith.trace.name",J_="langsmith.metadata",vh="langsmith.span.tags",Y_="langsmith.request.streaming",X_="langsmith.request.headers"});var sI,ew,tw,rw,xh=_(()=>{jn();sI=(...r)=>fetch(...r),ew=Symbol.for("ls:fetch_implementation"),tw=()=>{let r=globalThis[ew];return r?typeof r=="function"&&"Headers"in r&&"Request"in r&&"Response"in r:!1},rw=r=>async(...e)=>{if(r||Me("DEBUG")==="true"){let[n,s]=e;console.log(`\u2192 ${s?.method||"GET"} ${n}`)}let t=await(globalThis[ew]??sI)(...e);return(r||Me("DEBUG")==="true")&&console.log(`\u2190 ${t.status} ${t.statusText} ${t.url}`),t}});var zu,Ah=_(()=>{jn();zu=()=>Me("PROJECT")??Zt("LANGCHAIN_SESSION")??"default"});var rf,nf=_(()=>{Eh();Oh();xh();Ah();rf="0.3.77"});function sf(){if(Ph===void 0){let r=Ih(),e=lI();Ph={library:"langsmith",runtime:r,sdk:"langsmith-js",sdk_version:rf,...e}}return Ph}function Th(){let r=cI(),e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[n,s]of Object.entries(r))typeof s=="string"&&!t.includes(n)&&!n.toLowerCase().includes("key")&&!n.toLowerCase().includes("secret")&&!n.toLowerCase().includes("token")&&(n==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[n]=s);return e}function cI(){let r={};try{if(typeof process<"u"&&process.env)for(let[e,t]of Object.entries(process.env))(e.startsWith("LANGCHAIN_")||e.startsWith("LANGSMITH_"))&&t!=null&&((e.toLowerCase().includes("key")||e.toLowerCase().includes("secret")||e.toLowerCase().includes("token"))&&typeof t=="string"?r[e]=t.slice(0,2)+"*".repeat(t.length-4)+t.slice(-2):r[e]=t)}catch{}return r}function Zt(r){try{return typeof process<"u"?process.env?.[r]:void 0}catch{return}}function Me(r){return Zt(`LANGSMITH_${r}`)||Zt(`LANGCHAIN_${r}`)}function lI(){if(Sh!==void 0)return Sh;let r=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of r){let n=Zt(t);n!==void 0&&(e[t]=n)}return Sh=e,e}function af(){return Zt("OTEL_ENABLED")==="true"||Me("OTEL_ENABLED")==="true"}var tn,iI,aI,oI,nw,uI,Ih,Ph,Sh,jn=_(()=>{nf();iI=()=>typeof window<"u"&&typeof window.document<"u",aI=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",oI=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),nw=()=>typeof Deno<"u",uI=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!nw(),Ih=()=>tn||(typeof Bun<"u"?tn="bun":iI()?tn="browser":uI()?tn="node":aI()?tn="webworker":oI()?tn="jsdom":nw()?tn="deno":tn="other",tn)});function of(){return Mh.getTraceInstance()}function iw(){return Mh.getContextInstance()}function aw(){return Mh.getDefaultOTLPTracerComponents()}var Rh,Nh,$h,kh,Ch,sw,fI,pI,jh,Mh,zh=_(()=>{jn();Rh=class{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&af()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let n;if(t.length===1&&typeof t[0]=="function"?n=t[0]:t.length===2&&typeof t[1]=="function"?n=t[1]:t.length===3&&typeof t[2]=="function"&&(n=t[2]),typeof n=="function")return n()}},Nh=class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Rh})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},$h=class{active(){return{}}with(e,t){return t()}},kh=Symbol.for("ls:otel_trace"),Ch=Symbol.for("ls:otel_context"),sw=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),fI=new Nh,pI=new $h,jh=class{getTraceInstance(){return globalThis[kh]??fI}getContextInstance(){return globalThis[Ch]??pI}initializeGlobalInstances(e){globalThis[kh]===void 0&&(globalThis[kh]=e.trace),globalThis[Ch]===void 0&&(globalThis[Ch]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[sw]=e}getDefaultOTLPTracerComponents(){return globalThis[sw]??void 0}},Mh=new jh});function hI(r){return dI[r]||r}var dI,uf,ow=_(()=>{Q_();zh();dI={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};uf=class{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(let n of e)try{if(!n.run)continue;if(n.operation==="post"){let s=this.createSpanForRun(n,n.run,t.get(n.id));s&&!n.run.end_time&&this.spans.set(n.id,s)}else this.updateSpanForRun(n,n.run)}catch(s){console.error(`Error processing operation ${n.id}:`,s)}}createSpanForRun(e,t,n){let s=n&&of().getSpan(n);if(s)try{return this.finishSpanSetup(s,t,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,t,n){return this.setSpanAttributes(e,t,n),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{let n=this.spans.get(e.id);if(!n){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(n,t,e),t.error?(n.setStatus({code:2}),n.recordException(new Error(t.error))):n.setStatus({code:1});let s=t.end_time;s&&(n.end(new Date(s)),this.spans.delete(e.id))}catch(n){console.error(`Failed to update span for run ${e.id}:`,n)}}extractModelName(e){if(e.extra?.metadata){let t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){let n=t.invocation_params;if(n.model)return n.model;if(n.model_name)return n.model_name}}}setSpanAttributes(e,t,n){if("run_type"in t&&t.run_type){e.setAttribute(H_,t.run_type);let o=hI(t.run_type||"chain");e.setAttribute(O_,o)}"name"in t&&t.name&&e.setAttribute(W_,t.name),"session_id"in t&&t.session_id&&e.setAttribute(q_,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(K_,t.session_name),this.setGenAiSystem(e,t);let s=this.extractModelName(t);s&&e.setAttribute(bh,s),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(yh,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute(_h,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(wh,t.total_tokens),this.setInvocationParameters(e,t);let i=t.extra?.metadata||{};for(let[o,u]of Object.entries(i))u!=null&&e.setAttribute(`${J_}.${o}`,String(u));let a=t.tags;if(a&&Array.isArray(a)?e.setAttribute(vh,a.join(", ")):a&&e.setAttribute(vh,String(a)),"serialized"in t&&typeof t.serialized=="object"){let o=t.serialized;o.name&&e.setAttribute(L_,String(o.name)),o.signature&&e.setAttribute(D_,String(o.signature)),o.doc&&e.setAttribute(F_,String(o.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,t){let n="langchain",s=this.extractModelName(t);if(s){let i=s.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?n="anthropic":i.includes("bedrock")?n="aws.bedrock":i.includes("azure")&&i.includes("openai")?n="az.ai.openai":i.includes("azure")&&i.includes("inference")?n="az.ai.inference":i.includes("cohere")?n="cohere":i.includes("deepseek")?n="deepseek":i.includes("gemini")?n="gemini":i.includes("groq")?n="groq":i.includes("watson")||i.includes("ibm")?n="ibm.watsonx.ai":i.includes("mistral")?n="mistral_ai":i.includes("gpt")||i.includes("openai")?n="openai":i.includes("perplexity")||i.includes("sonar")?n="perplexity":i.includes("vertex")?n="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(n="xai")}e.setAttribute(P_,n)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;let n=t.extra.metadata.invocation_params;n.max_tokens!==void 0&&e.setAttribute(I_,n.max_tokens),n.temperature!==void 0&&e.setAttribute(T_,n.temperature),n.top_p!==void 0&&e.setAttribute(k_,n.top_p),n.frequency_penalty!==void 0&&e.setAttribute(C_,n.frequency_penalty),n.presence_penalty!==void 0&&e.setAttribute(R_,n.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{let n=t.run.inputs;typeof n=="object"&&n!==null&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(bh,n.model),n.stream!==void 0&&e.setAttribute(Y_,n.stream),n.extra_headers&&e.setAttribute(X_,JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute(M_,JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute(z_,JSON.stringify(n.extra_body))),e.setAttribute($_,JSON.stringify(n))}catch(n){console.debug(`Failed to process inputs for run ${t.id}`,n)}if(t.run.outputs)try{let n=t.run.outputs,s=this.getUnifiedRunTokens(n);if(s&&(e.setAttribute(yh,s[0]),e.setAttribute(_h,s[1]),e.setAttribute(wh,s[0]+s[1])),n&&typeof n=="object"){if(n.model&&e.setAttribute(S_,String(n.model)),n.id&&e.setAttribute(U_,n.id),n.choices&&Array.isArray(n.choices)){let i=n.choices.map(a=>a.finish_reason).filter(a=>a).map(String);i.length>0&&e.setAttribute(N_,i.join(", "))}if(n.service_tier&&e.setAttribute(B_,n.service_tier),n.system_fingerprint&&e.setAttribute(V_,n.system_fingerprint),n.usage_metadata&&typeof n.usage_metadata=="object"){let i=n.usage_metadata;i.input_token_details&&e.setAttribute(G_,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(Z_,JSON.stringify(i.output_token_details))}}e.setAttribute(j_,JSON.stringify(n))}catch(n){console.debug(`Failed to process outputs for run ${t.id}`,n)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;let n=Object.keys(e);for(let a of n){let o=e[a];if(!(!o||typeof o!="object")&&(t=this.extractUnifiedRunTokens(o.usage_metadata),t||o.lc===1&&o.kwargs&&typeof o.kwargs=="object"&&(t=this.extractUnifiedRunTokens(o.kwargs.usage_metadata),t)))return t}let s=e.generations||[];if(!Array.isArray(s))return null;let i=Array.isArray(s[0])?s.flat():s;for(let a of i)if(typeof a=="object"&&a.message&&typeof a.message=="object"&&a.message.kwargs&&typeof a.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(a.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}});var cw=B((yL,Lh)=>{"use strict";var mI=Object.prototype.hasOwnProperty,vt="~";function Lu(){}Object.create&&(Lu.prototype=Object.create(null),new Lu().__proto__||(vt=!1));function gI(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function uw(r,e,t,n,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new gI(t,n||r,s),a=vt?vt+e:e;return r._events[a]?r._events[a].fn?r._events[a]=[r._events[a],i]:r._events[a].push(i):(r._events[a]=i,r._eventsCount++),r}function cf(r,e){--r._eventsCount===0?r._events=new Lu:delete r._events[e]}function lt(){this._events=new Lu,this._eventsCount=0}lt.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)mI.call(t,n)&&e.push(vt?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};lt.prototype.listeners=function(e){var t=vt?vt+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,a=new Array(i);s<i;s++)a[s]=n[s].fn;return a};lt.prototype.listenerCount=function(e){var t=vt?vt+e:e,n=this._events[t];return n?n.fn?1:n.length:0};lt.prototype.emit=function(e,t,n,s,i,a){var o=vt?vt+e:e;if(!this._events[o])return!1;var u=this._events[o],c=arguments.length,l,f;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,s),!0;case 5:return u.fn.call(u.context,t,n,s,i),!0;case 6:return u.fn.call(u.context,t,n,s,i,a),!0}for(f=1,l=new Array(c-1);f<c;f++)l[f-1]=arguments[f];u.fn.apply(u.context,l)}else{var p=u.length,d;for(f=0;f<p;f++)switch(u[f].once&&this.removeListener(e,u[f].fn,void 0,!0),c){case 1:u[f].fn.call(u[f].context);break;case 2:u[f].fn.call(u[f].context,t);break;case 3:u[f].fn.call(u[f].context,t,n);break;case 4:u[f].fn.call(u[f].context,t,n,s);break;default:if(!l)for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u[f].fn.apply(u[f].context,l)}}return!0};lt.prototype.on=function(e,t,n){return uw(this,e,t,n,!1)};lt.prototype.once=function(e,t,n){return uw(this,e,t,n,!0)};lt.prototype.removeListener=function(e,t,n,s){var i=vt?vt+e:e;if(!this._events[i])return this;if(!t)return cf(this,i),this;var a=this._events[i];if(a.fn)a.fn===t&&(!s||a.once)&&(!n||a.context===n)&&cf(this,i);else{for(var o=0,u=[],c=a.length;o<c;o++)(a[o].fn!==t||s&&!a[o].once||n&&a[o].context!==n)&&u.push(a[o]);u.length?this._events[i]=u.length===1?u[0]:u:cf(this,i)}return this};lt.prototype.removeAllListeners=function(e){var t;return e?(t=vt?vt+e:e,this._events[t]&&cf(this,t)):(this._events=new Lu,this._eventsCount=0),this};lt.prototype.off=lt.prototype.removeListener;lt.prototype.addListener=lt.prototype.on;lt.prefixed=vt;lt.EventEmitter=lt;typeof Lh<"u"&&(Lh.exports=lt)});var fw=B((_L,lw)=>{"use strict";lw.exports=(r,e)=>(e=e||(()=>{}),r.then(t=>new Promise(n=>{n(e())}).then(()=>t),t=>new Promise(n=>{n(e())}).then(()=>{throw t})))});var dw=B((wL,ff)=>{"use strict";var bI=fw(),lf=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},pw=(r,e,t)=>new Promise((n,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){n(r);return}let i=setTimeout(()=>{if(typeof t=="function"){try{n(t())}catch(u){s(u)}return}let a=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new lf(a);typeof r.cancel=="function"&&r.cancel(),s(o)},e);bI(r.then(n,s),()=>{clearTimeout(i)})});ff.exports=pw;ff.exports.default=pw;ff.exports.TimeoutError=lf});var hw=B(Dh=>{"use strict";Object.defineProperty(Dh,"__esModule",{value:!0});function yI(r,e,t){let n=0,s=r.length;for(;s>0;){let i=s/2|0,a=n+i;t(r[a],e)<=0?(n=++a,s-=i+1):s=i}return n}Dh.default=yI});var mw=B(Uh=>{"use strict";Object.defineProperty(Uh,"__esModule",{value:!0});var _I=hw(),Fh=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let n={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(n);return}let s=_I.default(this._queue,n,(i,a)=>a.priority-i.priority);this._queue.splice(s,0,n)}dequeue(){let e=this._queue.shift();return e?.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};Uh.default=Fh});var df=B(Vh=>{"use strict";Object.defineProperty(Vh,"__esModule",{value:!0});var wI=cw(),gw=dw(),vI=mw(),pf=()=>{},xI=new gw.TimeoutError,Bh=class extends wI{constructor(e){var t,n,s,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=pf,this._resolveIdle=pf,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:vI.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=pf,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=pf,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,s)=>{let i=async()=>{this._pendingCount++,this._intervalCount++;try{let a=this._timeout===void 0&&t.timeout===void 0?e():gw.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(xI)});n(await a)}catch(a){s(a)}this._next()};this._queue.enqueue(i,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Vh.default=Bh});var bw,hf,AI,Du,yw=_(()=>{bw=yr(Ul(),1),hf=yr(df(),1),AI=[429,500,502,503,504],Du=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in hf.default?this.queue=new hf.default.default({concurrency:this.maxConcurrency}):this.queue=new hf.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let n=this.onFailedResponseHook;return this.queue.add(()=>(0,bw.default)(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.name==="TimeoutError"||s.message.startsWith("AbortError")||s?.code==="ECONNABORTED")throw s;let i=s?.response;if(n&&await n(i))return;let a=i?.status??s?.status;if(a&&!AI.includes(+a))throw s},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((s,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...n)}}});function Gh(r){return typeof r?._getType=="function"}function Zh(r){let e={type:r._getType(),data:{content:r.content}};return r?.additional_kwargs&&Object.keys(r.additional_kwargs).length>0&&(e.data.additional_kwargs={...r.additional_kwargs}),e}var _w=_(()=>{});function re(r,e){if(!EI.test(r)){let t=e!==void 0?`Invalid UUID for ${e}: ${r}`:`Invalid UUID: ${r}`;throw new Error(t)}return r}var EI,ww=_(()=>{EI=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i});function Fu(r){vw[r]||(console.warn(r),vw[r]=!0)}var vw,qh=_(()=>{vw={}});var Uu=B((IL,xw)=>{"use strict";var OI="2.0.0",PI=Number.MAX_SAFE_INTEGER||9007199254740991,SI=16,II=250,TI=["major","premajor","minor","preminor","patch","prepatch","prerelease"];xw.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:SI,MAX_SAFE_BUILD_LENGTH:II,MAX_SAFE_INTEGER:PI,RELEASE_TYPES:TI,SEMVER_SPEC_VERSION:OI,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}});var Bu=B((TL,Aw)=>{"use strict";var kI=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};Aw.exports=kI});var Ga=B((rn,Ew)=>{"use strict";var{MAX_SAFE_COMPONENT_LENGTH:Kh,MAX_SAFE_BUILD_LENGTH:CI,MAX_LENGTH:RI}=Uu(),NI=Bu();rn=Ew.exports={};var $I=rn.re=[],jI=rn.safeRe=[],$=rn.src=[],MI=rn.safeSrc=[],j=rn.t={},zI=0,Hh="[a-zA-Z0-9-]",LI=[["\\s",1],["\\d",RI],[Hh,CI]],DI=r=>{for(let[e,t]of LI)r=r.split(`${e}*`).join(`${e}{0,${t}}`).split(`${e}+`).join(`${e}{1,${t}}`);return r},se=(r,e,t)=>{let n=DI(e),s=zI++;NI(r,s,e),j[r]=s,$[s]=e,MI[s]=n,$I[s]=new RegExp(e,t?"g":void 0),jI[s]=new RegExp(n,t?"g":void 0)};se("NUMERICIDENTIFIER","0|[1-9]\\d*");se("NUMERICIDENTIFIERLOOSE","\\d+");se("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${Hh}*`);se("MAINVERSION",`(${$[j.NUMERICIDENTIFIER]})\\.(${$[j.NUMERICIDENTIFIER]})\\.(${$[j.NUMERICIDENTIFIER]})`);se("MAINVERSIONLOOSE",`(${$[j.NUMERICIDENTIFIERLOOSE]})\\.(${$[j.NUMERICIDENTIFIERLOOSE]})\\.(${$[j.NUMERICIDENTIFIERLOOSE]})`);se("PRERELEASEIDENTIFIER",`(?:${$[j.NONNUMERICIDENTIFIER]}|${$[j.NUMERICIDENTIFIER]})`);se("PRERELEASEIDENTIFIERLOOSE",`(?:${$[j.NONNUMERICIDENTIFIER]}|${$[j.NUMERICIDENTIFIERLOOSE]})`);se("PRERELEASE",`(?:-(${$[j.PRERELEASEIDENTIFIER]}(?:\\.${$[j.PRERELEASEIDENTIFIER]})*))`);se("PRERELEASELOOSE",`(?:-?(${$[j.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${$[j.PRERELEASEIDENTIFIERLOOSE]})*))`);se("BUILDIDENTIFIER",`${Hh}+`);se("BUILD",`(?:\\+(${$[j.BUILDIDENTIFIER]}(?:\\.${$[j.BUILDIDENTIFIER]})*))`);se("FULLPLAIN",`v?${$[j.MAINVERSION]}${$[j.PRERELEASE]}?${$[j.BUILD]}?`);se("FULL",`^${$[j.FULLPLAIN]}$`);se("LOOSEPLAIN",`[v=\\s]*${$[j.MAINVERSIONLOOSE]}${$[j.PRERELEASELOOSE]}?${$[j.BUILD]}?`);se("LOOSE",`^${$[j.LOOSEPLAIN]}$`);se("GTLT","((?:<|>)?=?)");se("XRANGEIDENTIFIERLOOSE",`${$[j.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);se("XRANGEIDENTIFIER",`${$[j.NUMERICIDENTIFIER]}|x|X|\\*`);se("XRANGEPLAIN",`[v=\\s]*(${$[j.XRANGEIDENTIFIER]})(?:\\.(${$[j.XRANGEIDENTIFIER]})(?:\\.(${$[j.XRANGEIDENTIFIER]})(?:${$[j.PRERELEASE]})?${$[j.BUILD]}?)?)?`);se("XRANGEPLAINLOOSE",`[v=\\s]*(${$[j.XRANGEIDENTIFIERLOOSE]})(?:\\.(${$[j.XRANGEIDENTIFIERLOOSE]})(?:\\.(${$[j.XRANGEIDENTIFIERLOOSE]})(?:${$[j.PRERELEASELOOSE]})?${$[j.BUILD]}?)?)?`);se("XRANGE",`^${$[j.GTLT]}\\s*${$[j.XRANGEPLAIN]}$`);se("XRANGELOOSE",`^${$[j.GTLT]}\\s*${$[j.XRANGEPLAINLOOSE]}$`);se("COERCEPLAIN",`(^|[^\\d])(\\d{1,${Kh}})(?:\\.(\\d{1,${Kh}}))?(?:\\.(\\d{1,${Kh}}))?`);se("COERCE",`${$[j.COERCEPLAIN]}(?:$|[^\\d])`);se("COERCEFULL",$[j.COERCEPLAIN]+`(?:${$[j.PRERELEASE]})?(?:${$[j.BUILD]})?(?:$|[^\\d])`);se("COERCERTL",$[j.COERCE],!0);se("COERCERTLFULL",$[j.COERCEFULL],!0);se("LONETILDE","(?:~>?)");se("TILDETRIM",`(\\s*)${$[j.LONETILDE]}\\s+`,!0);rn.tildeTrimReplace="$1~";se("TILDE",`^${$[j.LONETILDE]}${$[j.XRANGEPLAIN]}$`);se("TILDELOOSE",`^${$[j.LONETILDE]}${$[j.XRANGEPLAINLOOSE]}$`);se("LONECARET","(?:\\^)");se("CARETTRIM",`(\\s*)${$[j.LONECARET]}\\s+`,!0);rn.caretTrimReplace="$1^";se("CARET",`^${$[j.LONECARET]}${$[j.XRANGEPLAIN]}$`);se("CARETLOOSE",`^${$[j.LONECARET]}${$[j.XRANGEPLAINLOOSE]}$`);se("COMPARATORLOOSE",`^${$[j.GTLT]}\\s*(${$[j.LOOSEPLAIN]})$|^$`);se("COMPARATOR",`^${$[j.GTLT]}\\s*(${$[j.FULLPLAIN]})$|^$`);se("COMPARATORTRIM",`(\\s*)${$[j.GTLT]}\\s*(${$[j.LOOSEPLAIN]}|${$[j.XRANGEPLAIN]})`,!0);rn.comparatorTrimReplace="$1$2$3";se("HYPHENRANGE",`^\\s*(${$[j.XRANGEPLAIN]})\\s+-\\s+(${$[j.XRANGEPLAIN]})\\s*$`);se("HYPHENRANGELOOSE",`^\\s*(${$[j.XRANGEPLAINLOOSE]})\\s+-\\s+(${$[j.XRANGEPLAINLOOSE]})\\s*$`);se("STAR","(<|>)?=?\\s*\\*");se("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");se("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});var mf=B((kL,Ow)=>{"use strict";var FI=Object.freeze({loose:!0}),UI=Object.freeze({}),BI=r=>r?typeof r!="object"?FI:r:UI;Ow.exports=BI});var Wh=B((CL,Iw)=>{"use strict";var Pw=/^[0-9]+$/,Sw=(r,e)=>{if(typeof r=="number"&&typeof e=="number")return r===e?0:r<e?-1:1;let t=Pw.test(r),n=Pw.test(e);return t&&n&&(r=+r,e=+e),r===e?0:t&&!n?-1:n&&!t?1:r<e?-1:1},VI=(r,e)=>Sw(e,r);Iw.exports={compareIdentifiers:Sw,rcompareIdentifiers:VI}});var ft=B((RL,kw)=>{"use strict";var gf=Bu(),{MAX_LENGTH:Tw,MAX_SAFE_INTEGER:bf}=Uu(),{safeRe:yf,t:_f}=Ga(),GI=mf(),{compareIdentifiers:Jh}=Wh(),Yh=class r{constructor(e,t){if(t=GI(t),e instanceof r){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Tw)throw new TypeError(`version is longer than ${Tw} characters`);gf("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let n=e.trim().match(t.loose?yf[_f.LOOSE]:yf[_f.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>bf||this.major<0)throw new TypeError("Invalid major version");if(this.minor>bf||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>bf||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map(s=>{if(/^[0-9]+$/.test(s)){let i=+s;if(i>=0&&i<bf)return i}return s}):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(gf("SemVer.compare",this.version,this.options,e),!(e instanceof r)){if(typeof e=="string"&&e===this.version)return 0;e=new r(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof r||(e=new r(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(e){if(e instanceof r||(e=new r(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let n=this.prerelease[t],s=e.prerelease[t];if(gf("prerelease compare",t,n,s),n===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(n===void 0)return-1;if(n===s)continue;return Jh(n,s)}while(++t)}compareBuild(e){e instanceof r||(e=new r(e,this.options));let t=0;do{let n=this.build[t],s=e.build[t];if(gf("build compare",t,n,s),n===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(n===void 0)return-1;if(n===s)continue;return Jh(n,s)}while(++t)}inc(e,t,n){if(e.startsWith("pre")){if(!t&&n===!1)throw new Error("invalid increment argument: identifier is empty");if(t){let s=`-${t}`.match(this.options.loose?yf[_f.PRERELEASELOOSE]:yf[_f.PRERELEASE]);if(!s||s[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let s=Number(n)?1:0;if(this.prerelease.length===0)this.prerelease=[s];else{let i=this.prerelease.length;for(;--i>=0;)typeof this.prerelease[i]=="number"&&(this.prerelease[i]++,i=-2);if(i===-1){if(t===this.prerelease.join(".")&&n===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(s)}}if(t){let i=[t,s];n===!1&&(i=[t]),Jh(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=i):this.prerelease=i}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};kw.exports=Yh});var Ti=B((NL,Rw)=>{"use strict";var Cw=ft(),ZI=(r,e,t=!1)=>{if(r instanceof Cw)return r;try{return new Cw(r,e)}catch(n){if(!t)return null;throw n}};Rw.exports=ZI});var $w=B(($L,Nw)=>{"use strict";var qI=Ti(),KI=(r,e)=>{let t=qI(r,e);return t?t.version:null};Nw.exports=KI});var Mw=B((jL,jw)=>{"use strict";var HI=Ti(),WI=(r,e)=>{let t=HI(r.trim().replace(/^[=v]+/,""),e);return t?t.version:null};jw.exports=WI});var Dw=B((ML,Lw)=>{"use strict";var zw=ft(),JI=(r,e,t,n,s)=>{typeof t=="string"&&(s=n,n=t,t=void 0);try{return new zw(r instanceof zw?r.version:r,t).inc(e,n,s).version}catch{return null}};Lw.exports=JI});var Bw=B((zL,Uw)=>{"use strict";var Fw=Ti(),YI=(r,e)=>{let t=Fw(r,null,!0),n=Fw(e,null,!0),s=t.compare(n);if(s===0)return null;let i=s>0,a=i?t:n,o=i?n:t,u=!!a.prerelease.length;if(!!o.prerelease.length&&!u){if(!o.patch&&!o.minor)return"major";if(o.compareMain(a)===0)return o.minor&&!o.patch?"minor":"patch"}let l=u?"pre":"";return t.major!==n.major?l+"major":t.minor!==n.minor?l+"minor":t.patch!==n.patch?l+"patch":"prerelease"};Uw.exports=YI});var Gw=B((LL,Vw)=>{"use strict";var XI=ft(),QI=(r,e)=>new XI(r,e).major;Vw.exports=QI});var qw=B((DL,Zw)=>{"use strict";var eT=ft(),tT=(r,e)=>new eT(r,e).minor;Zw.exports=tT});var Hw=B((FL,Kw)=>{"use strict";var rT=ft(),nT=(r,e)=>new rT(r,e).patch;Kw.exports=nT});var Jw=B((UL,Ww)=>{"use strict";var sT=Ti(),iT=(r,e)=>{let t=sT(r,e);return t&&t.prerelease.length?t.prerelease:null};Ww.exports=iT});var nr=B((BL,Xw)=>{"use strict";var Yw=ft(),aT=(r,e,t)=>new Yw(r,t).compare(new Yw(e,t));Xw.exports=aT});var ev=B((VL,Qw)=>{"use strict";var oT=nr(),uT=(r,e,t)=>oT(e,r,t);Qw.exports=uT});var rv=B((GL,tv)=>{"use strict";var cT=nr(),lT=(r,e)=>cT(r,e,!0);tv.exports=lT});var wf=B((ZL,sv)=>{"use strict";var nv=ft(),fT=(r,e,t)=>{let n=new nv(r,t),s=new nv(e,t);return n.compare(s)||n.compareBuild(s)};sv.exports=fT});var av=B((qL,iv)=>{"use strict";var pT=wf(),dT=(r,e)=>r.sort((t,n)=>pT(t,n,e));iv.exports=dT});var uv=B((KL,ov)=>{"use strict";var hT=wf(),mT=(r,e)=>r.sort((t,n)=>hT(n,t,e));ov.exports=mT});var Vu=B((HL,cv)=>{"use strict";var gT=nr(),bT=(r,e,t)=>gT(r,e,t)>0;cv.exports=bT});var vf=B((WL,lv)=>{"use strict";var yT=nr(),_T=(r,e,t)=>yT(r,e,t)<0;lv.exports=_T});var Xh=B((JL,fv)=>{"use strict";var wT=nr(),vT=(r,e,t)=>wT(r,e,t)===0;fv.exports=vT});var Qh=B((YL,pv)=>{"use strict";var xT=nr(),AT=(r,e,t)=>xT(r,e,t)!==0;pv.exports=AT});var xf=B((XL,dv)=>{"use strict";var ET=nr(),OT=(r,e,t)=>ET(r,e,t)>=0;dv.exports=OT});var Af=B((QL,hv)=>{"use strict";var PT=nr(),ST=(r,e,t)=>PT(r,e,t)<=0;hv.exports=ST});var em=B((eD,mv)=>{"use strict";var IT=Xh(),TT=Qh(),kT=Vu(),CT=xf(),RT=vf(),NT=Af(),$T=(r,e,t,n)=>{switch(e){case"===":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r===t;case"!==":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r!==t;case"":case"=":case"==":return IT(r,t,n);case"!=":return TT(r,t,n);case">":return kT(r,t,n);case">=":return CT(r,t,n);case"<":return RT(r,t,n);case"<=":return NT(r,t,n);default:throw new TypeError(`Invalid operator: ${e}`)}};mv.exports=$T});var bv=B((tD,gv)=>{"use strict";var jT=ft(),MT=Ti(),{safeRe:Ef,t:Of}=Ga(),zT=(r,e)=>{if(r instanceof jT)return r;if(typeof r=="number"&&(r=String(r)),typeof r!="string")return null;e=e||{};let t=null;if(!e.rtl)t=r.match(e.includePrerelease?Ef[Of.COERCEFULL]:Ef[Of.COERCE]);else{let u=e.includePrerelease?Ef[Of.COERCERTLFULL]:Ef[Of.COERCERTL],c;for(;(c=u.exec(r))&&(!t||t.index+t[0].length!==r.length);)(!t||c.index+c[0].length!==t.index+t[0].length)&&(t=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(t===null)return null;let n=t[2],s=t[3]||"0",i=t[4]||"0",a=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return MT(`${n}.${s}.${i}${a}${o}`,e)};gv.exports=zT});var _v=B((rD,yv)=>{"use strict";var tm=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){let s=this.map.keys().next().value;this.delete(s)}this.map.set(e,t)}return this}};yv.exports=tm});var sr=B((nD,Av)=>{"use strict";var LT=/\s+/g,rm=class r{constructor(e,t){if(t=FT(t),e instanceof r)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new r(e.raw,t);if(e instanceof nm)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(LT," "),this.set=this.raw.split("||").map(n=>this.parseRange(n.trim())).filter(n=>n.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let n=this.set[0];if(this.set=this.set.filter(s=>!vv(s[0])),this.set.length===0)this.set=[n];else if(this.set.length>1){for(let s of this.set)if(s.length===1&&KT(s[0])){this.set=[s];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let n=0;n<t.length;n++)n>0&&(this.formatted+=" "),this.formatted+=t[n].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let n=((this.options.includePrerelease&&ZT)|(this.options.loose&&qT))+":"+e,s=wv.get(n);if(s)return s;let i=this.options.loose,a=i?xt[pt.HYPHENRANGELOOSE]:xt[pt.HYPHENRANGE];e=e.replace(a,nk(this.options.includePrerelease)),xe("hyphen replace",e),e=e.replace(xt[pt.COMPARATORTRIM],BT),xe("comparator trim",e),e=e.replace(xt[pt.TILDETRIM],VT),xe("tilde trim",e),e=e.replace(xt[pt.CARETTRIM],GT),xe("caret trim",e);let o=e.split(" ").map(f=>HT(f,this.options)).join(" ").split(/\s+/).map(f=>rk(f,this.options));i&&(o=o.filter(f=>(xe("loose invalid filter",f,this.options),!!f.match(xt[pt.COMPARATORLOOSE])))),xe("range list",o);let u=new Map,c=o.map(f=>new nm(f,this.options));for(let f of c){if(vv(f))return[f];u.set(f.value,f)}u.size>1&&u.has("")&&u.delete("");let l=[...u.values()];return wv.set(n,l),l}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Range is required");return this.set.some(n=>xv(n,t)&&e.set.some(s=>xv(s,t)&&n.every(i=>s.every(a=>i.intersects(a,t)))))}test(e){if(!e)return!1;if(typeof e=="string")try{e=new UT(e,this.options)}catch{return!1}for(let t=0;t<this.set.length;t++)if(sk(this.set[t],e,this.options))return!0;return!1}};Av.exports=rm;var DT=_v(),wv=new DT,FT=mf(),nm=Gu(),xe=Bu(),UT=ft(),{safeRe:xt,t:pt,comparatorTrimReplace:BT,tildeTrimReplace:VT,caretTrimReplace:GT}=Ga(),{FLAG_INCLUDE_PRERELEASE:ZT,FLAG_LOOSE:qT}=Uu(),vv=r=>r.value==="<0.0.0-0",KT=r=>r.value==="",xv=(r,e)=>{let t=!0,n=r.slice(),s=n.pop();for(;t&&n.length;)t=n.every(i=>s.intersects(i,e)),s=n.pop();return t},HT=(r,e)=>(r=r.replace(xt[pt.BUILD],""),xe("comp",r,e),r=YT(r,e),xe("caret",r),r=WT(r,e),xe("tildes",r),r=QT(r,e),xe("xrange",r),r=tk(r,e),xe("stars",r),r),At=r=>!r||r.toLowerCase()==="x"||r==="*",WT=(r,e)=>r.trim().split(/\s+/).map(t=>JT(t,e)).join(" "),JT=(r,e)=>{let t=e.loose?xt[pt.TILDELOOSE]:xt[pt.TILDE];return r.replace(t,(n,s,i,a,o)=>{xe("tilde",r,n,s,i,a,o);let u;return At(s)?u="":At(i)?u=`>=${s}.0.0 <${+s+1}.0.0-0`:At(a)?u=`>=${s}.${i}.0 <${s}.${+i+1}.0-0`:o?(xe("replaceTilde pr",o),u=`>=${s}.${i}.${a}-${o} <${s}.${+i+1}.0-0`):u=`>=${s}.${i}.${a} <${s}.${+i+1}.0-0`,xe("tilde return",u),u})},YT=(r,e)=>r.trim().split(/\s+/).map(t=>XT(t,e)).join(" "),XT=(r,e)=>{xe("caret",r,e);let t=e.loose?xt[pt.CARETLOOSE]:xt[pt.CARET],n=e.includePrerelease?"-0":"";return r.replace(t,(s,i,a,o,u)=>{xe("caret",r,s,i,a,o,u);let c;return At(i)?c="":At(a)?c=`>=${i}.0.0${n} <${+i+1}.0.0-0`:At(o)?i==="0"?c=`>=${i}.${a}.0${n} <${i}.${+a+1}.0-0`:c=`>=${i}.${a}.0${n} <${+i+1}.0.0-0`:u?(xe("replaceCaret pr",u),i==="0"?a==="0"?c=`>=${i}.${a}.${o}-${u} <${i}.${a}.${+o+1}-0`:c=`>=${i}.${a}.${o}-${u} <${i}.${+a+1}.0-0`:c=`>=${i}.${a}.${o}-${u} <${+i+1}.0.0-0`):(xe("no pr"),i==="0"?a==="0"?c=`>=${i}.${a}.${o}${n} <${i}.${a}.${+o+1}-0`:c=`>=${i}.${a}.${o}${n} <${i}.${+a+1}.0-0`:c=`>=${i}.${a}.${o} <${+i+1}.0.0-0`),xe("caret return",c),c})},QT=(r,e)=>(xe("replaceXRanges",r,e),r.split(/\s+/).map(t=>ek(t,e)).join(" ")),ek=(r,e)=>{r=r.trim();let t=e.loose?xt[pt.XRANGELOOSE]:xt[pt.XRANGE];return r.replace(t,(n,s,i,a,o,u)=>{xe("xRange",r,n,s,i,a,o,u);let c=At(i),l=c||At(a),f=l||At(o),p=f;return s==="="&&p&&(s=""),u=e.includePrerelease?"-0":"",c?s===">"||s==="<"?n="<0.0.0-0":n="*":s&&p?(l&&(a=0),o=0,s===">"?(s=">=",l?(i=+i+1,a=0,o=0):(a=+a+1,o=0)):s==="<="&&(s="<",l?i=+i+1:a=+a+1),s==="<"&&(u="-0"),n=`${s+i}.${a}.${o}${u}`):l?n=`>=${i}.0.0${u} <${+i+1}.0.0-0`:f&&(n=`>=${i}.${a}.0${u} <${i}.${+a+1}.0-0`),xe("xRange return",n),n})},tk=(r,e)=>(xe("replaceStars",r,e),r.trim().replace(xt[pt.STAR],"")),rk=(r,e)=>(xe("replaceGTE0",r,e),r.trim().replace(xt[e.includePrerelease?pt.GTE0PRE:pt.GTE0],"")),nk=r=>(e,t,n,s,i,a,o,u,c,l,f,p)=>(At(n)?t="":At(s)?t=`>=${n}.0.0${r?"-0":""}`:At(i)?t=`>=${n}.${s}.0${r?"-0":""}`:a?t=`>=${t}`:t=`>=${t}${r?"-0":""}`,At(c)?u="":At(l)?u=`<${+c+1}.0.0-0`:At(f)?u=`<${c}.${+l+1}.0-0`:p?u=`<=${c}.${l}.${f}-${p}`:r?u=`<${c}.${l}.${+f+1}-0`:u=`<=${u}`,`${t} ${u}`.trim()),sk=(r,e,t)=>{for(let n=0;n<r.length;n++)if(!r[n].test(e))return!1;if(e.prerelease.length&&!t.includePrerelease){for(let n=0;n<r.length;n++)if(xe(r[n].semver),r[n].semver!==nm.ANY&&r[n].semver.prerelease.length>0){let s=r[n].semver;if(s.major===e.major&&s.minor===e.minor&&s.patch===e.patch)return!0}return!1}return!0}});var Gu=B((sD,Tv)=>{"use strict";var Zu=Symbol("SemVer ANY"),am=class r{static get ANY(){return Zu}constructor(e,t){if(t=Ev(t),e instanceof r){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),im("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===Zu?this.value="":this.value=this.operator+this.semver.version,im("comp",this)}parse(e){let t=this.options.loose?Ov[Pv.COMPARATORLOOSE]:Ov[Pv.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=n[1]!==void 0?n[1]:"",this.operator==="="&&(this.operator=""),n[2]?this.semver=new Sv(n[2],this.options.loose):this.semver=Zu}toString(){return this.value}test(e){if(im("Comparator.test",e,this.options.loose),this.semver===Zu||e===Zu)return!0;if(typeof e=="string")try{e=new Sv(e,this.options)}catch{return!1}return sm(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new Iv(e.value,t).test(this.value):e.operator===""?e.value===""?!0:new Iv(this.value,t).test(e.semver):(t=Ev(t),t.includePrerelease&&(this.value==="<0.0.0-0"||e.value==="<0.0.0-0")||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||sm(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||sm(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}};Tv.exports=am;var Ev=mf(),{safeRe:Ov,t:Pv}=Ga(),sm=em(),im=Bu(),Sv=ft(),Iv=sr()});var qu=B((iD,kv)=>{"use strict";var ik=sr(),ak=(r,e,t)=>{try{e=new ik(e,t)}catch{return!1}return e.test(r)};kv.exports=ak});var Rv=B((aD,Cv)=>{"use strict";var ok=sr(),uk=(r,e)=>new ok(r,e).set.map(t=>t.map(n=>n.value).join(" ").trim().split(" "));Cv.exports=uk});var $v=B((oD,Nv)=>{"use strict";var ck=ft(),lk=sr(),fk=(r,e,t)=>{let n=null,s=null,i=null;try{i=new lk(e,t)}catch{return null}return r.forEach(a=>{i.test(a)&&(!n||s.compare(a)===-1)&&(n=a,s=new ck(n,t))}),n};Nv.exports=fk});var Mv=B((uD,jv)=>{"use strict";var pk=ft(),dk=sr(),hk=(r,e,t)=>{let n=null,s=null,i=null;try{i=new dk(e,t)}catch{return null}return r.forEach(a=>{i.test(a)&&(!n||s.compare(a)===1)&&(n=a,s=new pk(n,t))}),n};jv.exports=hk});var Dv=B((cD,Lv)=>{"use strict";var om=ft(),mk=sr(),zv=Vu(),gk=(r,e)=>{r=new mk(r,e);let t=new om("0.0.0");if(r.test(t)||(t=new om("0.0.0-0"),r.test(t)))return t;t=null;for(let n=0;n<r.set.length;++n){let s=r.set[n],i=null;s.forEach(a=>{let o=new om(a.semver.version);switch(a.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!i||zv(o,i))&&(i=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${a.operator}`)}}),i&&(!t||zv(t,i))&&(t=i)}return t&&r.test(t)?t:null};Lv.exports=gk});var Uv=B((lD,Fv)=>{"use strict";var bk=sr(),yk=(r,e)=>{try{return new bk(r,e).range||"*"}catch{return null}};Fv.exports=yk});var Pf=B((fD,Zv)=>{"use strict";var _k=ft(),Gv=Gu(),{ANY:wk}=Gv,vk=sr(),xk=qu(),Bv=Vu(),Vv=vf(),Ak=Af(),Ek=xf(),Ok=(r,e,t,n)=>{r=new _k(r,n),e=new vk(e,n);let s,i,a,o,u;switch(t){case">":s=Bv,i=Ak,a=Vv,o=">",u=">=";break;case"<":s=Vv,i=Ek,a=Bv,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(xk(r,e,n))return!1;for(let c=0;c<e.set.length;++c){let l=e.set[c],f=null,p=null;if(l.forEach(d=>{d.semver===wk&&(d=new Gv(">=0.0.0")),f=f||d,p=p||d,s(d.semver,f.semver,n)?f=d:a(d.semver,p.semver,n)&&(p=d)}),f.operator===o||f.operator===u||(!p.operator||p.operator===o)&&i(r,p.semver))return!1;if(p.operator===u&&a(r,p.semver))return!1}return!0};Zv.exports=Ok});var Kv=B((pD,qv)=>{"use strict";var Pk=Pf(),Sk=(r,e,t)=>Pk(r,e,">",t);qv.exports=Sk});var Wv=B((dD,Hv)=>{"use strict";var Ik=Pf(),Tk=(r,e,t)=>Ik(r,e,"<",t);Hv.exports=Tk});var Xv=B((hD,Yv)=>{"use strict";var Jv=sr(),kk=(r,e,t)=>(r=new Jv(r,t),e=new Jv(e,t),r.intersects(e,t));Yv.exports=kk});var ex=B((mD,Qv)=>{"use strict";var Ck=qu(),Rk=nr();Qv.exports=(r,e,t)=>{let n=[],s=null,i=null,a=r.sort((l,f)=>Rk(l,f,t));for(let l of a)Ck(l,e,t)?(i=l,s||(s=l)):(i&&n.push([s,i]),i=null,s=null);s&&n.push([s,null]);let o=[];for(let[l,f]of n)l===f?o.push(l):!f&&l===a[0]?o.push("*"):f?l===a[0]?o.push(`<=${f}`):o.push(`${l} - ${f}`):o.push(`>=${l}`);let u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e}});var ax=B((gD,ix)=>{"use strict";var tx=sr(),cm=Gu(),{ANY:um}=cm,Ku=qu(),lm=nr(),Nk=(r,e,t={})=>{if(r===e)return!0;r=new tx(r,t),e=new tx(e,t);let n=!1;e:for(let s of r.set){for(let i of e.set){let a=jk(s,i,t);if(n=n||a!==null,a)continue e}if(n)return!1}return!0},$k=[new cm(">=0.0.0-0")],rx=[new cm(">=0.0.0")],jk=(r,e,t)=>{if(r===e)return!0;if(r.length===1&&r[0].semver===um){if(e.length===1&&e[0].semver===um)return!0;t.includePrerelease?r=$k:r=rx}if(e.length===1&&e[0].semver===um){if(t.includePrerelease)return!0;e=rx}let n=new Set,s,i;for(let d of r)d.operator===">"||d.operator===">="?s=nx(s,d,t):d.operator==="<"||d.operator==="<="?i=sx(i,d,t):n.add(d.semver);if(n.size>1)return null;let a;if(s&&i){if(a=lm(s.semver,i.semver,t),a>0)return null;if(a===0&&(s.operator!==">="||i.operator!=="<="))return null}for(let d of n){if(s&&!Ku(d,String(s),t)||i&&!Ku(d,String(i),t))return null;for(let h of e)if(!Ku(d,String(h),t))return!1;return!0}let o,u,c,l,f=i&&!t.includePrerelease&&i.semver.prerelease.length?i.semver:!1,p=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1;f&&f.prerelease.length===1&&i.operator==="<"&&f.prerelease[0]===0&&(f=!1);for(let d of e){if(l=l||d.operator===">"||d.operator===">=",c=c||d.operator==="<"||d.operator==="<=",s){if(p&&d.semver.prerelease&&d.semver.prerelease.length&&d.semver.major===p.major&&d.semver.minor===p.minor&&d.semver.patch===p.patch&&(p=!1),d.operator===">"||d.operator===">="){if(o=nx(s,d,t),o===d&&o!==s)return!1}else if(s.operator===">="&&!Ku(s.semver,String(d),t))return!1}if(i){if(f&&d.semver.prerelease&&d.semver.prerelease.length&&d.semver.major===f.major&&d.semver.minor===f.minor&&d.semver.patch===f.patch&&(f=!1),d.operator==="<"||d.operator==="<="){if(u=sx(i,d,t),u===d&&u!==i)return!1}else if(i.operator==="<="&&!Ku(i.semver,String(d),t))return!1}if(!d.operator&&(i||s)&&a!==0)return!1}return!(s&&c&&!i&&a!==0||i&&l&&!s&&a!==0||p||f)},nx=(r,e,t)=>{if(!r)return e;let n=lm(r.semver,e.semver,t);return n>0?r:n<0||e.operator===">"&&r.operator===">="?e:r},sx=(r,e,t)=>{if(!r)return e;let n=lm(r.semver,e.semver,t);return n<0?r:n>0||e.operator==="<"&&r.operator==="<="?e:r};ix.exports=Nk});var lx=B((bD,cx)=>{"use strict";var fm=Ga(),ox=Uu(),Mk=ft(),ux=Wh(),zk=Ti(),Lk=$w(),Dk=Mw(),Fk=Dw(),Uk=Bw(),Bk=Gw(),Vk=qw(),Gk=Hw(),Zk=Jw(),qk=nr(),Kk=ev(),Hk=rv(),Wk=wf(),Jk=av(),Yk=uv(),Xk=Vu(),Qk=vf(),eC=Xh(),tC=Qh(),rC=xf(),nC=Af(),sC=em(),iC=bv(),aC=Gu(),oC=sr(),uC=qu(),cC=Rv(),lC=$v(),fC=Mv(),pC=Dv(),dC=Uv(),hC=Pf(),mC=Kv(),gC=Wv(),bC=Xv(),yC=ex(),_C=ax();cx.exports={parse:zk,valid:Lk,clean:Dk,inc:Fk,diff:Uk,major:Bk,minor:Vk,patch:Gk,prerelease:Zk,compare:qk,rcompare:Kk,compareLoose:Hk,compareBuild:Wk,sort:Jk,rsort:Yk,gt:Xk,lt:Qk,eq:eC,neq:tC,gte:rC,lte:nC,cmp:sC,coerce:iC,Comparator:aC,Range:oC,satisfies:uC,toComparators:cC,maxSatisfying:lC,minSatisfying:fC,minVersion:pC,validRange:dC,outside:hC,gtr:mC,ltr:gC,intersects:bC,simplifyRange:yC,subset:_C,SemVer:Mk,re:fm.re,src:fm.src,tokens:fm.t,SEMVER_SPEC_VERSION:ox.SEMVER_SPEC_VERSION,RELEASE_TYPES:ox.RELEASE_TYPES,compareIdentifiers:ux.compareIdentifiers,rcompareIdentifiers:ux.rcompareIdentifiers}});function Mn(r){if(!r||r.split("/").length>2||r.startsWith("/")||r.endsWith("/")||r.split(":").length>2)throw new Error(`Invalid identifier format: ${r}`);let[e,t]=r.split(":"),n=t||"latest";if(e.includes("/")){let[s,i]=e.split("/",2);if(!s||!i)throw new Error(`Invalid identifier format: ${r}`);return[s,i,n]}else{if(!e)throw new Error(`Invalid identifier format: ${r}`);return["-",e,n]}}var wC,fx=_(()=>{wC=yr(lx(),1)});async function V(r,e,t){let n;if(r.ok){t&&(n=await r.text());return}if(r.status===403)try{(await r.json())?.error==="org_scoped_key_requires_workspace"&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{let o=new Error(`${r.status} ${r.statusText}`);throw o.status=r?.status,o}if(n===void 0)try{n=await r.text()}catch{n=""}let s=`Failed to ${e}. Received status [${r.status}]: ${r.statusText}. Message: ${n}`;if(r.status===409)throw new pm(s);let i=new Error(s);throw i.status=r.status,i}function dx(r){return typeof r=="object"&&r!==null&&r.code===px}var pm,px,Sf,dm=_(()=>{pm=class extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}};px="ERR_CONFLICTING_ENDPOINTS",Sf=class extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:px}),this.name="ConflictingEndpointsError"}}});function AC(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function If(r){return xC.encode(r)}function mx(r){if(r&&typeof r=="object"&&r!==null){if(r instanceof Map)return Object.fromEntries(r);if(r instanceof Set)return Array.from(r);if(r instanceof Date)return r.toISOString();if(r instanceof RegExp)return r.toString();if(r instanceof Error)return{name:r.name,message:r.message}}else if(typeof r=="bigint")return r.toString();return r}function EC(r){return function(e,t){if(r){let n=r.call(this,e,t);if(n!==void 0)return n}return mx(t)}}function Mt(r,e,t,n,s){try{let i=JSON.stringify(r,EC(t),n);return If(i)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),If("[Unserializable]");Me("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof s>"u"&&(s=AC()),mm(r,"",0,[],void 0,0,s);let a;try{Za.length===0?a=JSON.stringify(r,t,n):a=JSON.stringify(r,OC(t),n)}catch{return If("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Tf.length!==0;){let o=Tf.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return If(a)}}function hm(r,e,t,n){var s=Object.getOwnPropertyDescriptor(n,t);s.get!==void 0?s.configurable?(Object.defineProperty(n,t,{value:r}),Tf.push([n,t,e,s])):Za.push([e,t,r]):(n[t]=r,Tf.push([n,t,e]))}function mm(r,e,t,n,s,i,a){i+=1;var o;if(typeof r=="object"&&r!==null){for(o=0;o<n.length;o++)if(n[o]===r){hm(vC,r,e,s);return}if(typeof a.depthLimit<"u"&&i>a.depthLimit){hm(hx,r,e,s);return}if(typeof a.edgesLimit<"u"&&t+1>a.edgesLimit){hm(hx,r,e,s);return}if(n.push(r),Array.isArray(r))for(o=0;o<r.length;o++)mm(r[o],o,o,n,r,i,a);else{r=mx(r);var u=Object.keys(r);for(o=0;o<u.length;o++){var c=u[o];mm(r[c],c,o,n,r,i,a)}}n.pop()}}function OC(r){return r=typeof r<"u"?r:function(e,t){return t},function(e,t){if(Za.length>0)for(var n=0;n<Za.length;n++){var s=Za[n];if(s[1]===e&&s[0]===t){t=s[2],Za.splice(n,1);break}}return r.call(this,e,t)}}var hx,vC,Tf,Za,xC,gx=_(()=>{jn();hx="[...]",vC={result:"[Circular]"},Tf=[],Za=[],xC=new TextEncoder});function bx(r,e){let t=sf(),n=e??Th(),s=r.extra??{},i=s.metadata;return r.extra={...s,runtime:{...t,...s?.runtime},metadata:{...n,...n.revision_id||"revision_id"in r&&r.revision_id?{revision_id:("revision_id"in r?r.revision_id:void 0)??n.revision_id}:{},...i}},r}async function IC(r){let e=[];for await(let t of r)e.push(t);return e}function kf(r){if(r!==void 0)return r.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function yx(r){return typeof r=="number"?Number(r.toFixed(4)):r}function wx(r){return"dataset_id"in r||"dataset_name"in r}var PC,SC,TC,gm,kC,CC,RC,_x,Ii,Eh=_(()=>{vr();ow();zh();yw();_w();jn();nf();ww();qh();fx();dm();xh();gx();PC=r=>{let e=r?.toString()??Me("TRACING_SAMPLING_RATE");if(e===void 0)return;let t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},SC=r=>{let t=r.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};TC=async r=>{if(r?.status===429){let e=parseInt(r.headers.get("retry-after")??"10",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};gm=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,n=new Promise(i=>{t=i}),s=Mt(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:n,size:s}),this.sizeBytes+=s,n}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let n=[],s=0;for(;s+(this.peek()?.size??0)<e&&this.items.length>0&&n.length<t;){let i=this.items.shift();i&&(n.push(i),s+=i.size,this.sizeBytes-=i.size)}if(n.length===0&&this.items.length>0){let i=this.items.shift();n.push(i),s+=i.size,this.sizeBytes-=i.size}return[n.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl})),()=>n.forEach(i=>i.itemPromiseResolve())]}},kC=24*1024*1024,CC=1e4,RC=100,_x="https://api.smith.langchain.com",Ii=class r{get _fetch(){return this.fetchImplementation||rw(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new gm}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Zt("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Zt("LANGSMITH_DEBUG")==="true"});let t=r.getDefaultClientConfig();if(this.tracingSampleRate=PC(e.tracingSamplingRate),this.apiUrl=kf(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=kf(e.apiKey??t.apiKey),this.webUrl=kf(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=kf(e.workspaceId??Me("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Du({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new Du({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:TC,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,af()&&(this.langSmithToOTELTranslator=new uf),this.cachedLSEnvVarsForMetadata=Th()}static getDefaultClientConfig(){let e=Me("API_KEY"),t=Me("ENDPOINT")??_x,n=Me("HIDE_INPUTS")==="true",s=Me("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:n,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:SC(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${rf}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=await this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){let n=t?.toString()??"",s=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{let a=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(a,`fetch ${e}`),a})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let s=Number(t.get("offset"))||0,i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(s)),t.set("limit",String(i));let a=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(async()=>{let c=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(c,`fetch ${e}`),c}),u=n?n(await o.json()):await o.json();if(u.length===0||(yield u,u.length<i))break;s+=u.length}}async*_getCursorPaginatedList(e,t=null,n="POST",s="runs"){let i=t?{...t}:{};for(;;){let a=JSON.stringify(i),u=await(await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(l,`fetch ${e}`),l})).json();if(!u||!u[s])break;yield u[s];let c=u.cursors;if(!c||!c.next)break;i.cursor=c.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let n=[];for(let s of e)this.filteredPostUuids.has(s.trace_id)?s.id===s.trace_id&&this.filteredPostUuids.delete(s.trace_id):n.push(s);return n}else{let n=[];for(let s of e){let i=s.trace_id??s.id;this.filteredPostUuids.has(i)||(s.id===i?this._shouldSample()?n.push(s):this.filteredPostUuids.add(i):n.push(s))}return n}}async _getBatchSizeLimitBytes(){let e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??kC}async _getBatchSizeLimit(){let e=await this._ensureServerInfo();return this.batchSizeLimit??e.batch_ingest_config?.size_limit??RC}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){let n=[];for(;this.autoBatchQueue.items.length>0;){let[s,i]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!s.length){i();break}let a=s.reduce((c,l)=>{let f=l.apiUrl??this.apiUrl,p=l.apiKey??this.apiKey,h=l.apiKey===this.apiKey&&l.apiUrl===this.apiUrl?"default":`${f}|${p}`;return c[h]||(c[h]=[]),c[h].push(l),c},{}),o=[];for(let[c,l]of Object.entries(a)){let f=this._processBatch(l,{apiUrl:c==="default"?void 0:c.split("|")[0],apiKey:c==="default"?void 0:c.split("|")[1]});o.push(f)}let u=Promise.all(o).finally(i);n.push(u)}return Promise.all(n)}async _processBatch(e,t){if(e.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(e);else{let n={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},s=await this._ensureServerInfo();if(s?.batch_ingest_config?.use_multipart_endpoint){let i=s?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(n,{...t,useGzip:i})}else await this.batchIngestRuns(n,t)}}catch(n){console.error("Error exporting batch:",n)}}_sendBatchToOTELTranslator(e){if(this.langSmithToOTELTranslator!==void 0){let t=new Map,n=[];for(let s of e)s.item.id&&s.otelContext&&(t.set(s.item.id,s.otelContext),s.action==="create"?n.push({operation:"post",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}):n.push({operation:"patch",id:s.item.id,trace_id:s.item.trace_id??s.item.id,run:s.item}));this.langSmithToOTELTranslator.exportBatch(n,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=bx(e.item,this.cachedLSEnvVarsForMetadata);let t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;let n=await this._getBatchSizeLimitBytes(),s=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>s)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:s})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){let t=await(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(CC),...this.fetchOptions});return await V(n,"get server info"),n})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){let e=of(),t=iw();if(this.langSmithToOTELTranslator!==void 0){let n=e.getActiveSpan();if(n)return e.setSpan(t.active(),n)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;let n={...this.headers,"Content-Type":"application/json"},s=e.project_name;delete e.project_name;let i=await this.prepareRunCreateOrUpdateInputs({session_name:s,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){let u=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:u,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error);return}let a=bx(i,this.cachedLSEnvVarsForMetadata);t?.apiKey!==void 0&&(n["x-api-key"]=t.apiKey),t?.workspaceId!==void 0&&(n["x-tenant-id"]=t.workspaceId);let o=Mt(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{let u=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await V(u,"create run",!0),u})}async batchIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;let s=await Promise.all(e?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[]),i=await Promise.all(t?.map(u=>this.prepareRunCreateOrUpdateInputs(u))??[]);if(s.length>0&&i.length>0){let u=s.reduce((l,f)=>(f.id&&(l[f.id]=f),l),{}),c=[];for(let l of i)l.id!==void 0&&u[l.id]?u[l.id]={...u[l.id],...l}:c.push(l);s=Object.values(u),i=c}let a={post:s,patch:i};if(!a.post.length&&!a.patch.length)return;let o={post:[],patch:[]};for(let u of["post","patch"]){let c=u,l=a[c].reverse(),f=l.pop();for(;f!==void 0;)o[c].push(f),f=l.pop()}if(o.post.length>0||o.patch.length>0){let u=o.post.map(c=>c.id).concat(o.patch.map(c=>c.id)).join(",");await this._postBatchIngestRuns(Mt(o,`Ingesting runs with ids: ${u}`),n)}}async _postBatchIngestRuns(e,t){let n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};t?.apiKey!==void 0&&(n["x-api-key"]=t.apiKey),await this.batchIngestCaller.call(async()=>{let s=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await V(s,"batch create run",!0),s})}async multipartIngestRuns({runCreates:e,runUpdates:t},n){if(e===void 0&&t===void 0)return;let s={},i=[];for(let f of e??[]){let p=await this.prepareRunCreateOrUpdateInputs(f);p.id!==void 0&&p.attachments!==void 0&&(s[p.id]=p.attachments),delete p.attachments,i.push(p)}let a=[];for(let f of t??[])a.push(await this.prepareRunCreateOrUpdateInputs(f));if(i.find(f=>f.trace_id===void 0||f.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(a.find(f=>f.trace_id===void 0||f.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&a.length>0){let f=i.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),p=[];for(let d of a)d.id!==void 0&&f[d.id]?f[d.id]={...f[d.id],...d}:p.push(d);i=Object.values(f),a=p}if(i.length===0&&a.length===0)return;let c=[],l=[];for(let[f,p]of[["post",i],["patch",a]])for(let d of p){let{inputs:h,outputs:m,events:g,extra:y,error:b,serialized:w,attachments:x,...A}=d,P={inputs:h,outputs:m,events:g,extra:y,error:b,serialized:w},M=Mt(A,`Serializing for multipart ingestion of run with id: ${A.id}`);l.push({name:`${f}.${A.id}`,payload:new Blob([M],{type:`application/json; length=${M.length}`})});for(let[N,I]of Object.entries(P)){if(I===void 0)continue;let S=Mt(I,`Serializing ${N} for multipart ingestion of run with id: ${A.id}`);l.push({name:`${f}.${A.id}.${N}`,payload:new Blob([S],{type:`application/json; length=${S.length}`})})}if(A.id!==void 0){let N=s[A.id];if(N){delete s[A.id];for(let[I,S]of Object.entries(N)){let C,ue;if(Array.isArray(S)?[C,ue]=S:(C=S.mimeType,ue=S.data),I.includes(".")){console.warn(`Skipping attachment '${I}' for run ${A.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${A.id}.${I}`,payload:new Blob([ue],{type:`${C}; length=${ue.byteLength}`})})}}}c.push(`trace=${A.trace_id},id=${A.id}`)}await this._sendMultipartRequest(l,c.join("; "),n)}async _createNodeFetchBody(e,t){let n=[];for(let a of e)n.push(new Blob([`--${t}\r
`])),n.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),n.push(a.payload),n.push(new Blob([`\r
`]));return n.push(new Blob([`--${t}--\r
`])),await new Blob(n).arrayBuffer()}async _createMultipartStream(e,t){let n=new TextEncoder;return new ReadableStream({async start(i){let a=async o=>{typeof o=="string"?i.enqueue(n.encode(o)):i.enqueue(o)};for(let o of e){await a(`--${t}\r
`),await a(`Content-Disposition: form-data; name="${o.name}"\r
`),await a(`Content-Type: ${o.payload.type}\r
\r
`);let c=o.payload.stream().getReader();try{let l;for(;!(l=await c.read()).done;)i.enqueue(l.value)}finally{c.releaseLock()}await a(`\r
`)}await a(`--${t}--\r
`),i.close()}})}async _sendMultipartRequest(e,t,n){let s="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=tw(),a=()=>this._createNodeFetchBody(e,s),o=()=>this._createMultipartStream(e,s),u=async c=>this.batchIngestCaller.call(async()=>{let l=await c(),f={...this.headers,"Content-Type":`multipart/form-data; boundary=${s}`};n?.apiKey!==void 0&&(f["x-api-key"]=n.apiKey);let p=l;n?.useGzip&&typeof l=="object"&&"pipeThrough"in l&&(p=l.pipeThrough(new CompressionStream("gzip")),f["Content-Encoding"]="gzip");let d=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:f,body:p,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(d,"Failed to send multipart request",!0),d});try{let c,l=!1;!i&&!this.multipartStreamingDisabled&&Ih()!=="bun"?(l=!0,c=await u(o)):c=await u(a),(!this.multipartStreamingDisabled||l)&&c.status===422&&(n?.apiUrl??this.apiUrl)!==_x&&(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,c=await u(a))}catch(c){console.warn(`${c.message.trim()}

Context: ${t}`)}}async updateRun(e,t,n){re(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));let s={...t,id:e};if(!this._filterForSampling([s],!0).length)return;if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){let o=this._cloneCurrentOTELContext();if(t.end_time!==void 0&&s.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:s,otelContext:o,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error);return}let i={...this.headers,"Content-Type":"application/json"};n?.apiKey!==void 0&&(i["x-api-key"]=n.apiKey),n?.workspaceId!==void 0&&(i["x-tenant-id"]=n.workspaceId);let a=Mt(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{let o=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(o,"update run",!0),o})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){re(e);let n=await this._get(`/runs/${e}`);return t&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(t!==void 0){let s;t.session_id?s=t.session_id:n?.projectName?s=(await this.readProject({projectName:n?.projectName})).id:n?.projectId?s=n?.projectId:s=(await this.readProject({projectName:Me("PROJECT")||"default"})).id;let i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){let s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await IC(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},s={};t.sort((i,a)=>(i?.dotted_order??"").localeCompare(a?.dotted_order??""));for(let i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in n||(n[i.parent_run_id]=[]),n[i.parent_run_id].push(i),s[i.id]=i)}e.child_runs=n[e.id]||[];for(let i in n)i!==e.id&&(s[i].child_runs=n[i]);return e}async*listRuns(e){let{projectId:t,projectName:n,parentRunId:s,traceId:i,referenceExampleId:a,startTime:o,executionOrder:u,isRoot:c,runType:l,error:f,id:p,query:d,filter:h,traceFilter:m,treeFilter:g,limit:y,select:b,order:w}=e,x=[];if(t&&(x=Array.isArray(t)?t:[t]),n){let N=Array.isArray(n)?n:[n],I=await Promise.all(N.map(S=>this.readProject({projectName:S}).then(C=>C.id)));x.push(...I)}let A=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],P={session:x.length?x:null,run_type:l,reference_example:a,query:d,filter:h,trace_filter:m,tree_filter:g,execution_order:u,parent_run:s,start_time:o?o.toISOString():null,error:f,id:p,limit:y,trace:i,select:b||A,is_root:c,order:w};P.select.includes("child_run_ids")&&Fu("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let M=0;for await(let N of this._getCursorPaginatedList("/runs/query",P))if(y){if(M>=y)break;if(N.length+M>y){yield*N.slice(0,y-M);break}M+=N.length,yield*N}else yield*N}async*listGroupRuns(e){let{projectId:t,projectName:n,groupBy:s,filter:i,startTime:a,endTime:o,limit:u,offset:c}=e,f={session_id:t||(await this.readProject({projectName:n})).id,group_by:s,filter:i,start_time:a?a.toISOString():null,end_time:o?o.toISOString():null,limit:Number(u)||100},p=Number(c)||0,d="/runs/group",h=`${this.apiUrl}${d}`;for(;;){let m={...f,offset:p},g=Object.fromEntries(Object.entries(m).filter(([P,M])=>M!==void 0)),y=JSON.stringify(g),w=await(await this.caller.call(async()=>{let P=await this._fetch(h,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await V(P,`Failed to fetch ${d}`),P})).json(),{groups:x,total:A}=w;if(x.length===0)break;for(let P of x)yield P;if(p+=x.length,p>=A)break}}async getRunStats({id:e,trace:t,parentRun:n,runType:s,projectNames:i,projectIds:a,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:f,filter:p,traceFilter:d,treeFilter:h,isRoot:m,dataSourceType:g}){let y=a||[];i&&(y=[...a||[],...await Promise.all(i.map(M=>this.readProject({projectName:M}).then(N=>N.id)))]);let w=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:n,run_type:s,session:y,reference_example:o,start_time:u,end_time:c,error:l,query:f,filter:p,trace_filter:d,tree_filter:h,is_root:m,data_source_type:g}).filter(([M,N])=>N!==void 0)),x=JSON.stringify(w);return await(await this.caller.call(async()=>{let M=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:x});return await V(M,"get run stats"),M})).json()}async shareRun(e,{shareId:t}={}){let n={run_id:e,share_token:t||ve()};re(e);let s=JSON.stringify(n),a=await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await V(o,"share run"),o})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){re(e),await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(t,"unshare run",!0),t})}async readRunSharedLink(e){re(e);let n=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(s,"read run shared link"),s})).json();if(!(n===null||!("share_token"in n)))return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let n=new URLSearchParams({share_token:e});if(t!==void 0)for(let a of t)n.append("id",a);return re(e),await(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(a,"list shared runs"),a})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),re(e);let s=await(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(i,"read dataset shared schema"),i})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let n={dataset_id:e};re(e);let s=JSON.stringify(n),a=await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await V(o,"share dataset"),o})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){re(e),await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(t,"unshare dataset",!0),t})}async readSharedDataset(e){return re(e),await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(s,"read shared dataset"),s})).json()}async listSharedExamples(e,t){let n={};t?.exampleIds&&(n.id=t.exampleIds);let s=new URLSearchParams;Object.entries(n).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>s.append(o,c)):s.append(o,u)});let i=await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/public/${e}/examples?${s.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(o,"list shared examples"),o}),a=await i.json();if(!i.ok)throw"detail"in a?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(a.detail)?a.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return a.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){let o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=i||{};n&&(c.metadata=n);let l={name:e,extra:c,description:t};a!==null&&(l.reference_dataset_id=a);let f=JSON.stringify(l);return await(await this.caller.call(async()=>{let h=await this._fetch(u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:f});return await V(h,"create project"),h})).json()}async updateProject(e,{name:t=null,description:n=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){let o=`${this.apiUrl}/sessions/${e}`,u=i;s&&(u={...u||{},metadata:s});let c=JSON.stringify({name:t,extra:u,description:n,end_time:a?new Date(a).toISOString():null});return await(await this.caller.call(async()=>{let p=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await V(p,"update project"),p})).json()}async hasProject({projectId:e,projectName:t}){let n="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),n+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");let i=await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}${n}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(a,"has project"),a});try{let a=await i.json();return i.ok?Array.isArray(a)?a.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let s="/sessions",i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)re(e),s+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");n!==void 0&&i.append("include_stats",n.toString());let a=await this._get(s,i),o;if(Array.isArray(a)){if(a.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=a[0]}else o=a;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let n=await this.readProject({projectId:e,projectName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let n=await this.readDataset({datasetId:e,datasetName:t}),s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/datasets/${n.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:s,referenceDatasetName:i,includeStats:a,datasetVersion:o,referenceFree:u,metadata:c}={}){let l=new URLSearchParams;if(e!==void 0)for(let f of e)l.append("id",f);if(t!==void 0&&l.append("name",t),n!==void 0&&l.append("name_contains",n),s!==void 0)l.append("reference_dataset",s);else if(i!==void 0){let f=await this.readDataset({datasetName:i});l.append("reference_dataset",f.id)}a!==void 0&&l.append("include_stats",a.toString()),o!==void 0&&l.append("dataset_version",o),u!==void 0&&l.append("reference_free",u.toString()),c!==void 0&&l.append("metadata",JSON.stringify(c));for await(let f of this._getPaginated("/sessions",l))yield*f}async deleteProject({projectId:e,projectName:t}){let n;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?n=(await this.readProject({projectName:t})).id:n=e,re(n),await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(s,`delete session ${n} (${t})`,!0),s})}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:s,description:i,dataType:a,name:o}){let u=`${this.apiUrl}/datasets/upload`,c=new FormData;return c.append("file",e,t),n.forEach(p=>{c.append("input_keys",p)}),s.forEach(p=>{c.append("output_keys",p)}),i&&c.append("description",i),a&&c.append("data_type",a),o&&c.append("name",o),await(await this.caller.call(async()=>{let p=await this._fetch(u,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await V(p,"upload CSV"),p})).json()}async createDataset(e,{description:t,dataType:n,inputsSchema:s,outputsSchema:i,metadata:a}={}){let o={name:e,description:t,extra:a?{metadata:a}:void 0};n&&(o.data_type=n),s&&(o.inputs_schema_definition=s),i&&(o.outputs_schema_definition=i);let u=JSON.stringify(o);return await(await this.caller.call(async()=>{let f=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await V(f,"create dataset"),f})).json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets",s=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)re(e),n+=`/${e}`;else if(t)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");let i=await this._get(n,s),a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(n){if(n instanceof Error&&n.message.toLocaleLowerCase().includes("not found"))return!1;throw n}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:s}){let i=e;if(i===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:t})).id);let a=new URLSearchParams({from_version:typeof n=="string"?n:n.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let n="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${n}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:s,datasetNameContains:i,metadata:a}={}){let o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(n!==void 0)for(let c of n)u.append("id",c);s!==void 0&&u.append("name",s),i!==void 0&&u.append("name_contains",i),a!==void 0&&u.append("metadata",JSON.stringify(a));for await(let c of this._getPaginated(o,u))yield*c}async updateDataset(e){let{datasetId:t,datasetName:n,...s}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");let i=t??(await this.readDataset({datasetName:n})).id;re(i);let a=JSON.stringify(s);return await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(u,"update dataset"),u})).json()}async updateDatasetTag(e){let{datasetId:t,datasetName:n,asOf:s,tag:i}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");let a=t??(await this.readDataset({datasetName:n})).id;re(a);let o=JSON.stringify({as_of:typeof s=="string"?s:s.toISOString(),tag:i});await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await V(u,"update dataset tags",!0),u})}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)re(s),n+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{let i=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(i,`delete ${n}`,!0),i})}async indexDataset({datasetId:e,datasetName:t,tag:n}){let s=e;if(!s&&!t)throw new Error("Must provide either datasetName or datasetId");if(s&&t)throw new Error("Must provide either datasetName or datasetId, not both");s||(s=(await this.readDataset({datasetName:t})).id),re(s);let a=JSON.stringify({tag:n});await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${s}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(u,"index dataset"),u})).json()}async similarExamples(e,t,n,{filter:s}={}){let i={limit:n,inputs:e};s!==void 0&&(i.filter=s),re(t);let a=JSON.stringify(i);return(await(await this.caller.call(async()=>{let c=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await V(c,"fetch similar examples"),c})).json()).examples}async createExample(e,t,n){if(wx(e)&&(t!==void 0||n!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let s=t?n?.datasetId:e.dataset_id,i=t?n?.datasetName:e.dataset_name;if(s===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:i})).id);let a=(t?n?.createdAt:e.created_at)||new Date,o;wx(e)?o=e:o={inputs:e,outputs:t,created_at:a?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};let u=await this._uploadExamplesMultipart(s,[o]);return await this.readExample(u.example_ids?.[0]??ve())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];let b=e,w=b[0].dataset_id,x=b[0].dataset_name;if(w===void 0&&x===void 0)throw new Error("Must provide either datasetName or datasetId");if(w!==void 0&&x!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");w===void 0&&(w=(await this.readDataset({datasetName:x})).id);let A=await this._uploadExamplesMultipart(w,b);return await Promise.all(A.example_ids.map(M=>this.readExample(M)))}let{inputs:t,outputs:n,metadata:s,splits:i,sourceRunIds:a,useSourceRunIOs:o,useSourceRunAttachments:u,attachments:c,exampleIds:l,datasetId:f,datasetName:p}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let d=f,h=p;if(d===void 0&&h===void 0)throw new Error("Must provide either datasetName or datasetId");if(d!==void 0&&h!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");d===void 0&&(d=(await this.readDataset({datasetName:h})).id);let m=t.map((b,w)=>({dataset_id:d,inputs:b,outputs:n?.[w],metadata:s?.[w],split:i?.[w],id:l?.[w],attachments:c?.[w],source_run_id:a?.[w],use_source_run_io:o?.[w],use_source_run_attachments:u?.[w]})),g=await this._uploadExamplesMultipart(d,m);return await Promise.all(g.example_ids.map(b=>this.readExample(b)))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){let s=e.map(a=>Gh(a)?Zh(a):a),i=Gh(t)?Zh(t):t;return this.createExample({input:s},{output:i},n)}async readExample(e){re(e);let t=`/examples/${e}`,n=await this._get(t),{attachment_urls:s,...i}=n,a=i;return s&&(a.attachments=Object.entries(s).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url,mime_type:c.mime_type},o),{})),a}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:s,splits:i,inlineS3Urls:a,metadata:o,limit:u,offset:c,filter:l,includeAttachments:f}={}){let p;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)p=e;else if(t!==void 0)p=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let d=new URLSearchParams({dataset:p}),h=s?typeof s=="string"?s:s?.toISOString():void 0;h&&d.append("as_of",h);let m=a??!0;if(d.append("inline_s3_urls",m.toString()),n!==void 0)for(let y of n)d.append("id",y);if(i!==void 0)for(let y of i)d.append("splits",y);if(o!==void 0){let y=JSON.stringify(o);d.append("metadata",y)}u!==void 0&&d.append("limit",u.toString()),c!==void 0&&d.append("offset",c.toString()),l!==void 0&&d.append("filter",l),f===!0&&["attachment_urls","outputs","metadata"].forEach(y=>d.append("select",y));let g=0;for await(let y of this._getPaginated("/examples",d)){for(let b of y){let{attachment_urls:w,...x}=b,A=x;w&&(A.attachments=Object.entries(w).reduce((P,[M,N])=>(P[M.slice(11)]={presigned_url:N.presigned_url,mime_type:N.mime_type||void 0},P),{})),yield A,g++}if(u!==void 0&&g>=u)break}}async deleteExample(e){re(e);let t=`/examples/${e}`;await this.caller.call(async()=>{let n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(n,`delete ${t}`,!0),n})}async updateExample(e,t){let n;t?n=e:n=e.id,re(n);let s;t?s={id:n,...t}:s=e;let i;return s.dataset_id!==void 0?i=s.dataset_id:i=(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(i,[s])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:s}){let i;if(e?i=e:i=(await this.readDataset({datasetName:t})).id,re(i),n&&s||!n&&!s)throw new Error("Exactly one of asOf and tag must be specified.");let a=new URLSearchParams;return n!==void 0&&a.append("as_of",typeof n=="string"?n:n.toISOString()),s!==void 0&&a.append("tag",s),await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(u,"read dataset version"),u})).json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,re(s);let i=new URLSearchParams,a=n?typeof n=="string"?n:n?.toISOString():void 0;return a&&i.append("as_of",a),await this._get(`/datasets/${s}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:s,remove:i=!1}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,re(a);let o={split_name:n,examples:s.map(c=>(re(c),c)),remove:i},u=JSON.stringify(o);await this.caller.call(async()=>{let c=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await V(c,"update dataset splits",!0),c})}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:s,referenceExample:i}={loadChildRuns:!1}){Fu("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let a;if(typeof e=="string")a=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)a=e;else throw new Error(`Invalid run type: ${typeof e}`);a.reference_example_id!==null&&a.reference_example_id!==void 0&&(i=await this.readExample(a.reference_example_id));let o=await t.evaluateRun(a,i),[u,c]=await this._logEvaluationFeedback(o,a,n);return c[0]}async createFeedback(e,t,{score:n,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:f,projectId:p,comparativeExperimentId:d}){if(!e&&!p)throw new Error("One of runId or projectId must be provided");if(e&&p)throw new Error("Only one of runId or projectId can be provided");let h={type:u??"api",metadata:o??{}};c!==void 0&&h?.metadata!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:c}),h?.metadata!==void 0&&h.metadata.__run?.run_id!==void 0&&re(h.metadata.__run.run_id);let m={id:l??ve(),run_id:e,key:t,score:yx(n),value:s,correction:i,comment:a,feedback_source:h,comparative_experiment_id:d,feedbackConfig:f,session_id:p},g=JSON.stringify(m),y=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{let b=await this._fetch(y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await V(b,"create feedback",!0),b}),m}async updateFeedback(e,{score:t,value:n,correction:s,comment:i}){let a={};t!=null&&(a.score=yx(t)),n!=null&&(a.value=n),s!=null&&(a.correction=s),i!=null&&(a.comment=i),re(e);let o=JSON.stringify(a);await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await V(u,"update feedback",!0),u})}async readFeedback(e){re(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){re(e);let t=`/feedback/${e}`;await this.caller.call(async()=>{let n=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(n,`delete ${t}`,!0),n})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){let s=new URLSearchParams;if(e)for(let i of e)re(i),s.append("run",i);if(t)for(let i of t)s.append("key",i);if(n)for(let i of n)s.append("source",i);for await(let i of this._getPaginated("/feedback",s))yield*i}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:s}={}){let i={run_id:e,feedback_key:t,feedback_config:s};n?typeof n=="string"?i.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(i.expires_in=n):i.expires_in={hours:3};let a=JSON.stringify(i);return await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(u,"create presigned feedback token"),u})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:s,description:i,metadata:a,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),!n==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:n,description:i,created_at:(s??new Date)?.toISOString(),extra:{}};a&&(u.extra.metadata=a);let c=JSON.stringify(u);return(await this.caller.call(async()=>{let f=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await V(f,"create comparative experiment"),f})).json()}async*listPresignedFeedbackTokens(e){re(e);let t=new URLSearchParams({run_id:e});for await(let n of this._getPaginated("/feedback/tokens",t))yield*n}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,n){let s=this._selectEvalResults(e),i=[];for(let a of s){let o=n||{};a.evaluatorInfo&&(o={...a.evaluatorInfo,...o});let u=null;a.targetRunId?u=a.targetRunId:t&&(u=t.id),i.push(await this.createFeedback(u,a.key,{score:a.score,value:a.value,comment:a.comment,correction:a.correction,sourceInfo:o,sourceRunId:a.sourceRunId,feedbackConfig:a.feedbackConfig,feedbackSourceType:"model"}))}return[s,i]}async logEvaluationFeedback(e,t,n){let[s]=await this._logEvaluationFeedback(e,t,n);return s}async*listAnnotationQueues(e={}){let{queueIds:t,name:n,nameContains:s,limit:i}=e,a=new URLSearchParams;t&&t.forEach((u,c)=>{re(u,`queueIds[${c}]`),a.append("ids",u)}),n&&a.append("name",n),s&&a.append("name_contains",s),a.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(let u of this._getPaginated("/annotation-queues",a))if(yield*u,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){let{name:t,description:n,queueId:s,rubricInstructions:i}=e,a={name:t,description:n,id:s||ve(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([c,l])=>l!==void 0)));return(await this.caller.call(async()=>{let c=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await V(c,"create annotation queue"),c})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(n,"read annotation queue"),n})).json()}async updateAnnotationQueue(e,t){let{name:n,description:s,rubricInstructions:i}=t,a=JSON.stringify({name:n,description:s,rubric_instructions:i});await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){let n=JSON.stringify(t.map((s,i)=>re(s,`runIds[${i}]`).toString()));await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await V(s,"add runs to annotation queue",!0),s})}async getRunFromAnnotationQueue(e,t){let n=`/annotation-queues/${re(e,"queueId")}/run`;return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/runs/${re(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/annotation-queues/${re(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(n,"get size from annotation queue"),n})).json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){let n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${n.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let n=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(s,"get latest commit hash"),s})).json();if(n.commits.length!==0)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[n,s,i]=Mn(e),a=JSON.stringify({like:t});return(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/likes/${n}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(u,`${t?"like":"unlike"} prompt`),u})).json()}async _getPromptUrl(e){let[t,n,s]=Mn(e);if(await this._currentTenantIsOwner(t)){let i=await this._getSettings();return s!=="latest"?`${this.getHostUrl()}/prompts/${n}/${s.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${i.id}`}else return s!=="latest"?`${this.getHostUrl()}/hub/${t}/${n}/${s.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,n=>n.commits))yield*t}async*listPrompts(e){let t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(let n of this._getPaginated("/repos",t,s=>s.repos))yield*n}async getPrompt(e){let[t,n,s]=Mn(e),a=await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return o?.status===404?null:(await V(o,"get prompt"),o)}))?.json();return a?.repo?a.repo:null}async createPrompt(e,t){let n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[s,i,a]=Mn(e);if(!await this._currentTenantIsOwner(s))throw await this._ownerConflictError("create a prompt",s);let o={repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},u=JSON.stringify(o),c=await this.caller.call(async()=>{let f=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await V(f,"create prompt"),f}),{repo:l}=await c.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[s,i,a]=Mn(e),o=n?.parentCommitHash==="latest"||!n?.parentCommitHash?await this._getLatestCommitHash(`${s}/${i}`):n?.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=JSON.stringify(u),f=await(await this.caller.call(async()=>{let p=await this._fetch(`${this.apiUrl}/commits/${s}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await V(p,"create commit"),p})).json();return this._getPromptUrl(`${s}/${i}${f.commit_hash?`:${f.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let n=new FormData;for(let a of t){let o=a.id,u={...a.metadata&&{metadata:a.metadata},...a.split&&{split:a.split}},c=Mt(u,`Serializing body for example with id: ${o}`),l=new Blob([c],{type:"application/json"});if(n.append(o,l),a.inputs){let f=Mt(a.inputs,`Serializing inputs for example with id: ${o}`),p=new Blob([f],{type:"application/json"});n.append(`${o}.inputs`,p)}if(a.outputs){let f=Mt(a.outputs,`Serializing outputs whle updating example with id: ${o}`),p=new Blob([f],{type:"application/json"});n.append(`${o}.outputs`,p)}if(a.attachments)for(let[f,p]of Object.entries(a.attachments)){let d,h;Array.isArray(p)?[d,h]=p:(d=p.mimeType,h=p.data);let m=new Blob([h],{type:`${d}; length=${h.byteLength}`});n.append(`${o}.attachment.${f}`,m)}if(a.attachments_operations){let f=Mt(a.attachments_operations,`Serializing attachments while updating example with id: ${o}`),p=new Blob([f],{type:"application/json"});n.append(`${o}.attachments_operations`,p)}}let s=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${s}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await V(a,"update examples"),a})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let n=new FormData;for(let i of t){let a=(i.id??ve()).toString(),o={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},u=Mt(o,`Serializing body for uploaded example with id: ${a}`),c=new Blob([u],{type:"application/json"});if(n.append(a,c),i.inputs){let l=Mt(i.inputs,`Serializing inputs for uploaded example with id: ${a}`),f=new Blob([l],{type:"application/json"});n.append(`${a}.inputs`,f)}if(i.outputs){let l=Mt(i.outputs,`Serializing outputs for uploaded example with id: ${a}`),f=new Blob([l],{type:"application/json"});n.append(`${a}.outputs`,f)}if(i.attachments)for(let[l,f]of Object.entries(i.attachments)){let p,d;Array.isArray(f)?[p,d]=f:(p=f.mimeType,d=f.data);let h=new Blob([d],{type:`${p}; length=${d.byteLength}`});n.append(`${a}.attachment.${l}`,h)}}return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await V(i,"upload examples"),i})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[n,s]=Mn(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);let i={};if(t?.description!==void 0&&(i.description=t.description),t?.readme!==void 0&&(i.readme=t.readme),t?.tags!==void 0&&(i.tags=t.tags),t?.isPublic!==void 0&&(i.is_public=t.isPublic),t?.isArchived!==void 0&&(i.is_archived=t.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");let a=JSON.stringify(i);return(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/repos/${n}/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await V(u,"update prompt"),u})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[t,n,s]=Mn(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(a,"delete prompt"),a})).json()}async pullPromptCommit(e,t){let[n,s,i]=Mn(e),o=await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/commits/${n}/${s}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await V(u,"pull prompt commit"),u})).json();return{owner:n,repo:s,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){let n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(s=>s!=="object")&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){let{sourceApiUrl:n=this.apiUrl,datasetName:s}=t,[i,a]=this.parseTokenOrUrl(e,n),o=new r({apiUrl:i,apiKey:"placeholder"}),u=await o.readSharedDataset(a),c=s||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch{}let l=await o.listSharedExamples(a),f=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(p=>p.inputs),outputs:l.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:f.id})}catch(p){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),p}}parseTokenOrUrl(e,t,n=2,s="dataset"){try{return re(e),[t,e]}catch{}try{let a=new URL(e).pathname.split("/").filter(o=>o!=="");if(a.length>=n){let o=a[a.length-n];return[t,o]}else throw new Error(`Invalid public ${s} URL: ${e}`)}catch{throw new Error(`Invalid public ${s} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await aw()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}});var vx,xx=_(()=>{jn();vx=r=>r!==void 0?r:!!["TRACING_V2","TRACING"].find(t=>Me(t)==="true")});var Cf,Ax=_(()=>{Cf=Symbol.for("lc:context_variables")});function NC(r){return r.replace(/[-:.]/g,"")}function bm(r,e,t=1){let n=t.toFixed(0).slice(0,3).padStart(3,"0"),s=`${new Date(r).toISOString().slice(0,-1)}${n}Z`;return{dottedOrder:NC(s)+e,microsecondPrecisionDatestring:s}}function Ox(r){return r!=null&&typeof r.createChild=="function"&&typeof r.postRun=="function"}function Px(r){return typeof r=="object"&&r!=null&&typeof r.name=="string"&&r.name==="langchain_tracer"}function Ex(r){return Array.isArray(r)&&r.some(e=>Px(e))}function $C(r){return typeof r=="object"&&r!=null&&Array.isArray(r.handlers)}function jC(r){return r!=null&&typeof r.callbacks=="object"&&(Ex(r.callbacks?.handlers)||Ex(r.callbacks))}function MC(r){return r.split(".").map(t=>{let n=t.slice(0,-36),s=t.slice(-36),i=parseInt(n.slice(0,4)),a=parseInt(n.slice(4,6))-1,o=parseInt(n.slice(6,8)),u=parseInt(n.slice(9,11)),c=parseInt(n.slice(11,13)),l=parseInt(n.slice(13,15)),f=parseInt(n.slice(15,21));return[new Date(i,a,o,u,c,l,f/1e3),s]})}function zC(){let r=Zt("LANGSMITH_RUNS_ENDPOINTS");if(!r)return[];try{let e=JSON.parse(r);if(Array.isArray(e)){let t=[];for(let n of e){if(typeof n!="object"||n===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof n}`);continue}if(typeof n.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_url}`);continue}if(typeof n.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof n.api_key}`);continue}t.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key})}return t}else if(typeof e=="object"&&e!==null){DC(e);let t=[];for(let[n,s]of Object.entries(e)){let i=n.replace(/\/$/,"");if(typeof s=="string")t.push({apiUrl:i,apiKey:s});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got ${typeof s}`);continue}}return t}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof e}`),[]}catch(e){if(dx(e))throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function LC(r){return r?r.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):zC()}function DC(r){if(Object.keys(r).length>0&&Me("ENDPOINT"))throw new Sf}var Rf,xr,Oh=_(()=>{vr();Eh();xx();dm();Ax();jn();Ah();jn();qh();Rf=class r{constructor(e,t,n,s){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n,this.replicas=s}static fromHeader(e){let t=e.split(","),n={},s=[],i,a;for(let o of t){let[u,c]=o.split("="),l=decodeURIComponent(c);u==="langsmith-metadata"?n=JSON.parse(l):u==="langsmith-tags"?s=l.split(","):u==="langsmith-project"?i=l:u==="langsmith-replicas"&&(a=JSON.parse(l))}return new r(n,s,i,a)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}},xr=class r{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Ox(e)){Object.assign(this,{...e});return}let t=r.getDefaultConfig(),{metadata:n,...s}=e,i=s.client??r.getSharedClient(),a={...n,...s?.extra?.metadata};if(s.extra={...s.extra,metadata:a},Object.assign(this,{...t,...s,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=LC(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){let{dottedOrder:o,microsecondPrecisionDatestring:u}=bm(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o,this._serialized_start_time=u}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:ve(),run_type:"chain",project_name:zu(),child_runs:[],api_url:Zt("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Zt("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return r.sharedClient||(r.sharedClient=new Ii),r.sharedClient}createChild(e){let t=this.child_execution_order+1,n=new r({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Cf in this&&(n[Cf]=this[Cf]);let s=Symbol.for("lc:child_config"),i=e.extra?.[s]??this.extra[s];if(jC(i)){let u={...i},c=$C(u.callbacks)?u.callbacks.copy?.():void 0;c&&(Object.assign(c,{_parentRunId:n.id}),c.handlers?.find(Px)?.updateFromRunTree?.(n),u.callbacks=c),n.extra[s]=u}let a=new Set,o=this;for(;o!=null&&!a.has(o.id);)a.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(n),n}async end(e,t,n=Date.now(),s){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,s&&Object.keys(s).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...s}}:{metadata:s})}_convertToCreate(e,t,n=!0){let s=e.extra??{};if(s?.runtime?.library===void 0&&(s.runtime||(s.runtime={}),t))for(let[o,u]of Object.entries(t))s.runtime[o]||(s.runtime[o]=u);let i,a;return n?(a=e.parent_run?.id??e.parent_run_id,i=[]):(i=e.child_runs.map(o=>this._convertToCreate(o,t,n)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:s,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,n=!0){let s=this._convertToCreate(this,t,n);if(e===this.project_name)return s;let i=f=>Ba(`${f}:${e}`,Ba.DNS),a=i(s.id),o=s.trace_id?i(s.trace_id):void 0,u=s.parent_run_id?i(s.parent_run_id):void 0,c;if(s.dotted_order){let f=MC(s.dotted_order),p=[];for(let h=0;h<f.length-1;h++){let[m,g]=f[h],y=i(g);p.push(m.toISOString().replace(/[-:]/g,"").replace(".","")+y)}let[d]=f[f.length-1];p.push(d.toISOString().replace(/[-:]/g,"").replace(".","")+a),c=p.join(".")}else c=void 0;return{...s,id:a,trace_id:o,parent_run_id:u,dotted_order:c,session_name:e}}async postRun(e=!0){try{let t=sf();if(this.replicas&&this.replicas.length>0)for(let{projectName:n,apiKey:s,apiUrl:i,workspaceId:a}of this.replicas){let o=this._remapForProject(n??this.project_name,t,!0);await this.client.createRun(o,{apiKey:s,apiUrl:i,workspaceId:a})}else{let n=this._convertToCreate(this,t,e);await this.client.createRun(n)}if(!e){Fu("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let n of this.child_runs)await n.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(let{projectName:t,apiKey:n,apiUrl:s,workspaceId:i,updates:a}of this.replicas){let o=this._remapForProject(t??this.project_name),u={id:o.id,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...a};e?.excludeInputs||(u.inputs=o.inputs),await this.client.updateRun(o.id,u,{apiKey:n,apiUrl:s,workspaceId:i})}else try{let t={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){let n=e?.callbacks,s,i,a,o=vx();if(n){let c=n?.getParentRunId?.()??"",l=n?.handlers?.find(f=>f?.name=="langchain_tracer");s=l?.getRun?.(c),i=l?.projectName,a=l?.client,o=o||!!l}return s?new r({name:s.name,id:s.id,trace_id:s.trace_id,dotted_order:s.dotted_order,client:a,tracingEnabled:o,project_name:i,tags:[...new Set((s?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...s?.extra?.metadata,...e?.metadata}}}).createChild(t):new r({...t,client:a,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){let n="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,s=n["langsmith-trace"];if(!s||typeof s!="string")return;let i=s.trim(),a=i.split(".").map(c=>{let[l,f]=c.split("Z");return{strTime:l,time:Date.parse(l+"Z"),uuid:f}}),o=a[0].uuid,u={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:a.at(-1)?.uuid,trace_id:o,dotted_order:i};if(n.baggage&&typeof n.baggage=="string"){let c=Rf.fromHeader(n.baggage);u.metadata=c.metadata,u.tags=c.tags,u.project_name=c.project_name,u.replicas=c.replicas}return new r(u)}toHeaders(e){let t={"langsmith-trace":this.dotted_order,baggage:new Rf(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(let[n,s]of Object.entries(t))e.set(n,s);return t}};Object.defineProperty(xr,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})});var Nf=_(()=>{Oh()});var Ix=B((WD,Sx)=>{"use strict";Sx.exports=function(r,e){if(typeof r!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,r.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var jx=B((JD,ym)=>{"use strict";var FC=/[\p{Lu}]/u,UC=/[\p{Ll}]/u,Tx=/^[\p{Lu}](?![\p{Lu}])/gu,Rx=/([\p{Alpha}\p{N}_]|$)/u,Nx=/[_.\- ]+/,BC=new RegExp("^"+Nx.source),kx=new RegExp(Nx.source+Rx.source,"gu"),Cx=new RegExp("\\d+"+Rx.source,"gu"),VC=(r,e,t)=>{let n=!1,s=!1,i=!1;for(let a=0;a<r.length;a++){let o=r[a];n&&FC.test(o)?(r=r.slice(0,a)+"-"+r.slice(a),n=!1,i=s,s=!0,a++):s&&i&&UC.test(o)?(r=r.slice(0,a-1)+"-"+r.slice(a-1),i=s,s=!1,n=!0):(n=e(o)===o&&t(o)!==o,i=s,s=t(o)===o&&e(o)!==o)}return r},GC=(r,e)=>(Tx.lastIndex=0,r.replace(Tx,t=>e(t))),ZC=(r,e)=>(kx.lastIndex=0,Cx.lastIndex=0,r.replace(kx,(t,n)=>e(n)).replace(Cx,t=>e(t))),$x=(r,e)=>{if(!(typeof r=="string"||Array.isArray(r)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(r)?r=r.map(i=>i.trim()).filter(i=>i.length).join("-"):r=r.trim(),r.length===0)return"";let t=e.locale===!1?i=>i.toLowerCase():i=>i.toLocaleLowerCase(e.locale),n=e.locale===!1?i=>i.toUpperCase():i=>i.toLocaleUpperCase(e.locale);return r.length===1?e.pascalCase?n(r):t(r):(r!==t(r)&&(r=VC(r,t,n)),r=r.replace(BC,""),e.preserveConsecutiveUppercase?r=GC(r,t):r=t(r),e.pascalCase&&(r=n(r.charAt(0))+r.slice(1)),ZC(r,n))};ym.exports=$x;ym.exports.default=$x});function zx(r,e){return e?.[r]||(0,Mx.default)(r)}function _m(r,e,t){let n={};for(let s in r)Object.hasOwn(r,s)&&(n[e(s,t)]=r[s]);return n}var Mx,qC,wm=_(()=>{Mx=yr(Ix(),1),qC=yr(jx(),1)});function Lx(r){return Array.isArray(r)?[...r]:{...r}}function KC(r,e){let t=Lx(r);for(let[n,s]of Object.entries(e)){let[i,...a]=n.split(".").reverse(),o=t;for(let u of a.reverse()){if(o[u]===void 0)break;o[u]=Lx(o[u]),o=o[u]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return t}function $f(r){let e=Object.getPrototypeOf(r);return typeof r.lc_name=="function"&&(typeof e.lc_name!="function"||r.lc_name()!==e.lc_name())?r.lc_name():r.name}var Et,Ar=_(()=>{wm();Et=class r{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,$f(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([n])=>this.lc_serializable_keys?.includes(n))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof r||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},n=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(n,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let i=this,a=n,[o,...u]=s.split(".").reverse();for(let c of u.reverse()){if(!(c in i)||i[c]===void 0)return;(!(c in a)||a[c]===void 0)&&(typeof i[c]=="object"&&i[c]!=null?a[c]={}:Array.isArray(i[c])&&(a[c]=[])),i=i[c],a=a[c]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:_m(Object.keys(t).length?KC(n,t):n,zx,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}});function Dx(){return vm===void 0&&(vm={library:"langchain-js",runtime:QC()}),vm}function we(r){try{return typeof process<"u"?process.env?.[r]:xm()?Deno?.env.get(r):void 0}catch{return}}var WC,JC,YC,xm,XC,QC,vm,nn=_(()=>{WC=()=>typeof window<"u"&&typeof window.document<"u",JC=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",YC=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),xm=()=>typeof Deno<"u",XC=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!xm(),QC=()=>{let r;return WC()?r="browser":XC()?r="node":JC()?r="webworker":YC()?r="jsdom":xm()?r="deno":r="other",r}});function Em(r){return"lc_prefer_streaming"in r&&r.lc_prefer_streaming}var Am,zn,Fx,ki=_(()=>{vr();Ar();nn();Am=class{};zn=class r extends Am{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,$f(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:we("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Et.prototype.toJSON.call(this)}toJSONNotImplemented(){return Et.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends r{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve()}),Object.assign(this,e)}}return new t}},Fx=r=>{let e=r;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"}});function Pm(r,e){if(r)return new xr({...r,start_time:r._serialized_start_time??r.start_time,parent_run:Pm(e),child_runs:r.child_runs.map(t=>Pm(t)).filter(t=>t!==void 0),extra:{...r.extra,runtime:Dx()},tracingEnabled:!1})}function Om(r,e){return r&&!Array.isArray(r)&&typeof r=="object"?r:{[e]:r}}function qa(r){return typeof r._addRunToRunMap=="function"}var rR,Ot,Er=_(()=>{Nf();ki();nn();rR=r=>{if(r)return r.events=r.events??[],r.child_runs=r.child_runs??[],r};Ot=class extends zn{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?rR(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let{dottedOrder:t,microsecondPrecisionDatestring:n}=bm(new Date(e.start_time).getTime(),e.id,e.execution_order),s={...e},i=this.getRunById(s.parent_run_id);if(s.parent_run_id!==void 0?i&&(this._addChildRun(i,s),i.child_execution_order=Math.max(i.child_execution_order,s.child_execution_order),s.trace_id=i.trace_id,i.dotted_order!==void 0&&(s.dotted_order=[i.dotted_order,t].join("."),s._serialized_start_time=n)):(s.trace_id=s.id,s.dotted_order=t,s._serialized_start_time=n),this.usesRunTreeMap){let a=Pm(s,i);a!==void 0&&this.runTreeMap.set(s.id,a)}else this.runMap.set(s.id,s);return s}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,s,i,a,o,u){let c=this._getExecutionOrder(s),l=Date.now(),f=o?{...i,metadata:o}:i,p={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:f??{},tags:a||[]};return this._addRunToRunMap(p)}async handleLLMStart(e,t,n,s,i,a,o,u){let c=this.getRunById(n)??this._createRunForLLMStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}_createRunForChatModelStart(e,t,n,s,i,a,o,u){let c=this._getExecutionOrder(s),l=Date.now(),f=o?{...i,metadata:o}:i,p={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:f??{},tags:a||[]};return this._addRunToRunMap(p)}async handleChatModelStart(e,t,n,s,i,a,o,u){let c=this.getRunById(n)??this._createRunForChatModelStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onLLMStart?.(c),c}async handleLLMEnd(e,t,n,s,i){let a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMEnd?.(a),await this._endTrace(a),a}async handleLLMError(e,t,n,s,i){let a=this.getRunById(t);if(!a||a?.run_type!=="llm")throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...i},await this.onLLMError?.(a),await this._endTrace(a),a}_createRunForChainStart(e,t,n,s,i,a,o,u){let c=this._getExecutionOrder(s),l=Date.now(),f={id:n,name:u??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(f)}async handleChainStart(e,t,n,s,i,a,o,u){let c=this.getRunById(n)??this._createRunForChainStart(e,t,n,s,i,a,o,u);return await this.onRunCreate?.(c),await this.onChainStart?.(c),c}async handleChainEnd(e,t,n,s,i){let a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Om(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Om(i.inputs,"input")),await this.onChainEnd?.(a),await this._endTrace(a),a}async handleChainError(e,t,n,s,i){let a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),i?.inputs!==void 0&&(a.inputs=Om(i.inputs,"input")),await this.onChainError?.(a),await this._endTrace(a),a}_createRunForToolStart(e,t,n,s,i,a,o){let u=this._getExecutionOrder(s),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,s,i,a,o){let u=this.getRunById(n)??this._createRunForToolStart(e,t,n,s,i,a,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){let n=this.getRunById(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onToolEnd?.(n),await this._endTrace(n),n}async handleToolError(e,t){let n=this.getRunById(t);if(!n||n?.run_type!=="tool")throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onToolError?.(n),await this._endTrace(n),n}async handleAgentAction(e,t){let n=this.getRunById(t);if(!n||n?.run_type!=="chain")return;let s=n;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(n)}async handleAgentEnd(e,t){let n=this.getRunById(t);!n||n?.run_type!=="chain"||(n.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(n))}_createRunForRetrieverStart(e,t,n,s,i,a,o){let u=this._getExecutionOrder(s),c=Date.now(),l={id:n,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,s,i,a,o){let u=this.getRunById(n)??this._createRunForRetrieverStart(e,t,n,s,i,a,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){let n=this.getRunById(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await this.onRetrieverEnd?.(n),await this._endTrace(n),n}async handleRetrieverError(e,t){let n=this.getRunById(t);if(!n||n?.run_type!=="retriever")throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await this.onRetrieverError?.(n),await this._endTrace(n),n}async handleText(e,t){let n=this.getRunById(t);!n||n?.run_type!=="chain"||(n.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(n))}async handleLLMNewToken(e,t,n,s,i,a){let o=this.getRunById(n);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:a?.chunk}),o}}});var Gx=B((s2,Vx)=>{"use strict";var Ux=(r=0)=>e=>`\x1B[${38+r};5;${e}m`,Bx=(r=0)=>(e,t,n)=>`\x1B[${38+r};2;${e};${t};${n}m`;function sR(){let r=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,n]of Object.entries(e)){for(let[s,i]of Object.entries(n))e[s]={open:`\x1B[${i[0]}m`,close:`\x1B[${i[1]}m`},n[s]=e[s],r.set(i[0],i[1]);Object.defineProperty(e,t,{value:n,enumerable:!1})}return Object.defineProperty(e,"codes",{value:r,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Ux(),e.color.ansi16m=Bx(),e.bgColor.ansi256=Ux(10),e.bgColor.ansi16m=Bx(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,n,s)=>t===n&&n===s?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(n/255*5)+Math.round(s/255*5),enumerable:!1},hexToRgb:{value:t=>{let n=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!n)return[0,0,0];let{colorString:s}=n.groups;s.length===3&&(s=s.split("").map(a=>a+a).join(""));let i=Number.parseInt(s,16);return[i>>16&255,i>>8&255,i&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(Vx,"exports",{enumerable:!0,get:sR})});function Pt(r,e){return`${r.open}${e}${r.close}`}function ir(r,e){try{return JSON.stringify(r,null,2)}catch{return e}}function Zx(r){return typeof r=="string"?r.trim():r==null?r:ir(r,r.toString())}function ys(r){if(!r.end_time)return"";let e=r.end_time-r.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var Sm,zt,Hu,Im=_(()=>{Sm=yr(Gx(),1);Er();({color:zt}=Sm.default),Hu=class extends Ot{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],n=e;for(;n.parent_run_id;){let s=this.runMap.get(n.parent_run_id);if(s)t.push(s),n=s;else break}return t}getBreadcrumbs(e){let n=[...this.getParents(e).reverse(),e].map((s,i,a)=>{let o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?Pt(Sm.default.bold,o):o}).join(" > ");return Pt(zt.grey,n)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${ir(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.cyan,"[chain/end]")} [${t}] [${ys(e)}] Exiting Chain run with output: ${ir(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.red,"[chain/error]")} [${t}] [${ys(e)}] Chain run errored with error: ${ir(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${Pt(zt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${ir(n,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.cyan,"[llm/end]")} [${t}] [${ys(e)}] Exiting LLM run with output: ${ir(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.red,"[llm/error]")} [${t}] [${ys(e)}] LLM run errored with error: ${ir(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Zx(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.cyan,"[tool/end]")} [${t}] [${ys(e)}] Exiting Tool run with output: "${Zx(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.red,"[tool/error]")} [${t}] [${ys(e)}] Tool run errored with error: ${ir(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${ir(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.cyan,"[retriever/end]")} [${t}] [${ys(e)}] Exiting Retriever run with output: ${ir(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${Pt(zt.red,"[retriever/error]")} [${t}] [${ys(e)}] Retriever run errored with error: ${ir(e.error,"[error]")}`)}onAgentAction(e){let t=e,n=this.getBreadcrumbs(e);console.log(`${Pt(zt.blue,"[agent/action]")} [${n}] Agent selected action: ${ir(t.actions[t.actions.length-1],"[action]")}`)}}});function _s(r,e){return r.lc_error_code=e,r.message=`${r.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,r}var Wu=_(()=>{});function ws(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="tool_call")}function qx(r){return!!(r&&typeof r=="object"&&"toolCall"in r&&r.toolCall!=null&&typeof r.toolCall=="object"&&"id"in r.toolCall&&typeof r.toolCall.id=="string")}var Ci,jf=_(()=>{Ci=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}});function Tm(r,e=Ka){r=r.trim();let t=r.indexOf("```");if(t===-1)return e(r);let n=r.substring(t+3);n.startsWith(`json
`)?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith(`
`)&&(n=n.substring(1));let s=n.indexOf("```"),i=n;return s!==-1&&(i=n.substring(0,s)),e(i.trim())}function Ka(r){if(typeof r>"u")return null;try{return JSON.parse(r)}catch{}let e="",t=[],n=!1,s=!1;for(let i of r){if(n)i==='"'&&!s?n=!1:i===`
`&&!s?i="\\n":i==="\\"?s=!s:s=!1;else if(i==='"')n=!0,s=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}n&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}var km=_(()=>{});function Ha(r){return typeof r=="object"&&r!==null&&"type"in r&&typeof r.type=="string"&&"source_type"in r&&(r.source_type==="url"||r.source_type==="base64"||r.source_type==="text"||r.source_type==="id")}function Kx(r){return Ha(r)&&r.source_type==="url"&&"url"in r&&typeof r.url=="string"}function Hx(r){return Ha(r)&&r.source_type==="base64"&&"data"in r&&typeof r.data=="string"}function Wx(r){if(Ha(r)){if(r.source_type==="url")return{type:"image_url",image_url:{url:r.url}};if(r.source_type==="base64"){if(!r.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${r.mime_type};base64,${r.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}var Cm=_(()=>{});function ar(r,e){return typeof r=="string"?r===""?e:typeof e=="string"?r+e:Array.isArray(e)&&e.some(t=>Ha(t))?[{type:"text",source_type:"text",text:r},...e]:[{type:"text",text:r},...e]:Array.isArray(e)?Ju(r,e)??[...r,...e]:e===""?r:Array.isArray(r)&&r.some(t=>Ha(t))?[...r,{type:"file",source_type:"text",text:e}]:[...r,{type:"text",text:e}]}function Jx(r,e){return r==="error"||e==="error"?"error":"success"}function aR(r,e){function t(n,s){if(typeof n!="object"||n===null||n===void 0)return n;if(s>=e)return Array.isArray(n)?"[Array]":"[Object]";if(Array.isArray(n))return n.map(a=>t(a,s+1));let i={};for(let a of Object.keys(n))i[a]=t(n[a],s+1);return i}return JSON.stringify(t(r,0),null,2)}function Ne(r,e){let t={...r};for(let[n,s]of Object.entries(e))if(t[n]==null)t[n]=s;else{if(s==null)continue;if(typeof t[n]!=typeof s||Array.isArray(t[n])!==Array.isArray(s))throw new Error(`field[${n}] already exists in the message chunk, but with a different type.`);if(typeof t[n]=="string"){if(n==="type")continue;["id","name","output_version","model_provider"].includes(n)?t[n]=s:t[n]+=s}else if(typeof t[n]=="object"&&!Array.isArray(t[n]))t[n]=Ne(t[n],s);else if(Array.isArray(t[n]))t[n]=Ju(t[n],s);else{if(t[n]===s)continue;console.warn(`field[${n}] already exists in this message chunk and value has unsupported type.`)}}return t}function Ju(r,e){if(!(r===void 0&&e===void 0)){if(r===void 0||e===void 0)return r||e;{let t=[...r];for(let n of e)if(typeof n=="object"&&n!==null&&"index"in n&&typeof n.index=="number"){let s=t.findIndex(i=>{let a=typeof i=="object",o="index"in i&&i.index===n.index,u="id"in i&&"id"in n&&i?.id===n?.id,c=!("id"in i)||!i?.id||!("id"in n)||!n?.id;return a&&o&&(u||c)});s!==-1&&typeof t[s]=="object"&&t[s]!==null?t[s]=Ne(t[s],n):t.push(n)}else{if(typeof n=="object"&&n!==null&&"text"in n&&n.text==="")continue;t.push(n)}return t}}}function Yx(r,e){if(!r&&!e)throw new Error("Cannot merge two undefined objects.");if(!r||!e)return r||e;if(typeof r!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof r}
Right ${typeof e}`);if(typeof r=="string"&&typeof e=="string")return r+e;if(Array.isArray(r)&&Array.isArray(e))return Ju(r,e);if(typeof r=="object"&&typeof e=="object")return Ne(r,e);if(r===e)return r;throw new Error(`Can not merge objects of different types.
Left ${r}
Right ${e}`)}function Xx(r){return typeof r.role=="string"}function Ue(r){return typeof r?._getType=="function"}function Wa(r){return Ue(r)&&typeof r.concat=="function"}var ze,Lt,or=_(()=>{Ar();Cm();ze=class extends Et{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=aR(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};Lt=class extends ze{}});function Qx(r){return r!=null&&typeof r=="object"&&"lc_direct_tool_output"in r&&r.lc_direct_tool_output===!0}function e0(r){let e=[],t=[];for(let n of r)if(n.function){let s=n.function.name;try{let i=JSON.parse(n.function.arguments),a={name:s||"",args:i||{},id:n.id};e.push(a)}catch{t.push({name:s,args:n.function.arguments,id:n.id,error:"Malformed args."})}}else continue;return[e,t]}function Rm(r){return r._getType()==="tool"}var Ln,Ja,Ya=_(()=>{or();Ln=class extends ze{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){typeof e=="string"&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Ja=class r extends Lt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new r({content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),artifact:Yx(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Jx(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}});function Ri(r){return r._getType()==="ai"}function Nm(r){return r._getType()==="ai"}var dt,St,Ni=_(()=>{km();or();Ya();dt=class extends ze{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if(typeof e=="string")n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;let s=n.additional_kwargs?.tool_calls,i=n.tool_calls;s!=null&&s.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(s!=null&&i===void 0){let[a,o]=e0(s);n.tool_calls=a??[],n.invalid_tool_calls=o??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch{n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof n!="string"&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};St=class r extends Lt{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0||e.tool_call_chunks.length===0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{let s=(e.tool_call_chunks??[]).reduce((o,u)=>{let c=o.findIndex(([l])=>"id"in u&&u.id&&"index"in u&&u.index!==void 0?u.id===l.id&&u.index===l.index:"id"in u&&u.id?u.id===l.id:"index"in u&&u.index!==void 0?u.index===l.index:!1);return c!==-1?o[c].push(u):o.push([u]),o},[]),i=[],a=[];for(let o of s){let u={},c=o[0]?.name??"",l=o.map(d=>d.args||"").join(""),f=l.length?l:"{}",p=o[0]?.id;try{if(u=Ka(f),!p||u===null||typeof u!="object"||Array.isArray(u))throw new Error("Malformed tool call chunk args.");i.push({name:c,args:u,id:p,type:"tool_call"})}catch{a.push({name:c,args:f,id:p,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:i,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let n=Ju(this.tool_call_chunks,e.tool_call_chunks);n!==void 0&&n.length>0&&(t.tool_call_chunks=n)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let n={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},s={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:i.input_tokens+a.input_tokens,output_tokens:i.output_tokens+a.output_tokens,total_tokens:i.total_tokens+a.total_tokens,...Object.keys(n).length>0&&{input_token_details:n},...Object.keys(s).length>0&&{output_token_details:s}};t.usage_metadata=o}return new r(t)}}});var Or,$i,Mf=_(()=>{or();Or=class r extends ze{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return r}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},$i=class r extends Lt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new r({content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}});var ji,zf=_(()=>{or();ji=class r extends Lt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new r({content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}});var ht,Mi,Yu=_(()=>{or();ht=class extends ze{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}},Mi=class r extends Lt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new r({content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});var Xu,Lf=_(()=>{or();Xu=class extends ze{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}});var vs,xs,Df=_(()=>{or();vs=class extends ze{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}},xs=class r extends Lt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new r({content:ar(this.content,e.content),additional_kwargs:Ne(this.additional_kwargs,e.additional_kwargs),response_metadata:Ne(this.response_metadata,e.response_metadata),id:this.id??e.id})}}});function uR(r){return ws(r)?r:typeof r.id=="string"&&r.type==="function"&&typeof r.function=="object"&&r.function!==null&&"arguments"in r.function&&typeof r.function.arguments=="string"&&"name"in r.function&&typeof r.function.name=="string"?{id:r.id,args:JSON.parse(r.function.arguments),name:r.function.name,type:"tool_call"}:r}function cR(r){return typeof r=="object"&&r!=null&&r.lc===1&&Array.isArray(r.id)&&r.kwargs!=null&&typeof r.kwargs=="object"}function $m(r){let e,t;if(cR(r)){let n=r.id.at(-1);n==="HumanMessage"||n==="HumanMessageChunk"?e="user":n==="AIMessage"||n==="AIMessageChunk"?e="assistant":n==="SystemMessage"||n==="SystemMessageChunk"?e="system":n==="FunctionMessage"||n==="FunctionMessageChunk"?e="function":n==="ToolMessage"||n==="ToolMessageChunk"?e="tool":e="unknown",t=r.kwargs}else{let{type:n,...s}=r;e=n,t=s}if(e==="human"||e==="user")return new ht(t);if(e==="ai"||e==="assistant"){let{tool_calls:n,...s}=t;if(!Array.isArray(n))return new dt(t);let i=n.map(uR);return new dt({...s,tool_calls:i})}else{if(e==="system")return new vs(t);if(e==="developer")return new vs({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new Ln({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});if(e==="remove"&&"id"in t&&typeof t.id=="string")return new Xu({...t,id:t.id});throw _s(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(r,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function Dt(r){if(typeof r=="string")return new ht(r);if(Ue(r))return r;if(Array.isArray(r)){let[e,t]=r;return $m({type:e,content:t})}else if(Xx(r)){let{role:e,...t}=r;return $m({...t,type:e})}else return $m(r)}function Xa(r,e="Human",t="AI"){let n=[];for(let s of r){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=t;else if(s._getType()==="system")i="System";else if(s._getType()==="function")i="Function";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);let a=s.name?`${s.name}, `:"",o=typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2);n.push(`${i}: ${a}${o}`)}return n.join(`
`)}function jm(r){let e=r._getType();if(e==="human")return new Mi({...r});if(e==="ai"){let t={...r};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(n=>({...n,type:"tool_call_chunk",index:void 0,args:JSON.stringify(n.args)}))}),new St({...t})}else{if(e==="system")return new xs({...r});if(e==="function")return new ji({...r});if(Or.isInstance(r))return new $i({...r});throw new Error("Unknown message type.")}}var Dn=_(()=>{Wu();jf();Ni();or();Mf();zf();Yu();Lf();Df();Ya()});var Ff=_(()=>{nf()});var Mm,zm,Lm=_(()=>{Ff();nn();zm=()=>{if(Mm===void 0){let r=we("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Mm=new Ii(r)}return Mm}});var zi,Uf=_(()=>{Ff();Nf();hh();Er();Lm();zi=class r extends Ot{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});let{exampleId:t,projectName:n,client:s,replicas:i}=e;this.projectName=n??zu(),this.replicas=i,this.exampleId=t,this.client=s??zm();let a=r.getTraceableRunTree();a&&this.updateFromRunTree(a)}async persistRun(e){}async onRunCreate(e){await this.getRunTreeWithTracingConfig(e.id)?.postRun()}async onRunUpdate(e){await this.getRunTreeWithTracingConfig(e.id)?.patchRun()}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e,n=new Set;for(;t.parent_run&&!(n.has(t.id)||(n.add(t.id),!t.parent_run));)t=t.parent_run;n.clear();let s=[t];for(;s.length>0;){let i=s.shift();!i||n.has(i.id)||(n.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&s.push(...i.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){let t=this.runTreeMap.get(e);if(t)return new xr({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return __(!0)}catch{return}}}});var t0,Li,r0,As,Qu=_(()=>{t0=Symbol.for("ls:tracing_async_local_storage"),Li=Symbol.for("lc:context_variables"),r0=r=>{globalThis[t0]=r},As=()=>globalThis[t0]});function fR(){let r="default"in Bf.default?Bf.default.default:Bf.default;return new r({autoStart:!0,concurrency:1})}function pR(){return typeof ec>"u"&&(ec=fR()),ec}async function $e(r,e){if(e===!0){let t=As();t!==void 0?await t.run(void 0,async()=>r()):await r()}else ec=pR(),ec.add(async()=>{let t=As();t!==void 0?await t.run(void 0,async()=>r()):await r()})}var Bf,ec,n0=_(()=>{Bf=yr(df(),1);Qu();Lm()});var Dm=_(()=>{n0()});var s0,i0=_(()=>{nn();s0=r=>r!==void 0?r:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>we(t)==="true")});function Fm(r){let e=As();return e===void 0?void 0:e.getStore()?.[Li]?.[r]}var hR,a0,o0=_(()=>{Nf();Qu();hR=Symbol("lc:configure_hooks"),a0=()=>Fm(hR)||[]});function Zm(r){return r?Array.isArray(r)||"name"in r?{callbacks:r}:r:{}}function tc(r){return"name"in r?r:zn.fromMethods(r)}var Um,Qa,Bm,Vf,Vm,Gm,We,Es=_(()=>{vr();ki();Im();Dn();nn();Uf();Dm();i0();Er();o0();Um=class{setHandler(e){return this.setHandlers([e])}},Qa=class{constructor(e,t,n,s,i,a,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>$e(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleCustomEvent(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{try{await a.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},Bm=class extends Qa{getChild(e){let t=new We(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw n}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}},t.awaitHandlers)))}},Vf=class extends Qa{async handleLLMNewToken(e,t,n,s,i,a){await Promise.all(this.handlers.map(o=>$e(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{if(!a.ignoreLLM)try{await a.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleLLMEnd(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{if(!a.ignoreLLM)try{await a.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}},Vm=class extends Qa{getChild(e){let t=new We(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{if(!a.ignoreChain)try{await a.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainError: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleChainEnd(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{if(!a.ignoreChain)try{await a.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainEnd: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}},Gm=class extends Qa{getChild(e){let t=new We(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>$e(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${n}`),t.raiseError)throw n}},t.awaitHandlers)))}},We=class r extends Um{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let f=l===0&&n?n:ve();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qa(p)&&p._createRunForLLMStart(e,[c],f,this._parentRunId,i,this.tags,this.metadata,u),$e(async()=>{try{await p.handleLLMStart?.(e,[c],f,this._parentRunId,i,this.tags,this.metadata,u)}catch(d){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${d}`),p.raiseError)throw d}},p.awaitHandlers)})),new Vf(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,s=void 0,i=void 0,a=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let f=l===0&&n?n:ve();return await Promise.all(this.handlers.map(p=>{if(!p.ignoreLLM)return qa(p)&&p._createRunForChatModelStart(e,[c],f,this._parentRunId,i,this.tags,this.metadata,u),$e(async()=>{try{if(p.handleChatModelStart)await p.handleChatModelStart?.(e,[c],f,this._parentRunId,i,this.tags,this.metadata,u);else if(p.handleLLMStart){let d=Xa(c);await p.handleLLMStart?.(e,[d],f,this._parentRunId,i,this.tags,this.metadata,u)}}catch(d){if((p.raiseError?console.error:console.warn)(`Error in handler ${p.constructor.name}, handleLLMStart: ${d}`),p.raiseError)throw d}},p.awaitHandlers)})),new Vf(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return qa(u)&&u._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,s,o),$e(async()=>{try{await u.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,s,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new Vm(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return qa(u)&&u._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),$e(async()=>{try{await u.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new Gm(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return qa(u)&&u._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,o),$e(async()=>{try{await u.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,o)}catch(c){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${c}`),u.raiseError)throw c}},u.awaitHandlers)})),new Bm(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,s,i){await Promise.all(this.handlers.map(a=>$e(async()=>{if(!a.ignoreCustomEvent)try{await a.handleCustomEvent?.(e,t,n,this.tags,this.metadata)}catch(o){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${o}`),a.raiseError)throw o}},a.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let n=new r(this._parentRunId);for(let s of this.handlers){let i=this.inheritableHandlers.includes(s);n.addHandler(s,i)}for(let s of this.tags){let i=this.inheritableTags.includes(s);n.addTags([s],i)}for(let s of Object.keys(this.metadata)){let i=Object.keys(this.inheritableMetadata).includes(s);n.addMetadata({[s]:this.metadata[s]},i)}for(let s of e)n.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===s.name)||n.addHandler(s,t);return n}static fromHandlers(e){class t extends zn{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve()}),Object.assign(this,e)}}let n=new this;return n.addHandler(new t),n}static configure(e,t,n,s,i,a,o){return this._configureSync(e,t,n,s,i,a,o)}static _configureSync(e,t,n,s,i,a,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new r,u.setHandlers(e?.map(tc)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(tc):t?.handlers,!1));let c=we("LANGCHAIN_VERBOSE")==="true"||o?.verbose,l=zi.getTraceableRunTree()?.tracingEnabled||s0(),f=l||(we("LANGCHAIN_TRACING")??!1);if(c||f){if(u||(u=new r),c&&!u.handlers.some(p=>p.name===Hu.prototype.name)){let p=new Hu;u.addHandler(p,!0)}if(f&&!u.handlers.some(p=>p.name==="langchain_tracer")&&l){let p=new zi;u.addHandler(p,!0)}if(l){let p=zi.getTraceableRunTree();p&&u._parentRunId===void 0&&(u._parentRunId=p.id,u.handlers.find(h=>h.name==="langchain_tracer")?.updateFromRunTree(p))}}for(let{contextVar:p,inheritable:d=!0,handlerClass:h,envVar:m}of a0()){let g=m&&we(m)==="true"&&h,y,b=p!==void 0?Fm(p):void 0;b&&Fx(b)?y=b:g&&(y=new h({})),y!==void 0&&(u||(u=new r),u.handlers.some(w=>w.name===y.name)||u.addHandler(y,d))}return(n||s)&&u&&(u.addTags(n??[]),u.addTags(s??[],!1)),(i||a)&&u&&(u.addMetadata(i??{}),u.addMetadata(a??{},!1)),u}}});var Gf,gR,u0,qm,Ce,c0=_(()=>{Ff();Qu();Es();Gf=class{getStore(){}run(e,t){return t()}enterWith(e){}},gR=new Gf,u0=Symbol.for("lc:child_config"),qm=class{getInstance(){return As()??gR}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[u0]}runWithConfig(e,t,n){let s=We._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),a=i.getStore(),o=s?.getParentRunId(),u=s?.handlers?.find(l=>l?.name==="langchain_tracer"),c;return u&&o?c=u.getRunTreeWithTracingConfig(o):n||(c=new xr({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[u0]:e}),a!==void 0&&a[Li]!==void 0&&(c===void 0&&(c={}),c[Li]=a[Li]),i.run(c,t)}initializeGlobalInstance(e){As()===void 0&&r0(e)}},Ce=new qm});var Di=_(()=>{c0();Qu()});async function mt(r){return We._configureSync(r?.callbacks,void 0,r?.tags,void 0,r?.metadata)}function nt(...r){let e={};for(let t of r.filter(n=>!!n))for(let n of Object.keys(t))if(n==="metadata")e[n]={...e[n],...t[n]};else if(n==="tags"){let s=e[n]??[];e[n]=[...new Set(s.concat(t[n]??[]))]}else if(n==="configurable")e[n]={...e[n],...t[n]};else if(n==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(n==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(n==="callbacks"){let s=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!s)e.callbacks=i;else if(Array.isArray(s))e.callbacks=s.concat(i);else{let a=s.copy();for(let o of i)a.addHandler(tc(o),!0);e.callbacks=a}else if(i)if(!s)e.callbacks=i;else if(Array.isArray(s)){let a=i.copy();for(let o of s)a.addHandler(tc(o),!0);e.callbacks=a}else e.callbacks=new We(i._parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else{let s=n;e[s]=t[s]??e[s]}return e}function fe(r){let e=Ce.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:n,runName:s,...i}=e;t=Object.entries(i).reduce((a,[o,u])=>(u!==void 0&&(a[o]=u),a),t)}if(r&&(t=Object.entries(r).reduce((n,[s,i])=>(i!==void 0&&(n[s]=i),n),t)),t?.configurable)for(let n of Object.keys(t.configurable))bR.has(typeof t.configurable[n])&&!t.metadata?.[n]&&(t.metadata||(t.metadata={}),t.metadata[n]=t.configurable[n]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");let n=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,n])):t.signal=n,delete t.timeout}return t}function be(r={},{callbacks:e,maxConcurrency:t,recursionLimit:n,runName:s,configurable:i,runId:a}={}){let o=fe(r);return e!==void 0&&(delete o.runName,o.callbacks=e),n!==void 0&&(o.recursionLimit=n),t!==void 0&&(o.maxConcurrency=t),s!==void 0&&(o.runName=s),i!==void 0&&(o.configurable={...o.configurable,...i}),a!==void 0&&delete o.runId,o}function Pr(r){return r?{configurable:r.configurable,recursionLimit:r.recursionLimit,callbacks:r.callbacks,tags:r.tags,metadata:r.metadata,maxConcurrency:r.maxConcurrency,timeout:r.timeout,signal:r.signal}:void 0}var Zf,bR,sn=_(()=>{Es();Di();Zf=25;bR=new Set(["string","number","boolean"])});async function an(r,e){if(e===void 0)return r;let t;return Promise.race([r.catch(n=>{if(!e?.aborted)throw n}),new Promise((n,s)=>{t=()=>{s(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&s(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}var Km=_(()=>{});function Hm(r,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){let i=await r.next();for(let a of t)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function Un(r,e){if(Array.isArray(r)&&Array.isArray(e))return r.concat(e);if(typeof r=="string"&&typeof e=="string")return r+e;if(typeof r=="number"&&typeof e=="number")return r+e;if("concat"in r&&typeof r.concat=="function")return r.concat(e);if(typeof r=="object"&&typeof e=="object"){let t={...r};for(let[n,s]of Object.entries(e))n in t&&!Array.isArray(t[n])?t[n]=Un(t[n],s):t[n]=s;return t}else throw new Error(`Cannot concat ${typeof r} and ${typeof e}`)}async function l0(r,e,t,n,...s){let i=new Fn({generator:e,startSetup:t,signal:n}),a=await i.setup;return{output:r(i,a,...s),setup:a}}var Be,Fn,Sr=_(()=>{sn();Di();Km();Be=class r extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new r({start(n){return s();function s(){return t.read().then(({done:i,value:a})=>{if(i){n.close();return}return n.enqueue(a),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new r({async pull(t){let{value:n,done:s}=await e.next();s&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}};Fn=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,n)=>{Ce.runWithConfig(Pr(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then(s=>t(void 0),n)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?Ce.runWithConfig(Pr(this.config),this.signal?async()=>an(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}});async function f0(r,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=r;if(["retriever","llm","prompt"].includes(r.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function p0(r,e){let{outputs:t}=r;return e==="original"||["retriever","llm","prompt"].includes(r.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function _R(r){return r!==void 0&&r.message!==void 0}var Ir,rc,d0,nc,Wm=_(()=>{gh();Er();Sr();Ni();Ir=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),n=bs({},t);return new rc({ops:t,state:n[n.length-1].newDocument})}},rc=class r extends Ir{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),n=bs(this.state,e.ops);return new r({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){let t=bs({},e.ops);return new r({ops:e.ops,state:t[t.length-1].newDocument})}},d0=r=>r.name==="log_stream_tracer";nc=class extends Ot{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Be.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(n=n||t.find(s=>this.includeTags?.includes(s))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(n=n&&t.every(s=>!this.excludeTags?.includes(s))),n}async*tapOutputIterable(e,t){for await(let n of t){if(e!==this.rootId){let s=this.keyMapByRunId[e];s&&await this.writer.write(new Ir({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Ir({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(n.inputs=await f0(e,this._schemaFormat)),await this.writer.write(new Ir({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let n=[];this._schemaFormat==="streaming_events"&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await f0(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await p0(e,this._schemaFormat)}),e.end_time!==void 0&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let s=new Ir({ops:n});await this.writer.write(s)}finally{if(e.id===this.rootId){let t=new Ir({ops:[{op:"replace",path:"/final_output",value:await p0(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){let s=this.keyMapByRunId[e.id];if(s===void 0)return;let i=e.inputs.messages!==void 0,a;i?_R(n?.chunk)?a=n?.chunk:a=new St({id:`run-${e.id}`,content:t}):a=t;let o=new Ir({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:a}]});await this.writer.write(o)}}});var qf,Tr,Bn,Os=_(()=>{qf="__run",Tr=class r{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new r({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},Bn=class r extends Tr{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new r({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}});function Kf({name:r,serialized:e}){return r!==void 0?r:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var h0,Hf,m0=_(()=>{Er();Sr();Ni();Os();h0=r=>r.name==="event_stream_tracer",Hf=class extends Ot{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Be.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],n=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(n=n||t.find(s=>this.includeTags?.includes(s))!==void 0),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(n=n&&t.every(s=>!this.excludeTags?.includes(s))),n}async*tapOutputIterable(e,t){let n=await t.next();if(n.done)return;let s=this.runInfoMap.get(e);if(s===void 0){yield n.value;return}function i(o,u){return o==="llm"&&typeof u=="string"?new Tr({text:u}):u}let a=this.tappedPromises.get(e);if(a===void 0){let o;a=new Promise(u=>{o=u}),this.tappedPromises.set(e,a);try{let u={event:`on_${s.runType}_stream`,run_id:e,name:s.name,tags:s.tags,metadata:s.metadata,data:{}};await this.send({...u,data:{chunk:i(s.runType,n.value)}},s),yield n.value;for await(let c of t)s.runType!=="tool"&&s.runType!=="retriever"&&await this.send({...u,data:{chunk:i(s.runType,c)}},s),yield c}finally{o()}}else{yield n.value;for await(let o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let n=this.tappedPromises.get(e.run_id);n!==void 0?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Kf(e),n=e.inputs.messages!==void 0?"chat_model":"llm",s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,s);let i=`on_${n}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onLLMNewToken(e,t,n){let s=this.runInfoMap.get(e.id),i,a;if(s===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(s.runType==="chat_model")a="on_chat_model_stream",n?.chunk===void 0?i=new St({content:t,id:`run-${e.id}`}):i=n.chunk.message;else if(s.runType==="llm")a="on_llm_stream",n?.chunk===void 0?i=new Tr({text:t}):i=n.chunk;else throw new Error(`Unexpected run type ${s.runType}`);await this.send({event:a,data:{chunk:i},run_id:e.id,name:s.name,tags:s.tags,metadata:s.metadata},s)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let n;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let s=e.outputs?.generations,i;if(t.runType==="chat_model"){for(let a of s??[]){if(i!==void 0)break;i=a[0]?.message}n="on_chat_model_end"}else if(t.runType==="llm")i={generations:s?.map(a=>a.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:n,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Kf(e),n=e.run_type??"chain",s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},s.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,s.inputs=e.inputs.input):(i.input=e.inputs,s.inputs=e.inputs),this.runInfoMap.set(e.id,s),await this.send({event:`on_${n}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let n=`on_${e.run_type}_end`,s=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:s};s.input&&Object.keys(s).length===1&&(a.input=s.input,t.inputs=s.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Kf(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let n=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Kf(e),s={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,s),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},s)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){let s=this.runInfoMap.get(n);if(s===void 0)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:s.tags,metadata:s.metadata,data:t},s)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}});var g0,Wf,xR,AR,Vn,eo=_(()=>{g0=yr(Ul(),1),Wf=yr(df(),1),xR=[400,401,402,403,404,405,406,407,409],AR=r=>{if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||r?.code==="ECONNABORTED")throw r;let e=r?.response?.status??r?.status;if(e&&xR.includes(+e))throw r;if(r?.error?.code==="insufficient_quota"){let t=new Error(r?.message);throw t.name="InsufficientQuotaError",t}},Vn=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??AR;let t="default"in Wf.default?Wf.default.default:Wf.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,g0.default)(()=>e(...t).catch(n=>{throw n instanceof Error?n:new Error(n)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise((s,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}});var sc,b0=_(()=>{Er();sc=class extends Ot{constructor({config:e,onStart:t,onEnd:n,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}});function ic(r){return r?r.lc_runnable:!1}var Jf,Jm=_(()=>{Jf=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,s=e.tags??[];return this.includeNames!==void 0&&(n=n||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(n=n||this.includeTypes.includes(t)),this.includeTags!==void 0&&(n=n||s.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(n=n&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(n=n&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(n=n&&s.every(i=>!this.excludeTags?.includes(i))),n}}});function Ym(r){return r.replace(/[^a-zA-Z-_0-9]/g,"_")}function PR(r){let e="";for(let[t,n]of Object.entries(r))e+=`	classDef ${t} ${n};
`;return e}function y0(r,e,t){let{firstNode:n,lastNode:s,nodeColors:i,withStyles:a=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{},c=a?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(a){let d="default",h={[d]:"{0}({1})"};n!==void 0&&(h[n]="{0}([{1}]):::first"),s!==void 0&&(h[s]="{0}([{1}]):::last");for(let[m,g]of Object.entries(r)){let y=g.name.split(":").pop()??"",w=OR.some(A=>y.startsWith(A)&&y.endsWith(A))?`<p>${y}</p>`:y;Object.keys(g.metadata??{}).length&&(w+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([A,P])=>`${A} = ${P}`).join(`
`)}</em></small>`);let x=(h[m]??h[d]).replace("{0}",Ym(m)).replace("{1}",w);c+=`	${x}
`}}let l={};for(let d of e){let h=d.source.split(":"),m=d.target.split(":"),g=h.filter((y,b)=>y===m[b]).join(":");l[g]||(l[g]=[]),l[g].push(d)}let f=new Set;function p(d,h){let m=d.length===1&&d[0].source===d[0].target;if(h&&!m){let g=h.split(":").pop();if(f.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);f.add(g),c+=`	subgraph ${g}
`}for(let g of d){let{source:y,target:b,data:w,conditional:x}=g,A="";if(w!==void 0){let P=w,M=P.split(" ");M.length>u&&(P=Array.from({length:Math.ceil(M.length/u)},(N,I)=>M.slice(I*u,(I+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),A=x?` -. &nbsp;${P}&nbsp; .-> `:` -- &nbsp;${P}&nbsp; --> `}else A=x?" -.-> ":" --> ";c+=`	${Ym(y)}${A}${Ym(b)};
`}for(let g in l)g.startsWith(`${h}:`)&&g!==h&&p(l[g],g);h&&!m&&(c+=`	end
`)}p(l[""]??[],"");for(let d in l)!d.includes(":")&&d!==""&&p(l[d],d);return a&&(c+=PR(i??{})),c}async function _0(r,e){return SR(r,{...e,imageType:"png"})}async function SR(r,e){let t=e?.backgroundColor??"white",n=e?.imageType??"png",s=btoa(r);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let i=`https://mermaid.ink/img/${s}?bgColor=${t}&type=${n}`,a=await fetch(i);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join(`
`));return await a.blob()}var OR,w0=_(()=>{OR=["*","_","`"]});function to(r,e,t){function n(o,u){var c;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(c=o._zod).traits??(c.traits=new Set),o._zod.traits.add(r),e(o,u);for(let l in a.prototype)l in o||Object.defineProperty(o,l,{value:a.prototype[l].bind(o)});o._zod.constr=a,o._zod.def=u}let s=t?.Parent??Object;class i extends s{}Object.defineProperty(i,"name",{value:r});function a(o){var u;let c=t?.Parent?new i:this;n(c,o),(u=c._zod).deferred??(u.deferred=[]);for(let l of c._zod.deferred)l();return c}return Object.defineProperty(a,"init",{value:n}),Object.defineProperty(a,Symbol.hasInstance,{value:o=>t?.Parent&&o instanceof t.Parent?!0:o?._zod?.traits?.has(r)}),Object.defineProperty(a,"name",{value:r}),a}function ro(r){return r&&Object.assign(Xm,r),Xm}var GF,ZF,Ps,Xm,ac=_(()=>{GF=Object.freeze({status:"aborted"});ZF=Symbol("zod_brand"),Ps=class extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},Xm={}});function Qm(r){let e=Object.values(r).filter(n=>typeof n=="number");return Object.entries(r).filter(([n,s])=>e.indexOf(+n)===-1).map(([n,s])=>s)}function x0(r,e){return typeof e=="bigint"?e.toString():e}function A0(r){return{get value(){{let t=r();return Object.defineProperty(this,"value",{value:t}),t}throw new Error("cached value already set")}}}function no(r,e,t){let n=new r._zod.constr(e??r._zod.def);return(!e||t?.parent)&&(n._zod.parent=r),n}function E0(r){let e=r;if(!e)return{};if(typeof e=="string")return{error:()=>e};if(e?.message!==void 0){if(e?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");e.error=e.message}return delete e.message,typeof e.error=="string"?{...e,error:()=>e.error}:e}function Xf(r,e=0){for(let t=e;t<r.issues.length;t++)if(r.issues[t]?.continue!==!0)return!0;return!1}function Yf(r){return typeof r=="string"?r:r?.message}function so(r,e,t){let n={...r,path:r.path??[]};if(!r.message){let s=Yf(r.inst?._zod.def?.error?.(r))??Yf(e?.error?.(r))??Yf(t.customError?.(r))??Yf(t.localeError?.(r))??"Invalid input";n.message=s}return delete n.inst,delete n.continue,e?.reportInput||delete n.input,n}var eg,IR,qF,Ss=_(()=>{eg=Error.captureStackTrace?Error.captureStackTrace:(...r)=>{},IR=A0(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{let r=Function;return new r(""),!0}catch{return!1}});qF={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]}});var O0,P0,oc,tg=_(()=>{ac();Ss();O0=(r,e)=>{r.name="$ZodError",Object.defineProperty(r,"_zod",{value:r._zod,enumerable:!1}),Object.defineProperty(r,"issues",{value:e,enumerable:!1}),Object.defineProperty(r,"message",{get(){return JSON.stringify(e,x0,2)},enumerable:!0}),Object.defineProperty(r,"toString",{value:()=>r.message,enumerable:!1})},P0=to("$ZodError",O0),oc=to("$ZodError",O0,{Parent:Error})});var kR,S0,CR,I0,RR,T0,NR,k0,rg=_(()=>{ac();tg();Ss();kR=r=>(e,t,n,s)=>{let i=n?Object.assign(n,{async:!1}):{async:!1},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise)throw new Ps;if(a.issues.length){let o=new(s?.Err??r)(a.issues.map(u=>so(u,i,ro())));throw eg(o,s?.callee),o}return a.value},S0=kR(oc),CR=r=>async(e,t,n,s)=>{let i=n?Object.assign(n,{async:!0}):{async:!0},a=e._zod.run({value:t,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){let o=new(s?.Err??r)(a.issues.map(u=>so(u,i,ro())));throw eg(o,s?.callee),o}return a.value},I0=CR(oc),RR=r=>(e,t,n)=>{let s=n?{...n,async:!1}:{async:!1},i=e._zod.run({value:t,issues:[]},s);if(i instanceof Promise)throw new Ps;return i.issues.length?{success:!1,error:new(r??P0)(i.issues.map(a=>so(a,s,ro())))}:{success:!0,data:i.value}},T0=RR(oc),NR=r=>async(e,t,n)=>{let s=n?Object.assign(n,{async:!0}):{async:!0},i=e._zod.run({value:t,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new r(i.issues.map(a=>so(a,s,ro())))}:{success:!0,data:i.value}},k0=NR(oc)});var $R,WF,C0=_(()=>{$R="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",WF=new RegExp(`^${$R}$`)});var R0=_(()=>{});var N0=_(()=>{});var $0,ng=_(()=>{$0={major:4,minor:0,patch:0}});var MR,j0,M0=_(()=>{ac();rg();Ss();ng();Ss();MR=to("$ZodType",(r,e)=>{var t;r??(r={}),r._zod.def=e,r._zod.bag=r._zod.bag||{},r._zod.version=$0;let n=[...r._zod.def.checks??[]];r._zod.traits.has("$ZodCheck")&&n.unshift(r);for(let s of n)for(let i of s._zod.onattach)i(r);if(n.length===0)(t=r._zod).deferred??(t.deferred=[]),r._zod.deferred?.push(()=>{r._zod.run=r._zod.parse});else{let s=(i,a,o)=>{let u=Xf(i),c;for(let l of a){if(l._zod.def.when){if(!l._zod.def.when(i))continue}else if(u)continue;let f=i.issues.length,p=l._zod.check(i);if(p instanceof Promise&&o?.async===!1)throw new Ps;if(c||p instanceof Promise)c=(c??Promise.resolve()).then(async()=>{await p,i.issues.length!==f&&(u||(u=Xf(i,f)))});else{if(i.issues.length===f)continue;u||(u=Xf(i,f))}}return c?c.then(()=>i):i};r._zod.run=(i,a)=>{let o=r._zod.parse(i,a);if(o instanceof Promise){if(a.async===!1)throw new Ps;return o.then(u=>s(u,n,a))}return s(o,n,a)}}r["~standard"]={validate:s=>{try{let i=T0(r,s);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return k0(r,s).then(a=>a.success?{value:a.data}:{issues:a.error?.issues})}},vendor:"zod",version:1}}),j0=to("$ZodNever",(r,e)=>{MR.init(r,e),r._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:r}),t)})});var z0=_(()=>{});function LR(){return new uc}var hU,mU,uc,on,sg=_(()=>{hU=Symbol("ZodOutput"),mU=Symbol("ZodInput"),uc=class{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){let n=t[0];if(this._map.set(e,n),n&&typeof n=="object"&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}};on=LR()});function L0(r,e){return new r({type:"never",...E0(e)})}var D0=_(()=>{Ss()});var F0=_(()=>{});function ig(r,e){if(r instanceof uc){let n=new Qf(e),s={};for(let o of r._idmap.entries()){let[u,c]=o;n.process(c)}let i={},a={registry:r,uri:e?.uri,defs:s};for(let o of r._idmap.entries()){let[u,c]=o;i[u]=n.emit(c,{...e,external:a})}if(Object.keys(s).length>0){let o=n.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:s}}return{schemas:i}}let t=new Qf(e);return t.process(r),t.emit(r,e)}function Ve(r,e){let t=e??{seen:new Set};if(t.seen.has(r))return!1;t.seen.add(r);let s=r._zod.def;switch(s.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Ve(s.element,t);case"object":{for(let i in s.shape)if(Ve(s.shape[i],t))return!0;return!1}case"union":{for(let i of s.options)if(Ve(i,t))return!0;return!1}case"intersection":return Ve(s.left,t)||Ve(s.right,t);case"tuple":{for(let i of s.items)if(Ve(i,t))return!0;return!!(s.rest&&Ve(s.rest,t))}case"record":return Ve(s.keyType,t)||Ve(s.valueType,t);case"map":return Ve(s.keyType,t)||Ve(s.valueType,t);case"set":return Ve(s.valueType,t);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Ve(s.innerType,t);case"lazy":return Ve(s.getter(),t);case"default":return Ve(s.innerType,t);case"prefault":return Ve(s.innerType,t);case"custom":return!1;case"transform":return!0;case"pipe":return Ve(s.in,t)||Ve(s.out,t);case"success":return!1;case"catch":return!1;default:}throw new Error(`Unknown schema type: ${s.type}`)}var Qf,U0=_(()=>{sg();Ss();Qf=class{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??on,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var n;let s=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,t.schemaPath.includes(e)&&(a.cycle=t.path),a.schema;let o={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,o);let u=e._zod.toJSONSchema?.();if(u)o.schema=u;else{let f={...t,schemaPath:[...t.schemaPath,e],path:t.path},p=e._zod.parent;if(p)o.ref=p,this.process(p,f),this.seen.get(p).isParent=!0;else{let d=o.schema;switch(s.type){case"string":{let h=d;h.type="string";let{minimum:m,maximum:g,format:y,patterns:b,contentEncoding:w}=e._zod.bag;if(typeof m=="number"&&(h.minLength=m),typeof g=="number"&&(h.maxLength=g),y&&(h.format=i[y]??y,h.format===""&&delete h.format),w&&(h.contentEncoding=w),b&&b.size>0){let x=[...b];x.length===1?h.pattern=x[0].source:x.length>1&&(o.schema.allOf=[...x.map(A=>({...this.target==="draft-7"?{type:"string"}:{},pattern:A.source}))])}break}case"number":{let h=d,{minimum:m,maximum:g,format:y,multipleOf:b,exclusiveMaximum:w,exclusiveMinimum:x}=e._zod.bag;typeof y=="string"&&y.includes("int")?h.type="integer":h.type="number",typeof x=="number"&&(h.exclusiveMinimum=x),typeof m=="number"&&(h.minimum=m,typeof x=="number"&&(x>=m?delete h.minimum:delete h.exclusiveMinimum)),typeof w=="number"&&(h.exclusiveMaximum=w),typeof g=="number"&&(h.maximum=g,typeof w=="number"&&(w<=g?delete h.maximum:delete h.exclusiveMaximum)),typeof b=="number"&&(h.multipleOf=b);break}case"boolean":{let h=d;h.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{d.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{d.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{let h=d,{minimum:m,maximum:g}=e._zod.bag;typeof m=="number"&&(h.minItems=m),typeof g=="number"&&(h.maxItems=g),h.type="array",h.items=this.process(s.element,{...f,path:[...f.path,"items"]});break}case"object":{let h=d;h.type="object",h.properties={};let m=s.shape;for(let b in m)h.properties[b]=this.process(m[b],{...f,path:[...f.path,"properties",b]});let g=new Set(Object.keys(m)),y=new Set([...g].filter(b=>{let w=s.shape[b]._zod;return this.io==="input"?w.optin===void 0:w.optout===void 0}));y.size>0&&(h.required=Array.from(y)),s.catchall?._zod.def.type==="never"?h.additionalProperties=!1:s.catchall?s.catchall&&(h.additionalProperties=this.process(s.catchall,{...f,path:[...f.path,"additionalProperties"]})):this.io==="output"&&(h.additionalProperties=!1);break}case"union":{let h=d;h.anyOf=s.options.map((m,g)=>this.process(m,{...f,path:[...f.path,"anyOf",g]}));break}case"intersection":{let h=d,m=this.process(s.left,{...f,path:[...f.path,"allOf",0]}),g=this.process(s.right,{...f,path:[...f.path,"allOf",1]}),y=w=>"allOf"in w&&Object.keys(w).length===1,b=[...y(m)?m.allOf:[m],...y(g)?g.allOf:[g]];h.allOf=b;break}case"tuple":{let h=d;h.type="array";let m=s.items.map((b,w)=>this.process(b,{...f,path:[...f.path,"prefixItems",w]}));if(this.target==="draft-2020-12"?h.prefixItems=m:h.items=m,s.rest){let b=this.process(s.rest,{...f,path:[...f.path,"items"]});this.target==="draft-2020-12"?h.items=b:h.additionalItems=b}s.rest&&(h.items=this.process(s.rest,{...f,path:[...f.path,"items"]}));let{minimum:g,maximum:y}=e._zod.bag;typeof g=="number"&&(h.minItems=g),typeof y=="number"&&(h.maxItems=y);break}case"record":{let h=d;h.type="object",h.propertyNames=this.process(s.keyType,{...f,path:[...f.path,"propertyNames"]}),h.additionalProperties=this.process(s.valueType,{...f,path:[...f.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{let h=d,m=Qm(s.entries);m.every(g=>typeof g=="number")&&(h.type="number"),m.every(g=>typeof g=="string")&&(h.type="string"),h.enum=m;break}case"literal":{let h=d,m=[];for(let g of s.values)if(g===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof g=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");m.push(Number(g))}else m.push(g);if(m.length!==0)if(m.length===1){let g=m[0];h.type=g===null?"null":typeof g,h.const=g}else m.every(g=>typeof g=="number")&&(h.type="number"),m.every(g=>typeof g=="string")&&(h.type="string"),m.every(g=>typeof g=="boolean")&&(h.type="string"),m.every(g=>g===null)&&(h.type="null"),h.enum=m;break}case"file":{let h=d,m={type:"string",format:"binary",contentEncoding:"binary"},{minimum:g,maximum:y,mime:b}=e._zod.bag;g!==void 0&&(m.minLength=g),y!==void 0&&(m.maxLength=y),b?b.length===1?(m.contentMediaType=b[0],Object.assign(h,m)):h.anyOf=b.map(w=>({...m,contentMediaType:w})):Object.assign(h,m);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{let h=this.process(s.innerType,f);d.anyOf=[h,{type:"null"}];break}case"nonoptional":{this.process(s.innerType,f),o.ref=s.innerType;break}case"success":{let h=d;h.type="boolean";break}case"default":{this.process(s.innerType,f),o.ref=s.innerType,d.default=JSON.parse(JSON.stringify(s.defaultValue));break}case"prefault":{this.process(s.innerType,f),o.ref=s.innerType,this.io==="input"&&(d._prefault=JSON.parse(JSON.stringify(s.defaultValue)));break}case"catch":{this.process(s.innerType,f),o.ref=s.innerType;let h;try{h=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}d.default=h;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{let h=d,m=e._zod.pattern;if(!m)throw new Error("Pattern not found in template literal");h.type="string",h.pattern=m.source;break}case"pipe":{let h=this.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;this.process(h,f),o.ref=h;break}case"readonly":{this.process(s.innerType,f),o.ref=s.innerType,d.readOnly=!0;break}case"promise":{this.process(s.innerType,f),o.ref=s.innerType;break}case"optional":{this.process(s.innerType,f),o.ref=s.innerType;break}case"lazy":{let h=e._zod.innerType;this.process(h,f),o.ref=h;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}default:}}}let c=this.metadataRegistry.get(e);return c&&Object.assign(o.schema,c),this.io==="input"&&Ve(e)&&(delete o.schema.examples,delete o.schema.default),this.io==="input"&&o.schema._prefault&&((n=o.schema).default??(n.default=o.schema._prefault)),delete o.schema._prefault,this.seen.get(e).schema}emit(e,t){let n={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},s=this.seen.get(e);if(!s)throw new Error("Unprocessed schema. This is a bug in Zod.");let i=l=>{let f=this.target==="draft-2020-12"?"$defs":"definitions";if(n.external){let m=n.external.registry.get(l[0])?.id,g=n.external.uri??(b=>b);if(m)return{ref:g(m)};let y=l[1].defId??l[1].schema.id??`schema${this.counter++}`;return l[1].defId=y,{defId:y,ref:`${g("__shared")}#/${f}/${y}`}}if(l[1]===s)return{ref:"#"};let d=`#/${f}/`,h=l[1].schema.id??`__schema${this.counter++}`;return{defId:h,ref:d+h}},a=l=>{if(l[1].schema.$ref)return;let f=l[1],{ref:p,defId:d}=i(l);f.def={...f.schema},d&&(f.defId=d);let h=f.schema;for(let m in h)delete h[m];h.$ref=p};if(n.cycles==="throw")for(let l of this.seen.entries()){let f=l[1];if(f.cycle)throw new Error(`Cycle detected: #/${f.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(let l of this.seen.entries()){let f=l[1];if(e===l[0]){a(l);continue}if(n.external){let d=n.external.registry.get(l[0])?.id;if(e!==l[0]&&d){a(l);continue}}if(this.metadataRegistry.get(l[0])?.id){a(l);continue}if(f.cycle){a(l);continue}if(f.count>1&&n.reused==="ref"){a(l);continue}}let o=(l,f)=>{let p=this.seen.get(l),d=p.def??p.schema,h={...d};if(p.ref===null)return;let m=p.ref;if(p.ref=null,m){o(m,f);let g=this.seen.get(m).schema;g.$ref&&f.target==="draft-7"?(d.allOf=d.allOf??[],d.allOf.push(g)):(Object.assign(d,g),Object.assign(d,h))}p.isParent||this.override({zodSchema:l,jsonSchema:d,path:p.path??[]})};for(let l of[...this.seen.entries()].reverse())o(l[0],{target:this.target});let u={};if(this.target==="draft-2020-12"?u.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?u.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),n.external?.uri){let l=n.external.registry.get(e)?.id;if(!l)throw new Error("Schema is missing an `id` property");u.$id=n.external.uri(l)}Object.assign(u,s.def);let c=n.external?.defs??{};for(let l of this.seen.entries()){let f=l[1];f.def&&f.defId&&(c[f.defId]=f.def)}n.external||Object.keys(c).length>0&&(this.target==="draft-2020-12"?u.$defs=c:u.definitions=c);try{return JSON.parse(JSON.stringify(u))}catch{throw new Error("Error converting schema to JSON.")}}}});var B0=_(()=>{});var ag=_(()=>{ac();rg();tg();M0();R0();ng();Ss();C0();z0();sg();N0();F0();D0();U0();B0()});var G0,V0,Z0,ep=_(()=>{G0=Symbol("Let zodToJsonSchema decide on which parser to use"),V0={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Z0=r=>typeof r=="string"?{...V0,name:r}:{...V0,...r}});var q0,og=_(()=>{ep();q0=r=>{let e=Z0(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,flags:{hasReferencedOpenAiAnyType:!1},currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}}});function ug(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function pe(r,e,t,n,s){r[e]=t,ug(r,e,n,s)}var Is=_(()=>{});var tp,rp=_(()=>{tp=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")}});var un=_(()=>{Ru();Ru()});function Ee(r){if(r.target!=="openAi")return{};let e=[...r.basePath,r.definitionPath,r.openAiAnyTypeName];return r.flags.hasReferencedOpenAiAnyType=!0,{$ref:r.$refStrategy==="relative"?tp(e,r.currentPath):e.join("/")}}var ur=_(()=>{rp()});function K0(r,e){let t={type:"array"};return r.type?._def&&r.type?._def?.typeName!==v.ZodAny&&(t.items=H(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&pe(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&pe(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(pe(t,"minItems",r.exactLength.value,r.exactLength.message,e),pe(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}var cg=_(()=>{un();Is();Le()});function H0(r,e){let t={type:"integer",format:"int64"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?pe(t,"minimum",n.value,n.message,e):pe(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),pe(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?pe(t,"maximum",n.value,n.message,e):pe(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),pe(t,"maximum",n.value,n.message,e));break;case"multipleOf":pe(t,"multipleOf",n.value,n.message,e);break}return t}var lg=_(()=>{Is()});function W0(){return{type:"boolean"}}var fg=_(()=>{});function np(r,e){return H(r.type._def,e)}var sp=_(()=>{Le()});var J0,pg=_(()=>{Le();J0=(r,e)=>H(r.innerType._def,e)});function dg(r,e,t){let n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((s,i)=>dg(r,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return FR(r,e)}}var FR,hg=_(()=>{Is();FR=(r,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let n of r.checks)switch(n.kind){case"min":pe(t,"minimum",n.value,n.message,e);break;case"max":pe(t,"maximum",n.value,n.message,e);break}return t}});function Y0(r,e){return{...H(r.innerType._def,e),default:r.defaultValue()}}var mg=_(()=>{Le()});function X0(r,e){return e.effectStrategy==="input"?H(r.schema._def,e):Ee(e)}var gg=_(()=>{Le();ur()});function Q0(r){return{type:"string",enum:Array.from(r.values)}}var bg=_(()=>{});function eA(r,e){let t=[H(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),H(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i),n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,s=[];return t.forEach(i=>{if(UR(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){let{additionalProperties:o,...u}=i;a=u}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}var UR,yg=_(()=>{Le();UR=r=>"type"in r&&r.type==="string"?!1:"allOf"in r});function tA(r,e){let t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}var _g=_(()=>{});function ip(r,e){let t={type:"string"};if(r.checks)for(let n of r.checks)switch(n.kind){case"min":pe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e);break;case"max":pe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Cr(t,"email",n.message,e);break;case"format:idn-email":Cr(t,"idn-email",n.message,e);break;case"pattern:zod":It(t,kr.email,n.message,e);break}break;case"url":Cr(t,"uri",n.message,e);break;case"uuid":Cr(t,"uuid",n.message,e);break;case"regex":It(t,n.regex,n.message,e);break;case"cuid":It(t,kr.cuid,n.message,e);break;case"cuid2":It(t,kr.cuid2,n.message,e);break;case"startsWith":It(t,RegExp(`^${vg(n.value,e)}`),n.message,e);break;case"endsWith":It(t,RegExp(`${vg(n.value,e)}$`),n.message,e);break;case"datetime":Cr(t,"date-time",n.message,e);break;case"date":Cr(t,"date",n.message,e);break;case"time":Cr(t,"time",n.message,e);break;case"duration":Cr(t,"duration",n.message,e);break;case"length":pe(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e),pe(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"includes":{It(t,RegExp(vg(n.value,e)),n.message,e);break}case"ip":{n.version!=="v6"&&Cr(t,"ipv4",n.message,e),n.version!=="v4"&&Cr(t,"ipv6",n.message,e);break}case"base64url":It(t,kr.base64url,n.message,e);break;case"jwt":It(t,kr.jwt,n.message,e);break;case"cidr":{n.version!=="v6"&&It(t,kr.ipv4Cidr,n.message,e),n.version!=="v4"&&It(t,kr.ipv6Cidr,n.message,e);break}case"emoji":It(t,kr.emoji(),n.message,e);break;case"ulid":{It(t,kr.ulid,n.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Cr(t,"binary",n.message,e);break}case"contentEncoding:base64":{pe(t,"contentEncoding","base64",n.message,e);break}case"pattern:zod":{It(t,kr.base64,n.message,e);break}}break}case"nanoid":It(t,kr.nanoid,n.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}function vg(r,e){return e.patternStrategy==="escape"?VR(r):r}function VR(r){let e="";for(let t=0;t<r.length;t++)BR.has(r[t])||(e+="\\"),e+=r[t];return e}function Cr(r,e,t,n){r.format||r.anyOf?.some(s=>s.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):pe(r,"format",e,t,n)}function It(r,e,t,n){r.pattern||r.allOf?.some(s=>s.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:rA(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):pe(r,"pattern",rA(e,n),t,n)}function rA(r,e){if(!e.applyRegexFlags||!r.flags)return r.source;let t={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},n=t.i?r.source.toLowerCase():r.source,s="",i=!1,a=!1,o=!1;for(let u=0;u<n.length;u++){if(i){s+=n[u],i=!1;continue}if(t.i){if(a){if(n[u].match(/[a-z]/)){o?(s+=n[u],s+=`${n[u-2]}-${n[u]}`.toUpperCase(),o=!1):n[u+1]==="-"&&n[u+2]?.match(/[a-z]/)?(s+=n[u],o=!0):s+=`${n[u]}${n[u].toUpperCase()}`;continue}}else if(n[u].match(/[a-z]/)){s+=`[${n[u]}${n[u].toUpperCase()}]`;continue}}if(t.m){if(n[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(n[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(t.s&&n[u]==="."){s+=a?`${n[u]}\r
`:`[${n[u]}\r
]`;continue}s+=n[u],n[u]==="\\"?i=!0:a&&n[u]==="]"?a=!1:!a&&n[u]==="["&&(a=!0)}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return s}var wg,kr,BR,ap=_(()=>{Is();kr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(wg===void 0&&(wg=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),wg),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};BR=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789")});function op(r,e){if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&r.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,s)=>({...n,[s]:H(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",s]})??Ee(e)}),{}),additionalProperties:e.rejectedAdditionalProperties};let t={type:"object",additionalProperties:H(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===v.ZodString&&r.keyType._def.checks?.length){let{type:n,...s}=ip(r.keyType._def,e);return{...t,propertyNames:s}}else{if(r.keyType?._def.typeName===v.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};if(r.keyType?._def.typeName===v.ZodBranded&&r.keyType._def.type._def.typeName===v.ZodString&&r.keyType._def.type._def.checks?.length){let{type:n,...s}=np(r.keyType._def,e);return{...t,propertyNames:s}}}return t}var up=_(()=>{un();Le();ap();sp();ur()});function nA(r,e){if(e.mapStrategy==="record")return op(r,e);let t=H(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||Ee(e),n=H(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||Ee(e);return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}var xg=_(()=>{Le();up();ur()});function sA(r){let e=r.values,n=Object.keys(r.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}var Ag=_(()=>{});function iA(r){return r.target==="openAi"?void 0:{not:Ee({...r,currentPath:[...r.currentPath,"not"]})}}var Eg=_(()=>{ur()});function aA(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Og=_(()=>{});function uA(r,e){if(e.target==="openApi3")return oA(r,e);let t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in cc&&(!n._def.checks||!n._def.checks.length))){let n=t.reduce((s,i)=>{let a=cc[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){let n=t.reduce((s,i)=>{let a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===t.length){let s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return oA(r,e)}var cc,oA,cp=_(()=>{Le();cc={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};oA=(r,e)=>{let t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,s)=>H(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0}});function cA(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"?{type:cc[r.innerType._def.typeName],nullable:!0}:{type:[cc[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let n=H(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}let t=H(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}var Pg=_(()=>{Le();cp()});function lA(r,e){let t={type:"number"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"int":t.type="integer",ug(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?pe(t,"minimum",n.value,n.message,e):pe(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),pe(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?pe(t,"maximum",n.value,n.message,e):pe(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),pe(t,"maximum",n.value,n.message,e));break;case"multipleOf":pe(t,"multipleOf",n.value,n.message,e);break}return t}var Sg=_(()=>{Is()});function fA(r,e){let t=e.target==="openAi",n={type:"object",properties:{}},s=[],i=r.shape();for(let o in i){let u=i[o];if(u===void 0||u._def===void 0)continue;let c=ZR(u);c&&t&&(u._def.typeName==="ZodOptional"&&(u=u._def.innerType),u.isNullable()||(u=u.nullable()),c=!1);let l=H(u._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});l!==void 0&&(n.properties[o]=l,c||s.push(o))}s.length&&(n.required=s);let a=GR(r,e);return a!==void 0&&(n.additionalProperties=a),n}function GR(r,e){if(r.catchall._def.typeName!=="ZodNever")return H(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(r.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function ZR(r){try{return r.isOptional()}catch{return!0}}var Ig=_(()=>{Le()});var pA,Tg=_(()=>{Le();ur();pA=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return H(r.innerType._def,e);let t=H(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:Ee(e)},t]}:Ee(e)}});var dA,kg=_(()=>{Le();dA=(r,e)=>{if(e.pipeStrategy==="input")return H(r.in._def,e);if(e.pipeStrategy==="output")return H(r.out._def,e);let t=H(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=H(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(s=>s!==void 0)}}});function hA(r,e){return H(r.type._def,e)}var Cg=_(()=>{Le()});function mA(r,e){let n={type:"array",uniqueItems:!0,items:H(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&pe(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&pe(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}var Rg=_(()=>{Is();Le()});function gA(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>H(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:H(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>H(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}var Ng=_(()=>{Le()});function bA(r){return{not:Ee(r)}}var $g=_(()=>{ur()});function yA(r){return Ee(r)}var jg=_(()=>{ur()});var _A,Mg=_(()=>{Le();_A=(r,e)=>H(r.innerType._def,e)});var wA,zg=_(()=>{un();ur();cg();lg();fg();sp();pg();hg();mg();gg();bg();yg();_g();xg();Ag();Eg();Og();Pg();Sg();Ig();Tg();kg();Cg();up();Rg();ap();Ng();$g();cp();jg();Mg();wA=(r,e,t)=>{switch(e){case v.ZodString:return ip(r,t);case v.ZodNumber:return lA(r,t);case v.ZodObject:return fA(r,t);case v.ZodBigInt:return H0(r,t);case v.ZodBoolean:return W0();case v.ZodDate:return dg(r,t);case v.ZodUndefined:return bA(t);case v.ZodNull:return aA(t);case v.ZodArray:return K0(r,t);case v.ZodUnion:case v.ZodDiscriminatedUnion:return uA(r,t);case v.ZodIntersection:return eA(r,t);case v.ZodTuple:return gA(r,t);case v.ZodRecord:return op(r,t);case v.ZodLiteral:return tA(r,t);case v.ZodEnum:return Q0(r);case v.ZodNativeEnum:return sA(r);case v.ZodNullable:return cA(r,t);case v.ZodOptional:return pA(r,t);case v.ZodMap:return nA(r,t);case v.ZodSet:return mA(r,t);case v.ZodLazy:return()=>r.getter()._def;case v.ZodPromise:return hA(r,t);case v.ZodNaN:case v.ZodNever:return iA(t);case v.ZodEffects:return X0(r,t);case v.ZodAny:return Ee(t);case v.ZodUnknown:return yA(t);case v.ZodDefault:return Y0(r,t);case v.ZodBranded:return np(r,t);case v.ZodReadonly:return _A(r,t);case v.ZodCatch:return J0(r,t);case v.ZodPipeline:return dA(r,t);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(n=>{})(e)}}});function H(r,e,t=!1){let n=e.seen.get(r);if(e.override){let o=e.override?.(r,e,n,t);if(o!==G0)return o}if(n&&!t){let o=qR(n,e);if(o!==void 0)return o}let s={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,s);let i=wA(r,r.typeName,e),a=typeof i=="function"?H(i(),e):i;if(a&&KR(r,e,a),e.postProcess){let o=e.postProcess(a,r,e);return s.jsonSchema=a,o}return s.jsonSchema=a,a}var qR,KR,Le=_(()=>{ep();zg();rp();ur();qR=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"relative":return{$ref:tp(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((t,n)=>e.currentPath[n]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),Ee(e)):e.$refStrategy==="seen"?Ee(e):void 0}},KR=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t)});var vA=_(()=>{});var ao,Lg=_(()=>{Le();og();ur();ao=(r,e)=>{let t=q0(e),n=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[c,l])=>({...u,[c]:H(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0)??Ee(t)}),{}):void 0,s=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,i=H(r._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1)??Ee(t),a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(i.title=a),t.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[t.openAiAnyTypeName]||(n[t.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:t.$refStrategy==="relative"?"1":[...t.basePath,t.definitionPath,t.openAiAnyTypeName].join("/")}}));let o=s===void 0?n?{...i,[t.definitionPath]:n}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...n,[s]:i}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o}});var lp=_(()=>{ep();og();Is();rp();Le();vA();ur();cg();lg();fg();sp();pg();hg();mg();gg();bg();yg();_g();xg();Ag();Eg();Og();Pg();Sg();Ig();Tg();kg();Cg();Mg();up();Rg();ap();Ng();$g();cp();jg();zg();Lg();Lg()});function Gn(r,e){let t=typeof r;if(t!==typeof e)return!1;if(Array.isArray(r)){if(!Array.isArray(e))return!1;let n=r.length;if(n!==e.length)return!1;for(let s=0;s<n;s++)if(!Gn(r[s],e[s]))return!1;return!0}if(t==="object"){if(!r||!e)return r===e;let n=Object.keys(r),s=Object.keys(e);if(n.length!==s.length)return!1;for(let a of n)if(!Gn(r[a],e[a]))return!1;return!0}return r===e}var Dg=_(()=>{});function qt(r){return encodeURI(HR(r))}function HR(r){return r.replace(/~/g,"~0").replace(/\//g,"~1")}var fp=_(()=>{});function Ts(r,e=Object.create(null),t=XR,n=""){if(r&&typeof r=="object"&&!Array.isArray(r)){let i=r.$id||r.id;if(i){let a=new URL(i,t.href);a.hash.length>1?e[a.href]=r:(a.hash="",n===""?t=a:Ts(r,e,t))}}else if(r!==!0&&r!==!1)return e;let s=t.href+(n?"#"+n:"");if(e[s]!==void 0)throw new Error(`Duplicate schema URI "${s}".`);if(e[s]=r,r===!0||r===!1)return e;if(r.__absolute_uri__===void 0&&Object.defineProperty(r,"__absolute_uri__",{enumerable:!1,value:s}),r.$ref&&r.__absolute_ref__===void 0){let i=new URL(r.$ref,t.href);i.hash=i.hash,Object.defineProperty(r,"__absolute_ref__",{enumerable:!1,value:i.href})}if(r.$recursiveRef&&r.__absolute_recursive_ref__===void 0){let i=new URL(r.$recursiveRef,t.href);i.hash=i.hash,Object.defineProperty(r,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(r.$anchor){let i=new URL("#"+r.$anchor,t.href);e[i.href]=r}for(let i in r){if(YR[i])continue;let a=`${n}/${qt(i)}`,o=r[i];if(Array.isArray(o)){if(WR[i]){let u=o.length;for(let c=0;c<u;c++)Ts(o[c],e,t,`${a}/${c}`)}}else if(JR[i])for(let u in o)Ts(o[u],e,t,`${a}/${qt(u)}`);else Ts(o,e,t,a)}return e}var WR,JR,YR,XR,pp=_(()=>{fp();WR={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},JR={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},YR={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0},XR=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker")});function cn(r){return r.test.bind(r)}function hN(r){return r%4===0&&(r%100!==0||r%400===0)}function xA(r){let e=r.match(QR);if(!e)return!1;let t=+e[1],n=+e[2],s=+e[3];return n>=1&&n<=12&&s>=1&&s<=(n==2&&hN(t)?29:eN[n])}function AA(r,e){let t=e.match(tN);if(!t)return!1;let n=+t[1],s=+t[2],i=+t[3],a=!!t[5];return(n<=23&&s<=59&&i<=59||n==23&&s==59&&i==60)&&(!r||a)}function gN(r){let e=r.split(mN);return e.length==2&&xA(e[0])&&AA(!0,e[1])}function _N(r){return bN.test(r)&&yN.test(r)}function vN(r){if(wN.test(r))return!1;try{return new RegExp(r,"u"),!0}catch{return!1}}var QR,eN,tN,rN,nN,sN,iN,aN,oN,uN,cN,lN,fN,pN,dN,Fg,mN,bN,yN,wN,Ug=_(()=>{QR=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,eN=[0,31,28,31,30,31,30,31,31,30,31,30,31],tN=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,rN=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,nN=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,sN=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,iN=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,aN=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,oN=/^(?:\/(?:[^~/]|~0|~1)*)*$/,uN=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,cN=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,lN=r=>{if(r[0]==='"')return!1;let[e,t,...n]=r.split("@");return!e||!t||n.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},fN=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,pN=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,dN=r=>r.length>1&&r.length<80&&(/^P\d+([.,]\d+)?W$/.test(r)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(r)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(r));Fg={date:xA,time:AA.bind(void 0,!1),"date-time":gN,duration:dN,uri:_N,"uri-reference":cn(nN),"uri-template":cn(sN),url:cn(iN),email:lN,hostname:cn(rN),ipv4:cn(fN),ipv6:cn(pN),regex:vN,uuid:cn(aN),"json-pointer":cn(oN),"json-pointer-uri-fragment":cn(uN),"relative-json-pointer":cn(cN)};mN=/t|\s/i;bN=/\/|:/,yN=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;wN=/[^\\]\\Z/});var EA,OA=_(()=>{(function(r){r[r.Flag=1]="Flag",r[r.Basic=2]="Basic",r[r.Detailed=4]="Detailed"})(EA||(EA={}))});function PA(r){let e=0,t=r.length,n=0,s;for(;n<t;)e++,s=r.charCodeAt(n++),s>=55296&&s<=56319&&n<t&&(s=r.charCodeAt(n),(s&64512)==56320&&n++);return e}var Bg=_(()=>{});function Ae(r,e,t="2019-09",n=Ts(e),s=!0,i=null,a="#",o="#",u=Object.create(null)){if(e===!0)return{valid:!0,errors:[]};if(e===!1)return{valid:!1,errors:[{instanceLocation:a,keyword:"false",keywordLocation:a,error:"False boolean schema."}]};let c=typeof r,l;switch(c){case"boolean":case"number":case"string":l=c;break;case"object":r===null?l="null":Array.isArray(r)?l="array":l="object";break;default:throw new Error(`Instances of "${c}" type are not supported.`)}let{$ref:f,$recursiveRef:p,$recursiveAnchor:d,type:h,const:m,enum:g,required:y,not:b,anyOf:w,allOf:x,oneOf:A,if:P,then:M,else:N,format:I,properties:S,patternProperties:C,additionalProperties:ue,unevaluatedProperties:Re,minProperties:br,maxProperties:Ca,propertyNames:jy,dependentRequired:Ud,dependentSchemas:Bd,dependencies:Vd,prefixItems:Gd,items:Ou,additionalItems:My,unevaluatedItems:zy,contains:Ly,minContains:Tn,maxContains:wl,minItems:Zd,maxItems:qd,uniqueItems:mP,minimum:oi,maximum:ui,exclusiveMinimum:Pu,exclusiveMaximum:Su,multipleOf:vl,minLength:xl,maxLength:Al,pattern:Dy,__absolute_ref__:El,__absolute_recursive_ref__:gP}=e,z=[];if(d===!0&&i===null&&(i=e),p==="#"){let Y=i===null?n[gP]:i,Z=`${o}/$recursiveRef`,ee=Ae(r,i===null?e:i,t,n,s,Y,a,Z,u);ee.valid||z.push({instanceLocation:a,keyword:"$recursiveRef",keywordLocation:Z,error:"A subschema had errors."},...ee.errors)}if(f!==void 0){let Z=n[El||f];if(Z===void 0){let k=`Unresolved $ref "${f}".`;throw El&&El!==f&&(k+=`  Absolute URI "${El}".`),k+=`
Known schemas:
- ${Object.keys(n).join(`
- `)}`,new Error(k)}let ee=`${o}/$ref`,L=Ae(r,Z,t,n,s,i,a,ee,u);if(L.valid||z.push({instanceLocation:a,keyword:"$ref",keywordLocation:ee,error:"A subschema had errors."},...L.errors),t==="4"||t==="7")return{valid:z.length===0,errors:z}}if(Array.isArray(h)){let Y=h.length,Z=!1;for(let ee=0;ee<Y;ee++)if(l===h[ee]||h[ee]==="integer"&&l==="number"&&r%1===0&&r===r){Z=!0;break}Z||z.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${h.join('", "')}".`})}else h==="integer"?(l!=="number"||r%1||r!==r)&&z.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${h}".`}):h!==void 0&&l!==h&&z.push({instanceLocation:a,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${l}" is invalid. Expected "${h}".`});if(m!==void 0&&(l==="object"||l==="array"?Gn(r,m)||z.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):r!==m&&z.push({instanceLocation:a,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),g!==void 0&&(l==="object"||l==="array"?g.some(Y=>Gn(r,Y))||z.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(Y=>r===Y)||z.push({instanceLocation:a,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),b!==void 0){let Y=`${o}/not`;Ae(r,b,t,n,s,i,a,Y).valid&&z.push({instanceLocation:a,keyword:"not",keywordLocation:Y,error:'Instance matched "not" schema.'})}let Ol=[];if(w!==void 0){let Y=`${o}/anyOf`,Z=z.length,ee=!1;for(let L=0;L<w.length;L++){let k=w[L],Q=Object.create(u),X=Ae(r,k,t,n,s,d===!0?i:null,a,`${Y}/${L}`,Q);z.push(...X.errors),ee=ee||X.valid,X.valid&&Ol.push(Q)}ee?z.length=Z:z.splice(Z,0,{instanceLocation:a,keyword:"anyOf",keywordLocation:Y,error:"Instance does not match any subschemas."})}if(x!==void 0){let Y=`${o}/allOf`,Z=z.length,ee=!0;for(let L=0;L<x.length;L++){let k=x[L],Q=Object.create(u),X=Ae(r,k,t,n,s,d===!0?i:null,a,`${Y}/${L}`,Q);z.push(...X.errors),ee=ee&&X.valid,X.valid&&Ol.push(Q)}ee?z.length=Z:z.splice(Z,0,{instanceLocation:a,keyword:"allOf",keywordLocation:Y,error:"Instance does not match every subschema."})}if(A!==void 0){let Y=`${o}/oneOf`,Z=z.length,ee=A.filter((L,k)=>{let Q=Object.create(u),X=Ae(r,L,t,n,s,d===!0?i:null,a,`${Y}/${k}`,Q);return z.push(...X.errors),X.valid&&Ol.push(Q),X.valid}).length;ee===1?z.length=Z:z.splice(Z,0,{instanceLocation:a,keyword:"oneOf",keywordLocation:Y,error:`Instance does not match exactly one subschema (${ee} matches).`})}if((l==="object"||l==="array")&&Object.assign(u,...Ol),P!==void 0){let Y=`${o}/if`;if(Ae(r,P,t,n,s,i,a,Y,u).valid){if(M!==void 0){let ee=Ae(r,M,t,n,s,i,a,`${o}/then`,u);ee.valid||z.push({instanceLocation:a,keyword:"if",keywordLocation:Y,error:'Instance does not match "then" schema.'},...ee.errors)}}else if(N!==void 0){let ee=Ae(r,N,t,n,s,i,a,`${o}/else`,u);ee.valid||z.push({instanceLocation:a,keyword:"if",keywordLocation:Y,error:'Instance does not match "else" schema.'},...ee.errors)}}if(l==="object"){if(y!==void 0)for(let L of y)L in r||z.push({instanceLocation:a,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${L}".`});let Y=Object.keys(r);if(br!==void 0&&Y.length<br&&z.push({instanceLocation:a,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${br} properties.`}),Ca!==void 0&&Y.length>Ca&&z.push({instanceLocation:a,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${Ca} properties.`}),jy!==void 0){let L=`${o}/propertyNames`;for(let k in r){let Q=`${a}/${qt(k)}`,X=Ae(k,jy,t,n,s,i,Q,L);X.valid||z.push({instanceLocation:a,keyword:"propertyNames",keywordLocation:L,error:`Property name "${k}" does not match schema.`},...X.errors)}}if(Ud!==void 0){let L=`${o}/dependantRequired`;for(let k in Ud)if(k in r){let Q=Ud[k];for(let X of Q)X in r||z.push({instanceLocation:a,keyword:"dependentRequired",keywordLocation:L,error:`Instance has "${k}" but does not have "${X}".`})}}if(Bd!==void 0)for(let L in Bd){let k=`${o}/dependentSchemas`;if(L in r){let Q=Ae(r,Bd[L],t,n,s,i,a,`${k}/${qt(L)}`,u);Q.valid||z.push({instanceLocation:a,keyword:"dependentSchemas",keywordLocation:k,error:`Instance has "${L}" but does not match dependant schema.`},...Q.errors)}}if(Vd!==void 0){let L=`${o}/dependencies`;for(let k in Vd)if(k in r){let Q=Vd[k];if(Array.isArray(Q))for(let X of Q)X in r||z.push({instanceLocation:a,keyword:"dependencies",keywordLocation:L,error:`Instance has "${k}" but does not have "${X}".`});else{let X=Ae(r,Q,t,n,s,i,a,`${L}/${qt(k)}`);X.valid||z.push({instanceLocation:a,keyword:"dependencies",keywordLocation:L,error:`Instance has "${k}" but does not match dependant schema.`},...X.errors)}}}let Z=Object.create(null),ee=!1;if(S!==void 0){let L=`${o}/properties`;for(let k in S){if(!(k in r))continue;let Q=`${a}/${qt(k)}`,X=Ae(r[k],S[k],t,n,s,i,Q,`${L}/${qt(k)}`);if(X.valid)u[k]=Z[k]=!0;else if(ee=s,z.push({instanceLocation:a,keyword:"properties",keywordLocation:L,error:`Property "${k}" does not match schema.`},...X.errors),ee)break}}if(!ee&&C!==void 0){let L=`${o}/patternProperties`;for(let k in C){let Q=new RegExp(k,"u"),X=C[k];for(let Nt in r){if(!Q.test(Nt))continue;let Fy=`${a}/${qt(Nt)}`,Uy=Ae(r[Nt],X,t,n,s,i,Fy,`${L}/${qt(k)}`);Uy.valid?u[Nt]=Z[Nt]=!0:(ee=s,z.push({instanceLocation:a,keyword:"patternProperties",keywordLocation:L,error:`Property "${Nt}" matches pattern "${k}" but does not match associated schema.`},...Uy.errors))}}}if(!ee&&ue!==void 0){let L=`${o}/additionalProperties`;for(let k in r){if(Z[k])continue;let Q=`${a}/${qt(k)}`,X=Ae(r[k],ue,t,n,s,i,Q,L);X.valid?u[k]=!0:(ee=s,z.push({instanceLocation:a,keyword:"additionalProperties",keywordLocation:L,error:`Property "${k}" does not match additional properties schema.`},...X.errors))}}else if(!ee&&Re!==void 0){let L=`${o}/unevaluatedProperties`;for(let k in r)if(!u[k]){let Q=`${a}/${qt(k)}`,X=Ae(r[k],Re,t,n,s,i,Q,L);X.valid?u[k]=!0:z.push({instanceLocation:a,keyword:"unevaluatedProperties",keywordLocation:L,error:`Property "${k}" does not match unevaluated properties schema.`},...X.errors)}}}else if(l==="array"){qd!==void 0&&r.length>qd&&z.push({instanceLocation:a,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${r.length} > ${qd}).`}),Zd!==void 0&&r.length<Zd&&z.push({instanceLocation:a,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${r.length} < ${Zd}).`});let Y=r.length,Z=0,ee=!1;if(Gd!==void 0){let L=`${o}/prefixItems`,k=Math.min(Gd.length,Y);for(;Z<k;Z++){let Q=Ae(r[Z],Gd[Z],t,n,s,i,`${a}/${Z}`,`${L}/${Z}`);if(u[Z]=!0,!Q.valid&&(ee=s,z.push({instanceLocation:a,keyword:"prefixItems",keywordLocation:L,error:"Items did not match schema."},...Q.errors),ee))break}}if(Ou!==void 0){let L=`${o}/items`;if(Array.isArray(Ou)){let k=Math.min(Ou.length,Y);for(;Z<k;Z++){let Q=Ae(r[Z],Ou[Z],t,n,s,i,`${a}/${Z}`,`${L}/${Z}`);if(u[Z]=!0,!Q.valid&&(ee=s,z.push({instanceLocation:a,keyword:"items",keywordLocation:L,error:"Items did not match schema."},...Q.errors),ee))break}}else for(;Z<Y;Z++){let k=Ae(r[Z],Ou,t,n,s,i,`${a}/${Z}`,L);if(u[Z]=!0,!k.valid&&(ee=s,z.push({instanceLocation:a,keyword:"items",keywordLocation:L,error:"Items did not match schema."},...k.errors),ee))break}if(!ee&&My!==void 0){let k=`${o}/additionalItems`;for(;Z<Y;Z++){let Q=Ae(r[Z],My,t,n,s,i,`${a}/${Z}`,k);u[Z]=!0,Q.valid||(ee=s,z.push({instanceLocation:a,keyword:"additionalItems",keywordLocation:k,error:"Items did not match additional items schema."},...Q.errors))}}}if(Ly!==void 0)if(Y===0&&Tn===void 0)z.push({instanceLocation:a,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(Tn!==void 0&&Y<Tn)z.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${Y}) than minContains (${Tn}).`});else{let L=`${o}/contains`,k=z.length,Q=0;for(let X=0;X<Y;X++){let Nt=Ae(r[X],Ly,t,n,s,i,`${a}/${X}`,L);Nt.valid?(u[X]=!0,Q++):z.push(...Nt.errors)}Q>=(Tn||0)&&(z.length=k),Tn===void 0&&wl===void 0&&Q===0?z.splice(k,0,{instanceLocation:a,keyword:"contains",keywordLocation:L,error:"Array does not contain item matching schema."}):Tn!==void 0&&Q<Tn?z.push({instanceLocation:a,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${Tn} items matching schema. Only ${Q} items were found.`}):wl!==void 0&&Q>wl&&z.push({instanceLocation:a,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${wl} items matching schema. ${Q} items were found.`})}if(!ee&&zy!==void 0){let L=`${o}/unevaluatedItems`;for(Z;Z<Y;Z++){if(u[Z])continue;let k=Ae(r[Z],zy,t,n,s,i,`${a}/${Z}`,L);u[Z]=!0,k.valid||z.push({instanceLocation:a,keyword:"unevaluatedItems",keywordLocation:L,error:"Items did not match unevaluated items schema."},...k.errors)}}if(mP)for(let L=0;L<Y;L++){let k=r[L],Q=typeof k=="object"&&k!==null;for(let X=0;X<Y;X++){if(L===X)continue;let Nt=r[X];(k===Nt||Q&&(typeof Nt=="object"&&Nt!==null)&&Gn(k,Nt))&&(z.push({instanceLocation:a,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${L} and ${X}.`}),L=Number.MAX_SAFE_INTEGER,X=Number.MAX_SAFE_INTEGER)}}}else if(l==="number"){if(t==="4"?(oi!==void 0&&(Pu===!0&&r<=oi||r<oi)&&z.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${r} is less than ${Pu?"or equal to ":""} ${oi}.`}),ui!==void 0&&(Su===!0&&r>=ui||r>ui)&&z.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${r} is greater than ${Su?"or equal to ":""} ${ui}.`})):(oi!==void 0&&r<oi&&z.push({instanceLocation:a,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${r} is less than ${oi}.`}),ui!==void 0&&r>ui&&z.push({instanceLocation:a,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${r} is greater than ${ui}.`}),Pu!==void 0&&r<=Pu&&z.push({instanceLocation:a,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${r} is less than ${Pu}.`}),Su!==void 0&&r>=Su&&z.push({instanceLocation:a,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${r} is greater than or equal to ${Su}.`})),vl!==void 0){let Y=r%vl;Math.abs(0-Y)>=11920929e-14&&Math.abs(vl-Y)>=11920929e-14&&z.push({instanceLocation:a,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${r} is not a multiple of ${vl}.`})}}else if(l==="string"){let Y=xl===void 0&&Al===void 0?0:PA(r);xl!==void 0&&Y<xl&&z.push({instanceLocation:a,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${Y} < ${xl}).`}),Al!==void 0&&Y>Al&&z.push({instanceLocation:a,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${Y} > ${Al}).`}),Dy!==void 0&&!new RegExp(Dy,"u").test(r)&&z.push({instanceLocation:a,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),I!==void 0&&Fg[I]&&!Fg[I](r)&&z.push({instanceLocation:a,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${I}".`})}return{valid:z.length===0,errors:z}}var Vg=_(()=>{Dg();pp();Ug();fp();Bg()});var SA=_(()=>{pp();Vg()});var lc=_(()=>{Dg();pp();Ug();fp();OA();Bg();Vg();SA()});function Rr(r){if(typeof r!="object"||r===null)return!1;let e=r;if(!("_zod"in e))return!1;let t=e._zod;return typeof t=="object"&&t!==null&&"def"in t}function ln(r){if(typeof r!="object"||r===null)return!1;let e=r;if(!("_def"in e)||"_zod"in e)return!1;let t=e._def;return typeof t=="object"&&t!=null&&"typeName"in t}function Fi(r){return!r||typeof r!="object"||Array.isArray(r)?!1:!!(Rr(r)||ln(r))}async function IA(r,e){if(Rr(r))try{return{success:!0,data:await I0(r,e)}}catch(t){return{success:!1,error:t}}if(ln(r))return r.safeParse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function co(r,e){if(Rr(r))return S0(r,e);if(ln(r))return r.parse(e);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function fc(r){if(Rr(r))return on.get(r)?.description;if(ln(r)||"description"in r&&typeof r.description=="string")return r.description}function Gg(r){return Fi(r)?ln(r)?r._def.typeName==="ZodString":Rr(r)?r._zod.def.type==="string":!1:!1}function uo(r){return Rr(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="object":!1}function TA(r){return Rr(r)?typeof r=="object"&&r!==null&&"_zod"in r&&typeof r._zod=="object"&&r._zod!==null&&"def"in r._zod&&typeof r._zod.def=="object"&&r._zod.def!==null&&"type"in r._zod.def&&r._zod.def.type==="array":!1}function dp(r,e=!1){if(ln(r))return r.strict();if(uo(r)){let t=r._zod.def.shape;if(e)for(let[i,a]of Object.entries(r._zod.def.shape)){if(uo(a)){let u=dp(a,e);t[i]=u}else if(TA(a)){let u=a._zod.def.element;uo(u)&&(u=dp(u,e)),t[i]=no(a,{...a._zod.def,element:u})}else t[i]=a;let o=on.get(a);o&&on.add(t[i],o)}let n=no(r,{...r._zod.def,shape:t,catchall:L0(j0)}),s=on.get(r);return s&&on.add(n,s),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function xN(r){return ln(r)&&"typeName"in r._def&&r._def.typeName==="ZodEffects"}function AN(r){return Rr(r)&&r._zod.def.type==="pipe"}function oo(r,e=!1){if(ln(r))return xN(r)?oo(r._def.schema,e):r;if(Rr(r)){let t=r;if(AN(r)&&(t=oo(r._zod.def.in,e)),e){if(uo(t)){let s=t._zod.def.shape;for(let[i,a]of Object.entries(t._zod.def.shape))s[i]=oo(a,e);t=no(t,{...t._zod.def,shape:s})}else if(TA(t)){let s=oo(t._zod.def.element,e);t=no(t,{...t._zod.def,element:s})}}let n=on.get(r);return n&&on.add(t,n),t}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}var Zn=_(()=>{ag()});function qn(r){if(Rr(r)){let e=oo(r,!0);if(uo(e)){let t=dp(e,!0);return ig(t)}else return ig(r)}return ln(r)?ao(r):r}var ks=_(()=>{ag();lp();lc();Zn();lc()});function ON(r,e){if(r!==void 0&&!Gt(r))return r;if(ic(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function PN(r){return ic(r.data)?{type:"runnable",data:{id:r.data.lc_id,name:r.data.getName()}}:{type:"schema",data:{...qn(r.data.schema),title:r.data.name}}}function kA(r,e=[]){let t=new Set(r.edges.filter(s=>!e.includes(s.source)).map(s=>s.target)),n=[];for(let s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}function CA(r,e=[]){let t=new Set(r.edges.filter(s=>!e.includes(s.target)).map(s=>s.source)),n=[];for(let s of Object.values(r.nodes))!e.includes(s.id)&&!t.has(s.id)&&n.push(s);return n.length===1?n[0]:void 0}var Cs,Zg=_(()=>{vr();Jm();w0();ks();Cs=class r{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){let e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=Gt(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...PN(t)})),edges:this.edges.map(t=>{let n={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(n.data=t.data),typeof t.conditional<"u"&&(n.conditional=t.conditional),n})}}addNode(e,t,n){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let s=t??ve(),i={id:s,data:e,name:ON(t,e),metadata:n};return this.nodes[s]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,s){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let i={source:e.id,target:t.id,data:n,conditional:s};return this.edges.push(i),i}firstNode(){return kA(this)}lastNode(){return CA(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map(c=>c.id).every(Gt)&&(n="");let i=c=>n?`${n}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[i(c)]={...l,id:i(c)}});let a=e.edges.map(c=>({...c,source:i(c.source),target:i(c.target)}));this.edges=[...this.edges,...a];let o=e.firstNode(),u=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,u?{id:i(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();e&&kA(this,[e.id])&&this.removeNode(e)}trimLastNode(){let e=this.lastNode();e&&CA(this,[e.id])&&this.removeNode(e)}reid(){let e=Object.fromEntries(Object.values(this.nodes).map(s=>[s.id,s.name])),t=new Map;Object.values(e).forEach(s=>{t.set(s,(t.get(s)||0)+1)});let n=s=>{let i=e[s];return Gt(s)&&t.get(i)===1?i:s};return new r({nodes:Object.fromEntries(Object.entries(this.nodes).map(([s,i])=>[n(s),{...i,id:n(s)}])),edges:this.edges.map(s=>({...s,source:n(s.source),target:n(s.target)}))})}drawMermaid(e){let{withStyles:t,curveStyle:n,nodeColors:s={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},a=this.reid(),o=a.firstNode(),u=a.lastNode();return y0(a.nodes,a.edges,{firstNode:o?.id,lastNode:u?.id,withStyles:t,curveStyle:n,nodeColors:s,wrapLabelNWords:i})}async drawMermaidPng(e){let t=this.drawMermaid(e);return _0(t,{backgroundColor:e?.backgroundColor})}}});function RA(r){let e=new TextEncoder,t=new ReadableStream({async start(n){for await(let s of r)n.enqueue(e.encode(`event: data
data: ${JSON.stringify(s)}

`));n.enqueue(e.encode(`event: end

`)),n.close()}});return Be.fromReadableStream(t)}var NA=_(()=>{Sr()});function qg(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.iterator]=="function"&&typeof r.next=="function"}function hp(r){return typeof r=="object"&&r!==null&&typeof r[Symbol.asyncIterator]=="function"}function*Kg(r,e){for(;;){let{value:t,done:n}=Ce.runWithConfig(Pr(r),e.next.bind(e),!0);if(n)break;yield t}}async function*mp(r,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:n,done:s}=await Ce.runWithConfig(Pr(r),t.next.bind(e),!0);if(s)break;yield n}}var $A,jA=_(()=>{Di();sn();$A=r=>r!=null&&typeof r=="object"&&"next"in r&&typeof r.next=="function"});function Ge(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}function SN(r){if(Kl(r))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}function Ze(r){if(typeof r=="function")return new fn({func:r});if(W.isRunnable(r))return r;if(!Array.isArray(r)&&typeof r=="object"){let e={};for(let[t,n]of Object.entries(r))e[t]=Ze(n);return new Rs({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}function IN(r,e){let t=e.name??r.getName(),n=e.description??fc(e.schema);return Gg(e.schema)?new dc({name:t,description:n,schema:Se.object({input:Se.string()}).transform(s=>s.input),bound:r}):new dc({name:t,description:n,schema:e.schema,bound:r})}var Hg,W,cr,gp,pc,gt,Rs,Wg,fn,bp,lo,yp,dc,st=_(()=>{Ll();Hg=yr(Ul(),1);vr();hh();Wm();m0();Ar();Sr();Km();sn();eo();b0();Jm();Di();Zg();NA();jA();jf();Zn();W=class extends Et{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new cr({bound:this,kwargs:e,config:{}})}map(){return new gp({bound:this})}withRetry(e){return new pc({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new cr({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new bp({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(fe);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let n=Object.fromEntries(Object.entries(e).filter(([s])=>s!=="runId"));return Array.from({length:t},(s,i)=>fe(i===0?e:n))}return Array.from({length:t},()=>fe(e))}async batch(e,t,n){let s=this._getOptionsList(t??{},e.length),i=s[0]?.maxConcurrency??n?.maxConcurrency,a=new Vn({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,c)=>a.call(async()=>{try{return await this.invoke(u,s[c])}catch(l){if(n?.returnExceptions)return l;throw l}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let n=fe(t),s=new Fn({generator:this._streamIterator(e,n),config:n});return await s.setup,Be.fromAsyncGenerator(s)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=fe(e):t=fe({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){let s=fe(n),a=await(await mt(s))?.handleChainStart(this.toJSON(),Ge(t,"input"),s.runId,s?.runType,void 0,void 0,s?.runName??this.getName());delete s.runId;let o;try{let u=e.call(this,t,s,a);o=await an(u,n?.signal)}catch(u){throw await a?.handleChainError(u),u}return await a?.handleChainEnd(Ge(o,"output")),o}async _batchWithConfig(e,t,n,s){let i=this._getOptionsList(n??{},t.length),a=await Promise.all(i.map(mt)),o=await Promise.all(a.map(async(c,l)=>{let f=await c?.handleChainStart(this.toJSON(),Ge(t[l],"input"),i[l].runId,i[l].runType,void 0,void 0,i[l].runName??this.getName());return delete i[l].runId,f})),u;try{let c=e.call(this,t,i,o,s);u=await an(c,i?.[0]?.signal)}catch(c){throw await Promise.all(o.map(l=>l?.handleChainError(c))),c}return await Promise.all(o.map(c=>c?.handleChainEnd(Ge(u,"output")))),u}_concatOutputChunks(e,t){return Un(e,t)}async*_transformStreamWithConfig(e,t,n){let s,i=!0,a,o=!0,u=fe(n),c=await mt(u),l=this;async function*f(){for await(let d of e){if(i)if(s===void 0)s=d;else try{s=l._concatOutputChunks(s,d)}catch{s=void 0,i=!1}yield d}}let p;try{let d=await l0(t.bind(this),f(),async()=>c?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),n?.signal,u);delete u.runId,p=d.setup;let h=p?.handlers.find(h0),m=d.output;h!==void 0&&p!==void 0&&(m=h.tapOutputIterable(p.runId,m));let g=p?.handlers.find(d0);g!==void 0&&p!==void 0&&(m=g.tapOutputIterable(p.runId,m));for await(let y of m)if(yield y,o)if(a===void 0)a=y;else try{a=this._concatOutputChunks(a,y)}catch{a=void 0,o=!1}}catch(d){throw await p?.handleChainError(d,void 0,void 0,void 0,{inputs:Ge(s,"input")}),d}await p?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:Ge(s,"input")})}getGraph(e){let t=new Cs,n=t.addNode({name:`${this.getName()}Input`,schema:Se.any()}),s=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Se.any()});return t.addEdge(n,s),t.addEdge(s,i),t}pipe(e){return new gt({first:this,last:Ze(e)})}pick(e){return this.pipe(new yp(e))}assign(e){return this.pipe(new lo(new Rs({steps:e})))}async*transform(e,t){let n;for await(let s of e)n===void 0?n=s:n=this._concatOutputChunks(n,s);yield*this._streamIterator(n,fe(t))}async*streamLog(e,t,n){let s=new nc({...n,autoClose:!1,_schemaFormat:"original"}),i=fe(t);yield*this._streamLog(e,s,i)}async*_streamLog(e,t,n){let{callbacks:s}=n;if(s===void 0)n.callbacks=[t];else if(Array.isArray(s))n.callbacks=s.concat([t]);else{let u=s.copy();u.addHandler(t,!0),n.callbacks=u}let i=this.stream(e,n);async function a(){try{let u=await i;for await(let c of u){let l=new Ir({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}let o=a();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,n){let s;if(t.version==="v1")s=this._streamEventsV1(e,t,n);else if(t.version==="v2")s=this._streamEventsV2(e,t,n);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?RA(s):Be.fromAsyncGenerator(s)}async*_streamEventsV2(e,t,n){let s=new Hf({...n,autoClose:!1}),i=fe(t),a=i.runId??ve();i.runId=a;let o=i.callbacks;if(o===void 0)i.callbacks=[s];else if(Array.isArray(o))i.callbacks=o.concat(s);else{let h=o.copy();h.addHandler(s,!0),i.callbacks=h}let u=new AbortController,c=this;async function l(){let h,m=null;try{t?.signal?"any"in AbortSignal?h=AbortSignal.any([u.signal,t.signal]):(h=t.signal,m=()=>{u.abort()},t.signal.addEventListener("abort",m,{once:!0})):h=u.signal;let g=await c.stream(e,{...i,signal:h}),y=s.tapOutputIterable(a,g);for await(let b of y)if(u.signal.aborted)break}finally{await s.finish(),h&&m&&h.removeEventListener("abort",m)}}let f=l(),p=!1,d;try{for await(let h of s){if(!p){h.data.input=e,p=!0,d=h.run_id,yield h;continue}h.run_id===d&&h.event.endsWith("_end")&&h.data?.input&&delete h.data.input,yield h}}finally{u.abort(),await f}}async*_streamEventsV1(e,t,n){let s,i=!1,a=fe(t),o=a.tags??[],u=a.metadata??{},c=a.runName??this.getName(),l=new nc({...n,autoClose:!1,_schemaFormat:"streaming_events"}),f=new Jf({...n}),p=this._streamLog(e,l,a);for await(let h of p){if(s?s=s.concat(h):s=rc.fromRunLogPatch(h),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let b={...s.state},w={run_id:b.id,event:`on_${b.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};f.includeEvent(w,b.type)&&(yield w)}let m=h.ops.filter(b=>b.path.startsWith("/logs/")).map(b=>b.path.split("/")[2]),g=[...new Set(m)];for(let b of g){let w,x={},A=s.state.logs[b];if(A.end_time===void 0?A.streamed_output.length>0?w="stream":w="start":w="end",w==="start")A.inputs!==void 0&&(x.input=A.inputs);else if(w==="end")A.inputs!==void 0&&(x.input=A.inputs),x.output=A.final_output;else if(w==="stream"){let P=A.streamed_output.length;if(P!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${P} instead. Encountered in: "${A.name}"`);x={chunk:A.streamed_output[0]},A.streamed_output=[]}yield{event:`on_${A.type}_${w}`,name:A.name,run_id:A.id,tags:A.tags,metadata:A.metadata,data:x}}let{state:y}=s;if(y.streamed_output.length>0){let b=y.streamed_output.length;if(b!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${b} instead. Encountered in: "${y.name}"`);let w={chunk:y.streamed_output[0]};y.streamed_output=[];let x={event:`on_${y.type}_stream`,run_id:y.id,tags:o,metadata:u,name:c,data:w};f.includeEvent(x,y.type)&&(yield x)}}let d=s?.state;if(d!==void 0){let h={event:`on_${d.type}_end`,name:c,run_id:d.id,tags:o,metadata:u,data:{output:d.final_output}};f.includeEvent(h,d.type)&&(yield h)}}static isRunnable(e){return ic(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new cr({bound:this,config:{},configFactories:[s=>({callbacks:[new sc({config:s,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return IN(this,e)}},cr=class r extends W{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=nt(this.config,...e);return nt(t,...this.configFactories?await Promise.all(this.configFactories.map(async n=>await n(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new pc({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(fe(t),this.kwargs))}async batch(e,t,n){let s=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(fe(i),this.kwargs))):await this._mergeConfig(fe(t),this.kwargs);return this.bound.batch(e,s,n)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(fe(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(fe(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(fe(t),this.kwargs))}streamEvents(e,t,n){let s=this,i=async function*(){yield*s.bound.streamEvents(e,{...await s._mergeConfig(fe(t),s.kwargs),version:t.version},n)};return Be.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&W.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new r({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new sc({config:s,onStart:e,onEnd:t,onError:n})]})]})}},gp=class r extends W{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new r({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,be(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new r({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}},pc=class extends cr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){let s=e>1?`retry:attempt:${e}`:void 0;return be(t,{callbacks:n?.getChild(s)})}async _invoke(e,t,n){return(0,Hg.default)(s=>super.invoke(e,this._patchConfigForRetry(s,t,n)),{onFailedAttempt:s=>this.onFailedAttempt(s,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,s){let i={};try{await(0,Hg.default)(async a=>{let o=e.map((p,d)=>d).filter(p=>i[p.toString()]===void 0||i[p.toString()]instanceof Error),u=o.map(p=>e[p]),c=o.map(p=>this._patchConfigForRetry(a,t?.[p],n?.[p])),l=await super.batch(u,c,{...s,returnExceptions:!0}),f;for(let p=0;p<l.length;p+=1){let d=l[p],h=o[p];d instanceof Error&&f===void 0&&(f=d,f.input=u[p]),i[h.toString()]=d}if(f)throw f;return l},{onFailedAttempt:a=>this.onFailedAttempt(a,a.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if(s?.returnExceptions!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}},gt=class r extends W{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let n=fe(t),i=await(await mt(n))?.handleChainStart(this.toJSON(),Ge(e,"input"),n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let a=e,o;try{let u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1){let f=u[c].invoke(a,be(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`)}));a=await an(f,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(a,be(n,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(Ge(o,"output")),o}async batch(e,t,n){let s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(mt)),a=await Promise.all(i.map(async(u,c)=>{let l=await u?.handleChainStart(this.toJSON(),Ge(e[c],"input"),s[c].runId,void 0,void 0,void 0,s[c].runName);return delete s[c].runId,l})),o=e;try{for(let u=0;u<this.steps.length;u+=1){let l=this.steps[u].batch(o,a.map((f,p)=>{let d=f?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return be(s[p],{callbacks:d})}),n);o=await an(l,s[0]?.signal)}}catch(u){throw await Promise.all(a.map(c=>c?.handleChainError(u))),u}return await Promise.all(a.map(u=>u?.handleChainEnd(Ge(o,"output")))),o}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){let n=await mt(t),{runId:s,...i}=t??{},a=await n?.handleChainStart(this.toJSON(),Ge(e,"input"),s,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last],u=!0,c;async function*l(){yield e}try{let f=o[0].transform(l(),be(i,{callbacks:a?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let p=1;p<o.length;p+=1)f=await o[p].transform(f,be(i,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${p+1}`)}));for await(let p of f)if(t?.signal?.throwIfAborted(),yield p,u)if(c===void 0)c=p;else try{c=this._concatOutputChunks(c,p)}catch{c=void 0,u=!1}}catch(f){throw await a?.handleChainError(f),f}await a?.handleChainEnd(Ge(c,"output"))}getGraph(e){let t=new Cs,n=null;return this.steps.forEach((s,i)=>{let a=s.getGraph(e);i!==0&&a.trimFirstNode(),i!==this.steps.length-1&&a.trimLastNode(),t.extend(a);let o=a.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);n&&t.addEdge(n,o),n=a.lastNode()}),t}pipe(e){return r.isRunnableSequence(e)?new r({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new r({first:this.first,middle:[...this.middle,this.last],last:Ze(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&W.isRunnable(e)}static from([e,...t],n){let s={};return typeof n=="string"?s.name=n:n!==void 0&&(s=n),new r({...s,first:Ze(e),middle:t.slice(0,-1).map(Ze),last:Ze(t[t.length-1])})}},Rs=class r extends W{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,n]of Object.entries(e.steps))this.steps[t]=Ze(n)}static from(e){return new r({steps:e})}async invoke(e,t){let n=fe(t),i=await(await mt(n))?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName);delete n.runId;let a={};try{let o=Object.entries(this.steps).map(async([u,c])=>{a[u]=await c.invoke(e,be(n,{callbacks:i?.getChild(`map:key:${u}`)}))});await an(Promise.all(o),t?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(a),a}async*_transform(e,t,n){let s={...this.steps},i=Hm(e,Object.keys(s).length),a=new Map(Object.entries(s).map(([o,u],c)=>{let l=u.transform(i[c],be(n,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,l.next().then(f=>({key:o,gen:l,result:f}))]}));for(;a.size;){let o=Promise.race(a.values()),{key:u,result:c,gen:l}=await an(o,n?.signal);a.delete(u),c.done||(yield{[u]:c.value},a.set(u,l.next().then(f=>({key:u,gen:l,result:f}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let s=fe(t),i=new Fn({generator:this.transform(n(),s),config:s});return await i.setup,Be.fromAsyncGenerator(i)}},Wg=class r extends W{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Kl(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[n]=this._getOptionsList(t??{},1),s=await mt(n),i=this.func(be(n,{callbacks:s}),e);return an(i,n?.signal)}async*_streamIterator(e,t){let[n]=this._getOptionsList(t??{},1),s=await this.invoke(e,t);if(hp(s)){for await(let i of s)n?.signal?.throwIfAborted(),yield i;return}if($A(s)){for(;;){n?.signal?.throwIfAborted();let i=s.next();if(i.done)break;yield i.value}return}yield s}static from(e){return new r({func:e})}};fn=class r extends W{static lc_name(){return"RunnableLambda"}constructor(e){if(Kl(e.func))return Wg.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),SN(e.func),this.func=e.func}static from(e){return new r({func:e})}async _invoke(e,t,n){return new Promise((s,i)=>{let a=be(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??Zf)-1});Ce.runWithConfig(Pr(a),async()=>{try{let o=await this.func(e,{...a});if(o&&W.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...a,recursionLimit:(a.recursionLimit??Zf)-1})}else if(hp(o)){let u;for await(let c of mp(a,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=this._concatOutputChunks(u,c)}catch{u=c}o=u}else if(qg(o)){let u;for(let c of Kg(a,o))if(t?.signal?.throwIfAborted(),u===void 0)u=c;else try{u=this._concatOutputChunks(u,c)}catch{u=c}o=u}s(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let s;for await(let o of e)if(s===void 0)s=o;else try{s=this._concatOutputChunks(s,o)}catch{s=o}let i=be(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??Zf)-1}),a=await new Promise((o,u)=>{Ce.runWithConfig(Pr(i),async()=>{try{let c=await this.func(s,{...i,config:i});o(c)}catch(c){u(c)}})});if(a&&W.isRunnable(a)){if(n?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await a.stream(s,i);for await(let u of o)yield u}else if(hp(a))for await(let o of mp(i,a))n?.signal?.throwIfAborted(),yield o;else if(qg(a))for(let o of Kg(i,a))n?.signal?.throwIfAborted(),yield o;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let s=fe(t),i=new Fn({generator:this.transform(n(),s),config:s});return await i.setup,Be.fromAsyncGenerator(i)}},bp=class extends W{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let n=fe(t),s=await mt(n),{runId:i,...a}=n,o=await s?.handleChainStart(this.toJSON(),Ge(e,"input"),i,void 0,void 0,void 0,a?.runName),u=be(a,{callbacks:o?.getChild()});return await Ce.runWithConfig(u,async()=>{let l;for(let f of this.runnables()){n?.signal?.throwIfAborted();try{let p=await f.invoke(e,u);return await o?.handleChainEnd(Ge(p,"output")),p}catch(p){l===void 0&&(l=p)}}throw l===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(l),l)})}async*_streamIterator(e,t){let n=fe(t),s=await mt(n),{runId:i,...a}=n,o=await s?.handleChainStart(this.toJSON(),Ge(e,"input"),i,void 0,void 0,void 0,a?.runName),u,c;for(let f of this.runnables()){n?.signal?.throwIfAborted();let p=be(a,{callbacks:o?.getChild()});try{let d=await f.stream(e,p);c=mp(p,d);break}catch(d){u===void 0&&(u=d)}}if(c===void 0){let f=u??new Error("No error stored at end of fallback.");throw await o?.handleChainError(f),f}let l;try{for await(let f of c){yield f;try{l=l===void 0?l:this._concatOutputChunks(l,f)}catch{l=void 0}}}catch(f){throw await o?.handleChainError(f),f}await o?.handleChainEnd(Ge(l,"output"))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");let s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(u=>mt(u))),a=await Promise.all(i.map(async(u,c)=>{let l=await u?.handleChainStart(this.toJSON(),Ge(e[c],"input"),s[c].runId,void 0,void 0,void 0,s[c].runName);return delete s[c].runId,l})),o;for(let u of this.runnables()){s[0].signal?.throwIfAborted();try{let c=await u.batch(e,a.map((l,f)=>be(s[f],{callbacks:l?.getChild()})),n);return await Promise.all(a.map((l,f)=>l?.handleChainEnd(Ge(c[f],"output")))),c}catch(c){o===void 0&&(o=c)}}throw o?(await Promise.all(a.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};lo=class extends W{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Rs&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){let s=this.mapper.getStepsKeys(),[i,a]=Hm(e),o=this.mapper.transform(a,be(n,{callbacks:t?.getChild()})),u=o.next();for await(let c of i){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);let l=Object.fromEntries(Object.entries(c).filter(([f])=>!s.includes(f)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(let c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let s=fe(t),i=new Fn({generator:this.transform(n(),s),config:s});return await i.setup,Be.fromAsyncGenerator(i)}},yp=class extends W{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(n=>[n,e[n]]).filter(n=>n[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let n=await this._pick(t);n!==void 0&&(yield n)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*n(){yield e}let s=fe(t),i=new Fn({generator:this.transform(n(),s),config:s});return await i.setup,Be.fromAsyncGenerator(i)}},dc=class extends cr{constructor(e){let t=gt.from([fn.from(async n=>{let s;if(ws(n))try{s=await co(this.schema,n.args)}catch{throw new Ci("Received tool input did not match expected schema",JSON.stringify(n.args))}else s=n;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}});var hc,fo,po,_p,ho=_(()=>{Ar();Yu();Dn();hc=class extends Et{},fo=class extends hc{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new ht(this.value)]}},po=class extends hc{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Xa(this.messages)}toChatMessages(){return this.messages}},_p=class extends hc{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new ht({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}});var Kn,mc=_(()=>{ho();mo();Kn=class extends Hn{async formatPromptValue(e){let t=await this.format(e);return new fo(t)}}});function Yg(r){return typeof r=="function"}function CN(r){return bo(r)?"array":typeof r}function Jg(r){return r.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function MA(r,e){return r!=null&&typeof r=="object"&&e in r}function RN(r,e){return r!=null&&typeof r!="object"&&r.hasOwnProperty&&r.hasOwnProperty(e)}function $N(r,e){return NN.call(r,e)}function MN(r){return!$N(jN,r)}function LN(r){return String(r).replace(/[&<>"'`=\/]/g,function(t){return zN[t]})}function VN(r,e){if(!r)return[];var t=!1,n=[],s=[],i=[],a=!1,o=!1,u="",c=0;function l(){if(a&&!o)for(;i.length;)delete s[i.pop()];else i=[];a=!1,o=!1}var f,p,d;function h(N){if(typeof N=="string"&&(N=N.split(FN,2)),!bo(N)||N.length!==2)throw new Error("Invalid tags: "+N);f=new RegExp(Jg(N[0])+"\\s*"),p=new RegExp("\\s*"+Jg(N[1])),d=new RegExp("\\s*"+Jg("}"+N[1]))}h(e||lr.tags);for(var m=new bc(r),g,y,b,w,x,A;!m.eos();){if(g=m.pos,b=m.scanUntil(f),b)for(var P=0,M=b.length;P<M;++P)w=b.charAt(P),MN(w)?(i.push(s.length),u+=w):(o=!0,t=!0,u+=" "),s.push(["text",w,g,g+1]),g+=1,w===`
`&&(l(),u="",c=0,t=!1);if(!m.scan(f))break;if(a=!0,y=m.scan(BN)||"name",m.scan(DN),y==="="?(b=m.scanUntil(zA),m.scan(zA),m.scanUntil(p)):y==="{"?(b=m.scanUntil(d),m.scan(UN),m.scanUntil(p),y="&"):b=m.scanUntil(p),!m.scan(p))throw new Error("Unclosed tag at "+m.pos);if(y==">"?x=[y,b,g,m.pos,u,c,t]:x=[y,b,g,m.pos],c++,s.push(x),y==="#"||y==="^")n.push(x);else if(y==="/"){if(A=n.pop(),!A)throw new Error('Unopened section "'+b+'" at '+g);if(A[1]!==b)throw new Error('Unclosed section "'+A[1]+'" at '+g)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&h(b)}if(l(),A=n.pop(),A)throw new Error('Unclosed section "'+A[1]+'" at '+m.pos);return ZN(GN(s))}function GN(r){for(var e=[],t,n,s=0,i=r.length;s<i;++s)t=r[s],t&&(t[0]==="text"&&n&&n[0]==="text"?(n[1]+=t[1],n[3]=t[3]):(e.push(t),n=t));return e}function ZN(r){for(var e=[],t=e,n=[],s,i,a=0,o=r.length;a<o;++a)switch(s=r[a],s[0]){case"#":case"^":t.push(s),n.push(s),t=s[4]=[];break;case"/":i=n.pop(),i[5]=s[2],t=n.length>0?n[n.length-1][4]:e;break;default:t.push(s)}return e}function bc(r){this.string=r,this.tail=r,this.pos=0}function go(r,e){this.view=r,this.cache={".":this.view},this.parent=e}function Tt(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}var kN,bo,NN,jN,zN,DN,FN,zA,UN,BN,lr,gc,wp,LA=_(()=>{kN=Object.prototype.toString,bo=Array.isArray||function(e){return kN.call(e)==="[object Array]"};NN=RegExp.prototype.test;jN=/\S/;zN={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};DN=/\s*/,FN=/\s+/,zA=/\s*=/,UN=/\s*\}/,BN=/#|\^|\/|>|\{|&|=|!/;bc.prototype.eos=function(){return this.tail===""};bc.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};bc.prototype.scanUntil=function(e){var t=this.tail.search(e),n;switch(t){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=n.length,n};go.prototype.push=function(e){return new go(e,this)};go.prototype.lookup=function(e){var t=this.cache,n;if(t.hasOwnProperty(e))n=t[e];else{for(var s=this,i,a,o,u=!1;s;){if(e.indexOf(".")>0)for(i=s.view,a=e.split("."),o=0;i!=null&&o<a.length;)o===a.length-1&&(u=MA(i,a[o])||RN(i,a[o])),i=i[a[o++]];else i=s.view[e],u=MA(s.view,e);if(u){n=i;break}s=s.parent}t[e]=n}return Yg(n)&&(n=n.call(this.view)),n};Tt.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};Tt.prototype.parse=function(e,t){var n=this.templateCache,s=e+":"+(t||lr.tags).join(":"),i=typeof n<"u",a=i?n.get(s):void 0;return a==null&&(a=VN(e,t),i&&n.set(s,a)),a};Tt.prototype.render=function(e,t,n,s){var i=this.getConfigTags(s),a=this.parse(e,i),o=t instanceof go?t:new go(t,void 0);return this.renderTokens(a,o,n,e,s)};Tt.prototype.renderTokens=function(e,t,n,s,i){for(var a="",o,u,c,l=0,f=e.length;l<f;++l)c=void 0,o=e[l],u=o[0],u==="#"?c=this.renderSection(o,t,n,s,i):u==="^"?c=this.renderInverted(o,t,n,s,i):u===">"?c=this.renderPartial(o,t,n,i):u==="&"?c=this.unescapedValue(o,t):u==="name"?c=this.escapedValue(o,t,i):u==="text"&&(c=this.rawValue(o)),c!==void 0&&(a+=c);return a};Tt.prototype.renderSection=function(e,t,n,s,i){var a=this,o="",u=t.lookup(e[1]);function c(p){return a.render(p,t,n,i)}if(u){if(bo(u))for(var l=0,f=u.length;l<f;++l)o+=this.renderTokens(e[4],t.push(u[l]),n,s,i);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),n,s,i);else if(Yg(u)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,s.slice(e[3],e[5]),c),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,n,s,i);return o}};Tt.prototype.renderInverted=function(e,t,n,s,i){var a=t.lookup(e[1]);if(!a||bo(a)&&a.length===0)return this.renderTokens(e[4],t,n,s,i)};Tt.prototype.indentPartial=function(e,t,n){for(var s=t.replace(/[^ \t]/g,""),i=e.split(`
`),a=0;a<i.length;a++)i[a].length&&(a>0||!n)&&(i[a]=s+i[a]);return i.join(`
`)};Tt.prototype.renderPartial=function(e,t,n,s){if(n){var i=this.getConfigTags(s),a=Yg(n)?n(e[1]):n[e[1]];if(a!=null){var o=e[6],u=e[5],c=e[4],l=a;u==0&&c&&(l=this.indentPartial(a,c,o));var f=this.parse(l,i);return this.renderTokens(f,t,n,l,s)}}};Tt.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(n!=null)return n};Tt.prototype.escapedValue=function(e,t,n){var s=this.getConfigEscape(n)||lr.escape,i=t.lookup(e[1]);if(i!=null)return typeof i=="number"&&s===lr.escape?String(i):s(i)};Tt.prototype.rawValue=function(e){return e[1]};Tt.prototype.getConfigTags=function(e){return bo(e)?e:e&&typeof e=="object"?e.tags:void 0};Tt.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!bo(e))return e.escape};lr={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(r){gc.templateCache=r},get templateCache(){return gc.templateCache}},gc=new Tt;lr.clearCache=function(){return gc.clearCache()};lr.parse=function(e,t){return gc.parse(e,t)};lr.render=function(e,t,n,s){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+CN(e)+'" was given as the first argument for mustache#render(template, view, partials)');return gc.render(e,t,n,s)};lr.escape=LN;lr.Scanner=bc;lr.Context=go;lr.Writer=Tt;wp=lr});function DA(){wp.escape=r=>r}var yc,FA,vp,qN,KN,Xg,HN,Ft,_c,Ui,Bi=_(()=>{LA();Wu();yc=r=>{let e=r.split(""),t=[],n=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1},s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){let i=n("}",s);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{let i=n("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");t.push({type:"literal",text:a}),s=i<0?e.length:i}}return t},FA=(r,e=[])=>{let t=[];for(let n of r)if(n[0]==="name"){let s=n[1].includes(".")?n[1].split(".")[0]:n[1];t.push({type:"variable",name:s})}else if(["#","&","^",">"].includes(n[0])){if(t.push({type:"variable",name:n[1]}),n[0]==="#"&&n.length>4&&Array.isArray(n[4])){let s=[...e,n[1]],i=FA(n[4],s);t.push(...i)}}else t.push({type:"literal",text:n[1]});return t},vp=r=>{DA();let e=wp.parse(r);return FA(e)},qN=(r,e)=>yc(r).reduce((t,n)=>{if(n.type==="variable"){if(n.name in e){let s=typeof e[n.name]=="string"?e[n.name]:JSON.stringify(e[n.name]);return t+s}throw new Error(`(f-string) Missing value for input ${n.name}`)}return t+n.text},""),KN=(r,e)=>(DA(),wp.render(r,e)),Xg={"f-string":qN,mustache:KN},HN={"f-string":yc,mustache:vp},Ft=(r,e,t)=>{try{return Xg[e](r,t)}catch(n){throw _s(n,"INVALID_PROMPT_INPUT")}},_c=(r,e)=>HN[e](r),Ui=(r,e,t)=>{if(!(e in Xg)){let n=Object.keys(Xg);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${n}`)}try{let n=t.reduce((s,i)=>(s[i]="foo",s),{});Array.isArray(r)?r.forEach(s=>{if(s.type==="text")Ft(s.text,e,n);else if(s.type==="image_url")if(typeof s.image_url=="string")Ft(s.image_url,e,n);else{let i=s.image_url.url;Ft(i,e,n)}else throw new Error(`Invalid message template received. ${JSON.stringify(s,null,2)}`)}):Ft(r,e,n)}catch(n){throw new Error(`Invalid prompt schema: ${n.message}`)}}});var Qg={};Sl(Qg,{PromptTemplate:()=>fr});var fr,yo=_(()=>{mc();Bi();fr=class r extends Kn{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ui(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return Ft(this.template,this.templateFormat,t)}static fromExamples(e,t,n,s=`

`,i=""){let a=[i,...e,t].join(s);return new r({inputVariables:n,template:a})}static fromTemplate(e,t){let{templateFormat:n="f-string",...s}=t??{},i=new Set;return _c(e,n).forEach(a=>{a.type==="variable"&&i.add(a.name)}),new r({inputVariables:[...i],templateFormat:n,template:e,...s})}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:n};return new r(s)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new r({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}});var UA=_(()=>{st();Ni();or();Mf();zf();Yu();Lf();Df();Ya();Dn()});var Wn=_(()=>{Ni();or();Mf();zf();Yu();Df();Dn();UA();Lf();Cm();Ya()});var _o,eb=_(()=>{ho();mo();Bi();_o=class r extends Hn{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ui([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:n};return new r(s)}async format(e){let t={};for(let[a,o]of Object.entries(this.template))typeof o=="string"?t[a]=Ft(o,this.templateFormat,e):t[a]=o;let n=e.url||t.url,s=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if(typeof n!="string")throw new Error("url must be a string.");let i={url:n};return s&&(i.detail=s),i}async formatPromptValue(e){let t=await this.format(e);return new _p(t)}}});function tb(r,e){let t=[];for(let n of Object.values(r))if(typeof n=="string")_c(n,e).forEach(s=>{s.type==="variable"&&t.push(s.name)});else if(Array.isArray(n))for(let s of n)typeof s=="string"?_c(s,e).forEach(i=>{i.type==="variable"&&t.push(i.name)}):typeof s=="object"&&t.push(...tb(s,e));else typeof n=="object"&&n!==null&&t.push(...tb(n,e));return Array.from(new Set(t))}function rb(r,e,t){let n={};for(let[s,i]of Object.entries(r))if(typeof i=="string")n[s]=Ft(i,t,e);else if(Array.isArray(i)){let a=[];for(let o of i)typeof o=="string"?a.push(Ft(o,t,e)):typeof o=="object"&&a.push(rb(o,e,t));n[s]=a}else typeof i=="object"&&i!==null?n[s]=rb(i,e,t):n[s]=i;return n}var wc,nb=_(()=>{st();Bi();wc=class extends W{static lc_name(){return"DictPromptTemplate"}constructor(e){let t=e.templateFormat??"f-string",n=tb(e.template,t);super({inputVariables:n,...e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","dict"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=t,this.inputVariables=n}async format(e){return rb(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}}});function JN(r){return r===null||typeof r!="object"||Array.isArray(r)?!1:Object.keys(r).length===1&&"text"in r&&typeof r.text=="string"}function YN(r){return r===null||typeof r!="object"||Array.isArray(r)?!1:"image_url"in r&&(typeof r.image_url=="string"||typeof r.image_url=="object"&&r.image_url!==null&&"url"in r.image_url&&typeof r.image_url.url=="string")}function XN(r){return typeof r.formatMessages=="function"}function QN(r,e){if(XN(r)||Ue(r))return r;if(Array.isArray(r)&&r[0]==="placeholder"){let s=r[1];if(e?.templateFormat==="mustache"&&typeof s=="string"&&s.slice(0,2)==="{{"&&s.slice(-2)==="}}"){let i=s.slice(2,-2);return new xp({variableName:i,optional:!0})}else if(typeof s=="string"&&s[0]==="{"&&s[s.length-1]==="}"){let i=s.slice(1,-1);return new xp({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${e?.templateFormat??'"f-string"'}: "${r[1]}". Expected a variable name surrounded by ${e?.templateFormat==="mustache"?"double":"single"} curly braces.`)}let t=Dt(r),n;if(typeof t.content=="string"?n=t.content:n=t.content.map(s=>"text"in s?{...s,text:s.text}:"image_url"in s?{...s,image_url:s.image_url}:s),t._getType()==="human")return Ap.fromTemplate(n,e);if(t._getType()==="ai")return ab.fromTemplate(n,e);if(t._getType()==="system")return ob.fromTemplate(n,e);if(Or.isInstance(t))return ib.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function e$(r){return r.constructor.lc_name()==="MessagesPlaceholder"}var vc,xp,sb,xc,ib,Ac,Ap,ab,ob,Ns,Ec=_(()=>{Wn();ho();st();mc();mo();yo();eb();Bi();Wu();nb();vc=class extends W{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(n=>this.formatMessages(n),e,{...t,runType:"prompt"})}},xp=class extends vc{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let s=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw s.name="InputFormatError",s}let n;try{Array.isArray(t)?n=t.map(Dt):n=[Dt(t)]}catch(s){let i=typeof t=="string"?t:JSON.stringify(t,null,2),a=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${s.message}`].join(`

`));throw a.name="InputFormatError",a.lc_error_code=s.lc_error_code,a}return n}},sb=class extends vc{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},xc=class extends Hn{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new po(t)}},ib=class extends sb{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new Or(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(fr.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}};Ac=class extends vc{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let n=[];this.prompt.forEach(s=>{"inputVariables"in s&&(n=n.concat(s.inputVariables))}),this.inputVariables=n}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let n=t._messageClass();return new n({content:e})}else if(t.chatMessageClass){let n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(fr.fromTemplate(e,t));let n=[];for(let s of e)if(typeof s=="string")n.push(fr.fromTemplate(s,t));else if(s!==null)if(JN(s)){let i="";typeof s.text=="string"&&(i=s.text??"");let a={...t,additionalContentFields:s};n.push(fr.fromTemplate(i,a))}else if(YN(s)){let i=s.image_url??"",a,o=[];if(typeof i=="string"){let u;t?.templateFormat==="mustache"?u=vp(i):u=yc(i);let c=u.flatMap(l=>l.type==="variable"?[l.name]:[]);if((c?.length??0)>0){if(c.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${c}
From: ${i}`);o=[c[0]]}else o=[];i={url:i},a=new _o({template:i,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:s})}else if(typeof i=="object"){if("url"in i){let u;t?.templateFormat==="mustache"?u=vp(i.url):u=yc(i.url),o=u.flatMap(c=>c.type==="variable"?[c.name]:[])}else o=[];a=new _o({template:i,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:s})}else throw new Error("Invalid image template");n.push(a)}else typeof s=="object"&&n.push(new wc({template:s,templateFormat:t?.templateFormat}));return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof Kn){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let n of this.prompt){let s={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(let i of n.inputVariables)s||(s={[i]:e[i]}),s={...s,[i]:e[i]};if(n instanceof Kn){let i=await n.format(s),a;"additionalContentFields"in n&&(a=n.additionalContentFields),i!==""&&t.push({...a,type:"text",text:i})}else if(n instanceof _o){let i=await n.format(s),a;"additionalContentFields"in n&&(a=n.additionalContentFields),t.push({...a,type:"image_url",image_url:i})}else if(n instanceof wc){let i=await n.format(s),a;"additionalContentFields"in n&&(a=n.additionalContentFields),t.push({...a,...i})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},Ap=class extends Ac{static _messageClass(){return ht}static lc_name(){return"HumanMessagePromptTemplate"}},ab=class extends Ac{static _messageClass(){return dt}static lc_name(){return"AIMessagePromptTemplate"}},ob=class extends Ac{static _messageClass(){return vs}static lc_name(){return"SystemMessagePromptTemplate"}};Ns=class r extends xc{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let o of this.promptMessages)if(!(o instanceof ze))for(let u of o.inputVariables)t.add(u);let n=this.inputVariables,s=new Set(this.partialVariables?n.concat(Object.keys(this.partialVariables)):n),i=new Set([...s].filter(o=>!t.has(o)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);let a=new Set([...t].filter(o=>!s.has(o)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;let n=await Promise.all(e.content.map(async s=>{if(s.type!=="image_url")return s;let i="";typeof s.image_url=="string"?i=s.image_url:i=s.image_url.url;let o=await fr.fromTemplate(i,{templateFormat:this.templateFormat}).format(t);return typeof s.image_url!="string"&&"url"in s.image_url?s.image_url.url=o:s.image_url=o,s}));return e.content=n,e}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),n=[];for(let s of this.promptMessages)if(s instanceof ze)n.push(await this._parseImagePrompts(s,t));else{let i;this.templateFormat==="mustache"?i={...t}:i=s.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(e$(s)&&s.optional))throw _s(new Error(`Missing value for input variable \`${u.toString()}\``),"INVALID_PROMPT_INPUT");return o[u]=t[u],o},{});let a=await s.formatMessages(i);n=n.concat(a)}return n}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:n};return new r(s)}static fromTemplate(e,t){let n=fr.fromTemplate(e,t),s=new Ap({prompt:n});return this.fromMessages([s])}static fromMessages(e,t){let n=e.reduce((a,o)=>a.concat(o instanceof r?o.promptMessages:[QN(o,t)]),[]),s=e.reduce((a,o)=>o instanceof r?Object.assign(a,o.partialVariables):a,Object.create(null)),i=new Set;for(let a of n)if(!(a instanceof ze))for(let o of a.inputVariables)o in s||i.add(o);return new this({...t,inputVariables:[...i],promptMessages:n,partialVariables:s,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}});var BA={};Sl(BA,{FewShotChatMessagePromptTemplate:()=>cb,FewShotPromptTemplate:()=>ub});var ub,cb,lb=_(()=>{mc();Bi();yo();Ec();ub=class r extends Kn{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ui(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:n};return new r(s)}async format(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),s=await Promise.all(n.map(a=>this.examplePrompt.format(a))),i=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return Ft(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let n=await fr.deserialize(t),s;if(Array.isArray(e.examples))s=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new r({inputVariables:e.input_variables,examplePrompt:n,examples:s,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},cb=class r extends xc{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ui(this.prefix+this.suffix,this.templateFormat,t)}}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t);n=n.map(i=>{let a={};return this.examplePrompt.inputVariables.forEach(o=>{a[o]=i[o]}),a});let s=[];for(let i of n){let a=await this.examplePrompt.formatMessages(i);s.push(...a)}return s}async format(e){let t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),i=(await Promise.all(n.map(o=>this.examplePrompt.formatMessages(o)))).flat().map(o=>o.content),a=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return Ft(a,this.templateFormat,t)}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),n={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:n};return new r(s)}}});var Hn,mo=_(()=>{st();Hn=class extends W{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},n={};for(let[i,a]of Object.entries(t))typeof a=="string"?n[i]=a:n[i]=await a();return{...n,...e}}async invoke(e,t){let n={...this.metadata,...t?.metadata},s=[...this.tags??[],...t?.tags??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...t,tags:s,metadata:n,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(yo(),Qg));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(yo(),Qg));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(lb(),BA));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}});var JA=B(kp=>{"use strict";kp.byteLength=g$;kp.toByteArray=y$;kp.fromByteArray=v$;var dn=[],pr=[],m$=typeof Uint8Array<"u"?Uint8Array:Array,db="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Gi=0,HA=db.length;Gi<HA;++Gi)dn[Gi]=db[Gi],pr[db.charCodeAt(Gi)]=Gi;var Gi,HA;pr[45]=62;pr[95]=63;function WA(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function g$(r){var e=WA(r),t=e[0],n=e[1];return(t+n)*3/4-n}function b$(r,e,t){return(e+t)*3/4-t}function y$(r){var e,t=WA(r),n=t[0],s=t[1],i=new m$(b$(r,n,s)),a=0,o=s>0?n-4:n,u;for(u=0;u<o;u+=4)e=pr[r.charCodeAt(u)]<<18|pr[r.charCodeAt(u+1)]<<12|pr[r.charCodeAt(u+2)]<<6|pr[r.charCodeAt(u+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=pr[r.charCodeAt(u)]<<2|pr[r.charCodeAt(u+1)]>>4,i[a++]=e&255),s===1&&(e=pr[r.charCodeAt(u)]<<10|pr[r.charCodeAt(u+1)]<<4|pr[r.charCodeAt(u+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function _$(r){return dn[r>>18&63]+dn[r>>12&63]+dn[r>>6&63]+dn[r&63]}function w$(r,e,t){for(var n,s=[],i=e;i<t;i+=3)n=(r[i]<<16&16711680)+(r[i+1]<<8&65280)+(r[i+2]&255),s.push(_$(n));return s.join("")}function v$(r){for(var e,t=r.length,n=t%3,s=[],i=16383,a=0,o=t-n;a<o;a+=i)s.push(w$(r,a,a+i>o?o:a+i));return n===1?(e=r[t-1],s.push(dn[e>>2]+dn[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],s.push(dn[e>>10]+dn[e>>4&63]+dn[e<<2&63]+"=")),s.join("")}});mo();Ec();lb();mo();Ec();yo();mc();Bi();eb();st();Ec();nb();var Jn=class extends Error{constructor(e,t){let n=e??"";t?.lc_error_code&&(n=`${n}

Troubleshooting URL: https://langchain-ai.github.io/langgraphjs/troubleshooting/errors/${t.lc_error_code}/
`),super(n),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}},Ep=class extends Jn{get is_bubble_up(){return!0}},Op=class extends Jn{constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},Oc=class extends Jn{constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},$s=class extends Ep{constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},Pc=class extends $s{constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},Sc=class extends Ep{constructor(e){super(),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function VA(r){return r!==void 0&&r.name===Sc.unminifiable_name}function wo(r){return r!==void 0&&r.is_bubble_up===!0}function Vi(r){return r!==void 0&&[$s.unminifiable_name,Pc.unminifiable_name].includes(r.name)}var Ic=class extends Jn{constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},Oe=class extends Jn{constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},he=class extends Jn{constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}};var Pp=class extends Jn{constructor(e,t){super(e,t),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};vr();function Sp(r){return ql({clockseq:r})}function js(r,e){let t=e.replace(/-/g,"").match(/.{2}/g).map(n=>parseInt(n,16));return Ba(r,new Uint8Array(t))}var GA="__error__",vo="__scheduled__",ZA="__interrupt__",qA="__resume__";Ar();var r$=typeof window=="object"?window:{},oe="0123456789abcdef".split(""),n$=[-2147483648,8388608,32768,128],Nr=[24,16,8,0];var Je=[];function $r(r){r?(Je[0]=Je[16]=Je[1]=Je[2]=Je[3]=Je[4]=Je[5]=Je[6]=Je[7]=Je[8]=Je[9]=Je[10]=Je[11]=Je[12]=Je[13]=Je[14]=Je[15]=0,this.blocks=Je):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}$r.prototype.update=function(r){if(!this.finalized){var e=typeof r!="string";e&&r.constructor===r$.ArrayBuffer&&(r=new Uint8Array(r));for(var t,n=0,s,i=r.length||0,a=this.blocks;n<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),e)for(s=this.start;n<i&&s<64;++n)a[s>>2]|=r[n]<<Nr[s++&3];else for(s=this.start;n<i&&s<64;++n)t=r.charCodeAt(n),t<128?a[s>>2]|=t<<Nr[s++&3]:t<2048?(a[s>>2]|=(192|t>>6)<<Nr[s++&3],a[s>>2]|=(128|t&63)<<Nr[s++&3]):t<55296||t>=57344?(a[s>>2]|=(224|t>>12)<<Nr[s++&3],a[s>>2]|=(128|t>>6&63)<<Nr[s++&3],a[s>>2]|=(128|t&63)<<Nr[s++&3]):(t=65536+((t&1023)<<10|r.charCodeAt(++n)&1023),a[s>>2]|=(240|t>>18)<<Nr[s++&3],a[s>>2]|=(128|t>>12&63)<<Nr[s++&3],a[s>>2]|=(128|t>>6&63)<<Nr[s++&3],a[s>>2]|=(128|t&63)<<Nr[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=a[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};$r.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>2]|=n$[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};$r.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,i,a,o,u=this.blocks;for(a=16;a<80;++a)o=u[a-3]^u[a-8]^u[a-14]^u[a-16],u[a]=o<<1|o>>>31;for(a=0;a<20;a+=5)i=e&t|~e&n,o=r<<5|r>>>27,s=o+i+s+1518500249+u[a]<<0,e=e<<30|e>>>2,i=r&e|~r&t,o=s<<5|s>>>27,n=o+i+n+1518500249+u[a+1]<<0,r=r<<30|r>>>2,i=s&r|~s&e,o=n<<5|n>>>27,t=o+i+t+1518500249+u[a+2]<<0,s=s<<30|s>>>2,i=n&s|~n&r,o=t<<5|t>>>27,e=o+i+e+1518500249+u[a+3]<<0,n=n<<30|n>>>2,i=t&n|~t&s,o=e<<5|e>>>27,r=o+i+r+1518500249+u[a+4]<<0,t=t<<30|t>>>2;for(;a<40;a+=5)i=e^t^n,o=r<<5|r>>>27,s=o+i+s+1859775393+u[a]<<0,e=e<<30|e>>>2,i=r^e^t,o=s<<5|s>>>27,n=o+i+n+1859775393+u[a+1]<<0,r=r<<30|r>>>2,i=s^r^e,o=n<<5|n>>>27,t=o+i+t+1859775393+u[a+2]<<0,s=s<<30|s>>>2,i=n^s^r,o=t<<5|t>>>27,e=o+i+e+1859775393+u[a+3]<<0,n=n<<30|n>>>2,i=t^n^s,o=e<<5|e>>>27,r=o+i+r+1859775393+u[a+4]<<0,t=t<<30|t>>>2;for(;a<60;a+=5)i=e&t|e&n|t&n,o=r<<5|r>>>27,s=o+i+s-1894007588+u[a]<<0,e=e<<30|e>>>2,i=r&e|r&t|e&t,o=s<<5|s>>>27,n=o+i+n-1894007588+u[a+1]<<0,r=r<<30|r>>>2,i=s&r|s&e|r&e,o=n<<5|n>>>27,t=o+i+t-1894007588+u[a+2]<<0,s=s<<30|s>>>2,i=n&s|n&r|s&r,o=t<<5|t>>>27,e=o+i+e-1894007588+u[a+3]<<0,n=n<<30|n>>>2,i=t&n|t&s|n&s,o=e<<5|e>>>27,r=o+i+r-1894007588+u[a+4]<<0,t=t<<30|t>>>2;for(;a<80;a+=5)i=e^t^n,o=r<<5|r>>>27,s=o+i+s-899497514+u[a]<<0,e=e<<30|e>>>2,i=r^e^t,o=s<<5|s>>>27,n=o+i+n-899497514+u[a+1]<<0,r=r<<30|r>>>2,i=s^r^e,o=n<<5|n>>>27,t=o+i+t-899497514+u[a+2]<<0,s=s<<30|s>>>2,i=n^s^r,o=t<<5|t>>>27,e=o+i+e-899497514+u[a+3]<<0,n=n<<30|n>>>2,i=t^n^s,o=e<<5|e>>>27,r=o+i+r-899497514+u[a+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0};$r.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4;return oe[r>>28&15]+oe[r>>24&15]+oe[r>>20&15]+oe[r>>16&15]+oe[r>>12&15]+oe[r>>8&15]+oe[r>>4&15]+oe[r&15]+oe[e>>28&15]+oe[e>>24&15]+oe[e>>20&15]+oe[e>>16&15]+oe[e>>12&15]+oe[e>>8&15]+oe[e>>4&15]+oe[e&15]+oe[t>>28&15]+oe[t>>24&15]+oe[t>>20&15]+oe[t>>16&15]+oe[t>>12&15]+oe[t>>8&15]+oe[t>>4&15]+oe[t&15]+oe[n>>28&15]+oe[n>>24&15]+oe[n>>20&15]+oe[n>>16&15]+oe[n>>12&15]+oe[n>>8&15]+oe[n>>4&15]+oe[n&15]+oe[s>>28&15]+oe[s>>24&15]+oe[s>>20&15]+oe[s>>16&15]+oe[s>>12&15]+oe[s>>8&15]+oe[s>>4&15]+oe[s&15]};$r.prototype.toString=$r.prototype.hex;$r.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4;return[r>>24&255,r>>16&255,r>>8&255,r&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,s>>24&255,s>>16&255,s>>8&255,s&255]};$r.prototype.array=$r.prototype.digest;$r.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(20),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),r};var KA=!1,fb=r=>(KA||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),KA=!0),new $r(!0).update(r).hex());var D="0123456789abcdef".split(""),s$=[-2147483648,8388608,32768,128],jr=[24,16,8,0],Ip=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];var Ye=[];function pn(r,e){e?(Ye[0]=Ye[16]=Ye[1]=Ye[2]=Ye[3]=Ye[4]=Ye[5]=Ye[6]=Ye[7]=Ye[8]=Ye[9]=Ye[10]=Ye[11]=Ye[12]=Ye[13]=Ye[14]=Ye[15]=0,this.blocks=Ye):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=r}pn.prototype.update=function(r){if(!this.finalized){var e,t=typeof r;if(t!=="string"){if(t==="object"){if(r===null)throw new Error(ERROR);if(ARRAY_BUFFER&&r.constructor===ArrayBuffer)r=new Uint8Array(r);else if(!Array.isArray(r)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(r)))throw new Error(ERROR)}else throw new Error(ERROR);e=!0}for(var n,s=0,i,a=r.length,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),e)for(i=this.start;s<a&&i<64;++s)o[i>>>2]|=r[s]<<jr[i++&3];else for(i=this.start;s<a&&i<64;++s)n=r.charCodeAt(s),n<128?o[i>>>2]|=n<<jr[i++&3]:n<2048?(o[i>>>2]|=(192|n>>>6)<<jr[i++&3],o[i>>>2]|=(128|n&63)<<jr[i++&3]):n<55296||n>=57344?(o[i>>>2]|=(224|n>>>12)<<jr[i++&3],o[i>>>2]|=(128|n>>>6&63)<<jr[i++&3],o[i>>>2]|=(128|n&63)<<jr[i++&3]):(n=65536+((n&1023)<<10|r.charCodeAt(++s)&1023),o[i>>>2]|=(240|n>>>18)<<jr[i++&3],o[i>>>2]|=(128|n>>>12&63)<<jr[i++&3],o[i>>>2]|=(128|n>>>6&63)<<jr[i++&3],o[i>>>2]|=(128|n&63)<<jr[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};pn.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var r=this.blocks,e=this.lastByteIndex;r[16]=this.block,r[e>>>2]|=s$[e&3],this.block=r[16],e>=56&&(this.hashed||this.hash(),r[0]=this.block,r[16]=r[1]=r[2]=r[3]=r[4]=r[5]=r[6]=r[7]=r[8]=r[9]=r[10]=r[11]=r[12]=r[13]=r[14]=r[15]=0),r[14]=this.hBytes<<3|this.bytes>>>29,r[15]=this.bytes<<3,this.hash()}};pn.prototype.hash=function(){var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,u=this.blocks,c,l,f,p,d,h,m,g,y,b,w;for(c=16;c<64;++c)d=u[c-15],l=(d>>>7|d<<25)^(d>>>18|d<<14)^d>>>3,d=u[c-2],f=(d>>>17|d<<15)^(d>>>19|d<<13)^d>>>10,u[c]=u[c-16]+l+u[c-7]+f<<0;for(w=e&t,c=0;c<64;c+=4)this.first?(this.is224?(g=300032,d=u[0]-1413257819,o=d-150054599<<0,n=d+24177077<<0):(g=704751109,d=u[0]-210244248,o=d-1521486534<<0,n=d+143694565<<0),this.first=!1):(l=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),f=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),g=r&e,p=g^r&t^w,m=s&i^~s&a,d=o+f+m+Ip[c]+u[c],h=l+p,o=n+d<<0,n=d+h<<0),l=(n>>>2|n<<30)^(n>>>13|n<<19)^(n>>>22|n<<10),f=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),y=n&r,p=y^n&e^g,m=a&o^~a&s,d=i+f+m+Ip[c+1]+u[c+1],h=l+p,a=t+d<<0,t=d+h<<0,l=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),f=(a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7),b=t&n,p=b^t&r^y,m=i&a^~i&o,d=s+f+m+Ip[c+2]+u[c+2],h=l+p,i=e+d<<0,e=d+h<<0,l=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),f=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),w=e&t,p=w^e&n^b,m=i&a^~i&o,d=s+f+m+Ip[c+3]+u[c+3],h=l+p,s=r+d<<0,r=d+h<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+r<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+n<<0,this.h4=this.h4+s<<0,this.h5=this.h5+i<<0,this.h6=this.h6+a<<0,this.h7=this.h7+o<<0};pn.prototype.hex=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,u=D[r>>>28&15]+D[r>>>24&15]+D[r>>>20&15]+D[r>>>16&15]+D[r>>>12&15]+D[r>>>8&15]+D[r>>>4&15]+D[r&15]+D[e>>>28&15]+D[e>>>24&15]+D[e>>>20&15]+D[e>>>16&15]+D[e>>>12&15]+D[e>>>8&15]+D[e>>>4&15]+D[e&15]+D[t>>>28&15]+D[t>>>24&15]+D[t>>>20&15]+D[t>>>16&15]+D[t>>>12&15]+D[t>>>8&15]+D[t>>>4&15]+D[t&15]+D[n>>>28&15]+D[n>>>24&15]+D[n>>>20&15]+D[n>>>16&15]+D[n>>>12&15]+D[n>>>8&15]+D[n>>>4&15]+D[n&15]+D[s>>>28&15]+D[s>>>24&15]+D[s>>>20&15]+D[s>>>16&15]+D[s>>>12&15]+D[s>>>8&15]+D[s>>>4&15]+D[s&15]+D[i>>>28&15]+D[i>>>24&15]+D[i>>>20&15]+D[i>>>16&15]+D[i>>>12&15]+D[i>>>8&15]+D[i>>>4&15]+D[i&15]+D[a>>>28&15]+D[a>>>24&15]+D[a>>>20&15]+D[a>>>16&15]+D[a>>>12&15]+D[a>>>8&15]+D[a>>>4&15]+D[a&15];return this.is224||(u+=D[o>>>28&15]+D[o>>>24&15]+D[o>>>20&15]+D[o>>>16&15]+D[o>>>12&15]+D[o>>>8&15]+D[o>>>4&15]+D[o&15]),u};pn.prototype.toString=pn.prototype.hex;pn.prototype.digest=function(){this.finalize();var r=this.h0,e=this.h1,t=this.h2,n=this.h3,s=this.h4,i=this.h5,a=this.h6,o=this.h7,u=[r>>>24&255,r>>>16&255,r>>>8&255,r&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255];return this.is224||u.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),u};pn.prototype.array=pn.prototype.digest;pn.prototype.arrayBuffer=function(){this.finalize();var r=new ArrayBuffer(this.is224?28:32),e=new DataView(r);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),r};Dn();var a$=(...r)=>fb(r.join("_"));var pb=class{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:a$})}makeDefaultKeyEncoder(e){this.keyEncoder=e}},o$=new Map,Tp=class r extends pb{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new r(o$)}};ki();Es();Dm();Ar();Wn();st();eo();Ar();ho();Dn();eo();var YA=yr(JA(),1);var x$=Object.defineProperty,A$=(r,e,t)=>e in r?x$(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,E$=(r,e,t)=>(A$(r,typeof e!="symbol"?e+"":e,t),t);function O$(r,e){let t=Array.from({length:r.length},(n,s)=>({start:s,end:s+1}));for(;t.length>1;){let n=null;for(let s=0;s<t.length-1;s++){let i=r.slice(t[s].start,t[s+1].end),a=e.get(i.join(","));a!=null&&(n==null||a<n[0])&&(n=[a,s])}if(n!=null){let s=n[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function P$(r,e){return r.length===1?[e.get(r.join(","))]:O$(r,e).map(t=>e.get(r.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function S$(r){return r.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var hb=class{constructor(r,e){kn(this,"specialTokens");kn(this,"inverseSpecialTokens");kn(this,"patStr");kn(this,"textEncoder",new TextEncoder);kn(this,"textDecoder",new TextDecoder("utf-8"));kn(this,"rankMap",new Map);kn(this,"textMap",new Map);this.patStr=r.pat_str;let t=r.bpe_ranks.split(`
`).filter(Boolean).reduce((n,s)=>{let[i,a,...o]=s.split(" "),u=Number.parseInt(a,10);return o.forEach((c,l)=>n[c]=u+l),n},{});for(let[n,s]of Object.entries(t)){let i=YA.default.toByteArray(n);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...r.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((n,[s,i])=>(n[i]=this.textEncoder.encode(s),n),{})}encode(r,e=[],t="all"){let n=new RegExp(this.patStr,"ug"),s=hb.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(c=>!a.has(c)):t);if(o.size>0){let c=hb.specialTokenRegex([...o]),l=r.match(c);if(l!=null)throw new Error(`The text contains a special token that is not allowed: ${l[0]}`)}let u=0;for(;;){let c=null,l=u;for(;s.lastIndex=l,c=s.exec(r),!(c==null||a.has(c[0]));)l=c.index+1;let f=c?.index??r.length;for(let d of r.substring(u,f).matchAll(n)){let h=this.textEncoder.encode(d[0]),m=this.rankMap.get(h.join(","));if(m!=null){i.push(m);continue}i.push(...P$(h,this.rankMap))}if(c==null)break;let p=this.specialTokens[c[0]];i.push(p),u=c.index+c[0].length}return i}decode(r){let e=[],t=0;for(let i=0;i<r.length;++i){let a=r[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),t+=o.length)}let n=new Uint8Array(t),s=0;for(let i of e)n.set(i,s),s+=i.length;return this.textDecoder.decode(n)}},Cp=hb;E$(Cp,"specialTokenRegex",r=>new RegExp(r.map(e=>S$(e)).join("|"),"g"));function mb(r){switch(r){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}eo();var Rp={},I$=new Vn({});async function T$(r){return r in Rp||(Rp[r]=I$.fetch(`https://tiktoken.pages.dev/js/${r}.json`).then(e=>e.json()).then(e=>new Cp(e)).catch(e=>{throw delete Rp[r],e})),await Rp[r]}async function XA(r){return T$(mb(r))}st();var C$=r=>r.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":r.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":r.startsWith("gpt-4-32k")?"gpt-4-32k":r.startsWith("gpt-4-")?"gpt-4":r.startsWith("gpt-4o")?"gpt-4o":r;function QA(r){return typeof r!="object"||!r?!1:!!("type"in r&&r.type==="function"&&"function"in r&&typeof r.function=="object"&&r.function&&"name"in r.function&&"parameters"in r.function)}var R$=()=>!1,Tc=class extends W{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??R$(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},kc=class extends Tc{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){let{cache:s,...i}=n;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof s=="object"?this.cache=s:s?this.cache=Tp.global():this.cache=void 0,this.caller=new Vn(n??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(s=>typeof s=="string"?s:s.type==="text"&&"text"in s?s.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await XA("modelName"in this?C$(this.modelName):"gpt2")}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(s){console.warn("Failed to calculate number of tokens, falling back to approximate count",s)}return n}static _convertInputToPromptValue(e){return typeof e=="string"?new fo(e):Array.isArray(e)?new po(e.map(Dt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(n).filter(([a,o])=>o!==void 0).map(([a,o])=>`${a}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};Wn();Os();Es();st();Sr();Sr();st();sn();var dr=class extends W{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let n=fe(t);return this.func&&await this.func(e,n),this._callWithConfig(s=>Promise.resolve(s),e,n)}async*transform(e,t){let n=fe(t),s,i=!0;for await(let a of this._transformStreamWithConfig(e,o=>o,n))if(yield a,i)if(s===void 0)s=a;else try{s=Un(s,a)}catch{s=void 0,i=!1}this.func&&s!==void 0&&await this.func(s,n)}static assign(e){return new lo(new Rs({steps:e}))}};Zn();ki();ks();function gb(r){let e=[];for(let t of r){let n=t;if(Array.isArray(t.content))for(let s=0;s<t.content.length;s++){let i=t.content[s];(Kx(i)||Hx(i))&&n===t&&(n=new t.constructor({...n,content:[...t.content.slice(0,s),Wx(i),...t.content.slice(s+1)]}))}e.push(n)}return e}var Cc=class r extends kc{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){let n=r._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===r.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{let s=r._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...i.metadata,...this.getLsParams(a)},u=await We.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this?.invocationParams(a),batch_size:1},l=await u?.handleChatModelStart(this.toJSON(),[gb(s)],i.runId,void 0,c,void 0,void 0,i.runName),f,p;try{for await(let d of this._streamResponseChunks(s,a,l?.[0])){if(d.message.id==null){let h=l?.at(0)?.runId;h!=null&&d.message._updateId(`run-${h}`)}d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,f?f=f.concat(d):f=d,Nm(d.message)&&d.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:d.message.usage_metadata.input_tokens,completionTokens:d.message.usage_metadata.output_tokens,totalTokens:d.message.usage_metadata.total_tokens}})}}catch(d){throw await Promise.all((l??[]).map(h=>h?.handleLLMError(d))),d}await Promise.all((l??[]).map(d=>d?.handleLLMEnd({generations:[[f]],llmOutput:p})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n,s){let i=e.map(f=>f.map(Dt)),a;if(s!==void 0&&s.length===i.length)a=s;else{let f={...n.metadata,...this.getLsParams(t)},p=await We.configure(n.callbacks,this.callbacks,n.tags,this.tags,f,this.metadata,{verbose:this.verbose}),d={options:t,invocation_params:this?.invocationParams(t),batch_size:1};a=await p?.handleChatModelStart(this.toJSON(),i.map(gb),n.runId,void 0,d,void 0,void 0,n.runName)}let o=[],u=[];if(!!a?.[0].handlers.find(Em)&&!this.disableStreaming&&i.length===1&&this._streamResponseChunks!==r.prototype._streamResponseChunks)try{let f=await this._streamResponseChunks(i[0],t,a?.[0]),p,d;for await(let h of f){if(h.message.id==null){let m=a?.at(0)?.runId;m!=null&&h.message._updateId(`run-${m}`)}p===void 0?p=h:p=Un(p,h),Nm(h.message)&&h.message.usage_metadata!==void 0&&(d={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}if(p===void 0)throw new Error("Received empty response from chat model call.");o.push([p]),await a?.[0].handleLLMEnd({generations:o,llmOutput:d})}catch(f){throw await a?.[0].handleLLMError(f),f}else{let f=await Promise.allSettled(i.map((p,d)=>this._generate(p,{...t,promptIndex:d},a?.[d])));await Promise.all(f.map(async(p,d)=>{if(p.status==="fulfilled"){let h=p.value;for(let m of h.generations){if(m.message.id==null){let g=a?.at(0)?.runId;g!=null&&m.message._updateId(`run-${g}`)}m.message.response_metadata={...m.generationInfo,...m.message.response_metadata}}return h.generations.length===1&&(h.generations[0].message.response_metadata={...h.llmOutput,...h.generations[0].message.response_metadata}),o[d]=h.generations,u[d]=h.llmOutput,a?.[d]?.handleLLMEnd({generations:[h.generations],llmOutput:h.llmOutput})}else return await a?.[d]?.handleLLMError(p.reason),Promise.reject(p.reason)}))}let l={generations:o,llmOutput:u.length?this._combineLLMOutput?.(...u):void 0};return Object.defineProperty(l,qf,{value:a?{runIds:a?.map(f=>f.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:s,handledOptions:i}){let a=e.map(g=>g.map(Dt)),o={...i.metadata,...this.getLsParams(s)},u=await We.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this?.invocationParams(s),batch_size:1},l=await u?.handleChatModelStart(this.toJSON(),a.map(gb),i.runId,void 0,c,void 0,void 0,i.runName),f=[],d=(await Promise.allSettled(a.map(async(g,y)=>{let b=r._convertInputToPromptValue(g).toString(),w=await t.lookup(b,n);return w==null&&f.push(y),w}))).map((g,y)=>({result:g,runManager:l?.[y]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),h=[];await Promise.all(d.map(async({result:g,runManager:y},b)=>{if(g.status==="fulfilled"){let w=g.value;return h[b]=w.map(x=>("message"in x&&Ue(x.message)&&Ri(x.message)&&(x.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),x.generationInfo={...x.generationInfo,tokenUsage:{}},x)),w.length&&await y?.handleLLMNewToken(w[0].text),y?.handleLLMEnd({generations:[w]},void 0,void 0,void 0,{cached:!0})}else return await y?.handleLLMError(g.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(g.reason)}));let m={generations:h,missingPromptIndices:f,startedRunManagers:l};return Object.defineProperty(m,qf,{value:l?{runIds:l?.map(g=>g.runId)}:void 0,configurable:!0}),m}async generate(e,t,n){let s;Array.isArray(t)?s={stop:t}:s=t;let i=e.map(h=>h.map(Dt)),[a,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(a.callbacks=a.callbacks??n,!this.cache)return this._generateUncached(i,o,a);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:f,startedRunManagers:p}=await this._generateCached({messages:i,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:a}),d={};if(f.length>0){let h=await this._generateUncached(f.map(m=>i[m]),o,a,p!==void 0?f.map(m=>p?.[m]):void 0);await Promise.all(h.generations.map(async(m,g)=>{let y=f[g];l[y]=m;let b=r._convertInputToPromptValue(i[y]).toString();return u.update(b,c,m)})),d=h.llmOutput??{}}return{generations:l,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){let s=e.map(i=>i.toChatMessages());return this.generate(s,t,n)}async call(e,t,n){return(await this.generate([e.map(Dt)],t,n)).generations[0][0].message}async callPrompt(e,t,n){let s=e.toChatMessages();return this.call(s,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){let s=new ht(e),i=await this.call([s],t,n);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');let n=e,s=t?.name,i=fc(n)??"A function available to call.",a=t?.method,o=t?.includeRaw;if(a==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=s??"extract",c;Fi(n)?c=[{type:"function",function:{name:u,description:i,parameters:qn(n)}}]:("name"in n&&(u=n.name),c=[{type:"function",function:{name:u,description:i,parameters:n}}]);let l=this.bindTools(c),f=fn.from(m=>{if(!m.tool_calls||m.tool_calls.length===0)throw new Error("No tool calls found in the response.");let g=m.tool_calls.find(y=>y.name===u);if(!g)throw new Error(`No tool call found with name ${u}.`);return g.args});if(!o)return l.pipe(f).withConfig({runName:"StructuredOutput"});let p=dr.assign({parsed:(m,g)=>f.invoke(m.raw,g)}),d=dr.assign({parsed:()=>null}),h=p.withFallbacks({fallbacks:[d]});return gt.from([{raw:l},h]).withConfig({runName:"StructuredOutputRunnable"})}};Wn();Os();Es();Sr();ki();Ar();Wn();st();sn();st();sn();st();sn();Sr();Wn();st();Wu();var bb=class extends W{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(n,s)=>this.parseResult([{text:n}],s?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(n,s)=>this.parseResult([{message:n,text:this._baseMessageToString(n)}],s?.callbacks),e,{...t,runType:"parser"})}},Zi=class extends bb{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}},Ms=class extends Error{constructor(e,t,n,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=s,s&&(n===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");_s(this,"OUTPUT_PARSING_FAILURE")}};lc();or();Dn();Os();var xo=class extends Zi{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},qi=class extends xo{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(let s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Wa(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Bn({message:s,text:s.content})}else if(Ue(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");i=new Bn({message:jm(s),text:s.content})}else i=new Tr({text:s});n===void 0?n=i:n=n.concat(i);let a=await this.parsePartialResult([n]);a!=null&&!Gn(a,t)&&(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}};Ll();Zn();ks();var Rc=class extends Zi{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Se.object(Object.fromEntries(Object.entries(e).map(([n,s])=>[n,Se.string().describe(s)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(qn(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.trim(),s=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(i,a)=>`"${a.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await co(this.schema,JSON.parse(s))}catch(t){throw new Ms(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};gh();km();var Nc=class extends qi{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?tf(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Tm(e[0].text)}async parse(e){return Tm(e,JSON.parse)}getFormatInstructions(){return""}};Os();ho();Es();st();sn();Ar();Ll();lc();Es();sn();Ya();Di();jf();Zn();ks();st();Zn();function yb(r){return r!==void 0&&Array.isArray(r.lc_namespace)}function _b(r){return r!==void 0&&W.isRunnable(r)&&"lc_name"in r.constructor&&typeof r.constructor.lc_name=="function"&&r.constructor.lc_name()==="RunnableToolLike"}function wb(r){return!!r&&typeof r=="object"&&"name"in r&&"schema"in r&&(Fi(r.schema)||r.schema!=null&&typeof r.schema=="object"&&"type"in r.schema&&typeof r.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(r.schema.type))}function $c(r){return wb(r)||_b(r)||yb(r)}var Np=class extends Tc{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let n,s=fe(nt(this.defaultConfig,t));return ws(e)?(n=e.args,s={...s,toolCall:e}):n=e,this.call(n,s)}async call(e,t,n){let s=ws(e)?e.args:e,i;if(Fi(this.schema))try{i=await co(this.schema,s)}catch(h){let m="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(m=`${m}
Details: ${h.message}`),new Ci(m,JSON.stringify(e))}else{let h=Ae(s,this.schema);if(!h.valid){let m="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(m=`${m}
Details: ${h.errors.map(g=>`${g.keywordLocation}: ${g.error}`).join(`
`)}`),new Ci(m,JSON.stringify(e))}i=s}let a=Zm(t),u=await We.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose})?.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName);delete a.runId;let c;try{c=await this._call(i,u,a)}catch(h){throw await u?.handleToolError(h),h}let l,f;if(this.responseFormat==="content_and_artifact")if(Array.isArray(c)&&c.length===2)[l,f]=c;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(c)}`);else l=c;let p;ws(e)&&(p=e.id),!p&&qx(a)&&(p=a.toolCall.id);let d=B$({content:l,artifact:f,toolCallId:p,name:this.name,metadata:this.metadata});return await u?.handleToolEnd(d),d}},$p=class extends Np{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Se.object({input:Se.string().optional()}).transform(t=>t.input)})}call(e,t){let n=typeof e=="string"||e==null?{input:e}:e;return super.call(n,t)}};function B$(r){let{content:e,artifact:t,toolCallId:n,metadata:s}=r;return n&&!Qx(e)?typeof e=="string"||Array.isArray(e)&&e.every(i=>typeof i=="object")?new Ln({status:"success",content:e,artifact:t,tool_call_id:n,name:r.name,metadata:s}):new Ln({status:"success",content:V$(e),artifact:t,tool_call_id:n,name:r.name,metadata:s}):e}function V$(r){try{return JSON.stringify(r,null,2)??""}catch{return`${r}`}}Er();Im();Uf();Dn();nn();Er();Wm();Er();Uf();eo();nn();ks();function vb(r,e){let t=typeof e=="number"?void 0:e;return{name:r.name,description:r.description,parameters:qn(r.schema),...t?.strict!==void 0?{strict:t.strict}:{}}}ks();Sr();Wn();Os();st();Er();ks();Ar();Zn();wm();nn();function jp(r){if(typeof r!="object"||r===null)return r;let e=Array.isArray(r)?[]:{};for(let t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=jp(r[t]));return e}function jc(){return{v:1,id:Sp(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function Yn(r){return{v:r.v,id:r.id,ts:r.ts,channel_values:{...r.channel_values},channel_versions:{...r.channel_versions},versions_seen:jp(r.versions_seen),pending_sends:[...r.pending_sends]}}function xb(r,e){return typeof r=="number"&&typeof e=="number"?Math.sign(r-e):String(r).localeCompare(String(e))}function Ab(...r){return r.reduce((e,t,n)=>n===0?t:xb(e,t)>=0?e:t)}var Mp={[GA]:-1,[vo]:-2,[ZA]:-3,[qA]:-4};var Ki=class extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}};function oj(r){if(r.length===0)throw new Ki("Namespace cannot be empty.");for(let e of r){if(typeof e!="string")throw new Ki(`Invalid namespace label '${e}' found in ${r}. Namespace labels must be strings, but got ${typeof e}.`);if(e.includes("."))throw new Ki(`Invalid namespace label '${e}' found in ${r}. Namespace labels cannot contain periods ('.').`);if(e==="")throw new Ki(`Namespace labels cannot be empty strings. Got ${e} in ${r}`)}if(r[0]==="langgraph")throw new Ki(`Root label for namespace cannot be "langgraph". Got: ${r}`)}var Ao=class{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t={}){let{filter:n,limit:s=10,offset:i=0,query:a}=t;return(await this.batch([{namespacePrefix:e,filter:n,limit:s,offset:i,query:a}]))[0]}async put(e,t,n,s){oj(e),await this.batch([{namespace:e,key:t,value:n,index:s}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e={}){let{prefix:t,suffix:n,maxDepth:s,limit:i=100,offset:a=0}=e,o=[];return t&&o.push({matchType:"prefix",path:t}),n&&o.push({matchType:"suffix",path:n}),(await this.batch([{matchConditions:o.length?o:void 0,maxDepth:s,limit:i,offset:a}]))[0]}start(){}stop(){}};var uj=r=>"lg_name"in r&&r.lg_name==="AsyncBatchedStore"?r.store:r,Mc=class extends Ao{constructor(e){super(),Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"AsyncBatchedStore"}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=uj(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){let{filter:n,limit:s=10,offset:i=0,query:a}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:n,limit:s,offset:i,query:a})}async put(e,t,n){return this.enqueueOperation({namespace:e,key:t,value:n})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((t,n)=>{let s=this.nextKey;this.nextKey+=1,this.queue.set(s,{operation:e,resolve:t,reject:n})})}async processBatchQueue(){for(;this.running;){if(await new Promise(t=>{setTimeout(t,0)}),this.queue.size===0)continue;let e=new Map(this.queue);this.queue.clear();try{let t=Array.from(e.values()).map(({operation:s})=>s),n=await this.store.batch(t);e.forEach(({resolve:s},i)=>{let a=Array.from(e.keys()).indexOf(i);s(n[a])})}catch(t){e.forEach(({reject:n})=>{n(t)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}};function Hi(r){return r!=null&&r.lg_is_channel===!0}var hr=class{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}};function zs(r,e){let t=Object.fromEntries(Object.entries(r).filter(([,s])=>Hi(s))),n={};for(let s in t)if(Object.prototype.hasOwnProperty.call(t,s)){let i=e.channel_values[s];n[s]=t[s].fromCheckpoint(i)}return n}function Mr(r,e,t){let n;if(e===void 0)n=r.channel_values;else{n={};for(let s of Object.keys(e))try{n[s]=e[s].checkpoint()}catch(i){if(i.name!==Oe.unminifiable_name)throw i}}return{v:1,id:Sp(t),ts:new Date().toISOString(),channel_values:n,channel_versions:{...r.channel_versions},versions_seen:jp(r.versions_seen),pending_sends:r.pending_sends??[]}}var Xn=class r extends hr{constructor(e,t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=e,this.initialValueFactory=t,this.value=t?.()}fromCheckpoint(e){let t=new r(this.operator,this.initialValueFactory);return typeof e<"u"&&(t.value=e),t}update(e){let t=e;if(!t.length)return!1;this.value===void 0&&([this.value]=t,t=t.slice(1));for(let n of t)this.value!==void 0&&(this.value=this.operator(this.value,n));return!0}get(){if(this.value===void 0)throw new Oe;return this.value}checkpoint(){if(this.value===void 0)throw new Oe;return this.value}};var hn=class r extends hr{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]})}fromCheckpoint(e){let t=new r;return typeof e<"u"&&(t.value=[e]),t}update(e){if(e.length===0)return!1;if(e.length!==1)throw new he("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[e[e.length-1]],!0}get(){if(this.value.length===0)throw new Oe;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Oe;return this.value[0]}};var me="__start__",te="__end__",zr="__input__",eE="__copy__",qe="__error__",Qn="__pregel_send",Lc="__pregel_call",Lr="__pregel_read",je="__pregel_checkpointer",mn="__pregel_resuming",Wi="__pregel_task_id",Eo="__pregel_stream",lj="__pregel_resume_value",Dr="__pregel_scratchpad",Oo="__pregel_previous",fj="checkpoint_id",zp="checkpoint_ns",tE="__pregel_node_finished",kt="checkpoint_map",Eb="__pregel_abort_signals",ye="__interrupt__",bt="__resume__",Dc="__no_writes__",es="__return__",Ji="__previous__",Yi="__pregel_runtime_placeholder__";var ge="langsmith:hidden",rE="langsmith:nostream",Ob="__self__",ts="__pregel_tasks",Ct="__pregel_push",Fc="__pregel_pull";var yt="00000000-0000-0000-0000-000000000000",nE=[ge,zr,ye,bt,qe,Dc,ts,Qn,Lr,je,Eo,mn,Wi,Lc,lj,Dr,Oo,kt,zp,fj],De="|",mr=":";function Lp(r){let e=r;return e!=null&&typeof e.node=="string"&&e.args!==void 0}var Ls=class{constructor(e,t){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Send"}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.node=e,this.args=zc(t)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function Xe(r){return r instanceof Ls}var it=class{constructor(e){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Command"}),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"graph",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resume",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"goto",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?zc(e.goto):[zc(e.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){let e;return typeof this.goto=="string"?e=this.goto:Xe(this.goto)?e=this.goto.toJSON():e=this.goto?.map(t=>typeof t=="string"?t:t.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}};Object.defineProperty(it,"PARENT",{enumerable:!0,configurable:!0,writable:!0,value:"__parent__"});function at(r){return typeof r!="object"||r==null?!1:"lg_name"in r&&r.lg_name==="Command"}function zc(r,e=new Map){if(r!=null&&typeof r=="object"){if(e.has(r))return e.get(r);let t;if(Array.isArray(r))t=[],e.set(r,t),r.forEach((n,s)=>{t[s]=zc(n,e)});else if(at(r)&&!(r instanceof it))t=new it(r),e.set(r,t);else if(Lp(r)&&!(r instanceof Ls))t=new Ls(r.node,r.args),e.set(r,t);else if(at(r)||Xe(r))t=r,e.set(r,t);else if("lc_serializable"in r&&r.lc_serializable)t=r,e.set(r,t);else{t={},e.set(r,t);for(let[n,s]of Object.entries(r))t[n]=zc(s,e)}return t}return r}var Dp=class{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw new Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}};var Pb="__channel_key_placeholder__",Fp=class extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(n=>!n.runtime)){if(typeof t=="object"&&!Array.isArray(t))for(let[n,s]of Object.entries(t))for(let[i,a]of this.entries())a.runtime&&a.call(e)===s&&(t[n]={[Yi]:i});else if(typeof t=="object"&&"constructor"in t)for(let n of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let s=t[n];for(let[i,a]of this.entries())a.runtime&&a.call(e)===s&&(t[n]={[Yi]:i})}catch(s){if(s.name!==TypeError.name)throw s}}}replaceRuntimePlaceholders(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(n=>!n.runtime)){if(typeof t=="object"&&!Array.isArray(t)){for(let[n,s]of Object.entries(t))if(typeof s=="object"&&s!==null&&Yi in s){let i=s[Yi];typeof i=="string"&&(t[n]=this.get(i)?.call(e))}}else if(typeof t=="object"&&"constructor"in t)for(let n of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let s=t[n];if(typeof s=="object"&&s!==null&&Yi in s){let i=this.get(s[Yi]);i&&(t[n]=i.call(e))}}catch(s){if(s.name!==TypeError.name)throw s}}}};function Xi(r){return!!(typeof r=="object"&&r&&"cls"in r&&"params"in r)}var Up=class r extends Dp{call(){}static async initialize(e,t){return Promise.resolve(new r(e))}};var Bp=class{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}},Po=function(r){return Xi(r)?r:r?Vp(r):new hn};Po.Root=r=>new Bp(r);function Vp(r){return typeof r=="object"&&r&&"reducer"in r&&r.reducer?new Xn(r.reducer,r.default):typeof r=="object"&&r&&"value"in r&&r.value?new Xn(r.value,r.default):new hn}Zg();un();vr();Di();var pj=["tags","metadata","callbacks","configurable"],dj=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interruptBefore","interruptAfter","signal"],hj=25;function Gp(...r){let e={tags:[],metadata:{},callbacks:void 0,recursionLimit:hj,configurable:{}},t=Ce.getRunnableConfig();if(t!==void 0){for(let[n,s]of Object.entries(t))if(s!==void 0)if(pj.includes(n)){let i;Array.isArray(s)?i=[...s]:typeof s=="object"?n==="callbacks"&&"copy"in s&&typeof s.copy=="function"?i=s.copy():i={...s}:i=s,e[n]=i}else e[n]=s}for(let n of r)if(n!==void 0)for(let[s,i]of Object.entries(n))i!==void 0&&dj.includes(s)&&(e[s]=i);for(let[n,s]of Object.entries(e.configurable))e.metadata=e.metadata??{},!n.startsWith("__")&&(typeof s=="string"||typeof s=="number"||typeof s=="boolean")&&!(n in e.metadata)&&(e.metadata[n]=s);return e}function Zp(r){return r.split(De).filter(e=>!e.match(/^\d+$/)).map(e=>e.split(mr)[0]).join(De)}function sE(r){let e=r.split(De);for(;e.length>1&&e[e.length-1].match(/^\d+$/);)e.pop();return e.slice(0,-1).join(De)}var Qe=class extends W{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,n){return new Promise((s,i)=>{let a=be(t,{callbacks:n?.getChild()});Ce.runWithConfig(a,async()=>{try{let o=await this.func(e,a);s(o)}catch(o){i(o)}})})}async invoke(e,t){let n,s=Gp(t),i=nt(this.config,s);return this.trace?n=await this._callWithConfig(this._tracedInvoke,e,i):n=await Ce.runWithConfig(i,async()=>this.func(e,i)),W.isRunnable(n)&&this.recurse?await Ce.runWithConfig(i,async()=>n.invoke(e,i)):n}};function*rs(r,e){if(e===void 0)yield*r;else for(let t of r)yield[e,t]}async function Fr(r){let e=[];for await(let t of await r)e.push(t);return e}function Qi(r){let e=[];for(let t of r)e.push(t);return e}function So(r,e){return r?"configurable"in r?{...r,configurable:{...r.configurable,...e}}:{...r,configurable:e}:{configurable:e}}function iE(r){return r!=null&&typeof r=="function"&&r instanceof Object.getPrototypeOf(async function*(){}).constructor}function aE(r){return r!=null&&typeof r=="function"&&r instanceof Object.getPrototypeOf(function*(){}).constructor}var g5={[Symbol.for("LG_SKIP_WRITE")]:!0};function mj(r){return typeof r=="object"&&r?.[Symbol.for("LG_SKIP_WRITE")]!==void 0}var Ut={[Symbol.for("LG_PASSTHROUGH")]:!0};function qp(r){return typeof r=="object"&&r?.[Symbol.for("LG_PASSTHROUGH")]!==void 0}var Sb=Symbol("IS_WRITER"),Pe=class r extends Qe{constructor(e,t){let n=`ChannelWrite<${e.map(s=>Xe(s)?s.node:"channel"in s?s.channel:"...").join(",")}>`;super({writes:e,name:n,tags:t,func:async(s,i)=>this._write(s,i??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=e}async _write(e,t){let n=this.writes.map(s=>Ib(s)&&qp(s.value)?{mapper:s.mapper,value:e}:Kp(s)&&qp(s.value)?{channel:s.channel,value:e,skipNone:s.skipNone,mapper:s.mapper}:s);return await r.doWrite(t,n),e}static async doWrite(e,t){for(let i of t){if(Kp(i)){if(i.channel===ts)throw new he("Cannot write to the reserved channel TASKS");if(qp(i.value))throw new he("PASSTHROUGH value must be replaced")}if(Ib(i)&&qp(i.value))throw new he("PASSTHROUGH value must be replaced")}let n=[];for(let i of t)if(Xe(i))n.push([ts,i]);else if(Ib(i)){let a=await i.mapper.invoke(i.value,e);a!=null&&a.length>0&&n.push(...a)}else if(Kp(i)){let a=i.mapper!==void 0?await i.mapper.invoke(i.value,e):i.value;if(mj(a)||i.skipNone&&a===void 0)continue;n.push([i.channel,a])}else throw new Error(`Invalid write entry: ${JSON.stringify(i)}`);let s=e.configurable?.[Qn];s(n)}static isWriter(e){return e instanceof r||Sb in e&&!!e[Sb]}static registerWriter(e){return Object.defineProperty(e,Sb,{value:!0})}};function Kp(r){return r!==void 0&&typeof r.channel=="string"}function Ib(r){return r!==void 0&&!Kp(r)&&W.isRunnable(r.mapper)}var Hp=class r extends Qe{constructor(e,t,n=!1){super({func:(s,i)=>r.doRead(i,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=n,this.mapper=t,this.channel=e,this.name=Array.isArray(e)?`ChannelRead<${e.join(",")}>`:`ChannelRead<${e}>`}static doRead(e,t,n,s){let i=e.configurable?.[Lr];if(!i)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return s?s(i(t,n)):i(t,n)}},Io=new dr,Kt=class r extends cr{constructor(e){let{channels:t,triggers:n,mapper:s,writers:i,bound:a,kwargs:o,metadata:u,retryPolicy:c,tags:l,subgraphs:f,ends:p}=e,d=[...e.config?.tags?e.config.tags:[],...l??[]];super({...e,bound:e.bound??Io,config:{...e.config?e.config:{},tags:d}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:Io}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=t,this.triggers=n,this.mapper=s,this.writers=i??this.writers,this.bound=a??this.bound,this.kwargs=o??this.kwargs,this.metadata=u??this.metadata,this.tags=d,this.retryPolicy=c,this.subgraphs=f,this.ends=p}getWriters(){let e=[...this.writers];for(;e.length>1&&e[e.length-1]instanceof Pe&&e[e.length-2]instanceof Pe;){let t=e.slice(-2),n=t[0].writes.concat(t[1].writes);e[e.length-2]=new Pe(n,t[0].config?.tags),e.pop()}return e}getNode(){let e=this.getWriters();if(!(this.bound===Io&&e.length===0))return this.bound===Io&&e.length===1?e[0]:this.bound===Io?new gt({first:e[0],middle:e.slice(1,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):e.length>0?new gt({first:this.bound,middle:e.slice(0,e.length-1),last:e[e.length-1],omitSequenceTags:!0}):this.bound}join(e){if(!Array.isArray(e))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new r({channels:{...this.channels,...Object.fromEntries(e.map(t=>[t,t]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(e){return Pe.isWriter(e)?new r({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,e],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):this.bound===Io?new r({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:Ze(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):new r({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(e),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}};var Ur=class extends Error{constructor(e){super(e),this.name="GraphValidationError"}};function oE({nodes:r,channels:e,inputChannels:t,outputChannels:n,streamChannels:s,interruptAfterNodes:i,interruptBeforeNodes:a}){if(!e)throw new Ur("Channels not provided");let o=new Set,u=new Set;for(let[c,l]of Object.entries(r)){if(c===ye)throw new Ur(`"Node name ${ye} is reserved"`);if(l.constructor===Kt)l.triggers.forEach(f=>o.add(f));else throw new Ur(`Invalid node type ${typeof l}, expected PregelNode`)}for(let c of o)if(!(c in e))throw new Ur(`Subcribed channel '${String(c)}' not in channels`);if(Array.isArray(t)){if(t.every(c=>!o.has(c)))throw new Ur(`None of the input channels ${t} are subscribed to by any node`)}else if(!o.has(t))throw new Ur(`Input channel ${String(t)} is not subscribed to by any node`);Array.isArray(n)?n.forEach(c=>u.add(c)):u.add(n),s&&!Array.isArray(s)?u.add(s):Array.isArray(s)&&s.forEach(c=>u.add(c));for(let c of u)if(!(c in e))throw new Ur(`Output channel '${String(c)}' not in channels`);if(i&&i!=="*"){for(let c of i)if(!(c in r))throw new Ur(`Node ${String(c)} not in nodes`)}if(a&&a!=="*"){for(let c of a)if(!(c in r))throw new Ur(`Node ${String(c)} not in nodes`)}}function Tb(r,e){if(Array.isArray(r)){for(let t of r)if(!(t in e))throw new Error(`Key ${String(t)} not found in channels`)}else if(!(r in e))throw new Error(`Key ${String(r)} not found in channels`)}vr();function Ds(r,e,t=!0,n=!1){try{return r[e].get()}catch(s){if(s.name===Oe.unminifiable_name){if(n)return s;if(t)return null}throw s}}function Br(r,e,t=!0){if(Array.isArray(e)){let n={};for(let s of e)try{n[s]=Ds(r,s,!t)}catch(i){if(i.name===Oe.unminifiable_name)continue}return n}else return Ds(r,e)}function*uE(r,e){if(r.graph===it.PARENT)throw new he("There is no parent graph.");if(r.goto){let t;Array.isArray(r.goto)?t=r.goto:t=[r.goto];for(let n of t)if(Xe(n))yield[yt,ts,n];else if(typeof n=="string")yield[yt,`branch:to:${n}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof n}`)}if(r.resume)if(typeof r.resume=="object"&&Object.keys(r.resume).length&&Object.keys(r.resume).every(Gt))for(let[t,n]of Object.entries(r.resume)){let s=e.filter(i=>i[0]===t&&i[1]===bt).map(i=>i[2]).slice(0,1)??[];s.push(n),yield[t,bt,s]}else yield[yt,bt,r.resume];if(r.update){if(typeof r.update!="object"||!r.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(r.update))for(let[t,n]of r.update)yield[yt,t,n];else for(let[t,n]of Object.entries(r.update))yield[yt,t,n]}}function*Wp(r,e){if(e!=null)if(Array.isArray(r)&&typeof e=="object"&&!Array.isArray(e))for(let t in e)r.includes(t)&&(yield[t,e[t]]);else{if(Array.isArray(r))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[r,e]}}function*Jp(r,e,t){Array.isArray(r)?(e===!0||e.find(([n,s])=>r.includes(n)))&&(yield Br(t,r)):(e===!0||e.some(([n,s])=>n===r))&&(yield Ds(t,r))}function*kb(r,e,t){let n=e.filter(([o,u])=>(o.config===void 0||!o.config.tags?.includes(ge))&&u[0][0]!==qe&&u[0][0]!==ye);if(!n.length)return;let s;n.some(([o])=>o.writes.some(([u,c])=>u===es))?s=n.flatMap(([o])=>o.writes.filter(([u,c])=>u===es).map(([u,c])=>[o.name,c])):Array.isArray(r)?s=n.flatMap(([o])=>{let{writes:u}=o,c={};for(let[l]of u)r.includes(l)&&(c[l]=(c[l]||0)+1);return Object.values(c).some(l=>l>1)?u.filter(([l])=>r.includes(l)).map(([l,f])=>[o.name,{[l]:f}]):[[o.name,Object.fromEntries(u.filter(([l])=>r.includes(l)))]]}):s=n.flatMap(([o])=>o.writes.filter(([u,c])=>u===r).map(([u,c])=>[o.name,c]));let i={};for(let[o,u]of s)o in i||(i[o]=[]),i[o].push(u);let a={};for(let o in i)if(i[o].length===1){let[u]=i[o];a[o]=u}else a[o]=i[o];t&&(a.__metadata__={cached:t}),yield a}function gj(r){return"steps"in r&&Array.isArray(r.steps)}function Uc(r){return"lg_is_pregel"in r&&r.lg_is_pregel===!0}function Yp(r){let e=[r];for(let t of e){if(Uc(t))return t;gj(t)&&e.push(...t.steps)}}var Bc={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Vc=(r,e)=>`${r.start}${e}${r.end}`;function*Cb(r,e){let t=new Date().toISOString();for(let{id:n,name:s,input:i,config:a,triggers:o,writes:u}of e){if(a?.tags?.includes(ge))continue;let c=u.filter(([l,f])=>l===n&&f===ye).map(([,l])=>l);yield{type:"task",timestamp:t,step:r,payload:{id:n,name:s,input:i,triggers:o,interrupts:c}}}}function*cE(r,e,t){let n=new Date().toISOString();for(let[{id:s,name:i,config:a},o]of e)a?.tags?.includes(ge)||(yield{type:"task_result",timestamp:n,step:r,payload:{id:s,name:i,result:o.filter(([u])=>Array.isArray(t)?t.includes(u):u===t),interrupts:o.filter(u=>u[0]===ye).map(u=>u[1])}})}function*lE(r,e,t,n,s,i,a,o){function u(p){let d={};return p.callbacks!=null&&(d.callbacks=p.callbacks),p.configurable!=null&&(d.configurable=p.configurable),p.maxConcurrency!=null&&(d.max_concurrency=p.maxConcurrency),p.metadata!=null&&(d.metadata=p.metadata),p.recursionLimit!=null&&(d.recursion_limit=p.recursionLimit),p.runId!=null&&(d.run_id=p.runId),p.runName!=null&&(d.run_name=p.runName),p.tags!=null&&(d.tags=p.tags),d}let c=e.configurable?.checkpoint_ns,l={};for(let p of i){if(!(p.subgraphs?.length?p.subgraphs:[p.proc]).find(Yp))continue;let h=`${p.name}:${p.id}`;c&&(h=`${c}|${h}`),l[p.id]={configurable:{thread_id:e.configurable?.thread_id,checkpoint_ns:h}}}yield{type:"checkpoint",timestamp:new Date().toISOString(),step:r,payload:{config:u(e),values:Br(t,n),metadata:s,next:i.map(p=>p.name),tasks:Rb(i,a,l),parentConfig:o?u(o):void 0}}}function Rb(r,e,t){return r.map(n=>{let s=e.find(([o,u])=>o===n.id&&u===qe)?.[2],i=e.filter(([o,u])=>o===n.id&&u===ye).map(([,,o])=>o);if(s)return{id:n.id,name:n.name,path:n.path,error:s,interrupts:i};let a=t?.[n.id];return{id:n.id,name:n.name,path:n.path,interrupts:i,...a!==void 0?{state:a}:{}}})}function fE(r,e,t){console.log([`${Vc(Bc.blue,`[${r}:checkpoint]`)}`,`\x1B[1m State at the end of step ${r}:\x1B[0m
`,JSON.stringify(Br(e,t),null,2)].join(""))}function Xp(r,e){let t=e.length;console.log([`${Vc(Bc.blue,`[${r}:tasks]`)}`,`\x1B[1m Starting step ${r} with ${t} task${t===1?"":"s"}:\x1B[0m
`,e.map(n=>`- ${Vc(Bc.green,String(n.name))} -> ${JSON.stringify(n.input,null,2)}`).join(`
`)].join(""))}function pE(r,e,t){let n={};for(let[s,i]of e)t.includes(s)&&(n[s]||(n[s]=[]),n[s].push(i));console.log([`${Vc(Bc.blue,`[${r}:writes]`)}`,`\x1B[1m Finished step ${r} with writes to ${Object.keys(n).length} channel${Object.keys(n).length!==1?"s":""}:\x1B[0m
`,Object.entries(n).map(([s,i])=>`- ${Vc(Bc.yellow,s)} -> ${i.map(a=>JSON.stringify(a)).join(", ")}`).join(`
`)].join(""))}var Qp=class{constructor({func:e,name:t,input:n,retry:s,callbacks:i}){Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__lg_type",{enumerable:!0,configurable:!0,writable:!0,value:"call"}),this.func=e,this.name=t,this.input=n,this.retry=s,this.callbacks=i}};function dE(r){return typeof r=="object"&&r!==null&&"__lg_type"in r&&r.__lg_type==="call"}function Nb(r){let e=Object.values(r),t=e.length>0?typeof e[0]:void 0,n;return t==="number"?n=0:t==="string"&&(n=""),n}function Gc(r,e){if(Object.keys(r).length>0){let t=Nb(e);return Object.fromEntries(Object.entries(e).filter(([n,s])=>s>(r[n]??t)))}else return e}function hE(r,e){return r&&!Array.isArray(r)&&!(r instanceof Date)&&typeof r=="object"?r:{[e]:r}}function Vr(r,e){return r===null?{configurable:e}:r?.configurable===void 0?{...r,configurable:e}:{...r,configurable:{...r.configurable,...e}}}function ea(r,e){let t=e?.parents??{};return Object.keys(t).length>0?Vr(r,{[kt]:{...t,[r.configurable?.checkpoint_ns??""]:r.configurable?.checkpoint_id}}):r}function Fs(...r){if(r.length===1)return r[0];let e=new AbortController,t=()=>{e.abort(),r.forEach(n=>n.removeEventListener("abort",t))};return r.forEach(n=>n.addEventListener("abort",t)),r.some(n=>n.aborted)&&e.abort(),e.signal}function mE(r,e){let t=new Qe({func:n=>e(...n),name:r,trace:!1,recurse:!1});return new gt({name:r,first:t,last:new Pe([{channel:es,value:Ut}],[ge])})}function gE(r,e){return new Qe({func:(n,s)=>e(n,s),name:r,trace:!1,recurse:!1})}var bE=r=>r!==void 0?r+1:1;function qc(r,e,t){let n=Object.values(r.channel_versions),s=n.length>0?typeof n[0]:void 0,i;s==="number"?i=0:s==="string"&&(i="");let a=r.versions_seen[ye]??{},o=Object.entries(r.channel_versions).some(([c,l])=>l>(a[c]??i)),u=t.some(c=>e==="*"?!c.config?.tags?.includes(ge):e.includes(c.name));return o&&u}function Zc(r,e,t,n,s,i,a=!1){let o=[],u=new Set;if(Array.isArray(i))o=i.filter(l=>n.get(l)),i=i.filter(l=>!n.get(l)),u=new Set(i.filter(l=>s.writes.some(([f,p])=>f===l)));else{for(let[l]of s.writes)if(l===i){u=new Set([l]);break}u=u||new Set}let c;if(a&&u.size>0){let l=Object.fromEntries(Object.entries(t).filter(([d,h])=>u.has(d))),f=Mr(e,l,-1),p=zs(l,f);Rt(Yn(f),p,[s]),c=Br({...t,...p},i)}else c=Br(t,i);if(o.length>0)for(let l of o){let f=n.get(l);if(f){let p=f.call(r);c[l]=p}}return c}function $b(r,e,t,n,s){for(let[i,a]of s)if([Ct,ts].includes(i)&&a!=null){if(!Xe(a))throw new he(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(a)}`);if(!(a.node in t))throw new he(`Invalid node name "${a.node}" in Send packet`);n.replaceRuntimeValues(r,a.args)}e(s)}var bj=new Set([Dc,Ct,bt,ye,es,qe]);function Rt(r,e,t,n){t.sort((f,p)=>{let d=f.path?.slice(0,3)||[],h=p.path?.slice(0,3)||[];for(let m=0;m<Math.min(d.length,h.length);m+=1){if(d[m]<h[m])return-1;if(d[m]>h[m])return 1}return d.length-h.length});let s=t.some(f=>f.triggers.length>0),i=Object.fromEntries(Object.entries(e).filter(([f,p])=>Hi(p)));for(let f of t){r.versions_seen[f.name]===void 0&&(r.versions_seen[f.name]={});for(let p of f.triggers)p in r.channel_versions&&(r.versions_seen[f.name][p]=r.channel_versions[p])}let a;Object.keys(r.channel_versions).length>0&&(a=Ab(...Object.values(r.channel_versions)));let o=new Set(t.flatMap(f=>f.triggers).filter(f=>!nE.includes(f)));for(let f of o)f in i&&i[f].consume()&&n!==void 0&&(r.channel_versions[f]=n(a,i[f]));r.pending_sends?.length&&s&&(r.pending_sends=[]);let u={},c={};for(let f of t)for(let[p,d]of f.writes)bj.has(p)||(p===ts?r.pending_sends.push({node:d.node,args:d.args}):p in i?p in u?u[p].push(d):u[p]=[d]:p in c?c[p].push(d):c[p]=[d]);a=void 0,Object.keys(r.channel_versions).length>0&&(a=Ab(...Object.values(r.channel_versions)));let l=new Set;for(let[f,p]of Object.entries(u))if(f in i){let d;try{d=i[f].update(p)}catch(h){if(h.name===he.unminifiable_name){let m=new he(`Invalid update for channel "${f}" with values ${JSON.stringify(p)}: ${h.message}`);throw m.lc_error_code=h.lc_error_code,m}else throw h}d&&n!==void 0&&(r.channel_versions[f]=n(a,i[f])),l.add(f)}if(s)for(let f of Object.keys(i))l.has(f)||i[f].update([])&&n!==void 0&&(r.channel_versions[f]=n(a,i[f]));return c}function ta(r,e,t,n,s,i,a,o){let u={};for(let c=0;c<r.pending_sends.length;c+=1){let l=ed([Ct,c],r,e,t,n,s,i,a,o);l!==void 0&&(u[l.id]=l)}for(let c of Object.keys(t)){let l=ed([Fc,c],r,e,t,n,s,i,a,o);l!==void 0&&(u[l.id]=l)}return u}function ed(r,e,t,n,s,i,a,o,u){let{step:c,checkpointer:l,manager:f}=u,p=a.configurable??{},d=p.checkpoint_ns??"";if(r[0]===Ct&&dE(r[r.length-1])){let h=r[r.length-1],m=mE(h.name,h.func),g=[Ct],y=d===""?h.name:`${d}${De}${h.name}`,b=js(JSON.stringify([y,c.toString(),h.name,Ct,r[1],r[2]]),e.id),w=`${y}${mr}${b}`,x={langgraph_step:c,langgraph_node:h.name,langgraph_triggers:g,langgraph_path:r.slice(0,3),langgraph_checkpoint_ns:w};if(o){let A=[];return{name:h.name,input:h.input,proc:m,writes:A,config:be(nt(a,{metadata:x,store:u.store??a.store}),{runName:h.name,callbacks:f?.getChild(`graph:step:${c}`),configurable:{[Wi]:b,[Qn]:M=>$b(c,N=>A.push(...N),n,i,M),[Lr]:(M,N=!1)=>Zc(c,e,s,i,{name:h.name,writes:A,triggers:g,path:r.slice(0,3)},M,N),[je]:l??p[je],[kt]:{...p[kt],[d]:e.id},[Dr]:jb({pendingWrites:t??[],taskId:b,currentTaskInput:h.input}),[Oo]:e.channel_values[Ji],checkpoint_id:void 0,checkpoint_ns:w}}),triggers:g,retry_policy:h.retry,id:b,path:r.slice(0,3),writers:[]}}else return{id:b,name:h.name,interrupts:[],path:r.slice(0,3)}}else if(r[0]===Ct){let h=typeof r[1]=="number"?r[1]:parseInt(r[1],10);if(h>=e.pending_sends.length)return;let m=Lp(e.pending_sends[h])&&!Xe(e.pending_sends[h])?new Ls(e.pending_sends[h].node,e.pending_sends[h].args):e.pending_sends[h];if(!Lp(m)){console.warn(`Ignoring invalid packet ${JSON.stringify(m)} in pending sends.`);return}if(!(m.node in n)){console.warn(`Ignoring unknown node name ${m.node} in pending sends.`);return}let g=[Ct],y=d===""?m.node:`${d}${De}${m.node}`,b=js(JSON.stringify([y,c.toString(),m.node,Ct,h.toString()]),e.id),w=`${y}${mr}${b}`,x={langgraph_step:c,langgraph_node:m.node,langgraph_triggers:g,langgraph_path:r.slice(0,3),langgraph_checkpoint_ns:w};if(o){let A=n[m.node],P=A.getNode();if(P!==void 0){i.replaceRuntimePlaceholders(c,m.args),A.metadata!==void 0&&(x={...x,...A.metadata});let M=[];return{name:m.node,input:m.args,proc:P,subgraphs:A.subgraphs,writes:M,config:be(nt(a,{metadata:x,tags:A.tags,store:u.store??a.store}),{runName:m.node,callbacks:f?.getChild(`graph:step:${c}`),configurable:{[Wi]:b,[Qn]:N=>$b(c,I=>M.push(...I),n,i,N),[Lr]:(N,I=!1)=>Zc(c,e,s,i,{name:m.node,writes:M,triggers:g,path:r},N,I),[je]:l??p[je],[kt]:{...p[kt],[d]:e.id},[Dr]:jb({pendingWrites:t??[],taskId:b,currentTaskInput:m.args}),[Oo]:e.channel_values[Ji],checkpoint_id:void 0,checkpoint_ns:w}}),triggers:g,retry_policy:A.retryPolicy,id:b,path:r,writers:A.getWriters()}}}else return{id:b,name:m.node,interrupts:[],path:r}}else if(r[0]===Fc){let h=r[1].toString(),m=n[h];if(m===void 0)return;if(t?.length){let w=d===""?h:`${d}${De}${h}`,x=js(JSON.stringify([w,c.toString(),h,Fc,h]),e.id);if(t.some(P=>P[0]===x&&P[1]!==qe))return}let g=Nb(e.channel_versions);if(g===void 0)return;let y=e.versions_seen[h]??{},b=m.triggers.filter(w=>{let x=Ds(s,w,!1,!0);return!(x instanceof Error&&x.name===Oe.unminifiable_name)&&(e.channel_versions[w]??g)>(y[w]??g)}).sort();if(b.length>0){let w=yj(c,m,i,s,o);if(w===void 0)return;let x=d===""?h:`${d}${De}${h}`,A=js(JSON.stringify([x,c.toString(),h,Fc,b]),e.id),P=`${x}${mr}${A}`,M={langgraph_step:c,langgraph_node:h,langgraph_triggers:b,langgraph_path:r,langgraph_checkpoint_ns:P};if(o){let N=m.getNode();if(N!==void 0){m.metadata!==void 0&&(M={...M,...m.metadata});let I=[];return{name:h,input:w,proc:N,subgraphs:m.subgraphs,writes:I,config:be(nt(a,{metadata:M,tags:m.tags,store:u.store??a.store}),{runName:h,callbacks:f?.getChild(`graph:step:${c}`),configurable:{[Wi]:A,[Qn]:S=>$b(c,C=>{I.push(...C)},n,i,S),[Lr]:(S,C=!1)=>Zc(c,e,s,i,{name:h,writes:I,triggers:b,path:r},S,C),[je]:l??p[je],[kt]:{...p[kt],[d]:e.id},[Dr]:jb({pendingWrites:t??[],taskId:A,currentTaskInput:w}),[Oo]:e.channel_values[Ji],checkpoint_id:void 0,checkpoint_ns:P}}),triggers:b,retry_policy:m.retryPolicy,id:A,path:r,writers:m.getWriters()}}}else return{id:A,name:h,interrupts:[],path:r}}}}function yj(r,e,t,n,s){let i;if(typeof e.channels=="object"&&!Array.isArray(e.channels)){i={};for(let[a,o]of Object.entries(e.channels))if(e.triggers.includes(o))try{i[a]=Ds(n,o,!1)}catch(u){if(u.name===Oe.unminifiable_name)return;throw u}else if(o in n)try{i[a]=Ds(n,o,!1)}catch(u){if(u.name===Oe.unminifiable_name)continue;throw u}else i[a]=t.get(a)?.call(r)}else if(Array.isArray(e.channels)){let a=!1;for(let o of e.channels)try{i=Ds(n,o,!1),a=!0;break}catch(u){if(u.name===Oe.unminifiable_name)continue;throw u}if(!a)return}else throw new Error(`Invalid channels type, expected list or dict, got ${e.channels}`);return s&&e.mapper!==void 0&&(i=e.mapper(i)),i}function jb({pendingWrites:r,taskId:e,currentTaskInput:t}){let n=r.find(([i,a])=>i===yt&&a===bt)?.[2],s={callCounter:0,interruptCounter:-1,resume:r.filter(([i,a])=>i===e&&a===bt).flatMap(([i,a,o])=>o),nullResume:n,subgraphCounter:0,currentTaskInput:t,consumeNullResume:()=>{if(s.nullResume)return delete s.nullResume,r.splice(r.findIndex(([i,a])=>i===yt&&a===bt),1),n}};return s}Sr();var Kc=class extends Be{constructor(e,t){let n=e.getReader(),s=t??new AbortController;super({start(i){return a();function a(){return n.read().then(({done:o,value:u})=>{if(o){i.close();return}return i.enqueue(u),a()})}}}),Object.defineProperty(this,"_abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._abortController=s,this._reader=n}async cancel(e){this._abortController.abort(e),this._reader.releaseLock()}get signal(){return this._abortController.signal}},To=class extends Be{get closed(){return this._closed}constructor(e){let t,n=new Promise(s=>{t=s});super({start:s=>{t(s)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),n.then(s=>{this.controller=s}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}};var td=Symbol.for("INPUT_DONE"),Mb=Symbol.for("INPUT_RESUMING"),_j=25;function wj(...r){return new To({passthroughFn:e=>{for(let t of r)t.modes.has(e[1])&&t.push(e)},modes:new Set(r.flatMap(e=>Array.from(e.modes)))})}var rd=class r{get isResuming(){let e=Object.keys(this.checkpoint.channel_versions).length!==0,n=this.config.configurable?.[mn]!==void 0&&this.config.configurable?.[mn],s=this.input===null||this.input===void 0,i=at(this.input)&&this.input.resume!=null,a=this.input===Mb;return e&&(n||s||i||a)}constructor(e){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"toInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.input=e.input,this.checkpointer=e.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=bE,this.checkpoint=e.checkpoint,this.checkpointMetadata=e.checkpointMetadata,this.checkpointPreviousVersions=e.checkpointPreviousVersions,this.channels=e.channels,this.managed=e.managed,this.checkpointPendingWrites=e.checkpointPendingWrites,this.step=e.step,this.stop=e.stop,this.config=e.config,this.checkpointConfig=e.checkpointConfig,this.isNested=e.isNested,this.manager=e.manager,this.outputKeys=e.outputKeys,this.streamKeys=e.streamKeys,this.nodes=e.nodes,this.skipDoneTasks=e.skipDoneTasks,this.store=e.store,this.stream=e.stream,this.checkpointNamespace=e.checkpointNamespace,this.prevCheckpointConfig=e.prevCheckpointConfig,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.debug=e.debug}static async initialize(e){let{config:t,stream:n}=e;n!==void 0&&t.configurable?.[Eo]!==void 0&&(n=wj(n,t.configurable[Eo]));let s=t.configurable?!("checkpoint_id"in t.configurable):!0,i=t.configurable?.[Dr];t.configurable&&i&&(i.subgraphCounter>0&&(t=Vr(t,{[zp]:[t.configurable[zp],i.subgraphCounter.toString()].join(De)})),i.subgraphCounter+=1);let a=Lr in(t.configurable??{});!a&&t.configurable?.checkpoint_ns!==void 0&&t.configurable?.checkpoint_ns!==""&&(t=Vr(t,{checkpoint_ns:"",checkpoint_id:void 0}));let o=t;t.configurable?.[kt]!==void 0&&t.configurable?.[kt]?.[t.configurable?.checkpoint_ns]&&(o=Vr(t,{checkpoint_id:t.configurable[kt][t.configurable?.checkpoint_ns]}));let u=t.configurable?.checkpoint_ns?.split(De)??[],c=await e.checkpointer?.getTuple(o)??{config:t,checkpoint:jc(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};o={...t,...c.config,configurable:{checkpoint_ns:"",...t.configurable,...c.config.configurable}};let l=c.parentConfig,f=Yn(c.checkpoint),p={...c.metadata},d=c.pendingWrites??[],h=zs(e.channelSpecs,f),m=(p.step??0)+1,g=m+(t.recursionLimit??_j)+1,y={...f.channel_versions},b=e.store?new Mc(e.store):void 0;return b&&b.start(),new r({input:e.input,config:t,checkpointer:e.checkpointer,checkpoint:f,checkpointMetadata:p,checkpointConfig:o,prevCheckpointConfig:l,checkpointNamespace:u,channels:h,managed:e.managed,isNested:a,manager:e.manager,skipDoneTasks:s,step:m,stop:g,checkpointPreviousVersions:y,checkpointPendingWrites:d,outputKeys:e.outputKeys??[],streamKeys:e.streamKeys??[],nodes:e.nodes,stream:n,store:b,interruptAfter:e.interruptAfter,interruptBefore:e.interruptBefore,debug:e.debug})}_checkpointerPutAfterPrevious(e){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>this.checkpointer?.put(e.config,e.checkpoint,e.metadata,e.newVersions)),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(e,t){let n=this.managed.get(e);n&&"update"in n&&typeof n.update=="function"&&await n.update(t)}putWrites(e,t){let n=t;if(n.length===0)return;n.every(([i])=>i in Mp)&&(n=Array.from(new Map(n.map(i=>[i[0],i])).values()));for(let[i,a]of n){let o=this.checkpointPendingWrites.findIndex(u=>u[0]===e&&u[1]===i);i in Mp&&o!==-1?this.checkpointPendingWrites[o]=[e,i,a]:this.checkpointPendingWrites.push([e,i,a])}let s=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},n,e);s!==void 0&&this.checkpointerPromises.push(s),this.tasks&&this._outputWrites(e,n)}_outputWrites(e,t,n=!1){let s=this.tasks[e];if(s!==void 0){if(s.config!==void 0&&(s.config.tags??[]).includes(ge))return;t.length>0&&t[0][0]!==qe&&t[0][0]!==ye&&this._emit(Qi(rs(kb(this.outputKeys,[[s,t]],n),"updates"))),n||this._emit(Qi(rs(cE(this.step,[[s,t]],this.streamKeys),"debug")))}}async tick(e){this.store&&!this.store.isRunning&&this.store?.start();let{inputKeys:t=[]}=e;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![td,Mb].includes(this.input))await this._first(t);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new $s;if(Object.values(this.tasks).every(i=>i.writes.length>0)){let i=Object.values(this.tasks).flatMap(u=>u.writes),a=Rt(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(let[u,c]of Object.entries(a))await this.updateManagedValues(u,c);let o=await Fr(rs(Jp(this.outputKeys,i,this.channels),"values"));if(this._emit(o),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:kb(this.outputKeys,Object.values(this.tasks).map(u=>[u,u.writes])).next().value??null}),qc(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new $s;this.config.configurable?.[mn]!==void 0&&delete this.config.configurable?.[mn]}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;let n=ta(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream});if(this.tasks=n,this.checkpointer&&this._emit(await Fr(rs(lE(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(let[i,a,o]of this.checkpointPendingWrites){if(a===qe||a===ye||a===bt)continue;let u=Object.values(this.tasks).find(c=>c.id===i);u&&u.writes.push([a,o])}for(let i of Object.values(this.tasks))i.writes.length>0&&this._outputWrites(i.id,i.writes,!0)}if(Object.values(this.tasks).every(i=>i.writes.length>0))return this.tick({inputKeys:t});if(qc(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new $s;let s=await Fr(rs(Cb(this.step,Object.values(this.tasks)),"debug"));return this._emit(s),!0}async finishAndHandleError(e){let t=this._suppressInterrupt(e);if((t||e===void 0)&&(this.output=Br(this.channels,this.outputKeys)),t){if(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(n=>n.writes.length>0)){let n=Rt(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(let[s,i]of Object.entries(n))await this.updateManagedValues(s,i);this._emit(Qi(rs(Jp(this.outputKeys,Object.values(this.tasks).flatMap(s=>s.writes),this.channels),"values")))}this._emit([["updates",{[ye]:e.interrupts}]])}return t}acceptPush(e,t,n){if(this.interruptAfter?.length>0&&qc(this.checkpoint,this.interruptAfter,[e])){this.toInterrupt.push(e);return}let s=ed([Ct,e.path??[],t,e.id,n],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,e.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(s){if(this.interruptBefore?.length>0&&qc(this.checkpoint,this.interruptBefore,[s])){this.toInterrupt.push(s);return}return this._emit(Qi(rs(Cb(this.step,[s]),"debug"))),this.debug&&Xp(this.step,[s]),this.tasks[s.id]=s,this.skipDoneTasks&&this._matchWrites({[s.id]:s}),s}}_suppressInterrupt(e){return Vi(e)&&!this.isNested}async _first(e){let{configurable:t}=this.config,n=t?.[Dr];if(n&&n.nullResume!==void 0&&this.putWrites(yt,[[bt,n.nullResume]]),at(this.input)){if(this.input.resume!=null&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");let o={};for(let[u,c,l]of uE(this.input,this.checkpointPendingWrites))o[u]===void 0&&(o[u]=[]),o[u].push([c,l]);if(Object.keys(o).length===0)throw new Ic("Received empty Command input");for(let[u,c]of Object.entries(o))this.putWrites(u,c)}let s=(this.checkpointPendingWrites??[]).filter(a=>a[0]===yt).map(a=>a.slice(1));s.length>0&&Rt(this.checkpoint,this.channels,[{name:zr,writes:s,triggers:[]}],this.checkpointerGetNextVersion);let i=at(this.input)&&s.length>0;if(this.isResuming||i){for(let o of Object.keys(this.channels))if(this.checkpoint.channel_versions[o]!==void 0){let u=this.checkpoint.channel_versions[o];this.checkpoint.versions_seen[ye]={...this.checkpoint.versions_seen[ye],[o]:u}}let a=await Fr(rs(Jp(this.outputKeys,!0,this.channels),"values"));this._emit(a)}if(this.isResuming)this.input=Mb;else if(i)await this._putCheckpoint({source:"input",writes:{}}),this.input=td;else{let a=await Fr(Wp(e,this.input));if(a.length>0){let o=ta(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});Rt(this.checkpoint,this.channels,Object.values(o).concat([{name:zr,writes:a,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(a)}),this.input=td}else if(mn in(this.config.configurable??{}))this.input=td;else throw new Ic(`Received no input writes for ${JSON.stringify(e,null,2)}`)}this.isNested||(this.config=Vr(this.config,{[mn]:this.isResuming}))}_emit(e){for(let t of e)this.stream.modes.has(t[0])&&this.stream.push([this.checkpointNamespace,...t])}async _putCheckpoint(e){let t={...e,step:this.step,parents:this.config.configurable?.[kt]??{}};if(this.checkpointer!==void 0){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=t,this.checkpoint=Mr(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};let n={...this.checkpoint.channel_versions},s=Gc(this.checkpointPreviousVersions,n);this.checkpointPreviousVersions=n,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:Yn(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:s}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}_matchWrites(e){for(let[t,n,s]of this.checkpointPendingWrites){if(n===qe||n===ye||n===bt)continue;let i=Object.values(e).find(a=>a.id===t);i&&i.writes.push([n,s])}for(let t of Object.values(e))t.writes.length>0&&this._outputWrites(t.id,t.writes,!0)}};ki();Wn();function vj(r){return Ue(r?.message)}var nd=class extends zn{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stableMessageIdMap",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.streamFn=e}_emit(e,t,n,s=!1){var a;if(s&&t.id!==void 0&&this.seen[t.id]!==void 0)return;let i=t.id;n!=null&&(Rm(t)?i??(i=`run-${n}-tool-${t.tool_call_id}`):((i==null||i===`run-${n}`)&&(i=this.stableMessageIdMap[n]??i??`run-${n}`),(a=this.stableMessageIdMap)[n]??(a[n]=i))),i!==t.id&&(t.id=i,t.lc_kwargs.id=i),t.id!=null&&(this.seen[t.id]=t),this.streamFn([e[0],"messages",[t,e[1]]])}handleChatModelStart(e,t,n,s,i,a,o,u){o&&(!a||!a.includes(rE)&&!a.includes("nostream"))&&(this.metadatas[n]=[o.langgraph_checkpoint_ns.split("|"),{tags:a,name:u,...o}])}handleLLMNewToken(e,t,n,s,i,a){let o=a?.chunk;this.emittedChatModelRunIds[n]=!0,this.metadatas[n]!==void 0&&(vj(o)?this._emit(this.metadatas[n],o.message,n):this._emit(this.metadatas[n],new St({content:e}),n))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){let n=e.generations?.[0]?.[0];Ue(n?.message)&&this._emit(this.metadatas[t],n?.message,t,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t],delete this.stableMessageIdMap[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,n,s,i,a,o,u){if(a!==void 0&&u===a.langgraph_node&&(i===void 0||!i.includes(ge))&&(this.metadatas[n]=[a.langgraph_checkpoint_ns.split("|"),{tags:i,name:u,...a}],typeof t=="object")){for(let c of Object.values(t))if((Ue(c)||Wa(c))&&c.id!==void 0)this.seen[c.id]=c;else if(Array.isArray(c))for(let l of c)(Ue(l)||Wa(l))&&l.id!==void 0&&(this.seen[l.id]=l)}}handleChainEnd(e,t){let n=this.metadatas[t];if(delete this.metadatas[t],n!==void 0){if(Ue(e))this._emit(n,e,t,!0);else if(Array.isArray(e))for(let s of e)Ue(s)&&this._emit(n,s,t,!0);else if(e!=null&&typeof e=="object"){for(let s of Object.values(e))if(Ue(s))this._emit(n,s,t,!0);else if(Array.isArray(s))for(let i of s)Ue(i)&&this._emit(n,i,t,!0)}}}handleChainError(e,t){delete this.metadatas[t]}};var xj=500,Aj=2,Ej=128e3,Oj=3,Pj=[400,401,402,403,404,405,406,407,409],Sj=r=>{if(r.message.startsWith("Cancel")||r.message.startsWith("AbortError")||r.name==="AbortError"||r?.code==="ECONNABORTED")return!1;let e=r?.response?.status??r?.status;return!(e&&Pj.includes(+e)||r?.error?.code==="insufficient_quota")};async function zb(r,e,t,n){let s=r.retry_policy??e,i=s!==void 0?s.initialInterval??xj:0,a=0,o,u,{config:c}=r;for(t&&(c=Vr(c,t)),c={...c,signal:n};!n?.aborted;){r.writes.splice(0,r.writes.length),o=void 0;try{u=await r.proc.invoke(r.input,c);break}catch(l){if(o=l,o.pregelTaskId=r.id,VA(o)){let h=c?.configurable?.checkpoint_ns,m=o.command;if(m.graph===h){for(let g of r.writers)await g.invoke(m,c);o=void 0;break}else if(m.graph===it.PARENT){let g=sE(h);o.command=new it({...o.command,graph:g})}}if(wo(o)||s===void 0||(a+=1,a>=(s.maxAttempts??Oj))||!(s.retryOn??Sj)(o))break;i=Math.min(s.maxInterval??Ej,i*(s.backoffFactor??Aj));let p=s.jitter?Math.floor(i+Math.random()*1e3):i;await new Promise(h=>setTimeout(h,p));let d=o.name??o.constructor.unminifiable_name??o.constructor.name;(s?.logWarning??!0)&&console.log(`Retrying task "${String(r.name)}" after ${i.toFixed(2)}ms (attempt ${a}) after ${d}: ${o}`),c=Vr(c,{[mn]:!0})}}return{task:r,result:u,error:o,signalAborted:n?.aborted}}var Lb=Symbol.for("promiseAdded");function Ij(){let r={next:()=>{},wait:Promise.resolve(Lb)};function e(t){r.next=()=>{r.wait=new Promise(e),t(Lb)}}return r.wait=new Promise(e),r}var sd=class{constructor({loop:e,nodeFinished:t}){Object.defineProperty(this,"nodeFinished",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loop=e,this.nodeFinished=t}async tick(e={}){let{timeout:t,retryPolicy:n,onStepWrite:s,maxConcurrency:i}=e,a=new Set,o,u=new AbortController,c=Object.values(this.loop.tasks).filter(p=>p.writes.length===0),l=this._initializeAbortSignals({exceptionSignalController:u,timeout:t,signal:e.signal}),f=this._executeTasksWithRetry(c,{signals:l,retryPolicy:n,maxConcurrency:i});for await(let{task:p,error:d,signalAborted:h}of f)this._commit(p,d),Vi(d)||wo(d)&&!Vi(o)?o=d:d&&(a.size===0||!h)&&(u.abort(),a.add(d));if(s?.(this.loop.step,Object.values(this.loop.tasks).map(p=>p.writes).flat()),a.size===1)throw Array.from(a)[0];if(a.size>1)throw new AggregateError(Array.from(a),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(Vi(o)||wo(o)&&this.loop.isNested)throw o}_initializeAbortSignals({exceptionSignalController:e,timeout:t,signal:n}){let s=this.loop.config.configurable?.[Eb]??{},a=n&&s.composedAbortSignal&&n!==s.composedAbortSignal?Fs(s.externalAbortSignal,n):s.externalAbortSignal??n,o=s.errorAbortSignal?Fs(s.errorAbortSignal,e.signal):e.signal,u=t?AbortSignal.timeout(t):void 0,c=Fs(...a?[a]:[],...u?[u]:[],o),l={externalAbortSignal:a,errorAbortSignal:o,timeoutAbortSignal:u,composedAbortSignal:c};return this.loop.config=Vr(this.loop.config,{[Eb]:l}),l}async*_executeTasksWithRetry(e,t){let{retryPolicy:n,maxConcurrency:s,signals:i}=t??{},a=Ij(),o={},u={executingTasksMap:o,barrier:a,retryPolicy:n,scheduleTask:async(d,h,m)=>this.loop.acceptPush(d,h,m)};if(i?.composedAbortSignal?.aborted)throw new Error("Abort");let c=0,l,f=i?.externalAbortSignal||i?.timeoutAbortSignal?Fs(...i.externalAbortSignal?[i.externalAbortSignal]:[],...i.timeoutAbortSignal?[i.timeoutAbortSignal]:[]):void 0,p=f?new Promise((d,h)=>{l=()=>h(new Error("Abort")),f.addEventListener("abort",l,{once:!0})}):void 0;for(;(c===0||Object.keys(o).length>0)&&e.length;){for(;Object.values(o).length<(s??e.length)&&c<e.length;c+=1){let h=e[c];o[h.id]=zb(h,n,{[Lc]:yE?.bind(u,this,h)},i?.composedAbortSignal).catch(m=>({task:h,error:m,signalAborted:i?.composedAbortSignal?.aborted}))}let d=await Promise.race([...Object.values(o),...p?[p]:[],a.wait]);d!==Lb&&(yield d,delete o[d.task.id])}}_commit(e,t){if(t!==void 0)if(Vi(t)){if(t.interrupts.length){let n=t.interrupts.map(i=>[ye,i]),s=e.writes.filter(i=>i[0]===bt);s.length&&n.push(...s),this.loop.putWrites(e.id,n)}}else wo(t)&&e.writes.length?this.loop.putWrites(e.id,e.writes):this.loop.putWrites(e.id,[[qe,{message:t.message,name:t.name}]]);else this.nodeFinished&&(e.config?.tags==null||!e.config.tags.includes(ge))&&this.nodeFinished(String(e.name)),e.writes.length===0&&e.writes.push([Dc,null]),this.loop.putWrites(e.id,e.writes)}};async function yE(r,e,t,n,s,i={}){let a=e.config?.configurable?.[Dr];if(!a)throw new Error(`BUG: No scratchpad found on task ${e.name}__${e.id}`);let o=a.callCounter;a.callCounter+=1;let u=new Qp({func:t,name:n,input:s,retry:i.retry,callbacks:i.callbacks}),c=await this.scheduleTask(e,o,u);if(!c)return;let l=this.executingTasksMap[c.id];if(l!==void 0)return l;if(c.writes.length>0){let f=c.writes.filter(([d])=>d===es),p=c.writes.filter(([d])=>d===qe);if(f.length>0){if(f.length===1)return Promise.resolve(f[0][1]);throw new Error(`BUG: multiple returns found for task ${c.name}__${c.id}`)}if(p.length>0){if(p.length===1){let d=p[0][1],h=d instanceof Error?d:new Error(String(d));return Promise.reject(h)}throw new Error(`BUG: multiple errors found for task ${c.name}__${c.id}`)}return}else{let f=zb(c,i.retry,{[Lc]:yE.bind(this,r,c)});return this.executingTasksMap[c.id]=f,this.barrier.next(),f.then(({result:p,error:d})=>d?Promise.reject(d):p)}}function Tj(r){return typeof r=="string"}var id=class{static subscribeTo(e,t){let{key:n,tags:s}={key:void 0,tags:void 0,...t??{}};if(Array.isArray(e)&&n!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let i;Tj(e)?n?i={[n]:e}:i=[e]:i=Object.fromEntries(e.map(o=>[o,o]));let a=Array.isArray(e)?e:[e];return new Kt({channels:i,triggers:a,tags:s})}static writeTo(e,t){let n=[];for(let s of e)n.push({channel:s,value:Ut,skipNone:!1});for(let[s,i]of Object.entries(t??{}))W.isRunnable(i)||typeof i=="function"?n.push({channel:s,value:Ut,skipNone:!0,mapper:Ze(i)}):n.push({channel:s,value:i,skipNone:!1});return new Pe(n)}},ko=class extends W{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;t!=null&&!Array.isArray(t)&&(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.name=e.name,this.autoValidate&&this.validate()}withConfig(e){let t=nt(this.config,e);return new this.constructor({...this,config:t})}validate(){return oE({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(let[n,s]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(n))continue;let i=s.subgraphs?.length?s.subgraphs:[s.bound];for(let a of i){let o=Yp(a);if(o!==void 0){if(n===e){yield[n,o];return}if(e===void 0&&(yield[n,o]),t){let u=e;e!==void 0&&(u=e.slice(n.length+1));for(let[c,l]of o.getSubgraphs(u,t))yield[`${n}${De}${c}`,l]}}}}}async*getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:n,applyPendingWrites:s=!1}){if(t===void 0)return{values:{},next:[],config:e,tasks:[]};let{managed:i}=await this.prepareSpecs(e,{skipManaged:!0}),a=zs(this.channels,t.checkpoint);if(t.pendingWrites?.length){let d=t.pendingWrites.filter(([h,m])=>h===yt).map(([h,m,g])=>[String(m),g]);d.length>0&&Rt(t.checkpoint,a,[{name:zr,writes:d,triggers:[]}])}let o=Object.values(ta(t.checkpoint,t.pendingWrites,this.nodes,a,i,t.config,!0,{step:(t.metadata?.step??-1)+1,store:this.store})),u=await Fr(this.getSubgraphsAsync()),c=t.config.configurable?.checkpoint_ns??"",l={};for(let d of o){let h=u.find(([g])=>g===d.name);if(!h)continue;let m=`${String(d.name)}${mr}${d.id}`;if(c&&(m=`${c}${De}${m}`),n===void 0){let g={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:m}};l[d.id]=g}else{let g={configurable:{[je]:n,thread_id:t.config.configurable?.thread_id,checkpoint_ns:m}},y=h[1];l[d.id]=await y.getState(g,{subgraphs:!0})}}if(s&&t.pendingWrites?.length){let d=Object.fromEntries(o.map(m=>[m.id,m]));for(let[m,g,y]of t.pendingWrites)[qe,ye,vo].includes(g)||m in d&&d[m].writes.push([String(g),y]);let h=o.filter(m=>m.writes.length>0);h.length>0&&Rt(t.checkpoint,a,h)}let f=t?.metadata;f&&t?.config?.configurable?.thread_id&&(f={...f,thread_id:t.config.configurable.thread_id});let p=o.filter(d=>d.writes.length===0).map(d=>d.name);return{values:Br(a,this.streamChannelsAsIs),next:p,tasks:Rb(o,t?.pendingWrites??[],l),metadata:f,config:ea(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){let n=e.configurable?.[je]??this.checkpointer;if(!n)throw new Oc("No checkpointer set");let s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){let u=Zp(s);for await(let[c,l]of this.getSubgraphsAsync(u,!0))if(c===u)return await l.getState(So(e,{[je]:n}),{subgraphs:t?.subgraphs});throw new Error(`Subgraph with namespace "${u}" not found.`)}let i=nt(this.config,e),a=await n.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:a,subgraphCheckpointer:t?.subgraphs?n:void 0,applyPendingWrites:!e.configurable?.checkpoint_id})}async*getStateHistory(e,t){let n=e.configurable?.[je]??this.checkpointer;if(!n)throw new Error("No checkpointer set");let s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){let a=Zp(s);for await(let[o,u]of this.getSubgraphsAsync(a,!0))if(o===a){yield*u.getStateHistory(So(e,{[je]:n}),t);return}throw new Error(`Subgraph with namespace "${a}" not found.`)}let i=nt(this.config,e,{configurable:{checkpoint_ns:s}});for await(let a of n.list(i,t))yield this._prepareStateSnapshot({config:a.config,saved:a})}async bulkUpdateState(e,t){let n=e.configurable?.[je]??this.checkpointer;if(!n)throw new Oc("No checkpointer set");if(t.length===0)throw new Error("No supersteps provided");if(t.some(o=>o.updates.length===0))throw new Error("No updates provided");let s=e.configurable?.checkpoint_ns??"";if(s!==""&&e.configurable?.[je]===void 0){let o=Zp(s);for await(let[,u]of this.getSubgraphsAsync(o,!0))return await u.bulkUpdateState(So(e,{[je]:n}),t);throw new Error(`Subgraph "${o}" not found`)}let i=async(o,u)=>{let c=this.config?nt(this.config,o):o,l=await n.getTuple(c),f=l!==void 0?Yn(l.checkpoint):jc(),p={...l?.checkpoint.channel_versions},d=l?.metadata?.step??-1,h=So(c,{checkpoint_ns:c.configurable?.checkpoint_ns??""}),m=c.metadata??{};l?.config.configurable&&(h=So(c,l.config.configurable),m={...l.metadata,...m});let{values:g,asNode:y}=u[0];if(g==null&&y===void 0){if(u.length>1)throw new he("Cannot create empty checkpoint with multiple updates");let I=await n.put(h,Mr(f,void 0,d),{source:"update",step:d+1,writes:{},parents:l?.metadata?.parents??{}},{});return ea(I,l?l.metadata:void 0)}let b=zs(this.channels,f),{managed:w}=await this.prepareSpecs(c,{skipManaged:!0});if(g===null&&y===te){if(u.length>1)throw new he("Cannot apply multiple updates when clearing state");if(l){let S=ta(f,l.pendingWrites||[],this.nodes,b,w,l.config,!0,{step:(l.metadata?.step??-1)+1,checkpointer:this.checkpointer||void 0,store:this.store}),C=(l.pendingWrites||[]).filter(ue=>ue[0]===yt).map(ue=>ue.slice(1));C.length>0&&Rt(l.checkpoint,b,[{name:zr,writes:C,triggers:[]}]);for(let[ue,Re,br]of l.pendingWrites||[])[qe,ye,vo].includes(Re)||ue in S&&S[ue].writes.push([Re,br]);Rt(f,b,Object.values(S))}let I=await n.put(h,Mr(f,void 0,d),{...m,source:"update",step:d+1,writes:{},parents:l?.metadata?.parents??{}},{});return ea(I,l?l.metadata:void 0)}if(g==null&&y===eE){if(u.length>1)throw new he("Cannot copy checkpoint with multiple updates");let I=await n.put(l?.parentConfig??h,Mr(f,void 0,d),{source:"fork",step:d+1,writes:{},parents:l?.metadata?.parents??{}},{});return ea(I,l?l.metadata:void 0)}if(y===zr){if(u.length>1)throw new he("Cannot apply multiple updates when updating as input");let I=await Fr(Wp(this.inputChannels,g));if(I.length===0)throw new he(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);Rt(f,b,[{name:zr,writes:I,triggers:[]}],n.getNextVersion.bind(this.checkpointer));let S=l?.metadata?.step!=null?l.metadata.step+1:-1,C=await n.put(h,Mr(f,b,S),{source:"input",step:S,writes:Object.fromEntries(I),parents:l?.metadata?.parents??{}},Gc(p,f.channel_versions));return await n.putWrites(C,I,js(zr,f.id)),ea(C,l?l.metadata:void 0)}if(c.configurable?.checkpoint_id===void 0&&l?.pendingWrites!==void 0&&l.pendingWrites.length>0){let I=ta(f,l.pendingWrites,this.nodes,b,w,l.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(l.metadata?.step??-1)+1}),S=(l.pendingWrites??[]).filter(ue=>ue[0]===yt).map(ue=>ue.slice(1));S.length>0&&Rt(l.checkpoint,b,[{name:zr,writes:S,triggers:[]}]);for(let[ue,Re,br]of l.pendingWrites)[qe,ye,vo].includes(Re)||I[ue]===void 0||I[ue].writes.push([Re,br]);let C=Object.values(I).filter(ue=>ue.writes.length>0);C.length>0&&Rt(f,b,C)}let x=Object.values(f.versions_seen).map(I=>Object.values(I)).flat().find(I=>!!I),A=[];if(u.length===1){let{values:I,asNode:S}=u[0];if(S===void 0&&Object.keys(this.nodes).length===1)[S]=Object.keys(this.nodes);else if(S===void 0&&x===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(S=this.inputChannels);else if(S===void 0){let C=Object.entries(f.versions_seen).map(([ue,Re])=>Object.values(Re).map(br=>[br,ue])).flat().sort(([ue],[Re])=>xb(ue,Re));C&&(C.length===1?S=C[0][1]:C[C.length-1][0]!==C[C.length-2][0]&&(S=C[C.length-1][1]))}if(S===void 0)throw new he('Ambiguous update, specify "asNode"');A.push({values:I,asNode:S})}else for(let{asNode:I,values:S}of u){if(I==null)throw new he('"asNode" is required when applying multiple updates');A.push({values:S,asNode:I})}let P=[];for(let{asNode:I,values:S}of A){if(this.nodes[I]===void 0)throw new he(`Node "${I.toString()}" does not exist`);let C=this.nodes[I].getWriters();if(!C.length)throw new he(`No writers found for node "${I.toString()}"`);P.push({name:I,input:S,proc:C.length>1?gt.from(C,{omitSequenceTags:!0}):C[0],writes:[],triggers:[ye],id:js(ye,f.id),writers:[]})}for(let I of P)await I.proc.invoke(I.input,be({...c,store:c?.store??this.store},{runName:c.runName??`${this.getName()}UpdateState`,configurable:{[Qn]:S=>I.writes.push(...S),[Lr]:(S,C=!1)=>Zc(d,f,b,w,I,S,C)}}));for(let I of P){let S=I.writes.filter(C=>C[0]!==Ct);l!==void 0&&S.length>0&&await n.putWrites(h,S,I.id)}Rt(f,b,P,n.getNextVersion.bind(this.checkpointer));let M=Gc(p,f.channel_versions),N=await n.put(h,Mr(f,b,d+1),{source:"update",step:d+1,writes:Object.fromEntries(A.map(I=>[I.asNode,I.values])),parents:l?.metadata?.parents??{}},M);for(let I of P){let S=I.writes.filter(C=>C[0]===Ct);S.length>0&&await n.putWrites(N,S,I.id)}return ea(N,l?l.metadata:void 0)},a=e;for(let{updates:o}of t)a=await i(a,o);return a}async updateState(e,t,n){return this.bulkUpdateState(e,[{updates:[{values:t,asNode:n}]}])}_defaults(e){let{debug:t,streamMode:n,inputKeys:s,outputKeys:i,interruptAfter:a,interruptBefore:o,...u}=e,c=!0,l=t!==void 0?t:this.debug,f=i;f===void 0?f=this.streamChannelsAsIs:Tb(f,this.channels);let p=s;p===void 0?p=this.inputChannels:Tb(p,this.channels);let d=o??this.interruptBefore??[],h=a??this.interruptAfter??[],m;n!==void 0?(m=Array.isArray(n)?n:[n],c=typeof n=="string"):(m=this.streamMode,c=!0),e.configurable?.[Wi]!==void 0&&(m=["values"]);let g;this.checkpointer===!1?g=void 0:e!==void 0&&e.configurable?.[je]!==void 0?g=e.configurable[je]:g=this.checkpointer;let y=e.store??this.store;return[l,m,p,f,u,d,h,g,y,c]}async stream(e,t){let n=new AbortController,s={recursionLimit:this.config?.recursionLimit,...t,signal:t?.signal?Fs(t.signal,n.signal):n.signal};return new Kc(await super.stream(e,s),n)}streamEvents(e,t,n){let s=new AbortController,i={recursionLimit:this.config?.recursionLimit,callbacks:this.config?.callbacks,...t,signal:t?.signal?Fs(t.signal,s.signal):s.signal};return new Kc(super.streamEvents(e,i,n),s)}async prepareSpecs(e,t){let n={...e,store:this.store},s={},i={};for(let[o,u]of Object.entries(this.channels))Hi(u)?s[o]=u:t?.skipManaged?i[o]={cls:Up,params:{config:{}}}:i[o]=u;let a=new Fp(await Object.entries(i).reduce(async(o,[u,c])=>{let l=await o,f;return Xi(c)?("key"in c.params&&c.params.key===Pb&&(c.params.key=u),f=await c.cls.initialize(n,c.params)):f=await c.initialize(n),f!==void 0&&l.push([u,f]),l},Promise.resolve([])));return{channelSpecs:s,managed:a}}async _validateInput(e){return e}async _validateConfigurable(e){return e}async*_streamIterator(e,t){let n=t?.subgraphs,s=Gp(this.config,t);if(s.recursionLimit===void 0||s.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&s.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');let i=await this._validateInput(e),{runId:a,...o}=s,[u,c,,l,f,p,d,h,m,g]=this._defaults(o);f.configurable=await this._validateConfigurable(f.configurable);let y=new To({modes:new Set(c)});if(c.includes("messages")){let S=new nd(ue=>y.push(ue)),{callbacks:C}=f;if(C===void 0)f.callbacks=[S];else if(Array.isArray(C))f.callbacks=C.concat(S);else{let ue=C.copy();ue.addHandler(S,!0),f.callbacks=ue}}c.includes("custom")&&(f.writer=S=>y.push([[],"custom",S]));let w=await(await mt(f))?.handleChainStart(this.toJSON(),hE(e,"input"),a,void 0,void 0,void 0,f?.runName??this.getName()),{channelSpecs:x,managed:A}=await this.prepareSpecs(f),P,M,I=(async()=>{try{P=await rd.initialize({input:i,config:f,checkpointer:h,nodes:this.nodes,channelSpecs:x,managed:A,outputKeys:l,streamKeys:this.streamChannelsAsIs,store:m,stream:y,interruptAfter:d,interruptBefore:p,manager:w,debug:this.debug});let S=new sd({loop:P,nodeFinished:f.configurable?.[tE]});t?.subgraphs&&(P.config.configurable={...P.config.configurable,[Eo]:P.stream}),await this._runLoop({loop:P,runner:S,debug:u,config:f})}catch(S){M=S}finally{try{P&&await P.store?.stop(),await Promise.all([...P?.checkpointerPromises??[],...Array.from(A.values()).map(S=>S.promises())])}catch(S){M=M??S}M?y.error(M):y.close()}})();try{for await(let S of y){if(S===void 0)throw new Error("Data structure error.");let[C,ue,Re]=S;c.includes(ue)&&(n&&!g?yield[C,ue,Re]:g?n?yield[C,Re]:yield Re:yield[ue,Re])}}catch(S){throw await w?.handleChainError(M),S}finally{await I}await w?.handleChainEnd(P?.output??{},a,void 0,void 0,void 0)}async invoke(e,t){let n=t?.streamMode??"values",s={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:n},i=[],a=await this.stream(e,s);for await(let o of a)i.push(o);return n==="values"?i[i.length-1]:i}async _runLoop(e){let{loop:t,runner:n,debug:s,config:i}=e,a;try{for(;await t.tick({inputKeys:this.inputChannels});)s&&fE(t.checkpointMetadata.step,t.channels,this.streamChannelsList),s&&Xp(t.step,Object.values(t.tasks)),await n.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(o,u)=>{s&&pE(o,u,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal});if(t.status==="out_of_steps")throw new Op([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(o){if(a=o,!await t.finishAndHandleError(a))throw o}finally{a===void 0&&await t.finishAndHandleError()}}};var gr=class r extends hr{constructor(e=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.guard=e}fromCheckpoint(e){let t=new r(this.guard);return typeof e<"u"&&(t.value=[e]),t}update(e){if(e.length===0){let t=this.value.length>0;return this.value=[],t}if(e.length!==1&&this.guard)throw new he("EphemeralValue can only receive one value per step.");return this.value=[e[e.length-1]],!0}get(){if(this.value.length===0)throw new Oe;return this.value[0]}checkpoint(){if(this.value.length===0)throw new Oe;return this.value[0]}};var Hc=class{constructor(e){Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),W.isRunnable(e.path)?this.path=e.path:this.path=Ze(e.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce((t,n)=>(t[n]=n,t),{}):e.pathMap}run(e,t){return Pe.registerWriter(new Qe({name:"<branch_run>",trace:!1,func:async(n,s)=>{try{return await this._route(n,s,e,t)}catch(i){throw i.name===Pc.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),i}}}))}async _route(e,t,n,s){let i=await this.path.invoke(s?s(t):e,t);Array.isArray(i)||(i=[i]);let a;if(this.ends?a=i.map(u=>Xe(u)?u:this.ends[u]):a=i,a.some(u=>!u))throw new Error("Branch condition returned unknown or null destination");if(a.filter(Xe).some(u=>u.node===te))throw new he("Cannot send a packet to the END node");return await n(a,t)??e}},Co=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(...e){function t(s){return s.length>=1&&typeof s[0]!="string"}let n=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(let[s,i,a]of n){for(let u of[De,mr])if(s.includes(u))throw new Error(`"${u}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===te)throw new Error(`Node \`${s}\` is reserved.`);let o=Ze(i);this.nodes[s]={runnable:o,metadata:a?.metadata,subgraphs:Uc(o)?[o]:a?.subgraphs,ends:a?.ends}}return this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===te)throw new Error("END cannot be a start node");if(t===me)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([n])=>n===e)&&!("channels"in this))throw new Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,n){var a,o;let s=typeof e=="object"?e:{source:e,path:t,pathMap:n};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!W.isRunnable(s.path)){let u=Array.isArray(s.pathMap)?s.pathMap.join(","):Object.keys(s.pathMap??{}).join(",");s.path=Ze(s.path).withConfig({runName:`Branch<${s.source}${u!==""?`,${u}`:""}>`.slice(0,63)})}let i=s.path.getName()==="RunnableLambda"?"condition":s.path.getName();if(this.branches[s.source]&&this.branches[s.source][i])throw new Error(`Condition \`${i}\` already present for node \`${e}\``);return(a=this.branches)[o=s.source]??(a[o]={}),this.branches[s.source][i]=new Hc(s),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(me,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,te)}compile({checkpointer:e,interruptBefore:t,interruptAfter:n,name:s}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(n)?n:[]]);let i=new Wc({builder:this,checkpointer:e,interruptAfter:n,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[me]:new gr,[te]:new gr},inputChannels:me,outputChannels:te,streamChannels:[],streamMode:"values",name:s});for(let[a,o]of Object.entries(this.nodes))i.attachNode(a,o);for(let[a,o]of this.edges)i.attachEdge(a,o);for(let[a,o]of Object.entries(this.branches))for(let[u,c]of Object.entries(o))i.attachBranch(a,u,c);return i.validate()}validate(e){let t=new Set([...this.allEdges].map(([s,i])=>s));for(let[s]of Object.entries(this.branches))t.add(s);for(let s of t)if(s!==me&&!(s in this.nodes))throw new Error(`Found edge starting at unknown node \`${s}\``);let n=new Set([...this.allEdges].map(([s,i])=>i));for(let[s,i]of Object.entries(this.branches))for(let a of Object.values(i))if(a.ends!=null)for(let o of Object.values(a.ends))n.add(o);else{n.add(te);for(let o of Object.keys(this.nodes))o!==s&&n.add(o)}for(let s of Object.values(this.nodes))for(let i of s.ends??[])n.add(i);for(let s of Object.keys(this.nodes))if(!n.has(s))throw new Pp([`Node \`${s}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(let s of n)if(s!==te&&!(s in this.nodes))throw new Error(`Found edge ending at unknown node \`${s}\``);if(e){for(let s of e)if(!(s in this.nodes))throw new Error(`Interrupt node \`${s}\` is not present`)}this.compiled=!0}},Wc=class extends ko{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new gr,this.nodes[e]=new Kt({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs,ends:t.ends}).pipe(t.runnable).pipe(new Pe([{channel:e,value:Ut}],[ge])),this.streamChannels.push(e)}attachEdge(e,t){if(t===te){if(e===me)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new Pe([{channel:te,value:Ut}],[ge]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,n){e===me&&!this.nodes[me]&&(this.nodes[me]=id.subscribeTo(me,{tags:[ge]})),this.nodes[e].pipe(n.run(i=>{let a=i.map(o=>Xe(o)?o:{channel:o===te?te:`branch:${e}:${t}:${o}`,value:Ut});return new Pe(a,[ge])}));let s=n.ends?Object.values(n.ends):Object.keys(this.nodes);for(let i of s)if(i!==te){let a=`branch:${e}:${t}:${i}`;this.channels[a]=new gr,this.nodes[i].triggers.push(a),this.nodes[i].channels.push(a)}}async getGraphAsync(e){let t=e?.xray,n=new Cs,s={[me]:n.addNode({schema:Se.any()},me)},i={},a={};t&&(a=Object.fromEntries((await Fr(this.getSubgraphsAsync())).filter(c=>_E(c[1]))));function o(c,l,f,p=!1){if(l===te&&i[te]===void 0&&(i[te]=n.addNode({schema:Se.any()},te)),s[c]!==void 0){if(i[l]===void 0)throw new Error(`End node ${l} not found!`);return n.addEdge(s[c],i[l],f!==l?f:void 0,p)}}for(let[c,l]of Object.entries(this.builder.nodes)){let f=_t(c),p=l.runnable,d=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?d.__interrupt="before,after":this.interruptBefore?.includes(c)?d.__interrupt="before":this.interruptAfter?.includes(c)&&(d.__interrupt="after"),t){let h=typeof t=="number"?t-1:t,m=a[c]!==void 0?await a[c].getGraphAsync({...e,xray:h}):p.getGraph(e);if(m.trimFirstNode(),m.trimLastNode(),Object.keys(m.nodes).length>1){let b=function(x){return x?x.lc_runnable:!1},w=function(x,A){if(x!==void 0&&!Gt(x))return x;if(b(A))try{let P=A.getName();return P=P.startsWith("Runnable")?P.slice(8):P,P}catch{return A.getName()}else return A.name??"UnknownSchema"},[g,y]=n.extend(m,f);if(g===void 0)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);y!==void 0&&(s[f]={name:w(y.id,y.data),...y}),i[f]={name:w(g.id,g.data),...g}}else{let g=n.addNode(p,f,d);s[f]=g,i[f]=g}}else{let h=n.addNode(p,f,d);s[f]=h,i[f]=h}}let u=[...this.builder.allEdges].sort(([c],[l])=>c<l?-1:l>c?1:0);for(let[c,l]of u)o(_t(c),_t(l));for(let[c,l]of Object.entries(this.builder.branches)){let f={...Object.fromEntries(Object.keys(this.builder.nodes).filter(p=>p!==c).map(p=>[_t(p),_t(p)])),[te]:te};for(let p of Object.values(l)){let d;p.ends!==void 0?d=p.ends:d=f;for(let[h,m]of Object.entries(d))o(_t(c),_t(m),h,!0)}}for(let[c,l]of Object.entries(this.builder.nodes))if(l.ends!==void 0)for(let f of l.ends)o(_t(c),_t(f),void 0,!0);return n}getGraph(e){let t=e?.xray,n=new Cs,s={[me]:n.addNode({schema:Se.any()},me)},i={},a={};t&&(a=Object.fromEntries(Qi(this.getSubgraphs()).filter(c=>_E(c[1]))));function o(c,l,f,p=!1){return l===te&&i[te]===void 0&&(i[te]=n.addNode({schema:Se.any()},te)),n.addEdge(s[c],i[l],f!==l?f:void 0,p)}for(let[c,l]of Object.entries(this.builder.nodes)){let f=_t(c),p=l.runnable,d=l.metadata??{};if(this.interruptBefore?.includes(c)&&this.interruptAfter?.includes(c)?d.__interrupt="before,after":this.interruptBefore?.includes(c)?d.__interrupt="before":this.interruptAfter?.includes(c)&&(d.__interrupt="after"),t){let h=typeof t=="number"?t-1:t,m=a[c]!==void 0?a[c].getGraph({...e,xray:h}):p.getGraph(e);if(m.trimFirstNode(),m.trimLastNode(),Object.keys(m.nodes).length>1){let b=function(x){return x?x.lc_runnable:!1},w=function(x,A){if(x!==void 0&&!Gt(x))return x;if(b(A))try{let P=A.getName();return P=P.startsWith("Runnable")?P.slice(8):P,P}catch{return A.getName()}else return A.name??"UnknownSchema"},[g,y]=n.extend(m,f);if(g===void 0)throw new Error(`Could not extend subgraph "${c}" due to missing entrypoint.`);y!==void 0&&(s[f]={name:w(y.id,y.data),...y}),i[f]={name:w(g.id,g.data),...g}}else{let g=n.addNode(p,f,d);s[f]=g,i[f]=g}}else{let h=n.addNode(p,f,d);s[f]=h,i[f]=h}}let u=[...this.builder.allEdges].sort(([c],[l])=>c<l?-1:l>c?1:0);for(let[c,l]of u)o(_t(c),_t(l));for(let[c,l]of Object.entries(this.builder.branches)){let f={...Object.fromEntries(Object.keys(this.builder.nodes).filter(p=>p!==c).map(p=>[_t(p),_t(p)])),[te]:te};for(let p of Object.values(l)){let d;p.ends!==void 0?d=p.ends:d=f;for(let[h,m]of Object.entries(d))o(_t(c),_t(m),h,!0)}}return n}};function _E(r){return typeof r.attachNode=="function"&&typeof r.attachEdge=="function"}function _t(r){return r==="subgraph"?`"${r}"`:r}var wE=(r,e)=>r.size===e.size&&[...r].every(t=>e.has(t)),ad=class r extends hr{constructor(e){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=e,this.seen=new Set}fromCheckpoint(e){let t=new r(this.names);return typeof e<"u"&&(t.seen=new Set(e)),t}update(e){let t=!1;for(let n of e)if(this.names.has(n))this.seen.has(n)||(this.seen.add(n),t=!0);else throw new he(`Value ${JSON.stringify(n)} not in names ${JSON.stringify(this.names)}`);return t}get(){if(!wE(this.names,this.seen))throw new Oe}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&wE(this.seen,this.names)?(this.seen=new Set,!0):!1}};var vE=new WeakMap;function xE(r){return typeof r=="object"&&r!=null&&"_parse"in r&&typeof r._parse=="function"}function kj(r){return xE(r)&&"removeDefault"in r&&typeof r.removeDefault=="function"}function gn(r){return xE(r)&&"partial"in r&&typeof r.partial=="function"}function AE(r,e){if(e.reducer&&!e.default){let t=kj(r)?r._def.defaultValue:void 0;t!=null&&(e.default=t)}return vE.set(r,e),r}function Cj(r){return vE.get(r)}function Ro(r){let e={};for(let t in r.shape)if(Object.prototype.hasOwnProperty.call(r.shape,t)){let n=r.shape[t],s=Cj(n);s?.reducer?e[t]=new Xn(s.reducer.fn,s.default):e[t]=new hn}return e}var ns="__root__",ra=class extends Co{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_configRuntimeSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),zj(e)){let n=Ro(e.state),s=e.input!=null?Ro(e.input):n,i=e.output!=null?Ro(e.output):n;this._schemaDefinition=n,this._schemaRuntimeDefinition=e.state,this._inputDefinition=s,this._inputRuntimeDefinition=e.input??e.state.partial(),this._outputDefinition=i,this._outputRuntimeDefinition=e.output??e.state}else if(gn(e)){let n=Ro(e);this._schemaDefinition=n,this._schemaRuntimeDefinition=e,this._inputDefinition=n,this._inputRuntimeDefinition=e.partial(),this._outputDefinition=n,this._outputRuntimeDefinition=e}else if(Mj(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(jj(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(Nj(e)||EE(e)){let n=EE(e)?e.spec:e;this._schemaDefinition=n}else if($j(e)){let n=Rj(e.channels);this._schemaDefinition=n}else throw new Error("Invalid StateGraph input.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),gn(t)&&(this._configRuntimeSchema=t.passthrough())}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,t])=>e.map(n=>[n,t]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(let[t,n]of Object.entries(e)){let s;if(typeof n=="function"?s=n():s=n,this.channels[t]!==void 0){if(this.channels[t]!==s&&!Xi(s)&&s.lc_graph_name!=="LastValue")throw new Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=s}}}addNode(...e){function t(s){return s.length>=1&&typeof s[0]!="string"}let n=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(n.length===0)throw new Error("No nodes provided in `addNode`");for(let[s,i,a]of n){if(s in this.channels)throw new Error(`${s} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(let l of[De,mr])if(s.includes(l))throw new Error(`"${l}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),s in this.nodes)throw new Error(`Node \`${s}\` already present.`);if(s===te||s===me)throw new Error(`Node \`${s}\` is reserved.`);let o=this._schemaDefinition;a?.input!==void 0&&(gn(a.input)?o=Ro(a.input):a.input.spec!==void 0&&(o=a.input.spec)),o!==void 0&&this._addSchema(o);let u;W.isRunnable(i)?u=i:typeof i=="function"?u=new Qe({func:i,name:s,trace:!1}):u=Ze(i);let c={runnable:u,retryPolicy:a?.retryPolicy,metadata:a?.metadata,input:o??this._schemaDefinition,subgraphs:Uc(u)?[u]:a?.subgraphs,ends:a?.ends};this.nodes[s]=c}return this}addEdge(e,t){if(typeof e=="string")return super.addEdge(e,t);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(let n of e){if(n===te)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(s=>s===n))throw new Error(`Need to add a node named "${n}" first`)}if(t===te)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(n=>n===t))throw new Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}addSequence(e){let t=Array.isArray(e)?e:Object.entries(e);if(t.length===0)throw new Error("Sequence requires at least one node.");let n;for(let[s,i,a]of t){if(s in this.nodes)throw new Error(`Node names must be unique: node with the name "${s}" already exists.`);let o=s;this.addNode(o,i,a),n!=null&&this.addEdge(n,o),n=o}return this}compile({checkpointer:e,store:t,interruptBefore:n,interruptAfter:s,name:i}={}){this.validate([...Array.isArray(n)?n:[],...Array.isArray(s)?s:[]]);let a=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),o=a.length===1&&a[0]===ns?ns:a,u=Object.keys(this.channels),c=u.length===1&&u[0]===ns?ns:u,l=new Jc({builder:this,checkpointer:e,interruptAfter:s,interruptBefore:n,autoValidate:!1,nodes:{},channels:{...this.channels,[me]:new gr},inputChannels:me,outputChannels:o,streamChannels:c,streamMode:"updates",store:t,name:i});l.attachNode(me);for(let[f,p]of Object.entries(this.nodes))l.attachNode(f,p);l.attachBranch(me,Ob,OE(),{withReader:!1});for(let[f]of Object.entries(this.nodes))l.attachBranch(f,Ob,OE(),{withReader:!1});for(let[f,p]of this.edges)l.attachEdge(f,p);for(let[f,p]of this.waitingEdges)l.attachEdge(f,p);for(let[f,p]of Object.entries(this.branches))for(let[d,h]of Object.entries(p))l.attachBranch(f,d,h);return l.validate()}};function Rj(r){let e={};for(let[t,n]of Object.entries(r))if(t===ns)e[t]=Vp(n);else{let s=t;e[t]=Vp(n)}return e}var Jc=class extends Wc{attachNode(e,t){let n;e===me?n=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).filter(([u,c])=>!Xi(c)).map(([u])=>u):n=Object.keys(this.builder.channels);function s(u){if(at(u))return u.graph===it.PARENT?null:u._updateAsTuples();if(Array.isArray(u)&&u.length>0&&u.some(c=>at(c))){let c=[];for(let l of u)if(at(l)){if(l.graph===it.PARENT)continue;c.push(...l._updateAsTuples())}else c.push([ns,l]);return c}else if(u!=null)return[[ns,u]];return null}let i=e;function a(u){if(u){if(at(u))return u.graph===it.PARENT?null:u._updateAsTuples().filter(([c])=>n.includes(c));if(Array.isArray(u)&&u.length>0&&u.some(at)){let c=[];for(let l of u)if(at(l)){if(l.graph===it.PARENT)continue;c.push(...l._updateAsTuples().filter(([f])=>n.includes(f)))}else{let f=a(l);f&&c.push(...f??[])}return c}else{if(typeof u=="object"&&!Array.isArray(u))return Object.entries(u).filter(([c])=>n.includes(c));{let c=Array.isArray(u)?"array":typeof u;throw new he(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${c}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}let o=[{value:Ut,mapper:new Qe({func:n.length&&n[0]===ns?s:a,trace:!1,recurse:!1})}];if(e===me)this.nodes[e]=new Kt({tags:[ge],triggers:[me],channels:[me],writers:[new Pe(o,[ge])]});else{let u=t?.input??this.builder._schemaDefinition,c=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(u)).map(p=>[p,p])),l=Object.keys(c).length===1&&ns in c,f=`branch:to:${e}`;this.channels[f]=new gr(!1),this.nodes[e]=new Kt({triggers:[f],channels:l?Object.keys(c):c,writers:[new Pe(o,[ge])],mapper:l?void 0:p=>Object.fromEntries(Object.entries(p).filter(([d])=>d in c)),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs,ends:t?.ends})}}attachEdge(e,t){if(t!==te){if(typeof e=="string")this.nodes[e].writers.push(new Pe([{channel:`branch:to:${t}`,value:null}],[ge]));else if(Array.isArray(e)){let n=`join:${e.join("+")}:${t}`;this.channels[n]=new ad(new Set(e)),this.nodes[t].triggers.push(n);for(let s of e)this.nodes[s].writers.push(new Pe([{channel:n,value:s}],[ge]))}}}attachBranch(e,t,n,s={withReader:!0}){let i=async(a,o)=>{let u=a.filter(l=>l!==te);if(!u.length)return;let c=u.map(l=>Xe(l)?l:{channel:`branch:to:${l}`,value:e});await Pe.doWrite({...o,tags:(o.tags??[]).concat([ge])},c)};this.nodes[e].writers.push(n.run(i,s.withReader?a=>Hp.doRead(a,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){let t=this.builder._inputRuntimeDefinition;if(at(e)){let n=e;return e.update&&gn(t)&&(n.update=t.parse(e.update)),n}return gn(t)?t.parse(e):e}async _validateConfigurable(e){let t=this.builder._configRuntimeSchema;return gn(t)&&t.parse(e),e}};function Nj(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)&&Object.keys(r).length>0&&Object.values(r).every(e=>typeof e=="function"||Hi(e))}function EE(r){return typeof r=="object"&&r!==null&&"lc_graph_name"in r&&r.lc_graph_name==="AnnotationRoot"}function $j(r){return typeof r=="object"&&r!==null&&r.channels!==void 0}function jj(r){return typeof r=="object"&&r!==null&&r.stateSchema!==void 0}function Mj(r){return typeof r=="object"&&r!==null&&r.stateSchema===void 0&&r.input!==void 0&&r.output!==void 0}function zj(r){return!(typeof r!="object"||r==null||!("state"in r)||!gn(r.state)||"input"in r&&!gn(r.input)||"output"in r&&!gn(r.output))}function Lj(r){if(Xe(r))return[r];let e=[];at(r)?e.push(r):Array.isArray(r)&&e.push(...r.filter(at));let t=[];for(let n of e){if(n.graph===it.PARENT)throw new Sc(n);Xe(n.goto)||typeof n.goto=="string"?t.push(n.goto):Array.isArray(n.goto)&&t.push(...n.goto)}return t}function OE(){let r=new Qe({func:Lj,tags:[ge],trace:!1,recurse:!1,name:"<control_branch>"});return new Hc({path:r})}vr();var Db="__remove_all__";function No(r,e){let t=Array.isArray(r)?r:[r],n=Array.isArray(e)?e:[e],s=t.map(Dt),i=n.map(Dt);for(let l of s)(l.id===null||l.id===void 0)&&(l.id=ve(),l.lc_kwargs.id=l.id);let a;for(let l=0;l<i.length;l+=1){let f=i[l];(f.id===null||f.id===void 0)&&(f.id=ve(),f.lc_kwargs.id=f.id),f.getType()==="remove"&&f.id===Db&&(a=l)}if(a!=null)return i.slice(a+1);let o=[...s],u=new Map(o.map((l,f)=>[l.id,f])),c=new Set;for(let l of i){let f=u.get(l.id);if(f!==void 0)l.getType()==="remove"?c.add(l.id):(c.delete(l.id),o[f]=l);else{if(l.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${l.id}')`);u.set(l.id,o.length),o.push(l)}}return o.filter(l=>!c.has(l.id))}var PE=function(e,t){let{name:n,checkpointer:s,store:i}=typeof e=="string"?{name:e,checkpointer:void 0,store:void 0}:e;if(iE(t)||aE(t))throw new Error("Generators are disallowed as entrypoints. For streaming responses, use config.write.");let a="updates",o=gE(n,t);function u(p){return typeof p=="object"&&p!==null&&"__lg_type"in p&&p.__lg_type==="__pregel_final"}let c=new Qe({name:"pluckReturnValue",func:p=>u(p)?p.value:p}),l=new Qe({name:"pluckSaveValue",func:p=>u(p)?p.save:p}),f=new Kt({bound:o,triggers:[me],channels:[me],writers:[new Pe([{channel:te,value:Ut,mapper:c},{channel:Ji,value:Ut,mapper:l}],[ge])]});return new ko({name:n,checkpointer:s,nodes:{[n]:f},channels:{[me]:new gr,[te]:new hn,[Ji]:new hn},inputChannels:me,outputChannels:te,streamChannels:te,streamMode:a,store:i})};PE.final=function({value:e,save:t}){return{value:e,save:t,__lg_type:"__pregel_final"}};un();var Fj=Po.Root({messages:Po({reducer:No,default:()=>[]})}),Uj=Se.object({messages:AE(Se.custom(),{reducer:{schema:Se.custom(),fn:No},default:()=>[]})});var od="RFC3986",ud={RFC1738:r=>String(r).replace(/%20/g,"+"),RFC3986:r=>String(r)},SE="RFC1738";var Bj=Array.isArray,bn=(()=>{let r=[];for(let e=0;e<256;++e)r.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return r})();var Fb=1024,IE=(r,e,t,n,s)=>{if(r.length===0)return r;let i=r;if(typeof r=="symbol"?i=Symbol.prototype.toString.call(r):typeof r!="string"&&(i=String(r)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=Fb){let u=i.length>=Fb?i.slice(o,o+Fb):i,c=[];for(let l=0;l<u.length;++l){let f=u.charCodeAt(l);if(f===45||f===46||f===95||f===126||f>=48&&f<=57||f>=65&&f<=90||f>=97&&f<=122||s===SE&&(f===40||f===41)){c[c.length]=u.charAt(l);continue}if(f<128){c[c.length]=bn[f];continue}if(f<2048){c[c.length]=bn[192|f>>6]+bn[128|f&63];continue}if(f<55296||f>=57344){c[c.length]=bn[224|f>>12]+bn[128|f>>6&63]+bn[128|f&63];continue}l+=1,f=65536+((f&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=bn[240|f>>18]+bn[128|f>>12&63]+bn[128|f>>6&63]+bn[128|f&63]}a+=c.join("")}return a};function TE(r){return!r||typeof r!="object"?!1:!!(r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer(r))}function Ub(r,e){if(Bj(r)){let t=[];for(let n=0;n<r.length;n+=1)t.push(e(r[n]));return t}return e(r)}var Vj=Object.prototype.hasOwnProperty,kE={brackets(r){return String(r)+"[]"},comma:"comma",indices(r,e){return String(r)+"["+e+"]"},repeat(r){return String(r)}},yn=Array.isArray,Gj=Array.prototype.push,CE=function(r,e){Gj.apply(r,yn(e)?e:[e])},Zj=Date.prototype.toISOString,Ke={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:IE,encodeValuesOnly:!1,format:od,formatter:ud[od],indices:!1,serializeDate(r){return Zj.call(r)},skipNulls:!1,strictNullHandling:!1};function qj(r){return typeof r=="string"||typeof r=="number"||typeof r=="boolean"||typeof r=="symbol"||typeof r=="bigint"}var Bb={};function RE(r,e,t,n,s,i,a,o,u,c,l,f,p,d,h,m,g,y){let b=r,w=y,x=0,A=!1;for(;(w=w.get(Bb))!==void 0&&!A;){let S=w.get(r);if(x+=1,typeof S<"u"){if(S===x)throw new RangeError("Cyclic object value");A=!0}typeof w.get(Bb)>"u"&&(x=0)}if(typeof c=="function"?b=c(e,b):b instanceof Date?b=p?.(b):t==="comma"&&yn(b)&&(b=Ub(b,function(S){return S instanceof Date?p?.(S):S})),b===null){if(i)return u&&!m?u(e,Ke.encoder,g,"key",d):e;b=""}if(qj(b)||TE(b)){if(u){let S=m?e:u(e,Ke.encoder,g,"key",d);return[h?.(S)+"="+h?.(u(b,Ke.encoder,g,"value",d))]}return[h?.(e)+"="+h?.(String(b))]}let P=[];if(typeof b>"u")return P;let M;if(t==="comma"&&yn(b))m&&u&&(b=Ub(b,u)),M=[{value:b.length>0?b.join(",")||null:void 0}];else if(yn(c))M=c;else{let S=Object.keys(b);M=l?S.sort(l):S}let N=o?String(e).replace(/\./g,"%2E"):String(e),I=n&&yn(b)&&b.length===1?N+"[]":N;if(s&&yn(b)&&b.length===0)return I+"[]";for(let S=0;S<M.length;++S){let C=M[S],ue=typeof C=="object"&&typeof C.value<"u"?C.value:b[C];if(a&&ue===null)continue;let Re=f&&o?C.replace(/\./g,"%2E"):C,br=yn(b)?typeof t=="function"?t(I,Re):I:I+(f?"."+Re:"["+Re+"]");y.set(r,x);let Ca=new WeakMap;Ca.set(Bb,y),CE(P,RE(ue,br,t,n,s,i,a,o,t==="comma"&&m&&yn(b)?null:u,c,l,f,p,d,h,m,g,Ca))}return P}function Kj(r=Ke){if(typeof r.allowEmptyArrays<"u"&&typeof r.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof r.encodeDotInKeys<"u"&&typeof r.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(r.encoder!==null&&typeof r.encoder<"u"&&typeof r.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=r.charset||Ke.charset;if(typeof r.charset<"u"&&r.charset!=="utf-8"&&r.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=od;if(typeof r.format<"u"){if(!Vj.call(ud,r.format))throw new TypeError("Unknown format option provided.");t=r.format}let n=ud[t],s=Ke.filter;(typeof r.filter=="function"||yn(r.filter))&&(s=r.filter);let i;if(r.arrayFormat&&r.arrayFormat in kE?i=r.arrayFormat:"indices"in r?i=r.indices?"indices":"repeat":i=Ke.arrayFormat,"commaRoundTrip"in r&&typeof r.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let a=typeof r.allowDots>"u"?r.encodeDotInKeys?!0:Ke.allowDots:!!r.allowDots;return{addQueryPrefix:typeof r.addQueryPrefix=="boolean"?r.addQueryPrefix:Ke.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof r.allowEmptyArrays=="boolean"?!!r.allowEmptyArrays:Ke.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof r.charsetSentinel=="boolean"?r.charsetSentinel:Ke.charsetSentinel,commaRoundTrip:!!r.commaRoundTrip,delimiter:typeof r.delimiter>"u"?Ke.delimiter:r.delimiter,encode:typeof r.encode=="boolean"?r.encode:Ke.encode,encodeDotInKeys:typeof r.encodeDotInKeys=="boolean"?r.encodeDotInKeys:Ke.encodeDotInKeys,encoder:typeof r.encoder=="function"?r.encoder:Ke.encoder,encodeValuesOnly:typeof r.encodeValuesOnly=="boolean"?r.encodeValuesOnly:Ke.encodeValuesOnly,filter:s,format:t,formatter:n,serializeDate:typeof r.serializeDate=="function"?r.serializeDate:Ke.serializeDate,skipNulls:typeof r.skipNulls=="boolean"?r.skipNulls:Ke.skipNulls,sort:typeof r.sort=="function"?r.sort:null,strictNullHandling:typeof r.strictNullHandling=="boolean"?r.strictNullHandling:Ke.strictNullHandling}}function Vb(r,e={}){let t=r,n=Kj(e),s,i;typeof n.filter=="function"?(i=n.filter,t=i("",t)):yn(n.filter)&&(i=n.filter,s=i);let a=[];if(typeof t!="object"||t===null)return"";let o=kE[n.arrayFormat],u=o==="comma"&&n.commaRoundTrip;s||(s=Object.keys(t)),n.sort&&s.sort(n.sort);let c=new WeakMap;for(let p=0;p<s.length;++p){let d=s[p];n.skipNulls&&t[d]===null||CE(a,RE(t[d],d,o,u,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}let l=a.join(n.delimiter),f=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?f+="utf8=%26%2310003%3B&":f+="utf8=%E2%9C%93&"),l.length>0?f+l:""}var na="4.104.0";var NE=!1,sa,Gb,Wj,Jj,Yj,Zb,Xj,cd,qb,Kb,Hb,ld,Wb;function $E(r,e={auto:!1}){if(NE)throw new Error(`you must \`import 'openai/shims/${r.kind}'\` before importing anything else from openai`);if(sa)throw new Error(`can't \`import 'openai/shims/${r.kind}'\` after \`import 'openai/shims/${sa}'\``);NE=e.auto,sa=r.kind,Gb=r.fetch,Wj=r.Request,Jj=r.Response,Yj=r.Headers,Zb=r.FormData,Xj=r.Blob,cd=r.File,qb=r.ReadableStream,Kb=r.getMultipartRequestOptions,Hb=r.getDefaultAgent,ld=r.fileFromPath,Wb=r.isFsReadStream}var fd=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function jE({manuallyImported:r}={}){let e=r?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,n,s,i;try{t=fetch,n=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new fd(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}var Jb=()=>{sa||$E(jE(),{auto:!0})};Jb();var F=class extends Error{},Fe=class r extends F{constructor(e,t,n,s){super(`${r.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.request_id=s?.["x-request-id"],this.error=t;let i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,n){let s=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new ss({message:n,cause:pd(t)});let i=t?.error;return e===400?new $o(e,i,n,s):e===401?new jo(e,i,n,s):e===403?new Mo(e,i,n,s):e===404?new zo(e,i,n,s):e===409?new Lo(e,i,n,s):e===422?new Do(e,i,n,s):e===429?new Fo(e,i,n,s):e>=500?new Uo(e,i,n,s):new r(e,i,n,s)}},Ie=class extends Fe{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},ss=class extends Fe{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Gr=class extends ss{constructor({message:e}={}){super({message:e??"Request timed out."})}},$o=class extends Fe{},jo=class extends Fe{},Mo=class extends Fe{},zo=class extends Fe{},Lo=class extends Fe{},Do=class extends Fe{},Fo=class extends Fe{},Uo=class extends Fe{},Bo=class extends F{constructor(){super("Could not parse response content as the length limit was reached")}},Vo=class extends F{constructor(){super("Could not parse response content as the request was rejected by the content filter")}};var dd=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ia=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Ht,aa=class{constructor(){Ht.set(this,void 0),this.buffer=new Uint8Array,dd(this,Ht,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;let s=[],i;for(;(i=t1(this.buffer,ia(this,Ht,"f")))!=null;){if(i.carriage&&ia(this,Ht,"f")==null){dd(this,Ht,i.index,"f");continue}if(ia(this,Ht,"f")!=null&&(i.index!==ia(this,Ht,"f")+1||i.carriage)){s.push(this.decodeText(this.buffer.slice(0,ia(this,Ht,"f")-1))),this.buffer=this.buffer.slice(ia(this,Ht,"f")),dd(this,Ht,null,"f");continue}let a=ia(this,Ht,"f")!==null?i.preceding-1:i.preceding,o=this.decodeText(this.buffer.slice(0,a));s.push(o),this.buffer=this.buffer.slice(i.index),dd(this,Ht,null,"f")}return s}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new F(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new F(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new F("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};Ht=new WeakMap;aa.NEWLINE_CHARS=new Set([`
`,"\r"]);aa.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function t1(r,e){for(let s=e??0;s<r.length;s++){if(r[s]===10)return{preceding:s,index:s+1,carriage:!1};if(r[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function ME(r){for(let n=0;n<r.length-1;n++){if(r[n]===10&&r[n+1]===10||r[n]===13&&r[n+1]===13)return n+2;if(r[n]===13&&r[n+1]===10&&n+3<r.length&&r[n+2]===13&&r[n+3]===10)return n+4}return-1}function Yb(r){if(r[Symbol.asyncIterator])return r;let e=r.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var _n=class r{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*s(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(let a of r1(e,t))if(!i){if(a.data.startsWith("[DONE]")){i=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(u){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),u}if(o&&o.error)throw new Fe(void 0,o.error,void 0,Qb(e.headers));yield o}else{let o;try{o=JSON.parse(a.data)}catch(u){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),u}if(a.event=="error")throw new Fe(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new r(s,t)}static fromReadableStream(e,t){let n=!1;async function*s(){let a=new aa,o=Yb(e);for await(let u of o)for(let c of a.decode(u))yield c;for(let u of a.flush())yield u}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(let o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new r(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),s=i=>({next:()=>{if(i.length===0){let a=n.next();e.push(a),t.push(a)}return i.shift()}});return[new r(()=>s(e),this.controller),new r(()=>s(t),this.controller)]}toReadableStream(){let e=this,t,n=new TextEncoder;return new qb({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{let{value:i,done:a}=await t.next();if(a)return s.close();let o=n.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){await t.return?.()}})}};async function*r1(r,e){if(!r.body)throw e.abort(),new F("Attempted to iterate over a response with no body");let t=new Xb,n=new aa,s=Yb(r.body);for await(let i of n1(s))for(let a of n.decode(i)){let o=t.decode(a);o&&(yield o)}for(let i of n.flush()){let a=t.decode(i);a&&(yield a)}}async function*n1(r){let e=new Uint8Array;for await(let t of r){if(t==null)continue;let n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,s=new Uint8Array(e.length+n.length);s.set(e),s.set(n,e.length),e=s;let i;for(;(i=ME(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var Xb=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=s1(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}};function s1(r,e){let t=r.indexOf(e);return t!==-1?[r.substring(0,t),e,r.substring(t+e.length)]:[r,"",""]}var zE=r=>r!=null&&typeof r=="object"&&typeof r.url=="string"&&typeof r.blob=="function",LE=r=>r!=null&&typeof r=="object"&&typeof r.name=="string"&&typeof r.lastModified=="number"&&Yc(r),Yc=r=>r!=null&&typeof r=="object"&&typeof r.size=="number"&&typeof r.type=="string"&&typeof r.text=="function"&&typeof r.slice=="function"&&typeof r.arrayBuffer=="function",i1=r=>LE(r)||zE(r)||Wb(r);async function ry(r,e,t){if(r=await r,LE(r))return r;if(zE(r)){let s=await r.blob();e||(e=new URL(r.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=Yc(s)?[await s.arrayBuffer()]:[s];return new cd(i,e,t)}let n=await a1(r);if(e||(e=u1(r)??"unknown_file"),!t?.type){let s=n[0]?.type;typeof s=="string"&&(t={...t,type:s})}return new cd(n,e,t)}async function a1(r){let e=[];if(typeof r=="string"||ArrayBuffer.isView(r)||r instanceof ArrayBuffer)e.push(r);else if(Yc(r))e.push(await r.arrayBuffer());else if(c1(r))for await(let t of r)e.push(t);else throw new Error(`Unexpected data type: ${typeof r}; constructor: ${r?.constructor?.name}; props: ${o1(r)}`);return e}function o1(r){return`[${Object.getOwnPropertyNames(r).map(t=>`"${t}"`).join(", ")}]`}function u1(r){return ey(r.name)||ey(r.filename)||ey(r.path)?.split(/[\\/]/).pop()}var ey=r=>{if(typeof r=="string")return r;if(typeof Buffer<"u"&&r instanceof Buffer)return String(r)},c1=r=>r!=null&&typeof r=="object"&&typeof r[Symbol.asyncIterator]=="function",ny=r=>r&&typeof r=="object"&&r.body&&r[Symbol.toStringTag]==="MultipartBody";var Bt=async r=>{let e=await DE(r.body);return Kb(e,r)},DE=async r=>{let e=new Zb;return await Promise.all(Object.entries(r||{}).map(([t,n])=>ty(e,t,n))),e};var ty=async(r,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")r.append(e,String(t));else if(i1(t)){let n=await ry(t);r.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>ty(r,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,s])=>ty(r,`${e}[${n}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var f1=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},p1=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},hd;Jb();async function ZE(r){let{response:e}=r;if(r.options.stream)return is("response",e.status,e.url,e.headers,e.body),r.options.__streamClass?r.options.__streamClass.fromSSEResponse(e,r.controller):_n.fromSSEResponse(e,r.controller);if(e.status===204)return null;if(r.options.__binaryResponse)return e;let n=e.headers.get("content-type")?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){let a=await e.json();return is("response",e.status,e.url,e.headers,a),qE(a,e)}let i=await e.text();return is("response",e.status,e.url,e.headers,i),i}function qE(r,e){return!r||typeof r!="object"||Array.isArray(r)?r:Object.defineProperty(r,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var gd=class r extends Promise{constructor(e,t=ZE){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new r(this.responsePromise,async t=>qE(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},bd=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=sy("maxRetries",t),this.timeout=sy("timeout",n),this.httpAgent=s,this.fetch=i??Gb}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...g1(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${w1()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async s=>{let i=s&&Yc(s?.body)?new DataView(await s.body.arrayBuffer()):s?.body instanceof DataView?s.body:s?.body instanceof ArrayBuffer?new DataView(s.body):s&&ArrayBuffer.isView(s?.body)?new DataView(s.body.buffer):s?.body;return{method:e,path:t,...s,body:i}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let n={...e},{method:s,path:i,query:a,headers:o={}}=n,u=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:ny(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(u),l=this.buildURL(i,a);"timeout"in n&&sy("timeout",n.timeout),n.timeout=n.timeout??this.timeout;let f=n.httpAgent??this.httpAgent??Hb(l),p=n.timeout+1e3;typeof f?.options?.timeout=="number"&&p>(f.options.timeout??0)&&(f.options.timeout=p),this.idempotencyHeader&&s!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);let d=this.buildHeaders({options:n,headers:o,contentLength:c,retryCount:t});return{req:{method:s,...u&&{body:u},headers:d,...f&&{agent:f},signal:n.signal??null},url:l,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:s}){let i={};n&&(i["content-length"]=n);let a=this.defaultHeaders(e);return VE(i,a),VE(i,t),ny(e.body)&&sa!=="node"&&delete i["content-type"],md(a,"x-stainless-retry-count")===void 0&&md(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(s)),md(a,"x-stainless-timeout")===void 0&&md(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,s){return Fe.generate(e,t,n,s)}request(e,t=null){return new gd(this.makeRequest(e,t))}async makeRequest(e,t){let n=await e,s=n.maxRetries??this.maxRetries;t==null&&(t=s),await this.prepareOptions(n);let{req:i,url:a,timeout:o}=this.buildRequest(n,{retryCount:s-t});if(await this.prepareRequest(i,{url:a,options:n}),is("request",a,n,i.headers),n.signal?.aborted)throw new Ie;let u=new AbortController,c=await this.fetchWithTimeout(a,i,o,u).catch(pd);if(c instanceof Error){if(n.signal?.aborted)throw new Ie;if(t)return this.retryRequest(n,t);throw c.name==="AbortError"?new Gr:new ss({cause:c})}let l=Qb(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){let g=`retrying, ${t} attempts remaining`;return is(`response (error; ${g})`,c.status,a,l),this.retryRequest(n,t,l)}let f=await c.text().catch(g=>pd(g).message),p=b1(f),d=p?void 0:f;throw is(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,l,d),this.makeStatusError(c.status,p,d,l)}return{response:c,options:n,controller:u}}requestAPIList(e,t){let n=this.makeRequest(t,null);return new iy(this,n,e)}buildURL(e,t){let n=_1(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return KE(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new F(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,s){let{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());let o=setTimeout(()=>s.abort(),n),u={signal:s.signal,...a};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let s,i=n?.["retry-after-ms"];if(i){let o=parseFloat(i);Number.isNaN(o)||(s=o)}let a=n?.["retry-after"];if(a&&!s){let o=parseFloat(a);Number.isNaN(o)?s=Date.parse(a)-Date.now():s=o*1e3}if(!(s&&0<=s&&s<60*1e3)){let o=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,o)}return await as(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${na}`}},Xc=class{constructor(e,t,n,s){hd.set(this,void 0),f1(this,hd,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new F("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[s,i]of n)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await p1(this,hd,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(hd=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},iy=class extends gd{constructor(e,t,n){super(t,async s=>new n(e,s.response,await ZE(s),s.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},Qb=r=>new Proxy(Object.fromEntries(r.entries()),{get(e,t){let n=t.toString();return e[n.toLowerCase()]||e[n]}}),d1={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ne=r=>typeof r=="object"&&r!==null&&!KE(r)&&Object.keys(r).every(e=>HE(d1,e)),h1=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":na,"X-Stainless-OS":UE(Deno.build.os),"X-Stainless-Arch":FE(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":na,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":na,"X-Stainless-OS":UE(process.platform),"X-Stainless-Arch":FE(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let r=m1();return r?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":na,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${r.browser}`,"X-Stainless-Runtime-Version":r.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":na,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function m1(){if(typeof navigator>"u"||!navigator)return null;let r=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of r){let n=t.exec(navigator.userAgent);if(n){let s=n[1]||0,i=n[2]||0,a=n[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}var FE=r=>r==="x32"?"x32":r==="x86_64"||r==="x64"?"x64":r==="arm"?"arm":r==="aarch64"||r==="arm64"?"arm64":r?`other:${r}`:"unknown",UE=r=>(r=r.toLowerCase(),r.includes("ios")?"iOS":r==="android"?"Android":r==="darwin"?"MacOS":r==="win32"?"Windows":r==="freebsd"?"FreeBSD":r==="openbsd"?"OpenBSD":r==="linux"?"Linux":r?`Other:${r}`:"Unknown"),BE,g1=()=>BE??(BE=h1()),b1=r=>{try{return JSON.parse(r)}catch{return}},y1=/^[a-z][a-z0-9+.-]*:/i,_1=r=>y1.test(r),as=r=>new Promise(e=>setTimeout(e,r)),sy=(r,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new F(`${r} must be an integer`);if(e<0)throw new F(`${r} must be a positive integer`);return e},pd=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(r)};var Qc=r=>{if(typeof process<"u")return process.env?.[r]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(r)?.trim()};function KE(r){if(!r)return!0;for(let e in r)return!1;return!0}function HE(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function VE(r,e){for(let t in e){if(!HE(e,t))continue;let n=t.toLowerCase();if(!n)continue;let s=e[t];s===null?delete r[n]:s!==void 0&&(r[n]=s)}}var GE=new Set(["authorization","api-key"]);function is(r,...e){if(typeof process<"u"&&process?.env?.DEBUG==="true"){let t=e.map(n=>{if(!n)return n;if(n.headers){let i={...n,headers:{...n.headers}};for(let a in n.headers)GE.has(a.toLowerCase())&&(i.headers[a]="REDACTED");return i}let s=null;for(let i in n)GE.has(i.toLowerCase())&&(s??(s={...n}),s[i]="REDACTED");return s??n});console.log(`OpenAI:DEBUG:${r}`,...t)}}var w1=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),WE=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",v1=r=>typeof r?.get=="function";var md=(r,e)=>{let t=e.toLowerCase();if(v1(r)){let n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(s,i,a)=>i+a.toUpperCase());for(let s of[e,t,e.toUpperCase(),n]){let i=r.get(s);if(i)return i}}for(let[n,s]of Object.entries(r))if(n.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};var JE=r=>{if(typeof Buffer<"u"){let e=Buffer.from(r,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{let e=atob(r),t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return Array.from(new Float32Array(n.buffer))}};function el(r){return r!=null&&typeof r=="object"&&!Array.isArray(r)}var wn=class extends Xc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},ce=class extends Xc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}};var E=class{constructor(e){this._client=e}};var Go=class extends E{list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,yd,{query:t,...n})}};var Us=class extends E{constructor(){super(...arguments),this.messages=new Go(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/chat/completions",Bs,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}},Bs=class extends ce{},yd=class extends ce{};Us.ChatCompletionsPage=Bs;Us.Messages=Go;var us=class extends E{constructor(){super(...arguments),this.completions=new Us(this._client)}};us.Completions=Us;us.ChatCompletionsPage=Bs;var Zo=class extends E{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}};var qo=class extends E{create(e,t){return this._client.post("/audio/transcriptions",Bt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}};var Ko=class extends E{create(e,t){return this._client.post("/audio/translations",Bt({body:e,...t,__metadata:{model:e.model}}))}};var vn=class extends E{constructor(){super(...arguments),this.transcriptions=new qo(this._client),this.translations=new Ko(this._client),this.speech=new Zo(this._client)}};vn.Transcriptions=qo;vn.Translations=Ko;vn.Speech=Zo;var Vs=class extends E{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/batches",oa,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},oa=class extends ce{};Vs.BatchesPage=oa;var Zr=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Te=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},ay,_d,wd,tl,rl,vd,nl,cs,sl,xd,Ad,Ho,YE,Gs=class{constructor(){ay.add(this),this.controller=new AbortController,_d.set(this,void 0),wd.set(this,()=>{}),tl.set(this,()=>{}),rl.set(this,void 0),vd.set(this,()=>{}),nl.set(this,()=>{}),cs.set(this,{}),sl.set(this,!1),xd.set(this,!1),Ad.set(this,!1),Ho.set(this,!1),Zr(this,_d,new Promise((e,t)=>{Zr(this,wd,e,"f"),Zr(this,tl,t,"f")}),"f"),Zr(this,rl,new Promise((e,t)=>{Zr(this,vd,e,"f"),Zr(this,nl,t,"f")}),"f"),Te(this,_d,"f").catch(()=>{}),Te(this,rl,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},Te(this,ay,"m",YE).bind(this))},0)}_connected(){this.ended||(Te(this,wd,"f").call(this),this._emit("connect"))}get ended(){return Te(this,sl,"f")}get errored(){return Te(this,xd,"f")}get aborted(){return Te(this,Ad,"f")}abort(){this.controller.abort()}on(e,t){return(Te(this,cs,"f")[e]||(Te(this,cs,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=Te(this,cs,"f")[e];if(!n)return this;let s=n.findIndex(i=>i.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(Te(this,cs,"f")[e]||(Te(this,cs,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Zr(this,Ho,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Zr(this,Ho,!0,"f"),await Te(this,rl,"f")}_emit(e,...t){if(Te(this,sl,"f"))return;e==="end"&&(Zr(this,sl,!0,"f"),Te(this,vd,"f").call(this));let n=Te(this,cs,"f")[e];if(n&&(Te(this,cs,"f")[e]=n.filter(s=>!s.once),n.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!Te(this,Ho,"f")&&!n?.length&&Promise.reject(s),Te(this,tl,"f").call(this,s),Te(this,nl,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!Te(this,Ho,"f")&&!n?.length&&Promise.reject(s),Te(this,tl,"f").call(this,s),Te(this,nl,"f").call(this,s),this._emit("end")}}_emitFinal(){}};_d=new WeakMap,wd=new WeakMap,tl=new WeakMap,rl=new WeakMap,vd=new WeakMap,nl=new WeakMap,cs=new WeakMap,sl=new WeakMap,xd=new WeakMap,Ad=new WeakMap,Ho=new WeakMap,ay=new WeakSet,YE=function(e){if(Zr(this,xd,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Ie),e instanceof Ie)return Zr(this,Ad,!0,"f"),this._emit("abort",e);if(e instanceof F)return this._emit("error",e);if(e instanceof Error){let t=new F(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new F(String(e)))};var G=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Wt=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},ot,oy,xn,Ed,qr,ca,Wo,ua,Sd,Jt,Od,Pd,ol,il,al,XE,QE,eO,tO,rO,nO,sO,An=class r extends Gs{constructor(){super(...arguments),ot.add(this),oy.set(this,[]),xn.set(this,{}),Ed.set(this,{}),qr.set(this,void 0),ca.set(this,void 0),Wo.set(this,void 0),ua.set(this,void 0),Sd.set(this,void 0),Jt.set(this,void 0),Od.set(this,void 0),Pd.set(this,void 0),ol.set(this,void 0)}[(oy=new WeakMap,xn=new WeakMap,Ed=new WeakMap,qr=new WeakMap,ca=new WeakMap,Wo=new WeakMap,ua=new WeakMap,Sd=new WeakMap,Jt=new WeakMap,Od=new WeakMap,Pd=new WeakMap,ol=new WeakMap,ot=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("event",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new r;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();let s=_n.fromReadableStream(e,this.controller);for await(let i of s)G(this,ot,"m",il).call(this,i);if(s.controller.signal?.aborted)throw new Ie;return this._addRun(G(this,ot,"m",al).call(this))}toReadableStream(){return new _n(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s,i){let a=new r;return a._run(()=>a._runToolAssistantStream(e,t,n,s,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,s,i){let a=i?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let o={...s,stream:!0},u=await e.submitToolOutputs(t,n,o,{...i,signal:this.controller.signal});this._connected();for await(let c of u)G(this,ot,"m",il).call(this,c);if(u.controller.signal?.aborted)throw new Ie;return this._addRun(G(this,ot,"m",al).call(this))}static createThreadAssistantStream(e,t,n){let s=new r;return s._run(()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,n,s){let i=new r;return i._run(()=>i._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return G(this,Od,"f")}currentRun(){return G(this,Pd,"f")}currentMessageSnapshot(){return G(this,qr,"f")}currentRunStepSnapshot(){return G(this,ol,"f")}async finalRunSteps(){return await this.done(),Object.values(G(this,xn,"f"))}async finalMessages(){return await this.done(),Object.values(G(this,Ed,"f"))}async finalRun(){if(await this.done(),!G(this,ca,"f"))throw Error("Final run was not received.");return G(this,ca,"f")}async _createThreadAssistantStream(e,t,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},a=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(let o of a)G(this,ot,"m",il).call(this,o);if(a.controller.signal?.aborted)throw new Ie;return this._addRun(G(this,ot,"m",al).call(this))}async _createAssistantStream(e,t,n,s){let i=s?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...n,stream:!0},o=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(let u of o)G(this,ot,"m",il).call(this,u);if(o.controller.signal?.aborted)throw new Ie;return this._addRun(G(this,ot,"m",al).call(this))}static accumulateDelta(e,t){for(let[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let i=e[n];if(i==null){e[n]=s;continue}if(n==="index"||n==="type"){e[n]=s;continue}if(typeof i=="string"&&typeof s=="string")i+=s;else if(typeof i=="number"&&typeof s=="number")i+=s;else if(el(i)&&el(s))i=this.accumulateDelta(i,s);else if(Array.isArray(i)&&Array.isArray(s)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...s);continue}for(let a of s){if(!el(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);let o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let u=i[o];u==null?i.push(a):i[o]=this.accumulateDelta(u,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${i}`);e[n]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s,i){return await this._createToolAssistantStream(n,e,t,s,i)}};il=function(e){if(!this.ended)switch(Wt(this,Od,e,"f"),G(this,ot,"m",eO).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":G(this,ot,"m",sO).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":G(this,ot,"m",QE).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":G(this,ot,"m",XE).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},al=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");if(!G(this,ca,"f"))throw Error("Final run has not been received");return G(this,ca,"f")},XE=function(e){let[t,n]=G(this,ot,"m",rO).call(this,e,G(this,qr,"f"));Wt(this,qr,t,"f"),G(this,Ed,"f")[t.id]=t;for(let s of n){let i=t.content[s.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let s of e.data.delta.content){if(s.type=="text"&&s.text){let i=s.text,a=t.content[s.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=G(this,Wo,"f")){if(G(this,ua,"f"))switch(G(this,ua,"f").type){case"text":this._emit("textDone",G(this,ua,"f").text,G(this,qr,"f"));break;case"image_file":this._emit("imageFileDone",G(this,ua,"f").image_file,G(this,qr,"f"));break}Wt(this,Wo,s.index,"f")}Wt(this,ua,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(G(this,Wo,"f")!==void 0){let s=e.data.content[G(this,Wo,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,G(this,qr,"f"));break;case"text":this._emit("textDone",s.text,G(this,qr,"f"));break}}G(this,qr,"f")&&this._emit("messageDone",e.data),Wt(this,qr,void 0,"f")}},QE=function(e){let t=G(this,ot,"m",tO).call(this,e);switch(Wt(this,ol,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let i of n.step_details.tool_calls)i.index==G(this,Sd,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(G(this,Jt,"f")&&this._emit("toolCallDone",G(this,Jt,"f")),Wt(this,Sd,i.index,"f"),Wt(this,Jt,t.step_details.tool_calls[i.index],"f"),G(this,Jt,"f")&&this._emit("toolCallCreated",G(this,Jt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Wt(this,ol,void 0,"f"),e.data.step_details.type=="tool_calls"&&G(this,Jt,"f")&&(this._emit("toolCallDone",G(this,Jt,"f")),Wt(this,Jt,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},eO=function(e){G(this,oy,"f").push(e),this._emit("event",e)},tO=function(e){switch(e.event){case"thread.run.step.created":return G(this,xn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=G(this,xn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){let s=An.accumulateDelta(t,n.delta);G(this,xn,"f")[e.data.id]=s}return G(this,xn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":G(this,xn,"f")[e.data.id]=e.data;break}if(G(this,xn,"f")[e.data.id])return G(this,xn,"f")[e.data.id];throw new Error("No snapshot available")},rO=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(let i of s.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=G(this,ot,"m",nO).call(this,i,a)}else t.content[i.index]=i,n.push(i);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},nO=function(e,t){return An.accumulateDelta(t,e)},sO=function(e){switch(Wt(this,Pd,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Wt(this,ca,e.data,"f"),G(this,Jt,"f")&&(this._emit("toolCallDone",G(this,Jt,"f")),Wt(this,Jt,void 0,"f"));break;case"thread.run.cancelling":break}};var la=class extends E{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/assistants",Jo,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Jo=class extends ce{};la.AssistantsPage=Jo;function uy(r){return typeof r.parse=="function"}var Zs=r=>r?.role==="assistant",cy=r=>r?.role==="function",ly=r=>r?.role==="tool";function iO(r,e){let t={...r};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function ul(r){return r?.$brand==="auto-parseable-response-format"}function aO(r,{parser:e,callback:t}){let n={...r};return Object.defineProperties(n,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),n}function fa(r){return r?.$brand==="auto-parseable-tool"}function oO(r,e){return!e||!fy(e)?{...r,choices:r.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:cl(r,e)}function cl(r,e){let t=r.choices.map(n=>{if(n.finish_reason==="length")throw new Bo;if(n.finish_reason==="content_filter")throw new Vo;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:n.message.tool_calls?.map(s=>T1(e,s))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?I1(e,n.message.content):null}}});return{...r,choices:t}}function I1(r,e){return r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(e):JSON.parse(e):null}function T1(r,e){let t=r.tools?.find(n=>n.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:fa(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function uO(r,e){if(!r)return!1;let t=r.tools?.find(n=>n.function?.name===e.function.name);return fa(t)||t?.function.strict||!1}function fy(r){return ul(r.response_format)?!0:r.tools?.some(e=>fa(e)||e.type==="function"&&e.function.strict===!0)??!1}function cO(r){for(let e of r??[]){if(e.type!=="function")throw new F(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new F(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Vt=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},wt,py,Id,dy,hy,my,fO,gy,lO=10,Yo=class extends Gs{constructor(){super(...arguments),wt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(cy(e)||ly(e))&&e.content)this._emit("functionCallResult",e.content);else if(Zs(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Zs(e)&&e.tool_calls)for(let n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new F("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Vt(this,wt,"m",py).call(this)}async finalMessage(){return await this.done(),Vt(this,wt,"m",Id).call(this)}async finalFunctionCall(){return await this.done(),Vt(this,wt,"m",dy).call(this)}async finalFunctionCallResult(){return await this.done(),Vt(this,wt,"m",hy).call(this)}async totalUsage(){return await this.done(),Vt(this,wt,"m",my).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=Vt(this,wt,"m",Id).call(this);t&&this._emit("finalMessage",t);let n=Vt(this,wt,"m",py).call(this);n&&this._emit("finalContent",n);let s=Vt(this,wt,"m",dy).call(this);s&&this._emit("finalFunctionCall",s);let i=Vt(this,wt,"m",hy).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",Vt(this,wt,"m",my).call(this))}async _createChatCompletion(e,t,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Vt(this,wt,"m",fO).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(cl(i,t))}async _runChatCompletion(e,t,n){for(let s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){let s="function",{function_call:i="auto",stream:a,...o}=t,u=typeof i!="string"&&i?.name,{maxChatCompletions:c=lO}=n||{},l={};for(let p of t.functions)l[p.name||p.function.name]=p;let f=t.functions.map(p=>({name:p.name||p.function.name,parameters:p.parameters,description:p.description}));for(let p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){let h=(await this._createChatCompletion(e,{...o,function_call:i,functions:f,messages:[...this.messages]},n)).choices[0]?.message;if(!h)throw new F("missing message in ChatCompletion response");if(!h.function_call)return;let{name:m,arguments:g}=h.function_call,y=l[m];if(y){if(u&&u!==m){let A=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:m,content:A});continue}}else{let A=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${f.map(P=>JSON.stringify(P.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:A});continue}let b;try{b=uy(y)?await y.parse(g):g}catch(A){this._addMessage({role:s,name:m,content:A instanceof Error?A.message:String(A)});continue}let w=await y.function(b,this),x=Vt(this,wt,"m",gy).call(this,w);if(this._addMessage({role:s,name:m,content:x}),u)return}}async _runTools(e,t,n){let s="tool",{tool_choice:i="auto",stream:a,...o}=t,u=typeof i!="string"&&i?.function?.name,{maxChatCompletions:c=lO}=n||{},l=t.tools.map(d=>{if(fa(d)){if(!d.$callback)throw new F("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:d.$callback,name:d.function.name,description:d.function.description||"",parameters:d.function.parameters,parse:d.$parseRaw,strict:!0}}}return d}),f={};for(let d of l)d.type==="function"&&(f[d.function.name||d.function.function.name]=d.function);let p="tools"in t?l.map(d=>d.type==="function"?{type:"function",function:{name:d.function.name||d.function.function.name,parameters:d.function.parameters,description:d.function.description,strict:d.function.strict}}:d):void 0;for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<c;++d){let m=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:p,messages:[...this.messages]},n)).choices[0]?.message;if(!m)throw new F("missing message in ChatCompletion response");if(!m.tool_calls?.length)return;for(let g of m.tool_calls){if(g.type!=="function")continue;let y=g.id,{name:b,arguments:w}=g.function,x=f[b];if(x){if(u&&u!==b){let N=`Invalid tool_call: ${JSON.stringify(b)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:y,content:N});continue}}else{let N=`Invalid tool_call: ${JSON.stringify(b)}. Available options are: ${Object.keys(f).map(I=>JSON.stringify(I)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:y,content:N});continue}let A;try{A=uy(x)?await x.parse(w):w}catch(N){let I=N instanceof Error?N.message:String(N);this._addMessage({role:s,tool_call_id:y,content:I});continue}let P=await x.function(A,this),M=Vt(this,wt,"m",gy).call(this,P);if(this._addMessage({role:s,tool_call_id:y,content:M}),u)return}}}};wt=new WeakSet,py=function(){return Vt(this,wt,"m",Id).call(this).content??null},Id=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(Zs(t)){let{function_call:n,...s}=t,i={...s,content:t.content??null,refusal:t.refusal??null};return n&&(i.function_call=n),i}}throw new F("stream ended without producing a ChatCompletionMessage with role=assistant")},dy=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Zs(t)&&t?.function_call)return t.function_call;if(Zs(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},hy=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(cy(t)&&t.content!=null||ly(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>n.role==="assistant"&&n.tool_calls?.some(s=>s.type==="function"&&s.id===t.tool_call_id)))return t.content}},my=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},fO=function(e){if(e.n!=null&&e.n>1)throw new F("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},gy=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var ll=class r extends Yo{static runFunctions(e,t,n){let s=new r,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,n){let s=new r,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e,t=!0){super._addMessage(e,t),Zs(e)&&e.content&&this._emit("content",e.content)}};var et={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},by=class extends Error{},yy=class extends Error{};function k1(r,e=et.ALL){if(typeof r!="string")throw new TypeError(`expecting str, got ${typeof r}`);if(!r.trim())throw new Error(`${r} is empty`);return C1(r.trim(),e)}var C1=(r,e)=>{let t=r.length,n=0,s=p=>{throw new by(`${p} at position ${n}`)},i=p=>{throw new yy(`${p} at position ${n}`)},a=()=>(f(),n>=t&&s("Unexpected end of input"),r[n]==='"'?o():r[n]==="{"?u():r[n]==="["?c():r.substring(n,n+4)==="null"||et.NULL&e&&t-n<4&&"null".startsWith(r.substring(n))?(n+=4,null):r.substring(n,n+4)==="true"||et.BOOL&e&&t-n<4&&"true".startsWith(r.substring(n))?(n+=4,!0):r.substring(n,n+5)==="false"||et.BOOL&e&&t-n<5&&"false".startsWith(r.substring(n))?(n+=5,!1):r.substring(n,n+8)==="Infinity"||et.INFINITY&e&&t-n<8&&"Infinity".startsWith(r.substring(n))?(n+=8,1/0):r.substring(n,n+9)==="-Infinity"||et.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(r.substring(n))?(n+=9,-1/0):r.substring(n,n+3)==="NaN"||et.NAN&e&&t-n<3&&"NaN".startsWith(r.substring(n))?(n+=3,NaN):l()),o=()=>{let p=n,d=!1;for(n++;n<t&&(r[n]!=='"'||d&&r[n-1]==="\\");)d=r[n]==="\\"?!d:!1,n++;if(r.charAt(n)=='"')try{return JSON.parse(r.substring(p,++n-Number(d)))}catch(h){i(String(h))}else if(et.STR&e)try{return JSON.parse(r.substring(p,n-Number(d))+'"')}catch{return JSON.parse(r.substring(p,r.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},u=()=>{n++,f();let p={};try{for(;r[n]!=="}";){if(f(),n>=t&&et.OBJ&e)return p;let d=o();f(),n++;try{let h=a();Object.defineProperty(p,d,{value:h,writable:!0,enumerable:!0,configurable:!0})}catch(h){if(et.OBJ&e)return p;throw h}f(),r[n]===","&&n++}}catch{if(et.OBJ&e)return p;s("Expected '}' at end of object")}return n++,p},c=()=>{n++;let p=[];try{for(;r[n]!=="]";)p.push(a()),f(),r[n]===","&&n++}catch{if(et.ARR&e)return p;s("Expected ']' at end of array")}return n++,p},l=()=>{if(n===0){r==="-"&&et.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(r)}catch(d){if(et.NUM&e)try{return r[r.length-1]==="."?JSON.parse(r.substring(0,r.lastIndexOf("."))):JSON.parse(r.substring(0,r.lastIndexOf("e")))}catch{}i(String(d))}}let p=n;for(r[n]==="-"&&n++;r[n]&&!",]}".includes(r[n]);)n++;n==t&&!(et.NUM&e)&&s("Unterminated number literal");try{return JSON.parse(r.substring(p,n))}catch{r.substring(p,n)==="-"&&et.NUM&e&&s("Not sure what '-' is");try{return JSON.parse(r.substring(p,r.lastIndexOf("e")))}catch(h){i(String(h))}}},f=()=>{for(;n<t&&` 
\r	`.includes(r[n]);)n++};return a()},_y=r=>k1(r,et.ALL^et.NUM);var Xo=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},_e=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},He,ls,Qo,qs,wy,Td,vy,xy,Ay,kd,Ey,pO,eu=class r extends Yo{constructor(e){super(),He.add(this),ls.set(this,void 0),Qo.set(this,void 0),qs.set(this,void 0),Xo(this,ls,e,"f"),Xo(this,Qo,[],"f")}get currentChatCompletionSnapshot(){return _e(this,qs,"f")}static fromReadableStream(e){let t=new r(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){let s=new r(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,n){super._createChatCompletion;let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),_e(this,He,"m",wy).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(let a of i)_e(this,He,"m",vy).call(this,a);if(i.controller.signal?.aborted)throw new Ie;return this._addChatCompletion(_e(this,He,"m",kd).call(this))}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),_e(this,He,"m",wy).call(this),this._connected();let s=_n.fromReadableStream(e,this.controller),i;for await(let a of s)i&&i!==a.id&&this._addChatCompletion(_e(this,He,"m",kd).call(this)),_e(this,He,"m",vy).call(this,a),i=a.id;if(s.controller.signal?.aborted)throw new Ie;return this._addChatCompletion(_e(this,He,"m",kd).call(this))}[(ls=new WeakMap,Qo=new WeakMap,qs=new WeakMap,He=new WeakSet,wy=function(){this.ended||Xo(this,qs,void 0,"f")},Td=function(t){let n=_e(this,Qo,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},_e(this,Qo,"f")[t.index]=n,n)},vy=function(t){if(this.ended)return;let n=_e(this,He,"m",pO).call(this,t);this._emit("chunk",t,n);for(let s of t.choices){let i=n.choices[s.index];s.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",s.delta.content,i.message.content),this._emit("content.delta",{delta:s.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),s.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:s.delta.refusal,snapshot:i.message.refusal}),s.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:s.logprobs?.content,snapshot:i.logprobs?.content??[]}),s.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:s.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});let a=_e(this,He,"m",Td).call(this,i);i.finish_reason&&(_e(this,He,"m",Ay).call(this,i),a.current_tool_call_index!=null&&_e(this,He,"m",xy).call(this,i,a.current_tool_call_index));for(let o of s.delta.tool_calls??[])a.current_tool_call_index!==o.index&&(_e(this,He,"m",Ay).call(this,i),a.current_tool_call_index!=null&&_e(this,He,"m",xy).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=o.index;for(let o of s.delta.tool_calls??[]){let u=i.message.tool_calls?.[o.index];u?.type&&(u?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:u.function?.name,index:o.index,arguments:u.function.arguments,parsed_arguments:u.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(u?.type,void 0))}}},xy=function(t,n){if(_e(this,He,"m",Td).call(this,t).done_tool_calls.has(n))return;let i=t.message.tool_calls?.[n];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){let a=_e(this,ls,"f")?.tools?.find(o=>o.type==="function"&&o.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:n,arguments:i.function.arguments,parsed_arguments:fa(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Ay=function(t){let n=_e(this,He,"m",Td).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;let s=_e(this,He,"m",Ey).call(this);this._emit("content.done",{content:t.message.content,parsed:s?s.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},kd=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");let t=_e(this,qs,"f");if(!t)throw new F("request ended without sending any chunks");return Xo(this,qs,void 0,"f"),Xo(this,Qo,[],"f"),R1(t,_e(this,ls,"f"))},Ey=function(){let t=_e(this,ls,"f")?.response_format;return ul(t)?t:null},pO=function(t){var n,s,i,a;let o=_e(this,qs,"f"),{choices:u,...c}=t;o?Object.assign(o,c):o=Xo(this,qs,{...c,choices:[]},"f");for(let{delta:l,finish_reason:f,index:p,logprobs:d=null,...h}of t.choices){let m=o.choices[p];if(m||(m=o.choices[p]={finish_reason:f,index:p,message:{},logprobs:d,...h}),d)if(!m.logprobs)m.logprobs=Object.assign({},d);else{let{content:P,refusal:M,...N}=d;Object.assign(m.logprobs,N),P&&((n=m.logprobs).content??(n.content=[]),m.logprobs.content.push(...P)),M&&((s=m.logprobs).refusal??(s.refusal=[]),m.logprobs.refusal.push(...M))}if(f&&(m.finish_reason=f,_e(this,ls,"f")&&fy(_e(this,ls,"f")))){if(f==="length")throw new Bo;if(f==="content_filter")throw new Vo}if(Object.assign(m,h),!l)continue;let{content:g,refusal:y,function_call:b,role:w,tool_calls:x,...A}=l;if(Object.assign(m.message,A),y&&(m.message.refusal=(m.message.refusal||"")+y),w&&(m.message.role=w),b&&(m.message.function_call?(b.name&&(m.message.function_call.name=b.name),b.arguments&&((i=m.message.function_call).arguments??(i.arguments=""),m.message.function_call.arguments+=b.arguments)):m.message.function_call=b),g&&(m.message.content=(m.message.content||"")+g,!m.message.refusal&&_e(this,He,"m",Ey).call(this)&&(m.message.parsed=_y(m.message.content))),x){m.message.tool_calls||(m.message.tool_calls=[]);for(let{index:P,id:M,type:N,function:I,...S}of x){let C=(a=m.message.tool_calls)[P]??(a[P]={});Object.assign(C,S),M&&(C.id=M),N&&(C.type=N),I&&(C.function??(C.function={name:I.name??"",arguments:""})),I?.name&&(C.function.name=I.name),I?.arguments&&(C.function.arguments+=I.arguments,uO(_e(this,ls,"f"),C)&&(C.function.parsed_arguments=_y(C.function.arguments)))}}}return o},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("chunk",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new _n(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function R1(r,e){let{id:t,choices:n,created:s,model:i,system_fingerprint:a,...o}=r,u={...o,id:t,choices:n.map(({message:c,finish_reason:l,index:f,logprobs:p,...d})=>{if(!l)throw new F(`missing finish_reason for choice ${f}`);let{content:h=null,function_call:m,tool_calls:g,...y}=c,b=c.role;if(!b)throw new F(`missing role for choice ${f}`);if(m){let{arguments:w,name:x}=m;if(w==null)throw new F(`missing function_call.arguments for choice ${f}`);if(!x)throw new F(`missing function_call.name for choice ${f}`);return{...d,message:{content:h,function_call:{arguments:w,name:x},role:b,refusal:c.refusal??null},finish_reason:l,index:f,logprobs:p}}return g?{...d,index:f,finish_reason:l,logprobs:p,message:{...y,role:b,content:h,refusal:c.refusal??null,tool_calls:g.map((w,x)=>{let{function:A,type:P,id:M,...N}=w,{arguments:I,name:S,...C}=A||{};if(M==null)throw new F(`missing choices[${f}].tool_calls[${x}].id
${Cd(r)}`);if(P==null)throw new F(`missing choices[${f}].tool_calls[${x}].type
${Cd(r)}`);if(S==null)throw new F(`missing choices[${f}].tool_calls[${x}].function.name
${Cd(r)}`);if(I==null)throw new F(`missing choices[${f}].tool_calls[${x}].function.arguments
${Cd(r)}`);return{...N,id:M,type:P,function:{...C,name:S,arguments:I}}})}}:{...d,message:{...y,content:h,role:b,refusal:c.refusal??null},finish_reason:l,index:f,logprobs:p}}),created:s,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return oO(u,e)}function Cd(r){return JSON.stringify(r)}var fl=class r extends eu{static fromReadableStream(e){let t=new r(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){let s=new r(null),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,n){let s=new r(t),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}};var pl=class extends E{parse(e,t){return cO(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>cl(n,e))}runFunctions(e,t){return e.stream?fl.runFunctions(this._client,e,t):ll.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?fl.runTools(this._client,e,t):ll.runTools(this._client,e,t)}stream(e,t){return eu.createChatCompletion(this._client,e,t)}};var tu=class extends E{constructor(){super(...arguments),this.completions=new pl(this._client)}};(function(r){r.Completions=pl})(tu||(tu={}));var ru=class extends E{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}};var nu=class extends E{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}};var Ks=class extends E{constructor(){super(...arguments),this.sessions=new ru(this._client),this.transcriptionSessions=new nu(this._client)}};Ks.Sessions=ru;Ks.TranscriptionSessions=nu;var pa=class extends E{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,su,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}},su=class extends ce{};pa.MessagesPage=su;var da=class extends E{retrieve(e,t,n,s={},i){return ne(s)?this.retrieve(e,t,n,{},s):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:s,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,n={},s){return ne(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,iu,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}},iu=class extends ce{};da.RunStepsPage=iu;var fs=class extends E{constructor(){super(...arguments),this.steps=new da(this._client)}create(e,t,n){let{include:s,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:s},body:i,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,au,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let s=await this.create(e,t,n);return await this.poll(e,s.id,n)}createAndStream(e,t,n){return An.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:i,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=a.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await as(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,n){return An.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,s){let i=await this.submitToolOutputs(e,t,n,s);return await this.poll(e,i.id,s)}submitToolOutputsStream(e,t,n,s){return An.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,s)}},au=class extends ce{};fs.RunsPage=au;fs.Steps=da;fs.RunStepsPage=iu;var En=class extends E{constructor(){super(...arguments),this.runs=new fs(this._client),this.messages=new pa(this._client)}create(e={},t){return ne(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return An.createThreadAssistantStream(e,this._client.beta.threads,t)}};En.Runs=fs;En.RunsPage=au;En.Messages=pa;En.MessagesPage=su;var Kr=class extends E{constructor(){super(...arguments),this.realtime=new Ks(this._client),this.chat=new tu(this._client),this.assistants=new la(this._client),this.threads=new En(this._client)}};Kr.Realtime=Ks;Kr.Assistants=la;Kr.AssistantsPage=Jo;Kr.Threads=En;var ha=class extends E{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};var ou=class extends E{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n?.headers},__binaryResponse:!0})}};var Hs=class extends E{constructor(){super(...arguments),this.content=new ou(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,Bt({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,uu,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n?.headers}})}},uu=class extends ce{};Hs.FileListResponsesPage=uu;Hs.Content=ou;var On=class extends E{constructor(){super(...arguments),this.files=new Hs(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/containers",ma,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}},ma=class extends ce{};On.ContainerListResponsesPage=ma;On.Files=Hs;On.FileListResponsesPage=uu;var ga=class extends E{create(e,t){let n=!!e.encoding_format,s=n?e.encoding_format:"base64";n&&is("Request","User defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return n?i:(is("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{let u=o.embedding;o.embedding=JE(u)}),a)))}};var ba=class extends E{retrieve(e,t,n,s){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,s)}list(e,t,n={},s){return ne(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,cu,{query:n,...s})}},cu=class extends ce{};ba.OutputItemListResponsesPage=cu;var ps=class extends E{constructor(){super(...arguments),this.outputItems=new ba(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,lu,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}},lu=class extends ce{};ps.RunListResponsesPage=lu;ps.OutputItems=ba;ps.OutputItemListResponsesPage=cu;var Pn=class extends E{constructor(){super(...arguments),this.runs=new ps(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/evals",ya,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}},ya=class extends ce{};Pn.EvalListResponsesPage=ya;Pn.Runs=ps;Pn.RunListResponsesPage=lu;var Ws=class extends E{create(e,t){return this._client.post("/files",Bt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/files",_a,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){let s=new Set(["processed","error","deleted"]),i=Date.now(),a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await as(t),a=await this.retrieve(e),Date.now()-i>n)throw new Gr({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}},_a=class extends ce{};Ws.FileObjectsPage=_a;var fu=class extends E{};var pu=class extends E{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};var wa=class extends E{constructor(){super(...arguments),this.graders=new pu(this._client)}};wa.Graders=pu;var va=class extends E{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,du,{body:t,method:"post",...n})}retrieve(e,t={},n){return ne(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}},du=class extends wn{};va.PermissionCreateResponsesPage=du;var Js=class extends E{constructor(){super(...arguments),this.permissions=new va(this._client)}};Js.Permissions=va;Js.PermissionCreateResponsesPage=du;var xa=class extends E{list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,hu,{query:t,...n})}},hu=class extends ce{};xa.FineTuningJobCheckpointsPage=hu;var Sn=class extends E{constructor(){super(...arguments),this.checkpoints=new xa(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",mu,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return ne(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,gu,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}},mu=class extends ce{},gu=class extends ce{};Sn.FineTuningJobsPage=mu;Sn.FineTuningJobEventsPage=gu;Sn.Checkpoints=xa;Sn.FineTuningJobCheckpointsPage=hu;var Yt=class extends E{constructor(){super(...arguments),this.methods=new fu(this._client),this.jobs=new Sn(this._client),this.checkpoints=new Js(this._client),this.alpha=new wa(this._client)}};Yt.Methods=fu;Yt.Jobs=Sn;Yt.FineTuningJobsPage=mu;Yt.FineTuningJobEventsPage=gu;Yt.Checkpoints=Js;Yt.Alpha=wa;var bu=class extends E{};var Ys=class extends E{constructor(){super(...arguments),this.graderModels=new bu(this._client)}};Ys.GraderModels=bu;var Aa=class extends E{createVariation(e,t){return this._client.post("/images/variations",Bt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Bt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};var Xs=class extends E{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ea,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Ea=class extends wn{};Xs.ModelsPage=Ea;var Oa=class extends E{create(e,t){return this._client.post("/moderations",{body:e,...t})}};function dO(r,e){return!e||!tM(e)?{...r,output_parsed:null,output:r.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:Oy(r,e)}function Oy(r,e){let t=r.output.map(s=>{if(s.type==="function_call")return{...s,parsed_arguments:sM(e,s)};if(s.type==="message"){let i=s.content.map(a=>a.type==="output_text"?{...a,parsed:eM(e,a.text)}:a);return{...s,content:i}}return s}),n=Object.assign({},r,{output:t});return Object.getOwnPropertyDescriptor(r,"output_text")||Py(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(let s of n.output)if(s.type==="message"){for(let i of s.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),n}function eM(r,e){return r.text?.format?.type!=="json_schema"?null:"$parseRaw"in r.text?.format?(r.text?.format).$parseRaw(e):JSON.parse(e)}function tM(r){return!!ul(r.text?.format)}function rM(r){return r?.$brand==="auto-parseable-tool"}function nM(r,e){return r.find(t=>t.type==="function"&&t.name===e)}function sM(r,e){let t=nM(r.tools??[],e.name);return{...e,...e,parsed_arguments:rM(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function Py(r){let e=[];for(let t of r.output)if(t.type==="message")for(let n of t.content)n.type==="output_text"&&e.push(n.text);r.output_text=e.join("")}var yu=class extends E{list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Rd,{query:t,...n})}};var _u=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Qs=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},wu,Nd,ei,$d,hO,mO,gO,bO,jd=class r extends Gs{constructor(e){super(),wu.add(this),Nd.set(this,void 0),ei.set(this,void 0),$d.set(this,void 0),_u(this,Nd,e,"f")}static createResponse(e,t,n){let s=new r(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Qs(this,wu,"m",hO).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(let o of i)Qs(this,wu,"m",mO).call(this,o,a);if(i.controller.signal?.aborted)throw new Ie;return Qs(this,wu,"m",gO).call(this)}[(Nd=new WeakMap,ei=new WeakMap,$d=new WeakMap,wu=new WeakSet,hO=function(){this.ended||_u(this,ei,void 0,"f")},mO=function(t,n){if(this.ended)return;let s=(a,o)=>{(n==null||o.sequence_number>n)&&this._emit(a,o)},i=Qs(this,wu,"m",bO).call(this,t);switch(s("event",t),t.type){case"response.output_text.delta":{let a=i.output[t.output_index];if(!a)throw new F(`missing output at index ${t.output_index}`);if(a.type==="message"){let o=a.content[t.content_index];if(!o)throw new F(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new F(`expected content to be 'output_text', got ${o.type}`);s("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{let a=i.output[t.output_index];if(!a)throw new F(`missing output at index ${t.output_index}`);a.type==="function_call"&&s("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:s(t.type,t);break}},gO=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");let t=Qs(this,ei,"f");if(!t)throw new F("request ended without sending any events");_u(this,ei,void 0,"f");let n=aM(t,Qs(this,Nd,"f"));return _u(this,$d,n,"f"),n},bO=function(t){let n=Qs(this,ei,"f");if(!n){if(t.type!=="response.created")throw new F(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return n=_u(this,ei,t.response,"f"),n}switch(t.type){case"response.output_item.added":{n.output.push(t.item);break}case"response.content_part.added":{let s=n.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);s.type==="message"&&s.content.push(t.part);break}case"response.output_text.delta":{let s=n.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);if(s.type==="message"){let i=s.content[t.content_index];if(!i)throw new F(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new F(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{let s=n.output[t.output_index];if(!s)throw new F(`missing output at index ${t.output_index}`);s.type==="function_call"&&(s.arguments+=t.delta);break}case"response.completed":{_u(this,ei,t.response,"f");break}}return n},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("event",s=>{let i=t.shift();i?i.resolve(s):e.push(s)}),this.on("end",()=>{n=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),this.on("error",s=>{n=!0;for(let i of t)i.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=Qs(this,$d,"f");if(!e)throw new F("stream ended without producing a ChatCompletion");return e}};function aM(r,e){return dO(r,e)}var ti=class extends E{constructor(){super(...arguments),this.inputItems=new yu(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Py(n),n))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>Oy(n,e))}stream(e,t){return jd.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}},Rd=class extends ce{};ti.InputItems=yu;var vu=class extends E{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,Bt({body:t,...n}))}};var ri=class extends E{constructor(){super(...arguments),this.parts=new vu(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}};ri.Parts=vu;var yO=async r=>{let e=await Promise.allSettled(r),t=e.filter(s=>s.status==="rejected");if(t.length){for(let s of t)console.error(s.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let n=[];for(let s of e)s.status==="fulfilled"&&n.push(s.value);return n};var ni=class extends E{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,s){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t={},n){return ne(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,si,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let i=await this.retrieve(e,t,{...n,headers:s}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=i.response.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await as(o);break;case"failed":case"completed":return a}}}async upload(e,t,n){let s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){let s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,xu,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}},si=class extends ce{},xu=class extends wn{};ni.VectorStoreFilesPage=si;ni.FileContentResponsesPage=xu;var Au=class extends E{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){let s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n={},s){return ne(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,si,{query:n,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async poll(e,t,n){let s={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(s["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){let{data:i,response:a}=await this.retrieve(e,t,{...n,headers:s}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{let u=a.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await as(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=s?.maxConcurrency??5,a=Math.min(i,t.length),o=this._client,u=t.values(),c=[...n];async function l(p){for(let d of p){let h=await o.files.create({file:d,purpose:"assistants"},s);c.push(h.id)}}let f=Array(a).fill(u).map(l);return await yO(f),await this.createAndPoll(e,{file_ids:c})}};var Xt=class extends E{constructor(){super(...arguments),this.files=new ni(this._client),this.fileBatches=new Au(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return ne(e)?this.list({},e):this._client.getAPIList("/vector_stores",Pa,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,Sa,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}},Pa=class extends ce{},Sa=class extends wn{};Xt.VectorStoresPage=Pa;Xt.VectorStoreSearchResponsesPage=Sa;Xt.Files=ni;Xt.VectorStoreFilesPage=si;Xt.FileContentResponsesPage=xu;Xt.FileBatches=Au;var _O,J=class extends bd{constructor({baseURL:e=Qc("OPENAI_BASE_URL"),apiKey:t=Qc("OPENAI_API_KEY"),organization:n=Qc("OPENAI_ORG_ID")??null,project:s=Qc("OPENAI_PROJECT_ID")??null,...i}={}){if(t===void 0)throw new F("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let a={apiKey:t,organization:n,project:s,...i,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&WE())throw new F(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new ha(this),this.chat=new us(this),this.embeddings=new ga(this),this.files=new Ws(this),this.images=new Aa(this),this.audio=new vn(this),this.moderations=new Oa(this),this.models=new Xs(this),this.fineTuning=new Yt(this),this.graders=new Ys(this),this.vectorStores=new Xt(this),this.beta=new Kr(this),this.batches=new Vs(this),this.uploads=new ri(this),this.responses=new ti(this),this.evals=new Pn(this),this.containers=new On(this),this._options=a,this.apiKey=t,this.organization=n,this.project=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Vb(e,{arrayFormat:"brackets"})}};_O=J;J.OpenAI=_O;J.DEFAULT_TIMEOUT=6e5;J.OpenAIError=F;J.APIError=Fe;J.APIConnectionError=ss;J.APIConnectionTimeoutError=Gr;J.APIUserAbortError=Ie;J.NotFoundError=zo;J.ConflictError=Lo;J.RateLimitError=Fo;J.BadRequestError=$o;J.AuthenticationError=jo;J.InternalServerError=Uo;J.PermissionDeniedError=Mo;J.UnprocessableEntityError=Do;J.toFile=ry;J.fileFromPath=ld;J.Completions=ha;J.Chat=us;J.ChatCompletionsPage=Bs;J.Embeddings=ga;J.Files=Ws;J.FileObjectsPage=_a;J.Images=Aa;J.Audio=vn;J.Moderations=Oa;J.Models=Xs;J.ModelsPage=Ea;J.FineTuning=Yt;J.Graders=Ys;J.VectorStores=Xt;J.VectorStoresPage=Pa;J.VectorStoreSearchResponsesPage=Sa;J.Beta=Kr;J.Batches=Vs;J.BatchesPage=oa;J.Uploads=ri;J.Responses=ti;J.Evals=Pn;J.EvalListResponsesPage=ya;J.Containers=On;J.ContainerListResponsesPage=ma;Os();nn();Ni();Zn();function Iy(r,e){if(r.function===void 0)return;let t;if(e?.partial)try{t=Ka(r.function.arguments??"{}")}catch{return}else try{t=JSON.parse(r.function.arguments)}catch(s){throw new Ms([`Function "${r.function.name}" arguments:`,"",r.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}let n={name:r.function.name,args:t,type:"tool_call"};return e?.returnId&&(n.id=r.id),n}function wO(r){if(r.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:r.id,type:"function",function:{name:r.name,arguments:JSON.stringify(r.args)}}}function vO(r,e){return{name:r.function?.name,args:r.function?.arguments,id:r.id,error:e,type:"invalid_tool_call"}}var Sy=class extends qi{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let n=e[0].message,s;if(Ri(n)&&n.tool_calls?.length?s=n.tool_calls.map(a=>{let{id:o,...u}=a;return this.returnId?{id:o,...u}:u}):n.additional_kwargs.tool_calls!==void 0&&(s=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(o=>Iy(o,{returnId:this.returnId,partial:t}))),!s)return[];let i=[];for(let a of s)if(a!==void 0){let o={type:a.name,args:a.args,id:a.id};i.push(o)}return i}},dl=class extends Sy{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await IA(this.zodSchema,e);if(t.success)return t.data;throw new Ms(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let n=(await super.parsePartialResult(e)).filter(i=>i.type===this.keyName),s=n;if(n.length)return this.returnId||(s=n.map(i=>i.args)),this.returnSingle?s[0]:s}async parseResult(e){let n=(await super.parsePartialResult(e,!1)).filter(a=>a.type===this.keyName),s=n;return n.length?(this.returnId||(s=n.map(a=>a.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(a=>this._validateResult(a)))):void 0}};lp();var AO=Symbol("Let zodToJsonSchema decide on which parser to use"),xO={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},EO=r=>typeof r=="string"?{...xO,basePath:["#"],definitions:{},name:r}:{...xO,basePath:["#"],definitions:{},...r};var hl=r=>"_def"in r?r._def:r;function OO(r){if(!r)return!0;for(let e in r)return!1;return!0}var PO=r=>{let e=EO(r),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([n,s])=>[hl(s),{def:hl(s),path:[...e.basePath,e.definitionPath,n],jsonSchema:void 0}]))}};function Ty(r,e,t,n){n?.errorMessages&&t&&(r.errorMessage={...r.errorMessage,[e]:t})}function de(r,e,t,n,s){r[e]=t,Ty(r,e,n,s)}un();function SO(){return{}}un();function IO(r,e){let t={type:"array"};return r.type?._def?.typeName!==v.ZodAny&&(t.items=K(r.type._def,{...e,currentPath:[...e.currentPath,"items"]})),r.minLength&&de(t,"minItems",r.minLength.value,r.minLength.message,e),r.maxLength&&de(t,"maxItems",r.maxLength.value,r.maxLength.message,e),r.exactLength&&(de(t,"minItems",r.exactLength.value,r.exactLength.message,e),de(t,"maxItems",r.exactLength.value,r.exactLength.message,e)),t}function TO(r,e){let t={type:"integer",format:"int64"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"min":e.target==="jsonSchema7"?n.inclusive?de(t,"minimum",n.value,n.message,e):de(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?de(t,"maximum",n.value,n.message,e):de(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",n.value,n.message,e));break;case"multipleOf":de(t,"multipleOf",n.value,n.message,e);break}return t}function kO(){return{type:"boolean"}}function CO(r,e){return K(r.type._def,e)}var RO=(r,e)=>K(r.innerType._def,e);function ky(r,e,t){let n=t??e.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((s,i)=>ky(r,e,s))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return fM(r,e)}}var fM=(r,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let n of r.checks)switch(n.kind){case"min":de(t,"minimum",n.value,n.message,e);break;case"max":de(t,"maximum",n.value,n.message,e);break}return t};function NO(r,e){return{...K(r.innerType._def,e),default:r.defaultValue()}}function $O(r,e,t){return e.effectStrategy==="input"?K(r.schema._def,e,t):{}}function jO(r){return{type:"string",enum:[...r.values]}}var pM=r=>"type"in r&&r.type==="string"?!1:"allOf"in r;function MO(r,e){let t=[K(r.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),K(r.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i),n=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,s=[];return t.forEach(i=>{if(pM(i))s.push(...i.allOf),i.unevaluatedProperties===void 0&&(n=void 0);else{let a=i;if("additionalProperties"in i&&i.additionalProperties===!1){let{additionalProperties:o,...u}=i;a=u}else n=void 0;s.push(a)}}),s.length?{allOf:s,...n}:void 0}function zO(r,e){let t=typeof r.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(r.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[r.value]}:{type:t==="bigint"?"integer":t,const:r.value}}un();var Cy,Ia={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Cy===void 0&&(Cy=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Cy),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Md(r,e){let t={type:"string"};function n(s){return e.patternStrategy==="escape"?dM(s):s}if(r.checks)for(let s of r.checks)switch(s.kind){case"min":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Hr(t,"email",s.message,e);break;case"format:idn-email":Hr(t,"idn-email",s.message,e);break;case"pattern:zod":Wr(t,Ia.email,s.message,e);break}break;case"url":Hr(t,"uri",s.message,e);break;case"uuid":Hr(t,"uuid",s.message,e);break;case"regex":Wr(t,s.regex,s.message,e);break;case"cuid":Wr(t,Ia.cuid,s.message,e);break;case"cuid2":Wr(t,Ia.cuid2,s.message,e);break;case"startsWith":Wr(t,RegExp(`^${n(s.value)}`),s.message,e);break;case"endsWith":Wr(t,RegExp(`${n(s.value)}$`),s.message,e);break;case"datetime":Hr(t,"date-time",s.message,e);break;case"date":Hr(t,"date",s.message,e);break;case"time":Hr(t,"time",s.message,e);break;case"duration":Hr(t,"duration",s.message,e);break;case"length":de(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),de(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{Wr(t,RegExp(n(s.value)),s.message,e);break}case"ip":{s.version!=="v6"&&Hr(t,"ipv4",s.message,e),s.version!=="v4"&&Hr(t,"ipv6",s.message,e);break}case"emoji":Wr(t,Ia.emoji,s.message,e);break;case"ulid":{Wr(t,Ia.ulid,s.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Hr(t,"binary",s.message,e);break}case"contentEncoding:base64":{de(t,"contentEncoding","base64",s.message,e);break}case"pattern:zod":{Wr(t,Ia.base64,s.message,e);break}}break}case"nanoid":Wr(t,Ia.nanoid,s.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var dM=r=>Array.from(r).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Hr=(r,e,t,n)=>{r.format||r.anyOf?.some(s=>s.format)?(r.anyOf||(r.anyOf=[]),r.format&&(r.anyOf.push({format:r.format,...r.errorMessage&&n.errorMessages&&{errorMessage:{format:r.errorMessage.format}}}),delete r.format,r.errorMessage&&(delete r.errorMessage.format,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.anyOf.push({format:e,...t&&n.errorMessages&&{errorMessage:{format:t}}})):de(r,"format",e,t,n)},Wr=(r,e,t,n)=>{r.pattern||r.allOf?.some(s=>s.pattern)?(r.allOf||(r.allOf=[]),r.pattern&&(r.allOf.push({pattern:r.pattern,...r.errorMessage&&n.errorMessages&&{errorMessage:{pattern:r.errorMessage.pattern}}}),delete r.pattern,r.errorMessage&&(delete r.errorMessage.pattern,Object.keys(r.errorMessage).length===0&&delete r.errorMessage)),r.allOf.push({pattern:LO(e,n),...t&&n.errorMessages&&{errorMessage:{pattern:t}}})):de(r,"pattern",LO(e,n),t,n)},LO=(r,e)=>{let t=typeof r=="function"?r():r;if(!e.applyRegexFlags||!t.flags)return t.source;let n={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},s=n.i?t.source.toLowerCase():t.source,i="",a=!1,o=!1,u=!1;for(let c=0;c<s.length;c++){if(a){i+=s[c],a=!1;continue}if(n.i){if(o){if(s[c].match(/[a-z]/)){u?(i+=s[c],i+=`${s[c-2]}-${s[c]}`.toUpperCase(),u=!1):s[c+1]==="-"&&s[c+2]?.match(/[a-z]/)?(i+=s[c],u=!0):i+=`${s[c]}${s[c].toUpperCase()}`;continue}}else if(s[c].match(/[a-z]/)){i+=`[${s[c]}${s[c].toUpperCase()}]`;continue}}if(n.m){if(s[c]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(s[c]==="$"){i+=`($|(?=[\r
]))`;continue}}if(n.s&&s[c]==="."){i+=o?`${s[c]}\r
`:`[${s[c]}\r
]`;continue}i+=s[c],s[c]==="\\"?a=!0:o&&s[c]==="]"?o=!1:!o&&s[c]==="["&&(o=!0)}try{let c=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return i};function zd(r,e){if(e.target==="openApi3"&&r.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:r.keyType._def.values,properties:r.keyType._def.values.reduce((n,s)=>({...n,[s]:K(r.valueType._def,{...e,currentPath:[...e.currentPath,"properties",s]})??{}}),{}),additionalProperties:!1};let t={type:"object",additionalProperties:K(r.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(r.keyType?._def.typeName===v.ZodString&&r.keyType._def.checks?.length){let n=Object.entries(Md(r.keyType._def,e)).reduce((s,[i,a])=>i==="type"?s:{...s,[i]:a},{});return{...t,propertyNames:n}}else if(r.keyType?._def.typeName===v.ZodEnum)return{...t,propertyNames:{enum:r.keyType._def.values}};return t}function DO(r,e){if(e.mapStrategy==="record")return zd(r,e);let t=K(r.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},n=K(r.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,n],minItems:2,maxItems:2}}}function FO(r){let e=r.values,n=Object.keys(r.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(n.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:n}}function UO(){return{not:{}}}function BO(r){return r.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var ml={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function GO(r,e){if(e.target==="openApi3")return VO(r,e);let t=r.options instanceof Map?Array.from(r.options.values()):r.options;if(t.every(n=>n._def.typeName in ml&&(!n._def.checks||!n._def.checks.length))){let n=t.reduce((s,i)=>{let a=ml[i._def.typeName];return a&&!s.includes(a)?[...s,a]:s},[]);return{type:n.length>1?n:n[0]}}else if(t.every(n=>n._def.typeName==="ZodLiteral"&&!n.description)){let n=t.reduce((s,i)=>{let a=typeof i._def.value;switch(a){case"string":case"number":case"boolean":return[...s,a];case"bigint":return[...s,"integer"];case"object":if(i._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(n.length===t.length){let s=n.filter((i,a,o)=>o.indexOf(i)===a);return{type:s.length>1?s:s[0],enum:t.reduce((i,a)=>i.includes(a._def.value)?i:[...i,a._def.value],[])}}}else if(t.every(n=>n._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((n,s)=>[...n,...s._def.values.filter(i=>!n.includes(i))],[])};return VO(r,e)}var VO=(r,e)=>{let t=(r.options instanceof Map?Array.from(r.options.values()):r.options).map((n,s)=>K(n._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(n=>!!n&&(!e.strictUnions||typeof n=="object"&&Object.keys(n).length>0));return t.length?{anyOf:t}:void 0};function ZO(r,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:ml[r.innerType._def.typeName],nullable:!0}:{type:[ml[r.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let n=K(r.innerType._def,{...e,currentPath:[...e.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}let t=K(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function qO(r,e){let t={type:"number"};if(!r.checks)return t;for(let n of r.checks)switch(n.kind){case"int":t.type="integer",Ty(t,"type",n.message,e);break;case"min":e.target==="jsonSchema7"?n.inclusive?de(t,"minimum",n.value,n.message,e):de(t,"exclusiveMinimum",n.value,n.message,e):(n.inclusive||(t.exclusiveMinimum=!0),de(t,"minimum",n.value,n.message,e));break;case"max":e.target==="jsonSchema7"?n.inclusive?de(t,"maximum",n.value,n.message,e):de(t,"exclusiveMaximum",n.value,n.message,e):(n.inclusive||(t.exclusiveMaximum=!0),de(t,"maximum",n.value,n.message,e));break;case"multipleOf":de(t,"multipleOf",n.value,n.message,e);break}return t}function hM(r,e){return e.removeAdditionalStrategy==="strict"?r.catchall._def.typeName==="ZodNever"?r.unknownKeys!=="strict":K(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:r.catchall._def.typeName==="ZodNever"?r.unknownKeys==="passthrough":K(r.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function KO(r,e){let t={type:"object",...Object.entries(r.shape()).reduce((n,[s,i])=>{if(i===void 0||i._def===void 0)return n;let a=[...e.currentPath,"properties",s],o=K(i._def,{...e,currentPath:a,propertyPath:a});return o===void 0?n:(e.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...n.properties,[s]:o},required:i.isOptional()&&!e.openaiStrictMode?n.required:[...n.required,s]})},{properties:{},required:[]}),additionalProperties:hM(r,e)};return t.required.length||delete t.required,t}var HO=(r,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return K(r.innerType._def,e);let t=K(r.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var WO=(r,e)=>{if(e.pipeStrategy==="input")return K(r.in._def,e);if(e.pipeStrategy==="output")return K(r.out._def,e);let t=K(r.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),n=K(r.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,n].filter(s=>s!==void 0)}};function JO(r,e){return K(r.type._def,e)}function YO(r,e){let n={type:"array",uniqueItems:!0,items:K(r.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return r.minSize&&de(n,"minItems",r.minSize.value,r.minSize.message,e),r.maxSize&&de(n,"maxItems",r.maxSize.value,r.maxSize.message,e),n}function XO(r,e){return r.rest?{type:"array",minItems:r.items.length,items:r.items.map((t,n)=>K(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[]),additionalItems:K(r.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:r.items.length,maxItems:r.items.length,items:r.items.map((t,n)=>K(t._def,{...e,currentPath:[...e.currentPath,"items",`${n}`]})).reduce((t,n)=>n===void 0?t:[...t,n],[])}}function QO(){return{not:{}}}function eP(){return{}}var tP=(r,e)=>K(r.innerType._def,e);function K(r,e,t=!1){let n=e.seen.get(r);if(e.override){let a=e.override?.(r,e,n,t);if(a!==AO)return a}if(n&&!t){let a=mM(n,e);if(a!==void 0)return"$ref"in a&&e.seenRefs.add(a.$ref),a}let s={def:r,path:e.currentPath,jsonSchema:void 0};e.seen.set(r,s);let i=bM(r,r.typeName,e,t);return i&&yM(r,e,i),s.jsonSchema=i,i}var mM=(r,e)=>{switch(e.$refStrategy){case"root":return{$ref:r.path.join("/")};case"extract-to-root":let t=r.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=r.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:gM(e.currentPath,r.path)};case"none":case"seen":return r.path.length<e.currentPath.length&&r.path.every((n,s)=>e.currentPath[s]===n)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},gM=(r,e)=>{let t=0;for(;t<r.length&&t<e.length&&r[t]===e[t];t++);return[(r.length-t).toString(),...e.slice(t)].join("/")},bM=(r,e,t,n)=>{switch(e){case v.ZodString:return Md(r,t);case v.ZodNumber:return qO(r,t);case v.ZodObject:return KO(r,t);case v.ZodBigInt:return TO(r,t);case v.ZodBoolean:return kO();case v.ZodDate:return ky(r,t);case v.ZodUndefined:return QO();case v.ZodNull:return BO(t);case v.ZodArray:return IO(r,t);case v.ZodUnion:case v.ZodDiscriminatedUnion:return GO(r,t);case v.ZodIntersection:return MO(r,t);case v.ZodTuple:return XO(r,t);case v.ZodRecord:return zd(r,t);case v.ZodLiteral:return zO(r,t);case v.ZodEnum:return jO(r);case v.ZodNativeEnum:return FO(r);case v.ZodNullable:return ZO(r,t);case v.ZodOptional:return HO(r,t);case v.ZodMap:return DO(r,t);case v.ZodSet:return YO(r,t);case v.ZodLazy:return K(r.getter()._def,t);case v.ZodPromise:return JO(r,t);case v.ZodNaN:case v.ZodNever:return UO();case v.ZodEffects:return $O(r,t,n);case v.ZodAny:return SO();case v.ZodUnknown:return eP();case v.ZodDefault:return NO(r,t);case v.ZodBranded:return CO(r,t);case v.ZodReadonly:return tP(r,t);case v.ZodCatch:return RO(r,t);case v.ZodPipeline:return WO(r,t);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(s=>{})(e)}},yM=(r,e,t)=>(r.description&&(t.description=r.description,e.markdownDescription&&(t.markdownDescription=r.description)),t);var rP=(r,e)=>{let t=PO(e),n=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,s=K(r._def,n===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,n]},!1)??{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);let a=(()=>{if(OO(t.definitions))return;let u={},c=new Set;for(let l=0;l<500;l++){let f=Object.entries(t.definitions).filter(([p])=>!c.has(p));if(f.length===0)break;for(let[p,d]of f)u[p]=K(hl(d),{...t,currentPath:[...t.basePath,t.definitionPath,p]},!0)??{},c.add(p)}return u})(),o=n===void 0?a?{...s,[t.definitionPath]:a}:s:t.nameStrategy==="duplicate-ref"?{...s,...a||t.seenRefs.size?{[t.definitionPath]:{...a,...t.seenRefs.size?{[n]:s}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,n].join("/"),[t.definitionPath]:{...a,[n]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function nP(r,e){return rP(r,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function sP(r,e,t){return iO({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:nP(r,{name:e})}},n=>r.parse(JSON.parse(n)))}function iP(r){return aO({type:"function",function:{name:r.name,parameters:nP(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))})}function ii(r){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:n,azureOpenAIBasePath:s,baseURL:i,azureADTokenProvider:a,azureOpenAIEndpoint:o}=r;if((n||a)&&s&&e)return`${s}/${e}`;if((n||a)&&o&&e)return`${o}/openai/deployments/${e}`;if(n||a){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}lp();function gl(r,e){return r.lc_error_code=e,r.message=`${r.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,r}function Ta(r){let e;return r.constructor.name===Gr.name?(e=new Error(r.message),e.name="TimeoutError"):r.constructor.name===Ie.name?(e=new Error(r.message),e.name="AbortError"):r.status===400&&r.message.includes("tool_calls")?e=gl(r,"INVALID_TOOL_RESULTS"):r.status===401?e=gl(r,"MODEL_AUTHENTICATION"):r.status===429?e=gl(r,"MODEL_RATE_LIMIT"):r.status===404?e=gl(r,"MODEL_NOT_FOUND"):e=r,e}function aP(r){if(r)return r==="any"||r==="required"?"required":r==="auto"?"auto":r==="none"?"none":typeof r=="string"?{type:"function",function:{name:r}}:r}function _M(r){return r.anyOf!==void 0&&Array.isArray(r.anyOf)}function oP(r){let e=["namespace functions {",""];for(let t of r)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(uP(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function uP(r,e){let t=[];for(let[n,s]of Object.entries(r.properties??{}))s.description&&e<2&&t.push(`// ${s.description}`),r.required?.includes(n)?t.push(`${n}: ${Ld(s,e)},`):t.push(`${n}?: ${Ld(s,e)},`);return t.map(n=>" ".repeat(e)+n).join(`
`)}function Ld(r,e){if(_M(r))return r.anyOf.map(t=>Ld(t,e)).join(" | ");switch(r.type){case"string":return r.enum?r.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return r.enum?r.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",uP(r,e+2),"}"].join(`
`);case"array":return r.items?`${Ld(r.items,e)}[]`:"any[]";default:return""}}function cP(r,e){let t;if($c(r)){let n=iP({name:r.name,parameters:r.schema,description:r.description});n.function.parameters?t={type:n.type,function:{name:n.function.name,description:n.function.description,parameters:n.function.parameters,...e?.strict!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:vb(r,e)}}else t=r;return e?.strict!==void 0&&(t.function.strict=e.strict),t}function wM(r){return r.role!=="system"&&r.role!=="developer"&&r.role!=="assistant"&&r.role!=="user"&&r.role!=="function"&&r.role!=="tool"&&console.warn(`Unknown message role: ${r.role}`),r.role}function fP(r){let e=r._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Or.isInstance(r))throw new Error("Invalid generic chat message");return wM(r)}default:throw new Error(`Unknown message type: ${e}`)}}function vM(r,e,t){let n=r.tool_calls;switch(r.role){case"assistant":{let s=[],i=[];for(let u of n??[])try{s.push(Iy(u,{returnId:!0}))}catch(c){i.push(vO(u,c.message))}let a={function_call:r.function_call,tool_calls:n};t!==void 0&&(a.__raw_response=e);let o={model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};return r.audio&&(a.audio=r.audio),new dt({content:r.content||"",tool_calls:s,invalid_tool_calls:i,additional_kwargs:a,response_metadata:o,id:e.id})}default:return new Or(r.content||"",r.role??"unknown")}}function xM(r,e,t,n){let s=r.role??t,i=r.content??"",a;r.function_call?a={function_call:r.function_call}:r.tool_calls?a={tool_calls:r.tool_calls}:a={},n&&(a.__raw_response=e),r.audio&&(a.audio={...r.audio,index:e.choices[0].index});let o={usage:{...e.usage}};if(s==="user")return new Mi({content:i,response_metadata:o});if(s==="assistant"){let u=[];if(Array.isArray(r.tool_calls))for(let c of r.tool_calls)u.push({name:c.function?.name,args:c.function?.arguments,id:c.id,index:c.index,type:"tool_call_chunk"});return new St({content:i,tool_call_chunks:u,additional_kwargs:a,id:e.id,response_metadata:o})}else return s==="system"?new xs({content:i,response_metadata:o}):s==="developer"?new xs({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):s==="function"?new ji({content:i,additional_kwargs:a,name:r.name,response_metadata:o}):s==="tool"?new Ja({content:i,additional_kwargs:a,tool_call_id:r.tool_call_id,response_metadata:o}):new $i({content:i,role:s,response_metadata:o})}function Ry(r,e){return r.flatMap(t=>{let n=fP(t);n==="system"&&e?.startsWith("o1")&&(n="developer");let s={role:n,content:t.content};if(t.name!=null&&(s.name=t.name),t.additional_kwargs.function_call!=null&&(s.function_call=t.additional_kwargs.function_call,s.content=null),Ri(t)&&t.tool_calls?.length?(s.tool_calls=t.tool_calls.map(wO),s.content=null):(t.additional_kwargs.tool_calls!=null&&(s.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(s.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){let i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[s,i]}return s})}function lP(r,e){return QA(r)?e?.strict!==void 0?{...r,function:{...r.function,strict:e.strict}}:r:cP(r,e)}var bl=class extends Cc{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??we("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??we("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??we("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??we("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??we("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??we("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??we("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??we("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){let n=this.azureOpenAIBasePath.split("/openai/deployments/");if(n.length===2){let[,s]=n;this.azureOpenAIApiDeploymentName=s}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.model==="o1"&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return t?.strict!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.bind({tools:e.map(s=>lP(s,{strict:n})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Dd(e.json_schema.schema)?sP(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let n;e?.strict!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let s={};e?.stream_options!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(s={stream_options:{include_usage:!0}});let i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(o=>lP(o,{strict:n})):void 0,tool_choice:aP(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...s,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(i.prediction=e.prediction);let a=e?.reasoning_effort??this.reasoningEffort;return a!==void 0&&(i.reasoning_effort=a),i}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){let s=Ry(e,this.model),i={...this.invocationParams(t,{streaming:!0}),messages:s,stream:!0},a,o=await this.completionWithRetry(i,t),u;for await(let c of o){let l=c?.choices?.[0];if(c.usage&&(u=c.usage),!l)continue;let{delta:f}=l;if(!f)continue;let p=xM(f,c,a,this.__includeRawResponse);a=f.role??a;let d={prompt:t.promptIndex??0,completion:l.index??0};if(typeof p.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let h={...d};l.finish_reason!=null&&(h.finish_reason=l.finish_reason,h.system_fingerprint=c.system_fingerprint,h.model_name=c.model),this.logprobs&&(h.logprobs=l.logprobs);let m=new Bn({message:p,text:p.content,generationInfo:h});yield m,await n?.handleLLMNewToken(m.text??"",d,void 0,void 0,void 0,{chunk:m})}if(u){let c={...u.prompt_tokens_details?.audio_tokens!==null&&{audio:u.prompt_tokens_details?.audio_tokens},...u.prompt_tokens_details?.cached_tokens!==null&&{cache_read:u.prompt_tokens_details?.cached_tokens}},l={...u.completion_tokens_details?.audio_tokens!==null&&{audio:u.completion_tokens_details?.audio_tokens},...u.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:u.completion_tokens_details?.reasoning_tokens}};yield new Bn({message:new St({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(c).length>0&&{input_token_details:c},...Object.keys(l).length>0&&{output_token_details:l}}}),text:""})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){let s={},i=this.invocationParams(t),a=Ry(e,this.model);if(i.stream){let o=this._streamResponseChunks(e,t,n),u={};for await(let h of o){h.message.response_metadata={...h.generationInfo,...h.message.response_metadata};let m=h.generationInfo?.completion??0;u[m]===void 0?u[m]=h:u[m]=u[m].concat(h)}let c=Object.entries(u).sort(([h],[m])=>parseInt(h,10)-parseInt(m,10)).map(([h,m])=>m),{functions:l,function_call:f}=this.invocationParams(t),p=await this.getEstimatedTokenCountFromPrompt(e,l,f),d=await this.getNumTokensFromGenerations(c);return s.input_tokens=p,s.output_tokens=d,s.total_tokens=p+d,{generations:c,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{let o;t.response_format&&t.response_format.type==="json_schema"?o=await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:a},{signal:t?.signal,...t?.options}):o=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t?.signal,...t?.options});let{completion_tokens:u,prompt_tokens:c,total_tokens:l,prompt_tokens_details:f,completion_tokens_details:p}=o?.usage??{};u&&(s.output_tokens=(s.output_tokens??0)+u),c&&(s.input_tokens=(s.input_tokens??0)+c),l&&(s.total_tokens=(s.total_tokens??0)+l),(f?.audio_tokens!==null||f?.cached_tokens!==null)&&(s.input_token_details={...f?.audio_tokens!==null&&{audio:f?.audio_tokens},...f?.cached_tokens!==null&&{cache_read:f?.cached_tokens}}),(p?.audio_tokens!==null||p?.reasoning_tokens!==null)&&(s.output_token_details={...p?.audio_tokens!==null&&{audio:p?.audio_tokens},...p?.reasoning_tokens!==null&&{reasoning:p?.reasoning_tokens}});let d=[];for(let h of o?.choices??[]){let g={text:h.message?.content??"",message:vM(h.message??{role:"assistant"},o,this.__includeRawResponse)};g.generationInfo={...h.finish_reason?{finish_reason:h.finish_reason}:{},...h.logprobs?{logprobs:h.logprobs}:{}},Ri(g.message)&&(g.message.usage_metadata=s),g.message=new dt(Object.fromEntries(Object.entries(g.message).filter(([y])=>!y.startsWith("lc_")))),d.push(g)}return{generations:d,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){let i=oP(t);s+=await this.getNumTokens(i),s+=9}return t&&e.find(i=>i._getType()==="system")&&(s-=4),n==="none"?s+=1:typeof n=="object"&&(s+=await this.getNumTokens(n.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,s)=>n+s,0)}async getNumTokensFromMessages(e){let t=0,n=0,s=0;this.model==="gpt-3.5-turbo-0301"?(n=4,s=-1):(n=3,s=1);let i=await Promise.all(e.map(async a=>{let o=await this.getNumTokens(a.content),u=await this.getNumTokens(fP(a)),c=a.name!==void 0?s+await this.getNumTokens(a.name):0,l=o+n+u+c,f=a;if(f._getType()==="function"&&(l-=2),f.additional_kwargs?.function_call&&(l+=3),f?.additional_kwargs.function_call?.name&&(l+=await this.getNumTokens(f.additional_kwargs.function_call?.name)),f.additional_kwargs.function_call?.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse(f.additional_kwargs.function_call?.arguments)))}catch(p){console.error("Error parsing function arguments",p,JSON.stringify(f.additional_kwargs.function_call)),l+=await this.getNumTokens(f.additional_kwargs.function_call?.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){let n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,n)}catch(s){throw Ta(s)}})}async betaParsedCompletionWithRetry(e,t){let n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,n)}catch(s){throw Ta(s)}})}_getClientOptions(e){if(!this.client){let n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},s=ii(n),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new J(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,s,i,a;AM(e)?(n=e.schema,s=e.name,i=e.method,a=e.includeRaw):(n=e,s=t?.name,i=t?.method,a=t?.includeRaw);let o,u;if(t?.strict!==void 0&&i==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(i==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),Dd(n)?u=Rc.fromZodSchema(n):u=new Nc;else if(i==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:s??"extract",description:n.description,schema:n,strict:t?.strict}}}),Dd(n)?u=Rc.fromZodSchema(n):u=new Nc;else{let p=s??"extract";if(Dd(n)){let d=ao(n);o=this.bind({tools:[{type:"function",function:{name:p,description:d.description,parameters:d}}],tool_choice:{type:"function",function:{name:p}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new dl({returnSingle:!0,keyName:p,zodSchema:n})}else{let d;typeof n.name=="string"&&typeof n.parameters=="object"&&n.parameters!=null?(d=n,p=n.name):(p=n.title??p,d={name:p,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:d}],tool_choice:{type:"function",function:{name:p}},...t?.strict!==void 0?{strict:t.strict}:{}}),u=new dl({returnSingle:!0,keyName:p})}}if(!a)return o.pipe(u);let c=dr.assign({parsed:(p,d)=>u.invoke(p.raw,d)}),l=dr.assign({parsed:()=>null}),f=c.withFallbacks({fallbacks:[l]});return gt.from([{raw:o},f])}};function Dd(r){return typeof r?.parse=="function"}function AM(r){return r!==void 0&&typeof r.schema=="object"}var Ny=class extends $p{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??we("OPENAI_API_KEY"),n=e?.organization??we("OPENAI_ORGANIZATION"),s={apiKey:t,organization:n,dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new J(s),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(s=>s.url?{type:"image_url",image_url:s.url}:[]).filter(s=>s!==void 0&&s.type==="image_url"&&typeof s.image_url=="string"&&s.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(s=>s.b64_json?{type:"image_url",image_url:{url:s.b64_json}}:[]).filter(s=>s!==void 0&&s.type==="image_url"&&typeof s.image_url=="object"&&"url"in s.image_url&&typeof s.image_url.url=="string"&&s.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let i=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(i)}let n=await this.client.images.generate(t),s="";return this.dallEResponseFormat==="url"?[s]=n.data.map(i=>i.url).filter(i=>i!=="undefined"):[s]=n.data.map(i=>i.b64_json).filter(i=>i!=="undefined"),s}};Object.defineProperty(Ny,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});un();var In={ANALYSIS_MODEL:"x-ai/grok-4-fast",QUALITY_MODEL:"x-ai/grok-4-fast",MIN_QUALITY_SCORE:90,MAX_ITERATIONS:2},ka=Fa({summary:wr().describe("A comprehensive summary of the video content (150-400 words)"),takeaways:zl(wr()).min(3).max(8).describe("Key insights and actionable takeaways for the audience"),key_facts:zl(wr()).min(3).max(6).describe("Important facts, statistics, or data points mentioned")}),yl=Fa({rate:Qd(["Fail","Refine","Pass"]).describe("Score for the quality aspect (Fail=poor, Refine=adequate, Pass=excellent)"),reason:wr().describe("Reason for the score")}),Fd=Fa({completeness:yl.describe("Rate for completeness: The entire transcript has been considered"),accuracy:yl.describe("Rate for accuracy: Content directly supported by transcript (no external additions)"),structure:yl.describe("Rate for structure: Summary, takeaways, and key_facts are properly formatted"),grammar:yl.describe("Rate for grammar: No typos, grammatical mistakes, appropriate wordings"),no_garbage:yl.describe("Rate for no_garbage: The promotional and meaningless content are removed")});function _l(r){let e=r;for(;e&&e._def&&e._def.typeName==="ZodEffects";)e=e._def.innerType;return e}function dP(r){if(!r||!r._def)return null;let e=r._def;return e.typeName==="ZodEffects"&&e.effect&&e.effect.type==="describe"?e.effect.description:e.description||null}function $y(r){function e(i,a){if(!i||!i._def)return"Any";let u=_l(i)._def;return u.typeName==="ZodString"?"str":u.typeName==="ZodNumber"?"float":u.typeName==="ZodBoolean"?"bool":u.typeName==="ZodArray"?`list[${e(u.type,a)}]`:u.typeName==="ZodObject"?"dict":u.typeName==="ZodEnum"?`Literal[${u.values.map(l=>`"${l}"`).join(", ")}]`:u.typeName==="ZodOptional"||u.typeName==="ZodDefault"?e(u.innerType,a):"Any"}function t(i){if(!i||!i._def)return"";let o=_l(i)._def,u=[];return o.typeName==="ZodArray"&&(o.minLength&&u.push(`minItems=${o.minLength.value}`),o.maxLength&&u.push(`maxItems=${o.maxLength.value}`)),u.length>0?`(${u.join(", ")})`:""}function n(i,a={},o=""){let u=[],c=_l(i);if(!c._def||c._def.typeName!=="ZodObject")return{lines:u,refs:new Set};let l=c._def.shape;if(!l)return{lines:u,refs:new Set};let f=l();for(let[p,d]of Object.entries(f)){let h=_l(d),m=h._def,g=dP(d),y=t(d),b=[];if(m.typeName==="ZodObject"){let w=`${o}${p}: dict`;g&&(w+=` = ${g}`),b.push(w);let x=n(h,a,o+"  ");b=b.concat(x.lines)}else{let w=e(d,a),x=`${o}${p}: ${w}`;y&&(x+=` ${y}`),g&&(x+=` = ${g}`),b.push(x)}u=u.concat(b)}return{lines:u,refs:new Set}}let{lines:s}=n(r);return s.join(`
`)}var Eu=class r{static _extractFieldInfo(e){let t={};if(e._def&&e._def.shape){let n=e._def.shape();for(let[s,i]of Object.entries(n)){let o=_l(i)._def;t[s]={description:dP(i)||"",type:o.typeName,min_length:o.typeName==="ZodArray"&&o.minLength?o.minLength.value:void 0,max_length:o.typeName==="ZodArray"&&o.maxLength?o.maxLength.value:void 0,required:!0}}}return t}static _buildLengthSummary(e){let t=[];for(let[n,s]of Object.entries(e)){let i=n.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase()),a=s.min_length,o=s.max_length;if(n==="summary"){let u=s.description||"";u.includes("150-400 words")||u.includes("(150-400 words)")?t.push("Summary (150-400 words)"):t.push("Summary")}else a!==void 0&&o!==void 0&&t.push(`${i} (${a}-${o} items)`)}return t.join(", ")}static _buildLengthGuidelines(e){let t=[];for(let[n,s]of Object.entries(e)){let i=n.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase()),a=s.min_length,o=s.max_length;if(n==="summary"){let u=s.description||"";u.includes("150-400 words")||u.includes("(150-400 words)")?t.push("- Summary: 150-400 words"):t.push("- Summary: As specified in description")}else a!==void 0&&o!==void 0&&t.push(`- ${i}: ${a}-${o} items`)}return t}static buildAnalysisPrompt(){let e=$y(ka),t=r._extractFieldInfo(ka),n=[];for(let[i,a]of Object.entries(t)){if(!a.description)continue;let u=`- ${i.replace(/_/g," ").replace(/\b\w/g,f=>f.toUpperCase())}: ${a.description}`,c=a.min_length,l=a.max_length;c!==void 0&&l!==void 0&&(u+=` (${c}-${l} items)`),n.push(u)}return["Create a comprehensive analysis that strictly follows the transcript content.","","OUTPUT SCHEMA:",e,"","FIELD REQUIREMENTS:",n.join(`
`),"","CORE REQUIREMENTS:","- ACCURACY: Every claim must be directly supported by the transcript","- TONE: Write in objective, article-like style (avoid 'This video...', 'The speaker...')","- AVOID META-DESCRIPTIVE LANGUAGE: Do not use phrases like 'This analysis explores', etc. Write direct, factual content only","","CONTENT FILTERING:","- Remove all promotional content (speaker intros, calls-to-action, self-promotion)","- Keep only educational content","- Correct obvious typos naturally","","QUALITY CHECKS:","- Content matches transcript exactly (no external additions)","- All promotional content removed","- Typos corrected naturally, meaning preserved",`- Length balanced: ${r._buildLengthSummary(t)}`].join(`
`)}static buildQualityPrompt(){let e=$y(Fd),t=r._extractFieldInfo(Fd),n=[],s=1;for(let[u,c]of Object.entries(t)){let l=u.toUpperCase().replace(/_/g," "),f=c.description||"",p=f.includes(":")?f.split(":",2)[1].trim():f;n.push(`${s}. ${l}: ${p}`),s++}let i=r._extractFieldInfo(ka),a=r._buildLengthGuidelines(i);return["Evaluate the analysis on the following aspects. Rate each 'Fail', 'Refine', or 'Pass' with a specific reason.","","ASPECTS:",n.join(`
`),"","LENGTH GUIDELINES:",a.join(`
`),"","QUALITY STANDARDS:","- Transcript-based content only","- Professional article-like tone","","Provide specific rates and reasons for each aspect.","","OUTPUT SCHEMA:",e].join(`
`)}static buildImprovementPrompt(){let e=$y(ka),t=r._extractFieldInfo(ka),n=[];for(let[i,a]of Object.entries(t)){if(!a.description)continue;let u=`- ${i.replace(/_/g," ").replace(/\b\w/g,f=>f.toUpperCase())}: ${a.description}`,c=a.min_length,l=a.max_length;c!==void 0&&l!==void 0&&(u+=` (${c}-${l} items)`),n.push(u)}return["Improve the analysis based on quality feedback while maintaining transcript accuracy.","","IMPROVEMENT PRIORITIES:","1. TRANSCRIPT ACCURACY: All content must be transcript-supported","2. PROMOTIONAL REMOVAL: Remove all intros, calls-to-action, self-promotion","3. WRITING STYLE: Use objective, article-like tone","4. AVOID META-DESCRIPTIVE LANGUAGE: Remove phrases like 'This analysis explores', etc.","5. TYPO CORRECTION: Fix obvious typos naturally","6. ARRAY FORMATTING: Return takeaways/key_facts as simple string arrays","","CONTENT TARGETS:",n.join(`
`),"","OUTPUT SCHEMA:",e].join(`
`)}},ai=class r{static calculateScore(e){let t={Fail:0,Refine:1,Pass:2},n=[e.completeness,e.accuracy,e.structure,e.grammar,e.no_garbage],s=n.reduce((o,u)=>o+t[u.rate],0),i=n.length*2;return Math.round(s/i*100)}static isAcceptable(e){return r.calculateScore(e)>=In.MIN_QUALITY_SCORE}static printQualityBreakdown(e){let t=r.calculateScore(e);console.log("\u{1F4C8} Quality breakdown:"),console.log(`Completeness: ${e.completeness.rate} - ${e.completeness.reason}`),console.log(`Accuracy: ${e.accuracy.rate} - ${e.accuracy.reason}`),console.log(`Structure: ${e.structure.rate} - ${e.structure.reason}`),console.log(`Grammar: ${e.grammar.rate} - ${e.grammar.reason}`),console.log(`No Garbage: ${e.no_garbage.rate} - ${e.no_garbage.reason}`),console.log(`Total Score: ${t}%`),r.isAcceptable(e)||console.log(`\u26A0\uFE0F  Quality below threshold (${In.MIN_QUALITY_SCORE}%), refinement needed`)}},OM=Fa({transcript:wr(),analysis_model:wr().default(In.ANALYSIS_MODEL),quality_model:wr().default(In.QUALITY_MODEL),analysis:ka.nullable().default(null),quality:Fd.nullable().default(null),iteration_count:jl().default(0),is_complete:Ml().default(!1),apiKey:wr().optional(),progressCallback:Xd().optional()});function hP(r,e){let t=typeof chrome<"u"&&chrome.runtime?chrome.runtime.getURL(""):"https://github.com/better-youtube-caption";return new bl({model:r,apiKey:e,configuration:{baseURL:"https://openrouter.ai/api/v1",defaultHeaders:{"HTTP-Referer":t,"X-Title":"Better YouTube Caption"}},temperature:0})}async function PM(r){let e=r.apiKey,t=r.progressCallback;t&&(r.quality&&r.analysis?t("\u{1F527} Refining analysis based on quality feedback..."):t(`\u{1F4DD} Generating initial analysis. Transcript length: ${r.transcript.length} characters`));let s=hP(r.analysis_model,e).withStructuredOutput(ka,{method:"jsonMode"}),i,a;if(r.quality&&r.analysis){let o=`# Improve this video analysis based on the following feedback:
## Analysis:
${JSON.stringify(r.analysis,null,2)}
## Quality Assessment:
${JSON.stringify(r.quality,null,2)}
Please provide an improved version that addresses the specific issues identified above to improve the overall quality score.`,u=Eu.buildImprovementPrompt(),l=`${`Original Transcript:
${r.transcript}`}

${o}`;i=Ns.fromMessages([["system",u],["human","{improvement_prompt}"]]);try{let p=await i.pipe(s).invoke({improvement_prompt:l});return t&&t("\u2728 Analysis refined successfully"),{analysis:p,iteration_count:r.iteration_count+1}}catch(f){throw console.error("Refinement failed:",f),t&&t(`Error in refinement: ${f.message}`),new Error(`Analysis refinement failed: ${f.message}`)}}else{let o=Eu.buildAnalysisPrompt();i=Ns.fromMessages([["system",o],["human","{content}"]]);try{let c=await i.pipe(s).invoke({content:r.transcript});return t&&t("\u{1F4CA} Analysis completed"),{analysis:c,iteration_count:r.iteration_count+1}}catch(u){throw console.error("Generation failed:",u),t&&t(`Error in generation: ${u.message}`),new Error(`Analysis generation failed: ${u.message}`)}}}async function SM(r){let e=r.apiKey,t=r.progressCallback;t&&(t("\u{1F50D} Performing quality check..."),t(`\u{1F50D} Using model: ${r.quality_model}`));let s=hP(r.quality_model,e).withStructuredOutput(Fd,{method:"jsonMode"});try{let i=Eu.buildQualityPrompt(),a=JSON.stringify(r.analysis,null,2),c=await Ns.fromMessages([["system",i],["human","{analysis_text}"]]).pipe(s).invoke({analysis_text:a});ai.printQualityBreakdown(c);let f=ai.calculateScore(c)>=In.MIN_QUALITY_SCORE||r.iteration_count>=In.MAX_ITERATIONS;return{quality:c,is_complete:f}}catch(i){throw console.error("Quality check failed:",i),t&&t(`Error in quality check: ${i.message}`),new Error(`Quality node failed: ${i.message}`)}}function IM(r){if(r.is_complete)return console.log("\u{1F504} Workflow complete (is_complete=True)"),te;let e=r.quality?ai.calculateScore(r.quality):0;return r.quality&&!ai.isAcceptable(r.quality)&&r.iteration_count<In.MAX_ITERATIONS?(console.log(`\u{1F504} Quality ${e}% below threshold ${In.MIN_QUALITY_SCORE}%, refining (iteration ${r.iteration_count+1})`),"analysisNode"):(console.log(`\u{1F504} Workflow ending (quality: ${e}%, iterations: ${r.iteration_count})`),te)}function TM(){return new ra(OM).addNode("analysisNode",PM).addNode("qualityNode",SM).addEdge(me,"analysisNode").addEdge("analysisNode","qualityNode").addConditionalEdges("qualityNode",IM,{analysisNode:"analysisNode",[te]:te}).compile()}async function pP(r,e,t){let n=TM(),s={transcript:r.transcript,analysis_model:r.analysis_model||In.ANALYSIS_MODEL,quality_model:r.quality_model||In.QUALITY_MODEL,analysis:null,quality:null,iteration_count:0,is_complete:!1,apiKey:e,progressCallback:t},i=await n.invoke(s),a=i.quality?ai.calculateScore(i.quality):0,o=kM(i.analysis);return{analysis:i.analysis,quality:i.quality,iteration_count:i.iteration_count,quality_score:a,summary_text:o}}function kM(r){let e=[];return e.push("## Summary"),e.push(""),e.push(r.summary),e.push(""),r.takeaways&&r.takeaways.length>0&&(e.push("## Key Takeaways"),e.push(""),r.takeaways.forEach(t=>{e.push(`- ${t}`)}),e.push("")),r.key_facts&&r.key_facts.length>0&&(e.push("## Key Facts"),e.push(""),r.key_facts.forEach(t=>{e.push(`- ${t}`)}),e.push("")),e.join(`
`)}typeof globalThis<"u"&&(globalThis.executeSummarizationWorkflow=pP,globalThis.SummaryWorkflow={executeSummarizationWorkflow:pP,PromptBuilder:Eu,QualityUtils:ai});})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/js-sha256/hash.js:
  (**
   * [js-sha256]{@link https://github.com/emn178/js-sha256}
   *
   * @version 0.11.1
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2025
   * @license MIT
   *)
*/
//# sourceMappingURL=captionSummarizer.js.map
