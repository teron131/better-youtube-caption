(()=>{var i={SCRAPE_CREATORS_API_KEY:"scrapeCreatorsApiKey",OPENROUTER_API_KEY:"openRouterApiKey",SUMMARIZER_RECOMMENDED_MODEL:"summarizerRecommendedModel",SUMMARIZER_CUSTOM_MODEL:"summarizerCustomModel",REFINER_RECOMMENDED_MODEL:"refinerRecommendedModel",REFINER_CUSTOM_MODEL:"refinerCustomModel",AUTO_GENERATE:"autoGenerate",SHOW_SUBTITLES:"showSubtitles",CAPTION_FONT_SIZE:"captionFontSize",SUMMARY_FONT_SIZE:"summaryFontSize",TARGET_LANGUAGE_RECOMMENDED:"targetLanguageRecommended",TARGET_LANGUAGE_CUSTOM:"targetLanguageCustom"},T={AUTO_GENERATION_DELAY_MS:2e3,INIT_RETRY_DELAY_MS:500,SUBTITLE_UPDATE_INTERVAL_MS:100,MAX_INIT_ATTEMPTS:5,CONTENT_SCRIPT_INIT_DELAY_MS:500,STATUS_MESSAGE_DISPLAY_MS:2e3,SUMMARY_SUCCESS_DISPLAY_MS:3e3,CAPTION_CHECK_DELAY_MS:500},V={QUOTA_BYTES:10*1024*1024,MAX_STORAGE_BYTES:9.5*1024*1024,ESTIMATED_VIDEO_SIZE_BYTES:30*1024,CLEANUP_BATCH_SIZE:10};var I={MODEL_SUMMARIZER:"x-ai/grok-4.1-fast",MODEL_REFINER:"google/gemini-2.5-flash-lite-preview-09-2025",AUTO_GENERATE:!1,SHOW_SUBTITLES:!0,CAPTION_FONT_SIZE:"M",SUMMARY_FONT_SIZE:"M",TARGET_LANGUAGE_RECOMMENDED:"auto",TARGET_LANGUAGE_CUSTOM:""},D={CAPTION:{S:{base:"1.4vw",max:"22px",min:"12px",fullscreen:"1.7vw",fullscreenMax:"28px"},M:{base:"1.8vw",max:"28px",min:"14px",fullscreen:"2.2vw",fullscreenMax:"36px"},L:{base:"2.2vw",max:"34px",min:"16px",fullscreen:"2.7vw",fullscreenMax:"44px"}},SUMMARY:{S:{base:"16px",h2:"22px",h3:"19px"},M:{base:"18px",h2:"26px",h3:"22px"},L:{base:"20px",h2:"30px",h3:"24px"}}};var R={VIDEO_ID_LENGTH:11,SELECTORS:{VIDEO_PLAYER:"video.html5-main-video",MOVIE_PLAYER:"#movie_player",VIDEO_CONTAINER:".html5-video-container"}},c={FETCH_SUBTITLES:"fetchSubtitles",GENERATE_SUBTITLES:"generateSubtitles",GENERATE_SUMMARY:"generateSummary",SUBTITLES_GENERATED:"subtitlesGenerated",SUMMARY_GENERATED:"summaryGenerated",UPDATE_POPUP_STATUS:"updatePopupStatus",TOGGLE_SUBTITLES:"toggleSubtitles",GET_VIDEO_TITLE:"getVideoTitle",SHOW_ERROR:"showError",UPDATE_CAPTION_FONT_SIZE:"updateCaptionFontSize"},O={SUBTITLE_CONTAINER:"youtube-gemini-subtitles-container",SUBTITLE_TEXT:"youtube-gemini-subtitles-text"};var K={MIN_VIDEOS_TO_KEEP:5,DEFAULT_BATCH_SIZE:10};var v="Better YouTube Caption:",k=!0,r=(...e)=>{k&&console.log(v,...e)},f=(...e)=>{k&&console.warn(v,...e)},s=(...e)=>{console.error(v,...e)};async function Z(e,t){try{await z({[e]:t}),console.log("Subtitles saved to local storage for video ID:",e)}catch(o){if(o.message?.includes("QUOTA"))console.warn("Storage quota exceeded, attempting cleanup..."),await J(V.CLEANUP_BATCH_SIZE),await z({[e]:t}),console.log("Subtitles saved after cleanup for video:",e);else throw o}}function z(e){return new Promise((t,o)=>{chrome.storage.local.set(e,()=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):t()})})}async function J(e=10){return new Promise((t,o)=>{chrome.storage.local.get(null,n=>{if(chrome.runtime.lastError){o(new Error(chrome.runtime.lastError.message));return}let u=ee(n),m=te(u,e);chrome.storage.local.remove(m,()=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):(console.log(`Removed ${m.length} old video transcripts`),t())})})})}function ee(e){return Object.keys(e).filter(t=>t.length===R.VIDEO_ID_LENGTH&&Array.isArray(e[t]))}function te(e,t){let o=e.length<=t?Math.max(1,e.length-K.MIN_VIDEOS_TO_KEEP):t;return e.slice(0,o)}function G(e){return new Promise(t=>{chrome.storage.local.get([e],o=>{t(o[e]||null)})})}function S(e){try{return new URL(e).searchParams.get("v")}catch(t){return console.error("Error extracting video ID:",e,t),null}}function M(){return typeof chrome<"u"&&!!chrome.runtime&&typeof chrome.runtime.id=="string"&&!!chrome.storage&&!!chrome.storage.local}function P(e){return e?.message?.toLowerCase().includes("extension context invalidated")}var w=new Set;function oe(e){return w.has(e)}function re(e){w.add(e)}function A(e){w.delete(e)}function H(e,t,o,n){return t[i.AUTO_GENERATE]!==!0?(r("Auto-gen skipped: setting disabled"),{isValid:!1,reason:"setting disabled"}):n&&!o?(r("Auto-gen skipped: captions disabled"),{isValid:!1,reason:"captions disabled"}):t[i.SCRAPE_CREATORS_API_KEY]?oe(e)?(r("Auto-gen skipped: already triggered for video",e),{isValid:!1,reason:"already triggered"}):{isValid:!0}:(r("Auto-gen skipped: missing Scrape Creators key"),{isValid:!1,reason:"missing api key"})}function ne(e){let t=S(window.location.href);return t!==e?(r("Auto-gen cancel: video ID changed",e,"->",t),A(e),!1):!0}function ie(e){return new Promise(t=>{chrome.storage.local.get([i.SHOW_SUBTITLES],o=>{o[i.SHOW_SUBTITLES]!==!1?t(!0):(r("Auto-gen cancel: captions disabled"),A(e),t(!1))})})}async function ae(e,t,o,n){ne(e)&&(n&&!await ie(e)||o())}function q(e,t,o,n,u){re(e),r("Auto-gen enabled,",u?"waiting for page to load...":"triggering immediately...","videoId:",e);let m=()=>{ae(e,t,o,n)};u?setTimeout(()=>{if(!M()){r("Context invalidated before auto-generation, aborting."),A(e);return}r("Auto-gen delay elapsed; triggering now for",e),m()},T.AUTO_GENERATION_DELAY_MS):m()}function le(e,t,o,n){return e||t?.trim()||o?.trim()||n}async function X(e=null){if(e){let n=e[i.REFINER_CUSTOM_MODEL]?.trim(),u=e[i.REFINER_RECOMMENDED_MODEL]?.trim();return n||u||I.MODEL_REFINER}let t=await G(i.REFINER_CUSTOM_MODEL),o=await G(i.REFINER_RECOMMENDED_MODEL);return le(null,t,o,I.MODEL_REFINER)}var l=null,d=null,a=null,N=null,C=null;function $(){return a=document.querySelector(R.SELECTORS.VIDEO_PLAYER),a?(N=document.querySelector(R.SELECTORS.MOVIE_PLAYER)||document.querySelector(R.SELECTORS.VIDEO_CONTAINER)||a.parentElement,!!N):!1}function W(){if(document.getElementById(O.SUBTITLE_CONTAINER)){l=document.getElementById(O.SUBTITLE_CONTAINER),d=document.getElementById(O.SUBTITLE_TEXT);return}l=document.createElement("div"),l.id=O.SUBTITLE_CONTAINER,l.style.position="absolute",l.style.zIndex="9999",l.style.pointerEvents="none",l.style.display="none",d=document.createElement("div"),d.id=O.SUBTITLE_TEXT,l.appendChild(d),N?(getComputedStyle(N).position==="static"&&(N.style.position="relative"),N.appendChild(l),r("Subtitle container added to video container.")):s("Cannot add subtitle container, video container not found.")}function F(e){let t=D.CAPTION[e]||D.CAPTION.M;document.documentElement.style.setProperty("--caption-font-size-base",t.base),document.documentElement.style.setProperty("--caption-font-size-max",t.max),document.documentElement.style.setProperty("--caption-font-size-min",t.min),document.documentElement.style.setProperty("--caption-font-size-fullscreen",t.fullscreen),document.documentElement.style.setProperty("--caption-font-size-fullscreen-max",t.fullscreenMax),d&&(d.style.fontSize=`clamp(${t.min}, ${t.base}, ${t.max})`)}function se(e){if(!a||!d||!l||isNaN(a.currentTime))return;let t=a.currentTime*1e3,o=null;for(let n of e)if(t>=n.startTime&&t<=n.endTime){o=n;break}o?(d.textContent!==o.text&&(d.textContent=o.text),l.style.display="block"):Q()}function h(e){if(!a||!l){f("Cannot start subtitle display: Player or container missing.");return}x(),r("Starting subtitle display interval.");let t=()=>se(e);C=setInterval(t,T.SUBTITLE_UPDATE_INTERVAL_MS),a.addEventListener("play",t),a.addEventListener("seeked",t),a._subtitleUpdateFn=t}function x(){C&&(clearInterval(C),C=null,r("Stopped subtitle display interval.")),a&&a._subtitleUpdateFn&&(a.removeEventListener("play",a._subtitleUpdateFn),a.removeEventListener("seeked",a._subtitleUpdateFn),delete a._subtitleUpdateFn)}function Q(){l&&(l.style.display="none"),d&&(d.textContent="")}function Y(){x(),Q()}var E=[],L=0,U=window.location.href,_=!0,p=null;async function j(e,t,o=!0,n=!1){if(!H(e,t,_,o).isValid)return!1;let m=await X(t);return q(e,t,()=>{ue(e,t[i.SCRAPE_CREATORS_API_KEY],t[i.OPENROUTER_API_KEY],m)},o,n),!0}function Ee(){try{if(!M()){f("Extension context invalidated, skipping subtitle load.");return}if(!window.location.href.includes("youtube.com/watch")){r("Not on a video page, skipping subtitle load.");return}let e=S(window.location.href);if(!e){f("Could not extract video ID, skipping subtitle load.");return}let t=[e,i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL,i.SHOW_SUBTITLES];chrome.storage.local.get(t,o=>{try{if(chrome.runtime.lastError){if(P(chrome.runtime.lastError)){r("Subtitle load aborted - extension context invalidated.");return}s("Error loading subtitles from storage:",chrome.runtime.lastError.message);return}_=o[i.SHOW_SUBTITLES]!==!1,o&&o[e]?(r("Found stored subtitles for this video."),E=o[e],_&&h(E)):(r("No stored subtitles found for this video."),j(e,o,!0,!0))}catch(n){s("Error processing stored subtitles:",n)}})}catch(e){if(e?.message?.includes("Extension context invalidated")){r("Subtitle load aborted - extension context invalidated (outer).");return}s("Error in loadStoredSubtitles:",e)}}function ue(e,t,o,n){y(),r("Sending fetchSubtitles message to background...",{action:c.FETCH_SUBTITLES,videoId:e,hasScrapeKey:!!t,hasOpenRouterKey:!!o,modelSelection:n}),chrome.runtime.sendMessage({action:c.FETCH_SUBTITLES,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:o,modelSelection:n},u=>{chrome.runtime.lastError?(s("Error triggering auto-generation:",chrome.runtime.lastError.message),A(e)):r("Auto-generation triggered successfully, response:",u)})}function ce(){p&&(p.disconnect(),p=null),p=new MutationObserver(()=>{if(!M()){p&&(p.disconnect(),p=null);return}if(U!==window.location.href){r("URL changed (mutation).");let e=S(U);U=window.location.href;let t=S(U);e!==t&&A(e),de()}}),p.observe(document.body,{childList:!0,subtree:!0})}function de(){r("Reinitializing for new video..."),y(),L=0,B()}function B(){if(r("Initializing content script..."),!window.location.href.includes("youtube.com/watch")){r("Not on a video page, skipping initialization.");return}if(!$()){L++,L<T.MAX_INIT_ATTEMPTS?(r(`Video player not found, retrying (${L}/${T.MAX_INIT_ATTEMPTS})...`),setTimeout(B,T.INIT_RETRY_DELAY_MS)):s("Video player or container not found after multiple attempts.");return}r("Video player found."),W(),Ee(),pe(),Se()}function Se(){chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action===c.GET_VIDEO_TITLE)return me(e,o),!0;if(e.action===c.GENERATE_SUMMARY)return Te(e,o),!0;if(e.action===c.GENERATE_SUBTITLES)return _e(e,o),!0;if(e.action===c.SUBTITLES_GENERATED)return fe(e,o),!0;if(e.action===c.TOGGLE_SUBTITLES)return Ae(e,o),!0;if(e.action===c.UPDATE_CAPTION_FONT_SIZE)return ge(e,o),!0})}function me(e,t){let o=document.querySelector("h1.ytd-watch-metadata yt-formatted-string"),n=o?o.textContent:null;t({title:n})}function Te(e,t){r("Received generateSummary request");let o=e.videoId||S(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}r("Requesting summary from background for video:",o),chrome.runtime.sendMessage({action:c.GENERATE_SUMMARY,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,targetLanguage:e.targetLanguage},n=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):r("Summary request sent to background, response:",n)}),t({status:"started"})}function _e(e,t){r("Received generateSubtitles request");let o=e.videoId||S(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}r("Sending video ID to background:",o),y(),chrome.runtime.sendMessage({action:c.FETCH_SUBTITLES,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,forceRegenerate:e.forceRegenerate===!0},n=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):(r("Message sent to background, response:",n),n?.status==="error"&&A(o))}),t({status:"started"})}function fe(e,t){if(r("Received subtitlesGenerated request"),E=e.subtitles||[],r(`Received ${E.length} subtitle entries.`),E.length>0){_&&h(E);let o=e.videoId||S(window.location.href);o?Z(o,E).catch(n=>{s("Error saving subtitles:",n)}):f("Could not extract video ID, subtitles not saved."),t({status:"success"})}else f("Received empty subtitles array."),y(),t({status:"no_subtitles_found"})}function pe(){try{if(!M()){r("Context invalidated, skipping font size load.");return}chrome.storage.local.get([i.CAPTION_FONT_SIZE],e=>{try{if(chrome.runtime.lastError){let o=chrome.runtime.lastError.message||"";if(P(chrome.runtime.lastError)){r("Font size load aborted - extension context invalidated.");return}f("Error loading caption font size:",o);return}let t=e?.[i.CAPTION_FONT_SIZE]||I.CAPTION_FONT_SIZE;F(t)}catch(t){if(t?.message?.includes("Extension context invalidated")){r("Font size load aborted (callback) - extension context invalidated.");return}s("Error applying caption font size:",t)}})}catch(e){if(e?.message?.includes("Extension context invalidated")){r("Font size load aborted (outer) - extension context invalidated.");return}s("Error in loadCaptionFontSize:",e)}}function ge(e,t){let o=e.fontSize||I.CAPTION_FONT_SIZE;F(o),t({status:"success"})}function Ae(e,t){r("Received toggleSubtitles request");let o=Object.prototype.hasOwnProperty.call(e,"showSubtitles"),n=Object.prototype.hasOwnProperty.call(e,"enabled"),u=o?e.showSubtitles!==!1:n?e.enabled!==!1:!0,m=_;if(_=u,chrome.storage.local.set({[i.SHOW_SUBTITLES]:_}),_&&E.length>0?h(E):(x(),Y()),_&&!m&&E.length===0){let g=S(window.location.href);g&&chrome.storage.local.get([g,i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL],b=>{if(b[g]&&b[g].length>0){r("Subtitles already exist for this video, loading them..."),E=b[g],h(E);return}j(g,b,!1,!1)})}t({status:"success"})}function y(){E=[],Y(),r("Subtitles cleared.")}(function(){r("Content script loaded, readyState:",document.readyState);let e=()=>{B(),ce()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,T.CONTENT_SCRIPT_INIT_DELAY_MS)})();})();
//# sourceMappingURL=content.bundle.js.map
