(()=>{var i={SCRAPE_CREATORS_API_KEY:"scrapeCreatorsApiKey",OPENROUTER_API_KEY:"openRouterApiKey",SUMMARIZER_RECOMMENDED_MODEL:"summarizerRecommendedModel",SUMMARIZER_CUSTOM_MODEL:"summarizerCustomModel",REFINER_RECOMMENDED_MODEL:"refinerRecommendedModel",REFINER_CUSTOM_MODEL:"refinerCustomModel",AUTO_GENERATE:"autoGenerate",SHOW_SUBTITLES:"showSubtitles",CAPTION_FONT_SIZE:"captionFontSize",SUMMARY_FONT_SIZE:"summaryFontSize",TARGET_LANGUAGE_RECOMMENDED:"targetLanguageRecommended",TARGET_LANGUAGE_CUSTOM:"targetLanguageCustom"},S={AUTO_GENERATION_DELAY_MS:2e3,INIT_RETRY_DELAY_MS:500,SUBTITLE_UPDATE_INTERVAL_MS:100,MAX_INIT_ATTEMPTS:5,CONTENT_SCRIPT_INIT_DELAY_MS:500,STATUS_MESSAGE_DISPLAY_MS:2e3,SUMMARY_SUCCESS_DISPLAY_MS:3e3,CAPTION_CHECK_DELAY_MS:500},de={QUOTA_BYTES:10*1024*1024,MAX_STORAGE_BYTES:9.5*1024*1024,ESTIMATED_VIDEO_SIZE_BYTES:30*1024,CLEANUP_BATCH_SIZE:10};var C={MODEL_SUMMARIZER:"x-ai/grok-4.1-fast",MODEL_REFINER:"google/gemini-2.5-flash-lite-preview-09-2025",AUTO_GENERATE:!1,SHOW_SUBTITLES:!0,CAPTION_FONT_SIZE:"M",SUMMARY_FONT_SIZE:"M",TARGET_LANGUAGE_RECOMMENDED:"auto",TARGET_LANGUAGE_CUSTOM:""},L={CAPTION:{S:{base:"1.4vw",max:"22px",min:"12px",fullscreen:"1.7vw",fullscreenMax:"28px"},M:{base:"1.8vw",max:"28px",min:"14px",fullscreen:"2.2vw",fullscreenMax:"36px"},L:{base:"2.2vw",max:"34px",min:"16px",fullscreen:"2.7vw",fullscreenMax:"44px"}},SUMMARY:{S:{base:"13px",h2:"17px",h3:"15px"},M:{base:"15px",h2:"20px",h3:"17px"},L:{base:"17px",h2:"23px",h3:"19px"}}};var h={VIDEO_ID_LENGTH:11,SELECTORS:{VIDEO_PLAYER:"video.html5-main-video",MOVIE_PLAYER:"#movie_player",VIDEO_CONTAINER:".html5-video-container"}},E={FETCH_SUBTITLES:"fetchSubtitles",GENERATE_SUBTITLES:"generateSubtitles",GENERATE_SUMMARY:"generateSummary",SUBTITLES_GENERATED:"subtitlesGenerated",SUMMARY_GENERATED:"summaryGenerated",UPDATE_POPUP_STATUS:"updatePopupStatus",TOGGLE_SUBTITLES:"toggleSubtitles",GET_VIDEO_TITLE:"getVideoTitle",SHOW_ERROR:"showError",UPDATE_CAPTION_FONT_SIZE:"updateCaptionFontSize"},A={SUBTITLE_CONTAINER:"youtube-gemini-subtitles-container",SUBTITLE_TEXT:"youtube-gemini-subtitles-text"};function d(e){try{return new URL(e).searchParams.get("v")}catch(t){return console.error("Error extracting video ID:",e,t),null}}function R(){return typeof chrome<"u"&&!!chrome.runtime&&typeof chrome.runtime.id=="string"&&!!chrome.storage&&!!chrome.storage.local}function D(e){return e?.message?.toLowerCase().includes("extension context invalidated")}var G="Better YouTube Caption:",k=!0,n=(...e)=>{k&&console.log(G,...e)},T=(...e)=>{k&&console.warn(G,...e)},s=(...e)=>{console.error(G,...e)};var P=new Set;function q(e){return P.has(e)}function W(e){P.add(e)}function g(e){P.delete(e)}function B(e,t,o,r){return t[i.AUTO_GENERATE]!==!0?(n("Auto-gen skipped: setting disabled"),{isValid:!1,reason:"setting disabled"}):r&&!o?(n("Auto-gen skipped: captions disabled"),{isValid:!1,reason:"captions disabled"}):t[i.SCRAPE_CREATORS_API_KEY]?q(e)?(n("Auto-gen skipped: already triggered for video",e),{isValid:!1,reason:"already triggered"}):{isValid:!0}:(n("Auto-gen skipped: missing Scrape Creators key"),{isValid:!1,reason:"missing api key"})}function X(e){let t=d(window.location.href);return t!==e?(n("Auto-gen cancel: video ID changed",e,"->",t),g(e),!1):!0}function $(e){return new Promise(t=>{chrome.storage.local.get([i.SHOW_SUBTITLES],o=>{o[i.SHOW_SUBTITLES]!==!1?t(!0):(n("Auto-gen cancel: captions disabled"),g(e),t(!1))})})}async function j(e,t,o,r){X(e)&&(r&&!await $(e)||o())}function V(e,t,o,r,f){W(e),n("Auto-gen enabled,",f?"waiting for page to load...":"triggering immediately...","videoId:",e);let I=()=>{j(e,t,o,r)};f?setTimeout(()=>{if(!R()){n("Context invalidated before auto-generation, aborting."),g(e);return}n("Auto-gen delay elapsed; triggering now for",e),I()},S.AUTO_GENERATION_DELAY_MS):I()}var l=null,c=null,a=null,O=null,M=null;function z(){return a=document.querySelector(h.SELECTORS.VIDEO_PLAYER),a?(O=document.querySelector(h.SELECTORS.MOVIE_PLAYER)||document.querySelector(h.SELECTORS.VIDEO_CONTAINER)||a.parentElement,!!O):!1}function K(){if(document.getElementById(A.SUBTITLE_CONTAINER)){l=document.getElementById(A.SUBTITLE_CONTAINER),c=document.getElementById(A.SUBTITLE_TEXT);return}l=document.createElement("div"),l.id=A.SUBTITLE_CONTAINER,l.style.position="absolute",l.style.zIndex="9999",l.style.pointerEvents="none",l.style.display="none",c=document.createElement("div"),c.id=A.SUBTITLE_TEXT,l.appendChild(c),O?(getComputedStyle(O).position==="static"&&(O.style.position="relative"),O.appendChild(l),n("Subtitle container added to video container.")):s("Cannot add subtitle container, video container not found.")}function w(e){let t=L.CAPTION[e]||L.CAPTION.M;document.documentElement.style.setProperty("--caption-font-size-base",t.base),document.documentElement.style.setProperty("--caption-font-size-max",t.max),document.documentElement.style.setProperty("--caption-font-size-min",t.min),document.documentElement.style.setProperty("--caption-font-size-fullscreen",t.fullscreen),document.documentElement.style.setProperty("--caption-font-size-fullscreen-max",t.fullscreenMax),c&&(c.style.fontSize=`clamp(${t.min}, ${t.base}, ${t.max})`)}function Q(e){if(!a||!c||!l||isNaN(a.currentTime))return;let t=a.currentTime*1e3,o=null;for(let r of e)if(t>=r.startTime&&t<=r.endTime){o=r;break}o?(c.textContent!==o.text&&(c.textContent=o.text),l.style.display="block"):H()}function b(e){if(!a||!l){T("Cannot start subtitle display: Player or container missing.");return}x(),n("Starting subtitle display interval.");let t=()=>Q(e);M=setInterval(t,S.SUBTITLE_UPDATE_INTERVAL_MS),a.addEventListener("play",t),a.addEventListener("seeked",t),a._subtitleUpdateFn=t}function x(){M&&(clearInterval(M),M=null,n("Stopped subtitle display interval.")),a&&a._subtitleUpdateFn&&(a.removeEventListener("play",a._subtitleUpdateFn),a.removeEventListener("seeked",a._subtitleUpdateFn),delete a._subtitleUpdateFn)}function H(){l&&(l.style.display="none"),c&&(c.textContent="")}function F(){x(),H()}var u=[],y=0,v=window.location.href,p=!0,m=null;function J(e){let t=e[i.REFINER_CUSTOM_MODEL]?.trim(),o=e[i.REFINER_RECOMMENDED_MODEL]?.trim();return(t&&t.length>0?t:null)||(o&&o.length>0?o:null)||C.MODEL_REFINER}function Z(e,t,o=!0,r=!1){if(!B(e,t,p,o).isValid)return!1;let I=J(t);return V(e,t,()=>{te(e,t[i.SCRAPE_CREATORS_API_KEY],t[i.OPENROUTER_API_KEY],I)},o,r),!0}function ee(){try{if(!R()){T("Extension context invalidated, skipping subtitle load.");return}if(!window.location.href.includes("youtube.com/watch")){n("Not on a video page, skipping subtitle load.");return}let e=d(window.location.href);if(!e){T("Could not extract video ID, skipping subtitle load.");return}let t=[e,i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL,i.SHOW_SUBTITLES];chrome.storage.local.get(t,o=>{try{if(chrome.runtime.lastError){if(D(chrome.runtime.lastError)){n("Subtitle load aborted - extension context invalidated.");return}s("Error loading subtitles from storage:",chrome.runtime.lastError.message);return}p=o[i.SHOW_SUBTITLES]!==!1,o&&o[e]?(n("Found stored subtitles for this video."),u=o[e],p&&b(u)):(n("No stored subtitles found for this video."),Z(e,o,!0,!0))}catch(r){s("Error processing stored subtitles:",r)}})}catch(e){if(e?.message?.includes("Extension context invalidated")){n("Subtitle load aborted - extension context invalidated (outer).");return}s("Error in loadStoredSubtitles:",e)}}function te(e,t,o,r){U(),n("Sending fetchSubtitles message to background...",{action:E.FETCH_SUBTITLES,videoId:e,hasScrapeKey:!!t,hasOpenRouterKey:!!o,modelSelection:r}),chrome.runtime.sendMessage({action:E.FETCH_SUBTITLES,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:o,modelSelection:r},f=>{chrome.runtime.lastError?(s("Error triggering auto-generation:",chrome.runtime.lastError.message),g(e)):n("Auto-generation triggered successfully, response:",f)})}function oe(){m&&(m.disconnect(),m=null),m=new MutationObserver(()=>{if(!R()){m&&(m.disconnect(),m=null);return}if(v!==window.location.href){n("URL changed (mutation).");let e=d(v);v=window.location.href;let t=d(v);e!==t&&g(e),ne()}}),m.observe(document.body,{childList:!0,subtree:!0})}function ne(){n("Reinitializing for new video..."),U(),y=0,Y()}function Y(){if(n("Initializing content script..."),!window.location.href.includes("youtube.com/watch")){n("Not on a video page, skipping initialization.");return}if(!z()){y++,y<S.MAX_INIT_ATTEMPTS?(n(`Video player not found, retrying (${y}/${S.MAX_INIT_ATTEMPTS})...`),setTimeout(Y,S.INIT_RETRY_DELAY_MS)):s("Video player or container not found after multiple attempts.");return}n("Video player found."),K(),ee(),ue(),re()}function re(){chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action===E.GET_VIDEO_TITLE)return ie(e,o),!0;if(e.action===E.GENERATE_SUMMARY)return ae(e,o),!0;if(e.action===E.GENERATE_SUBTITLES)return le(e,o),!0;if(e.action===E.SUBTITLES_GENERATED)return se(e,o),!0;if(e.action===E.TOGGLE_SUBTITLES)return ce(e,o),!0;if(e.action===E.UPDATE_CAPTION_FONT_SIZE)return Ee(e,o),!0})}function ie(e,t){let o=document.querySelector("h1.ytd-watch-metadata yt-formatted-string"),r=o?o.textContent:null;t({title:r})}function ae(e,t){n("Received generateSummary request");let o=e.videoId||d(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}n("Requesting summary from background for video:",o),chrome.runtime.sendMessage({action:E.GENERATE_SUMMARY,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,targetLanguage:e.targetLanguage},r=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):n("Summary request sent to background, response:",r)}),t({status:"started"})}function le(e,t){n("Received generateSubtitles request");let o=e.videoId||d(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}n("Sending video ID to background:",o),U(),chrome.runtime.sendMessage({action:E.FETCH_SUBTITLES,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,forceRegenerate:e.forceRegenerate===!0},r=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):(n("Message sent to background, response:",r),r?.status==="error"&&g(o))}),t({status:"started"})}function se(e,t){if(n("Received subtitlesGenerated request"),u=e.subtitles||[],n(`Received ${u.length} subtitle entries.`),u.length>0){p&&b(u);let o=e.videoId||d(window.location.href);o?chrome.storage.local.set({[o]:u},()=>{chrome.runtime.lastError?chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("QUOTA")?T("Storage quota exceeded. Transcript will not be saved, but subtitles will still display."):s("Error saving subtitles:",chrome.runtime.lastError.message):n("Subtitles saved to local storage for video ID:",o)}):T("Could not extract video ID, subtitles not saved."),t({status:"success"})}else T("Received empty subtitles array."),U(),t({status:"no_subtitles_found"})}function ue(){try{if(!R()){n("Context invalidated, skipping font size load.");return}chrome.storage.local.get([i.CAPTION_FONT_SIZE],e=>{try{if(chrome.runtime.lastError){let o=chrome.runtime.lastError.message||"";if(D(chrome.runtime.lastError)){n("Font size load aborted - extension context invalidated.");return}T("Error loading caption font size:",o);return}let t=e?.[i.CAPTION_FONT_SIZE]||C.CAPTION_FONT_SIZE;w(t)}catch(t){if(t?.message?.includes("Extension context invalidated")){n("Font size load aborted (callback) - extension context invalidated.");return}s("Error applying caption font size:",t)}})}catch(e){if(e?.message?.includes("Extension context invalidated")){n("Font size load aborted (outer) - extension context invalidated.");return}s("Error in loadCaptionFontSize:",e)}}function Ee(e,t){let o=e.fontSize||C.CAPTION_FONT_SIZE;w(o),t({status:"success"})}function ce(e,t){n("Received toggleSubtitles request");let o=Object.prototype.hasOwnProperty.call(e,"showSubtitles"),r=Object.prototype.hasOwnProperty.call(e,"enabled"),f=o?e.showSubtitles!==!1:r?e.enabled!==!1:!0,I=p;if(p=f,chrome.storage.local.set({[i.SHOW_SUBTITLES]:p}),p&&u.length>0?b(u):(x(),F()),p&&!I&&u.length===0){let _=d(window.location.href);_&&chrome.storage.local.get([_,i.AUTO_GENERATE,i.SCRAPE_CREATORS_API_KEY,i.OPENROUTER_API_KEY,i.REFINER_RECOMMENDED_MODEL,i.REFINER_CUSTOM_MODEL],N=>{if(N[_]&&N[_].length>0){n("Subtitles already exist for this video, loading them..."),u=N[_],b(u);return}Z(_,N,!1,!1)})}t({status:"success"})}function U(){u=[],F(),n("Subtitles cleared.")}(function(){n("Content script loaded, readyState:",document.readyState);let e=()=>{Y(),oe()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,S.CONTENT_SCRIPT_INIT_DELAY_MS)})();})();
//# sourceMappingURL=content.bundle.js.map
