(()=>{var r={SCRAPE_CREATORS_API_KEY:"scrapeCreatorsApiKey",OPENROUTER_API_KEY:"openRouterApiKey",SUMMARIZER_RECOMMENDED_MODEL:"summarizerRecommendedModel",SUMMARIZER_CUSTOM_MODEL:"summarizerCustomModel",REFINER_RECOMMENDED_MODEL:"refinerRecommendedModel",REFINER_CUSTOM_MODEL:"refinerCustomModel",AUTO_GENERATE:"autoGenerate",SHOW_SUBTITLES:"showSubtitles",CAPTION_FONT_SIZE:"captionFontSize",SUMMARY_FONT_SIZE:"summaryFontSize",TARGET_LANGUAGE_RECOMMENDED:"targetLanguageRecommended",TARGET_LANGUAGE_CUSTOM:"targetLanguageCustom"},I={AUTO_GENERATION_DELAY_MS:2e3,INIT_RETRY_DELAY_MS:500,SUBTITLE_UPDATE_INTERVAL_MS:100,MAX_INIT_ATTEMPTS:5},te={QUOTA_BYTES:10*1024*1024,MAX_STORAGE_BYTES:9.5*1024*1024,ESTIMATED_VIDEO_SIZE_BYTES:30*1024,CLEANUP_BATCH_SIZE:10};var O={MODEL_SUMMARIZER:"x-ai/grok-4.1-fast",MODEL_REFINER:"google/gemini-2.5-flash-lite-preview-09-2025",AUTO_GENERATE:!1,SHOW_SUBTITLES:!0,CAPTION_FONT_SIZE:"M",SUMMARY_FONT_SIZE:"M",TARGET_LANGUAGE_RECOMMENDED:"auto",TARGET_LANGUAGE_CUSTOM:""},U={CAPTION:{S:{base:"1.4vw",max:"22px",min:"12px",fullscreen:"1.7vw",fullscreenMax:"28px"},M:{base:"1.8vw",max:"28px",min:"14px",fullscreen:"2.2vw",fullscreenMax:"36px"},L:{base:"2.2vw",max:"34px",min:"16px",fullscreen:"2.7vw",fullscreenMax:"44px"}},SUMMARY:{S:{base:"13px",h2:"17px",h3:"15px"},M:{base:"15px",h2:"20px",h3:"17px"},L:{base:"17px",h2:"23px",h3:"19px"}}};var h={VIDEO_ID_LENGTH:11,SELECTORS:{VIDEO_PLAYER:"video.html5-main-video",MOVIE_PLAYER:"#movie_player",VIDEO_CONTAINER:".html5-video-container"}},c={FETCH_SUBTITLES:"fetchSubtitles",GENERATE_SUBTITLES:"generateSubtitles",GENERATE_SUMMARY:"generateSummary",SUBTITLES_GENERATED:"subtitlesGenerated",SUMMARY_GENERATED:"summaryGenerated",UPDATE_POPUP_STATUS:"updatePopupStatus",TOGGLE_SUBTITLES:"toggleSubtitles",GET_VIDEO_TITLE:"getVideoTitle",SHOW_ERROR:"showError",UPDATE_CAPTION_FONT_SIZE:"updateCaptionFontSize"},M={SUBTITLE_CONTAINER:"youtube-gemini-subtitles-container",SUBTITLE_TEXT:"youtube-gemini-subtitles-text"};function S(e){try{return new URL(e).searchParams.get("v")}catch(t){return console.error("Error extracting video ID:",e,t),null}}var D="Better YouTube Caption:",F=!0,n=(...e)=>{F&&console.log(D,...e)};var f=(...e)=>{F&&console.warn(D,...e)},s=(...e)=>{console.error(D,...e)};var E=[],a=null,d=null,l=null,A=null,x=null,C=0,N=window.location.href,_=new Set,T=!0;var p=null;function y(){return typeof chrome<"u"&&!!chrome.runtime&&typeof chrome.runtime.id=="string"&&!!chrome.storage&&!!chrome.storage.local}function B(e){let t=e[r.REFINER_CUSTOM_MODEL]?.trim(),o=e[r.REFINER_RECOMMENDED_MODEL]?.trim();return(t&&t.length>0?t:null)||(o&&o.length>0?o:null)||O.MODEL_REFINER}function k(e,t,o=!0,i=!1){if(t[r.AUTO_GENERATE]!==!0)return n("Auto-gen skipped: setting disabled"),!1;if(o&&!T)return n("Auto-gen skipped: captions disabled"),!1;if(!t[r.SCRAPE_CREATORS_API_KEY])return n("Auto-gen skipped: missing Scrape Creators key"),!1;if(_.has(e))return n("Auto-gen skipped: already triggered for video",e),!1;_.add(e),n("Auto-gen enabled,",i?"waiting for page to load...":"triggering immediately...","videoId:",e);let m=()=>{let b=()=>{let u=S(window.location.href);if(u!==e){n("Auto-gen cancel: video ID changed",e,"->",u),_.delete(e);return}let g=B(t);V(e,t[r.SCRAPE_CREATORS_API_KEY],t[r.OPENROUTER_API_KEY],g)};o?chrome.storage.local.get([r.SHOW_SUBTITLES],u=>{if(!(u[r.SHOW_SUBTITLES]!==!1)){n("Auto-gen cancel: captions disabled"),_.delete(e);return}b()}):b()};return i?setTimeout(()=>{if(!y()){n("Context invalidated before auto-generation, aborting."),_.delete(e);return}n("Auto-gen delay elapsed; triggering now for",e),m()},I.AUTO_GENERATION_DELAY_MS):m(),!0}function z(){try{if(!y()){f("Extension context invalidated, skipping subtitle load.");return}if(!window.location.href.includes("youtube.com/watch")){n("Not on a video page, skipping subtitle load.");return}let e=S(window.location.href);if(!e){f("Could not extract video ID, skipping subtitle load.");return}let t=[e,r.AUTO_GENERATE,r.SCRAPE_CREATORS_API_KEY,r.OPENROUTER_API_KEY,r.REFINER_RECOMMENDED_MODEL,r.REFINER_CUSTOM_MODEL,r.SHOW_SUBTITLES];chrome.storage.local.get(t,o=>{try{if(chrome.runtime.lastError){if(chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Extension context invalidated")){n("Subtitle load aborted - extension context invalidated.");return}s("Error loading subtitles from storage:",chrome.runtime.lastError.message);return}T=o[r.SHOW_SUBTITLES]!==!1,o&&o[e]?(n("Found stored subtitles for this video."),E=o[e],T&&v()):(n("No stored subtitles found for this video."),k(e,o,!0,!0))}catch(i){s("Error processing stored subtitles:",i)}})}catch(e){if(e&&e.message&&e.message.includes("Extension context invalidated")){n("Subtitle load aborted - extension context invalidated (outer).");return}s("Error in loadStoredSubtitles:",e)}}function V(e,t,o,i){L(),n("Sending fetchSubtitles message to background...",{action:c.FETCH_SUBTITLES,videoId:e,hasScrapeKey:!!t,hasOpenRouterKey:!!o,modelSelection:i}),chrome.runtime.sendMessage({action:c.FETCH_SUBTITLES,videoId:e,scrapeCreatorsApiKey:t,openRouterApiKey:o,modelSelection:i},m=>{chrome.runtime.lastError?(s("Error triggering auto-generation:",chrome.runtime.lastError.message),_.delete(e)):n("Auto-generation triggered successfully, response:",m)})}function K(){p&&(p.disconnect(),p=null),p=new MutationObserver(()=>{if(!y()){p&&(p.disconnect(),p=null);return}if(N!==window.location.href){n("URL changed (mutation).");let e=S(N);N=window.location.href;let t=S(N);e!==t&&_.delete(e),Z()}}),p.observe(document.body,{childList:!0,subtree:!0})}function Z(){n("Reinitializing for new video..."),L(),C=0,P()}function H(){return l=document.querySelector(h.SELECTORS.VIDEO_PLAYER),l?(A=document.querySelector(h.SELECTORS.MOVIE_PLAYER)||document.querySelector(h.SELECTORS.VIDEO_CONTAINER)||l.parentElement,!!A):!1}function P(){if(n("Initializing content script..."),!window.location.href.includes("youtube.com/watch")){n("Not on a video page, skipping initialization.");return}if(!H()){C++,C<I.MAX_INIT_ATTEMPTS?(n(`Video player not found, retrying (${C}/${I.MAX_INIT_ATTEMPTS})...`),setTimeout(P,I.INIT_RETRY_DELAY_MS)):s("Video player or container not found after multiple attempts.");return}n("Video player found.",l),n("Video container found.",A),ee(),z(),j(),q()}function q(){chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action===c.GET_VIDEO_TITLE){let i=document.querySelector("h1.ytd-watch-metadata yt-formatted-string"),m=i?i.textContent:null;return o({title:m}),!0}else{if(e.action===c.GENERATE_SUMMARY)return W(e,o),!0;if(e.action===c.GENERATE_SUBTITLES)return $(e,o),!0;if(e.action===c.SUBTITLES_GENERATED)return X(e,o),!0;if(e.action===c.TOGGLE_SUBTITLES)return J(e,o),!0;if(e.action===c.UPDATE_CAPTION_FONT_SIZE)return Q(e,o),!0}})}function W(e,t){n("Received generateSummary request");let o=e.videoId||S(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}n("Requesting summary from background for video:",o),chrome.runtime.sendMessage({action:c.GENERATE_SUMMARY,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,targetLanguage:e.targetLanguage},i=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):n("Summary request sent to background, response:",i)}),t({status:"started"})}function $(e,t){n("Received generateSubtitles request");let o=e.videoId||S(window.location.href);if(!o){t({status:"error",message:"Could not extract video ID from URL."});return}n("Sending video ID to background:",o),L(),chrome.runtime.sendMessage({action:c.FETCH_SUBTITLES,videoId:o,scrapeCreatorsApiKey:e.scrapeCreatorsApiKey,openRouterApiKey:e.openRouterApiKey,modelSelection:e.modelSelection,forceRegenerate:e.forceRegenerate===!0},i=>{chrome.runtime.lastError?(s("Error sending message to background:",chrome.runtime.lastError),t({status:"error",message:"Could not communicate with background script."})):(n("Message sent to background, response:",i),i?.status==="error"&&_.delete(o))}),t({status:"started"})}function X(e,t){if(n("Received subtitlesGenerated request"),E=e.subtitles||[],n(`Received ${E.length} subtitle entries.`),E.length>0){T&&v();let o=e.videoId||S(window.location.href);o?chrome.storage.local.set({[o]:E},()=>{chrome.runtime.lastError?chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("QUOTA")?f("Storage quota exceeded. Transcript will not be saved, but subtitles will still display."):s("Error saving subtitles:",chrome.runtime.lastError.message):n("Subtitles saved to local storage for video ID:",o)}):f("Could not extract video ID, subtitles not saved."),t({status:"success"})}else f("Received empty subtitles array."),L(),t({status:"no_subtitles_found"})}function j(){try{if(!y()){n("Context invalidated, skipping font size load.");return}chrome.storage.local.get([r.CAPTION_FONT_SIZE],e=>{try{if(chrome.runtime.lastError){let o=chrome.runtime.lastError.message||"";if(o.includes("Extension context invalidated")){n("Font size load aborted - extension context invalidated.");return}f("Error loading caption font size:",o);return}let t=e?.[r.CAPTION_FONT_SIZE]||O.CAPTION_FONT_SIZE;Y(t)}catch(t){if(t?.message?.includes("Extension context invalidated")){n("Font size load aborted (callback) - extension context invalidated.");return}s("Error applying caption font size:",t)}})}catch(e){if(e?.message?.includes("Extension context invalidated")){n("Font size load aborted (outer) - extension context invalidated.");return}s("Error in loadCaptionFontSize:",e)}}function Y(e){let t=U.CAPTION[e]||U.CAPTION.M;document.documentElement.style.setProperty("--caption-font-size-base",t.base),document.documentElement.style.setProperty("--caption-font-size-max",t.max),document.documentElement.style.setProperty("--caption-font-size-min",t.min),document.documentElement.style.setProperty("--caption-font-size-fullscreen",t.fullscreen),document.documentElement.style.setProperty("--caption-font-size-fullscreen-max",t.fullscreenMax),d&&(d.style.fontSize=`clamp(${t.min}, ${t.base}, ${t.max})`)}function Q(e,t){let o=e.fontSize||O.CAPTION_FONT_SIZE;Y(o),t({status:"success"})}function J(e,t){n("Received toggleSubtitles request");let o=Object.prototype.hasOwnProperty.call(e,"showSubtitles"),i=Object.prototype.hasOwnProperty.call(e,"enabled"),m=o?e.showSubtitles!==!1:i?e.enabled!==!1:!0,b=T;if(T=m,chrome.storage.local.set({[r.SHOW_SUBTITLES]:T}),T&&E.length>0?v():(G(),w()),T&&!b&&E.length===0){let u=S(window.location.href);u&&chrome.storage.local.get([u,r.AUTO_GENERATE,r.SCRAPE_CREATORS_API_KEY,r.OPENROUTER_API_KEY,r.REFINER_RECOMMENDED_MODEL,r.REFINER_CUSTOM_MODEL],g=>{if(g[u]&&g[u].length>0){n("Subtitles already exist for this video, loading them..."),E=g[u],v();return}k(u,g,!1,!1)})}t({status:"success"})}function ee(){document.getElementById(M.SUBTITLE_CONTAINER)||(a=document.createElement("div"),a.id=M.SUBTITLE_CONTAINER,a.style.position="absolute",a.style.zIndex="9999",a.style.pointerEvents="none",a.style.display="none",d=document.createElement("div"),d.id=M.SUBTITLE_TEXT,a.appendChild(d),A?(getComputedStyle(A).position==="static"&&(A.style.position="relative"),A.appendChild(a),n("Subtitle container added to video container.")):s("Cannot add subtitle container, video container not found."))}function v(){if(!l||!a){f("Cannot start subtitle display: Player or container missing.");return}G(),n("Starting subtitle display interval."),x=setInterval(R,I.SUBTITLE_UPDATE_INTERVAL_MS),l.addEventListener("play",R),l.addEventListener("seeked",R)}function G(){x&&(clearInterval(x),x=null,n("Stopped subtitle display interval.")),l&&(l.removeEventListener("play",R),l.removeEventListener("seeked",R))}function L(){E=[],G(),w(),n("Subtitles cleared.")}function w(){a&&(a.style.display="none"),d&&(d.textContent="")}function R(){if(!l||!d||!a||isNaN(l.currentTime))return;let e=l.currentTime*1e3,t=null;for(let o of E)if(e>=o.startTime&&e<=o.endTime){t=o;break}t?(d.textContent!==t.text&&(d.textContent=t.text),a.style.display="block"):w()}(function(){n("Content script loaded, readyState:",document.readyState);let e=()=>{P(),K()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,500)})();})();
//# sourceMappingURL=content.bundle.js.map
