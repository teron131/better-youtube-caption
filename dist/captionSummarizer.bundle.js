(()=>{(()=>{var yO=Object.create,As=Object.defineProperty,bO=Object.getOwnPropertyDescriptor,_O=Object.getOwnPropertyNames,vO=Object.getPrototypeOf,wO=Object.prototype.hasOwnProperty,OO=(e,t,a)=>t in e?As(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,v=(e,t)=>()=>(e&&(t=e(e=0)),t),F=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Ss=(e,t)=>{for(var a in t)As(e,a,{get:t[a],enumerable:!0})},kO=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of _O(t))!wO.call(e,i)&&i!==a&&As(e,i,{get:()=>t[i],enumerable:!(r=bO(t,i))||r.enumerable});return e},Mt=(e,t,a)=>(a=e!=null?yO(vO(e)):{},kO(t||!e||!e.__esModule?As(a,"default",{value:e,enumerable:!0}):a,e)),fr=(e,t,a)=>OO(e,typeof t!="symbol"?t+"":t,a),ce,lu,T,sa,js=v(()=>{(function(e){e.assertEqual=i=>{};function t(i){}e.assertIs=t;function a(i){throw new Error}e.assertNever=a,e.arrayToEnum=i=>{let n={};for(let s of i)n[s]=s;return n},e.getValidEnumValues=i=>{let n=e.objectKeys(i).filter(o=>typeof i[i[o]]!="number"),s={};for(let o of n)s[o]=i[o];return e.objectValues(s)},e.objectValues=i=>e.objectKeys(i).map(function(n){return i[n]}),e.objectKeys=typeof Object.keys=="function"?i=>Object.keys(i):i=>{let n=[];for(let s in i)Object.prototype.hasOwnProperty.call(i,s)&&n.push(s);return n},e.find=(i,n)=>{for(let s of i)if(n(s))return s},e.isInteger=typeof Number.isInteger=="function"?i=>Number.isInteger(i):i=>typeof i=="number"&&Number.isFinite(i)&&Math.floor(i)===i;function r(i,n=" | "){return i.map(s=>typeof s=="string"?`'${s}'`:s).join(n)}e.joinValues=r,e.jsonStringifyReplacer=(i,n)=>typeof n=="bigint"?n.toString():n})(ce||(ce={})),function(e){e.mergeShapes=(t,a)=>({...t,...a})}(lu||(lu={})),T=ce.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),sa=e=>{switch(typeof e){case"undefined":return T.undefined;case"string":return T.string;case"number":return Number.isNaN(e)?T.nan:T.number;case"boolean":return T.boolean;case"function":return T.function;case"bigint":return T.bigint;case"symbol":return T.symbol;case"object":return Array.isArray(e)?T.array:e===null?T.null:e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?T.promise:typeof Map<"u"&&e instanceof Map?T.map:typeof Set<"u"&&e instanceof Set?T.set:typeof Date<"u"&&e instanceof Date?T.date:T.object;default:return T.unknown}}}),P,vp,At,uu=v(()=>{js(),P=ce.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),vp=e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),At=class Rw extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let a=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,a):this.__proto__=a,this.name="ZodError",this.issues=t}format(t){let a=t||function(n){return n.message},r={_errors:[]},i=n=>{for(let s of n.issues)if(s.code==="invalid_union")s.unionErrors.map(i);else if(s.code==="invalid_return_type")i(s.returnTypeError);else if(s.code==="invalid_arguments")i(s.argumentsError);else if(s.path.length===0)r._errors.push(a(s));else{let o=r,l=0;for(;l<s.path.length;){let u=s.path[l];l===s.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(a(s))):o[u]=o[u]||{_errors:[]},o=o[u],l++}}};return i(this),r}static assert(t){if(!(t instanceof Rw))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ce.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=a=>a.message){let a={},r=[];for(let i of this.issues)if(i.path.length>0){let n=i.path[0];a[n]=a[n]||[],a[n].push(t(i))}else r.push(t(i));return{formErrors:r,fieldErrors:a}}get formErrors(){return this.flatten()}},At.create=e=>new At(e)}),wp,mr,Op=v(()=>{uu(),js(),wp=(e,t)=>{let a;switch(e.code){case P.invalid_type:e.received===T.undefined?a="Required":a=`Expected ${e.expected}, received ${e.received}`;break;case P.invalid_literal:a=`Invalid literal value, expected ${JSON.stringify(e.expected,ce.jsonStringifyReplacer)}`;break;case P.unrecognized_keys:a=`Unrecognized key(s) in object: ${ce.joinValues(e.keys,", ")}`;break;case P.invalid_union:a="Invalid input";break;case P.invalid_union_discriminator:a=`Invalid discriminator value. Expected ${ce.joinValues(e.options)}`;break;case P.invalid_enum_value:a=`Invalid enum value. Expected ${ce.joinValues(e.options)}, received '${e.received}'`;break;case P.invalid_arguments:a="Invalid function arguments";break;case P.invalid_return_type:a="Invalid function return type";break;case P.invalid_date:a="Invalid date";break;case P.invalid_string:typeof e.validation=="object"?"includes"in e.validation?(a=`Invalid input: must include "${e.validation.includes}"`,typeof e.validation.position=="number"&&(a=`${a} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?a=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?a=`Invalid input: must end with "${e.validation.endsWith}"`:ce.assertNever(e.validation):e.validation!=="regex"?a=`Invalid ${e.validation}`:a="Invalid";break;case P.too_small:e.type==="array"?a=`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:e.type==="string"?a=`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:e.type==="number"?a=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="bigint"?a=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="date"?a=`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:a="Invalid input";break;case P.too_big:e.type==="array"?a=`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:e.type==="string"?a=`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:e.type==="number"?a=`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="bigint"?a=`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="date"?a=`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:a="Invalid input";break;case P.custom:a="Invalid input";break;case P.invalid_intersection_types:a="Intersection results could not be merged";break;case P.not_multiple_of:a=`Number must be a multiple of ${e.multipleOf}`;break;case P.not_finite:a="Number must be finite";break;default:a=t.defaultError,ce.assertNever(e)}return{message:a}},mr=wp});function EO(e){cu=e}function Is(){return cu}var cu,du=v(()=>{Op(),cu=mr});function $(e,t){let a=Is(),r=Qi({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,a,a===mr?void 0:mr].filter(i=>!!i)});e.common.issues.push(r)}var Qi,kp,Ye,H,gr,qe,$s,Ts,Ga,Qr,Ep=v(()=>{du(),Op(),Qi=e=>{let{data:t,path:a,errorMaps:r,issueData:i}=e,n=[...a,...i.path||[]],s={...i,path:n};if(i.message!==void 0)return{...i,path:n,message:i.message};let o="",l=r.filter(u=>!!u).slice().reverse();for(let u of l)o=u(s,{data:t,defaultError:o}).message;return{...i,path:n,message:o}},kp=[],Ye=class Lw{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(t,a){let r=[];for(let i of a){if(i.status==="aborted")return H;i.status==="dirty"&&t.dirty(),r.push(i.value)}return{status:t.value,value:r}}static async mergeObjectAsync(t,a){let r=[];for(let i of a){let n=await i.key,s=await i.value;r.push({key:n,value:s})}return Lw.mergeObjectSync(t,r)}static mergeObjectSync(t,a){let r={};for(let i of a){let{key:n,value:s}=i;if(n.status==="aborted"||s.status==="aborted")return H;n.status==="dirty"&&t.dirty(),s.status==="dirty"&&t.dirty(),n.value!=="__proto__"&&(typeof s.value<"u"||i.alwaysSet)&&(r[n.value]=s.value)}return{status:t.value,value:r}}},H=Object.freeze({status:"aborted"}),gr=e=>({status:"dirty",value:e}),qe=e=>({status:"valid",value:e}),$s=e=>e.status==="aborted",Ts=e=>e.status==="dirty",Ga=e=>e.status==="valid",Qr=e=>typeof Promise<"u"&&e instanceof Promise}),xO=v(()=>{}),U,PO=v(()=>{(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(U||(U={}))});function re(e){if(!e)return{};let{errorMap:t,invalid_type_error:a,required_error:r,description:i}=e;if(t&&(a||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return t?{errorMap:t,description:i}:{errorMap:(n,s)=>{let{message:o}=e;return n.code==="invalid_enum_value"?{message:o??s.defaultError}:typeof s.data>"u"?{message:o??r??s.defaultError}:n.code!=="invalid_type"?{message:s.defaultError}:{message:o??a??s.defaultError}},description:i}}function xp(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:e.precision==null&&(t=`${t}(\\.\\d+)?`);let a=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${a}`}function AO(e){return new RegExp(`^${xp(e)}$`)}function Pp(e){let t=`${mu}T${xp(e)}`,a=[];return a.push(e.local?"Z?":"Z"),e.offset&&a.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${a.join("|")})`,new RegExp(`^${t}$`)}function SO(e,t){return!!((t==="v4"||!t)&&Dp.test(e)||(t==="v6"||!t)&&zp.test(e))}function jO(e,t){if(!Rp.test(e))return!1;try{let[a]=e.split(".");if(!a)return!1;let r=a.replace(/-/g,"+").replace(/_/g,"/").padEnd(a.length+(4-a.length%4)%4,"="),i=JSON.parse(atob(r));return!(typeof i!="object"||i===null||"typ"in i&&i?.typ!=="JWT"||!i.alg||t&&i.alg!==t)}catch{return!1}}function IO(e,t){return!!((t==="v4"||!t)&&Fp.test(e)||(t==="v6"||!t)&&Bp.test(e))}function $O(e,t){let a=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,i=a>r?a:r,n=Number.parseInt(e.toFixed(i).replace(".","")),s=Number.parseInt(t.toFixed(i).replace(".",""));return n%s/10**i}function ei(e){if(e instanceof pt){let t={};for(let a in e.shape){let r=e.shape[a];t[a]=Dt.create(ei(r))}return new pt({...e._def,shape:()=>t})}else return e instanceof Ka?new Ka({...e._def,type:ei(e.element)}):e instanceof Dt?Dt.create(ei(e.unwrap())):e instanceof Sa?Sa.create(ei(e.unwrap())):e instanceof Aa?Aa.create(e.items.map(t=>ei(t))):e}function hu(e,t){let a=sa(e),r=sa(t);if(e===t)return{valid:!0,data:e};if(a===T.object&&r===T.object){let i=ce.objectKeys(t),n=ce.objectKeys(e).filter(o=>i.indexOf(o)!==-1),s={...e,...t};for(let o of n){let l=hu(e[o],t[o]);if(!l.valid)return{valid:!1};s[o]=l.data}return{valid:!0,data:s}}else if(a===T.array&&r===T.array){if(e.length!==t.length)return{valid:!1};let i=[];for(let n=0;n<e.length;n++){let s=e[n],o=t[n],l=hu(s,o);if(!l.valid)return{valid:!1};i.push(l.data)}return{valid:!0,data:i}}else return a===T.date&&r===T.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}function Ap(e,t){return new di({values:e,typeName:k.ZodEnum,...re(t)})}function Sp(e,t){let a=typeof e=="function"?e(t):typeof e=="string"?{message:e}:e;return typeof a=="string"?{message:a}:a}function jp(e,t={},a){return e?br.create().superRefine((r,i)=>{let n=e(r);if(n instanceof Promise)return n.then(s=>{if(!s){let o=Sp(t,r),l=o.fatal??a??!0;i.addIssue({code:"custom",...o,fatal:l})}});if(!n){let s=Sp(t,r),o=s.fatal??a??!0;i.addIssue({code:"custom",...s,fatal:o})}}):br.create()}var Ut,pu,ie,Ip,$p,Tp,Np,Cp,Rp,Lp,Mp,Up,fu,Dp,Fp,zp,Bp,Zp,qp,mu,Vp,yr,ti,ai,ri,ii,en,ni,si,br,Ja,oa,tn,Ka,pt,oi,Pa,gu,li,Aa,yu,an,rn,bu,ui,ci,di,hi,_r,St,Dt,Sa,pi,fi,nn,Wp,Ns,Cs,mi,Hp,k,Gp,Ft,Rs,Jp,Kp,Ls,Xp,Yp,Qp,ef,_u,tf,af,rf,Ms,gi,nf,sf,of,lf,uf,cf,df,hf,pf,ff,mf,vu,gf,yf,wu,bf,_f,vf,wf,Of,kf,Ef,xf,Pf,TO=v(()=>{uu(),du(),PO(),Ep(),js(),Ut=class{constructor(e,t,a,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=a,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},pu=(e,t)=>{if(Ga(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let a=new At(e.common.issues);return this._error=a,this._error}}},ie=class{get description(){return this._def.description}_getType(e){return sa(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:sa(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Ye,ctx:{common:e.parent.common,data:e.data,parsedType:sa(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(Qr(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let a=this.safeParse(e,t);if(a.success)return a.data;throw a.error}safeParse(e,t){let a={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:sa(e)},r=this._parseSync({data:e,path:a.path,parent:a});return pu(a,r)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:sa(e)};if(!this["~standard"].async)try{let a=this._parseSync({data:e,path:[],parent:t});return Ga(a)?{value:a.value}:{issues:t.common.issues}}catch(a){a?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>Ga(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){let a=await this.safeParseAsync(e,t);if(a.success)return a.data;throw a.error}async safeParseAsync(e,t){let a={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:sa(e)},r=this._parse({data:e,path:a.path,parent:a}),i=await(Qr(r)?r:Promise.resolve(r));return pu(a,i)}refine(e,t){let a=r=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(r):t;return this._refinement((r,i)=>{let n=e(r),s=()=>i.addIssue({code:P.custom,...a(r)});return typeof Promise<"u"&&n instanceof Promise?n.then(o=>o?!0:(s(),!1)):n?!0:(s(),!1)})}refinement(e,t){return this._refinement((a,r)=>e(a)?!0:(r.addIssue(typeof t=="function"?t(a,r):t),!1))}_refinement(e){return new St({schema:this,typeName:k.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Dt.create(this,this._def)}nullable(){return Sa.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ka.create(this)}promise(){return _r.create(this,this._def)}or(e){return oi.create([this,e],this._def)}and(e){return li.create(this,e,this._def)}transform(e){return new St({...re(this._def),schema:this,typeName:k.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new pi({...re(this._def),innerType:this,defaultValue:t,typeName:k.ZodDefault})}brand(){return new Ns({typeName:k.ZodBranded,type:this,...re(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new fi({...re(this._def),innerType:this,catchValue:t,typeName:k.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Cs.create(this,e)}readonly(){return mi.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Ip=/^c[^\s-]{8,}$/i,$p=/^[0-9a-z]+$/,Tp=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Np=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Cp=/^[a-z0-9_-]{21}$/i,Rp=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Lp=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Mp=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Up="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",Dp=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Fp=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,zp=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Bp=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Zp=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,qp=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,mu="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Vp=new RegExp(`^${mu}$`),yr=class vs extends ie{_parse(t){if(this._def.coerce&&(t.data=String(t.data)),this._getType(t)!==T.string){let i=this._getOrReturnCtx(t);return $(i,{code:P.invalid_type,expected:T.string,received:i.parsedType}),H}let a=new Ye,r;for(let i of this._def.checks)if(i.kind==="min")t.data.length<i.value&&(r=this._getOrReturnCtx(t,r),$(r,{code:P.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),a.dirty());else if(i.kind==="max")t.data.length>i.value&&(r=this._getOrReturnCtx(t,r),$(r,{code:P.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),a.dirty());else if(i.kind==="length"){let n=t.data.length>i.value,s=t.data.length<i.value;(n||s)&&(r=this._getOrReturnCtx(t,r),n?$(r,{code:P.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):s&&$(r,{code:P.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),a.dirty())}else if(i.kind==="email")Mp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"email",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="emoji")fu||(fu=new RegExp(Up,"u")),fu.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"emoji",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="uuid")Np.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"uuid",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="nanoid")Cp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"nanoid",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="cuid")Ip.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"cuid",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="cuid2")$p.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"cuid2",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="ulid")Tp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"ulid",code:P.invalid_string,message:i.message}),a.dirty());else if(i.kind==="url")try{new URL(t.data)}catch{r=this._getOrReturnCtx(t,r),$(r,{validation:"url",code:P.invalid_string,message:i.message}),a.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"regex",code:P.invalid_string,message:i.message}),a.dirty())):i.kind==="trim"?t.data=t.data.trim():i.kind==="includes"?t.data.includes(i.value,i.position)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),a.dirty()):i.kind==="toLowerCase"?t.data=t.data.toLowerCase():i.kind==="toUpperCase"?t.data=t.data.toUpperCase():i.kind==="startsWith"?t.data.startsWith(i.value)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:{startsWith:i.value},message:i.message}),a.dirty()):i.kind==="endsWith"?t.data.endsWith(i.value)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:{endsWith:i.value},message:i.message}),a.dirty()):i.kind==="datetime"?Pp(i).test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:"datetime",message:i.message}),a.dirty()):i.kind==="date"?Vp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:"date",message:i.message}),a.dirty()):i.kind==="time"?AO(i).test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{code:P.invalid_string,validation:"time",message:i.message}),a.dirty()):i.kind==="duration"?Lp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"duration",code:P.invalid_string,message:i.message}),a.dirty()):i.kind==="ip"?SO(t.data,i.version)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"ip",code:P.invalid_string,message:i.message}),a.dirty()):i.kind==="jwt"?jO(t.data,i.alg)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"jwt",code:P.invalid_string,message:i.message}),a.dirty()):i.kind==="cidr"?IO(t.data,i.version)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"cidr",code:P.invalid_string,message:i.message}),a.dirty()):i.kind==="base64"?Zp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"base64",code:P.invalid_string,message:i.message}),a.dirty()):i.kind==="base64url"?qp.test(t.data)||(r=this._getOrReturnCtx(t,r),$(r,{validation:"base64url",code:P.invalid_string,message:i.message}),a.dirty()):ce.assertNever(i);return{status:a.value,value:t.data}}_regex(t,a,r){return this.refinement(i=>t.test(i),{validation:a,code:P.invalid_string,...U.errToObj(r)})}_addCheck(t){return new vs({...this._def,checks:[...this._def.checks,t]})}email(t){return this._addCheck({kind:"email",...U.errToObj(t)})}url(t){return this._addCheck({kind:"url",...U.errToObj(t)})}emoji(t){return this._addCheck({kind:"emoji",...U.errToObj(t)})}uuid(t){return this._addCheck({kind:"uuid",...U.errToObj(t)})}nanoid(t){return this._addCheck({kind:"nanoid",...U.errToObj(t)})}cuid(t){return this._addCheck({kind:"cuid",...U.errToObj(t)})}cuid2(t){return this._addCheck({kind:"cuid2",...U.errToObj(t)})}ulid(t){return this._addCheck({kind:"ulid",...U.errToObj(t)})}base64(t){return this._addCheck({kind:"base64",...U.errToObj(t)})}base64url(t){return this._addCheck({kind:"base64url",...U.errToObj(t)})}jwt(t){return this._addCheck({kind:"jwt",...U.errToObj(t)})}ip(t){return this._addCheck({kind:"ip",...U.errToObj(t)})}cidr(t){return this._addCheck({kind:"cidr",...U.errToObj(t)})}datetime(t){return typeof t=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:t}):this._addCheck({kind:"datetime",precision:typeof t?.precision>"u"?null:t?.precision,offset:t?.offset??!1,local:t?.local??!1,...U.errToObj(t?.message)})}date(t){return this._addCheck({kind:"date",message:t})}time(t){return typeof t=="string"?this._addCheck({kind:"time",precision:null,message:t}):this._addCheck({kind:"time",precision:typeof t?.precision>"u"?null:t?.precision,...U.errToObj(t?.message)})}duration(t){return this._addCheck({kind:"duration",...U.errToObj(t)})}regex(t,a){return this._addCheck({kind:"regex",regex:t,...U.errToObj(a)})}includes(t,a){return this._addCheck({kind:"includes",value:t,position:a?.position,...U.errToObj(a?.message)})}startsWith(t,a){return this._addCheck({kind:"startsWith",value:t,...U.errToObj(a)})}endsWith(t,a){return this._addCheck({kind:"endsWith",value:t,...U.errToObj(a)})}min(t,a){return this._addCheck({kind:"min",value:t,...U.errToObj(a)})}max(t,a){return this._addCheck({kind:"max",value:t,...U.errToObj(a)})}length(t,a){return this._addCheck({kind:"length",value:t,...U.errToObj(a)})}nonempty(t){return this.min(1,U.errToObj(t))}trim(){return new vs({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new vs({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new vs({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(t=>t.kind==="datetime")}get isDate(){return!!this._def.checks.find(t=>t.kind==="date")}get isTime(){return!!this._def.checks.find(t=>t.kind==="time")}get isDuration(){return!!this._def.checks.find(t=>t.kind==="duration")}get isEmail(){return!!this._def.checks.find(t=>t.kind==="email")}get isURL(){return!!this._def.checks.find(t=>t.kind==="url")}get isEmoji(){return!!this._def.checks.find(t=>t.kind==="emoji")}get isUUID(){return!!this._def.checks.find(t=>t.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(t=>t.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(t=>t.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(t=>t.kind==="cuid2")}get isULID(){return!!this._def.checks.find(t=>t.kind==="ulid")}get isIP(){return!!this._def.checks.find(t=>t.kind==="ip")}get isCIDR(){return!!this._def.checks.find(t=>t.kind==="cidr")}get isBase64(){return!!this._def.checks.find(t=>t.kind==="base64")}get isBase64url(){return!!this._def.checks.find(t=>t.kind==="base64url")}get minLength(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxLength(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}},yr.create=e=>new yr({checks:[],typeName:k.ZodString,coerce:e?.coerce??!1,...re(e)}),ti=class np extends ie{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){if(this._def.coerce&&(t.data=Number(t.data)),this._getType(t)!==T.number){let i=this._getOrReturnCtx(t);return $(i,{code:P.invalid_type,expected:T.number,received:i.parsedType}),H}let a,r=new Ye;for(let i of this._def.checks)i.kind==="int"?ce.isInteger(t.data)||(a=this._getOrReturnCtx(t,a),$(a,{code:P.invalid_type,expected:"integer",received:"float",message:i.message}),r.dirty()):i.kind==="min"?(i.inclusive?t.data<i.value:t.data<=i.value)&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):i.kind==="max"?(i.inclusive?t.data>i.value:t.data>=i.value)&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):i.kind==="multipleOf"?$O(t.data,i.value)!==0&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.not_multiple_of,multipleOf:i.value,message:i.message}),r.dirty()):i.kind==="finite"?Number.isFinite(t.data)||(a=this._getOrReturnCtx(t,a),$(a,{code:P.not_finite,message:i.message}),r.dirty()):ce.assertNever(i);return{status:r.value,value:t.data}}gte(t,a){return this.setLimit("min",t,!0,U.toString(a))}gt(t,a){return this.setLimit("min",t,!1,U.toString(a))}lte(t,a){return this.setLimit("max",t,!0,U.toString(a))}lt(t,a){return this.setLimit("max",t,!1,U.toString(a))}setLimit(t,a,r,i){return new np({...this._def,checks:[...this._def.checks,{kind:t,value:a,inclusive:r,message:U.toString(i)}]})}_addCheck(t){return new np({...this._def,checks:[...this._def.checks,t]})}int(t){return this._addCheck({kind:"int",message:U.toString(t)})}positive(t){return this._addCheck({kind:"min",value:0,inclusive:!1,message:U.toString(t)})}negative(t){return this._addCheck({kind:"max",value:0,inclusive:!1,message:U.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:0,inclusive:!0,message:U.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:0,inclusive:!0,message:U.toString(t)})}multipleOf(t,a){return this._addCheck({kind:"multipleOf",value:t,message:U.toString(a)})}finite(t){return this._addCheck({kind:"finite",message:U.toString(t)})}safe(t){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:U.toString(t)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:U.toString(t)})}get minValue(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxValue(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}get isInt(){return!!this._def.checks.find(t=>t.kind==="int"||t.kind==="multipleOf"&&ce.isInteger(t.value))}get isFinite(){let t=null,a=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(a===null||r.value>a)&&(a=r.value):r.kind==="max"&&(t===null||r.value<t)&&(t=r.value)}return Number.isFinite(a)&&Number.isFinite(t)}},ti.create=e=>new ti({checks:[],typeName:k.ZodNumber,coerce:e?.coerce||!1,...re(e)}),ai=class sp extends ie{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){if(this._def.coerce)try{t.data=BigInt(t.data)}catch{return this._getInvalidInput(t)}if(this._getType(t)!==T.bigint)return this._getInvalidInput(t);let a,r=new Ye;for(let i of this._def.checks)i.kind==="min"?(i.inclusive?t.data<i.value:t.data<=i.value)&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),r.dirty()):i.kind==="max"?(i.inclusive?t.data>i.value:t.data>=i.value)&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),r.dirty()):i.kind==="multipleOf"?t.data%i.value!==BigInt(0)&&(a=this._getOrReturnCtx(t,a),$(a,{code:P.not_multiple_of,multipleOf:i.value,message:i.message}),r.dirty()):ce.assertNever(i);return{status:r.value,value:t.data}}_getInvalidInput(t){let a=this._getOrReturnCtx(t);return $(a,{code:P.invalid_type,expected:T.bigint,received:a.parsedType}),H}gte(t,a){return this.setLimit("min",t,!0,U.toString(a))}gt(t,a){return this.setLimit("min",t,!1,U.toString(a))}lte(t,a){return this.setLimit("max",t,!0,U.toString(a))}lt(t,a){return this.setLimit("max",t,!1,U.toString(a))}setLimit(t,a,r,i){return new sp({...this._def,checks:[...this._def.checks,{kind:t,value:a,inclusive:r,message:U.toString(i)}]})}_addCheck(t){return new sp({...this._def,checks:[...this._def.checks,t]})}positive(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:U.toString(t)})}negative(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:U.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:U.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:U.toString(t)})}multipleOf(t,a){return this._addCheck({kind:"multipleOf",value:t,message:U.toString(a)})}get minValue(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxValue(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}},ai.create=e=>new ai({checks:[],typeName:k.ZodBigInt,coerce:e?.coerce??!1,...re(e)}),ri=class extends ie{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==T.boolean){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.boolean,received:t.parsedType}),H}return qe(e.data)}},ri.create=e=>new ri({typeName:k.ZodBoolean,coerce:e?.coerce||!1,...re(e)}),ii=class Mw extends ie{_parse(t){if(this._def.coerce&&(t.data=new Date(t.data)),this._getType(t)!==T.date){let i=this._getOrReturnCtx(t);return $(i,{code:P.invalid_type,expected:T.date,received:i.parsedType}),H}if(Number.isNaN(t.data.getTime())){let i=this._getOrReturnCtx(t);return $(i,{code:P.invalid_date}),H}let a=new Ye,r;for(let i of this._def.checks)i.kind==="min"?t.data.getTime()<i.value&&(r=this._getOrReturnCtx(t,r),$(r,{code:P.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),a.dirty()):i.kind==="max"?t.data.getTime()>i.value&&(r=this._getOrReturnCtx(t,r),$(r,{code:P.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),a.dirty()):ce.assertNever(i);return{status:a.value,value:new Date(t.data.getTime())}}_addCheck(t){return new Mw({...this._def,checks:[...this._def.checks,t]})}min(t,a){return this._addCheck({kind:"min",value:t.getTime(),message:U.toString(a)})}max(t,a){return this._addCheck({kind:"max",value:t.getTime(),message:U.toString(a)})}get minDate(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t!=null?new Date(t):null}get maxDate(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t!=null?new Date(t):null}},ii.create=e=>new ii({checks:[],coerce:e?.coerce||!1,typeName:k.ZodDate,...re(e)}),en=class extends ie{_parse(e){if(this._getType(e)!==T.symbol){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.symbol,received:t.parsedType}),H}return qe(e.data)}},en.create=e=>new en({typeName:k.ZodSymbol,...re(e)}),ni=class extends ie{_parse(e){if(this._getType(e)!==T.undefined){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.undefined,received:t.parsedType}),H}return qe(e.data)}},ni.create=e=>new ni({typeName:k.ZodUndefined,...re(e)}),si=class extends ie{_parse(e){if(this._getType(e)!==T.null){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.null,received:t.parsedType}),H}return qe(e.data)}},si.create=e=>new si({typeName:k.ZodNull,...re(e)}),br=class extends ie{constructor(){super(...arguments),this._any=!0}_parse(e){return qe(e.data)}},br.create=e=>new br({typeName:k.ZodAny,...re(e)}),Ja=class extends ie{constructor(){super(...arguments),this._unknown=!0}_parse(e){return qe(e.data)}},Ja.create=e=>new Ja({typeName:k.ZodUnknown,...re(e)}),oa=class extends ie{_parse(e){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.never,received:t.parsedType}),H}},oa.create=e=>new oa({typeName:k.ZodNever,...re(e)}),tn=class extends ie{_parse(e){if(this._getType(e)!==T.undefined){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.void,received:t.parsedType}),H}return qe(e.data)}},tn.create=e=>new tn({typeName:k.ZodVoid,...re(e)}),Ka=class au extends ie{_parse(t){let{ctx:a,status:r}=this._processInputParams(t),i=this._def;if(a.parsedType!==T.array)return $(a,{code:P.invalid_type,expected:T.array,received:a.parsedType}),H;if(i.exactLength!==null){let s=a.data.length>i.exactLength.value,o=a.data.length<i.exactLength.value;(s||o)&&($(a,{code:s?P.too_big:P.too_small,minimum:o?i.exactLength.value:void 0,maximum:s?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),r.dirty())}if(i.minLength!==null&&a.data.length<i.minLength.value&&($(a,{code:P.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),r.dirty()),i.maxLength!==null&&a.data.length>i.maxLength.value&&($(a,{code:P.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),r.dirty()),a.common.async)return Promise.all([...a.data].map((s,o)=>i.type._parseAsync(new Ut(a,s,a.path,o)))).then(s=>Ye.mergeArray(r,s));let n=[...a.data].map((s,o)=>i.type._parseSync(new Ut(a,s,a.path,o)));return Ye.mergeArray(r,n)}get element(){return this._def.type}min(t,a){return new au({...this._def,minLength:{value:t,message:U.toString(a)}})}max(t,a){return new au({...this._def,maxLength:{value:t,message:U.toString(a)}})}length(t,a){return new au({...this._def,exactLength:{value:t,message:U.toString(a)}})}nonempty(t){return this.min(1,t)}},Ka.create=(e,t)=>new Ka({type:e,minLength:null,maxLength:null,exactLength:null,typeName:k.ZodArray,...re(t)}),pt=class na extends ie{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let t=this._def.shape(),a=ce.objectKeys(t);return this._cached={shape:t,keys:a},this._cached}_parse(t){if(this._getType(t)!==T.object){let l=this._getOrReturnCtx(t);return $(l,{code:P.invalid_type,expected:T.object,received:l.parsedType}),H}let{status:a,ctx:r}=this._processInputParams(t),{shape:i,keys:n}=this._getCached(),s=[];if(!(this._def.catchall instanceof oa&&this._def.unknownKeys==="strip"))for(let l in r.data)n.includes(l)||s.push(l);let o=[];for(let l of n){let u=i[l],c=r.data[l];o.push({key:{status:"valid",value:l},value:u._parse(new Ut(r,c,r.path,l)),alwaysSet:l in r.data})}if(this._def.catchall instanceof oa){let l=this._def.unknownKeys;if(l==="passthrough")for(let u of s)o.push({key:{status:"valid",value:u},value:{status:"valid",value:r.data[u]}});else if(l==="strict")s.length>0&&($(r,{code:P.unrecognized_keys,keys:s}),a.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let l=this._def.catchall;for(let u of s){let c=r.data[u];o.push({key:{status:"valid",value:u},value:l._parse(new Ut(r,c,r.path,u)),alwaysSet:u in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let l=[];for(let u of o){let c=await u.key,d=await u.value;l.push({key:c,value:d,alwaysSet:u.alwaysSet})}return l}).then(l=>Ye.mergeObjectSync(a,l)):Ye.mergeObjectSync(a,o)}get shape(){return this._def.shape()}strict(t){return U.errToObj,new na({...this._def,unknownKeys:"strict",...t!==void 0?{errorMap:(a,r)=>{let i=this._def.errorMap?.(a,r).message??r.defaultError;return a.code==="unrecognized_keys"?{message:U.errToObj(t).message??i}:{message:i}}}:{}})}strip(){return new na({...this._def,unknownKeys:"strip"})}passthrough(){return new na({...this._def,unknownKeys:"passthrough"})}extend(t){return new na({...this._def,shape:()=>({...this._def.shape(),...t})})}merge(t){return new na({unknownKeys:t._def.unknownKeys,catchall:t._def.catchall,shape:()=>({...this._def.shape(),...t._def.shape()}),typeName:k.ZodObject})}setKey(t,a){return this.augment({[t]:a})}catchall(t){return new na({...this._def,catchall:t})}pick(t){let a={};for(let r of ce.objectKeys(t))t[r]&&this.shape[r]&&(a[r]=this.shape[r]);return new na({...this._def,shape:()=>a})}omit(t){let a={};for(let r of ce.objectKeys(this.shape))t[r]||(a[r]=this.shape[r]);return new na({...this._def,shape:()=>a})}deepPartial(){return ei(this)}partial(t){let a={};for(let r of ce.objectKeys(this.shape)){let i=this.shape[r];t&&!t[r]?a[r]=i:a[r]=i.optional()}return new na({...this._def,shape:()=>a})}required(t){let a={};for(let r of ce.objectKeys(this.shape))if(t&&!t[r])a[r]=this.shape[r];else{let i=this.shape[r];for(;i instanceof Dt;)i=i._def.innerType;a[r]=i}return new na({...this._def,shape:()=>a})}keyof(){return Ap(ce.objectKeys(this.shape))}},pt.create=(e,t)=>new pt({shape:()=>e,unknownKeys:"strip",catchall:oa.create(),typeName:k.ZodObject,...re(t)}),pt.strictCreate=(e,t)=>new pt({shape:()=>e,unknownKeys:"strict",catchall:oa.create(),typeName:k.ZodObject,...re(t)}),pt.lazycreate=(e,t)=>new pt({shape:e,unknownKeys:"strip",catchall:oa.create(),typeName:k.ZodObject,...re(t)}),oi=class extends ie{_parse(e){let{ctx:t}=this._processInputParams(e),a=this._def.options;function r(i){for(let s of i)if(s.result.status==="valid")return s.result;for(let s of i)if(s.result.status==="dirty")return t.common.issues.push(...s.ctx.common.issues),s.result;let n=i.map(s=>new At(s.ctx.common.issues));return $(t,{code:P.invalid_union,unionErrors:n}),H}if(t.common.async)return Promise.all(a.map(async i=>{let n={...t,common:{...t.common,issues:[]},parent:null};return{result:await i._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(r);{let i,n=[];for(let o of a){let l={...t,common:{...t.common,issues:[]},parent:null},u=o._parseSync({data:t.data,path:t.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!i&&(i={result:u,ctx:l}),l.common.issues.length&&n.push(l.common.issues)}if(i)return t.common.issues.push(...i.ctx.common.issues),i.result;let s=n.map(o=>new At(o));return $(t,{code:P.invalid_union,unionErrors:s}),H}}get options(){return this._def.options}},oi.create=(e,t)=>new oi({options:e,typeName:k.ZodUnion,...re(t)}),Pa=e=>e instanceof ui?Pa(e.schema):e instanceof St?Pa(e.innerType()):e instanceof ci?[e.value]:e instanceof di?e.options:e instanceof hi?ce.objectValues(e.enum):e instanceof pi?Pa(e._def.innerType):e instanceof ni?[void 0]:e instanceof si?[null]:e instanceof Dt?[void 0,...Pa(e.unwrap())]:e instanceof Sa?[null,...Pa(e.unwrap())]:e instanceof Ns||e instanceof mi?Pa(e.unwrap()):e instanceof fi?Pa(e._def.innerType):[],gu=class Uw extends ie{_parse(t){let{ctx:a}=this._processInputParams(t);if(a.parsedType!==T.object)return $(a,{code:P.invalid_type,expected:T.object,received:a.parsedType}),H;let r=this.discriminator,i=a.data[r],n=this.optionsMap.get(i);return n?a.common.async?n._parseAsync({data:a.data,path:a.path,parent:a}):n._parseSync({data:a.data,path:a.path,parent:a}):($(a,{code:P.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),H)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(t,a,r){let i=new Map;for(let n of a){let s=Pa(n.shape[t]);if(!s.length)throw new Error(`A discriminator value for key \`${t}\` could not be extracted from all schema options`);for(let o of s){if(i.has(o))throw new Error(`Discriminator property ${String(t)} has duplicate value ${String(o)}`);i.set(o,n)}}return new Uw({typeName:k.ZodDiscriminatedUnion,discriminator:t,options:a,optionsMap:i,...re(r)})}},li=class extends ie{_parse(e){let{status:t,ctx:a}=this._processInputParams(e),r=(i,n)=>{if($s(i)||$s(n))return H;let s=hu(i.value,n.value);return s.valid?((Ts(i)||Ts(n))&&t.dirty(),{status:t.value,value:s.data}):($(a,{code:P.invalid_intersection_types}),H)};return a.common.async?Promise.all([this._def.left._parseAsync({data:a.data,path:a.path,parent:a}),this._def.right._parseAsync({data:a.data,path:a.path,parent:a})]).then(([i,n])=>r(i,n)):r(this._def.left._parseSync({data:a.data,path:a.path,parent:a}),this._def.right._parseSync({data:a.data,path:a.path,parent:a}))}},li.create=(e,t,a)=>new li({left:e,right:t,typeName:k.ZodIntersection,...re(a)}),Aa=class Dw extends ie{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==T.array)return $(r,{code:P.invalid_type,expected:T.array,received:r.parsedType}),H;if(r.data.length<this._def.items.length)return $(r,{code:P.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),H;!this._def.rest&&r.data.length>this._def.items.length&&($(r,{code:P.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),a.dirty());let i=[...r.data].map((n,s)=>{let o=this._def.items[s]||this._def.rest;return o?o._parse(new Ut(r,n,r.path,s)):null}).filter(n=>!!n);return r.common.async?Promise.all(i).then(n=>Ye.mergeArray(a,n)):Ye.mergeArray(a,i)}get items(){return this._def.items}rest(t){return new Dw({...this._def,rest:t})}},Aa.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Aa({items:e,typeName:k.ZodTuple,rest:null,...re(t)})},yu=class op extends ie{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==T.object)return $(r,{code:P.invalid_type,expected:T.object,received:r.parsedType}),H;let i=[],n=this._def.keyType,s=this._def.valueType;for(let o in r.data)i.push({key:n._parse(new Ut(r,o,r.path,o)),value:s._parse(new Ut(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Ye.mergeObjectAsync(a,i):Ye.mergeObjectSync(a,i)}get element(){return this._def.valueType}static create(t,a,r){return a instanceof ie?new op({keyType:t,valueType:a,typeName:k.ZodRecord,...re(r)}):new op({keyType:yr.create(),valueType:t,typeName:k.ZodRecord,...re(a)})}},an=class extends ie{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==T.map)return $(a,{code:P.invalid_type,expected:T.map,received:a.parsedType}),H;let r=this._def.keyType,i=this._def.valueType,n=[...a.data.entries()].map(([s,o],l)=>({key:r._parse(new Ut(a,s,a.path,[l,"key"])),value:i._parse(new Ut(a,o,a.path,[l,"value"]))}));if(a.common.async){let s=new Map;return Promise.resolve().then(async()=>{for(let o of n){let l=await o.key,u=await o.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),s.set(l.value,u.value)}return{status:t.value,value:s}})}else{let s=new Map;for(let o of n){let l=o.key,u=o.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),s.set(l.value,u.value)}return{status:t.value,value:s}}}},an.create=(e,t,a)=>new an({valueType:t,keyType:e,typeName:k.ZodMap,...re(a)}),rn=class lp extends ie{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==T.set)return $(r,{code:P.invalid_type,expected:T.set,received:r.parsedType}),H;let i=this._def;i.minSize!==null&&r.data.size<i.minSize.value&&($(r,{code:P.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),a.dirty()),i.maxSize!==null&&r.data.size>i.maxSize.value&&($(r,{code:P.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),a.dirty());let n=this._def.valueType;function s(l){let u=new Set;for(let c of l){if(c.status==="aborted")return H;c.status==="dirty"&&a.dirty(),u.add(c.value)}return{status:a.value,value:u}}let o=[...r.data.values()].map((l,u)=>n._parse(new Ut(r,l,r.path,u)));return r.common.async?Promise.all(o).then(l=>s(l)):s(o)}min(t,a){return new lp({...this._def,minSize:{value:t,message:U.toString(a)}})}max(t,a){return new lp({...this._def,maxSize:{value:t,message:U.toString(a)}})}size(t,a){return this.min(t,a).max(t,a)}nonempty(t){return this.min(1,t)}},rn.create=(e,t)=>new rn({valueType:e,minSize:null,maxSize:null,typeName:k.ZodSet,...re(t)}),bu=class ru extends ie{constructor(){super(...arguments),this.validate=this.implement}_parse(t){let{ctx:a}=this._processInputParams(t);if(a.parsedType!==T.function)return $(a,{code:P.invalid_type,expected:T.function,received:a.parsedType}),H;function r(o,l){return Qi({data:o,path:a.path,errorMaps:[a.common.contextualErrorMap,a.schemaErrorMap,Is(),mr].filter(u=>!!u),issueData:{code:P.invalid_arguments,argumentsError:l}})}function i(o,l){return Qi({data:o,path:a.path,errorMaps:[a.common.contextualErrorMap,a.schemaErrorMap,Is(),mr].filter(u=>!!u),issueData:{code:P.invalid_return_type,returnTypeError:l}})}let n={errorMap:a.common.contextualErrorMap},s=a.data;if(this._def.returns instanceof _r){let o=this;return qe(async function(...l){let u=new At([]),c=await o._def.args.parseAsync(l,n).catch(h=>{throw u.addIssue(r(l,h)),u}),d=await Reflect.apply(s,this,c);return await o._def.returns._def.type.parseAsync(d,n).catch(h=>{throw u.addIssue(i(d,h)),u})})}else{let o=this;return qe(function(...l){let u=o._def.args.safeParse(l,n);if(!u.success)throw new At([r(l,u.error)]);let c=Reflect.apply(s,this,u.data),d=o._def.returns.safeParse(c,n);if(!d.success)throw new At([i(c,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...t){return new ru({...this._def,args:Aa.create(t).rest(Ja.create())})}returns(t){return new ru({...this._def,returns:t})}implement(t){return this.parse(t)}strictImplement(t){return this.parse(t)}static create(t,a,r){return new ru({args:t||Aa.create([]).rest(Ja.create()),returns:a||Ja.create(),typeName:k.ZodFunction,...re(r)})}},ui=class extends ie{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}},ui.create=(e,t)=>new ui({getter:e,typeName:k.ZodLazy,...re(t)}),ci=class extends ie{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return $(t,{received:t.data,code:P.invalid_literal,expected:this._def.value}),H}return{status:"valid",value:e.data}}get value(){return this._def.value}},ci.create=(e,t)=>new ci({value:e,typeName:k.ZodLiteral,...re(t)}),di=class up extends ie{_parse(t){if(typeof t.data!="string"){let a=this._getOrReturnCtx(t),r=this._def.values;return $(a,{expected:ce.joinValues(r),received:a.parsedType,code:P.invalid_type}),H}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(t.data)){let a=this._getOrReturnCtx(t),r=this._def.values;return $(a,{received:a.data,code:P.invalid_enum_value,options:r}),H}return qe(t.data)}get options(){return this._def.values}get enum(){let t={};for(let a of this._def.values)t[a]=a;return t}get Values(){let t={};for(let a of this._def.values)t[a]=a;return t}get Enum(){let t={};for(let a of this._def.values)t[a]=a;return t}extract(t,a=this._def){return up.create(t,{...this._def,...a})}exclude(t,a=this._def){return up.create(this.options.filter(r=>!t.includes(r)),{...this._def,...a})}},di.create=Ap,hi=class extends ie{_parse(e){let t=ce.getValidEnumValues(this._def.values),a=this._getOrReturnCtx(e);if(a.parsedType!==T.string&&a.parsedType!==T.number){let r=ce.objectValues(t);return $(a,{expected:ce.joinValues(r),received:a.parsedType,code:P.invalid_type}),H}if(this._cache||(this._cache=new Set(ce.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let r=ce.objectValues(t);return $(a,{received:a.data,code:P.invalid_enum_value,options:r}),H}return qe(e.data)}get enum(){return this._def.values}},hi.create=(e,t)=>new hi({values:e,typeName:k.ZodNativeEnum,...re(t)}),_r=class extends ie{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==T.promise&&t.common.async===!1)return $(t,{code:P.invalid_type,expected:T.promise,received:t.parsedType}),H;let a=t.parsedType===T.promise?t.data:Promise.resolve(t.data);return qe(a.then(r=>this._def.type.parseAsync(r,{path:t.path,errorMap:t.common.contextualErrorMap})))}},_r.create=(e,t)=>new _r({type:e,typeName:k.ZodPromise,...re(t)}),St=class extends ie{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===k.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:a}=this._processInputParams(e),r=this._def.effect||null,i={addIssue:n=>{$(a,n),n.fatal?t.abort():t.dirty()},get path(){return a.path}};if(i.addIssue=i.addIssue.bind(i),r.type==="preprocess"){let n=r.transform(a.data,i);if(a.common.async)return Promise.resolve(n).then(async s=>{if(t.value==="aborted")return H;let o=await this._def.schema._parseAsync({data:s,path:a.path,parent:a});return o.status==="aborted"?H:o.status==="dirty"||t.value==="dirty"?gr(o.value):o});{if(t.value==="aborted")return H;let s=this._def.schema._parseSync({data:n,path:a.path,parent:a});return s.status==="aborted"?H:s.status==="dirty"||t.value==="dirty"?gr(s.value):s}}if(r.type==="refinement"){let n=s=>{let o=r.refinement(s,i);if(a.common.async)return Promise.resolve(o);if(o instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return s};if(a.common.async===!1){let s=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});return s.status==="aborted"?H:(s.status==="dirty"&&t.dirty(),n(s.value),{status:t.value,value:s.value})}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(s=>s.status==="aborted"?H:(s.status==="dirty"&&t.dirty(),n(s.value).then(()=>({status:t.value,value:s.value}))))}if(r.type==="transform")if(a.common.async===!1){let n=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});if(!Ga(n))return H;let s=r.transform(n.value,i);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(n=>Ga(n)?Promise.resolve(r.transform(n.value,i)).then(s=>({status:t.value,value:s})):H);ce.assertNever(r)}},St.create=(e,t,a)=>new St({schema:e,typeName:k.ZodEffects,effect:t,...re(a)}),St.createWithPreprocess=(e,t,a)=>new St({schema:t,effect:{type:"preprocess",transform:e},typeName:k.ZodEffects,...re(a)}),Dt=class extends ie{_parse(e){return this._getType(e)===T.undefined?qe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}},Dt.create=(e,t)=>new Dt({innerType:e,typeName:k.ZodOptional,...re(t)}),Sa=class extends ie{_parse(e){return this._getType(e)===T.null?qe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}},Sa.create=(e,t)=>new Sa({innerType:e,typeName:k.ZodNullable,...re(t)}),pi=class extends ie{_parse(e){let{ctx:t}=this._processInputParams(e),a=t.data;return t.parsedType===T.undefined&&(a=this._def.defaultValue()),this._def.innerType._parse({data:a,path:t.path,parent:t})}removeDefault(){return this._def.innerType}},pi.create=(e,t)=>new pi({innerType:e,typeName:k.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...re(t)}),fi=class extends ie{_parse(e){let{ctx:t}=this._processInputParams(e),a={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:a.data,path:a.path,parent:{...a}});return Qr(r)?r.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new At(a.common.issues)},input:a.data})})):{status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new At(a.common.issues)},input:a.data})}}removeCatch(){return this._def.innerType}},fi.create=(e,t)=>new fi({innerType:e,typeName:k.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...re(t)}),nn=class extends ie{_parse(e){if(this._getType(e)!==T.nan){let t=this._getOrReturnCtx(e);return $(t,{code:P.invalid_type,expected:T.nan,received:t.parsedType}),H}return{status:"valid",value:e.data}}},nn.create=e=>new nn({typeName:k.ZodNaN,...re(e)}),Wp=Symbol("zod_brand"),Ns=class extends ie{_parse(e){let{ctx:t}=this._processInputParams(e),a=t.data;return this._def.type._parse({data:a,path:t.path,parent:t})}unwrap(){return this._def.type}},Cs=class Fw extends ie{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.common.async)return(async()=>{let i=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?H:i.status==="dirty"?(a.dirty(),gr(i.value)):this._def.out._parseAsync({data:i.value,path:r.path,parent:r})})();{let i=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?H:i.status==="dirty"?(a.dirty(),{status:"dirty",value:i.value}):this._def.out._parseSync({data:i.value,path:r.path,parent:r})}}static create(t,a){return new Fw({in:t,out:a,typeName:k.ZodPipeline})}},mi=class extends ie{_parse(e){let t=this._def.innerType._parse(e),a=r=>(Ga(r)&&(r.value=Object.freeze(r.value)),r);return Qr(t)?t.then(r=>a(r)):a(t)}unwrap(){return this._def.innerType}},mi.create=(e,t)=>new mi({innerType:e,typeName:k.ZodReadonly,...re(t)}),Hp={object:pt.lazycreate},function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(k||(k={})),Gp=(e,t={message:`Input not instance of ${e.name}`})=>jp(a=>a instanceof e,t),Ft=yr.create,Rs=ti.create,Jp=nn.create,Kp=ai.create,Ls=ri.create,Xp=ii.create,Yp=en.create,Qp=ni.create,ef=si.create,_u=br.create,tf=Ja.create,af=oa.create,rf=tn.create,Ms=Ka.create,gi=pt.create,nf=pt.strictCreate,sf=oi.create,of=gu.create,lf=li.create,uf=Aa.create,cf=yu.create,df=an.create,hf=rn.create,pf=bu.create,ff=ui.create,mf=ci.create,vu=di.create,gf=hi.create,yf=_r.create,wu=St.create,bf=Dt.create,_f=Sa.create,vf=St.createWithPreprocess,wf=Cs.create,Of=()=>Ft().optional(),kf=()=>Rs().optional(),Ef=()=>Ls().optional(),xf={string:e=>yr.create({...e,coerce:!0}),number:e=>ti.create({...e,coerce:!0}),boolean:e=>ri.create({...e,coerce:!0}),bigint:e=>ai.create({...e,coerce:!0}),date:e=>ii.create({...e,coerce:!0})},Pf=H}),Ve={};Ss(Ve,{BRAND:()=>Wp,DIRTY:()=>gr,EMPTY_PATH:()=>kp,INVALID:()=>H,NEVER:()=>Pf,OK:()=>qe,ParseStatus:()=>Ye,Schema:()=>ie,ZodAny:()=>br,ZodArray:()=>Ka,ZodBigInt:()=>ai,ZodBoolean:()=>ri,ZodBranded:()=>Ns,ZodCatch:()=>fi,ZodDate:()=>ii,ZodDefault:()=>pi,ZodDiscriminatedUnion:()=>gu,ZodEffects:()=>St,ZodEnum:()=>di,ZodError:()=>At,ZodFirstPartyTypeKind:()=>k,ZodFunction:()=>bu,ZodIntersection:()=>li,ZodIssueCode:()=>P,ZodLazy:()=>ui,ZodLiteral:()=>ci,ZodMap:()=>an,ZodNaN:()=>nn,ZodNativeEnum:()=>hi,ZodNever:()=>oa,ZodNull:()=>si,ZodNullable:()=>Sa,ZodNumber:()=>ti,ZodObject:()=>pt,ZodOptional:()=>Dt,ZodParsedType:()=>T,ZodPipeline:()=>Cs,ZodPromise:()=>_r,ZodReadonly:()=>mi,ZodRecord:()=>yu,ZodSchema:()=>ie,ZodSet:()=>rn,ZodString:()=>yr,ZodSymbol:()=>en,ZodTransformer:()=>St,ZodTuple:()=>Aa,ZodType:()=>ie,ZodUndefined:()=>ni,ZodUnion:()=>oi,ZodUnknown:()=>Ja,ZodVoid:()=>tn,addIssueToContext:()=>$,any:()=>_u,array:()=>Ms,bigint:()=>Kp,boolean:()=>Ls,coerce:()=>xf,custom:()=>jp,date:()=>Xp,datetimeRegex:()=>Pp,defaultErrorMap:()=>mr,discriminatedUnion:()=>of,effect:()=>wu,enum:()=>vu,function:()=>pf,getErrorMap:()=>Is,getParsedType:()=>sa,instanceof:()=>Gp,intersection:()=>lf,isAborted:()=>$s,isAsync:()=>Qr,isDirty:()=>Ts,isValid:()=>Ga,late:()=>Hp,lazy:()=>ff,literal:()=>mf,makeIssue:()=>Qi,map:()=>df,nan:()=>Jp,nativeEnum:()=>gf,never:()=>af,null:()=>ef,nullable:()=>_f,number:()=>Rs,object:()=>gi,objectUtil:()=>lu,oboolean:()=>Ef,onumber:()=>kf,optional:()=>bf,ostring:()=>Of,pipeline:()=>wf,preprocess:()=>vf,promise:()=>yf,quotelessJson:()=>vp,record:()=>cf,set:()=>hf,setErrorMap:()=>EO,strictObject:()=>nf,string:()=>Ft,symbol:()=>Yp,transformer:()=>wu,tuple:()=>uf,undefined:()=>Qp,union:()=>sf,unknown:()=>tf,util:()=>ce,void:()=>rf});var Us=v(()=>{du(),Ep(),xO(),js(),TO(),uu()}),Ou=v(()=>{Us(),Us()}),NO=F((e,t)=>{function a(r,i){typeof i=="boolean"&&(i={forever:i}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=i||{},this._maxRetryTime=i&&i.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}t.exports=a,a.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},a.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},a.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var i=new Date().getTime();if(r&&i-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},a.prototype.attempt=function(r,i){this._fn=r,i&&(i.timeout&&(this._operationTimeout=i.timeout),i.cb&&(this._operationTimeoutCb=i.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},a.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)},a.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)},a.prototype.start=a.prototype.try,a.prototype.errors=function(){return this._errors},a.prototype.attempts=function(){return this._attempts},a.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},i=null,n=0,s=0;s<this._errors.length;s++){var o=this._errors[s],l=o.message,u=(r[l]||0)+1;r[l]=u,u>=n&&(i=o,n=u)}return i}}),CO=F(e=>{var t=NO();e.operation=function(a){var r=e.timeouts(a);return new t(r,{forever:a&&(a.forever||a.retries===1/0),unref:a&&a.unref,maxRetryTime:a&&a.maxRetryTime})},e.timeouts=function(a){if(a instanceof Array)return[].concat(a);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in a)r[i]=a[i];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],s=0;s<r.retries;s++)n.push(this.createTimeout(s,r));return a&&a.forever&&!n.length&&n.push(this.createTimeout(s,r)),n.sort(function(o,l){return o-l}),n},e.createTimeout=function(a,r){var i=r.randomize?Math.random()+1:1,n=Math.round(i*Math.max(r.minTimeout,1)*Math.pow(r.factor,a));return n=Math.min(n,r.maxTimeout),n},e.wrap=function(a,r,i){if(r instanceof Array&&(i=r,r=null),!i){i=[];for(var n in a)typeof a[n]=="function"&&i.push(n)}for(var s=0;s<i.length;s++){var o=i[s],l=a[o];a[o]=function(u){var c=e.operation(r),d=Array.prototype.slice.call(arguments,1),h=d.pop();d.push(function(p){c.retry(p)||(p&&(arguments[0]=c.mainError()),h.apply(this,arguments))}),c.attempt(function(){u.apply(a,d)})}.bind(a,l),a[o].options=r}}}),RO=F((e,t)=>{t.exports=CO()}),ku=F((e,t)=>{"use strict";var a=RO(),r=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],i=class extends Error{constructor(l){super(),l instanceof Error?(this.originalError=l,{message:l}=l):(this.originalError=new Error(l),this.originalError.stack=this.stack),this.name="AbortError",this.message=l}},n=(l,u,c)=>{let d=c.retries-(u-1);return l.attemptNumber=u,l.retriesLeft=d,l},s=l=>r.includes(l),o=(l,u)=>new Promise((c,d)=>{u={onFailedAttempt:()=>{},retries:10,...u};let h=a.operation(u);h.attempt(async p=>{try{c(await l(p))}catch(f){if(!(f instanceof Error)){d(new TypeError(`Non-error was thrown: "${f}". You should only throw errors.`));return}if(f instanceof i)h.stop(),d(f.originalError);else if(f instanceof TypeError&&!s(f.message))h.stop(),d(f);else{n(f,p,u);try{await u.onFailedAttempt(f)}catch(m){d(m);return}h.retry(f)||d(h.mainError())}}})});t.exports=o,t.exports.default=o,t.exports.AbortError=i}),Af,LO=v(()=>{Af=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i});function MO(e){return typeof e=="string"&&Af.test(e)}var ja,Sf=v(()=>{LO(),ja=MO});function UO(e){if(!ja(e))throw TypeError("Invalid UUID");var t,a=new Uint8Array(16);return a[0]=(t=parseInt(e.slice(0,8),16))>>>24,a[1]=t>>>16&255,a[2]=t>>>8&255,a[3]=t&255,a[4]=(t=parseInt(e.slice(9,13),16))>>>8,a[5]=t&255,a[6]=(t=parseInt(e.slice(14,18),16))>>>8,a[7]=t&255,a[8]=(t=parseInt(e.slice(19,23),16))>>>8,a[9]=t&255,a[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,a[11]=t/4294967296&255,a[12]=t>>>24&255,a[13]=t>>>16&255,a[14]=t>>>8&255,a[15]=t&255,a}var Eu,jf=v(()=>{Sf(),Eu=UO});function sn(e,t=0){return(Me[e[t+0]]+Me[e[t+1]]+Me[e[t+2]]+Me[e[t+3]]+"-"+Me[e[t+4]]+Me[e[t+5]]+"-"+Me[e[t+6]]+Me[e[t+7]]+"-"+Me[e[t+8]]+Me[e[t+9]]+"-"+Me[e[t+10]]+Me[e[t+11]]+Me[e[t+12]]+Me[e[t+13]]+Me[e[t+14]]+Me[e[t+15]]).toLowerCase()}var Me,Ds,on=v(()=>{for(Me=[],Ds=0;Ds<256;++Ds)Me.push((Ds+256).toString(16).slice(1))});function If(){if(!Fs&&(Fs=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Fs))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Fs($f)}var Fs,$f,Tf=v(()=>{$f=new Uint8Array(16)});function DO(e,t,a){var r=t&&a||0,i=t||new Array(16);e=e||{};var n=e.node,s=e.clockseq;if(e._v6||(n||(n=xu),s==null&&(s=zs)),n==null||s==null){var o=e.random||(e.rng||If)();n==null&&(n=[o[0],o[1],o[2],o[3],o[4],o[5]],!xu&&!e._v6&&(n[0]|=1,xu=n)),s==null&&(s=(o[6]<<8|o[7])&16383,zs===void 0&&!e._v6&&(zs=s))}var l=e.msecs!==void 0?e.msecs:Date.now(),u=e.nsecs!==void 0?e.nsecs:Zs+1,c=l-Bs+(u-Zs)/1e4;if(c<0&&e.clockseq===void 0&&(s=s+1&16383),(c<0||l>Bs)&&e.nsecs===void 0&&(u=0),u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Bs=l,Zs=u,zs=s,l+=122192928e5;var d=((l&268435455)*1e4+u)%4294967296;i[r++]=d>>>24&255,i[r++]=d>>>16&255,i[r++]=d>>>8&255,i[r++]=d&255;var h=l/4294967296*1e4&268435455;i[r++]=h>>>8&255,i[r++]=h&255,i[r++]=h>>>24&15|16,i[r++]=h>>>16&255,i[r++]=s>>>8|128,i[r++]=s&255;for(var p=0;p<6;++p)i[r+p]=n[p];return t||sn(i)}var xu,zs,Bs,Zs,Nf,FO=v(()=>{Tf(),on(),Bs=0,Zs=0,Nf=DO});function zO(e){var t=typeof e=="string"?Eu(e):e,a=BO(t);return typeof e=="string"?sn(a):a}function BO(e,t=!1){return Uint8Array.of((e[6]&15)<<4|e[7]>>4&15,(e[7]&15)<<4|(e[4]&240)>>4,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,(e[1]&15)<<4|(e[2]&240)>>4,96|e[2]&15,e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}var ZO=v(()=>{jf(),on()});function qO(e){e=unescape(encodeURIComponent(e));for(var t=[],a=0;a<e.length;++a)t.push(e.charCodeAt(a));return t}function VO(e,t,a){function r(i,n,s,o){var l;if(typeof i=="string"&&(i=qO(i)),typeof n=="string"&&(n=Eu(n)),((l=n)===null||l===void 0?void 0:l.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+i.length);if(u.set(n),u.set(i,n.length),u=a(u),u[6]=u[6]&15|t,u[8]=u[8]&63|128,s){o=o||0;for(var c=0;c<16;++c)s[o+c]=u[c];return s}return sn(u)}try{r.name=e}catch{}return r.DNS=Cf,r.URL=Rf,r}var Cf,Rf,WO=v(()=>{on(),jf(),Cf="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Rf="6ba7b811-9dad-11d1-80b4-00c04fd430c8"}),Lf,Pu,HO=v(()=>{Lf=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Pu={randomUUID:Lf}});function GO(e,t,a){if(Pu.randomUUID&&!t&&!e)return Pu.randomUUID();e=e||{};var r=e.random||(e.rng||If)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){a=a||0;for(var i=0;i<16;++i)t[a+i]=r[i];return t}return sn(r)}var Ue,JO=v(()=>{HO(),Tf(),on(),Ue=GO});function KO(e,t,a,r){switch(e){case 0:return t&a^~t&r;case 1:return t^a^r;case 2:return t&a^t&r^a&r;case 3:return t^a^r}}function Au(e,t){return e<<t|e>>>32-t}function XO(e){var t=[1518500249,1859775393,2400959708,3395469782],a=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof e=="string"){var r=unescape(encodeURIComponent(e));e=[];for(var i=0;i<r.length;++i)e.push(r.charCodeAt(i))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var n=e.length/4+2,s=Math.ceil(n/16),o=new Array(s),l=0;l<s;++l){for(var u=new Uint32Array(16),c=0;c<16;++c)u[c]=e[l*64+c*4]<<24|e[l*64+c*4+1]<<16|e[l*64+c*4+2]<<8|e[l*64+c*4+3];o[l]=u}o[s-1][14]=(e.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(e.length-1)*8&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var f=16;f<80;++f)h[f]=Au(h[f-3]^h[f-8]^h[f-14]^h[f-16],1);for(var m=a[0],g=a[1],b=a[2],y=a[3],_=a[4],w=0;w<80;++w){var O=Math.floor(w/20),j=Au(m,5)+KO(O,g,b,y)+_+t[O]+h[w]>>>0;_=y,y=b,b=Au(g,30)>>>0,g=m,m=j}a[0]=a[0]+m>>>0,a[1]=a[1]+g>>>0,a[2]=a[2]+b>>>0,a[3]=a[3]+y>>>0,a[4]=a[4]+_>>>0}return[a[0]>>24&255,a[0]>>16&255,a[0]>>8&255,a[0]&255,a[1]>>24&255,a[1]>>16&255,a[1]>>8&255,a[1]&255,a[2]>>24&255,a[2]>>16&255,a[2]>>8&255,a[2]&255,a[3]>>24&255,a[3]>>16&255,a[3]>>8&255,a[3]&255,a[4]>>24&255,a[4]>>16&255,a[4]>>8&255,a[4]&255]}var Mf,YO=v(()=>{Mf=XO}),Uf,qs,QO=v(()=>{WO(),YO(),Uf=VO("v5",80,Mf),qs=Uf});function Df(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),a.push.apply(a,r)}return a}function Ff(e){for(var t=1;t<arguments.length;t++){var a=arguments[t]!=null?arguments[t]:{};t%2?Df(Object(a),!0).forEach(function(r){ek(e,r,a[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Df(Object(a)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(a,r))})}return e}function ek(e,t,a){return(t=tk(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function tk(e){var t=ak(e,"string");return typeof t=="symbol"?t:t+""}function ak(e,t){if(typeof e!="object"||!e)return e;var a=e[Symbol.toPrimitive];if(a!==void 0){var r=a.call(e,t||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function rk(e={},t,a=0){var r=Nf(Ff(Ff({},e),{},{_v6:!0}),new Uint8Array(16));if(r=zO(r),t){for(var i=0;i<16;i++)t[a+i]=r[i];return t}return sn(r)}var ik=v(()=>{on(),FO(),ZO()}),la=v(()=>{JO(),QO(),ik(),Sf()});function nk(e=!1){let t=qf.getInstance().getStore();if(!e&&t===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return t}function Su(e){return typeof e=="function"&&"langsmith:traceable"in e}var zf,Vs,Bf,Zf,qf,sk,ok=v(()=>{zf=class{getStore(){}run(e,t){return t()}},Vs=Symbol.for("ls:tracing_async_local_storage"),Bf=new zf,Zf=class{getInstance(){return globalThis[Vs]??Bf}initializeGlobalInstance(e){globalThis[Vs]===void 0&&(globalThis[Vs]=e)}},qf=new Zf,sk=Symbol.for("langsmith:traceable:root")}),Vf=v(()=>{ok()});function ju(e,t){return Gf.call(e,t)}function Iu(e){if(Array.isArray(e)){let a=new Array(e.length);for(let r=0;r<a.length;r++)a[r]=""+r;return a}if(Object.keys)return Object.keys(e);let t=[];for(let a in e)ju(e,a)&&t.push(a);return t}function jt(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function $u(e){let t=0,a=e.length,r;for(;t<a;){if(r=e.charCodeAt(t),r>=48&&r<=57){t++;continue}return!1}return!0}function vr(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Wf(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Tu(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(let a=0,r=e.length;a<r;a++)if(Tu(e[a]))return!0}else if(typeof e=="object"){let a=Iu(e),r=a.length;for(var t=0;t<r;t++)if(Tu(e[a[t]]))return!0}}return!1}function Hf(e,t){let a=[e];for(let r in t){let i=typeof t[r]=="object"?JSON.stringify(t[r],null,2):t[r];typeof i<"u"&&a.push(`${r}: ${i}`)}return a.join(`
`)}var Gf,Nu,Ws=v(()=>{Gf=Object.prototype.hasOwnProperty,Nu=class extends Error{constructor(e,t,a,r,i){super(Hf(e,{name:t,index:a,operation:r,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Hf(e,{name:t,index:a,operation:r,tree:i})}}}),Jf={};Ss(Jf,{JsonPatchError:()=>we,_areEquals:()=>un,applyOperation:()=>wr,applyPatch:()=>ln,applyReducer:()=>lk,deepClone:()=>Xf,getValueByPointer:()=>Hs,validate:()=>Kf,validator:()=>Gs});function Hs(e,t){if(t=="")return e;var a={op:"_get",path:t};return wr(e,a),a.value}function wr(e,t,a=!1,r=!0,i=!0,n=0){if(a&&(typeof a=="function"?a(t,0,e,t.path):Gs(t,0)),t.path===""){let s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=Hs(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=un(e,t.value),s.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(a)throw new we("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,t,e);return s}}else{r||(e=jt(e));let s=(t.path||"").split("/"),o=e,l=1,u=s.length,c,d,h;for(typeof a=="function"?h=a:h=Gs;;){if(d=s[l],d&&d.indexOf("~")!=-1&&(d=Wf(d)),i&&(d=="__proto__"||d=="prototype"&&l>0&&s[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(a&&c===void 0&&(o[d]===void 0?c=s.slice(0,l).join("/"):l==u-1&&(c=t.path),c!==void 0&&h(t,0,e,c)),l++,Array.isArray(o)){if(d==="-")d=o.length;else{if(a&&!$u(d))throw new we("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",n,t,e);$u(d)&&(d=~~d)}if(l>=u){if(a&&t.op==="add"&&d>o.length)throw new we("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",n,t,e);let p=Yf[t.op].call(t,o,d,e);if(p.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return p}}else if(l>=u){let p=Or[t.op].call(t,o,d,e);if(p.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return p}if(o=o[d],a&&l<u&&(!o||typeof o!="object"))throw new we("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",n,t,e)}}}function ln(e,t,a,r=!0,i=!0){if(a&&!Array.isArray(t))throw new we("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=jt(e));let n=new Array(t.length);for(let s=0,o=t.length;s<o;s++)n[s]=wr(e,t[s],a,!0,i,s),e=n[s].newDocument;return n.newDocument=e,n}function lk(e,t,a){let r=wr(e,t);if(r.test===!1)throw new we("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument}function Gs(e,t,a,r){if(typeof e!="object"||e===null||Array.isArray(e))throw new we("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,a);if(Or[e.op]){if(typeof e.path!="string")throw new we("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,a);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new we('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,a);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new we("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,a);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new we("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,a);if((e.op==="add"||e.op==="replace"||e.op==="test")&&Tu(e.value))throw new we("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,a);if(a){if(e.op=="add"){var i=e.path.split("/").length,n=r.split("/").length;if(i!==n+1&&i!==n)throw new we("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,a)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==r)throw new we("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,a)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},o=Kf([s],a);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new we("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,a)}}}else throw new we("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,a)}function Kf(e,t,a){try{if(!Array.isArray(e))throw new we("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)ln(jt(t),jt(e),a||!0);else{a=a||Gs;for(var r=0;r<e.length;r++)a(e[r],r,t,void 0)}}catch(i){if(i instanceof we)return i;throw i}}function un(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var a=Array.isArray(e),r=Array.isArray(t),i,n,s;if(a&&r){if(n=e.length,n!=t.length)return!1;for(i=n;i--!==0;)if(!un(e[i],t[i]))return!1;return!0}if(a!=r)return!1;var o=Object.keys(e);if(n=o.length,n!==Object.keys(t).length)return!1;for(i=n;i--!==0;)if(!t.hasOwnProperty(o[i]))return!1;for(i=n;i--!==0;)if(s=o[i],!un(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}var we,Xf,Or,Yf,Cu=v(()=>{Ws(),we=Nu,Xf=jt,Or={add:function(e,t,a){return e[t]=this.value,{newDocument:a}},remove:function(e,t,a){var r=e[t];return delete e[t],{newDocument:a,removed:r}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:function(e,t,a){let r=Hs(a,this.path);r&&(r=jt(r));let i=wr(a,{op:"remove",path:this.from}).removed;return wr(a,{op:"add",path:this.path,value:i}),{newDocument:a,removed:r}},copy:function(e,t,a){let r=Hs(a,this.from);return wr(a,{op:"add",path:this.path,value:jt(r)}),{newDocument:a}},test:function(e,t,a){return{newDocument:a,test:un(e[t],this.value)}},_get:function(e,t,a){return this.value=e[t],{newDocument:a}}},Yf={add:function(e,t,a){return $u(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:a,index:t}},remove:function(e,t,a){var r=e.splice(t,1);return{newDocument:a,removed:r[0]}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:Or.move,copy:Or.copy,test:Or.test,_get:Or._get}});function Qf(e,t,a,r,i){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var n=Iu(t),s=Iu(e),o=!1,l=!1,u=s.length-1;u>=0;u--){var c=s[u],d=e[c];if(ju(t,c)&&!(t[c]===void 0&&d!==void 0&&Array.isArray(t)===!1)){var h=t[c];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?Qf(d,h,a,r+"/"+vr(c),i):d!==h&&(o=!0,i&&a.push({op:"test",path:r+"/"+vr(c),value:jt(d)}),a.push({op:"replace",path:r+"/"+vr(c),value:jt(h)}))}else Array.isArray(e)===Array.isArray(t)?(i&&a.push({op:"test",path:r+"/"+vr(c),value:jt(d)}),a.push({op:"remove",path:r+"/"+vr(c)}),l=!0):(i&&a.push({op:"test",path:r,value:e}),a.push({op:"replace",path:r,value:t}),o=!0)}if(!(!l&&n.length==s.length))for(var u=0;u<n.length;u++){var c=n[u];!ju(e,c)&&t[c]!==void 0&&a.push({op:"add",path:r+"/"+vr(c),value:jt(t[c])})}}}function uk(e,t,a=!1){var r=[];return Qf(e,t,r,"",a),r}var ck=v(()=>{Ws(),Cu()}),dk,em=v(()=>{Cu(),ck(),Ws(),Cu(),Ws(),dk={...Jf,JsonPatchError:Nu,deepClone:jt,escapePathComponent:vr,unescapePathComponent:Wf}}),tm,am,Ru,rm,Lu,Mu,Uu,im,nm,sm,om,lm,um,cm,dm,hm,pm,fm,mm,gm,ym,bm,_m,vm,wm,Om,km,Em,xm,Pm,Du,Am,Sm,hk=v(()=>{tm="gen_ai.operation.name",am="gen_ai.system",Ru="gen_ai.request.model",rm="gen_ai.response.model",Lu="gen_ai.usage.input_tokens",Mu="gen_ai.usage.output_tokens",Uu="gen_ai.usage.total_tokens",im="gen_ai.request.max_tokens",nm="gen_ai.request.temperature",sm="gen_ai.request.top_p",om="gen_ai.request.frequency_penalty",lm="gen_ai.request.presence_penalty",um="gen_ai.response.finish_reasons",cm="gen_ai.prompt",dm="gen_ai.completion",hm="gen_ai.request.extra_query",pm="gen_ai.request.extra_body",fm="gen_ai.serialized.name",mm="gen_ai.serialized.signature",gm="gen_ai.serialized.doc",ym="gen_ai.response.id",bm="gen_ai.response.service_tier",_m="gen_ai.response.system_fingerprint",vm="gen_ai.usage.input_token_details",wm="gen_ai.usage.output_token_details",Om="langsmith.trace.session_id",km="langsmith.trace.session_name",Em="langsmith.span.kind",xm="langsmith.trace.name",Pm="langsmith.metadata",Du="langsmith.span.tags",Am="langsmith.request.streaming",Sm="langsmith.request.headers"}),jm,Fu,Im,$m,Tm=v(()=>{Xa(),jm=(...e)=>fetch(...e),Fu=Symbol.for("ls:fetch_implementation"),Im=()=>{let e=globalThis[Fu];return e?typeof e=="function"&&"Headers"in e&&"Request"in e&&"Response"in e:!1},$m=e=>async(...t)=>{if(e||nt("DEBUG")==="true"){let[r,i]=t;console.log(`\u2192 ${i?.method||"GET"} ${r}`)}let a=await(globalThis[Fu]??jm)(...t);return(e||nt("DEBUG")==="true")&&console.log(`\u2190 ${a.status} ${a.statusText} ${a.url}`),a}}),zu,Nm=v(()=>{Xa(),zu=()=>nt("PROJECT")??ua("LANGCHAIN_SESSION")??"default"}),Bu,Zu=v(()=>{kg(),Sg(),Tm(),Nm(),Bu="0.3.77"});function Cm(){if(Wu===void 0){let e=Vu(),t=fk();Wu={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Bu,...t}}return Wu}function Rm(){let e=pk(),t={},a=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[r,i]of Object.entries(e))typeof i=="string"&&!a.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?t.revision_id=i:t[r]=i);return t}function pk(){let e={};try{if(typeof process<"u"&&process.env)for(let[t,a]of Object.entries(process.env))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&a!=null&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&typeof a=="string"?e[t]=a.slice(0,2)+"*".repeat(a.length-4)+a.slice(-2):e[t]=a)}catch{}return e}function ua(e){try{return typeof process<"u"?process.env?.[e]:void 0}catch{return}}function nt(e){return ua(`LANGSMITH_${e}`)||ua(`LANGCHAIN_${e}`)}function fk(){if(Hu!==void 0)return Hu;let e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(let a of e){let r=ua(a);r!==void 0&&(t[a]=r)}return Hu=t,t}function Lm(){return ua("OTEL_ENABLED")==="true"||nt("OTEL_ENABLED")==="true"}var Ia,Mm,Um,Dm,qu,Fm,Vu,Wu,Hu,Xa=v(()=>{Zu(),Mm=()=>typeof window<"u"&&typeof window.document<"u",Um=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Dm=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),qu=()=>typeof Deno<"u",Fm=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!qu(),Vu=()=>Ia||(typeof Bun<"u"?Ia="bun":Mm()?Ia="browser":Fm()?Ia="node":Um()?Ia="webworker":Dm()?Ia="jsdom":qu()?Ia="deno":Ia="other",Ia)});function zm(){return Xs.getTraceInstance()}function mk(){return Xs.getContextInstance()}function gk(){return Xs.getDefaultOTLPTracerComponents()}var Bm,Zm,qm,Js,Ks,Gu,Vm,Wm,Hm,Xs,Gm=v(()=>{Xa(),Bm=class{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&Lm()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let a;if(t.length===1&&typeof t[0]=="function"?a=t[0]:t.length===2&&typeof t[1]=="function"?a=t[1]:t.length===3&&typeof t[2]=="function"&&(a=t[2]),typeof a=="function")return a()}},Zm=class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Bm})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},qm=class{active(){return{}}with(e,t){return t()}},Js=Symbol.for("ls:otel_trace"),Ks=Symbol.for("ls:otel_context"),Gu=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),Vm=new Zm,Wm=new qm,Hm=class{getTraceInstance(){return globalThis[Js]??Vm}getContextInstance(){return globalThis[Ks]??Wm}initializeGlobalInstances(e){globalThis[Js]===void 0&&(globalThis[Js]=e.trace),globalThis[Ks]===void 0&&(globalThis[Ks]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Gu]=e}getDefaultOTLPTracerComponents(){return globalThis[Gu]??void 0}},Xs=new Hm});function yk(e){return Jm[e]||e}var Jm,Km,bk=v(()=>{hk(),Gm(),Jm={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"},Km=class{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(let a of e)try{if(!a.run)continue;if(a.operation==="post"){let r=this.createSpanForRun(a,a.run,t.get(a.id));r&&!a.run.end_time&&this.spans.set(a.id,r)}else this.updateSpanForRun(a,a.run)}catch(r){console.error(`Error processing operation ${a.id}:`,r)}}createSpanForRun(e,t,a){let r=a&&zm().getSpan(a);if(r)try{return this.finishSpanSetup(r,t,e)}catch(i){console.error(`Failed to create span for run ${e.id}:`,i);return}}finishSpanSetup(e,t,a){return this.setSpanAttributes(e,t,a),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{let a=this.spans.get(e.id);if(!a){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(a,t,e),t.error?(a.setStatus({code:2}),a.recordException(new Error(t.error))):a.setStatus({code:1});let r=t.end_time;r&&(a.end(new Date(r)),this.spans.delete(e.id))}catch(a){console.error(`Failed to update span for run ${e.id}:`,a)}}extractModelName(e){if(e.extra?.metadata){let t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){let a=t.invocation_params;if(a.model)return a.model;if(a.model_name)return a.model_name}}}setSpanAttributes(e,t,a){if("run_type"in t&&t.run_type){e.setAttribute(Em,t.run_type);let s=yk(t.run_type||"chain");e.setAttribute(tm,s)}"name"in t&&t.name&&e.setAttribute(xm,t.name),"session_id"in t&&t.session_id&&e.setAttribute(Om,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(km,t.session_name),this.setGenAiSystem(e,t);let r=this.extractModelName(t);r&&e.setAttribute(Ru,r),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(Lu,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute(Mu,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(Uu,t.total_tokens),this.setInvocationParameters(e,t);let i=t.extra?.metadata||{};for(let[s,o]of Object.entries(i))o!=null&&e.setAttribute(`${Pm}.${s}`,String(o));let n=t.tags;if(n&&Array.isArray(n)?e.setAttribute(Du,n.join(", ")):n&&e.setAttribute(Du,String(n)),"serialized"in t&&typeof t.serialized=="object"){let s=t.serialized;s.name&&e.setAttribute(fm,String(s.name)),s.signature&&e.setAttribute(mm,String(s.signature)),s.doc&&e.setAttribute(gm,String(s.doc))}this.setIOAttributes(e,a)}setGenAiSystem(e,t){let a="langchain",r=this.extractModelName(t);if(r){let i=r.toLowerCase();i.includes("anthropic")||i.startsWith("claude")?a="anthropic":i.includes("bedrock")?a="aws.bedrock":i.includes("azure")&&i.includes("openai")?a="az.ai.openai":i.includes("azure")&&i.includes("inference")?a="az.ai.inference":i.includes("cohere")?a="cohere":i.includes("deepseek")?a="deepseek":i.includes("gemini")?a="gemini":i.includes("groq")?a="groq":i.includes("watson")||i.includes("ibm")?a="ibm.watsonx.ai":i.includes("mistral")?a="mistral_ai":i.includes("gpt")||i.includes("openai")?a="openai":i.includes("perplexity")||i.includes("sonar")?a="perplexity":i.includes("vertex")?a="vertex_ai":(i.includes("xai")||i.includes("grok"))&&(a="xai")}e.setAttribute(am,a)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;let a=t.extra.metadata.invocation_params;a.max_tokens!==void 0&&e.setAttribute(im,a.max_tokens),a.temperature!==void 0&&e.setAttribute(nm,a.temperature),a.top_p!==void 0&&e.setAttribute(sm,a.top_p),a.frequency_penalty!==void 0&&e.setAttribute(om,a.frequency_penalty),a.presence_penalty!==void 0&&e.setAttribute(lm,a.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{let a=t.run.inputs;typeof a=="object"&&a!==null&&(a.model&&Array.isArray(a.messages)&&e.setAttribute(Ru,a.model),a.stream!==void 0&&e.setAttribute(Am,a.stream),a.extra_headers&&e.setAttribute(Sm,JSON.stringify(a.extra_headers)),a.extra_query&&e.setAttribute(hm,JSON.stringify(a.extra_query)),a.extra_body&&e.setAttribute(pm,JSON.stringify(a.extra_body))),e.setAttribute(cm,JSON.stringify(a))}catch(a){console.debug(`Failed to process inputs for run ${t.id}`,a)}if(t.run.outputs)try{let a=t.run.outputs,r=this.getUnifiedRunTokens(a);if(r&&(e.setAttribute(Lu,r[0]),e.setAttribute(Mu,r[1]),e.setAttribute(Uu,r[0]+r[1])),a&&typeof a=="object"){if(a.model&&e.setAttribute(rm,String(a.model)),a.id&&e.setAttribute(ym,a.id),a.choices&&Array.isArray(a.choices)){let i=a.choices.map(n=>n.finish_reason).filter(n=>n).map(String);i.length>0&&e.setAttribute(um,i.join(", "))}if(a.service_tier&&e.setAttribute(bm,a.service_tier),a.system_fingerprint&&e.setAttribute(_m,a.system_fingerprint),a.usage_metadata&&typeof a.usage_metadata=="object"){let i=a.usage_metadata;i.input_token_details&&e.setAttribute(vm,JSON.stringify(i.input_token_details)),i.output_token_details&&e.setAttribute(wm,JSON.stringify(i.output_token_details))}}e.setAttribute(dm,JSON.stringify(a))}catch(a){console.debug(`Failed to process outputs for run ${t.id}`,a)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;let a=Object.keys(e);for(let n of a){let s=e[n];if(!(!s||typeof s!="object")&&(t=this.extractUnifiedRunTokens(s.usage_metadata),t||s.lc===1&&s.kwargs&&typeof s.kwargs=="object"&&(t=this.extractUnifiedRunTokens(s.kwargs.usage_metadata),t)))return t}let r=e.generations||[];if(!Array.isArray(r))return null;let i=Array.isArray(r[0])?r.flat():r;for(let n of i)if(typeof n=="object"&&n.message&&typeof n.message=="object"&&n.message.kwargs&&typeof n.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(n.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}}}),_k=F((e,t)=>{"use strict";var a=Object.prototype.hasOwnProperty,r="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(r=!1));function n(u,c,d){this.fn=u,this.context=c,this.once=d||!1}function s(u,c,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var f=new n(d,h||u,p),m=r?r+c:c;return u._events[m]?u._events[m].fn?u._events[m]=[u._events[m],f]:u._events[m].push(f):(u._events[m]=f,u._eventsCount++),u}function o(u,c){--u._eventsCount===0?u._events=new i:delete u._events[c]}function l(){this._events=new i,this._eventsCount=0}l.prototype.eventNames=function(){var u=[],c,d;if(this._eventsCount===0)return u;for(d in c=this._events)a.call(c,d)&&u.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(c)):u},l.prototype.listeners=function(u){var c=r?r+u:u,d=this._events[c];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,p=d.length,f=new Array(p);h<p;h++)f[h]=d[h].fn;return f},l.prototype.listenerCount=function(u){var c=r?r+u:u,d=this._events[c];return d?d.fn?1:d.length:0},l.prototype.emit=function(u,c,d,h,p,f){var m=r?r+u:u;if(!this._events[m])return!1;var g=this._events[m],b=arguments.length,y,_;if(g.fn){switch(g.once&&this.removeListener(u,g.fn,void 0,!0),b){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,c),!0;case 3:return g.fn.call(g.context,c,d),!0;case 4:return g.fn.call(g.context,c,d,h),!0;case 5:return g.fn.call(g.context,c,d,h,p),!0;case 6:return g.fn.call(g.context,c,d,h,p,f),!0}for(_=1,y=new Array(b-1);_<b;_++)y[_-1]=arguments[_];g.fn.apply(g.context,y)}else{var w=g.length,O;for(_=0;_<w;_++)switch(g[_].once&&this.removeListener(u,g[_].fn,void 0,!0),b){case 1:g[_].fn.call(g[_].context);break;case 2:g[_].fn.call(g[_].context,c);break;case 3:g[_].fn.call(g[_].context,c,d);break;case 4:g[_].fn.call(g[_].context,c,d,h);break;default:if(!y)for(O=1,y=new Array(b-1);O<b;O++)y[O-1]=arguments[O];g[_].fn.apply(g[_].context,y)}}return!0},l.prototype.on=function(u,c,d){return s(this,u,c,d,!1)},l.prototype.once=function(u,c,d){return s(this,u,c,d,!0)},l.prototype.removeListener=function(u,c,d,h){var p=r?r+u:u;if(!this._events[p])return this;if(!c)return o(this,p),this;var f=this._events[p];if(f.fn)f.fn===c&&(!h||f.once)&&(!d||f.context===d)&&o(this,p);else{for(var m=0,g=[],b=f.length;m<b;m++)(f[m].fn!==c||h&&!f[m].once||d&&f[m].context!==d)&&g.push(f[m]);g.length?this._events[p]=g.length===1?g[0]:g:o(this,p)}return this},l.prototype.removeAllListeners=function(u){var c;return u?(c=r?r+u:u,this._events[c]&&o(this,c)):(this._events=new i,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=r,l.EventEmitter=l,typeof t<"u"&&(t.exports=l)}),vk=F((e,t)=>{"use strict";t.exports=(a,r)=>(r=r||(()=>{}),a.then(i=>new Promise(n=>{n(r())}).then(()=>i),i=>new Promise(n=>{n(r())}).then(()=>{throw i})))}),wk=F((e,t)=>{"use strict";var a=vk(),r=class extends Error{constructor(n){super(n),this.name="TimeoutError"}},i=(n,s,o)=>new Promise((l,u)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){l(n);return}let c=setTimeout(()=>{if(typeof o=="function"){try{l(o())}catch(p){u(p)}return}let d=typeof o=="string"?o:`Promise timed out after ${s} milliseconds`,h=o instanceof Error?o:new r(d);typeof n.cancel=="function"&&n.cancel(),u(h)},s);a(n.then(l,u),()=>{clearTimeout(c)})});t.exports=i,t.exports.default=i,t.exports.TimeoutError=r}),Ok=F(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});function t(a,r,i){let n=0,s=a.length;for(;s>0;){let o=s/2|0,l=n+o;i(a[l],r)<=0?(n=++l,s-=o+1):s=o}return n}e.default=t}),kk=F(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=Ok(),a=class{constructor(){this._queue=[]}enqueue(r,i){i=Object.assign({priority:0},i);let n={priority:i.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=i.priority){this._queue.push(n);return}let s=t.default(this._queue,n,(o,l)=>l.priority-o.priority);this._queue.splice(s,0,n)}dequeue(){return this._queue.shift()?.run}filter(r){return this._queue.filter(i=>i.priority===r.priority).map(i=>i.run)}get size(){return this._queue.length}};e.default=a}),Ju=F(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=_k(),a=wk(),r=kk(),i=()=>{},n=new a.TimeoutError,s=class extends t{constructor(o){var l,u,c,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=i,this._resolveIdle=i,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(l=o.intervalCap)===null||l===void 0?void 0:l.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(c=o.interval)===null||c===void 0?void 0:c.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=i,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=i,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let o=Date.now();if(this._intervalId===void 0){let l=this._intervalEnd-o;if(l<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},l)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let l=this._queue.dequeue();return l?(this.emit("active"),l(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,l={}){return new Promise((u,c)=>{let d=async()=>{this._pendingCount++,this._intervalCount++;try{let h=this._timeout===void 0&&l.timeout===void 0?o():a.default(Promise.resolve(o()),l.timeout===void 0?this._timeout:l.timeout,()=>{(l.throwOnTimeout===void 0?this._throwOnTimeout:l.throwOnTimeout)&&c(n)});u(await h)}catch(h){c(h)}this._next()};this._queue.enqueue(d,l),this._tryToStartAnother(),this.emit("add")})}async addAll(o,l){return Promise.all(o.map(async u=>this.add(u,l)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{let l=this._resolveEmpty;this._resolveEmpty=()=>{l(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{let l=this._resolveIdle;this._resolveIdle=()=>{l(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}};e.default=s}),Xm,Ys,Ym,Ku,Ek=v(()=>{Xm=Mt(ku(),1),Ys=Mt(Ju(),1),Ym=[429,500,502,503,504],Ku=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in Ys.default?this.queue=new Ys.default.default({concurrency:this.maxConcurrency}):this.queue=new Ys.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let a=this.onFailedResponseHook;return this.queue.add(()=>(0,Xm.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{async onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.name==="TimeoutError"||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let i=r?.response;if(a&&await a(i))return;let n=i?.status??r?.status;if(n&&!Ym.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise((r,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...a)}}});function Qm(e){return typeof e?._getType=="function"}function eg(e){let t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var xk=v(()=>{});function ae(e,t){if(!tg.test(e)){let a=t!==void 0?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`;throw new Error(a)}return e}var tg,Pk=v(()=>{tg=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i});function Xu(e){Yu[e]||(console.warn(e),Yu[e]=!0)}var Yu,ag=v(()=>{Yu={}}),Qs=F((e,t)=>{"use strict";var a="2.0.0",r=Number.MAX_SAFE_INTEGER||9007199254740991,i=16,n=250,s=["major","premajor","minor","preminor","patch","prepatch","prerelease"];t.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:i,MAX_SAFE_BUILD_LENGTH:n,MAX_SAFE_INTEGER:r,RELEASE_TYPES:s,SEMVER_SPEC_VERSION:a,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}}),eo=F((e,t)=>{"use strict";var a=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};t.exports=a}),cn=F((e,t)=>{"use strict";var{MAX_SAFE_COMPONENT_LENGTH:a,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:i}=Qs(),n=eo();e=t.exports={};var s=e.re=[],o=e.safeRe=[],l=e.src=[],u=e.safeSrc=[],c=e.t={},d=0,h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",i],[h,r]],f=g=>{for(let[b,y]of p)g=g.split(`${b}*`).join(`${b}{0,${y}}`).split(`${b}+`).join(`${b}{1,${y}}`);return g},m=(g,b,y)=>{let _=f(b),w=d++;n(g,w,b),c[g]=w,l[w]=b,u[w]=_,s[w]=new RegExp(b,y?"g":void 0),o[w]=new RegExp(_,y?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),m("MAINVERSION",`(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${l[c.NONNUMERICIDENTIFIER]}|${l[c.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${l[c.NONNUMERICIDENTIFIER]}|${l[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${l[c.PRERELEASEIDENTIFIER]}(?:\\.${l[c.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${l[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[c.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${h}+`),m("BUILD",`(?:\\+(${l[c.BUILDIDENTIFIER]}(?:\\.${l[c.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${l[c.MAINVERSION]}${l[c.PRERELEASE]}?${l[c.BUILD]}?`),m("FULL",`^${l[c.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${l[c.MAINVERSIONLOOSE]}${l[c.PRERELEASELOOSE]}?${l[c.BUILD]}?`),m("LOOSE",`^${l[c.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${l[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${l[c.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:${l[c.PRERELEASE]})?${l[c.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:${l[c.PRERELEASELOOSE]})?${l[c.BUILD]}?)?)?`),m("XRANGE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${a}})(?:\\.(\\d{1,${a}}))?(?:\\.(\\d{1,${a}}))?`),m("COERCE",`${l[c.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",l[c.COERCEPLAIN]+`(?:${l[c.PRERELEASE]})?(?:${l[c.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",l[c.COERCE],!0),m("COERCERTLFULL",l[c.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${l[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${l[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${l[c.LONECARET]}${l[c.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${l[c.LONECARET]}${l[c.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${l[c.GTLT]}\\s*(${l[c.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]}|${l[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${l[c.XRANGEPLAIN]})\\s+-\\s+(${l[c.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${l[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[c.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}),Qu=F((e,t)=>{"use strict";var a=Object.freeze({loose:!0}),r=Object.freeze({}),i=n=>n?typeof n!="object"?a:n:r;t.exports=i}),rg=F((e,t)=>{"use strict";var a=/^[0-9]+$/,r=(n,s)=>{if(typeof n=="number"&&typeof s=="number")return n===s?0:n<s?-1:1;let o=a.test(n),l=a.test(s);return o&&l&&(n=+n,s=+s),n===s?0:o&&!l?-1:l&&!o?1:n<s?-1:1},i=(n,s)=>r(s,n);t.exports={compareIdentifiers:r,rcompareIdentifiers:i}}),Qe=F((e,t)=>{"use strict";var a=eo(),{MAX_LENGTH:r,MAX_SAFE_INTEGER:i}=Qs(),{safeRe:n,t:s}=cn(),o=Qu(),{compareIdentifiers:l}=rg(),u=class Ea{constructor(d,h){if(h=o(h),d instanceof Ea){if(d.loose===!!h.loose&&d.includePrerelease===!!h.includePrerelease)return d;d=d.version}else if(typeof d!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof d}".`);if(d.length>r)throw new TypeError(`version is longer than ${r} characters`);a("SemVer",d,h),this.options=h,this.loose=!!h.loose,this.includePrerelease=!!h.includePrerelease;let p=d.trim().match(h.loose?n[s.LOOSE]:n[s.FULL]);if(!p)throw new TypeError(`Invalid Version: ${d}`);if(this.raw=d,this.major=+p[1],this.minor=+p[2],this.patch=+p[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");p[4]?this.prerelease=p[4].split(".").map(f=>{if(/^[0-9]+$/.test(f)){let m=+f;if(m>=0&&m<i)return m}return f}):this.prerelease=[],this.build=p[5]?p[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(d){if(a("SemVer.compare",this.version,this.options,d),!(d instanceof Ea)){if(typeof d=="string"&&d===this.version)return 0;d=new Ea(d,this.options)}return d.version===this.version?0:this.compareMain(d)||this.comparePre(d)}compareMain(d){return d instanceof Ea||(d=new Ea(d,this.options)),this.major<d.major?-1:this.major>d.major?1:this.minor<d.minor?-1:this.minor>d.minor?1:this.patch<d.patch?-1:this.patch>d.patch?1:0}comparePre(d){if(d instanceof Ea||(d=new Ea(d,this.options)),this.prerelease.length&&!d.prerelease.length)return-1;if(!this.prerelease.length&&d.prerelease.length)return 1;if(!this.prerelease.length&&!d.prerelease.length)return 0;let h=0;do{let p=this.prerelease[h],f=d.prerelease[h];if(a("prerelease compare",h,p,f),p===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(p===void 0)return-1;if(p!==f)return l(p,f)}while(++h)}compareBuild(d){d instanceof Ea||(d=new Ea(d,this.options));let h=0;do{let p=this.build[h],f=d.build[h];if(a("build compare",h,p,f),p===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(p===void 0)return-1;if(p!==f)return l(p,f)}while(++h)}inc(d,h,p){if(d.startsWith("pre")){if(!h&&p===!1)throw new Error("invalid increment argument: identifier is empty");if(h){let f=`-${h}`.match(this.options.loose?n[s.PRERELEASELOOSE]:n[s.PRERELEASE]);if(!f||f[1]!==h)throw new Error(`invalid identifier: ${h}`)}}switch(d){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",h,p);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",h,p);break;case"prepatch":this.prerelease.length=0,this.inc("patch",h,p),this.inc("pre",h,p);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",h,p),this.inc("pre",h,p);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let f=Number(p)?1:0;if(this.prerelease.length===0)this.prerelease=[f];else{let m=this.prerelease.length;for(;--m>=0;)typeof this.prerelease[m]=="number"&&(this.prerelease[m]++,m=-2);if(m===-1){if(h===this.prerelease.join(".")&&p===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(f)}}if(h){let m=[h,f];p===!1&&(m=[h]),l(this.prerelease[0],h)===0?isNaN(this.prerelease[1])&&(this.prerelease=m):this.prerelease=m}break}default:throw new Error(`invalid increment argument: ${d}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};t.exports=u}),yi=F((e,t)=>{"use strict";var a=Qe(),r=(i,n,s=!1)=>{if(i instanceof a)return i;try{return new a(i,n)}catch(o){if(!s)return null;throw o}};t.exports=r}),Ak=F((e,t)=>{"use strict";var a=yi(),r=(i,n)=>{let s=a(i,n);return s?s.version:null};t.exports=r}),Sk=F((e,t)=>{"use strict";var a=yi(),r=(i,n)=>{let s=a(i.trim().replace(/^[=v]+/,""),n);return s?s.version:null};t.exports=r}),jk=F((e,t)=>{"use strict";var a=Qe(),r=(i,n,s,o,l)=>{typeof s=="string"&&(l=o,o=s,s=void 0);try{return new a(i instanceof a?i.version:i,s).inc(n,o,l).version}catch{return null}};t.exports=r}),Ik=F((e,t)=>{"use strict";var a=yi(),r=(i,n)=>{let s=a(i,null,!0),o=a(n,null,!0),l=s.compare(o);if(l===0)return null;let u=l>0,c=u?s:o,d=u?o:s,h=!!c.prerelease.length;if(d.prerelease.length&&!h){if(!d.patch&&!d.minor)return"major";if(d.compareMain(c)===0)return d.minor&&!d.patch?"minor":"patch"}let p=h?"pre":"";return s.major!==o.major?p+"major":s.minor!==o.minor?p+"minor":s.patch!==o.patch?p+"patch":"prerelease"};t.exports=r}),$k=F((e,t)=>{"use strict";var a=Qe(),r=(i,n)=>new a(i,n).major;t.exports=r}),Tk=F((e,t)=>{"use strict";var a=Qe(),r=(i,n)=>new a(i,n).minor;t.exports=r}),Nk=F((e,t)=>{"use strict";var a=Qe(),r=(i,n)=>new a(i,n).patch;t.exports=r}),Ck=F((e,t)=>{"use strict";var a=yi(),r=(i,n)=>{let s=a(i,n);return s&&s.prerelease.length?s.prerelease:null};t.exports=r}),zt=F((e,t)=>{"use strict";var a=Qe(),r=(i,n,s)=>new a(i,s).compare(new a(n,s));t.exports=r}),Rk=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(n,i,s);t.exports=r}),Lk=F((e,t)=>{"use strict";var a=zt(),r=(i,n)=>a(i,n,!0);t.exports=r}),ec=F((e,t)=>{"use strict";var a=Qe(),r=(i,n,s)=>{let o=new a(i,s),l=new a(n,s);return o.compare(l)||o.compareBuild(l)};t.exports=r}),Mk=F((e,t)=>{"use strict";var a=ec(),r=(i,n)=>i.sort((s,o)=>a(s,o,n));t.exports=r}),Uk=F((e,t)=>{"use strict";var a=ec(),r=(i,n)=>i.sort((s,o)=>a(o,s,n));t.exports=r}),to=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)>0;t.exports=r}),tc=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)<0;t.exports=r}),ig=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)===0;t.exports=r}),ng=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)!==0;t.exports=r}),ac=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)>=0;t.exports=r}),rc=F((e,t)=>{"use strict";var a=zt(),r=(i,n,s)=>a(i,n,s)<=0;t.exports=r}),sg=F((e,t)=>{"use strict";var a=ig(),r=ng(),i=to(),n=ac(),s=tc(),o=rc(),l=(u,c,d,h)=>{switch(c){case"===":return typeof u=="object"&&(u=u.version),typeof d=="object"&&(d=d.version),u===d;case"!==":return typeof u=="object"&&(u=u.version),typeof d=="object"&&(d=d.version),u!==d;case"":case"=":case"==":return a(u,d,h);case"!=":return r(u,d,h);case">":return i(u,d,h);case">=":return n(u,d,h);case"<":return s(u,d,h);case"<=":return o(u,d,h);default:throw new TypeError(`Invalid operator: ${c}`)}};t.exports=l}),Dk=F((e,t)=>{"use strict";var a=Qe(),r=yi(),{safeRe:i,t:n}=cn(),s=(o,l)=>{if(o instanceof a)return o;if(typeof o=="number"&&(o=String(o)),typeof o!="string")return null;l=l||{};let u=null;if(!l.rtl)u=o.match(l.includePrerelease?i[n.COERCEFULL]:i[n.COERCE]);else{let m=l.includePrerelease?i[n.COERCERTLFULL]:i[n.COERCERTL],g;for(;(g=m.exec(o))&&(!u||u.index+u[0].length!==o.length);)(!u||g.index+g[0].length!==u.index+u[0].length)&&(u=g),m.lastIndex=g.index+g[1].length+g[2].length;m.lastIndex=-1}if(u===null)return null;let c=u[2],d=u[3]||"0",h=u[4]||"0",p=l.includePrerelease&&u[5]?`-${u[5]}`:"",f=l.includePrerelease&&u[6]?`+${u[6]}`:"";return r(`${c}.${d}.${h}${p}${f}`,l)};t.exports=s}),Fk=F((e,t)=>{"use strict";var a=class{constructor(){this.max=1e3,this.map=new Map}get(r){let i=this.map.get(r);if(i!==void 0)return this.map.delete(r),this.map.set(r,i),i}delete(r){return this.map.delete(r)}set(r,i){if(!this.delete(r)&&i!==void 0){if(this.map.size>=this.max){let n=this.map.keys().next().value;this.delete(n)}this.map.set(r,i)}return this}};t.exports=a}),Bt=F((e,t)=>{"use strict";var a=/\s+/g,r=class iu{constructor(I,V){if(V=s(V),I instanceof iu)return I.loose===!!V.loose&&I.includePrerelease===!!V.includePrerelease?I:new iu(I.raw,V);if(I instanceof o)return this.raw=I.value,this.set=[[I]],this.formatted=void 0,this;if(this.options=V,this.loose=!!V.loose,this.includePrerelease=!!V.includePrerelease,this.raw=I.trim().replace(a," "),this.set=this.raw.split("||").map(z=>this.parseRange(z.trim())).filter(z=>z.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let z=this.set[0];if(this.set=this.set.filter(W=>!b(W[0])),this.set.length===0)this.set=[z];else if(this.set.length>1){for(let W of this.set)if(W.length===1&&y(W[0])){this.set=[W];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let I=0;I<this.set.length;I++){I>0&&(this.formatted+="||");let V=this.set[I];for(let z=0;z<V.length;z++)z>0&&(this.formatted+=" "),this.formatted+=V[z].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(I){let V=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+I,z=n.get(V);if(z)return z;let W=this.options.loose,D=W?c[d.HYPHENRANGELOOSE]:c[d.HYPHENRANGE];I=I.replace(D,Wa(this.options.includePrerelease)),l("hyphen replace",I),I=I.replace(c[d.COMPARATORTRIM],h),l("comparator trim",I),I=I.replace(c[d.TILDETRIM],p),l("tilde trim",I),I=I.replace(c[d.CARETTRIM],f),l("caret trim",I);let X=I.split(" ").map(me=>w(me,this.options)).join(" ").split(/\s+/).map(me=>Xe(me,this.options));W&&(X=X.filter(me=>(l("loose invalid filter",me,this.options),!!me.match(c[d.COMPARATORLOOSE])))),l("range list",X);let de=new Map,le=X.map(me=>new o(me,this.options));for(let me of le){if(b(me))return[me];de.set(me.value,me)}de.size>1&&de.has("")&&de.delete("");let ue=[...de.values()];return n.set(V,ue),ue}intersects(I,V){if(!(I instanceof iu))throw new TypeError("a Range is required");return this.set.some(z=>_(z,V)&&I.set.some(W=>_(W,V)&&z.every(D=>W.every(X=>D.intersects(X,V)))))}test(I){if(!I)return!1;if(typeof I=="string")try{I=new u(I,this.options)}catch{return!1}for(let V=0;V<this.set.length;V++)if(Oa(this.set[V],I,this.options))return!0;return!1}};t.exports=r;var i=Fk(),n=new i,s=Qu(),o=ao(),l=eo(),u=Qe(),{safeRe:c,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=cn(),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=Qs(),b=N=>N.value==="<0.0.0-0",y=N=>N.value==="",_=(N,I)=>{let V=!0,z=N.slice(),W=z.pop();for(;V&&z.length;)V=z.every(D=>W.intersects(D,I)),W=z.pop();return V},w=(N,I)=>(N=N.replace(c[d.BUILD],""),l("comp",N,I),N=E(N,I),l("caret",N),N=j(N,I),l("tildes",N),N=x(N,I),l("xrange",N),N=Le(N,I),l("stars",N),N),O=N=>!N||N.toLowerCase()==="x"||N==="*",j=(N,I)=>N.trim().split(/\s+/).map(V=>S(V,I)).join(" "),S=(N,I)=>{let V=I.loose?c[d.TILDELOOSE]:c[d.TILDE];return N.replace(V,(z,W,D,X,de)=>{l("tilde",N,z,W,D,X,de);let le;return O(W)?le="":O(D)?le=`>=${W}.0.0 <${+W+1}.0.0-0`:O(X)?le=`>=${W}.${D}.0 <${W}.${+D+1}.0-0`:de?(l("replaceTilde pr",de),le=`>=${W}.${D}.${X}-${de} <${W}.${+D+1}.0-0`):le=`>=${W}.${D}.${X} <${W}.${+D+1}.0-0`,l("tilde return",le),le})},E=(N,I)=>N.trim().split(/\s+/).map(V=>A(V,I)).join(" "),A=(N,I)=>{l("caret",N,I);let V=I.loose?c[d.CARETLOOSE]:c[d.CARET],z=I.includePrerelease?"-0":"";return N.replace(V,(W,D,X,de,le)=>{l("caret",N,W,D,X,de,le);let ue;return O(D)?ue="":O(X)?ue=`>=${D}.0.0${z} <${+D+1}.0.0-0`:O(de)?D==="0"?ue=`>=${D}.${X}.0${z} <${D}.${+X+1}.0-0`:ue=`>=${D}.${X}.0${z} <${+D+1}.0.0-0`:le?(l("replaceCaret pr",le),D==="0"?X==="0"?ue=`>=${D}.${X}.${de}-${le} <${D}.${X}.${+de+1}-0`:ue=`>=${D}.${X}.${de}-${le} <${D}.${+X+1}.0-0`:ue=`>=${D}.${X}.${de}-${le} <${+D+1}.0.0-0`):(l("no pr"),D==="0"?X==="0"?ue=`>=${D}.${X}.${de}${z} <${D}.${X}.${+de+1}-0`:ue=`>=${D}.${X}.${de}${z} <${D}.${+X+1}.0-0`:ue=`>=${D}.${X}.${de} <${+D+1}.0.0-0`),l("caret return",ue),ue})},x=(N,I)=>(l("replaceXRanges",N,I),N.split(/\s+/).map(V=>te(V,I)).join(" ")),te=(N,I)=>{N=N.trim();let V=I.loose?c[d.XRANGELOOSE]:c[d.XRANGE];return N.replace(V,(z,W,D,X,de,le)=>{l("xRange",N,z,W,D,X,de,le);let ue=O(D),me=ue||O(X),ka=me||O(de),Ha=ka;return W==="="&&Ha&&(W=""),le=I.includePrerelease?"-0":"",ue?W===">"||W==="<"?z="<0.0.0-0":z="*":W&&Ha?(me&&(X=0),de=0,W===">"?(W=">=",me?(D=+D+1,X=0,de=0):(X=+X+1,de=0)):W==="<="&&(W="<",me?D=+D+1:X=+X+1),W==="<"&&(le="-0"),z=`${W+D}.${X}.${de}${le}`):me?z=`>=${D}.0.0${le} <${+D+1}.0.0-0`:ka&&(z=`>=${D}.${X}.0${le} <${D}.${+X+1}.0-0`),l("xRange return",z),z})},Le=(N,I)=>(l("replaceStars",N,I),N.trim().replace(c[d.STAR],"")),Xe=(N,I)=>(l("replaceGTE0",N,I),N.trim().replace(c[I.includePrerelease?d.GTE0PRE:d.GTE0],"")),Wa=N=>(I,V,z,W,D,X,de,le,ue,me,ka,Ha)=>(O(z)?V="":O(W)?V=`>=${z}.0.0${N?"-0":""}`:O(D)?V=`>=${z}.${W}.0${N?"-0":""}`:X?V=`>=${V}`:V=`>=${V}${N?"-0":""}`,O(ue)?le="":O(me)?le=`<${+ue+1}.0.0-0`:O(ka)?le=`<${ue}.${+me+1}.0-0`:Ha?le=`<=${ue}.${me}.${ka}-${Ha}`:N?le=`<${ue}.${me}.${+ka+1}-0`:le=`<=${le}`,`${V} ${le}`.trim()),Oa=(N,I,V)=>{for(let z=0;z<N.length;z++)if(!N[z].test(I))return!1;if(I.prerelease.length&&!V.includePrerelease){for(let z=0;z<N.length;z++)if(l(N[z].semver),N[z].semver!==o.ANY&&N[z].semver.prerelease.length>0){let W=N[z].semver;if(W.major===I.major&&W.minor===I.minor&&W.patch===I.patch)return!0}return!1}return!0}}),ao=F((e,t)=>{"use strict";var a=Symbol("SemVer ANY"),r=class cp{static get ANY(){return a}constructor(h,p){if(p=i(p),h instanceof cp){if(h.loose===!!p.loose)return h;h=h.value}h=h.trim().split(/\s+/).join(" "),l("comparator",h,p),this.options=p,this.loose=!!p.loose,this.parse(h),this.semver===a?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(h){let p=this.options.loose?n[s.COMPARATORLOOSE]:n[s.COMPARATOR],f=h.match(p);if(!f)throw new TypeError(`Invalid comparator: ${h}`);this.operator=f[1]!==void 0?f[1]:"",this.operator==="="&&(this.operator=""),f[2]?this.semver=new u(f[2],this.options.loose):this.semver=a}toString(){return this.value}test(h){if(l("Comparator.test",h,this.options.loose),this.semver===a||h===a)return!0;if(typeof h=="string")try{h=new u(h,this.options)}catch{return!1}return o(h,this.operator,this.semver,this.options)}intersects(h,p){if(!(h instanceof cp))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(h.value,p).test(this.value):h.operator===""?h.value===""?!0:new c(this.value,p).test(h.semver):(p=i(p),p.includePrerelease&&(this.value==="<0.0.0-0"||h.value==="<0.0.0-0")||!p.includePrerelease&&(this.value.startsWith("<0.0.0")||h.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&h.operator.startsWith(">")||this.operator.startsWith("<")&&h.operator.startsWith("<")||this.semver.version===h.semver.version&&this.operator.includes("=")&&h.operator.includes("=")||o(this.semver,"<",h.semver,p)&&this.operator.startsWith(">")&&h.operator.startsWith("<")||o(this.semver,">",h.semver,p)&&this.operator.startsWith("<")&&h.operator.startsWith(">")))}};t.exports=r;var i=Qu(),{safeRe:n,t:s}=cn(),o=sg(),l=eo(),u=Qe(),c=Bt()}),ro=F((e,t)=>{"use strict";var a=Bt(),r=(i,n,s)=>{try{n=new a(n,s)}catch{return!1}return n.test(i)};t.exports=r}),zk=F((e,t)=>{"use strict";var a=Bt(),r=(i,n)=>new a(i,n).set.map(s=>s.map(o=>o.value).join(" ").trim().split(" "));t.exports=r}),Bk=F((e,t)=>{"use strict";var a=Qe(),r=Bt(),i=(n,s,o)=>{let l=null,u=null,c=null;try{c=new r(s,o)}catch{return null}return n.forEach(d=>{c.test(d)&&(!l||u.compare(d)===-1)&&(l=d,u=new a(l,o))}),l};t.exports=i}),Zk=F((e,t)=>{"use strict";var a=Qe(),r=Bt(),i=(n,s,o)=>{let l=null,u=null,c=null;try{c=new r(s,o)}catch{return null}return n.forEach(d=>{c.test(d)&&(!l||u.compare(d)===1)&&(l=d,u=new a(l,o))}),l};t.exports=i}),qk=F((e,t)=>{"use strict";var a=Qe(),r=Bt(),i=to(),n=(s,o)=>{s=new r(s,o);let l=new a("0.0.0");if(s.test(l)||(l=new a("0.0.0-0"),s.test(l)))return l;l=null;for(let u=0;u<s.set.length;++u){let c=s.set[u],d=null;c.forEach(h=>{let p=new a(h.semver.version);switch(h.operator){case">":p.prerelease.length===0?p.patch++:p.prerelease.push(0),p.raw=p.format();case"":case">=":(!d||i(p,d))&&(d=p);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${h.operator}`)}}),d&&(!l||i(l,d))&&(l=d)}return l&&s.test(l)?l:null};t.exports=n}),Vk=F((e,t)=>{"use strict";var a=Bt(),r=(i,n)=>{try{return new a(i,n).range||"*"}catch{return null}};t.exports=r}),ic=F((e,t)=>{"use strict";var a=Qe(),r=ao(),{ANY:i}=r,n=Bt(),s=ro(),o=to(),l=tc(),u=rc(),c=ac(),d=(h,p,f,m)=>{h=new a(h,m),p=new n(p,m);let g,b,y,_,w;switch(f){case">":g=o,b=u,y=l,_=">",w=">=";break;case"<":g=l,b=c,y=o,_="<",w="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(h,p,m))return!1;for(let O=0;O<p.set.length;++O){let j=p.set[O],S=null,E=null;if(j.forEach(A=>{A.semver===i&&(A=new r(">=0.0.0")),S=S||A,E=E||A,g(A.semver,S.semver,m)?S=A:y(A.semver,E.semver,m)&&(E=A)}),S.operator===_||S.operator===w||(!E.operator||E.operator===_)&&b(h,E.semver)||E.operator===w&&y(h,E.semver))return!1}return!0};t.exports=d}),Wk=F((e,t)=>{"use strict";var a=ic(),r=(i,n,s)=>a(i,n,">",s);t.exports=r}),Hk=F((e,t)=>{"use strict";var a=ic(),r=(i,n,s)=>a(i,n,"<",s);t.exports=r}),Gk=F((e,t)=>{"use strict";var a=Bt(),r=(i,n,s)=>(i=new a(i,s),n=new a(n,s),i.intersects(n,s));t.exports=r}),Jk=F((e,t)=>{"use strict";var a=ro(),r=zt();t.exports=(i,n,s)=>{let o=[],l=null,u=null,c=i.sort((f,m)=>r(f,m,s));for(let f of c)a(f,n,s)?(u=f,l||(l=f)):(u&&o.push([l,u]),u=null,l=null);l&&o.push([l,null]);let d=[];for(let[f,m]of o)f===m?d.push(f):!m&&f===c[0]?d.push("*"):m?f===c[0]?d.push(`<=${m}`):d.push(`${f} - ${m}`):d.push(`>=${f}`);let h=d.join(" || "),p=typeof n.raw=="string"?n.raw:String(n);return h.length<p.length?h:n}}),Kk=F((e,t)=>{"use strict";var a=Bt(),r=ao(),{ANY:i}=r,n=ro(),s=zt(),o=(p,f,m={})=>{if(p===f)return!0;p=new a(p,m),f=new a(f,m);let g=!1;e:for(let b of p.set){for(let y of f.set){let _=c(b,y,m);if(g=g||_!==null,_)continue e}if(g)return!1}return!0},l=[new r(">=0.0.0-0")],u=[new r(">=0.0.0")],c=(p,f,m)=>{if(p===f)return!0;if(p.length===1&&p[0].semver===i){if(f.length===1&&f[0].semver===i)return!0;m.includePrerelease?p=l:p=u}if(f.length===1&&f[0].semver===i){if(m.includePrerelease)return!0;f=u}let g=new Set,b,y;for(let x of p)x.operator===">"||x.operator===">="?b=d(b,x,m):x.operator==="<"||x.operator==="<="?y=h(y,x,m):g.add(x.semver);if(g.size>1)return null;let _;if(b&&y&&(_=s(b.semver,y.semver,m),_>0||_===0&&(b.operator!==">="||y.operator!=="<=")))return null;for(let x of g){if(b&&!n(x,String(b),m)||y&&!n(x,String(y),m))return null;for(let te of f)if(!n(x,String(te),m))return!1;return!0}let w,O,j,S,E=y&&!m.includePrerelease&&y.semver.prerelease.length?y.semver:!1,A=b&&!m.includePrerelease&&b.semver.prerelease.length?b.semver:!1;E&&E.prerelease.length===1&&y.operator==="<"&&E.prerelease[0]===0&&(E=!1);for(let x of f){if(S=S||x.operator===">"||x.operator===">=",j=j||x.operator==="<"||x.operator==="<=",b){if(A&&x.semver.prerelease&&x.semver.prerelease.length&&x.semver.major===A.major&&x.semver.minor===A.minor&&x.semver.patch===A.patch&&(A=!1),x.operator===">"||x.operator===">="){if(w=d(b,x,m),w===x&&w!==b)return!1}else if(b.operator===">="&&!n(b.semver,String(x),m))return!1}if(y){if(E&&x.semver.prerelease&&x.semver.prerelease.length&&x.semver.major===E.major&&x.semver.minor===E.minor&&x.semver.patch===E.patch&&(E=!1),x.operator==="<"||x.operator==="<="){if(O=h(y,x,m),O===x&&O!==y)return!1}else if(y.operator==="<="&&!n(y.semver,String(x),m))return!1}if(!x.operator&&(y||b)&&_!==0)return!1}return!(b&&j&&!y&&_!==0||y&&S&&!b&&_!==0||A||E)},d=(p,f,m)=>{if(!p)return f;let g=s(p.semver,f.semver,m);return g>0?p:g<0||f.operator===">"&&p.operator===">="?f:p},h=(p,f,m)=>{if(!p)return f;let g=s(p.semver,f.semver,m);return g<0?p:g>0||f.operator==="<"&&p.operator==="<="?f:p};t.exports=o}),Xk=F((e,t)=>{"use strict";var a=cn(),r=Qs(),i=Qe(),n=rg(),s=yi(),o=Ak(),l=Sk(),u=jk(),c=Ik(),d=$k(),h=Tk(),p=Nk(),f=Ck(),m=zt(),g=Rk(),b=Lk(),y=ec(),_=Mk(),w=Uk(),O=to(),j=tc(),S=ig(),E=ng(),A=ac(),x=rc(),te=sg(),Le=Dk(),Xe=ao(),Wa=Bt(),Oa=ro(),N=zk(),I=Bk(),V=Zk(),z=qk(),W=Vk(),D=ic(),X=Wk(),de=Hk(),le=Gk(),ue=Jk(),me=Kk();t.exports={parse:s,valid:o,clean:l,inc:u,diff:c,major:d,minor:h,patch:p,prerelease:f,compare:m,rcompare:g,compareLoose:b,compareBuild:y,sort:_,rsort:w,gt:O,lt:j,eq:S,neq:E,gte:A,lte:x,cmp:te,coerce:Le,Comparator:Xe,Range:Wa,satisfies:Oa,toComparators:N,maxSatisfying:I,minSatisfying:V,minVersion:z,validRange:W,outside:D,gtr:X,ltr:de,intersects:le,simplifyRange:ue,subset:me,SemVer:i,re:a.re,src:a.src,tokens:a.t,SEMVER_SPEC_VERSION:r.SEMVER_SPEC_VERSION,RELEASE_TYPES:r.RELEASE_TYPES,compareIdentifiers:n.compareIdentifiers,rcompareIdentifiers:n.rcompareIdentifiers}});function Ya(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);let[t,a]=e.split(":"),r=a||"latest";if(t.includes("/")){let[i,n]=t.split("/",2);if(!i||!n)throw new Error(`Invalid identifier format: ${e}`);return[i,n,r]}else{if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}}var Yk,Qk=v(()=>{Yk=Mt(Xk(),1)});async function Z(e,t,a){let r;if(e.ok){a&&(r=await e.text());return}if(e.status===403)try{(await e.json())?.error==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{let s=new Error(`${e.status} ${e.statusText}`);throw s.status=e?.status,s}if(r===void 0)try{r=await e.text()}catch{r=""}let i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${r}`;if(e.status===409)throw new og(i);let n=new Error(i);throw n.status=e.status,n}function e1(e){return typeof e=="object"&&e!==null&&e.code===nc}var og,nc,lg,ug=v(()=>{og=class extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}},nc="ERR_CONFLICTING_ENDPOINTS",lg=class extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:nc}),this.name="ConflictingEndpointsError"}}});function t1(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function io(e){return hg.encode(e)}function cg(e){if(e&&typeof e=="object"&&e!==null){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if(typeof e=="bigint")return e.toString();return e}function a1(e){return function(t,a){if(e){let r=e.call(this,t,a);if(r!==void 0)return r}return cg(a)}}function ft(e,t,a,r,i){try{let n=JSON.stringify(e,a1(a),r);return io(n)}catch(n){if(!n.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),io("[Unserializable]");nt("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),typeof i>"u"&&(i=t1()),oc(e,"",0,[],void 0,0,i);let s;try{kr.length===0?s=JSON.stringify(e,a,r):s=JSON.stringify(e,r1(a),r)}catch{return io("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;dn.length!==0;){let o=dn.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return io(s)}}function sc(e,t,a,r){var i=Object.getOwnPropertyDescriptor(r,a);i.get!==void 0?i.configurable?(Object.defineProperty(r,a,{value:e}),dn.push([r,a,t,i])):kr.push([t,a,e]):(r[a]=e,dn.push([r,a,t]))}function oc(e,t,a,r,i,n,s){n+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<r.length;o++)if(r[o]===e){sc(dg,e,t,i);return}if(typeof s.depthLimit<"u"&&n>s.depthLimit){sc(lc,e,t,i);return}if(typeof s.edgesLimit<"u"&&a+1>s.edgesLimit){sc(lc,e,t,i);return}if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)oc(e[o],o,o,r,e,n,s);else{e=cg(e);var l=Object.keys(e);for(o=0;o<l.length;o++){var u=l[o];oc(e[u],u,o,r,e,n,s)}}r.pop()}}function r1(e){return e=typeof e<"u"?e:function(t,a){return a},function(t,a){if(kr.length>0)for(var r=0;r<kr.length;r++){var i=kr[r];if(i[1]===t&&i[0]===a){a=i[2],kr.splice(r,1);break}}return e.call(this,t,a)}}var lc,dg,dn,kr,hg,i1=v(()=>{Xa(),lc="[...]",dg={result:"[Circular]"},dn=[],kr=[],hg=new TextEncoder});function pg(e,t){let a=Cm(),r=t??Rm(),i=e.extra??{},n=i.metadata;return e.extra={...i,runtime:{...a,...i?.runtime},metadata:{...r,...r.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??r.revision_id}:{},...n}},e}async function n1(e){let t=[];for await(let a of e)t.push(a);return t}function no(e){if(e!==void 0)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function fg(e){return typeof e=="number"?Number(e.toFixed(4)):e}function mg(e){return"dataset_id"in e||"dataset_name"in e}var gg,yg,bg,_g,vg,wg,Og,uc,cc,kg=v(()=>{la(),bk(),Gm(),Ek(),xk(),Xa(),Zu(),Pk(),ag(),Qk(),ug(),Tm(),i1(),gg=e=>{let t=e?.toString()??nt("TRACING_SAMPLING_RATE");if(t===void 0)return;let a=parseFloat(t);if(a<0||a>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${a}`);return a},yg=e=>{let t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},bg=async e=>{if(e?.status===429){let t=parseInt(e.headers.get("retry-after")??"10",10)*1e3;if(t>0)return await new Promise(a=>setTimeout(a,t)),!0}return!1},_g=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,a=new Promise(i=>{t=i}),r=ft(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:a,size:r}),this.sizeBytes+=r,a}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let a=[],r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0&&a.length<t;){let i=this.items.shift();i&&(a.push(i),r+=i.size,this.sizeBytes-=i.size)}if(a.length===0&&this.items.length>0){let i=this.items.shift();a.push(i),r+=i.size,this.sizeBytes-=i.size}return[a.map(i=>({action:i.action,item:i.payload,otelContext:i.otelContext,apiKey:i.apiKey,apiUrl:i.apiUrl})),()=>a.forEach(i=>i.itemPromiseResolve())]}},vg=24*1024*1024,wg=1e4,Og=100,uc="https://api.smith.langchain.com",cc=class dp{get _fetch(){return this.fetchImplementation||$m(this.debug)}constructor(t={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new _g}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:ua("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:ua("LANGSMITH_DEBUG")==="true"});let a=dp.getDefaultClientConfig();if(this.tracingSampleRate=gg(t.tracingSamplingRate),this.apiUrl=no(t.apiUrl??a.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=no(t.apiKey??a.apiKey),this.webUrl=no(t.webUrl??a.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=no(t.workspaceId??nt("WORKSPACE_ID")),this.timeout_ms=t.timeout_ms??9e4,this.caller=new Ku({...t.callerOptions??{},maxRetries:4,debug:t.debug??this.debug}),this.traceBatchConcurrency=t.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=t.debug??this.debug,this.fetchImplementation=t.fetchImplementation,this.batchIngestCaller=new Ku({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...t.callerOptions??{},onFailedResponseHook:bg,debug:t.debug??this.debug}),this.hideInputs=t.hideInputs??t.anonymizer??a.hideInputs,this.hideOutputs=t.hideOutputs??t.anonymizer??a.hideOutputs,this.autoBatchTracing=t.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=t.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=t.batchSizeBytesLimit,this.batchSizeLimit=t.batchSizeLimit,this.fetchOptions=t.fetchOptions||{},this.manualFlushMode=t.manualFlushMode??this.manualFlushMode,Lm()&&(this.langSmithToOTELTranslator=new Km),this.cachedLSEnvVarsForMetadata=Rm()}static getDefaultClientConfig(){let t=nt("API_KEY"),a=nt("ENDPOINT")??uc,r=nt("HIDE_INPUTS")==="true",i=nt("HIDE_OUTPUTS")==="true";return{apiUrl:a,apiKey:t,webUrl:void 0,hideInputs:r,hideOutputs:i}}getHostUrl(){return this.webUrl?this.webUrl:yg(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let t={"User-Agent":`langsmith-js/${Bu}`};return this.apiKey&&(t["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(t["x-tenant-id"]=this.workspaceId),t}_getPlatformEndpointPath(t){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${t}`:`/platform/${t}`}async processInputs(t){return this.hideInputs===!1?t:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(t):t}async processOutputs(t){return this.hideOutputs===!1?t:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(t):t}async prepareRunCreateOrUpdateInputs(t){let a={...t};return a.inputs!==void 0&&(a.inputs=await this.processInputs(a.inputs)),a.outputs!==void 0&&(a.outputs=await this.processOutputs(a.outputs)),a}async _getResponse(t,a){let r=a?.toString()??"",i=`${this.apiUrl}${t}?${r}`;return await this.caller.call(async()=>{let n=await this._fetch(i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(n,`fetch ${t}`),n})}async _get(t,a){return(await this._getResponse(t,a)).json()}async*_getPaginated(t,a=new URLSearchParams,r){let i=Number(a.get("offset"))||0,n=Number(a.get("limit"))||100;for(;;){a.set("offset",String(i)),a.set("limit",String(n));let s=`${this.apiUrl}${t}?${a}`,o=await this.caller.call(async()=>{let u=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(u,`fetch ${t}`),u}),l=r?r(await o.json()):await o.json();if(l.length===0||(yield l,l.length<n))break;i+=l.length}}async*_getCursorPaginatedList(t,a=null,r="POST",i="runs"){let n=a?{...a}:{};for(;;){let s=JSON.stringify(n),o=await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}${t}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(u,`fetch ${t}`),u})).json();if(!o||!o[i])break;yield o[i];let l=o.cursors;if(!l||!l.next)break;n.cursor=l.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(t,a=!1){if(this.tracingSampleRate===void 0)return t;if(a){let r=[];for(let i of t)this.filteredPostUuids.has(i.trace_id)?i.id===i.trace_id&&this.filteredPostUuids.delete(i.trace_id):r.push(i);return r}else{let r=[];for(let i of t){let n=i.trace_id??i.id;this.filteredPostUuids.has(n)||(i.id===n?this._shouldSample()?r.push(i):this.filteredPostUuids.add(n):r.push(i))}return r}}async _getBatchSizeLimitBytes(){let t=await this._ensureServerInfo();return this.batchSizeBytesLimit??t.batch_ingest_config?.size_limit_bytes??vg}async _getBatchSizeLimit(){let t=await this._ensureServerInfo();return this.batchSizeLimit??t.batch_ingest_config?.size_limit??Og}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:a}){let r=[];for(;this.autoBatchQueue.items.length>0;){let[i,n]=this.autoBatchQueue.pop({upToSizeBytes:t,upToSize:a});if(!i.length){n();break}let s=i.reduce((u,c)=>{let d=c.apiUrl??this.apiUrl,h=c.apiKey??this.apiKey,p=c.apiKey===this.apiKey&&c.apiUrl===this.apiUrl?"default":`${d}|${h}`;return u[p]||(u[p]=[]),u[p].push(c),u},{}),o=[];for(let[u,c]of Object.entries(s)){let d=this._processBatch(c,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(d)}let l=Promise.all(o).finally(n);r.push(l)}return Promise.all(r)}async _processBatch(t,a){if(t.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(t);else{let r={runCreates:t.filter(n=>n.action==="create").map(n=>n.item),runUpdates:t.filter(n=>n.action==="update").map(n=>n.item)},i=await this._ensureServerInfo();if(i?.batch_ingest_config?.use_multipart_endpoint){let n=i?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(r,{...a,useGzip:n})}else await this.batchIngestRuns(r,a)}}catch(r){console.error("Error exporting batch:",r)}}_sendBatchToOTELTranslator(t){if(this.langSmithToOTELTranslator!==void 0){let a=new Map,r=[];for(let i of t)i.item.id&&i.otelContext&&(a.set(i.item.id,i.otelContext),i.action==="create"?r.push({operation:"post",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}):r.push({operation:"patch",id:i.item.id,trace_id:i.item.trace_id??i.item.id,run:i.item}));this.langSmithToOTELTranslator.exportBatch(r,a)}}async processRunOperation(t){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,t.item=pg(t.item,this.cachedLSEnvVarsForMetadata);let a=this.autoBatchQueue.push(t);if(this.manualFlushMode)return a;let r=await this._getBatchSizeLimitBytes(),i=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>i)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:i}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:i})},this.autoBatchAggregationDelayMs)),a}async _getServerInfo(){let t=await(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(wg),...this.fetchOptions});return await Z(a,"get server info"),a})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${t.status??"Unspecified status code"} ${t.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(t=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),t))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let t=await this._getBatchSizeLimitBytes(),a=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:a})}_cloneCurrentOTELContext(){let t=zm(),a=mk();if(this.langSmithToOTELTranslator!==void 0){let r=t.getActiveSpan();if(r)return t.setSpan(a.active(),r)}}async createRun(t,a){if(!this._filterForSampling([t]).length)return;let r={...this.headers,"Content-Type":"application/json"},i=t.project_name;delete t.project_name;let n=await this.prepareRunCreateOrUpdateInputs({session_name:i,...t,start_time:t.start_time??Date.now()});if(this.autoBatchTracing&&n.trace_id!==void 0&&n.dotted_order!==void 0){let l=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:n,otelContext:l,apiKey:a?.apiKey,apiUrl:a?.apiUrl}).catch(console.error);return}let s=pg(n,this.cachedLSEnvVarsForMetadata);a?.apiKey!==void 0&&(r["x-api-key"]=a.apiKey),a?.workspaceId!==void 0&&(r["x-tenant-id"]=a.workspaceId);let o=ft(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{let l=await this._fetch(`${a?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Z(l,"create run",!0),l})}async batchIngestRuns({runCreates:t,runUpdates:a},r){if(t===void 0&&a===void 0)return;let i=await Promise.all(t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[]),n=await Promise.all(a?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[]);if(i.length>0&&n.length>0){let l=i.reduce((c,d)=>(d.id&&(c[d.id]=d),c),{}),u=[];for(let c of n)c.id!==void 0&&l[c.id]?l[c.id]={...l[c.id],...c}:u.push(c);i=Object.values(l),n=u}let s={post:i,patch:n};if(!s.post.length&&!s.patch.length)return;let o={post:[],patch:[]};for(let l of["post","patch"]){let u=l,c=s[u].reverse(),d=c.pop();for(;d!==void 0;)o[u].push(d),d=c.pop()}if(o.post.length>0||o.patch.length>0){let l=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(ft(o,`Ingesting runs with ids: ${l}`),r)}}async _postBatchIngestRuns(t,a){let r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};a?.apiKey!==void 0&&(r["x-api-key"]=a.apiKey),await this.batchIngestCaller.call(async()=>{let i=await this._fetch(`${a?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await Z(i,"batch create run",!0),i})}async multipartIngestRuns({runCreates:t,runUpdates:a},r){if(t===void 0&&a===void 0)return;let i={},n=[];for(let u of t??[]){let c=await this.prepareRunCreateOrUpdateInputs(u);c.id!==void 0&&c.attachments!==void 0&&(i[c.id]=c.attachments),delete c.attachments,n.push(c)}let s=[];for(let u of a??[])s.push(await this.prepareRunCreateOrUpdateInputs(u));if(n.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(n.length>0&&s.length>0){let u=n.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),c=[];for(let d of s)d.id!==void 0&&u[d.id]?u[d.id]={...u[d.id],...d}:c.push(d);n=Object.values(u),s=c}if(n.length===0&&s.length===0)return;let o=[],l=[];for(let[u,c]of[["post",n],["patch",s]])for(let d of c){let{inputs:h,outputs:p,events:f,extra:m,error:g,serialized:b,attachments:y,..._}=d,w={inputs:h,outputs:p,events:f,extra:m,error:g,serialized:b},O=ft(_,`Serializing for multipart ingestion of run with id: ${_.id}`);l.push({name:`${u}.${_.id}`,payload:new Blob([O],{type:`application/json; length=${O.length}`})});for(let[j,S]of Object.entries(w)){if(S===void 0)continue;let E=ft(S,`Serializing ${j} for multipart ingestion of run with id: ${_.id}`);l.push({name:`${u}.${_.id}.${j}`,payload:new Blob([E],{type:`application/json; length=${E.length}`})})}if(_.id!==void 0){let j=i[_.id];if(j){delete i[_.id];for(let[S,E]of Object.entries(j)){let A,x;if(Array.isArray(E)?[A,x]=E:(A=E.mimeType,x=E.data),S.includes(".")){console.warn(`Skipping attachment '${S}' for run ${_.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${_.id}.${S}`,payload:new Blob([x],{type:`${A}; length=${x.byteLength}`})})}}}o.push(`trace=${_.trace_id},id=${_.id}`)}await this._sendMultipartRequest(l,o.join("; "),r)}async _createNodeFetchBody(t,a){let r=[];for(let i of t)r.push(new Blob([`--${a}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${i.name}"\r
`,`Content-Type: ${i.payload.type}\r
\r
`])),r.push(i.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${a}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(t,a){let r=new TextEncoder;return new ReadableStream({async start(i){let n=async s=>{typeof s=="string"?i.enqueue(r.encode(s)):i.enqueue(s)};for(let s of t){await n(`--${a}\r
`),await n(`Content-Disposition: form-data; name="${s.name}"\r
`),await n(`Content-Type: ${s.payload.type}\r
\r
`);let o=s.payload.stream().getReader();try{let l;for(;!(l=await o.read()).done;)i.enqueue(l.value)}finally{o.releaseLock()}await n(`\r
`)}await n(`--${a}--\r
`),i.close()}})}async _sendMultipartRequest(t,a,r){let i="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),n=Im(),s=()=>this._createNodeFetchBody(t,i),o=()=>this._createMultipartStream(t,i),l=async u=>this.batchIngestCaller.call(async()=>{let c=await u(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${i}`};r?.apiKey!==void 0&&(d["x-api-key"]=r.apiKey);let h=c;r?.useGzip&&typeof c=="object"&&"pipeThrough"in c&&(h=c.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");let p=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(p,"Failed to send multipart request",!0),p});try{let u,c=!1;!n&&!this.multipartStreamingDisabled&&Vu()!=="bun"?(c=!0,u=await l(o)):u=await l(s),(!this.multipartStreamingDisabled||c)&&u.status===422&&(r?.apiUrl??this.apiUrl)!==uc&&(console.warn(`Streaming multipart upload to ${r?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${a}".`),this.multipartStreamingDisabled=!0,u=await l(s))}catch(u){console.warn(`${u.message.trim()}

Context: ${a}`)}}async updateRun(t,a,r){ae(t),a.inputs&&(a.inputs=await this.processInputs(a.inputs)),a.outputs&&(a.outputs=await this.processOutputs(a.outputs));let i={...a,id:t};if(!this._filterForSampling([i],!0).length)return;if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){let o=this._cloneCurrentOTELContext();if(a.end_time!==void 0&&i.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:i,otelContext:o,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}let n={...this.headers,"Content-Type":"application/json"};r?.apiKey!==void 0&&(n["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(n["x-tenant-id"]=r.workspaceId);let s=ft(a,`Serializing payload to update run with id: ${t}`);await this.caller.call(async()=>{let o=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/${t}`,{method:"PATCH",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,"update run",!0),o})}async readRun(t,{loadChildRuns:a}={loadChildRuns:!1}){ae(t);let r=await this._get(`/runs/${t}`);return a&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:t,run:a,projectOpts:r}){if(a!==void 0){let i;a.session_id?i=a.session_id:r?.projectName?i=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?i=r?.projectId:i=(await this.readProject({projectName:nt("PROJECT")||"default"})).id;let n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${i}/r/${a.id}?poll=true`}else if(t!==void 0){let i=await this.readRun(t);if(!i.app_path)throw new Error(`Run ${t} has no app_path`);return`${this.getHostUrl()}${i.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(t){let a=await n1(this.listRuns({isRoot:!1,projectId:t.session_id,traceId:t.trace_id})),r={},i={};a.sort((n,s)=>(n?.dotted_order??"").localeCompare(s?.dotted_order??""));for(let n of a){if(n.parent_run_id===null||n.parent_run_id===void 0)throw new Error(`Child run ${n.id} has no parent`);n.dotted_order?.startsWith(t.dotted_order??"")&&n.id!==t.id&&(n.parent_run_id in r||(r[n.parent_run_id]=[]),r[n.parent_run_id].push(n),i[n.id]=n)}t.child_runs=r[t.id]||[];for(let n in r)n!==t.id&&(i[n].child_runs=r[n]);return t}async*listRuns(t){let{projectId:a,projectName:r,parentRunId:i,traceId:n,referenceExampleId:s,startTime:o,executionOrder:l,isRoot:u,runType:c,error:d,id:h,query:p,filter:f,traceFilter:m,treeFilter:g,limit:b,select:y,order:_}=t,w=[];if(a&&(w=Array.isArray(a)?a:[a]),r){let E=Array.isArray(r)?r:[r],A=await Promise.all(E.map(x=>this.readProject({projectName:x}).then(te=>te.id)));w.push(...A)}let O=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],j={session:w.length?w:null,run_type:c,reference_example:s,query:p,filter:f,trace_filter:m,tree_filter:g,execution_order:l,parent_run:i,start_time:o?o.toISOString():null,error:d,id:h,limit:b,trace:n,select:y||O,is_root:u,order:_};j.select.includes("child_run_ids")&&Xu("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let S=0;for await(let E of this._getCursorPaginatedList("/runs/query",j))if(b){if(S>=b)break;if(E.length+S>b){yield*E.slice(0,b-S);break}S+=E.length,yield*E}else yield*E}async*listGroupRuns(t){let{projectId:a,projectName:r,groupBy:i,filter:n,startTime:s,endTime:o,limit:l,offset:u}=t,c={session_id:a||(await this.readProject({projectName:r})).id,group_by:i,filter:n,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(l)||100},d=Number(u)||0,h="/runs/group",p=`${this.apiUrl}${h}`;for(;;){let f={...c,offset:d},m=Object.fromEntries(Object.entries(f).filter(([w,O])=>O!==void 0)),g=JSON.stringify(m),b=await(await this.caller.call(async()=>{let w=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await Z(w,`Failed to fetch ${h}`),w})).json(),{groups:y,total:_}=b;if(y.length===0)break;for(let w of y)yield w;if(d+=y.length,d>=_)break}}async getRunStats({id:t,trace:a,parentRun:r,runType:i,projectNames:n,projectIds:s,referenceExampleIds:o,startTime:l,endTime:u,error:c,query:d,filter:h,traceFilter:p,treeFilter:f,isRoot:m,dataSourceType:g}){let b=s||[];n&&(b=[...s||[],...await Promise.all(n.map(w=>this.readProject({projectName:w}).then(O=>O.id)))]);let y=Object.fromEntries(Object.entries({id:t,trace:a,parent_run:r,run_type:i,session:b,reference_example:o,start_time:l,end_time:u,error:c,query:d,filter:h,trace_filter:p,tree_filter:f,is_root:m,data_source_type:g}).filter(([w,O])=>O!==void 0)),_=JSON.stringify(y);return await(await this.caller.call(async()=>{let w=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:_});return await Z(w,"get run stats"),w})).json()}async shareRun(t,{shareId:a}={}){let r={run_id:t,share_token:a||Ue()};ae(t);let i=JSON.stringify(r),n=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await Z(s,"share run"),s})).json();if(n===null||!("share_token"in n))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(t){ae(t),await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"unshare run",!0),a})}async readRunSharedLink(t){ae(t);let a=await(await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(r,"read run shared link"),r})).json();if(!(a===null||!("share_token"in a)))return`${this.getHostUrl()}/public/${a.share_token}/r`}async listSharedRuns(t,{runIds:a}={}){let r=new URLSearchParams({share_token:t});if(a!==void 0)for(let i of a)r.append("id",i);return ae(t),await(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/public/${t}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(i,"list shared runs"),i})).json()}async readDatasetSharedSchema(t,a){if(!t&&!a)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:a})).id),ae(t);let r=await(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(i,"read dataset shared schema"),i})).json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(t,a){if(!t&&!a)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:a})).id);let r={dataset_id:t};ae(t);let i=JSON.stringify(r),n=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await Z(s,"share dataset"),s})).json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(t){ae(t),await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"unshare dataset",!0),a})}async readSharedDataset(t){return ae(t),await(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/public/${t}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"read shared dataset"),a})).json()}async listSharedExamples(t,a){let r={};a?.exampleIds&&(r.id=a.exampleIds);let i=new URLSearchParams;Object.entries(r).forEach(([o,l])=>{Array.isArray(l)?l.forEach(u=>i.append(o,u)):i.append(o,l)});let n=await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/public/${t}/examples?${i.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(o,"list shared examples"),o}),s=await n.json();if(!n.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${n.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${n.status} ${n.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:t,description:a=null,metadata:r=null,upsert:i=!1,projectExtra:n=null,referenceDatasetId:s=null}){let o=i?"?upsert=true":"",l=`${this.apiUrl}/sessions${o}`,u=n||{};r&&(u.metadata=r);let c={name:t,extra:u,description:a};s!==null&&(c.reference_dataset_id=s);let d=JSON.stringify(c);return await(await this.caller.call(async()=>{let h=await this._fetch(l,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await Z(h,"create project"),h})).json()}async updateProject(t,{name:a=null,description:r=null,metadata:i=null,projectExtra:n=null,endTime:s=null}){let o=`${this.apiUrl}/sessions/${t}`,l=n;i&&(l={...l||{},metadata:i});let u=JSON.stringify({name:a,extra:l,description:r,end_time:s?new Date(s).toISOString():null});return await(await this.caller.call(async()=>{let c=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Z(c,"update project"),c})).json()}async hasProject({projectId:t,projectName:a}){let r="/sessions",i=new URLSearchParams;if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)ae(t),r+=`/${t}`;else if(a!==void 0)i.append("name",a);else throw new Error("Must provide projectName or projectId");let n=await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}${r}?${i}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(s,"has project"),s});try{let s=await n.json();return n.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:t,projectName:a,includeStats:r}){let i="/sessions",n=new URLSearchParams;if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)ae(t),i+=`/${t}`;else if(a!==void 0)n.append("name",a);else throw new Error("Must provide projectName or projectId");r!==void 0&&n.append("include_stats",r.toString());let s=await this._get(i,n),o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${t}, name=${a}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:t,projectName:a}){if(t===void 0&&a===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:t,projectName:a}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${r.id}`}async getDatasetUrl({datasetId:t,datasetName:a}){if(t===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:t,datasetName:a}),i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let t=new URLSearchParams({limit:"1"});for await(let a of this._getPaginated("/sessions",t))return this._tenantId=a[0].tenant_id,a[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:t,name:a,nameContains:r,referenceDatasetId:i,referenceDatasetName:n,includeStats:s,datasetVersion:o,referenceFree:l,metadata:u}={}){let c=new URLSearchParams;if(t!==void 0)for(let d of t)c.append("id",d);if(a!==void 0&&c.append("name",a),r!==void 0&&c.append("name_contains",r),i!==void 0)c.append("reference_dataset",i);else if(n!==void 0){let d=await this.readDataset({datasetName:n});c.append("reference_dataset",d.id)}s!==void 0&&c.append("include_stats",s.toString()),o!==void 0&&c.append("dataset_version",o),l!==void 0&&c.append("reference_free",l.toString()),u!==void 0&&c.append("metadata",JSON.stringify(u));for await(let d of this._getPaginated("/sessions",c))yield*d}async deleteProject({projectId:t,projectName:a}){let r;if(t===void 0&&a===void 0)throw new Error("Must provide projectName or projectId");if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");t===void 0?r=(await this.readProject({projectName:a})).id:r=t,ae(r),await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(i,`delete session ${r} (${a})`,!0),i})}async uploadCsv({csvFile:t,fileName:a,inputKeys:r,outputKeys:i,description:n,dataType:s,name:o}){let l=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",t,a),r.forEach(c=>{u.append("input_keys",c)}),i.forEach(c=>{u.append("output_keys",c)}),n&&u.append("description",n),s&&u.append("data_type",s),o&&u.append("name",o),await(await this.caller.call(async()=>{let c=await this._fetch(l,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Z(c,"upload CSV"),c})).json()}async createDataset(t,{description:a,dataType:r,inputsSchema:i,outputsSchema:n,metadata:s}={}){let o={name:t,description:a,extra:s?{metadata:s}:void 0};r&&(o.data_type=r),i&&(o.inputs_schema_definition=i),n&&(o.outputs_schema_definition=n);let l=JSON.stringify(o);return await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await Z(u,"create dataset"),u})).json()}async readDataset({datasetId:t,datasetName:a}){let r="/datasets",i=new URLSearchParams({limit:"1"});if(t&&a)throw new Error("Must provide either datasetName or datasetId, not both");if(t)ae(t),r+=`/${t}`;else if(a)i.append("name",a);else throw new Error("Must provide datasetName or datasetId");let n=await this._get(r,i),s;if(Array.isArray(n)){if(n.length===0)throw new Error(`Dataset[id=${t}, name=${a}] not found`);s=n[0]}else s=n;return s}async hasDataset({datasetId:t,datasetName:a}){try{return await this.readDataset({datasetId:t,datasetName:a}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:t,datasetName:a,fromVersion:r,toVersion:i}){let n=t;if(n===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(n!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");n===void 0&&(n=(await this.readDataset({datasetName:a})).id);let s=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof i=="string"?i:i.toISOString()});return await this._get(`/datasets/${n}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:t,datasetName:a}){let r="/datasets";if(t===void 0)if(a!==void 0)t=(await this.readDataset({datasetName:a})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${t}/openai_ft`)).text()).trim().split(`
`).map(i=>JSON.parse(i))}async*listDatasets({limit:t=100,offset:a=0,datasetIds:r,datasetName:i,datasetNameContains:n,metadata:s}={}){let o="/datasets",l=new URLSearchParams({limit:t.toString(),offset:a.toString()});if(r!==void 0)for(let u of r)l.append("id",u);i!==void 0&&l.append("name",i),n!==void 0&&l.append("name_contains",n),s!==void 0&&l.append("metadata",JSON.stringify(s));for await(let u of this._getPaginated(o,l))yield*u}async updateDataset(t){let{datasetId:a,datasetName:r,...i}=t;if(!a&&!r)throw new Error("Must provide either datasetName or datasetId");let n=a??(await this.readDataset({datasetName:r})).id;ae(n);let s=JSON.stringify(i);return await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,"update dataset"),o})).json()}async updateDatasetTag(t){let{datasetId:a,datasetName:r,asOf:i,tag:n}=t;if(!a&&!r)throw new Error("Must provide either datasetName or datasetId");let s=a??(await this.readDataset({datasetName:r})).id;ae(s);let o=JSON.stringify({as_of:typeof i=="string"?i:i.toISOString(),tag:n});await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Z(l,"update dataset tags",!0),l})}async deleteDataset({datasetId:t,datasetName:a}){let r="/datasets",i=t;if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(a!==void 0&&(i=(await this.readDataset({datasetName:a})).id),i!==void 0)ae(i),r+=`/${i}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{let n=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(n,`delete ${r}`,!0),n})}async indexDataset({datasetId:t,datasetName:a,tag:r}){let i=t;if(!i&&!a)throw new Error("Must provide either datasetName or datasetId");if(i&&a)throw new Error("Must provide either datasetName or datasetId, not both");i||(i=(await this.readDataset({datasetName:a})).id),ae(i);let n=JSON.stringify({tag:r});await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/datasets/${i}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await Z(s,"index dataset"),s})).json()}async similarExamples(t,a,r,{filter:i}={}){let n={limit:r,inputs:t};i!==void 0&&(n.filter=i),ae(a);let s=JSON.stringify(n);return(await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${a}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await Z(o,"fetch similar examples"),o})).json()).examples}async createExample(t,a,r){if(mg(t)&&(a!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let i=a?r?.datasetId:t.dataset_id,n=a?r?.datasetName:t.dataset_name;if(i===void 0&&n===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&n!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:n})).id);let s=(a?r?.createdAt:t.created_at)||new Date,o;mg(t)?o=t:o={inputs:t,outputs:a,created_at:s?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};let l=await this._uploadExamplesMultipart(i,[o]);return await this.readExample(l.example_ids?.[0]??Ue())}async createExamples(t){if(Array.isArray(t)){if(t.length===0)return[];let b=t,y=b[0].dataset_id,_=b[0].dataset_name;if(y===void 0&&_===void 0)throw new Error("Must provide either datasetName or datasetId");if(y!==void 0&&_!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");y===void 0&&(y=(await this.readDataset({datasetName:_})).id);let w=await this._uploadExamplesMultipart(y,b);return await Promise.all(w.example_ids.map(O=>this.readExample(O)))}let{inputs:a,outputs:r,metadata:i,splits:n,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:l,attachments:u,exampleIds:c,datasetId:d,datasetName:h}=t;if(a===void 0)throw new Error("Must provide inputs when using legacy parameters");let p=d,f=h;if(p===void 0&&f===void 0)throw new Error("Must provide either datasetName or datasetId");if(p!==void 0&&f!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");p===void 0&&(p=(await this.readDataset({datasetName:f})).id);let m=a.map((b,y)=>({dataset_id:p,inputs:b,outputs:r?.[y],metadata:i?.[y],split:n?.[y],id:c?.[y],attachments:u?.[y],source_run_id:s?.[y],use_source_run_io:o?.[y],use_source_run_attachments:l?.[y]})),g=await this._uploadExamplesMultipart(p,m);return await Promise.all(g.example_ids.map(b=>this.readExample(b)))}async createLLMExample(t,a,r){return this.createExample({input:t},{output:a},r)}async createChatExample(t,a,r){let i=t.map(s=>Qm(s)?eg(s):s),n=Qm(a)?eg(a):a;return this.createExample({input:i},{output:n},r)}async readExample(t){ae(t);let a=`/examples/${t}`,r=await this._get(a),{attachment_urls:i,...n}=r,s=n;return i&&(s.attachments=Object.entries(i).reduce((o,[l,u])=>(o[l.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),s}async*listExamples({datasetId:t,datasetName:a,exampleIds:r,asOf:i,splits:n,inlineS3Urls:s,metadata:o,limit:l,offset:u,filter:c,includeAttachments:d}={}){let h;if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0)h=t;else if(a!==void 0)h=(await this.readDataset({datasetName:a})).id;else throw new Error("Must provide a datasetName or datasetId");let p=new URLSearchParams({dataset:h}),f=i?typeof i=="string"?i:i?.toISOString():void 0;f&&p.append("as_of",f);let m=s??!0;if(p.append("inline_s3_urls",m.toString()),r!==void 0)for(let b of r)p.append("id",b);if(n!==void 0)for(let b of n)p.append("splits",b);if(o!==void 0){let b=JSON.stringify(o);p.append("metadata",b)}l!==void 0&&p.append("limit",l.toString()),u!==void 0&&p.append("offset",u.toString()),c!==void 0&&p.append("filter",c),d===!0&&["attachment_urls","outputs","metadata"].forEach(b=>p.append("select",b));let g=0;for await(let b of this._getPaginated("/examples",p)){for(let y of b){let{attachment_urls:_,...w}=y,O=w;_&&(O.attachments=Object.entries(_).reduce((j,[S,E])=>(j[S.slice(11)]={presigned_url:E.presigned_url,mime_type:E.mime_type||void 0},j),{})),yield O,g++}if(l!==void 0&&g>=l)break}}async deleteExample(t){ae(t);let a=`/examples/${t}`;await this.caller.call(async()=>{let r=await this._fetch(this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(r,`delete ${a}`,!0),r})}async updateExample(t,a){let r;a?r=t:r=t.id,ae(r);let i;a?i={id:r,...a}:i=t;let n;return i.dataset_id!==void 0?n=i.dataset_id:n=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(n,[i])}async updateExamples(t){let a;return t[0].dataset_id===void 0?a=(await this.readExample(t[0].id)).dataset_id:a=t[0].dataset_id,this._updateExamplesMultipart(a,t)}async readDatasetVersion({datasetId:t,datasetName:a,asOf:r,tag:i}){let n;if(t?n=t:n=(await this.readDataset({datasetName:a})).id,ae(n),r&&i||!r&&!i)throw new Error("Exactly one of asOf and tag must be specified.");let s=new URLSearchParams;return r!==void 0&&s.append("as_of",typeof r=="string"?r:r.toISOString()),i!==void 0&&s.append("tag",i),await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${n}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(o,"read dataset version"),o})).json()}async listDatasetSplits({datasetId:t,datasetName:a,asOf:r}){let i;if(t===void 0&&a===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?i=(await this.readDataset({datasetName:a})).id:i=t,ae(i);let n=new URLSearchParams,s=r?typeof r=="string"?r:r?.toISOString():void 0;return s&&n.append("as_of",s),await this._get(`/datasets/${i}/splits`,n)}async updateDatasetSplits({datasetId:t,datasetName:a,splitName:r,exampleIds:i,remove:n=!1}){let s;if(t===void 0&&a===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?s=(await this.readDataset({datasetName:a})).id:s=t,ae(s);let o={split_name:r,examples:i.map(u=>(ae(u),u)),remove:n},l=JSON.stringify(o);await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await Z(u,"update dataset splits",!0),u})}async evaluateRun(t,a,{sourceInfo:r,loadChildRuns:i,referenceExample:n}={loadChildRuns:!1}){Xu("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof t=="string")s=await this.readRun(t,{loadChildRuns:i});else if(typeof t=="object"&&"id"in t)s=t;else throw new Error(`Invalid run type: ${typeof t}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(n=await this.readExample(s.reference_example_id));let o=await a.evaluateRun(s,n),[l,u]=await this._logEvaluationFeedback(o,s,r);return u[0]}async createFeedback(t,a,{score:r,value:i,correction:n,comment:s,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:u,feedbackId:c,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){if(!t&&!h)throw new Error("One of runId or projectId must be provided");if(t&&h)throw new Error("Only one of runId or projectId can be provided");let f={type:l??"api",metadata:o??{}};u!==void 0&&f?.metadata!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:u}),f?.metadata!==void 0&&f.metadata.__run?.run_id!==void 0&&ae(f.metadata.__run.run_id);let m={id:c??Ue(),run_id:t,key:a,score:fg(r),value:i,correction:n,comment:s,feedback_source:f,comparative_experiment_id:p,feedbackConfig:d,session_id:h},g=JSON.stringify(m),b=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{let y=await this._fetch(b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await Z(y,"create feedback",!0),y}),m}async updateFeedback(t,{score:a,value:r,correction:i,comment:n}){let s={};a!=null&&(s.score=fg(a)),r!=null&&(s.value=r),i!=null&&(s.correction=i),n!=null&&(s.comment=n),ae(t);let o=JSON.stringify(s);await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/feedback/${t}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Z(l,"update feedback",!0),l})}async readFeedback(t){ae(t);let a=`/feedback/${t}`;return await this._get(a)}async deleteFeedback(t){ae(t);let a=`/feedback/${t}`;await this.caller.call(async()=>{let r=await this._fetch(this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(r,`delete ${a}`,!0),r})}async*listFeedback({runIds:t,feedbackKeys:a,feedbackSourceTypes:r}={}){let i=new URLSearchParams;if(t)for(let n of t)ae(n),i.append("run",n);if(a)for(let n of a)i.append("key",n);if(r)for(let n of r)i.append("source",n);for await(let n of this._getPaginated("/feedback",i))yield*n}async createPresignedFeedbackToken(t,a,{expiration:r,feedbackConfig:i}={}){let n={run_id:t,feedback_key:a,feedback_config:i};r?typeof r=="string"?n.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(n.expires_in=r):n.expires_in={hours:3};let s=JSON.stringify(n);return await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,"create presigned feedback token"),o})).json()}async createComparativeExperiment({name:t,experimentIds:a,referenceDatasetId:r,createdAt:i,description:n,metadata:s,id:o}){if(a.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:a[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let l={id:o,name:t,experiment_ids:a,reference_dataset_id:r,description:n,created_at:(i??new Date)?.toISOString(),extra:{}};s&&(l.extra.metadata=s);let u=JSON.stringify(l);return(await this.caller.call(async()=>{let c=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Z(c,"create comparative experiment"),c})).json()}async*listPresignedFeedbackTokens(t){ae(t);let a=new URLSearchParams({run_id:t});for await(let r of this._getPaginated("/feedback/tokens",a))yield*r}_selectEvalResults(t){let a;return"results"in t?a=t.results:Array.isArray(t)?a=t:a=[t],a}async _logEvaluationFeedback(t,a,r){let i=this._selectEvalResults(t),n=[];for(let s of i){let o=r||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let l=null;s.targetRunId?l=s.targetRunId:a&&(l=a.id),n.push(await this.createFeedback(l,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[i,n]}async logEvaluationFeedback(t,a,r){let[i]=await this._logEvaluationFeedback(t,a,r);return i}async*listAnnotationQueues(t={}){let{queueIds:a,name:r,nameContains:i,limit:n}=t,s=new URLSearchParams;a&&a.forEach((l,u)=>{ae(l,`queueIds[${u}]`),s.append("ids",l)}),r&&s.append("name",r),i&&s.append("name_contains",i),s.append("limit",(n!==void 0?Math.min(n,100):100).toString());let o=0;for await(let l of this._getPaginated("/annotation-queues",s))if(yield*l,o++,n!==void 0&&o>=n)break}async createAnnotationQueue(t){let{name:a,description:r,queueId:i,rubricInstructions:n}=t,s={name:a,description:r,id:i||Ue(),rubric_instructions:n},o=JSON.stringify(Object.fromEntries(Object.entries(s).filter(([l,u])=>u!==void 0)));return(await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await Z(l,"create annotation queue"),l})).json()}async readAnnotationQueue(t){return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"read annotation queue"),a})).json()}async updateAnnotationQueue(t,a){let{name:r,description:i,rubricInstructions:n}=a,s=JSON.stringify({name:r,description:i,rubric_instructions:n});await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(t){await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"delete annotation queue",!0),a})}async addRunsToAnnotationQueue(t,a){let r=JSON.stringify(a.map((i,n)=>ae(i,`runIds[${n}]`).toString()));await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Z(i,"add runs to annotation queue",!0),i})}async getRunFromAnnotationQueue(t,a){let r=`/annotation-queues/${ae(t,"queueId")}/run`;return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}${r}/${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(i,"get run from annotation queue"),i})).json()}async deleteRunFromAnnotationQueue(t,a){await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}/runs/${ae(a,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(t){return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ae(t,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(a,"get size from annotation queue"),a})).json()}async _currentTenantIsOwner(t){let a=await this._getSettings();return t=="-"||a.tenant_handle===t}async _ownerConflictError(t,a){let r=await this._getSettings();return new Error(`Cannot ${t} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${a}`)}async _getLatestCommitHash(t){let a=await(await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/commits/${t}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(r,"get latest commit hash"),r})).json();if(a.commits.length!==0)return a.commits[0].commit_hash}async _likeOrUnlikePrompt(t,a){let[r,i,n]=Ya(t),s=JSON.stringify({like:a});return(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/likes/${r}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,`${a?"like":"unlike"} prompt`),o})).json()}async _getPromptUrl(t){let[a,r,i]=Ya(t);if(await this._currentTenantIsOwner(a)){let n=await this._getSettings();return i!=="latest"?`${this.getHostUrl()}/prompts/${r}/${i.substring(0,8)}?organizationId=${n.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${n.id}`}else return i!=="latest"?`${this.getHostUrl()}/hub/${a}/${r}/${i.substring(0,8)}`:`${this.getHostUrl()}/hub/${a}/${r}`}async promptExists(t){return!!await this.getPrompt(t)}async likePrompt(t){return this._likeOrUnlikePrompt(t,!0)}async unlikePrompt(t){return this._likeOrUnlikePrompt(t,!1)}async*listCommits(t){for await(let a of this._getPaginated(`/commits/${t}/`,new URLSearchParams,r=>r.commits))yield*a}async*listPrompts(t){let a=new URLSearchParams;a.append("sort_field",t?.sortField??"updated_at"),a.append("sort_direction","desc"),a.append("is_archived",(!!t?.isArchived).toString()),t?.isPublic!==void 0&&a.append("is_public",t.isPublic.toString()),t?.query&&a.append("query",t.query);for await(let r of this._getPaginated("/repos",a,i=>i.repos))yield*r}async getPrompt(t){let[a,r,i]=Ya(t),n=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/repos/${a}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return s?.status===404?null:(await Z(s,"get prompt"),s)}))?.json();return n?.repo?n.repo:null}async createPrompt(t,a){let r=await this._getSettings();if(a?.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[i,n,s]=Ya(t);if(!await this._currentTenantIsOwner(i))throw await this._ownerConflictError("create a prompt",i);let o={repo_handle:n,...a?.description&&{description:a.description},...a?.readme&&{readme:a.readme},...a?.tags&&{tags:a.tags},is_public:!!a?.isPublic},l=JSON.stringify(o),u=await this.caller.call(async()=>{let d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await Z(d,"create prompt"),d}),{repo:c}=await u.json();return c}async createCommit(t,a,r){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[i,n,s]=Ya(t),o=r?.parentCommitHash==="latest"||!r?.parentCommitHash?await this._getLatestCommitHash(`${i}/${n}`):r?.parentCommitHash,l={manifest:JSON.parse(JSON.stringify(a)),parent_commit:o},u=JSON.stringify(l),c=await(await this.caller.call(async()=>{let d=await this._fetch(`${this.apiUrl}/commits/${i}/${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await Z(d,"create commit"),d})).json();return this._getPromptUrl(`${i}/${n}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updateExamplesMultipart(t,a=[]){return this._updateExamplesMultipart(t,a)}async _updateExamplesMultipart(t,a=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let n of a){let s=n.id,o={...n.metadata&&{metadata:n.metadata},...n.split&&{split:n.split}},l=ft(o,`Serializing body for example with id: ${s}`),u=new Blob([l],{type:"application/json"});if(r.append(s,u),n.inputs){let c=ft(n.inputs,`Serializing inputs for example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.inputs`,d)}if(n.outputs){let c=ft(n.outputs,`Serializing outputs whle updating example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.outputs`,d)}if(n.attachments)for(let[c,d]of Object.entries(n.attachments)){let h,p;Array.isArray(d)?[h,p]=d:(h=d.mimeType,p=d.data);let f=new Blob([p],{type:`${h}; length=${p.byteLength}`});r.append(`${s}.attachment.${c}`,f)}if(n.attachments_operations){let c=ft(n.attachments_operations,`Serializing attachments while updating example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.attachments_operations`,d)}}let i=t??a[0]?.dataset_id;return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${i}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Z(n,"update examples"),n})).json()}async uploadExamplesMultipart(t,a=[]){return this._uploadExamplesMultipart(t,a)}async _uploadExamplesMultipart(t,a=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let i of a){let n=(i.id??Ue()).toString(),s={created_at:i.created_at,...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split},...i.source_run_id&&{source_run_id:i.source_run_id},...i.use_source_run_io&&{use_source_run_io:i.use_source_run_io},...i.use_source_run_attachments&&{use_source_run_attachments:i.use_source_run_attachments}},o=ft(s,`Serializing body for uploaded example with id: ${n}`),l=new Blob([o],{type:"application/json"});if(r.append(n,l),i.inputs){let u=ft(i.inputs,`Serializing inputs for uploaded example with id: ${n}`),c=new Blob([u],{type:"application/json"});r.append(`${n}.inputs`,c)}if(i.outputs){let u=ft(i.outputs,`Serializing outputs for uploaded example with id: ${n}`),c=new Blob([u],{type:"application/json"});r.append(`${n}.outputs`,c)}if(i.attachments)for(let[u,c]of Object.entries(i.attachments)){let d,h;Array.isArray(c)?[d,h]=c:(d=c.mimeType,h=c.data);let p=new Blob([h],{type:`${d}; length=${h.byteLength}`});r.append(`${n}.attachment.${u}`,p)}}return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${t}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await Z(i,"upload examples"),i})).json()}async updatePrompt(t,a){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[r,i]=Ya(t);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let n={};if(a?.description!==void 0&&(n.description=a.description),a?.readme!==void 0&&(n.readme=a.readme),a?.tags!==void 0&&(n.tags=a.tags),a?.isPublic!==void 0&&(n.is_public=a.isPublic),a?.isArchived!==void 0&&(n.is_archived=a.isArchived),Object.keys(n).length===0)throw new Error("No valid update options provided");let s=JSON.stringify(n);return(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/repos/${r}/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await Z(o,"update prompt"),o})).json()}async deletePrompt(t){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[a,r,i]=Ya(t);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("delete a prompt",a);return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/repos/${a}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(n,"delete prompt"),n})).json()}async pullPromptCommit(t,a){let[r,i,n]=Ya(t),s=await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/commits/${r}/${i}/${n}${a?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Z(o,"pull prompt commit"),o})).json();return{owner:r,repo:i,commit_hash:s.commit_hash,manifest:s.manifest,examples:s.examples}}async _pullPrompt(t,a){let r=await this.pullPromptCommit(t,{includeModel:a?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(t,a){return await this.promptExists(t)?a&&Object.keys(a).some(r=>r!=="object")&&await this.updatePrompt(t,{description:a?.description,readme:a?.readme,tags:a?.tags,isPublic:a?.isPublic}):await this.createPrompt(t,{description:a?.description,readme:a?.readme,tags:a?.tags,isPublic:a?.isPublic}),a?.object?await this.createCommit(t,a?.object,{parentCommitHash:a?.parentCommitHash}):await this._getPromptUrl(t)}async clonePublicDataset(t,a={}){let{sourceApiUrl:r=this.apiUrl,datasetName:i}=a,[n,s]=this.parseTokenOrUrl(t,r),o=new dp({apiUrl:n,apiKey:"placeholder"}),l=await o.readSharedDataset(s),u=i||l.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}let c=await o.listSharedExamples(s),d=await this.createDataset(u,{description:l.description,dataType:l.data_type||"kv",inputsSchema:l.inputs_schema_definition??void 0,outputsSchema:l.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map(h=>h.inputs),outputs:c.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),h}}parseTokenOrUrl(t,a,r=2,i="dataset"){try{return ae(t),[a,t]}catch{}try{let n=new URL(t).pathname.split("/").filter(s=>s!=="");if(n.length>=r){let s=n[n.length-r];return[a,s]}else throw new Error(`Invalid public ${i} URL: ${t}`)}catch{throw new Error(`Invalid public ${i} URL or token: ${t}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:t})=>t),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await gk()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}}),Eg,s1=v(()=>{Xa(),Eg=e=>e!==void 0?e:!!["TRACING_V2","TRACING"].find(t=>nt(t)==="true")}),so,o1=v(()=>{so=Symbol.for("lc:context_variables")});function l1(e){return e.replace(/[-:.]/g,"")}function xg(e,t,a=1){let r=a.toFixed(0).slice(0,3).padStart(3,"0"),i=`${new Date(e).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:l1(i)+t,microsecondPrecisionDatestring:i}}function u1(e){return e!=null&&typeof e.createChild=="function"&&typeof e.postRun=="function"}function Pg(e){return typeof e=="object"&&e!=null&&typeof e.name=="string"&&e.name==="langchain_tracer"}function Ag(e){return Array.isArray(e)&&e.some(t=>Pg(t))}function c1(e){return typeof e=="object"&&e!=null&&Array.isArray(e.handlers)}function d1(e){return e!=null&&typeof e.callbacks=="object"&&(Ag(e.callbacks?.handlers)||Ag(e.callbacks))}function h1(e){return e.split(".").map(t=>{let a=t.slice(0,-36),r=t.slice(-36),i=parseInt(a.slice(0,4)),n=parseInt(a.slice(4,6))-1,s=parseInt(a.slice(6,8)),o=parseInt(a.slice(9,11)),l=parseInt(a.slice(11,13)),u=parseInt(a.slice(13,15)),c=parseInt(a.slice(15,21));return[new Date(i,n,s,o,l,u,c/1e3),r]})}function p1(){let e=ua("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{let t=JSON.parse(e);if(Array.isArray(t)){let a=[];for(let r of t){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}a.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return a}else if(typeof t=="object"&&t!==null){m1(t);let a=[];for(let[r,i]of Object.entries(t)){let n=r.replace(/\/$/,"");if(typeof i=="string")a.push({apiUrl:n,apiKey:i});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof i}`);continue}}return a}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof t}`),[]}catch(t){if(e1(t))throw t;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function f1(e){return e?e.map(t=>Array.isArray(t)?{projectName:t[0],updates:t[1]}:t):p1()}function m1(e){if(Object.keys(e).length>0&&nt("ENDPOINT"))throw new lg}var dc,hn,Sg=v(()=>{la(),kg(),s1(),ug(),o1(),Xa(),Nm(),Xa(),ag(),dc=class zw{constructor(t,a,r,i){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=t,this.tags=a,this.project_name=r,this.replicas=i}static fromHeader(t){let a=t.split(","),r={},i=[],n,s;for(let o of a){let[l,u]=o.split("="),c=decodeURIComponent(u);l==="langsmith-metadata"?r=JSON.parse(c):l==="langsmith-tags"?i=c.split(","):l==="langsmith-project"?n=c:l==="langsmith-replicas"&&(s=JSON.parse(c))}return new zw(r,i,n,s)}toHeader(){let t=[];return this.metadata&&Object.keys(this.metadata).length>0&&t.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&t.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&t.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),t.join(",")}},hn=class xa{constructor(t){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),u1(t)){Object.assign(this,{...t});return}let a=xa.getDefaultConfig(),{metadata:r,...i}=t,n=i.client??xa.getSharedClient(),s={...r,...i?.extra?.metadata};if(i.extra={...i.extra,metadata:s},Object.assign(this,{...a,...i,client:n}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=f1(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){let{dottedOrder:o,microsecondPrecisionDatestring:l}=xg(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o,this._serialized_start_time=l}}set metadata(t){this.extra={...this.extra,metadata:{...this.extra?.metadata,...t}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:Ue(),run_type:"chain",project_name:zu(),child_runs:[],api_url:ua("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:ua("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return xa.sharedClient||(xa.sharedClient=new cc),xa.sharedClient}createChild(t){let a=this.child_execution_order+1,r=new xa({...t,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:a,child_execution_order:a});so in this&&(r[so]=this[so]);let i=Symbol.for("lc:child_config"),n=t.extra?.[i]??this.extra[i];if(d1(n)){let l={...n},u=c1(l.callbacks)?l.callbacks.copy?.():void 0;u&&(Object.assign(u,{_parentRunId:r.id}),u.handlers?.find(Pg)?.updateFromRunTree?.(r),l.callbacks=u),r.extra[i]=l}let s=new Set,o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,a),o=o.parent_run;return this.child_runs.push(r),r}async end(t,a,r=Date.now(),i){this.outputs=this.outputs??t,this.error=this.error??a,this.end_time=this.end_time??r,i&&Object.keys(i).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...i}}:{metadata:i})}_convertToCreate(t,a,r=!0){let i=t.extra??{};if(i?.runtime?.library===void 0&&(i.runtime||(i.runtime={}),a))for(let[o,l]of Object.entries(a))i.runtime[o]||(i.runtime[o]=l);let n,s;return r?(s=t.parent_run?.id??t.parent_run_id,n=[]):(n=t.child_runs.map(o=>this._convertToCreate(o,a,r)),s=void 0),{id:t.id,name:t.name,start_time:t._serialized_start_time??t.start_time,end_time:t.end_time,run_type:t.run_type,reference_example_id:t.reference_example_id,extra:i,serialized:t.serialized,error:t.error,inputs:t.inputs,outputs:t.outputs,session_name:t.project_name,child_runs:n,parent_run_id:s,trace_id:t.trace_id,dotted_order:t.dotted_order,tags:t.tags,attachments:t.attachments,events:t.events}}_remapForProject(t,a,r=!0){let i=this._convertToCreate(this,a,r);if(t===this.project_name)return i;let n=c=>qs(`${c}:${t}`,qs.DNS),s=n(i.id),o=i.trace_id?n(i.trace_id):void 0,l=i.parent_run_id?n(i.parent_run_id):void 0,u;if(i.dotted_order){let c=h1(i.dotted_order),d=[];for(let p=0;p<c.length-1;p++){let[f,m]=c[p],g=n(m);d.push(f.toISOString().replace(/[-:]/g,"").replace(".","")+g)}let[h]=c[c.length-1];d.push(h.toISOString().replace(/[-:]/g,"").replace(".","")+s),u=d.join(".")}else u=void 0;return{...i,id:s,trace_id:o,parent_run_id:l,dotted_order:u,session_name:t}}async postRun(t=!0){try{let a=Cm();if(this.replicas&&this.replicas.length>0)for(let{projectName:r,apiKey:i,apiUrl:n,workspaceId:s}of this.replicas){let o=this._remapForProject(r??this.project_name,a,!0);await this.client.createRun(o,{apiKey:i,apiUrl:n,workspaceId:s})}else{let r=this._convertToCreate(this,a,t);await this.client.createRun(r)}if(!t){Xu("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let r of this.child_runs)await r.postRun(!1)}}catch(a){console.error(`Error in postRun for run ${this.id}:`,a)}}async patchRun(t){if(this.replicas&&this.replicas.length>0)for(let{projectName:a,apiKey:r,apiUrl:i,workspaceId:n,updates:s}of this.replicas){let o=this._remapForProject(a??this.project_name),l={id:o.id,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...s};t?.excludeInputs||(l.inputs=o.inputs),await this.client.updateRun(o.id,l,{apiKey:r,apiUrl:i,workspaceId:n})}else try{let a={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};t?.excludeInputs||(a.inputs=this.inputs),await this.client.updateRun(this.id,a)}catch(a){console.error(`Error in patchRun for run ${this.id}`,a)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(t){this.events||(this.events=[]),typeof t=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:t}):this.events.push({...t,time:t.time??new Date().toISOString()})}static fromRunnableConfig(t,a){let r=t?.callbacks,i,n,s,o=Eg();if(r){let l=r?.getParentRunId?.()??"",u=r?.handlers?.find(c=>c?.name=="langchain_tracer");i=u?.getRun?.(l),n=u?.projectName,s=u?.client,o=o||!!u}return i?new xa({name:i.name,id:i.id,trace_id:i.trace_id,dotted_order:i.dotted_order,client:s,tracingEnabled:o,project_name:n,tags:[...new Set((i?.tags??[]).concat(t?.tags??[]))],extra:{metadata:{...i?.extra?.metadata,...t?.metadata}}}).createChild(a):new xa({...a,client:s,tracingEnabled:o,project_name:n})}static fromDottedOrder(t){return this.fromHeaders({"langsmith-trace":t})}static fromHeaders(t,a){let r="get"in t&&typeof t.get=="function"?{"langsmith-trace":t.get("langsmith-trace"),baggage:t.get("baggage")}:t,i=r["langsmith-trace"];if(!i||typeof i!="string")return;let n=i.trim(),s=n.split(".").map(u=>{let[c,d]=u.split("Z");return{strTime:c,time:Date.parse(c+"Z"),uuid:d}}),o=s[0].uuid,l={...a,name:a?.name??"parent",run_type:a?.run_type??"chain",start_time:a?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:n};if(r.baggage&&typeof r.baggage=="string"){let u=dc.fromHeader(r.baggage);l.metadata=u.metadata,l.tags=u.tags,l.project_name=u.project_name,l.replicas=u.replicas}return new xa(l)}toHeaders(t){let a={"langsmith-trace":this.dotted_order,baggage:new dc(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(t)for(let[r,i]of Object.entries(a))t.set(r,i);return a}},Object.defineProperty(hn,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})}),hc=v(()=>{Sg()}),g1=F((e,t)=>{"use strict";t.exports=function(a,r){if(typeof a!="string")throw new TypeError("Expected a string");return r=typeof r>"u"?"_":r,a.replace(/([a-z\d])([A-Z])/g,"$1"+r+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+r+"$2").toLowerCase()}}),y1=F((e,t)=>{"use strict";var a=/[\p{Lu}]/u,r=/[\p{Ll}]/u,i=/^[\p{Lu}](?![\p{Lu}])/gu,n=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,o=new RegExp("^"+s.source),l=new RegExp(s.source+n.source,"gu"),u=new RegExp("\\d+"+n.source,"gu"),c=(f,m,g)=>{let b=!1,y=!1,_=!1;for(let w=0;w<f.length;w++){let O=f[w];b&&a.test(O)?(f=f.slice(0,w)+"-"+f.slice(w),b=!1,_=y,y=!0,w++):y&&_&&r.test(O)?(f=f.slice(0,w-1)+"-"+f.slice(w-1),_=y,y=!1,b=!0):(b=m(O)===O&&g(O)!==O,_=y,y=g(O)===O&&m(O)!==O)}return f},d=(f,m)=>(i.lastIndex=0,f.replace(i,g=>m(g))),h=(f,m)=>(l.lastIndex=0,u.lastIndex=0,f.replace(l,(g,b)=>m(b)).replace(u,g=>m(g))),p=(f,m)=>{if(!(typeof f=="string"||Array.isArray(f)))throw new TypeError("Expected the input to be `string | string[]`");if(m={pascalCase:!1,preserveConsecutiveUppercase:!1,...m},Array.isArray(f)?f=f.map(y=>y.trim()).filter(y=>y.length).join("-"):f=f.trim(),f.length===0)return"";let g=m.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(m.locale),b=m.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(m.locale);return f.length===1?m.pascalCase?b(f):g(f):(f!==g(f)&&(f=c(f,g,b)),f=f.replace(o,""),m.preserveConsecutiveUppercase?f=d(f,g):f=g(f),m.pascalCase&&(f=b(f.charAt(0))+f.slice(1)),h(f,b))};t.exports=p,t.exports.default=p});function b1(e,t){return t?.[e]||(0,jg.default)(e)}function _1(e,t,a){let r={};for(let i in e)Object.hasOwn(e,i)&&(r[t(i,a)]=e[i]);return r}var jg,v1,Ig=v(()=>{jg=Mt(g1(),1),v1=Mt(y1(),1)});function $g(e){return Array.isArray(e)?[...e]:{...e}}function w1(e,t){let a=$g(e);for(let[r,i]of Object.entries(t)){let[n,...s]=r.split(".").reverse(),o=a;for(let l of s.reverse()){if(o[l]===void 0)break;o[l]=$g(o[l]),o=o[l]}o[n]!==void 0&&(o[n]={lc:1,type:"secret",id:[i]})}return a}function Tg(e){let t=Object.getPrototypeOf(e);return typeof e.lc_name=="function"&&(typeof t.lc_name!="function"||e.lc_name()!==t.lc_name())?e.lc_name():e.name}var bi,ca=v(()=>{Ig(),bi=class Bw{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Tg(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(t,...a){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(t||{}).filter(([r])=>this.lc_serializable_keys?.includes(r))):this.lc_kwargs=t??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Bw||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let t={},a={},r=Object.keys(this.lc_kwargs).reduce((i,n)=>(i[n]=n in this?this[n]:this.lc_kwargs[n],i),{});for(let i=Object.getPrototypeOf(this);i;i=Object.getPrototypeOf(i))Object.assign(t,Reflect.get(i,"lc_aliases",this)),Object.assign(a,Reflect.get(i,"lc_secrets",this)),Object.assign(r,Reflect.get(i,"lc_attributes",this));return Object.keys(a).forEach(i=>{let n=this,s=r,[o,...l]=i.split(".").reverse();for(let u of l.reverse()){if(!(u in n)||n[u]===void 0)return;(!(u in s)||s[u]===void 0)&&(typeof n[u]=="object"&&n[u]!=null?s[u]={}:Array.isArray(n[u])&&(s[u]=[])),n=n[u],s=s[u]}o in n&&n[o]!==void 0&&(s[o]=s[o]||n[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:_1(Object.keys(a).length?w1(r,a):r,b1,t)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}});function O1(){return pc===void 0&&(pc={library:"langchain-js",runtime:Mg()}),pc}function We(e){try{return typeof process<"u"?process.env?.[e]:oo()?Deno?.env.get(e):void 0}catch{return}}var Ng,Cg,Rg,oo,Lg,Mg,pc,$a=v(()=>{Ng=()=>typeof window<"u"&&typeof window.document<"u",Cg=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Rg=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),oo=()=>typeof Deno<"u",Lg=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!oo(),Mg=()=>{let e;return Ng()?e="browser":Lg()?e="node":Cg()?e="webworker":Rg()?e="jsdom":oo()?e="deno":e="other",e}});function k1(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}var Ug,pn,Dg,_i=v(()=>{la(),ca(),$a(),Ug=class{},pn=class Zw extends Ug{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Tg(this.constructor)]}constructor(t){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:We("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=t||{},t&&(this.ignoreLLM=t.ignoreLLM??this.ignoreLLM,this.ignoreChain=t.ignoreChain??this.ignoreChain,this.ignoreAgent=t.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=t.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=t.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=t.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(t._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return bi.prototype.toJSON.call(this)}toJSONNotImplemented(){return bi.prototype.toJSONNotImplemented.call(this)}static fromMethods(t){class a extends Zw{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ue()}),Object.assign(this,t)}}return new a}},Dg=e=>{let t=e;return t!==void 0&&typeof t.copy=="function"&&typeof t.name=="string"&&typeof t.awaitHandlers=="boolean"}});function fc(e,t){if(e)return new hn({...e,start_time:e._serialized_start_time??e.start_time,parent_run:fc(t),child_runs:e.child_runs.map(a=>fc(a)).filter(a=>a!==void 0),extra:{...e.extra,runtime:O1()},tracingEnabled:!1})}function mc(e,t){return e&&!Array.isArray(e)&&typeof e=="object"?e:{[t]:e}}function fn(e){return typeof e._addRunToRunMap=="function"}var Fg,vi,da=v(()=>{hc(),_i(),$a(),Fg=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e},vi=class extends pn{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?Fg(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let{dottedOrder:t,microsecondPrecisionDatestring:a}=xg(new Date(e.start_time).getTime(),e.id,e.execution_order),r={...e},i=this.getRunById(r.parent_run_id);if(r.parent_run_id!==void 0?i&&(this._addChildRun(i,r),i.child_execution_order=Math.max(i.child_execution_order,r.child_execution_order),r.trace_id=i.trace_id,i.dotted_order!==void 0&&(r.dotted_order=[i.dotted_order,t].join("."),r._serialized_start_time=a)):(r.trace_id=r.id,r.dotted_order=t,r._serialized_start_time=a),this.usesRunTreeMap){let n=fc(r,i);n!==void 0&&this.runTreeMap.set(r.id,n)}else this.runMap.set(r.id,r);return r}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,a,r,i,n,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,a,r,i,n,s,o){let l=this.getRunById(a)??this._createRunForLLMStart(e,t,a,r,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,a,r,i,n,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,a,r,i,n,s,o){let l=this.getRunById(a)??this._createRunForChatModelStart(e,t,a,r,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t,a,r,i){let n=this.getRunById(t);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMEnd?.(n),await this._endTrace(n),n}async handleLLMError(e,t,a,r,i){let n=this.getRunById(t);if(!n||n?.run_type!=="llm")throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMError?.(n),await this._endTrace(n),n}_createRunForChainStart(e,t,a,r,i,n,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(c)}async handleChainStart(e,t,a,r,i,n,s,o){let l=this.getRunById(a)??this._createRunForChainStart(e,t,a,r,i,n,s,o);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,a,r,i){let n=this.getRunById(t);if(!n)throw new Error("No chain run to end.");return n.end_time=Date.now(),n.outputs=mc(e,"output"),n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),i?.inputs!==void 0&&(n.inputs=mc(i.inputs,"input")),await this.onChainEnd?.(n),await this._endTrace(n),n}async handleChainError(e,t,a,r,i){let n=this.getRunById(t);if(!n)throw new Error("No chain run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),i?.inputs!==void 0&&(n.inputs=mc(i.inputs,"input")),await this.onChainError?.(n),await this._endTrace(n),n}_createRunForToolStart(e,t,a,r,i,n,s){let o=this._getExecutionOrder(r),l=Date.now(),u={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,a,r,i,n,s){let o=this.getRunById(a)??this._createRunForToolStart(e,t,a,r,i,n,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="tool")throw new Error("No tool run to end");return a.end_time=Date.now(),a.outputs={output:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await this.onToolEnd?.(a),await this._endTrace(a),a}async handleToolError(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="tool")throw new Error("No tool run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await this.onToolError?.(a),await this._endTrace(a),a}async handleAgentAction(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="chain")return;let r=a;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(a)}async handleAgentEnd(e,t){let a=this.getRunById(t);!a||a?.run_type!=="chain"||(a.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(a))}_createRunForRetrieverStart(e,t,a,r,i,n,s){let o=this._getExecutionOrder(r),l=Date.now(),u={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,a,r,i,n,s){let o=this.getRunById(a)??this._createRunForRetrieverStart(e,t,a,r,i,n,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="retriever")throw new Error("No retriever run to end");return a.end_time=Date.now(),a.outputs={documents:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await this.onRetrieverEnd?.(a),await this._endTrace(a),a}async handleRetrieverError(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="retriever")throw new Error("No retriever run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await this.onRetrieverError?.(a),await this._endTrace(a),a}async handleText(e,t){let a=this.getRunById(t);!a||a?.run_type!=="chain"||(a.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(a))}async handleLLMNewToken(e,t,a,r,i,n){let s=this.getRunById(a);if(!s||s?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:n?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:n?.chunk}),s}}}),E1=F((e,t)=>{"use strict";var a=(n=0)=>s=>`\x1B[${38+n};5;${s}m`,r=(n=0)=>(s,o,l)=>`\x1B[${38+n};2;${s};${o};${l}m`;function i(){let n=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(let[o,l]of Object.entries(s)){for(let[u,c]of Object.entries(l))s[u]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},l[u]=s[u],n.set(c[0],c[1]);Object.defineProperty(s,o,{value:l,enumerable:!1})}return Object.defineProperty(s,"codes",{value:n,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=a(),s.color.ansi16m=r(),s.bgColor.ansi256=a(10),s.bgColor.ansi16m=r(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,l,u)=>o===l&&l===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(l/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{let l=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!l)return[0,0,0];let{colorString:u}=l.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));let c=Number.parseInt(u,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(t,"exports",{enumerable:!0,get:i})});function et(e,t){return`${e.open}${t}${e.close}`}function It(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function zg(e){return typeof e=="string"?e.trim():e==null?e:It(e,e.toString())}function Qa(e){if(!e.end_time)return"";let t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}var gc,tt,yc,Bg=v(()=>{gc=Mt(E1(),1),da(),{color:tt}=gc.default,yc=class extends vi{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],a=e;for(;a.parent_run_id;){let r=this.runMap.get(a.parent_run_id);if(r)t.push(r),a=r;else break}return t}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((a,r,i)=>{let n=`${a.execution_order}:${a.run_type}:${a.name}`;return r===i.length-1?et(gc.default.bold,n):n}).join(" > ");return et(tt.grey,t)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.green,"[chain/start]")} [${t}] Entering Chain run with input: ${It(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.cyan,"[chain/end]")} [${t}] [${Qa(e)}] Exiting Chain run with output: ${It(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.red,"[chain/error]")} [${t}] [${Qa(e)}] Chain run errored with error: ${It(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),a="prompts"in e.inputs?{prompts:e.inputs.prompts.map(r=>r.trim())}:e.inputs;console.log(`${et(tt.green,"[llm/start]")} [${t}] Entering LLM run with input: ${It(a,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.cyan,"[llm/end]")} [${t}] [${Qa(e)}] Exiting LLM run with output: ${It(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.red,"[llm/error]")} [${t}] [${Qa(e)}] LLM run errored with error: ${It(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.green,"[tool/start]")} [${t}] Entering Tool run with input: "${zg(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.cyan,"[tool/end]")} [${t}] [${Qa(e)}] Exiting Tool run with output: "${zg(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.red,"[tool/error]")} [${t}] [${Qa(e)}] Tool run errored with error: ${It(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${It(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.cyan,"[retriever/end]")} [${t}] [${Qa(e)}] Exiting Retriever run with output: ${It(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${et(tt.red,"[retriever/error]")} [${t}] [${Qa(e)}] Retriever run errored with error: ${It(e.error,"[error]")}`)}onAgentAction(e){let t=e,a=this.getBreadcrumbs(e);console.log(`${et(tt.blue,"[agent/action]")} [${a}] Agent selected action: ${It(t.actions[t.actions.length-1],"[action]")}`)}}});function lo(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}var uo=v(()=>{});function mn(e){return!!(e&&typeof e=="object"&&"type"in e&&e.type==="tool_call")}function x1(e){return!!(e&&typeof e=="object"&&"toolCall"in e&&e.toolCall!=null&&typeof e.toolCall=="object"&&"id"in e.toolCall&&typeof e.toolCall.id=="string")}var co,bc=v(()=>{co=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}});function Zg(e,t=_c){e=e.trim();let a=e.indexOf("```");if(a===-1)return t(e);let r=e.substring(a+3);r.startsWith(`json
`)?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith(`
`)&&(r=r.substring(1));let i=r.indexOf("```"),n=r;return i!==-1&&(n=r.substring(0,i)),t(n.trim())}function _c(e){if(typeof e>"u")return null;try{return JSON.parse(e)}catch{}let t="",a=[],r=!1,i=!1;for(let n of e){if(r)n==='"'&&!i?r=!1:n===`
`&&!i?n="\\n":n==="\\"?i=!i:i=!1;else if(n==='"')r=!0,i=!1;else if(n==="{")a.push("}");else if(n==="[")a.push("]");else if(n==="}"||n==="]")if(a&&a[a.length-1]===n)a.pop();else return null;t+=n}r&&(t+='"');for(let n=a.length-1;n>=0;n-=1)t+=a[n];try{return JSON.parse(t)}catch{return null}}var qg=v(()=>{});function gn(e){return typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"source_type"in e&&(e.source_type==="url"||e.source_type==="base64"||e.source_type==="text"||e.source_type==="id")}function P1(e){return gn(e)&&e.source_type==="url"&&"url"in e&&typeof e.url=="string"}function A1(e){return gn(e)&&e.source_type==="base64"&&"data"in e&&typeof e.data=="string"}function S1(e){if(gn(e)){if(e.source_type==="url")return{type:"image_url",image_url:{url:e.url}};if(e.source_type==="base64"){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}var Vg=v(()=>{});function wi(e,t){return typeof e=="string"?e===""?t:typeof t=="string"?e+t:Array.isArray(t)&&t.some(a=>gn(a))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?ho(e,t)??[...e,...t]:t===""?e:Array.isArray(e)&&e.some(a=>gn(a))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function j1(e,t){return e==="error"||t==="error"?"error":"success"}function I1(e,t){function a(r,i){if(typeof r!="object"||r===null||r===void 0)return r;if(i>=t)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(s=>a(s,i+1));let n={};for(let s of Object.keys(r))n[s]=a(r[s],i+1);return n}return JSON.stringify(a(e,0),null,2)}function at(e,t){let a={...e};for(let[r,i]of Object.entries(t))if(a[r]==null)a[r]=i;else{if(i==null)continue;if(typeof a[r]!=typeof i||Array.isArray(a[r])!==Array.isArray(i))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof a[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?a[r]=i:a[r]+=i}else if(typeof a[r]=="object"&&!Array.isArray(a[r]))a[r]=at(a[r],i);else if(Array.isArray(a[r]))a[r]=ho(a[r],i);else{if(a[r]===i)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return a}function ho(e,t){if(!(e===void 0&&t===void 0)){if(e===void 0||t===void 0)return e||t;{let a=[...e];for(let r of t)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){let i=a.findIndex(n=>{let s=typeof n=="object",o="index"in n&&n.index===r.index,l="id"in n&&"id"in r&&n?.id===r?.id,u=!("id"in n)||!n?.id||!("id"in r)||!r?.id;return s&&o&&(l||u)});i!==-1&&typeof a[i]=="object"&&a[i]!==null?a[i]=at(a[i],r):a.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;a.push(r)}return a}}}function $1(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if(typeof e=="string"&&typeof t=="string")return e+t;if(Array.isArray(e)&&Array.isArray(t))return ho(e,t);if(typeof e=="object"&&typeof t=="object")return at(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}function T1(e){return typeof e.role=="string"}function mt(e){return typeof e?._getType=="function"}function vc(e){return mt(e)&&typeof e.concat=="function"}var Zt,Er,qt=v(()=>{ca(),Vg(),Zt=class extends bi{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=I1(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}},Er=class extends Zt{}});function N1(e){return e!=null&&typeof e=="object"&&"lc_direct_tool_output"in e&&e.lc_direct_tool_output===!0}function C1(e){let t=[],a=[];for(let r of e)if(r.function){let i=r.function.name;try{let n=JSON.parse(r.function.arguments),s={name:i||"",args:n||{},id:r.id};t.push(s)}catch{a.push({name:i,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[t,a]}function R1(e){return e._getType()==="tool"}var po,Wg,yn=v(()=>{qt(),po=class extends Zt{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,a){typeof e=="string"&&(e={content:e,name:a,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Wg=class qw extends Er{constructor(t){super(t),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=t.tool_call_id,this.artifact=t.artifact,this.status=t.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(t){return new qw({content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),artifact:$1(this.artifact,t.artifact),tool_call_id:this.tool_call_id,id:this.id??t.id,status:j1(this.status,t.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}});function fo(e){return e._getType()==="ai"}function Hg(e){return e._getType()==="ai"}var Oi,xr,ki=v(()=>{qg(),qt(),yn(),Oi=class extends Zt{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let a;if(typeof e=="string")a={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{a=e;let r=a.additional_kwargs?.tool_calls,i=a.tool_calls;r!=null&&r.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(r!=null&&i===void 0){let[n,s]=C1(r);a.tool_calls=n??[],a.invalid_tool_calls=s??[]}else a.tool_calls=a.tool_calls??[],a.invalid_tool_calls=a.invalid_tool_calls??[]}catch{a.tool_calls=[],a.invalid_tool_calls=[]}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a!="string"&&(this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=a.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}},xr=class Vw extends Er{constructor(t){let a;if(typeof t=="string")a={content:t,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(t.tool_call_chunks===void 0||t.tool_call_chunks.length===0)a={...t,tool_calls:t.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0};else{let r=(t.tool_call_chunks??[]).reduce((s,o)=>{let l=s.findIndex(([u])=>"id"in o&&o.id&&"index"in o&&o.index!==void 0?o.id===u.id&&o.index===u.index:"id"in o&&o.id?o.id===u.id:"index"in o&&o.index!==void 0?o.index===u.index:!1);return l!==-1?s[l].push(o):s.push([o]),s},[]),i=[],n=[];for(let s of r){let o={},l=s[0]?.name??"",u=s.map(h=>h.args||"").join(""),c=u.length?u:"{}",d=s[0]?.id;try{if(o=_c(c),!d||o===null||typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");i.push({name:l,args:o,id:d,type:"tool_call"})}catch{n.push({name:l,args:c,id:d,error:"Malformed args.",type:"invalid_tool_call"})}}a={...t,tool_calls:i,invalid_tool_calls:n,usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=a.tool_call_chunks??this.tool_call_chunks,this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=a.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(t){let a={content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),tool_call_chunks:[],id:this.id??t.id};if(this.tool_call_chunks!==void 0||t.tool_call_chunks!==void 0){let r=ho(this.tool_call_chunks,t.tool_call_chunks);r!==void 0&&r.length>0&&(a.tool_call_chunks=r)}if(this.usage_metadata!==void 0||t.usage_metadata!==void 0){let r={...(this.usage_metadata?.input_token_details?.audio!==void 0||t.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(t.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||t.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(t.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||t.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(t.usage_metadata?.input_token_details?.cache_creation??0)}},i={...(this.usage_metadata?.output_token_details?.audio!==void 0||t.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(t.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||t.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(t.usage_metadata?.output_token_details?.reasoning??0)}},n=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=t.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:n.input_tokens+s.input_tokens,output_tokens:n.output_tokens+s.output_tokens,total_tokens:n.total_tokens+s.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(i).length>0&&{output_token_details:i}};a.usage_metadata=o}return new Vw(a)}}}),Ei,wc,Oc=v(()=>{qt(),Ei=class Ww extends Zt{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ww}constructor(t,a){typeof t=="string"&&(t={content:t,role:a}),super(t),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t.role}_getType(){return"generic"}static isInstance(t){return t._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},wc=class Hw extends Er{static lc_name(){return"ChatMessageChunk"}constructor(t,a){typeof t=="string"&&(t={content:t,role:a}),super(t),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t.role}_getType(){return"generic"}concat(t){return new Hw({content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),role:this.role,id:this.id??t.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}}),kc,Ec=v(()=>{qt(),kc=class Gw extends Er{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(t){return new Gw({content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),name:this.name??"",id:this.id??t.id})}}}),Pr,xc,mo=v(()=>{qt(),Pr=class extends Zt{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}},xc=class Jw extends Er{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(t,a){super(t,a)}concat(t){return new Jw({content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),id:this.id??t.id})}}}),Gg,Pc=v(()=>{qt(),Gg=class extends Zt{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}}),go,yo,Ac=v(()=>{qt(),go=class extends Zt{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}},yo=class Kw extends Er{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(t,a){super(t,a)}concat(t){return new Kw({content:wi(this.content,t.content),additional_kwargs:at(this.additional_kwargs,t.additional_kwargs),response_metadata:at(this.response_metadata,t.response_metadata),id:this.id??t.id})}}});function L1(e){return mn(e)?e:typeof e.id=="string"&&e.type==="function"&&typeof e.function=="object"&&e.function!==null&&"arguments"in e.function&&typeof e.function.arguments=="string"&&"name"in e.function&&typeof e.function.name=="string"?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function M1(e){return typeof e=="object"&&e!=null&&e.lc===1&&Array.isArray(e.id)&&e.kwargs!=null&&typeof e.kwargs=="object"}function Sc(e){let t,a;if(M1(e)){let r=e.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?t="user":r==="AIMessage"||r==="AIMessageChunk"?t="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?t="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?t="function":r==="ToolMessage"||r==="ToolMessageChunk"?t="tool":t="unknown",a=e.kwargs}else{let{type:r,...i}=e;t=r,a=i}if(t==="human"||t==="user")return new Pr(a);if(t==="ai"||t==="assistant"){let{tool_calls:r,...i}=a;if(!Array.isArray(r))return new Oi(a);let n=r.map(L1);return new Oi({...i,tool_calls:n})}else{if(t==="system")return new go(a);if(t==="developer")return new go({...a,additional_kwargs:{...a.additional_kwargs,__openai_role__:"developer"}});if(t==="tool"&&"tool_call_id"in a)return new po({...a,content:a.content,tool_call_id:a.tool_call_id,name:a.name});if(t==="remove"&&"id"in a&&typeof a.id=="string")return new Gg({...a,id:a.id});throw lo(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function ha(e){if(typeof e=="string")return new Pr(e);if(mt(e))return e;if(Array.isArray(e)){let[t,a]=e;return Sc({type:t,content:a})}else if(T1(e)){let{role:t,...a}=e;return Sc({...a,type:t})}else return Sc(e)}function Jg(e,t="Human",a="AI"){let r=[];for(let i of e){let n;if(i._getType()==="human")n=t;else if(i._getType()==="ai")n=a;else if(i._getType()==="system")n="System";else if(i._getType()==="function")n="Function";else if(i._getType()==="tool")n="Tool";else if(i._getType()==="generic")n=i.role;else throw new Error(`Got unsupported message type: ${i._getType()}`);let s=i.name?`${i.name}, `:"",o=typeof i.content=="string"?i.content:JSON.stringify(i.content,null,2);r.push(`${n}: ${s}${o}`)}return r.join(`
`)}function U1(e){let t=e._getType();if(t==="human")return new xc({...e});if(t==="ai"){let a={...e};return"tool_calls"in a&&(a={...a,tool_call_chunks:a.tool_calls?.map(r=>({...r,type:"tool_call_chunk",index:void 0,args:JSON.stringify(r.args)}))}),new xr({...a})}else{if(t==="system")return new yo({...e});if(t==="function")return new kc({...e});if(Ei.isInstance(e))return new wc({...e});throw new Error("Unknown message type.")}}var er=v(()=>{uo(),bc(),ki(),qt(),Oc(),Ec(),mo(),Pc(),Ac(),yn()}),jc=v(()=>{Zu()}),Ic,Kg,Xg=v(()=>{jc(),$a(),Kg=()=>{if(Ic===void 0){let e=We("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Ic=new cc(e)}return Ic}}),bo,$c=v(()=>{jc(),hc(),Vf(),da(),Xg(),bo=class Xw extends vi{constructor(t={}){super(t),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});let{exampleId:a,projectName:r,client:i,replicas:n}=t;this.projectName=r??zu(),this.replicas=n,this.exampleId=a,this.client=i??Kg();let s=Xw.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(t){}async onRunCreate(t){await this.getRunTreeWithTracingConfig(t.id)?.postRun()}async onRunUpdate(t){await this.getRunTreeWithTracingConfig(t.id)?.patchRun()}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let a=t,r=new Set;for(;a.parent_run&&!(r.has(a.id)||(r.add(a.id),!a.parent_run));)a=a.parent_run;r.clear();let i=[a];for(;i.length>0;){let n=i.shift();!n||r.has(n.id)||(r.add(n.id),this.runTreeMap.set(n.id,n),n.child_runs&&i.push(...n.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){let a=this.runTreeMap.get(t);if(a)return new hn({...a,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return nk(!0)}catch{return}}}}),Tc,bn,Yg,xi,_o=v(()=>{Tc=Symbol.for("ls:tracing_async_local_storage"),bn=Symbol.for("lc:context_variables"),Yg=e=>{globalThis[Tc]=e},xi=()=>globalThis[Tc]});function D1(){let e="default"in vo.default?vo.default.default:vo.default;return new e({autoStart:!0,concurrency:1})}function F1(){return typeof _n>"u"&&(_n=D1()),_n}async function je(e,t){if(t===!0){let a=xi();a!==void 0?await a.run(void 0,async()=>e()):await e()}else _n=F1(),_n.add(async()=>{let a=xi();a!==void 0?await a.run(void 0,async()=>e()):await e()})}var vo,_n,z1=v(()=>{vo=Mt(Ju(),1),_o(),Xg()}),Qg=v(()=>{z1()}),ey,B1=v(()=>{$a(),ey=e=>e!==void 0?e:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>We(t)==="true")});function ty(e){let t=xi();return t===void 0?void 0:t.getStore()?.[bn]?.[e]}var ay,ry,Z1=v(()=>{hc(),_o(),ay=Symbol("lc:configure_hooks"),ry=()=>ty(ay)||[]});function q1(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}function wo(e){return"name"in e?e:pn.fromMethods(e)}var iy,vn,ny,Nc,sy,oy,Vt,Ar=v(()=>{la(),_i(),Bg(),er(),$a(),$c(),Qg(),B1(),da(),Z1(),iy=class{setHandler(e){return this.setHandlers([e])}},vn=class{constructor(e,t,a,r,i,n,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>je(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,a,r,i){await Promise.all(this.handlers.map(n=>je(async()=>{try{await n.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}},ny=class extends vn{getChild(e){let t=new Vt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}},Nc=class extends vn{async handleLLMNewToken(e,t,a,r,i,n){await Promise.all(this.handlers.map(s=>je(async()=>{if(!s.ignoreLLM)try{await s.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,n)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMNewToken: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMError(e,t,a,r,i){await Promise.all(this.handlers.map(n=>je(async()=>{if(!n.ignoreLLM)try{await n.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMError: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleLLMEnd(e,t,a,r,i){await Promise.all(this.handlers.map(n=>je(async()=>{if(!n.ignoreLLM)try{await n.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}},sy=class extends vn{getChild(e){let t=new Vt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,a,r,i){await Promise.all(this.handlers.map(n=>je(async()=>{if(!n.ignoreChain)try{await n.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleChainError: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleChainEnd(e,t,a,r,i){await Promise.all(this.handlers.map(n=>je(async()=>{if(!n.ignoreChain)try{await n.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(s){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleChainEnd: ${s}`),n.raiseError)throw s}},n.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},oy=class extends vn{getChild(e){let t=new Vt(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>je(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Vt=class ws extends iy{constructor(t,a){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=a?.handlers??this.handlers,this.inheritableHandlers=a?.inheritableHandlers??this.inheritableHandlers,this.tags=a?.tags??this.tags,this.inheritableTags=a?.inheritableTags??this.inheritableTags,this.metadata=a?.metadata??this.metadata,this.inheritableMetadata=a?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,a,r=void 0,i=void 0,n=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(a.map(async(u,c)=>{let d=c===0&&r?r:Ue();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return fn(h)&&h._createRunForLLMStart(t,[u],d,this._parentRunId,n,this.tags,this.metadata,l),je(async()=>{try{await h.handleLLMStart?.(t,[u],d,this._parentRunId,n,this.tags,this.metadata,l)}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new Nc(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,a,r=void 0,i=void 0,n=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(a.map(async(u,c)=>{let d=c===0&&r?r:Ue();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return fn(h)&&h._createRunForChatModelStart(t,[u],d,this._parentRunId,n,this.tags,this.metadata,l),je(async()=>{try{if(h.handleChatModelStart)await h.handleChatModelStart?.(t,[u],d,this._parentRunId,n,this.tags,this.metadata,l);else if(h.handleLLMStart){let p=Jg(u);await h.handleLLMStart?.(t,[p],d,this._parentRunId,n,this.tags,this.metadata,l)}}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new Nc(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,a,r=Ue(),i=void 0,n=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreChain)return fn(l)&&l._createRunForChainStart(t,a,r,this._parentRunId,this.tags,this.metadata,i,o),je(async()=>{try{await l.handleChainStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,i,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleChainStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new sy(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,a,r=Ue(),i=void 0,n=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreAgent)return fn(l)&&l._createRunForToolStart(t,a,r,this._parentRunId,this.tags,this.metadata,o),je(async()=>{try{await l.handleToolStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleToolStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new oy(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,a,r=Ue(),i=void 0,n=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreRetriever)return fn(l)&&l._createRunForRetrieverStart(t,a,r,this._parentRunId,this.tags,this.metadata,o),je(async()=>{try{await l.handleRetrieverStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleRetrieverStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new ny(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,a,r,i,n){await Promise.all(this.handlers.map(s=>je(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(t,a,r,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(t,a=!0){this.handlers.push(t),a&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(a=>a!==t),this.inheritableHandlers=this.inheritableHandlers.filter(a=>a!==t)}setHandlers(t,a=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of t)this.addHandler(r,a)}addTags(t,a=!0){this.removeTags(t),this.tags.push(...t),a&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(a=>!t.includes(a)),this.inheritableTags=this.inheritableTags.filter(a=>!t.includes(a))}addMetadata(t,a=!0){this.metadata={...this.metadata,...t},a&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(let a of Object.keys(t))delete this.metadata[a],delete this.inheritableMetadata[a]}copy(t=[],a=!0){let r=new ws(this._parentRunId);for(let i of this.handlers){let n=this.inheritableHandlers.includes(i);r.addHandler(i,n)}for(let i of this.tags){let n=this.inheritableTags.includes(i);r.addTags([i],n)}for(let i of Object.keys(this.metadata)){let n=Object.keys(this.inheritableMetadata).includes(i);r.addMetadata({[i]:this.metadata[i]},n)}for(let i of t)r.handlers.filter(n=>n.name==="console_callback_handler").some(n=>n.name===i.name)||r.addHandler(i,a);return r}static fromHandlers(t){class a extends pn{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ue()}),Object.assign(this,t)}}let r=new this;return r.addHandler(new a),r}static configure(t,a,r,i,n,s,o){return this._configureSync(t,a,r,i,n,s,o)}static _configureSync(t,a,r,i,n,s,o){let l;(t||a)&&(Array.isArray(t)||!t?(l=new ws,l.setHandlers(t?.map(wo)??[],!0)):l=t,l=l.copy(Array.isArray(a)?a.map(wo):a?.handlers,!1));let u=We("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=bo.getTraceableRunTree()?.tracingEnabled||ey(),d=c||(We("LANGCHAIN_TRACING")??!1);if(u||d){if(l||(l=new ws),u&&!l.handlers.some(h=>h.name===yc.prototype.name)){let h=new yc;l.addHandler(h,!0)}if(d&&!l.handlers.some(h=>h.name==="langchain_tracer")&&c){let h=new bo;l.addHandler(h,!0)}if(c){let h=bo.getTraceableRunTree();h&&l._parentRunId===void 0&&(l._parentRunId=h.id,l.handlers.find(p=>p.name==="langchain_tracer")?.updateFromRunTree(h))}}for(let{contextVar:h,inheritable:p=!0,handlerClass:f,envVar:m}of ry()){let g=m&&We(m)==="true"&&f,b,y=h!==void 0?ty(h):void 0;y&&Dg(y)?b=y:g&&(b=new f({})),b!==void 0&&(l||(l=new ws),l.handlers.some(_=>_.name===b.name)||l.addHandler(b,p))}return(r||i)&&l&&(l.addTags(r??[]),l.addTags(i??[],!1)),(n||s)&&l&&(l.addMetadata(n??{}),l.addMetadata(s??{},!1)),l}}}),ly,uy,Cc,cy,gt,V1=v(()=>{jc(),_o(),Ar(),ly=class{getStore(){}run(e,t){return t()}enterWith(e){}},uy=new ly,Cc=Symbol.for("lc:child_config"),cy=class{getInstance(){return xi()??uy}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[Cc]}runWithConfig(e,t,a){let r=Vt._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),n=i.getStore(),s=r?.getParentRunId(),o=r?.handlers?.find(u=>u?.name==="langchain_tracer"),l;return o&&s?l=o.getRunTreeWithTracingConfig(s):a||(l=new hn({name:"<runnable_lambda>",tracingEnabled:!1})),l&&(l.extra={...l.extra,[Cc]:e}),n!==void 0&&n[bn]!==void 0&&(l===void 0&&(l={}),l[bn]=n[bn]),i.run(l,t)}initializeGlobalInstance(e){xi()===void 0&&Yg(e)}},gt=new cy}),Pi=v(()=>{V1(),_o()});async function $t(e){return Vt._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Wt(...e){let t={};for(let a of e.filter(r=>!!r))for(let r of Object.keys(a))if(r==="metadata")t[r]={...t[r],...a[r]};else if(r==="tags"){let i=t[r]??[];t[r]=[...new Set(i.concat(a[r]??[]))]}else if(r==="configurable")t[r]={...t[r],...a[r]};else if(r==="timeout")t.timeout===void 0?t.timeout=a.timeout:a.timeout!==void 0&&(t.timeout=Math.min(t.timeout,a.timeout));else if(r==="signal")t.signal===void 0?t.signal=a.signal:a.signal!==void 0&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,a.signal]):t.signal=a.signal);else if(r==="callbacks"){let i=t.callbacks,n=a.callbacks;if(Array.isArray(n))if(!i)t.callbacks=n;else if(Array.isArray(i))t.callbacks=i.concat(n);else{let s=i.copy();for(let o of n)s.addHandler(wo(o),!0);t.callbacks=s}else if(n)if(!i)t.callbacks=n;else if(Array.isArray(i)){let s=n.copy();for(let o of i)s.addHandler(wo(o),!0);t.callbacks=s}else t.callbacks=new Vt(n._parentRunId,{handlers:i.handlers.concat(n.handlers),inheritableHandlers:i.inheritableHandlers.concat(n.inheritableHandlers),tags:Array.from(new Set(i.tags.concat(n.tags))),inheritableTags:Array.from(new Set(i.inheritableTags.concat(n.inheritableTags))),metadata:{...i.metadata,...n.metadata}})}else{let i=r;t[i]=a[i]??t[i]}return t}function pe(e){let t=gt.getRunnableConfig(),a={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){let{runId:r,runName:i,...n}=t;a=Object.entries(n).reduce((s,[o,l])=>(l!==void 0&&(s[o]=l),s),a)}if(e&&(a=Object.entries(e).reduce((r,[i,n])=>(n!==void 0&&(r[i]=n),r),a)),a?.configurable)for(let r of Object.keys(a.configurable))dy.has(typeof a.configurable[r])&&!a.metadata?.[r]&&(a.metadata||(a.metadata={}),a.metadata[r]=a.configurable[r]);if(a.timeout!==void 0){if(a.timeout<=0)throw new Error("Timeout must be a positive number");let r=AbortSignal.timeout(a.timeout);a.signal!==void 0?"any"in AbortSignal&&(a.signal=AbortSignal.any([a.signal,r])):a.signal=r,delete a.timeout}return a}function Pe(e={},{callbacks:t,maxConcurrency:a,recursionLimit:r,runName:i,configurable:n,runId:s}={}){let o=pe(e);return t!==void 0&&(delete o.runName,o.callbacks=t),r!==void 0&&(o.recursionLimit=r),a!==void 0&&(o.maxConcurrency=a),i!==void 0&&(o.runName=i),n!==void 0&&(o.configurable={...o.configurable,...n}),s!==void 0&&delete o.runId,o}function Ai(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}var Oo,dy,Ta=v(()=>{Ar(),Pi(),Oo=25,dy=new Set(["string","number","boolean"])});async function tr(e,t){if(t===void 0)return e;let a;return Promise.race([e.catch(r=>{if(!t?.aborted)throw r}),new Promise((r,i)=>{a=()=>{i(new Error("Aborted"))},t.addEventListener("abort",a),t.aborted&&i(new Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",a))}var hy=v(()=>{});function py(e,t=2){let a=Array.from({length:t},()=>[]);return a.map(async function*(r){for(;;)if(r.length===0){let i=await e.next();for(let n of a)n.push(i)}else{if(r[0].done)return;yield r.shift().value}})}function ko(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if(typeof e=="string"&&typeof t=="string"||typeof e=="number"&&typeof t=="number")return e+t;if("concat"in e&&typeof e.concat=="function")return e.concat(t);if(typeof e=="object"&&typeof t=="object"){let a={...e};for(let[r,i]of Object.entries(t))r in a&&!Array.isArray(a[r])?a[r]=ko(a[r],i):a[r]=i;return a}else throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}async function W1(e,t,a,r,...i){let n=new Sr({generator:t,startSetup:a,signal:r}),s=await n.setup;return{output:e(n,s,...i),setup:s}}var yt,Sr,pa=v(()=>{Ta(),Pi(),hy(),yt=class hp extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){let a=this.reader.cancel();this.reader.releaseLock(),await a}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){let a=t.getReader();return new hp({start(r){return i();function i(){return a.read().then(({done:n,value:s})=>{if(n){r.close();return}return r.enqueue(s),i()})}},cancel(){a.releaseLock()}})}static fromAsyncGenerator(t){return new hp({async pull(a){let{value:r,done:i}=await t.next();i&&a.close(),a.enqueue(r)},async cancel(a){await t.return(a)}})}},Sr=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,a)=>{gt.runWithConfig(Ai(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,a):this.firstResult.then(r=>t(void 0),a)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?gt.runWithConfig(Ai(this.config),this.signal?async()=>tr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}});async function fy(e,t){if(t==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:a}=e;if(["retriever","llm","prompt"].includes(e.run_type))return a;if(!(Object.keys(a).length===1&&a?.input===""))return a.input}async function my(e,t){let{outputs:a}=e;return t==="original"||["retriever","llm","prompt"].includes(e.run_type)?a:a!==void 0&&Object.keys(a).length===1&&a?.output!==void 0?a.output:a}function H1(e){return e!==void 0&&e.message!==void 0}var Na,Rc,gy,Lc,yy=v(()=>{em(),da(),pa(),ki(),Na=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),a=ln({},t);return new Rc({ops:t,state:a[a.length-1].newDocument})}},Rc=class pp extends Na{constructor(t){super(t),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=t.state}concat(t){let a=this.ops.concat(t.ops),r=ln(this.state,t.ops);return new pp({ops:a,state:r[r.length-1].newDocument})}static fromRunLogPatch(t){let a=ln({},t.ops);return new pp({ops:t.ops,state:a[a.length-1].newDocument})}},gy=e=>e.name==="log_stream_tracer",Lc=class extends vi{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=yt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],a=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(a=a||t.find(r=>this.includeTags?.includes(r))!==void 0),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(a=a&&t.every(r=>!this.excludeTags?.includes(r))),a}async*tapOutputIterable(e,t){for await(let a of t){if(e!==this.rootId){let r=this.keyMapByRunId[e];r&&await this.writer.write(new Na({ops:[{op:"add",path:`/logs/${r}/streamed_output/-`,value:a}]}))}yield a}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Na({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let a={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(a.inputs=await fy(e,this._schemaFormat)),await this.writer.write(new Na({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:a}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let a=[];this._schemaFormat==="streaming_events"&&a.push({op:"replace",path:`/logs/${t}/inputs`,value:await fy(e,this._schemaFormat)}),a.push({op:"add",path:`/logs/${t}/final_output`,value:await my(e,this._schemaFormat)}),e.end_time!==void 0&&a.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let r=new Na({ops:a});await this.writer.write(r)}finally{if(e.id===this.rootId){let t=new Na({ops:[{op:"replace",path:"/final_output",value:await my(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,a){let r=this.keyMapByRunId[e.id];if(r===void 0)return;let i=e.inputs.messages!==void 0,n;i?H1(a?.chunk)?n=a?.chunk:n=new xr({id:`run-${e.id}`,content:t}):n=t;let s=new Na({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:n}]});await this.writer.write(s)}}}),Mc,wn,On,jr=v(()=>{Mc="__run",wn=class Yw{constructor(t){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=t.text,this.generationInfo=t.generationInfo}concat(t){return new Yw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo}})}},On=class Qw extends wn{constructor(t){super(t),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=t.message}concat(t){return new Qw({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}}});function Eo({name:e,serialized:t}){return e!==void 0?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}var by,_y,G1=v(()=>{da(),pa(),ki(),jr(),by=e=>e.name==="event_stream_tracer",_y=class extends vi{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=yt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],a=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(a=a||t.find(r=>this.includeTags?.includes(r))!==void 0),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(a=a&&t.every(r=>!this.excludeTags?.includes(r))),a}async*tapOutputIterable(e,t){let a=await t.next();if(a.done)return;let r=this.runInfoMap.get(e);if(r===void 0){yield a.value;return}function i(s,o){return s==="llm"&&typeof o=="string"?new wn({text:o}):o}let n=this.tappedPromises.get(e);if(n===void 0){let s;n=new Promise(o=>{s=o}),this.tappedPromises.set(e,n);try{let o={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...o,data:{chunk:i(r.runType,a.value)}},r),yield a.value;for await(let l of t)r.runType!=="tool"&&r.runType!=="retriever"&&await this.send({...o,data:{chunk:i(r.runType,l)}},r),yield l}finally{s()}}else{yield a.value;for await(let s of t)yield s}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let a=this.tappedPromises.get(e.run_id);a!==void 0?a.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Eo(e),a=e.inputs.messages!==void 0?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:a,inputs:e.inputs};this.runInfoMap.set(e.id,r);let i=`on_${a}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,a){let r=this.runInfoMap.get(e.id),i,n;if(r===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(r.runType==="chat_model")n="on_chat_model_stream",a?.chunk===void 0?i=new xr({content:t,id:`run-${e.id}`}):i=a.chunk.message;else if(r.runType==="llm")n="on_llm_stream",a?.chunk===void 0?i=new wn({text:t}):i=a.chunk;else throw new Error(`Unexpected run type ${r.runType}`);await this.send({event:n,data:{chunk:i},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let a;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let r=e.outputs?.generations,i;if(t.runType==="chat_model"){for(let n of r??[]){if(i!==void 0)break;i=n[0]?.message}a="on_chat_model_end"}else if(t.runType==="llm")i={generations:r?.map(n=>n.map(s=>({text:s.text,generationInfo:s.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},a="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:a,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Eo(e),a=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},r.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,r.inputs=e.inputs.input):(i.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${a}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let a=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:r};r.input&&Object.keys(r).length===1&&(i.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:a,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Eo(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,a),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},a)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let a=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Eo(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,a){let r=this.runInfoMap.get(a);if(r===void 0)throw new Error(`handleCustomEvent: Run ID ${a} not found in run map.`);await this.send({event:"on_custom_event",run_id:a,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}}),vy,xo,wy,Oy,Po,kn=v(()=>{vy=Mt(ku(),1),xo=Mt(Ju(),1),wy=[400,401,402,403,404,405,406,407,409],Oy=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||e.name==="AbortError"||e?.code==="ECONNABORTED")throw e;let t=e?.response?.status??e?.status;if(t&&wy.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){let a=new Error(e?.message);throw a.name="InsufficientQuotaError",a}},Po=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Oy;let t="default"in xo.default?xo.default.default:xo.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,vy.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise((r,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...a)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}}),Uc,J1=v(()=>{da(),Uc=class extends vi{constructor({config:e,onStart:t,onEnd:a,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=a,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}});function Dc(e){return e?e.lc_runnable:!1}var ky,Ey=v(()=>{ky=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let a=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,r=e.tags??[];return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(t)),this.includeTags!==void 0&&(a=a||r.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(a=a&&r.every(i=>!this.excludeTags?.includes(i))),a}}});function Fc(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}function K1(e){let t="";for(let[a,r]of Object.entries(e))t+=`	classDef ${a} ${r};
`;return t}function X1(e,t,a){let{firstNode:r,lastNode:i,nodeColors:n,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=a??{},u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){let p="default",f={[p]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),i!==void 0&&(f[i]="{0}([{1}]):::last");for(let[m,g]of Object.entries(e)){let b=g.name.split(":").pop()??"",y=xy.some(w=>b.startsWith(w)&&b.endsWith(w))?`<p>${b}</p>`:b;Object.keys(g.metadata??{}).length&&(y+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([w,O])=>`${w} = ${O}`).join(`
`)}</em></small>`);let _=(f[m]??f[p]).replace("{0}",Fc(m)).replace("{1}",y);u+=`	${_}
`}}let c={};for(let p of t){let f=p.source.split(":"),m=p.target.split(":"),g=f.filter((b,y)=>b===m[y]).join(":");c[g]||(c[g]=[]),c[g].push(p)}let d=new Set;function h(p,f){let m=p.length===1&&p[0].source===p[0].target;if(f&&!m){let g=f.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),u+=`	subgraph ${g}
`}for(let g of p){let{source:b,target:y,data:_,conditional:w}=g,O="";if(_!==void 0){let j=_,S=j.split(" ");S.length>l&&(j=Array.from({length:Math.ceil(S.length/l)},(E,A)=>S.slice(A*l,(A+1)*l).join(" ")).join("&nbsp;<br>&nbsp;")),O=w?` -. &nbsp;${j}&nbsp; .-> `:` -- &nbsp;${j}&nbsp; --> `}else O=w?" -.-> ":" --> ";u+=`	${Fc(b)}${O}${Fc(y)};
`}for(let g in c)g.startsWith(`${f}:`)&&g!==f&&h(c[g],g);f&&!m&&(u+=`	end
`)}h(c[""]??[],"");for(let p in c)!p.includes(":")&&p!==""&&h(c[p],p);return s&&(u+=K1(n??{})),u}async function Y1(e,t){return Q1(e,{...t,imageType:"png"})}async function Q1(e,t){let a=t?.backgroundColor??"white",r=t?.imageType??"png",i=btoa(e);a!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(a)||(a=`!${a}`));let n=`https://mermaid.ink/img/${i}?bgColor=${a}&type=${r}`,s=await fetch(n);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}var xy,eE=v(()=>{xy=["*","_","`"]});function Ao(e,t,a){function r(o,l){var u;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(u=o._zod).traits??(u.traits=new Set),o._zod.traits.add(e),t(o,l);for(let c in s.prototype)c in o||Object.defineProperty(o,c,{value:s.prototype[c].bind(o)});o._zod.constr=s,o._zod.def=l}let i=a?.Parent??Object;class n extends i{}Object.defineProperty(n,"name",{value:e});function s(o){var l;let u=a?.Parent?new n:this;r(u,o),(l=u._zod).deferred??(l.deferred=[]);for(let c of u._zod.deferred)c();return u}return Object.defineProperty(s,"init",{value:r}),Object.defineProperty(s,Symbol.hasInstance,{value:o=>a?.Parent&&o instanceof a.Parent?!0:o?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}function So(e){return e&&Object.assign(zc,e),zc}var tE,aE,En,zc,jo=v(()=>{tE=Object.freeze({status:"aborted"}),aE=Symbol("zod_brand"),En=class extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},zc={}});function rE(e){let t=Object.values(e).filter(a=>typeof a=="number");return Object.entries(e).filter(([a,r])=>t.indexOf(+a)===-1).map(([a,r])=>r)}function iE(e,t){return typeof t=="bigint"?t.toString():t}function nE(e){return{get value(){{let t=e();return Object.defineProperty(this,"value",{value:t}),t}throw new Error("cached value already set")}}}function Io(e,t,a){let r=new e._zod.constr(t??e._zod.def);return(!t||a?.parent)&&(r._zod.parent=e),r}function sE(e){let t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function Bc(e,t=0){for(let a=t;a<e.issues.length;a++)if(e.issues[a]?.continue!==!0)return!0;return!1}function $o(e){return typeof e=="string"?e:e?.message}function To(e,t,a){let r={...e,path:e.path??[]};if(!e.message){let i=$o(e.inst?._zod.def?.error?.(e))??$o(t?.error?.(e))??$o(a.customError?.(e))??$o(a.localeError?.(e))??"Invalid input";r.message=i}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}var Zc,oE,lE,Ir=v(()=>{Zc=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{},oE=nE(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{let e=Function;return new e(""),!0}catch{return!1}}),lE={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]}}),qc,Py,xn,Ay=v(()=>{jo(),Ir(),qc=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get(){return JSON.stringify(t,iE,2)},enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},Py=Ao("$ZodError",qc),xn=Ao("$ZodError",qc,{Parent:Error})}),Sy,jy,Iy,$y,Ty,Ny,Cy,Ry,Ly=v(()=>{jo(),Ay(),Ir(),Sy=e=>(t,a,r,i)=>{let n=r?Object.assign(r,{async:!1}):{async:!1},s=t._zod.run({value:a,issues:[]},n);if(s instanceof Promise)throw new En;if(s.issues.length){let o=new(i?.Err??e)(s.issues.map(l=>To(l,n,So())));throw Zc(o,i?.callee),o}return s.value},jy=Sy(xn),Iy=e=>async(t,a,r,i)=>{let n=r?Object.assign(r,{async:!0}):{async:!0},s=t._zod.run({value:a,issues:[]},n);if(s instanceof Promise&&(s=await s),s.issues.length){let o=new(i?.Err??e)(s.issues.map(l=>To(l,n,So())));throw Zc(o,i?.callee),o}return s.value},$y=Iy(xn),Ty=e=>(t,a,r)=>{let i=r?{...r,async:!1}:{async:!1},n=t._zod.run({value:a,issues:[]},i);if(n instanceof Promise)throw new En;return n.issues.length?{success:!1,error:new(e??Py)(n.issues.map(s=>To(s,i,So())))}:{success:!0,data:n.value}},Ny=Ty(xn),Cy=e=>async(t,a,r)=>{let i=r?Object.assign(r,{async:!0}):{async:!0},n=t._zod.run({value:a,issues:[]},i);return n instanceof Promise&&(n=await n),n.issues.length?{success:!1,error:new e(n.issues.map(s=>To(s,i,So())))}:{success:!0,data:n.value}},Ry=Cy(xn)}),My,uE,cE=v(()=>{My="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",uE=new RegExp(`^${My}$`)}),dE=v(()=>{}),hE=v(()=>{}),Uy,Dy=v(()=>{Uy={major:4,minor:0,patch:0}}),Fy,zy,pE=v(()=>{jo(),Ly(),Ir(),Dy(),Ir(),Fy=Ao("$ZodType",(e,t)=>{var a;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Uy;let r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(let i of r)for(let n of i._zod.onattach)n(e);if(r.length===0)(a=e._zod).deferred??(a.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{let i=(n,s,o)=>{let l=Bc(n),u;for(let c of s){if(c._zod.def.when){if(!c._zod.def.when(n))continue}else if(l)continue;let d=n.issues.length,h=c._zod.check(n);if(h instanceof Promise&&o?.async===!1)throw new En;if(u||h instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await h,n.issues.length!==d&&(l||(l=Bc(n,d)))});else{if(n.issues.length===d)continue;l||(l=Bc(n,d))}}return u?u.then(()=>n):n};e._zod.run=(n,s)=>{let o=e._zod.parse(n,s);if(o instanceof Promise){if(s.async===!1)throw new En;return o.then(l=>i(l,r,s))}return i(o,r,s)}}e["~standard"]={validate:i=>{try{let n=Ny(e,i);return n.success?{value:n.data}:{issues:n.error?.issues}}catch{return Ry(e,i).then(n=>n.success?{value:n.data}:{issues:n.error?.issues})}},vendor:"zod",version:1}}),zy=Ao("$ZodNever",(e,t)=>{Fy.init(e,t),e._zod.parse=(a,r)=>(a.issues.push({expected:"never",code:"invalid_type",input:a.value,inst:e}),a)})}),fE=v(()=>{});function mE(){return new Vc}var gE,yE,Vc,Ca,By=v(()=>{gE=Symbol("ZodOutput"),yE=Symbol("ZodInput"),Vc=class{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){let a=t[0];if(this._map.set(e,a),a&&typeof a=="object"&&"id"in a){if(this._idmap.has(a.id))throw new Error(`ID ${a.id} already exists in the registry`);this._idmap.set(a.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let a={...this.get(t)??{}};return delete a.id,{...a,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}},Ca=mE()});function bE(e,t){return new e({type:"never",...sE(t)})}var _E=v(()=>{Ir()}),vE=v(()=>{});function Zy(e,t){if(e instanceof Vc){let r=new Wc(t),i={};for(let o of e._idmap.entries()){let[l,u]=o;r.process(u)}let n={},s={registry:e,uri:t?.uri,defs:i};for(let o of e._idmap.entries()){let[l,u]=o;n[l]=r.emit(u,{...t,external:s})}if(Object.keys(i).length>0){let o=r.target==="draft-2020-12"?"$defs":"definitions";n.__shared={[o]:i}}return{schemas:n}}let a=new Wc(t);return a.process(e),a.emit(e,t)}function Ie(e,t){let a=t??{seen:new Set};if(a.seen.has(e))return!1;a.seen.add(e);let r=e._zod.def;switch(r.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Ie(r.element,a);case"object":{for(let i in r.shape)if(Ie(r.shape[i],a))return!0;return!1}case"union":{for(let i of r.options)if(Ie(i,a))return!0;return!1}case"intersection":return Ie(r.left,a)||Ie(r.right,a);case"tuple":{for(let i of r.items)if(Ie(i,a))return!0;return!!(r.rest&&Ie(r.rest,a))}case"record":return Ie(r.keyType,a)||Ie(r.valueType,a);case"map":return Ie(r.keyType,a)||Ie(r.valueType,a);case"set":return Ie(r.valueType,a);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Ie(r.innerType,a);case"lazy":return Ie(r.getter(),a);case"default":return Ie(r.innerType,a);case"prefault":return Ie(r.innerType,a);case"custom":return!1;case"transform":return!0;case"pipe":return Ie(r.in,a)||Ie(r.out,a);case"success":return!1;case"catch":return!1;default:}throw new Error(`Unknown schema type: ${r.type}`)}var Wc,wE=v(()=>{By(),Ir(),Wc=class{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??Ca,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var a;let r=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},n=this.seen.get(e);if(n)return n.count++,t.schemaPath.includes(e)&&(n.cycle=t.path),n.schema;let s={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,s);let o=e._zod.toJSONSchema?.();if(o)s.schema=o;else{let u={...t,schemaPath:[...t.schemaPath,e],path:t.path},c=e._zod.parent;if(c)s.ref=c,this.process(c,u),this.seen.get(c).isParent=!0;else{let d=s.schema;switch(r.type){case"string":{let h=d;h.type="string";let{minimum:p,maximum:f,format:m,patterns:g,contentEncoding:b}=e._zod.bag;if(typeof p=="number"&&(h.minLength=p),typeof f=="number"&&(h.maxLength=f),m&&(h.format=i[m]??m,h.format===""&&delete h.format),b&&(h.contentEncoding=b),g&&g.size>0){let y=[...g];y.length===1?h.pattern=y[0].source:y.length>1&&(s.schema.allOf=[...y.map(_=>({...this.target==="draft-7"?{type:"string"}:{},pattern:_.source}))])}break}case"number":{let h=d,{minimum:p,maximum:f,format:m,multipleOf:g,exclusiveMaximum:b,exclusiveMinimum:y}=e._zod.bag;typeof m=="string"&&m.includes("int")?h.type="integer":h.type="number",typeof y=="number"&&(h.exclusiveMinimum=y),typeof p=="number"&&(h.minimum=p,typeof y=="number"&&(y>=p?delete h.minimum:delete h.exclusiveMinimum)),typeof b=="number"&&(h.exclusiveMaximum=b),typeof f=="number"&&(h.maximum=f,typeof b=="number"&&(b<=f?delete h.maximum:delete h.exclusiveMaximum)),typeof g=="number"&&(h.multipleOf=g);break}case"boolean":{let h=d;h.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{d.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{d.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{let h=d,{minimum:p,maximum:f}=e._zod.bag;typeof p=="number"&&(h.minItems=p),typeof f=="number"&&(h.maxItems=f),h.type="array",h.items=this.process(r.element,{...u,path:[...u.path,"items"]});break}case"object":{let h=d;h.type="object",h.properties={};let p=r.shape;for(let g in p)h.properties[g]=this.process(p[g],{...u,path:[...u.path,"properties",g]});let f=new Set(Object.keys(p)),m=new Set([...f].filter(g=>{let b=r.shape[g]._zod;return this.io==="input"?b.optin===void 0:b.optout===void 0}));m.size>0&&(h.required=Array.from(m)),r.catchall?._zod.def.type==="never"?h.additionalProperties=!1:r.catchall?r.catchall&&(h.additionalProperties=this.process(r.catchall,{...u,path:[...u.path,"additionalProperties"]})):this.io==="output"&&(h.additionalProperties=!1);break}case"union":{let h=d;h.anyOf=r.options.map((p,f)=>this.process(p,{...u,path:[...u.path,"anyOf",f]}));break}case"intersection":{let h=d,p=this.process(r.left,{...u,path:[...u.path,"allOf",0]}),f=this.process(r.right,{...u,path:[...u.path,"allOf",1]}),m=b=>"allOf"in b&&Object.keys(b).length===1,g=[...m(p)?p.allOf:[p],...m(f)?f.allOf:[f]];h.allOf=g;break}case"tuple":{let h=d;h.type="array";let p=r.items.map((g,b)=>this.process(g,{...u,path:[...u.path,"prefixItems",b]}));if(this.target==="draft-2020-12"?h.prefixItems=p:h.items=p,r.rest){let g=this.process(r.rest,{...u,path:[...u.path,"items"]});this.target==="draft-2020-12"?h.items=g:h.additionalItems=g}r.rest&&(h.items=this.process(r.rest,{...u,path:[...u.path,"items"]}));let{minimum:f,maximum:m}=e._zod.bag;typeof f=="number"&&(h.minItems=f),typeof m=="number"&&(h.maxItems=m);break}case"record":{let h=d;h.type="object",h.propertyNames=this.process(r.keyType,{...u,path:[...u.path,"propertyNames"]}),h.additionalProperties=this.process(r.valueType,{...u,path:[...u.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{let h=d,p=rE(r.entries);p.every(f=>typeof f=="number")&&(h.type="number"),p.every(f=>typeof f=="string")&&(h.type="string"),h.enum=p;break}case"literal":{let h=d,p=[];for(let f of r.values)if(f===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof f=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");p.push(Number(f))}else p.push(f);if(p.length!==0)if(p.length===1){let f=p[0];h.type=f===null?"null":typeof f,h.const=f}else p.every(f=>typeof f=="number")&&(h.type="number"),p.every(f=>typeof f=="string")&&(h.type="string"),p.every(f=>typeof f=="boolean")&&(h.type="string"),p.every(f=>f===null)&&(h.type="null"),h.enum=p;break}case"file":{let h=d,p={type:"string",format:"binary",contentEncoding:"binary"},{minimum:f,maximum:m,mime:g}=e._zod.bag;f!==void 0&&(p.minLength=f),m!==void 0&&(p.maxLength=m),g?g.length===1?(p.contentMediaType=g[0],Object.assign(h,p)):h.anyOf=g.map(b=>({...p,contentMediaType:b})):Object.assign(h,p);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{let h=this.process(r.innerType,u);d.anyOf=[h,{type:"null"}];break}case"nonoptional":{this.process(r.innerType,u),s.ref=r.innerType;break}case"success":{let h=d;h.type="boolean";break}case"default":{this.process(r.innerType,u),s.ref=r.innerType,d.default=JSON.parse(JSON.stringify(r.defaultValue));break}case"prefault":{this.process(r.innerType,u),s.ref=r.innerType,this.io==="input"&&(d._prefault=JSON.parse(JSON.stringify(r.defaultValue)));break}case"catch":{this.process(r.innerType,u),s.ref=r.innerType;let h;try{h=r.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}d.default=h;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{let h=d,p=e._zod.pattern;if(!p)throw new Error("Pattern not found in template literal");h.type="string",h.pattern=p.source;break}case"pipe":{let h=this.io==="input"?r.in._zod.def.type==="transform"?r.out:r.in:r.out;this.process(h,u),s.ref=h;break}case"readonly":{this.process(r.innerType,u),s.ref=r.innerType,d.readOnly=!0;break}case"promise":{this.process(r.innerType,u),s.ref=r.innerType;break}case"optional":{this.process(r.innerType,u),s.ref=r.innerType;break}case"lazy":{let h=e._zod.innerType;this.process(h,u),s.ref=h;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}default:}}}let l=this.metadataRegistry.get(e);return l&&Object.assign(s.schema,l),this.io==="input"&&Ie(e)&&(delete s.schema.examples,delete s.schema.default),this.io==="input"&&s.schema._prefault&&((a=s.schema).default??(a.default=s.schema._prefault)),delete s.schema._prefault,this.seen.get(e).schema}emit(e,t){let a={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},r=this.seen.get(e);if(!r)throw new Error("Unprocessed schema. This is a bug in Zod.");let i=u=>{let c=this.target==="draft-2020-12"?"$defs":"definitions";if(a.external){let p=a.external.registry.get(u[0])?.id,f=a.external.uri??(g=>g);if(p)return{ref:f(p)};let m=u[1].defId??u[1].schema.id??`schema${this.counter++}`;return u[1].defId=m,{defId:m,ref:`${f("__shared")}#/${c}/${m}`}}if(u[1]===r)return{ref:"#"};let d=`#/${c}/`,h=u[1].schema.id??`__schema${this.counter++}`;return{defId:h,ref:d+h}},n=u=>{if(u[1].schema.$ref)return;let c=u[1],{ref:d,defId:h}=i(u);c.def={...c.schema},h&&(c.defId=h);let p=c.schema;for(let f in p)delete p[f];p.$ref=d};if(a.cycles==="throw")for(let u of this.seen.entries()){let c=u[1];if(c.cycle)throw new Error(`Cycle detected: #/${c.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(let u of this.seen.entries()){let c=u[1];if(e===u[0]){n(u);continue}if(a.external){let d=a.external.registry.get(u[0])?.id;if(e!==u[0]&&d){n(u);continue}}if(this.metadataRegistry.get(u[0])?.id){n(u);continue}if(c.cycle){n(u);continue}if(c.count>1&&a.reused==="ref"){n(u);continue}}let s=(u,c)=>{let d=this.seen.get(u),h=d.def??d.schema,p={...h};if(d.ref===null)return;let f=d.ref;if(d.ref=null,f){s(f,c);let m=this.seen.get(f).schema;m.$ref&&c.target==="draft-7"?(h.allOf=h.allOf??[],h.allOf.push(m)):(Object.assign(h,m),Object.assign(h,p))}d.isParent||this.override({zodSchema:u,jsonSchema:h,path:d.path??[]})};for(let u of[...this.seen.entries()].reverse())s(u[0],{target:this.target});let o={};if(this.target==="draft-2020-12"?o.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),a.external?.uri){let u=a.external.registry.get(e)?.id;if(!u)throw new Error("Schema is missing an `id` property");o.$id=a.external.uri(u)}Object.assign(o,r.def);let l=a.external?.defs??{};for(let u of this.seen.entries()){let c=u[1];c.def&&c.defId&&(l[c.defId]=c.def)}a.external||Object.keys(l).length>0&&(this.target==="draft-2020-12"?o.$defs=l:o.definitions=l);try{return JSON.parse(JSON.stringify(o))}catch{throw new Error("Error converting schema to JSON.")}}}}),OE=v(()=>{}),qy=v(()=>{jo(),Ly(),Ay(),pE(),dE(),Dy(),Ir(),cE(),fE(),By(),hE(),vE(),_E(),wE(),OE()}),Vy,Hc,Wy,Gc=v(()=>{Vy=Symbol("Let zodToJsonSchema decide on which parser to use"),Hc={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Wy=e=>typeof e=="string"?{...Hc,name:e}:{...Hc,...e}}),Hy,Gy=v(()=>{Gc(),Hy=e=>{let t=Wy(e),a=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([r,i])=>[i._def,{def:i._def,path:[...t.basePath,t.definitionPath,r],jsonSchema:void 0}]))}}});function Jy(e,t,a,r){r?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function ye(e,t,a,r,i){e[t]=a,Jy(e,t,r,i)}var $r=v(()=>{}),Jc,Kc=v(()=>{Jc=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")}}),Ra=v(()=>{Us(),Us()});function st(e){if(e.target!=="openAi")return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:e.$refStrategy==="relative"?Jc(t,e.currentPath):t.join("/")}}var Ht=v(()=>{Kc()});function kE(e,t){let a={type:"array"};return e.type?._def&&e.type?._def?.typeName!==k.ZodAny&&(a.items=fe(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&ye(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&ye(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(ye(a,"minItems",e.exactLength.value,e.exactLength.message,t),ye(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}var Ky=v(()=>{Ra(),$r(),$e()});function EE(e,t){let a={type:"integer",format:"int64"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"min":t.target==="jsonSchema7"?r.inclusive?ye(a,"minimum",r.value,r.message,t):ye(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),ye(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?ye(a,"maximum",r.value,r.message,t):ye(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),ye(a,"maximum",r.value,r.message,t));break;case"multipleOf":ye(a,"multipleOf",r.value,r.message,t);break}return a}var Xy=v(()=>{$r()});function xE(){return{type:"boolean"}}var Yy=v(()=>{});function Qy(e,t){return fe(e.type._def,t)}var Xc=v(()=>{$e()}),eb,tb=v(()=>{$e(),eb=(e,t)=>fe(e.innerType._def,t)});function ab(e,t,a){let r=a??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((i,n)=>ab(e,t,i))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return rb(e,t)}}var rb,ib=v(()=>{$r(),rb=(e,t)=>{let a={type:"integer",format:"unix-time"};if(t.target==="openApi3")return a;for(let r of e.checks)switch(r.kind){case"min":ye(a,"minimum",r.value,r.message,t);break;case"max":ye(a,"maximum",r.value,r.message,t);break}return a}});function PE(e,t){return{...fe(e.innerType._def,t),default:e.defaultValue()}}var nb=v(()=>{$e()});function AE(e,t){return t.effectStrategy==="input"?fe(e.schema._def,t):st(t)}var sb=v(()=>{$e(),Ht()});function SE(e){return{type:"string",enum:Array.from(e.values)}}var ob=v(()=>{});function jE(e,t){let a=[fe(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),fe(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(n=>!!n),r=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,i=[];return a.forEach(n=>{if(lb(n))i.push(...n.allOf),n.unevaluatedProperties===void 0&&(r=void 0);else{let s=n;if("additionalProperties"in n&&n.additionalProperties===!1){let{additionalProperties:o,...l}=n;s=l}else r=void 0;i.push(s)}}),i.length?{allOf:i,...r}:void 0}var lb,ub=v(()=>{$e(),lb=e=>"type"in e&&e.type==="string"?!1:"allOf"in e});function IE(e,t){let a=typeof e.value;return a!=="bigint"&&a!=="number"&&a!=="boolean"&&a!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:a==="bigint"?"integer":a,enum:[e.value]}:{type:a==="bigint"?"integer":a,const:e.value}}var cb=v(()=>{});function db(e,t){let a={type:"string"};if(e.checks)for(let r of e.checks)switch(r.kind){case"min":ye(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,r.value):r.value,r.message,t);break;case"max":ye(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Gt(a,"email",r.message,t);break;case"format:idn-email":Gt(a,"idn-email",r.message,t);break;case"pattern:zod":rt(a,Tt.email,r.message,t);break}break;case"url":Gt(a,"uri",r.message,t);break;case"uuid":Gt(a,"uuid",r.message,t);break;case"regex":rt(a,r.regex,r.message,t);break;case"cuid":rt(a,Tt.cuid,r.message,t);break;case"cuid2":rt(a,Tt.cuid2,r.message,t);break;case"startsWith":rt(a,RegExp(`^${Yc(r.value,t)}`),r.message,t);break;case"endsWith":rt(a,RegExp(`${Yc(r.value,t)}$`),r.message,t);break;case"datetime":Gt(a,"date-time",r.message,t);break;case"date":Gt(a,"date",r.message,t);break;case"time":Gt(a,"time",r.message,t);break;case"duration":Gt(a,"duration",r.message,t);break;case"length":ye(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,r.value):r.value,r.message,t),ye(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,r.value):r.value,r.message,t);break;case"includes":{rt(a,RegExp(Yc(r.value,t)),r.message,t);break}case"ip":{r.version!=="v6"&&Gt(a,"ipv4",r.message,t),r.version!=="v4"&&Gt(a,"ipv6",r.message,t);break}case"base64url":rt(a,Tt.base64url,r.message,t);break;case"jwt":rt(a,Tt.jwt,r.message,t);break;case"cidr":{r.version!=="v6"&&rt(a,Tt.ipv4Cidr,r.message,t),r.version!=="v4"&&rt(a,Tt.ipv6Cidr,r.message,t);break}case"emoji":rt(a,Tt.emoji(),r.message,t);break;case"ulid":{rt(a,Tt.ulid,r.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{Gt(a,"binary",r.message,t);break}case"contentEncoding:base64":{ye(a,"contentEncoding","base64",r.message,t);break}case"pattern:zod":{rt(a,Tt.base64,r.message,t);break}}break}case"nanoid":rt(a,Tt.nanoid,r.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return a}function Yc(e,t){return t.patternStrategy==="escape"?$E(e):e}function $E(e){let t="";for(let a=0;a<e.length;a++)pb.has(e[a])||(t+="\\"),t+=e[a];return t}function Gt(e,t,a,r){e.format||e.anyOf?.some(i=>i.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&r.errorMessages&&{errorMessage:{format:a}}})):ye(e,"format",t,a,r)}function rt(e,t,a,r){e.pattern||e.allOf?.some(i=>i.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:hb(t,r),...a&&r.errorMessages&&{errorMessage:{pattern:a}}})):ye(e,"pattern",hb(t,r),a,r)}function hb(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},r=a.i?e.source.toLowerCase():e.source,i="",n=!1,s=!1,o=!1;for(let l=0;l<r.length;l++){if(n){i+=r[l],n=!1;continue}if(a.i){if(s){if(r[l].match(/[a-z]/)){o?(i+=r[l],i+=`${r[l-2]}-${r[l]}`.toUpperCase(),o=!1):r[l+1]==="-"&&r[l+2]?.match(/[a-z]/)?(i+=r[l],o=!0):i+=`${r[l]}${r[l].toUpperCase()}`;continue}}else if(r[l].match(/[a-z]/)){i+=`[${r[l]}${r[l].toUpperCase()}]`;continue}}if(a.m){if(r[l]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(r[l]==="$"){i+=`($|(?=[\r
]))`;continue}}if(a.s&&r[l]==="."){i+=s?`${r[l]}\r
`:`[${r[l]}\r
]`;continue}i+=r[l],r[l]==="\\"?n=!0:s&&r[l]==="]"?s=!1:!s&&r[l]==="["&&(s=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}var Qc,Tt,pb,ed=v(()=>{$r(),Tt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Qc===void 0&&(Qc=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Qc),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/},pb=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789")});function fb(e,t){if(t.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),t.target==="openApi3"&&e.keyType?._def.typeName===k.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,i)=>({...r,[i]:fe(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",i]})??st(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let a={type:"object",additionalProperties:fe(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if(t.target==="openApi3")return a;if(e.keyType?._def.typeName===k.ZodString&&e.keyType._def.checks?.length){let{type:r,...i}=db(e.keyType._def,t);return{...a,propertyNames:i}}else{if(e.keyType?._def.typeName===k.ZodEnum)return{...a,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===k.ZodBranded&&e.keyType._def.type._def.typeName===k.ZodString&&e.keyType._def.type._def.checks?.length){let{type:r,...i}=Qy(e.keyType._def,t);return{...a,propertyNames:i}}}return a}var td=v(()=>{Ra(),$e(),ed(),Xc(),Ht()});function TE(e,t){if(t.mapStrategy==="record")return fb(e,t);let a=fe(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||st(t),r=fe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||st(t);return{type:"array",maxItems:125,items:{type:"array",items:[a,r],minItems:2,maxItems:2}}}var mb=v(()=>{$e(),td(),Ht()});function NE(e){let t=e.values,a=Object.keys(e.values).filter(i=>typeof t[t[i]]!="number").map(i=>t[i]),r=Array.from(new Set(a.map(i=>typeof i)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:a}}var gb=v(()=>{});function CE(e){return e.target==="openAi"?void 0:{not:st({...e,currentPath:[...e.currentPath,"not"]})}}var yb=v(()=>{Ht()});function RE(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var bb=v(()=>{});function LE(e,t){if(t.target==="openApi3")return ad(e,t);let a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every(r=>r._def.typeName in Pn&&(!r._def.checks||!r._def.checks.length))){let r=a.reduce((i,n)=>{let s=Pn[n._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:r.length>1?r:r[0]}}else if(a.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=a.reduce((i,n)=>{let s=typeof n._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":if(n._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(r.length===a.length){let i=r.filter((n,s,o)=>o.indexOf(n)===s);return{type:i.length>1?i:i[0],enum:a.reduce((n,s)=>n.includes(s._def.value)?n:[...n,s._def.value],[])}}}else if(a.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:a.reduce((r,i)=>[...r,...i._def.values.filter(n=>!r.includes(n))],[])};return ad(e,t)}var Pn,ad,rd=v(()=>{$e(),Pn={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},ad=(e,t)=>{let a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((r,i)=>fe(r._def,{...t,currentPath:[...t.currentPath,"anyOf",`${i}`]})).filter(r=>!!r&&(!t.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return a.length?{anyOf:a}:void 0}});function ME(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"?{type:Pn[e.innerType._def.typeName],nullable:!0}:{type:[Pn[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){let r=fe(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let a=fe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}var _b=v(()=>{$e(),rd()});function UE(e,t){let a={type:"number"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"int":a.type="integer",Jy(a,"type",r.message,t);break;case"min":t.target==="jsonSchema7"?r.inclusive?ye(a,"minimum",r.value,r.message,t):ye(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),ye(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?ye(a,"maximum",r.value,r.message,t):ye(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),ye(a,"maximum",r.value,r.message,t));break;case"multipleOf":ye(a,"multipleOf",r.value,r.message,t);break}return a}var vb=v(()=>{$r()});function DE(e,t){let a=t.target==="openAi",r={type:"object",properties:{}},i=[],n=e.shape();for(let o in n){let l=n[o];if(l===void 0||l._def===void 0)continue;let u=zE(l);u&&a&&(l._def.typeName==="ZodOptional"&&(l=l._def.innerType),l.isNullable()||(l=l.nullable()),u=!1);let c=fe(l._def,{...t,currentPath:[...t.currentPath,"properties",o],propertyPath:[...t.currentPath,"properties",o]});c!==void 0&&(r.properties[o]=c,u||i.push(o))}i.length&&(r.required=i);let s=FE(e,t);return s!==void 0&&(r.additionalProperties=s),r}function FE(e,t){if(e.catchall._def.typeName!=="ZodNever")return fe(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return t.removeAdditionalStrategy==="strict"?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function zE(e){try{return e.isOptional()}catch{return!0}}var wb=v(()=>{$e()}),Ob,kb=v(()=>{$e(),Ht(),Ob=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return fe(e.innerType._def,t);let a=fe(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:st(t)},a]}:st(t)}}),Eb,xb=v(()=>{$e(),Eb=(e,t)=>{if(t.pipeStrategy==="input")return fe(e.in._def,t);if(t.pipeStrategy==="output")return fe(e.out._def,t);let a=fe(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),r=fe(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]});return{allOf:[a,r].filter(i=>i!==void 0)}}});function BE(e,t){return fe(e.type._def,t)}var Pb=v(()=>{$e()});function ZE(e,t){let a={type:"array",uniqueItems:!0,items:fe(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&ye(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&ye(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}var Ab=v(()=>{$r(),$e()});function qE(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((a,r)=>fe(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[]),additionalItems:fe(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((a,r)=>fe(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[])}}var Sb=v(()=>{$e()});function VE(e){return{not:st(e)}}var jb=v(()=>{Ht()});function WE(e){return st(e)}var Ib=v(()=>{Ht()}),$b,Tb=v(()=>{$e(),$b=(e,t)=>fe(e.innerType._def,t)}),Nb,Cb=v(()=>{Ra(),Ht(),Ky(),Xy(),Yy(),Xc(),tb(),ib(),nb(),sb(),ob(),ub(),cb(),mb(),gb(),yb(),bb(),_b(),vb(),wb(),kb(),xb(),Pb(),td(),Ab(),ed(),Sb(),jb(),rd(),Ib(),Tb(),Nb=(e,t,a)=>{switch(t){case k.ZodString:return db(e,a);case k.ZodNumber:return UE(e,a);case k.ZodObject:return DE(e,a);case k.ZodBigInt:return EE(e,a);case k.ZodBoolean:return xE();case k.ZodDate:return ab(e,a);case k.ZodUndefined:return VE(a);case k.ZodNull:return RE(a);case k.ZodArray:return kE(e,a);case k.ZodUnion:case k.ZodDiscriminatedUnion:return LE(e,a);case k.ZodIntersection:return jE(e,a);case k.ZodTuple:return qE(e,a);case k.ZodRecord:return fb(e,a);case k.ZodLiteral:return IE(e,a);case k.ZodEnum:return SE(e);case k.ZodNativeEnum:return NE(e);case k.ZodNullable:return ME(e,a);case k.ZodOptional:return Ob(e,a);case k.ZodMap:return TE(e,a);case k.ZodSet:return ZE(e,a);case k.ZodLazy:return()=>e.getter()._def;case k.ZodPromise:return BE(e,a);case k.ZodNaN:case k.ZodNever:return CE(a);case k.ZodEffects:return AE(e,a);case k.ZodAny:return st(a);case k.ZodUnknown:return WE(a);case k.ZodDefault:return PE(e,a);case k.ZodBranded:return Qy(e,a);case k.ZodReadonly:return $b(e,a);case k.ZodCatch:return eb(e,a);case k.ZodPipeline:return Eb(e,a);case k.ZodFunction:case k.ZodVoid:case k.ZodSymbol:return;default:return(r=>{})(t)}}});function fe(e,t,a=!1){let r=t.seen.get(e);if(t.override){let o=t.override?.(e,t,r,a);if(o!==Vy)return o}if(r&&!a){let o=Rb(r,t);if(o!==void 0)return o}let i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);let n=Nb(e,e.typeName,t),s=typeof n=="function"?fe(n(),t):n;if(s&&Lb(e,t,s),t.postProcess){let o=t.postProcess(s,e,t);return i.jsonSchema=s,o}return i.jsonSchema=s,s}var Rb,Lb,$e=v(()=>{Gc(),Cb(),Kc(),Ht(),Rb=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Jc(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((a,r)=>t.currentPath[r]===a)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),st(t)):t.$refStrategy==="seen"?st(t):void 0}},Lb=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a)}),HE=v(()=>{}),id,Mb=v(()=>{$e(),Gy(),Ht(),id=(e,t)=>{let a=Hy(t),r=typeof t=="object"&&t.definitions?Object.entries(t.definitions).reduce((l,[u,c])=>({...l,[u]:fe(c._def,{...a,currentPath:[...a.basePath,a.definitionPath,u]},!0)??st(a)}),{}):void 0,i=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,n=fe(e._def,i===void 0?a:{...a,currentPath:[...a.basePath,a.definitionPath,i]},!1)??st(a),s=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;s!==void 0&&(n.title=s),a.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[a.openAiAnyTypeName]||(r[a.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:a.$refStrategy==="relative"?"1":[...a.basePath,a.definitionPath,a.openAiAnyTypeName].join("/")}}));let o=i===void 0?r?{...n,[a.definitionPath]:r}:n:{$ref:[...a.$refStrategy==="relative"?[]:a.basePath,a.definitionPath,i].join("/"),[a.definitionPath]:{...r,[i]:n}};return a.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(a.target==="jsonSchema2019-09"||a.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),a.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o}}),nd=v(()=>{Gc(),Gy(),$r(),Kc(),$e(),HE(),Ht(),Ky(),Xy(),Yy(),Xc(),tb(),ib(),nb(),sb(),ob(),ub(),cb(),mb(),gb(),yb(),bb(),_b(),vb(),wb(),kb(),xb(),Pb(),Tb(),td(),Ab(),ed(),Sb(),jb(),rd(),Ib(),Cb(),Mb(),Mb()});function Si(e,t){let a=typeof e;if(a!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let r=e.length;if(r!==t.length)return!1;for(let i=0;i<r;i++)if(!Si(e[i],t[i]))return!1;return!0}if(a==="object"){if(!e||!t)return e===t;let r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(let n of r)if(!Si(e[n],t[n]))return!1;return!0}return e===t}var Ub=v(()=>{});function Jt(e){return encodeURI(GE(e))}function GE(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}var sd=v(()=>{});function An(e,t=Object.create(null),a=Bb,r=""){if(e&&typeof e=="object"&&!Array.isArray(e)){let n=e.$id||e.id;if(n){let s=new URL(n,a.href);s.hash.length>1?t[s.href]=e:(s.hash="",r===""?a=s:An(e,t,a))}}else if(e!==!0&&e!==!1)return t;let i=a.href+(r?"#"+r:"");if(t[i]!==void 0)throw new Error(`Duplicate schema URI "${i}".`);if(t[i]=e,e===!0||e===!1)return t;if(e.__absolute_uri__===void 0&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:i}),e.$ref&&e.__absolute_ref__===void 0){let n=new URL(e.$ref,a.href);n.hash=n.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:n.href})}if(e.$recursiveRef&&e.__absolute_recursive_ref__===void 0){let n=new URL(e.$recursiveRef,a.href);n.hash=n.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:n.href})}if(e.$anchor){let n=new URL("#"+e.$anchor,a.href);t[n.href]=e}for(let n in e){if(zb[n])continue;let s=`${r}/${Jt(n)}`,o=e[n];if(Array.isArray(o)){if(Db[n]){let l=o.length;for(let u=0;u<l;u++)An(o[u],t,a,`${s}/${u}`)}}else if(Fb[n])for(let l in o)An(o[l],t,a,`${s}/${Jt(l)}`);else An(o,t,a,s)}return t}var Db,Fb,zb,Bb,od=v(()=>{sd(),Db={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Fb={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},zb={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0},Bb=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker")});function fa(e){return e.test.bind(e)}function JE(e){return e%4===0&&(e%100!==0||e%400===0)}function Zb(e){let t=e.match(Vb);if(!t)return!1;let a=+t[1],r=+t[2],i=+t[3];return r>=1&&r<=12&&i>=1&&i<=(r==2&&JE(a)?29:Wb[r])}function qb(e,t){let a=t.match(Hb);if(!a)return!1;let r=+a[1],i=+a[2],n=+a[3],s=!!a[5];return(r<=23&&i<=59&&n<=59||r==23&&i==59&&n==60)&&(!e||s)}function KE(e){let t=e.split(s0);return t.length==2&&Zb(t[0])&&qb(!0,t[1])}function XE(e){return o0.test(e)&&l0.test(e)}function YE(e){if(u0.test(e))return!1;try{return new RegExp(e,"u"),!0}catch{return!1}}var Vb,Wb,Hb,Gb,Jb,Kb,Xb,Yb,Qb,e0,t0,a0,r0,i0,n0,ld,s0,o0,l0,u0,c0=v(()=>{Vb=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Wb=[0,31,28,31,30,31,30,31,31,30,31,30,31],Hb=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Gb=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Jb=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Kb=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,Xb=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,Yb=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,Qb=/^(?:\/(?:[^~/]|~0|~1)*)*$/,e0=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,t0=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,a0=e=>{if(e[0]==='"')return!1;let[t,a,...r]=e.split("@");return!t||!a||r.length!==0||t.length>64||a.length>253||t[0]==="."||t.endsWith(".")||t.includes("..")||!/^[a-z0-9.-]+$/i.test(a)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)?!1:a.split(".").every(i=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(i))},r0=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,i0=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,n0=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),ld={date:Zb,time:qb.bind(void 0,!1),"date-time":KE,duration:n0,uri:XE,"uri-reference":fa(Jb),"uri-template":fa(Kb),url:fa(Xb),email:a0,hostname:fa(Gb),ipv4:fa(r0),ipv6:fa(i0),regex:YE,uuid:fa(Yb),"json-pointer":fa(Qb),"json-pointer-uri-fragment":fa(e0),"relative-json-pointer":fa(t0)},s0=/t|\s/i,o0=/\/|:/,l0=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,u0=/[^\\]\\Z/}),d0,QE=v(()=>{(function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"})(d0||(d0={}))});function ex(e){let t=0,a=e.length,r=0,i;for(;r<a;)t++,i=e.charCodeAt(r++),i>=55296&&i<=56319&&r<a&&(i=e.charCodeAt(r),(i&64512)==56320&&r++);return t}var h0=v(()=>{});function Oe(e,t,a="2019-09",r=An(t),i=!0,n=null,s="#",o="#",l=Object.create(null)){if(t===!0)return{valid:!0,errors:[]};if(t===!1)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};let u=typeof e,c;switch(u){case"boolean":case"number":case"string":c=u;break;case"object":e===null?c="null":Array.isArray(e)?c="array":c="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}let{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:f,const:m,enum:g,required:b,not:y,anyOf:_,allOf:w,oneOf:O,if:j,then:S,else:E,format:A,properties:x,patternProperties:te,additionalProperties:Le,unevaluatedProperties:Xe,minProperties:Wa,maxProperties:Oa,propertyNames:N,dependentRequired:I,dependentSchemas:V,dependencies:z,prefixItems:W,items:D,additionalItems:X,unevaluatedItems:de,contains:le,minContains:ue,maxContains:me,minItems:ka,maxItems:Ha,uniqueItems:Yj,minimum:Jr,maximum:Kr,exclusiveMinimum:bs,exclusiveMaximum:_s,multipleOf:Xl,minLength:Yl,maxLength:Ql,pattern:Nw,__absolute_ref__:eu,__absolute_recursive_ref__:Qj}=t,R=[];if(p===!0&&n===null&&(n=t),h==="#"){let J=n===null?r[Qj]:n,B=`${o}/$recursiveRef`,oe=Oe(e,n===null?t:n,a,r,i,J,s,B,l);oe.valid||R.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:B,error:"A subschema had errors."},...oe.errors)}if(d!==void 0){let J=r[eu||d];if(J===void 0){let L=`Unresolved $ref "${d}".`;throw eu&&eu!==d&&(L+=`  Absolute URI "${eu}".`),L+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(L)}let B=`${o}/$ref`,oe=Oe(e,J,a,r,i,n,s,B,l);if(oe.valid||R.push({instanceLocation:s,keyword:"$ref",keywordLocation:B,error:"A subschema had errors."},...oe.errors),a==="4"||a==="7")return{valid:R.length===0,errors:R}}if(Array.isArray(f)){let J=f.length,B=!1;for(let oe=0;oe<J;oe++)if(c===f[oe]||f[oe]==="integer"&&c==="number"&&e%1===0&&e===e){B=!0;break}B||R.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f.join('", "')}".`})}else f==="integer"?(c!=="number"||e%1||e!==e)&&R.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f}".`}):f!==void 0&&c!==f&&R.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f}".`});if(m!==void 0&&(c==="object"||c==="array"?Si(e,m)||R.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):e!==m&&R.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),g!==void 0&&(c==="object"||c==="array"?g.some(J=>Si(e,J))||R.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(J=>e===J)||R.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),y!==void 0){let J=`${o}/not`;Oe(e,y,a,r,i,n,s,J).valid&&R.push({instanceLocation:s,keyword:"not",keywordLocation:J,error:'Instance matched "not" schema.'})}let tu=[];if(_!==void 0){let J=`${o}/anyOf`,B=R.length,oe=!1;for(let L=0;L<_.length;L++){let C=_[L],Q=Object.create(l),Y=Oe(e,C,a,r,i,p===!0?n:null,s,`${J}/${L}`,Q);R.push(...Y.errors),oe=oe||Y.valid,Y.valid&&tu.push(Q)}oe?R.length=B:R.splice(B,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:J,error:"Instance does not match any subschemas."})}if(w!==void 0){let J=`${o}/allOf`,B=R.length,oe=!0;for(let L=0;L<w.length;L++){let C=w[L],Q=Object.create(l),Y=Oe(e,C,a,r,i,p===!0?n:null,s,`${J}/${L}`,Q);R.push(...Y.errors),oe=oe&&Y.valid,Y.valid&&tu.push(Q)}oe?R.length=B:R.splice(B,0,{instanceLocation:s,keyword:"allOf",keywordLocation:J,error:"Instance does not match every subschema."})}if(O!==void 0){let J=`${o}/oneOf`,B=R.length,oe=O.filter((L,C)=>{let Q=Object.create(l),Y=Oe(e,L,a,r,i,p===!0?n:null,s,`${J}/${C}`,Q);return R.push(...Y.errors),Y.valid&&tu.push(Q),Y.valid}).length;oe===1?R.length=B:R.splice(B,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:J,error:`Instance does not match exactly one subschema (${oe} matches).`})}if((c==="object"||c==="array")&&Object.assign(l,...tu),j!==void 0){let J=`${o}/if`;if(Oe(e,j,a,r,i,n,s,J,l).valid){if(S!==void 0){let B=Oe(e,S,a,r,i,n,s,`${o}/then`,l);B.valid||R.push({instanceLocation:s,keyword:"if",keywordLocation:J,error:'Instance does not match "then" schema.'},...B.errors)}}else if(E!==void 0){let B=Oe(e,E,a,r,i,n,s,`${o}/else`,l);B.valid||R.push({instanceLocation:s,keyword:"if",keywordLocation:J,error:'Instance does not match "else" schema.'},...B.errors)}}if(c==="object"){if(b!==void 0)for(let L of b)L in e||R.push({instanceLocation:s,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${L}".`});let J=Object.keys(e);if(Wa!==void 0&&J.length<Wa&&R.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${Wa} properties.`}),Oa!==void 0&&J.length>Oa&&R.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${Oa} properties.`}),N!==void 0){let L=`${o}/propertyNames`;for(let C in e){let Q=`${s}/${Jt(C)}`,Y=Oe(C,N,a,r,i,n,Q,L);Y.valid||R.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:L,error:`Property name "${C}" does not match schema.`},...Y.errors)}}if(I!==void 0){let L=`${o}/dependantRequired`;for(let C in I)if(C in e){let Q=I[C];for(let Y of Q)Y in e||R.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:L,error:`Instance has "${C}" but does not have "${Y}".`})}}if(V!==void 0)for(let L in V){let C=`${o}/dependentSchemas`;if(L in e){let Q=Oe(e,V[L],a,r,i,n,s,`${C}/${Jt(L)}`,l);Q.valid||R.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:C,error:`Instance has "${L}" but does not match dependant schema.`},...Q.errors)}}if(z!==void 0){let L=`${o}/dependencies`;for(let C in z)if(C in e){let Q=z[C];if(Array.isArray(Q))for(let Y of Q)Y in e||R.push({instanceLocation:s,keyword:"dependencies",keywordLocation:L,error:`Instance has "${C}" but does not have "${Y}".`});else{let Y=Oe(e,Q,a,r,i,n,s,`${L}/${Jt(C)}`);Y.valid||R.push({instanceLocation:s,keyword:"dependencies",keywordLocation:L,error:`Instance has "${C}" but does not match dependant schema.`},...Y.errors)}}}let B=Object.create(null),oe=!1;if(x!==void 0){let L=`${o}/properties`;for(let C in x){if(!(C in e))continue;let Q=`${s}/${Jt(C)}`,Y=Oe(e[C],x[C],a,r,i,n,Q,`${L}/${Jt(C)}`);if(Y.valid)l[C]=B[C]=!0;else if(oe=i,R.push({instanceLocation:s,keyword:"properties",keywordLocation:L,error:`Property "${C}" does not match schema.`},...Y.errors),oe)break}}if(!oe&&te!==void 0){let L=`${o}/patternProperties`;for(let C in te){let Q=new RegExp(C,"u"),Y=te[C];for(let ht in e){if(!Q.test(ht))continue;let eI=`${s}/${Jt(ht)}`,Cw=Oe(e[ht],Y,a,r,i,n,eI,`${L}/${Jt(C)}`);Cw.valid?l[ht]=B[ht]=!0:(oe=i,R.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:L,error:`Property "${ht}" matches pattern "${C}" but does not match associated schema.`},...Cw.errors))}}}if(!oe&&Le!==void 0){let L=`${o}/additionalProperties`;for(let C in e){if(B[C])continue;let Q=`${s}/${Jt(C)}`,Y=Oe(e[C],Le,a,r,i,n,Q,L);Y.valid?l[C]=!0:(oe=i,R.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:L,error:`Property "${C}" does not match additional properties schema.`},...Y.errors))}}else if(!oe&&Xe!==void 0){let L=`${o}/unevaluatedProperties`;for(let C in e)if(!l[C]){let Q=`${s}/${Jt(C)}`,Y=Oe(e[C],Xe,a,r,i,n,Q,L);Y.valid?l[C]=!0:R.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:L,error:`Property "${C}" does not match unevaluated properties schema.`},...Y.errors)}}}else if(c==="array"){Ha!==void 0&&e.length>Ha&&R.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${Ha}).`}),ka!==void 0&&e.length<ka&&R.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${ka}).`});let J=e.length,B=0,oe=!1;if(W!==void 0){let L=`${o}/prefixItems`,C=Math.min(W.length,J);for(;B<C;B++){let Q=Oe(e[B],W[B],a,r,i,n,`${s}/${B}`,`${L}/${B}`);if(l[B]=!0,!Q.valid&&(oe=i,R.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:L,error:"Items did not match schema."},...Q.errors),oe))break}}if(D!==void 0){let L=`${o}/items`;if(Array.isArray(D)){let C=Math.min(D.length,J);for(;B<C;B++){let Q=Oe(e[B],D[B],a,r,i,n,`${s}/${B}`,`${L}/${B}`);if(l[B]=!0,!Q.valid&&(oe=i,R.push({instanceLocation:s,keyword:"items",keywordLocation:L,error:"Items did not match schema."},...Q.errors),oe))break}}else for(;B<J;B++){let C=Oe(e[B],D,a,r,i,n,`${s}/${B}`,L);if(l[B]=!0,!C.valid&&(oe=i,R.push({instanceLocation:s,keyword:"items",keywordLocation:L,error:"Items did not match schema."},...C.errors),oe))break}if(!oe&&X!==void 0){let C=`${o}/additionalItems`;for(;B<J;B++){let Q=Oe(e[B],X,a,r,i,n,`${s}/${B}`,C);l[B]=!0,Q.valid||(oe=i,R.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:C,error:"Items did not match additional items schema."},...Q.errors))}}}if(le!==void 0)if(J===0&&ue===void 0)R.push({instanceLocation:s,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(ue!==void 0&&J<ue)R.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${J}) than minContains (${ue}).`});else{let L=`${o}/contains`,C=R.length,Q=0;for(let Y=0;Y<J;Y++){let ht=Oe(e[Y],le,a,r,i,n,`${s}/${Y}`,L);ht.valid?(l[Y]=!0,Q++):R.push(...ht.errors)}Q>=(ue||0)&&(R.length=C),ue===void 0&&me===void 0&&Q===0?R.splice(C,0,{instanceLocation:s,keyword:"contains",keywordLocation:L,error:"Array does not contain item matching schema."}):ue!==void 0&&Q<ue?R.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${ue} items matching schema. Only ${Q} items were found.`}):me!==void 0&&Q>me&&R.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${me} items matching schema. ${Q} items were found.`})}if(!oe&&de!==void 0){let L=`${o}/unevaluatedItems`;for(B;B<J;B++){if(l[B])continue;let C=Oe(e[B],de,a,r,i,n,`${s}/${B}`,L);l[B]=!0,C.valid||R.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:L,error:"Items did not match unevaluated items schema."},...C.errors)}}if(Yj)for(let L=0;L<J;L++){let C=e[L],Q=typeof C=="object"&&C!==null;for(let Y=0;Y<J;Y++){if(L===Y)continue;let ht=e[Y];(C===ht||Q&&typeof ht=="object"&&ht!==null&&Si(C,ht))&&(R.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${L} and ${Y}.`}),L=Number.MAX_SAFE_INTEGER,Y=Number.MAX_SAFE_INTEGER)}}}else if(c==="number"){if(a==="4"?(Jr!==void 0&&(bs===!0&&e<=Jr||e<Jr)&&R.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${bs?"or equal to ":""} ${Jr}.`}),Kr!==void 0&&(_s===!0&&e>=Kr||e>Kr)&&R.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${_s?"or equal to ":""} ${Kr}.`})):(Jr!==void 0&&e<Jr&&R.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Jr}.`}),Kr!==void 0&&e>Kr&&R.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${Kr}.`}),bs!==void 0&&e<=bs&&R.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${bs}.`}),_s!==void 0&&e>=_s&&R.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${_s}.`})),Xl!==void 0){let J=e%Xl;Math.abs(0-J)>=11920929e-14&&Math.abs(Xl-J)>=11920929e-14&&R.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${Xl}.`})}}else if(c==="string"){let J=Yl===void 0&&Ql===void 0?0:ex(e);Yl!==void 0&&J<Yl&&R.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${J} < ${Yl}).`}),Ql!==void 0&&J>Ql&&R.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${J} > ${Ql}).`}),Nw!==void 0&&!new RegExp(Nw,"u").test(e)&&R.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),A!==void 0&&ld[A]&&!ld[A](e)&&R.push({instanceLocation:s,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${A}".`})}return{valid:R.length===0,errors:R}}var p0=v(()=>{Ub(),od(),c0(),sd(),h0()}),tx=v(()=>{od(),p0()}),No=v(()=>{Ub(),od(),c0(),sd(),QE(),h0(),p0(),tx()});function ma(e){if(typeof e!="object"||e===null)return!1;let t=e;if(!("_zod"in t))return!1;let a=t._zod;return typeof a=="object"&&a!==null&&"def"in a}function La(e){if(typeof e!="object"||e===null)return!1;let t=e;if(!("_def"in t)||"_zod"in t)return!1;let a=t._def;return typeof a=="object"&&a!=null&&"typeName"in a}function Co(e){return!e||typeof e!="object"||Array.isArray(e)?!1:!!(ma(e)||La(e))}async function ax(e,t){if(ma(e))try{return{success:!0,data:await $y(e,t)}}catch(a){return{success:!1,error:a}}if(La(e))return e.safeParse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function ud(e,t){if(ma(e))return jy(e,t);if(La(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function f0(e){if(ma(e))return Ca.get(e)?.description;if(La(e)||"description"in e&&typeof e.description=="string")return e.description}function rx(e){return Co(e)?La(e)?e._def.typeName==="ZodString":ma(e)?e._zod.def.type==="string":!1:!1}function Sn(e){return ma(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="object":!1}function m0(e){return ma(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="array":!1}function cd(e,t=!1){if(La(e))return e.strict();if(Sn(e)){let a=e._zod.def.shape;if(t)for(let[n,s]of Object.entries(e._zod.def.shape)){if(Sn(s)){let l=cd(s,t);a[n]=l}else if(m0(s)){let l=s._zod.def.element;Sn(l)&&(l=cd(l,t)),a[n]=Io(s,{...s._zod.def,element:l})}else a[n]=s;let o=Ca.get(s);o&&Ca.add(a[n],o)}let r=Io(e,{...e._zod.def,shape:a,catchall:bE(zy)}),i=Ca.get(e);return i&&Ca.add(r,i),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function ix(e){return La(e)&&"typeName"in e._def&&e._def.typeName==="ZodEffects"}function nx(e){return ma(e)&&e._zod.def.type==="pipe"}function jn(e,t=!1){if(La(e))return ix(e)?jn(e._def.schema,t):e;if(ma(e)){let a=e;if(nx(e)&&(a=jn(e._zod.def.in,t)),t){if(Sn(a)){let i=a._zod.def.shape;for(let[n,s]of Object.entries(a._zod.def.shape))i[n]=jn(s,t);a=Io(a,{...a._zod.def,shape:i})}else if(m0(a)){let i=jn(a._zod.def.element,t);a=Io(a,{...a._zod.def,element:i})}}let r=Ca.get(e);return r&&Ca.add(a,r),a}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}var ar=v(()=>{qy()});function Ro(e){if(ma(e)){let t=jn(e,!0);if(Sn(t)){let a=cd(t,!0);return Zy(a)}else return Zy(e)}return La(e)?id(e):e}var Tr=v(()=>{qy(),nd(),No(),ar(),No()});function sx(e,t){if(e!==void 0&&!ja(e))return e;if(Dc(t))try{let a=t.getName();return a=a.startsWith("Runnable")?a.slice(8):a,a}catch{return t.getName()}else return t.name??"UnknownSchema"}function ox(e){return Dc(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Ro(e.data.schema),title:e.data.name}}}function g0(e,t=[]){let a=new Set(e.edges.filter(i=>!t.includes(i.source)).map(i=>i.target)),r=[];for(let i of Object.values(e.nodes))!t.includes(i.id)&&!a.has(i.id)&&r.push(i);return r.length===1?r[0]:void 0}function y0(e,t=[]){let a=new Set(e.edges.filter(i=>!t.includes(i.target)).map(i=>i.source)),r=[];for(let i of Object.values(e.nodes))!t.includes(i.id)&&!a.has(i.id)&&r.push(i);return r.length===1?r[0]:void 0}var In,b0=v(()=>{la(),Ey(),eE(),Tr(),In=class eO{constructor(t){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=t?.nodes??this.nodes,this.edges=t?.edges??this.edges}toJSON(){let t={};return Object.values(this.nodes).forEach((a,r)=>{t[a.id]=ja(a.id)?r:a.id}),{nodes:Object.values(this.nodes).map(a=>({id:t[a.id],...ox(a)})),edges:this.edges.map(a=>{let r={source:t[a.source],target:t[a.target]};return typeof a.data<"u"&&(r.data=a.data),typeof a.conditional<"u"&&(r.conditional=a.conditional),r})}}addNode(t,a,r){if(a!==void 0&&this.nodes[a]!==void 0)throw new Error(`Node with id ${a} already exists`);let i=a??Ue(),n={id:i,data:t,name:sx(a,t),metadata:r};return this.nodes[i]=n,n}removeNode(t){delete this.nodes[t.id],this.edges=this.edges.filter(a=>a.source!==t.id&&a.target!==t.id)}addEdge(t,a,r,i){if(this.nodes[t.id]===void 0)throw new Error(`Source node ${t.id} not in graph`);if(this.nodes[a.id]===void 0)throw new Error(`Target node ${a.id} not in graph`);let n={source:t.id,target:a.id,data:r,conditional:i};return this.edges.push(n),n}firstNode(){return g0(this)}lastNode(){return y0(this)}extend(t,a=""){let r=a;Object.values(t.nodes).map(l=>l.id).every(ja)&&(r="");let i=l=>r?`${r}:${l}`:l;Object.entries(t.nodes).forEach(([l,u])=>{this.nodes[i(l)]={...u,id:i(l)}});let n=t.edges.map(l=>({...l,source:i(l.source),target:i(l.target)}));this.edges=[...this.edges,...n];let s=t.firstNode(),o=t.lastNode();return[s?{id:i(s.id),data:s.data}:void 0,o?{id:i(o.id),data:o.data}:void 0]}trimFirstNode(){let t=this.firstNode();t&&g0(this,[t.id])&&this.removeNode(t)}trimLastNode(){let t=this.lastNode();t&&y0(this,[t.id])&&this.removeNode(t)}reid(){let t=Object.fromEntries(Object.values(this.nodes).map(i=>[i.id,i.name])),a=new Map;Object.values(t).forEach(i=>{a.set(i,(a.get(i)||0)+1)});let r=i=>{let n=t[i];return ja(i)&&a.get(n)===1?n:i};return new eO({nodes:Object.fromEntries(Object.entries(this.nodes).map(([i,n])=>[r(i),{...n,id:r(i)}])),edges:this.edges.map(i=>({...i,source:r(i.source),target:r(i.target)}))})}drawMermaid(t){let{withStyles:a,curveStyle:r,nodeColors:i={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:n}=t??{},s=this.reid(),o=s.firstNode(),l=s.lastNode();return X1(s.nodes,s.edges,{firstNode:o?.id,lastNode:l?.id,withStyles:a,curveStyle:r,nodeColors:i,wrapLabelNWords:n})}async drawMermaidPng(t){let a=this.drawMermaid(t);return Y1(a,{backgroundColor:t?.backgroundColor})}}});function lx(e){let t=new TextEncoder,a=new ReadableStream({async start(r){for await(let i of e)r.enqueue(t.encode(`event: data
data: ${JSON.stringify(i)}

`));r.enqueue(t.encode(`event: end

`)),r.close()}});return yt.fromReadableStream(a)}var ux=v(()=>{pa()});function _0(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.iterator]=="function"&&typeof e.next=="function"}function dd(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.asyncIterator]=="function"}function*v0(e,t){for(;;){let{value:a,done:r}=gt.runWithConfig(Ai(e),t.next.bind(t),!0);if(r)break;yield a}}async function*hd(e,t){let a=t[Symbol.asyncIterator]();for(;;){let{value:r,done:i}=await gt.runWithConfig(Ai(e),a.next.bind(t),!0);if(i)break;yield r}}var w0,cx=v(()=>{Pi(),Ta(),w0=e=>e!=null&&typeof e=="object"&&"next"in e&&typeof e.next=="function"});function De(e,t){return e&&!Array.isArray(e)&&!(e instanceof Date)&&typeof e=="object"?e:{[t]:e}}function dx(e){if(Su(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}function bt(e){if(typeof e=="function")return new Lo({func:e});if(ge.isRunnable(e))return e;if(!Array.isArray(e)&&typeof e=="object"){let t={};for(let[a,r]of Object.entries(e))t[a]=bt(r);return new $n({steps:t})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}function hx(e,t){let a=t.name??e.getName(),r=t.description??f0(t.schema);return rx(t.schema)?new gd({name:a,description:r,schema:Ve.object({input:Ve.string()}).transform(i=>i.input),bound:e}):new gd({name:a,description:r,schema:t.schema,bound:e})}var pd,ge,Nr,O0,fd,Ma,$n,k0,Lo,E0,md,x0,gd,He=v(()=>{Ou(),pd=Mt(ku(),1),la(),Vf(),yy(),G1(),ca(),pa(),hy(),Ta(),kn(),J1(),Ey(),Pi(),b0(),ux(),cx(),bc(),ar(),ge=class extends bi{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Nr({bound:this,kwargs:e,config:{}})}map(){return new O0({bound:this})}withRetry(e){return new fd({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Nr({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new E0({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(pe);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let a=Object.fromEntries(Object.entries(e).filter(([r])=>r!=="runId"));return Array.from({length:t},(r,i)=>pe(i===0?e:a))}return Array.from({length:t},()=>pe(e))}async batch(e,t,a){let r=this._getOptionsList(t??{},e.length),i=r[0]?.maxConcurrency??a?.maxConcurrency,n=new Po({maxConcurrency:i,onFailedAttempt:o=>{throw o}}),s=e.map((o,l)=>n.call(async()=>{try{return await this.invoke(o,r[l])}catch(u){if(a?.returnExceptions)return u;throw u}}));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let a=pe(t),r=new Sr({generator:this._streamIterator(e,a),config:a});return await r.setup,yt.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=pe(e):t=pe({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let a={...e};return delete a.callbacks,delete a.tags,delete a.metadata,delete a.runName,delete a.configurable,delete a.recursionLimit,delete a.maxConcurrency,delete a.runId,delete a.timeout,delete a.signal,[t,a]}async _callWithConfig(e,t,a){let r=pe(a),i=await(await $t(r))?.handleChainStart(this.toJSON(),De(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName());delete r.runId;let n;try{let s=e.call(this,t,r,i);n=await tr(s,a?.signal)}catch(s){throw await i?.handleChainError(s),s}return await i?.handleChainEnd(De(n,"output")),n}async _batchWithConfig(e,t,a,r){let i=this._getOptionsList(a??{},t.length),n=await Promise.all(i.map($t)),s=await Promise.all(n.map(async(l,u)=>{let c=await l?.handleChainStart(this.toJSON(),De(t[u],"input"),i[u].runId,i[u].runType,void 0,void 0,i[u].runName??this.getName());return delete i[u].runId,c})),o;try{let l=e.call(this,t,i,s,r);o=await tr(l,i?.[0]?.signal)}catch(l){throw await Promise.all(s.map(u=>u?.handleChainError(l))),l}return await Promise.all(s.map(l=>l?.handleChainEnd(De(o,"output")))),o}_concatOutputChunks(e,t){return ko(e,t)}async*_transformStreamWithConfig(e,t,a){let r,i=!0,n,s=!0,o=pe(a),l=await $t(o),u=this;async function*c(){for await(let h of e){if(i)if(r===void 0)r=h;else try{r=u._concatOutputChunks(r,h)}catch{r=void 0,i=!1}yield h}}let d;try{let h=await W1(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),a?.signal,o);delete o.runId,d=h.setup;let p=d?.handlers.find(by),f=h.output;p!==void 0&&d!==void 0&&(f=p.tapOutputIterable(d.runId,f));let m=d?.handlers.find(gy);m!==void 0&&d!==void 0&&(f=m.tapOutputIterable(d.runId,f));for await(let g of f)if(yield g,s)if(n===void 0)n=g;else try{n=this._concatOutputChunks(n,g)}catch{n=void 0,s=!1}}catch(h){throw await d?.handleChainError(h,void 0,void 0,void 0,{inputs:De(r,"input")}),h}await d?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:De(r,"input")})}getGraph(e){let t=new In,a=t.addNode({name:`${this.getName()}Input`,schema:Ve.any()}),r=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Ve.any()});return t.addEdge(a,r),t.addEdge(r,i),t}pipe(e){return new Ma({first:this,last:bt(e)})}pick(e){return this.pipe(new x0(e))}assign(e){return this.pipe(new md(new $n({steps:e})))}async*transform(e,t){let a;for await(let r of e)a===void 0?a=r:a=this._concatOutputChunks(a,r);yield*this._streamIterator(a,pe(t))}async*streamLog(e,t,a){let r=new Lc({...a,autoClose:!1,_schemaFormat:"original"}),i=pe(t);yield*this._streamLog(e,r,i)}async*_streamLog(e,t,a){let{callbacks:r}=a;if(r===void 0)a.callbacks=[t];else if(Array.isArray(r))a.callbacks=r.concat([t]);else{let o=r.copy();o.addHandler(t,!0),a.callbacks=o}let i=this.stream(e,a);async function n(){try{let o=await i;for await(let l of o){let u=new Na({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(u)}}finally{await t.writer.close()}}let s=n();try{for await(let o of t)yield o}finally{await s}}streamEvents(e,t,a){let r;if(t.version==="v1")r=this._streamEventsV1(e,t,a);else if(t.version==="v2")r=this._streamEventsV2(e,t,a);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?lx(r):yt.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,a){let r=new _y({...a,autoClose:!1}),i=pe(t),n=i.runId??Ue();i.runId=n;let s=i.callbacks;if(s===void 0)i.callbacks=[r];else if(Array.isArray(s))i.callbacks=s.concat(r);else{let p=s.copy();p.addHandler(r,!0),i.callbacks=p}let o=new AbortController,l=this;async function u(){let p,f=null;try{t?.signal?"any"in AbortSignal?p=AbortSignal.any([o.signal,t.signal]):(p=t.signal,f=()=>{o.abort()},t.signal.addEventListener("abort",f,{once:!0})):p=o.signal;let m=await l.stream(e,{...i,signal:p}),g=r.tapOutputIterable(n,m);for await(let b of g)if(o.signal.aborted)break}finally{await r.finish(),p&&f&&p.removeEventListener("abort",f)}}let c=u(),d=!1,h;try{for await(let p of r){if(!d){p.data.input=e,d=!0,h=p.run_id,yield p;continue}p.run_id===h&&p.event.endsWith("_end")&&p.data?.input&&delete p.data.input,yield p}}finally{o.abort(),await c}}async*_streamEventsV1(e,t,a){let r,i=!1,n=pe(t),s=n.tags??[],o=n.metadata??{},l=n.runName??this.getName(),u=new Lc({...a,autoClose:!1,_schemaFormat:"streaming_events"}),c=new ky({...a}),d=this._streamLog(e,u,n);for await(let p of d){if(r?r=r.concat(p):r=Rc.fromRunLogPatch(p),r.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let b={...r.state},y={run_id:b.id,event:`on_${b.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};c.includeEvent(y,b.type)&&(yield y)}let f=p.ops.filter(b=>b.path.startsWith("/logs/")).map(b=>b.path.split("/")[2]),m=[...new Set(f)];for(let b of m){let y,_={},w=r.state.logs[b];if(w.end_time===void 0?w.streamed_output.length>0?y="stream":y="start":y="end",y==="start")w.inputs!==void 0&&(_.input=w.inputs);else if(y==="end")w.inputs!==void 0&&(_.input=w.inputs),_.output=w.final_output;else if(y==="stream"){let O=w.streamed_output.length;if(O!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${O} instead. Encountered in: "${w.name}"`);_={chunk:w.streamed_output[0]},w.streamed_output=[]}yield{event:`on_${w.type}_${y}`,name:w.name,run_id:w.id,tags:w.tags,metadata:w.metadata,data:_}}let{state:g}=r;if(g.streamed_output.length>0){let b=g.streamed_output.length;if(b!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${b} instead. Encountered in: "${g.name}"`);let y={chunk:g.streamed_output[0]};g.streamed_output=[];let _={event:`on_${g.type}_stream`,run_id:g.id,tags:s,metadata:o,name:l,data:y};c.includeEvent(_,g.type)&&(yield _)}}let h=r?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};c.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return Dc(e)}withListeners({onStart:e,onEnd:t,onError:a}){return new Nr({bound:this,config:{},configFactories:[r=>({callbacks:[new Uc({config:r,onStart:e,onEnd:t,onError:a})]})]})}asTool(e){return hx(this,e)}},Nr=class tO extends ge{static lc_name(){return"RunnableBinding"}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){let a=Wt(this.config,...t);return Wt(a,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(a))):[])}bind(t){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...t},config:this.config})}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new fd({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t?.stopAfterAttempt,...t})}async invoke(t,a){return this.bound.invoke(t,await this._mergeConfig(pe(a),this.kwargs))}async batch(t,a,r){let i=Array.isArray(a)?await Promise.all(a.map(async n=>this._mergeConfig(pe(n),this.kwargs))):await this._mergeConfig(pe(a),this.kwargs);return this.bound.batch(t,i,r)}_concatOutputChunks(t,a){return this.bound._concatOutputChunks(t,a)}async*_streamIterator(t,a){yield*this.bound._streamIterator(t,await this._mergeConfig(pe(a),this.kwargs))}async stream(t,a){return this.bound.stream(t,await this._mergeConfig(pe(a),this.kwargs))}async*transform(t,a){yield*this.bound.transform(t,await this._mergeConfig(pe(a),this.kwargs))}streamEvents(t,a,r){let i=this,n=async function*(){yield*i.bound.streamEvents(t,{...await i._mergeConfig(pe(a),i.kwargs),version:a.version},r)};return yt.fromAsyncGenerator(n())}static isRunnableBinding(t){return t.bound&&ge.isRunnable(t.bound)}withListeners({onStart:t,onEnd:a,onError:r}){return new tO({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[i=>({callbacks:[new Uc({config:i,onStart:t,onEnd:a,onError:r})]})]})}},O0=class fp extends ge{static lc_name(){return"RunnableEach"}constructor(t){super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=t.bound}bind(t){return new fp({bound:this.bound.bind(t)})}async invoke(t,a){return this._callWithConfig(this._invoke.bind(this),t,a)}async _invoke(t,a,r){return this.bound.batch(t,Pe(a,{callbacks:r?.getChild()}))}withListeners({onStart:t,onEnd:a,onError:r}){return new fp({bound:this.bound.withListeners({onStart:t,onEnd:a,onError:r})})}},fd=class extends Nr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,a){let r=e>1?`retry:attempt:${e}`:void 0;return Pe(t,{callbacks:a?.getChild(r)})}async _invoke(e,t,a){return(0,pd.default)(r=>super.invoke(e,this._patchConfigForRetry(r,t,a)),{onFailedAttempt:r=>this.onFailedAttempt(r,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,a,r){let i={};try{await(0,pd.default)(async n=>{let s=e.map((d,h)=>h).filter(d=>i[d.toString()]===void 0||i[d.toString()]instanceof Error),o=s.map(d=>e[d]),l=s.map(d=>this._patchConfigForRetry(n,t?.[d],a?.[d])),u=await super.batch(o,l,{...r,returnExceptions:!0}),c;for(let d=0;d<u.length;d+=1){let h=u[d],p=s[d];h instanceof Error&&c===void 0&&(c=h,c.input=o[d]),i[p.toString()]=h}if(c)throw c;return u},{onFailedAttempt:n=>this.onFailedAttempt(n,n.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(n){if(r?.returnExceptions!==!0)throw n}return Object.keys(i).sort((n,s)=>parseInt(n,10)-parseInt(s,10)).map(n=>i[parseInt(n,10)])}async batch(e,t,a){return this._batchWithConfig(this._batch.bind(this),e,t,a)}},Ma=class Os extends ge{static lc_name(){return"RunnableSequence"}constructor(t){super(t),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,a){let r=pe(a),i=await(await $t(r))?.handleChainStart(this.toJSON(),De(t,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let n=t,s;try{let o=[this.first,...this.middle];for(let l=0;l<o.length;l+=1){let u=o[l].invoke(n,Pe(r,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));n=await tr(u,a?.signal)}if(a?.signal?.aborted)throw new Error("Aborted");s=await this.last.invoke(n,Pe(r,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(De(s,"output")),s}async batch(t,a,r){let i=this._getOptionsList(a??{},t.length),n=await Promise.all(i.map($t)),s=await Promise.all(n.map(async(l,u)=>{let c=await l?.handleChainStart(this.toJSON(),De(t[u],"input"),i[u].runId,void 0,void 0,void 0,i[u].runName);return delete i[u].runId,c})),o=t;try{for(let l=0;l<this.steps.length;l+=1){let u=this.steps[l].batch(o,s.map((c,d)=>{let h=c?.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`);return Pe(i[d],{callbacks:h})}),r);o=await tr(u,i[0]?.signal)}}catch(l){throw await Promise.all(s.map(u=>u?.handleChainError(l))),l}return await Promise.all(s.map(l=>l?.handleChainEnd(De(o,"output")))),o}_concatOutputChunks(t,a){return this.last._concatOutputChunks(t,a)}async*_streamIterator(t,a){let r=await $t(a),{runId:i,...n}=a??{},s=await r?.handleChainStart(this.toJSON(),De(t,"input"),i,void 0,void 0,void 0,n?.runName),o=[this.first,...this.middle,this.last],l=!0,u;async function*c(){yield t}try{let d=o[0].transform(c(),Pe(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let h=1;h<o.length;h+=1)d=await o[h].transform(d,Pe(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${h+1}`)}));for await(let h of d)if(a?.signal?.throwIfAborted(),yield h,l)if(u===void 0)u=h;else try{u=this._concatOutputChunks(u,h)}catch{u=void 0,l=!1}}catch(d){throw await s?.handleChainError(d),d}await s?.handleChainEnd(De(u,"output"))}getGraph(t){let a=new In,r=null;return this.steps.forEach((i,n)=>{let s=i.getGraph(t);n!==0&&s.trimFirstNode(),n!==this.steps.length-1&&s.trimLastNode(),a.extend(s);let o=s.firstNode();if(!o)throw new Error(`Runnable ${i} has no first node`);r&&a.addEdge(r,o),r=s.lastNode()}),a}pipe(t){return Os.isRunnableSequence(t)?new Os({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new Os({first:this.first,middle:[...this.middle,this.last],last:bt(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&ge.isRunnable(t)}static from([t,...a],r){let i={};return typeof r=="string"?i.name=r:r!==void 0&&(i=r),new Os({...i,first:bt(t),middle:a.slice(0,-1).map(bt),last:bt(a[a.length-1])})}},$n=class aO extends ge{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[a,r]of Object.entries(t.steps))this.steps[a]=bt(r)}static from(t){return new aO({steps:t})}async invoke(t,a){let r=pe(a),i=await(await $t(r))?.handleChainStart(this.toJSON(),{input:t},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let n={};try{let s=Object.entries(this.steps).map(async([o,l])=>{n[o]=await l.invoke(t,Pe(r,{callbacks:i?.getChild(`map:key:${o}`)}))});await tr(Promise.all(s),a?.signal)}catch(s){throw await i?.handleChainError(s),s}return await i?.handleChainEnd(n),n}async*_transform(t,a,r){let i={...this.steps},n=py(t,Object.keys(i).length),s=new Map(Object.entries(i).map(([o,l],u)=>{let c=l.transform(n[u],Pe(r,{callbacks:a?.getChild(`map:key:${o}`)}));return[o,c.next().then(d=>({key:o,gen:c,result:d}))]}));for(;s.size;){let o=Promise.race(s.values()),{key:l,result:u,gen:c}=await tr(o,r?.signal);s.delete(l),u.done||(yield{[l]:u.value},s.set(l,c.next().then(d=>({key:l,gen:c,result:d}))))}}transform(t,a){return this._transformStreamWithConfig(t,this._transform.bind(this),a)}async stream(t,a){async function*r(){yield t}let i=pe(a),n=new Sr({generator:this.transform(r(),i),config:i});return await n.setup,yt.fromAsyncGenerator(n)}},k0=class rO extends ge{constructor(t){if(super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Su(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,a){let[r]=this._getOptionsList(a??{},1),i=await $t(r),n=this.func(Pe(r,{callbacks:i}),t);return tr(n,r?.signal)}async*_streamIterator(t,a){let[r]=this._getOptionsList(a??{},1),i=await this.invoke(t,a);if(dd(i)){for await(let n of i)r?.signal?.throwIfAborted(),yield n;return}if(w0(i)){for(;;){r?.signal?.throwIfAborted();let n=i.next();if(n.done)break;yield n.value}return}yield i}static from(t){return new rO({func:t})}},Lo=class iO extends ge{static lc_name(){return"RunnableLambda"}constructor(t){if(Su(t.func))return k0.from(t.func);super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),dx(t.func),this.func=t.func}static from(t){return new iO({func:t})}async _invoke(t,a,r){return new Promise((i,n)=>{let s=Pe(a,{callbacks:r?.getChild(),recursionLimit:(a?.recursionLimit??Oo)-1});gt.runWithConfig(Ai(s),async()=>{try{let o=await this.func(t,{...s});if(o&&ge.isRunnable(o)){if(a?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(t,{...s,recursionLimit:(s.recursionLimit??Oo)-1})}else if(dd(o)){let l;for await(let u of hd(s,o))if(a?.signal?.throwIfAborted(),l===void 0)l=u;else try{l=this._concatOutputChunks(l,u)}catch{l=u}o=l}else if(_0(o)){let l;for(let u of v0(s,o))if(a?.signal?.throwIfAborted(),l===void 0)l=u;else try{l=this._concatOutputChunks(l,u)}catch{l=u}o=l}i(o)}catch(o){n(o)}})})}async invoke(t,a){return this._callWithConfig(this._invoke.bind(this),t,a)}async*_transform(t,a,r){let i;for await(let o of t)if(i===void 0)i=o;else try{i=this._concatOutputChunks(i,o)}catch{i=o}let n=Pe(r,{callbacks:a?.getChild(),recursionLimit:(r?.recursionLimit??Oo)-1}),s=await new Promise((o,l)=>{gt.runWithConfig(Ai(n),async()=>{try{let u=await this.func(i,{...n,config:n});o(u)}catch(u){l(u)}})});if(s&&ge.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await s.stream(i,n);for await(let l of o)yield l}else if(dd(s))for await(let o of hd(n,s))r?.signal?.throwIfAborted(),yield o;else if(_0(s))for(let o of v0(n,s))r?.signal?.throwIfAborted(),yield o;else yield s}transform(t,a){return this._transformStreamWithConfig(t,this._transform.bind(this),a)}async stream(t,a){async function*r(){yield t}let i=pe(a),n=new Sr({generator:this.transform(r(),i),config:i});return await n.setup,yt.fromAsyncGenerator(n)}},E0=class extends ge{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let a=pe(t),r=await $t(a),{runId:i,...n}=a,s=await r?.handleChainStart(this.toJSON(),De(e,"input"),i,void 0,void 0,void 0,n?.runName),o=Pe(n,{callbacks:s?.getChild()});return await gt.runWithConfig(o,async()=>{let l;for(let u of this.runnables()){a?.signal?.throwIfAborted();try{let c=await u.invoke(e,o);return await s?.handleChainEnd(De(c,"output")),c}catch(c){l===void 0&&(l=c)}}throw l===void 0?new Error("No error stored at end of fallback."):(await s?.handleChainError(l),l)})}async*_streamIterator(e,t){let a=pe(t),r=await $t(a),{runId:i,...n}=a,s=await r?.handleChainStart(this.toJSON(),De(e,"input"),i,void 0,void 0,void 0,n?.runName),o,l;for(let c of this.runnables()){a?.signal?.throwIfAborted();let d=Pe(n,{callbacks:s?.getChild()});try{let h=await c.stream(e,d);l=hd(d,h);break}catch(h){o===void 0&&(o=h)}}if(l===void 0){let c=o??new Error("No error stored at end of fallback.");throw await s?.handleChainError(c),c}let u;try{for await(let c of l){yield c;try{u=u===void 0?u:this._concatOutputChunks(u,c)}catch{u=void 0}}}catch(c){throw await s?.handleChainError(c),c}await s?.handleChainEnd(De(u,"output"))}async batch(e,t,a){if(a?.returnExceptions)throw new Error("Not implemented.");let r=this._getOptionsList(t??{},e.length),i=await Promise.all(r.map(o=>$t(o))),n=await Promise.all(i.map(async(o,l)=>{let u=await o?.handleChainStart(this.toJSON(),De(e[l],"input"),r[l].runId,void 0,void 0,void 0,r[l].runName);return delete r[l].runId,u})),s;for(let o of this.runnables()){r[0].signal?.throwIfAborted();try{let l=await o.batch(e,n.map((u,c)=>Pe(r[c],{callbacks:u?.getChild()})),a);return await Promise.all(n.map((u,c)=>u?.handleChainEnd(De(l[c],"output")))),l}catch(l){s===void 0&&(s=l)}}throw s?(await Promise.all(n.map(o=>o?.handleChainError(s))),s):new Error("No error stored at end of fallbacks.")}},md=class extends ge{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof $n&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let a=await this.mapper.invoke(e,t);return{...e,...a}}async*_transform(e,t,a){let r=this.mapper.getStepsKeys(),[i,n]=py(e),s=this.mapper.transform(n,Pe(a,{callbacks:t?.getChild()})),o=s.next();for await(let l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let u=Object.fromEntries(Object.entries(l).filter(([c])=>!r.includes(c)));Object.keys(u).length>0&&(yield u)}yield(await o).value;for await(let l of s)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*a(){yield e}let r=pe(t),i=new Sr({generator:this.transform(a(),r),config:r});return await i.setup,yt.fromAsyncGenerator(i)}},x0=class extends ge{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(a=>[a,e[a]]).filter(a=>a[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let a=await this._pick(t);a!==void 0&&(yield a)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*a(){yield e}let r=pe(t),i=new Sr({generator:this.transform(a(),r),config:r});return await i.setup,yt.fromAsyncGenerator(i)}},gd=class extends Nr{constructor(e){let t=Ma.from([Lo.from(async a=>{let r;if(mn(a))try{r=await ud(this.schema,a.args)}catch{throw new co("Received tool input did not match expected schema",JSON.stringify(a.args))}else r=a;return r}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}}),Mo,yd,bd,P0,Tn=v(()=>{ca(),mo(),er(),Mo=class extends bi{},yd=class extends Mo{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Pr(this.value)]}},bd=class extends Mo{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Jg(this.messages)}toChatMessages(){return this.messages}},P0=class extends Mo{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new Pr({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}}),Nn,Uo=v(()=>{Tn(),Un(),Nn=class extends Go{async formatPromptValue(e){let t=await this.format(e);return new yd(t)}}});function _d(e){return typeof e=="function"}function px(e){return Cr(e)?"array":typeof e}function vd(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function A0(e,t){return e!=null&&typeof e=="object"&&t in e}function fx(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}function mx(e,t){return j0.call(e,t)}function gx(e){return!mx(I0,e)}function yx(e){return String(e).replace(/[&<>"'`=\/]/g,function(t){return $0[t]})}function bx(e,t){if(!e)return[];var a=!1,r=[],i=[],n=[],s=!1,o=!1,l="",u=0;function c(){if(s&&!o)for(;n.length;)delete i[n.pop()];else n=[];s=!1,o=!1}var d,h,p;function f(E){if(typeof E=="string"&&(E=E.split(N0,2)),!Cr(E)||E.length!==2)throw new Error("Invalid tags: "+E);d=new RegExp(vd(E[0])+"\\s*"),h=new RegExp("\\s*"+vd(E[1])),p=new RegExp("\\s*"+vd("}"+E[1]))}f(t||_t.tags);for(var m=new Cn(e),g,b,y,_,w,O;!m.eos();){if(g=m.pos,y=m.scanUntil(d),y)for(var j=0,S=y.length;j<S;++j)_=y.charAt(j),gx(_)?(n.push(i.length),l+=_):(o=!0,a=!0,l+=" "),i.push(["text",_,g,g+1]),g+=1,_===`
`&&(c(),l="",u=0,a=!1);if(!m.scan(d))break;if(s=!0,b=m.scan(R0)||"name",m.scan(T0),b==="="?(y=m.scanUntil(wd),m.scan(wd),m.scanUntil(h)):b==="{"?(y=m.scanUntil(p),m.scan(C0),m.scanUntil(h),b="&"):y=m.scanUntil(h),!m.scan(h))throw new Error("Unclosed tag at "+m.pos);if(b==">"?w=[b,y,g,m.pos,l,u,a]:w=[b,y,g,m.pos],u++,i.push(w),b==="#"||b==="^")r.push(w);else if(b==="/"){if(O=r.pop(),!O)throw new Error('Unopened section "'+y+'" at '+g);if(O[1]!==y)throw new Error('Unclosed section "'+O[1]+'" at '+g)}else b==="name"||b==="{"||b==="&"?o=!0:b==="="&&f(y)}if(c(),O=r.pop(),O)throw new Error('Unclosed section "'+O[1]+'" at '+m.pos);return vx(_x(i))}function _x(e){for(var t=[],a,r,i=0,n=e.length;i<n;++i)a=e[i],a&&(a[0]==="text"&&r&&r[0]==="text"?(r[1]+=a[1],r[3]=a[3]):(t.push(a),r=a));return t}function vx(e){for(var t=[],a=t,r=[],i,n,s=0,o=e.length;s<o;++s)switch(i=e[s],i[0]){case"#":case"^":a.push(i),r.push(i),a=i[4]=[];break;case"/":n=r.pop(),n[5]=i[2],a=r.length>0?r[r.length-1][4]:t;break;default:a.push(i)}return t}function Cn(e){this.string=e,this.tail=e,this.pos=0}function ji(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function it(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}var S0,Cr,j0,I0,$0,T0,N0,wd,C0,R0,_t,Ii,Do,wx=v(()=>{S0=Object.prototype.toString,Cr=Array.isArray||function(e){return S0.call(e)==="[object Array]"},j0=RegExp.prototype.test,I0=/\S/,$0={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},T0=/\s*/,N0=/\s+/,wd=/\s*=/,C0=/\s*\}/,R0=/#|\^|\/|>|\{|&|=|!/,Cn.prototype.eos=function(){return this.tail===""},Cn.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var a=t[0];return this.tail=this.tail.substring(a.length),this.pos+=a.length,a},Cn.prototype.scanUntil=function(e){var t=this.tail.search(e),a;switch(t){case-1:a=this.tail,this.tail="";break;case 0:a="";break;default:a=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=a.length,a},ji.prototype.push=function(e){return new ji(e,this)},ji.prototype.lookup=function(e){var t=this.cache,a;if(t.hasOwnProperty(e))a=t[e];else{for(var r=this,i,n,s,o=!1;r;){if(e.indexOf(".")>0)for(i=r.view,n=e.split("."),s=0;i!=null&&s<n.length;)s===n.length-1&&(o=A0(i,n[s])||fx(i,n[s])),i=i[n[s++]];else i=r.view[e],o=A0(r.view,e);if(o){a=i;break}r=r.parent}t[e]=a}return _d(a)&&(a=a.call(this.view)),a},it.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()},it.prototype.parse=function(e,t){var a=this.templateCache,r=e+":"+(t||_t.tags).join(":"),i=typeof a<"u",n=i?a.get(r):void 0;return n==null&&(n=bx(e,t),i&&a.set(r,n)),n},it.prototype.render=function(e,t,a,r){var i=this.getConfigTags(r),n=this.parse(e,i),s=t instanceof ji?t:new ji(t,void 0);return this.renderTokens(n,s,a,e,r)},it.prototype.renderTokens=function(e,t,a,r,i){for(var n="",s,o,l,u=0,c=e.length;u<c;++u)l=void 0,s=e[u],o=s[0],o==="#"?l=this.renderSection(s,t,a,r,i):o==="^"?l=this.renderInverted(s,t,a,r,i):o===">"?l=this.renderPartial(s,t,a,i):o==="&"?l=this.unescapedValue(s,t):o==="name"?l=this.escapedValue(s,t,i):o==="text"&&(l=this.rawValue(s)),l!==void 0&&(n+=l);return n},it.prototype.renderSection=function(e,t,a,r,i){var n=this,s="",o=t.lookup(e[1]);function l(d){return n.render(d,t,a,i)}if(o){if(Cr(o))for(var u=0,c=o.length;u<c;++u)s+=this.renderTokens(e[4],t.push(o[u]),a,r,i);else if(typeof o=="object"||typeof o=="string"||typeof o=="number")s+=this.renderTokens(e[4],t.push(o),a,r,i);else if(_d(o)){if(typeof r!="string")throw new Error("Cannot use higher-order sections without the original template");o=o.call(t.view,r.slice(e[3],e[5]),l),o!=null&&(s+=o)}else s+=this.renderTokens(e[4],t,a,r,i);return s}},it.prototype.renderInverted=function(e,t,a,r,i){var n=t.lookup(e[1]);if(!n||Cr(n)&&n.length===0)return this.renderTokens(e[4],t,a,r,i)},it.prototype.indentPartial=function(e,t,a){for(var r=t.replace(/[^ \t]/g,""),i=e.split(`
`),n=0;n<i.length;n++)i[n].length&&(n>0||!a)&&(i[n]=r+i[n]);return i.join(`
`)},it.prototype.renderPartial=function(e,t,a,r){if(a){var i=this.getConfigTags(r),n=_d(a)?a(e[1]):a[e[1]];if(n!=null){var s=e[6],o=e[5],l=e[4],u=n;o==0&&l&&(u=this.indentPartial(n,l,s));var c=this.parse(u,i);return this.renderTokens(c,t,a,u,r)}}},it.prototype.unescapedValue=function(e,t){var a=t.lookup(e[1]);if(a!=null)return a},it.prototype.escapedValue=function(e,t,a){var r=this.getConfigEscape(a)||_t.escape,i=t.lookup(e[1]);if(i!=null)return typeof i=="number"&&r===_t.escape?String(i):r(i)},it.prototype.rawValue=function(e){return e[1]},it.prototype.getConfigTags=function(e){return Cr(e)?e:e&&typeof e=="object"?e.tags:void 0},it.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!Cr(e))return e.escape},_t={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Ii.templateCache=e},get templateCache(){return Ii.templateCache}},Ii=new it,_t.clearCache=function(){return Ii.clearCache()},_t.parse=function(e,t){return Ii.parse(e,t)},_t.render=function(e,t,a,r){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+px(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Ii.render(e,t,a,r)},_t.escape=yx,_t.Scanner=Cn,_t.Context=ji,_t.Writer=it,Do=_t});function L0(){Do.escape=e=>e}var Rn,Od,Fo,M0,U0,zo,D0,Kt,Bo,Ln,$i=v(()=>{wx(),uo(),Rn=e=>{let t=e.split(""),a=[],r=(n,s)=>{for(let o=s;o<t.length;o+=1)if(n.includes(t[o]))return o;return-1},i=0;for(;i<t.length;)if(t[i]==="{"&&i+1<t.length&&t[i+1]==="{")a.push({type:"literal",text:"{"}),i+=2;else if(t[i]==="}"&&i+1<t.length&&t[i+1]==="}")a.push({type:"literal",text:"}"}),i+=2;else if(t[i]==="{"){let n=r("}",i);if(n<0)throw new Error("Unclosed '{' in template.");a.push({type:"variable",name:t.slice(i+1,n).join("")}),i=n+1}else{if(t[i]==="}")throw new Error("Single '}' in template.");{let n=r("{}",i),s=(n<0?t.slice(i):t.slice(i,n)).join("");a.push({type:"literal",text:s}),i=n<0?t.length:n}}return a},Od=(e,t=[])=>{let a=[];for(let r of e)if(r[0]==="name"){let i=r[1].includes(".")?r[1].split(".")[0]:r[1];a.push({type:"variable",name:i})}else if(["#","&","^",">"].includes(r[0])){if(a.push({type:"variable",name:r[1]}),r[0]==="#"&&r.length>4&&Array.isArray(r[4])){let i=[...t,r[1]],n=Od(r[4],i);a.push(...n)}}else a.push({type:"literal",text:r[1]});return a},Fo=e=>{L0();let t=Do.parse(e);return Od(t)},M0=(e,t)=>Rn(e).reduce((a,r)=>{if(r.type==="variable"){if(r.name in t){let i=typeof t[r.name]=="string"?t[r.name]:JSON.stringify(t[r.name]);return a+i}throw new Error(`(f-string) Missing value for input ${r.name}`)}return a+r.text},""),U0=(e,t)=>(L0(),Do.render(e,t)),zo={"f-string":M0,mustache:U0},D0={"f-string":Rn,mustache:Fo},Kt=(e,t,a)=>{try{return zo[t](e,a)}catch(r){throw lo(r,"INVALID_PROMPT_INPUT")}},Bo=(e,t)=>D0[t](e),Ln=(e,t,a)=>{if(!(t in zo)){let r=Object.keys(zo);throw new Error(`Invalid template format. Got \`${t}\`;
                         should be one of ${r}`)}try{let r=a.reduce((i,n)=>(i[n]="foo",i),{});Array.isArray(e)?e.forEach(i=>{if(i.type==="text")Kt(i.text,t,r);else if(i.type==="image_url")if(typeof i.image_url=="string")Kt(i.image_url,t,r);else{let n=i.image_url.url;Kt(n,t,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(i,null,2)}`)}):Kt(e,t,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}}}),kd={};Ss(kd,{PromptTemplate:()=>Ua});var Ua,Mn=v(()=>{Uo(),$i(),Ua=class ks extends Nn{static lc_name(){return"PromptTemplate"}constructor(t){if(super(t),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),Ln(this.template,this.templateFormat,a)}}_getPromptType(){return"prompt"}async format(t){let a=await this.mergePartialAndUserVariables(t);return Kt(this.template,this.templateFormat,a)}static fromExamples(t,a,r,i=`

`,n=""){let s=[n,...t,a].join(i);return new ks({inputVariables:r,template:s})}static fromTemplate(t,a){let{templateFormat:r="f-string",...i}=a??{},n=new Set;return Bo(t,r).forEach(s=>{s.type==="variable"&&n.add(s.name)}),new ks({inputVariables:[...n],templateFormat:r,template:t,...i})}async partial(t){let a=this.inputVariables.filter(n=>!(n in t)),r={...this.partialVariables??{},...t},i={...this,inputVariables:a,partialVariables:r};return new ks(i)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(t){if(!t.template)throw new Error("Prompt template must have a template");return new ks({inputVariables:t.input_variables,template:t.template,templateFormat:t.template_format})}}}),Ox=v(()=>{He(),ki(),qt(),Oc(),Ec(),mo(),Pc(),Ac(),yn(),er()}),rr=v(()=>{ki(),qt(),Oc(),Ec(),mo(),Ac(),er(),Ox(),Pc(),Vg(),yn()}),Zo,F0=v(()=>{Tn(),Un(),$i(),Zo=class nO extends Go{static lc_name(){return"ImagePromptTemplate"}constructor(t){if(super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=t.template,this.templateFormat=t.templateFormat??this.templateFormat,this.validateTemplate=t.validateTemplate??this.validateTemplate,this.additionalContentFields=t.additionalContentFields,this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),Ln([{type:"image_url",image_url:this.template}],this.templateFormat,a)}}_getPromptType(){return"prompt"}async partial(t){let a=this.inputVariables.filter(n=>!(n in t)),r={...this.partialVariables??{},...t},i={...this,inputVariables:a,partialVariables:r};return new nO(i)}async format(t){let a={};for(let[s,o]of Object.entries(this.template))typeof o=="string"?a[s]=Kt(o,this.templateFormat,t):a[s]=o;let r=t.url||a.url,i=t.detail||a.detail;if(!r)throw new Error("Must provide either an image URL.");if(typeof r!="string")throw new Error("url must be a string.");let n={url:r};return i&&(n.detail=i),n}async formatPromptValue(t){let a=await this.format(t);return new P0(a)}}});function Ed(e,t){let a=[];for(let r of Object.values(e))if(typeof r=="string")Bo(r,t).forEach(i=>{i.type==="variable"&&a.push(i.name)});else if(Array.isArray(r))for(let i of r)typeof i=="string"?Bo(i,t).forEach(n=>{n.type==="variable"&&a.push(n.name)}):typeof i=="object"&&a.push(...Ed(i,t));else typeof r=="object"&&r!==null&&a.push(...Ed(r,t));return Array.from(new Set(a))}function xd(e,t,a){let r={};for(let[i,n]of Object.entries(e))if(typeof n=="string")r[i]=Kt(n,a,t);else if(Array.isArray(n)){let s=[];for(let o of n)typeof o=="string"?s.push(Kt(o,a,t)):typeof o=="object"&&s.push(xd(o,t,a));r[i]=s}else typeof n=="object"&&n!==null?r[i]=xd(n,t,a):r[i]=n;return r}var Pd,z0=v(()=>{He(),$i(),Pd=class extends ge{static lc_name(){return"DictPromptTemplate"}constructor(e){let t=e.templateFormat??"f-string",a=Ed(e.template,t);super({inputVariables:a,...e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","dict"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=t,this.inputVariables=a}async format(e){return xd(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}}});function kx(e){return e===null||typeof e!="object"||Array.isArray(e)?!1:Object.keys(e).length===1&&"text"in e&&typeof e.text=="string"}function Ex(e){return e===null||typeof e!="object"||Array.isArray(e)?!1:"image_url"in e&&(typeof e.image_url=="string"||typeof e.image_url=="object"&&e.image_url!==null&&"url"in e.image_url&&typeof e.image_url.url=="string")}function xx(e){return typeof e.formatMessages=="function"}function Px(e,t){if(xx(e)||mt(e))return e;if(Array.isArray(e)&&e[0]==="placeholder"){let i=e[1];if(t?.templateFormat==="mustache"&&typeof i=="string"&&i.slice(0,2)==="{{"&&i.slice(-2)==="}}"){let n=i.slice(2,-2);return new Ad({variableName:n,optional:!0})}else if(typeof i=="string"&&i[0]==="{"&&i[i.length-1]==="}"){let n=i.slice(1,-1);return new Ad({variableName:n,optional:!0})}throw new Error(`Invalid placeholder template for format ${t?.templateFormat??'"f-string"'}: "${e[1]}". Expected a variable name surrounded by ${t?.templateFormat==="mustache"?"double":"single"} curly braces.`)}let a=ha(e),r;if(typeof a.content=="string"?r=a.content:r=a.content.map(i=>"text"in i?{...i,text:i.text}:"image_url"in i?{...i,image_url:i.image_url}:i),a._getType()==="human")return jd.fromTemplate(r,t);if(a._getType()==="ai")return q0.fromTemplate(r,t);if(a._getType()==="system")return V0.fromTemplate(r,t);if(Ei.isInstance(a))return Z0.fromTemplate(a.content,a.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${a._getType()}".`)}function Ax(e){return e.constructor.lc_name()==="MessagesPlaceholder"}var qo,Ad,B0,Sd,Z0,Vo,jd,q0,V0,Wo,Ho=v(()=>{rr(),Tn(),He(),Uo(),Un(),Mn(),F0(),$i(),uo(),z0(),qo=class extends ge{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(a=>this.formatMessages(a),e,{...t,runType:"prompt"})}},Ad=class extends qo{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let r=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw r.name="InputFormatError",r}let a;try{Array.isArray(t)?a=t.map(ha):a=[ha(t)]}catch(r){let i=typeof t=="string"?t:JSON.stringify(t,null,2),n=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${r.message}`].join(`

`));throw n.name="InputFormatError",n.lc_error_code=r.lc_error_code,n}return a}},B0=class extends qo{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},Sd=class extends Go{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new bd(t)}},Z0=class extends B0{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new Ei(await this.prompt.format(e),this.role)}static fromTemplate(e,t,a){return new this(Ua.fromTemplate(e,{templateFormat:a?.templateFormat}),t)}},Vo=class extends qo{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let a=[];this.prompt.forEach(r=>{"inputVariables"in r&&(a=a.concat(r.inputVariables))}),this.inputVariables=a}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let a=t._messageClass();return new a({content:e})}else if(t.chatMessageClass){let a=t.chatMessageClass();return new a({content:e,role:this.getRoleFromMessageClass(a.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(Ua.fromTemplate(e,t));let a=[];for(let r of e)if(typeof r=="string")a.push(Ua.fromTemplate(r,t));else if(r!==null)if(kx(r)){let i="";typeof r.text=="string"&&(i=r.text??"");let n={...t,additionalContentFields:r};a.push(Ua.fromTemplate(i,n))}else if(Ex(r)){let i=r.image_url??"",n,s=[];if(typeof i=="string"){let o;t?.templateFormat==="mustache"?o=Fo(i):o=Rn(i);let l=o.flatMap(u=>u.type==="variable"?[u.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${i}`);s=[l[0]]}else s=[];i={url:i},n=new Zo({template:i,inputVariables:s,templateFormat:t?.templateFormat,additionalContentFields:r})}else if(typeof i=="object"){if("url"in i){let o;t?.templateFormat==="mustache"?o=Fo(i.url):o=Rn(i.url),s=o.flatMap(l=>l.type==="variable"?[l.name]:[])}else s=[];n=new Zo({template:i,inputVariables:s,templateFormat:t?.templateFormat,additionalContentFields:r})}else throw new Error("Invalid image template");a.push(n)}else typeof r=="object"&&a.push(new Pd({template:r,templateFormat:t?.templateFormat}));return new this({prompt:a,additionalOptions:t})}async format(e){if(this.prompt instanceof Nn){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let a of this.prompt){let r={};if(!("inputVariables"in a))throw new Error(`Prompt ${a} does not have inputVariables defined.`);for(let i of a.inputVariables)r||(r={[i]:e[i]}),r={...r,[i]:e[i]};if(a instanceof Nn){let i=await a.format(r),n;"additionalContentFields"in a&&(n=a.additionalContentFields),i!==""&&t.push({...n,type:"text",text:i})}else if(a instanceof Zo){let i=await a.format(r),n;"additionalContentFields"in a&&(n=a.additionalContentFields),t.push({...n,type:"image_url",image_url:i})}else if(a instanceof Pd){let i=await a.format(r),n;"additionalContentFields"in a&&(n=a.additionalContentFields),t.push({...n,...i})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},jd=class extends Vo{static _messageClass(){return Pr}static lc_name(){return"HumanMessagePromptTemplate"}},q0=class extends Vo{static _messageClass(){return Oi}static lc_name(){return"AIMessagePromptTemplate"}},V0=class extends Vo{static _messageClass(){return go}static lc_name(){return"SystemMessagePromptTemplate"}},Wo=class nu extends Sd{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(t){if(super(t),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),t.templateFormat==="mustache"&&t.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,t),this.validateTemplate){let a=new Set;for(let o of this.promptMessages)if(!(o instanceof Zt))for(let l of o.inputVariables)a.add(l);let r=this.inputVariables,i=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),n=new Set([...i].filter(o=>!a.has(o)));if(n.size>0)throw new Error(`Input variables \`${[...n]}\` are not used in any of the prompt messages.`);let s=new Set([...a].filter(o=>!i.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(t,a){if(typeof t.content=="string")return t;let r=await Promise.all(t.content.map(async i=>{if(i.type!=="image_url")return i;let n="";typeof i.image_url=="string"?n=i.image_url:n=i.image_url.url;let s=await Ua.fromTemplate(n,{templateFormat:this.templateFormat}).format(a);return typeof i.image_url!="string"&&"url"in i.image_url?i.image_url.url=s:i.image_url=s,i}));return t.content=r,t}async formatMessages(t){let a=await this.mergePartialAndUserVariables(t),r=[];for(let i of this.promptMessages)if(i instanceof Zt)r.push(await this._parseImagePrompts(i,a));else{let n;this.templateFormat==="mustache"?n={...a}:n=i.inputVariables.reduce((o,l)=>{if(!(l in a)&&!(Ax(i)&&i.optional))throw lo(new Error(`Missing value for input variable \`${l.toString()}\``),"INVALID_PROMPT_INPUT");return o[l]=a[l],o},{});let s=await i.formatMessages(n);r=r.concat(s)}return r}async partial(t){let a=this.inputVariables.filter(n=>!(n in t)),r={...this.partialVariables??{},...t},i={...this,inputVariables:a,partialVariables:r};return new nu(i)}static fromTemplate(t,a){let r=Ua.fromTemplate(t,a),i=new jd({prompt:r});return this.fromMessages([i])}static fromMessages(t,a){let r=t.reduce((s,o)=>s.concat(o instanceof nu?o.promptMessages:[Px(o,a)]),[]),i=t.reduce((s,o)=>o instanceof nu?Object.assign(s,o.partialVariables):s,Object.create(null)),n=new Set;for(let s of r)if(!(s instanceof Zt))for(let o of s.inputVariables)o in i||n.add(o);return new this({...a,inputVariables:[...n],promptMessages:r,partialVariables:i,templateFormat:a?.templateFormat})}static fromPromptMessages(t){return this.fromMessages(t)}}}),W0={};Ss(W0,{FewShotChatMessagePromptTemplate:()=>G0,FewShotPromptTemplate:()=>H0});var H0,G0,J0=v(()=>{Uo(),$i(),Mn(),Ho(),H0=class mp extends Nn{constructor(t){if(super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,t),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),Ln(this.prefix+this.suffix,this.templateFormat,a)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(t){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(t){let a=this.inputVariables.filter(n=>!(n in t)),r={...this.partialVariables??{},...t},i={...this,inputVariables:a,partialVariables:r};return new mp(i)}async format(t){let a=await this.mergePartialAndUserVariables(t),r=await this.getExamples(a),i=await Promise.all(r.map(s=>this.examplePrompt.format(s))),n=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return Kt(n,this.templateFormat,a)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(t){let{example_prompt:a}=t;if(!a)throw new Error("Missing example prompt");let r=await Ua.deserialize(a),i;if(Array.isArray(t.examples))i=t.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new mp({inputVariables:t.input_variables,examplePrompt:r,examples:i,exampleSeparator:t.example_separator,prefix:t.prefix,suffix:t.suffix,templateFormat:t.template_format})}},G0=class sO extends Sd{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(t){if(super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=t.examples,this.examplePrompt=t.examplePrompt,this.exampleSeparator=t.exampleSeparator??`

`,this.exampleSelector=t.exampleSelector,this.prefix=t.prefix??"",this.suffix=t.suffix??"",this.templateFormat=t.templateFormat??"f-string",this.validateTemplate=t.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let a=this.inputVariables;this.partialVariables&&(a=a.concat(Object.keys(this.partialVariables))),Ln(this.prefix+this.suffix,this.templateFormat,a)}}async getExamples(t){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(t);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(t){let a=await this.mergePartialAndUserVariables(t),r=await this.getExamples(a);r=r.map(n=>{let s={};return this.examplePrompt.inputVariables.forEach(o=>{s[o]=n[o]}),s});let i=[];for(let n of r){let s=await this.examplePrompt.formatMessages(n);i.push(...s)}return i}async format(t){let a=await this.mergePartialAndUserVariables(t),r=await this.getExamples(a),i=(await Promise.all(r.map(s=>this.examplePrompt.formatMessages(s)))).flat().map(s=>s.content),n=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return Kt(n,this.templateFormat,a)}async partial(t){let a=this.inputVariables.filter(n=>!(n in t)),r={...this.partialVariables??{},...t},i={...this,inputVariables:a,partialVariables:r};return new sO(i)}}}),Go,Un=v(()=>{He(),Go=class extends ge{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},a={};for(let[r,i]of Object.entries(t))typeof i=="string"?a[r]=i:a[r]=await i();return{...a,...e}}async invoke(e,t){let a={...this.metadata,...t?.metadata},r=[...this.tags??[],...t?.tags??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...t,tags:r,metadata:a,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await Promise.resolve().then(()=>(Mn(),kd));return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await Promise.resolve().then(()=>(Mn(),kd));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await Promise.resolve().then(()=>(J0(),W0));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}}),Sx=F(e=>{"use strict";e.byteLength=l,e.toByteArray=c,e.fromByteArray=p;var t=[],a=[],r=typeof Uint8Array<"u"?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0,s=i.length;n<s;++n)t[n]=i[n],a[i.charCodeAt(n)]=n;var n,s;a[45]=62,a[95]=63;function o(f){var m=f.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=f.indexOf("=");g===-1&&(g=m);var b=g===m?0:4-g%4;return[g,b]}function l(f){var m=o(f),g=m[0],b=m[1];return(g+b)*3/4-b}function u(f,m,g){return(m+g)*3/4-g}function c(f){var m,g=o(f),b=g[0],y=g[1],_=new r(u(f,b,y)),w=0,O=y>0?b-4:b,j;for(j=0;j<O;j+=4)m=a[f.charCodeAt(j)]<<18|a[f.charCodeAt(j+1)]<<12|a[f.charCodeAt(j+2)]<<6|a[f.charCodeAt(j+3)],_[w++]=m>>16&255,_[w++]=m>>8&255,_[w++]=m&255;return y===2&&(m=a[f.charCodeAt(j)]<<2|a[f.charCodeAt(j+1)]>>4,_[w++]=m&255),y===1&&(m=a[f.charCodeAt(j)]<<10|a[f.charCodeAt(j+1)]<<4|a[f.charCodeAt(j+2)]>>2,_[w++]=m>>8&255,_[w++]=m&255),_}function d(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function h(f,m,g){for(var b,y=[],_=m;_<g;_+=3)b=(f[_]<<16&16711680)+(f[_+1]<<8&65280)+(f[_+2]&255),y.push(d(b));return y.join("")}function p(f){for(var m,g=f.length,b=g%3,y=[],_=16383,w=0,O=g-b;w<O;w+=_)y.push(h(f,w,w+_>O?O:w+_));return b===1?(m=f[g-1],y.push(t[m>>2]+t[m<<4&63]+"==")):b===2&&(m=(f[g-2]<<8)+f[g-1],y.push(t[m>>10]+t[m>>4&63]+t[m<<2&63]+"=")),y.join("")}});Un(),Ho(),J0(),Un(),Ho(),Mn(),Uo(),$i(),F0(),He(),Ho(),z0();var Rr=class extends Error{constructor(e,t){let a=e??"";t?.lc_error_code&&(a=`${a}

Troubleshooting URL: https://langchain-ai.github.io/langgraphjs/troubleshooting/errors/${t.lc_error_code}/
`),super(a),Object.defineProperty(this,"lc_error_code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_error_code=t?.lc_error_code}},K0=class extends Rr{get is_bubble_up(){return!0}},jx=class extends Rr{constructor(e,t){super(e,t),this.name="GraphRecursionError"}static get unminifiable_name(){return"GraphRecursionError"}},X0=class extends Rr{constructor(e,t){super(e,t),this.name="GraphValueError"}static get unminifiable_name(){return"GraphValueError"}},Dn=class extends K0{constructor(e,t){super(JSON.stringify(e,null,2),t),Object.defineProperty(this,"interrupts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="GraphInterrupt",this.interrupts=e??[]}static get unminifiable_name(){return"GraphInterrupt"}},Y0=class extends Dn{constructor(e,t){super([{value:e,when:"during"}],t),this.name="NodeInterrupt"}static get unminifiable_name(){return"NodeInterrupt"}},Q0=class extends K0{constructor(e){super(),Object.defineProperty(this,"command",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ParentCommand",this.command=e}static get unminifiable_name(){return"ParentCommand"}};function Ix(e){return e!==void 0&&e.name===Q0.unminifiable_name}function Jo(e){return e!==void 0&&e.is_bubble_up===!0}function Fn(e){return e!==void 0&&[Dn.unminifiable_name,Y0.unminifiable_name].includes(e.name)}var e_=class extends Rr{constructor(e,t){super(e,t),this.name="EmptyInputError"}static get unminifiable_name(){return"EmptyInputError"}},ot=class extends Rr{constructor(e,t){super(e,t),this.name="EmptyChannelError"}static get unminifiable_name(){return"EmptyChannelError"}},xe=class extends Rr{constructor(e,t){super(e,t),this.name="InvalidUpdateError"}static get unminifiable_name(){return"InvalidUpdateError"}},$x=class extends Rr{constructor(e,t){super(e,t),this.name="UnreachableNodeError"}static get unminifiable_name(){return"UnreachableNodeError"}};la();function t_(e){return rk({clockseq:e})}function Ti(e,t){let a=t.replace(/-/g,"").match(/.{2}/g).map(r=>parseInt(r,16));return qs(e,new Uint8Array(a))}var Tx="__error__",Ko="__scheduled__",Nx="__interrupt__",Cx="__resume__";ca();var Rx=typeof window=="object"?window:{},ne="0123456789abcdef".split(""),Lx=[-2147483648,8388608,32768,128],Xt=[24,16,8,0],Fe=[];function Yt(e){e?(Fe[0]=Fe[16]=Fe[1]=Fe[2]=Fe[3]=Fe[4]=Fe[5]=Fe[6]=Fe[7]=Fe[8]=Fe[9]=Fe[10]=Fe[11]=Fe[12]=Fe[13]=Fe[14]=Fe[15]=0,this.blocks=Fe):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Yt.prototype.update=function(e){if(!this.finalized){var t=typeof e!="string";t&&e.constructor===Rx.ArrayBuffer&&(e=new Uint8Array(e));for(var a,r=0,i,n=e.length||0,s=this.blocks;r<n;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(i=this.start;r<n&&i<64;++r)s[i>>2]|=e[r]<<Xt[i++&3];else for(i=this.start;r<n&&i<64;++r)a=e.charCodeAt(r),a<128?s[i>>2]|=a<<Xt[i++&3]:a<2048?(s[i>>2]|=(192|a>>6)<<Xt[i++&3],s[i>>2]|=(128|a&63)<<Xt[i++&3]):a<55296||a>=57344?(s[i>>2]|=(224|a>>12)<<Xt[i++&3],s[i>>2]|=(128|a>>6&63)<<Xt[i++&3],s[i>>2]|=(128|a&63)<<Xt[i++&3]):(a=65536+((a&1023)<<10|e.charCodeAt(++r)&1023),s[i>>2]|=(240|a>>18)<<Xt[i++&3],s[i>>2]|=(128|a>>12&63)<<Xt[i++&3],s[i>>2]|=(128|a>>6&63)<<Xt[i++&3],s[i>>2]|=(128|a&63)<<Xt[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=s[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Yt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Lx[t&3],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Yt.prototype.hash=function(){var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4,n,s,o,l=this.blocks;for(s=16;s<80;++s)o=l[s-3]^l[s-8]^l[s-14]^l[s-16],l[s]=o<<1|o>>>31;for(s=0;s<20;s+=5)n=t&a|~t&r,o=e<<5|e>>>27,i=o+n+i+1518500249+l[s]<<0,t=t<<30|t>>>2,n=e&t|~e&a,o=i<<5|i>>>27,r=o+n+r+1518500249+l[s+1]<<0,e=e<<30|e>>>2,n=i&e|~i&t,o=r<<5|r>>>27,a=o+n+a+1518500249+l[s+2]<<0,i=i<<30|i>>>2,n=r&i|~r&e,o=a<<5|a>>>27,t=o+n+t+1518500249+l[s+3]<<0,r=r<<30|r>>>2,n=a&r|~a&i,o=t<<5|t>>>27,e=o+n+e+1518500249+l[s+4]<<0,a=a<<30|a>>>2;for(;s<40;s+=5)n=t^a^r,o=e<<5|e>>>27,i=o+n+i+1859775393+l[s]<<0,t=t<<30|t>>>2,n=e^t^a,o=i<<5|i>>>27,r=o+n+r+1859775393+l[s+1]<<0,e=e<<30|e>>>2,n=i^e^t,o=r<<5|r>>>27,a=o+n+a+1859775393+l[s+2]<<0,i=i<<30|i>>>2,n=r^i^e,o=a<<5|a>>>27,t=o+n+t+1859775393+l[s+3]<<0,r=r<<30|r>>>2,n=a^r^i,o=t<<5|t>>>27,e=o+n+e+1859775393+l[s+4]<<0,a=a<<30|a>>>2;for(;s<60;s+=5)n=t&a|t&r|a&r,o=e<<5|e>>>27,i=o+n+i-1894007588+l[s]<<0,t=t<<30|t>>>2,n=e&t|e&a|t&a,o=i<<5|i>>>27,r=o+n+r-1894007588+l[s+1]<<0,e=e<<30|e>>>2,n=i&e|i&t|e&t,o=r<<5|r>>>27,a=o+n+a-1894007588+l[s+2]<<0,i=i<<30|i>>>2,n=r&i|r&e|i&e,o=a<<5|a>>>27,t=o+n+t-1894007588+l[s+3]<<0,r=r<<30|r>>>2,n=a&r|a&i|r&i,o=t<<5|t>>>27,e=o+n+e-1894007588+l[s+4]<<0,a=a<<30|a>>>2;for(;s<80;s+=5)n=t^a^r,o=e<<5|e>>>27,i=o+n+i-899497514+l[s]<<0,t=t<<30|t>>>2,n=e^t^a,o=i<<5|i>>>27,r=o+n+r-899497514+l[s+1]<<0,e=e<<30|e>>>2,n=i^e^t,o=r<<5|r>>>27,a=o+n+a-899497514+l[s+2]<<0,i=i<<30|i>>>2,n=r^i^e,o=a<<5|a>>>27,t=o+n+t-899497514+l[s+3]<<0,r=r<<30|r>>>2,n=a^r^i,o=t<<5|t>>>27,e=o+n+e-899497514+l[s+4]<<0,a=a<<30|a>>>2;this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+a<<0,this.h3=this.h3+r<<0,this.h4=this.h4+i<<0},Yt.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4;return ne[e>>28&15]+ne[e>>24&15]+ne[e>>20&15]+ne[e>>16&15]+ne[e>>12&15]+ne[e>>8&15]+ne[e>>4&15]+ne[e&15]+ne[t>>28&15]+ne[t>>24&15]+ne[t>>20&15]+ne[t>>16&15]+ne[t>>12&15]+ne[t>>8&15]+ne[t>>4&15]+ne[t&15]+ne[a>>28&15]+ne[a>>24&15]+ne[a>>20&15]+ne[a>>16&15]+ne[a>>12&15]+ne[a>>8&15]+ne[a>>4&15]+ne[a&15]+ne[r>>28&15]+ne[r>>24&15]+ne[r>>20&15]+ne[r>>16&15]+ne[r>>12&15]+ne[r>>8&15]+ne[r>>4&15]+ne[r&15]+ne[i>>28&15]+ne[i>>24&15]+ne[i>>20&15]+ne[i>>16&15]+ne[i>>12&15]+ne[i>>8&15]+ne[i>>4&15]+ne[i&15]},Yt.prototype.toString=Yt.prototype.hex,Yt.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4;return[e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,a>>24&255,a>>16&255,a>>8&255,a&255,r>>24&255,r>>16&255,r>>8&255,r&255,i>>24&255,i>>16&255,i>>8&255,i&255]},Yt.prototype.array=Yt.prototype.digest,Yt.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var a_=!1,Mx=e=>(a_||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),a_=!0),new Yt(!0).update(e).hex()),M="0123456789abcdef".split(""),Ux=[-2147483648,8388608,32768,128],Qt=[24,16,8,0],Xo=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],ze=[];function ga(e,t){t?(ze[0]=ze[16]=ze[1]=ze[2]=ze[3]=ze[4]=ze[5]=ze[6]=ze[7]=ze[8]=ze[9]=ze[10]=ze[11]=ze[12]=ze[13]=ze[14]=ze[15]=0,this.blocks=ze):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}ga.prototype.update=function(e){if(!this.finalized){var t,a=typeof e;if(a!=="string"){if(a==="object"){if(e===null)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(e)))throw new Error(ERROR)}else throw new Error(ERROR);t=!0}for(var r,i=0,n,s=e.length,o=this.blocks;i<s;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(n=this.start;i<s&&n<64;++i)o[n>>>2]|=e[i]<<Qt[n++&3];else for(n=this.start;i<s&&n<64;++i)r=e.charCodeAt(i),r<128?o[n>>>2]|=r<<Qt[n++&3]:r<2048?(o[n>>>2]|=(192|r>>>6)<<Qt[n++&3],o[n>>>2]|=(128|r&63)<<Qt[n++&3]):r<55296||r>=57344?(o[n>>>2]|=(224|r>>>12)<<Qt[n++&3],o[n>>>2]|=(128|r>>>6&63)<<Qt[n++&3],o[n>>>2]|=(128|r&63)<<Qt[n++&3]):(r=65536+((r&1023)<<10|e.charCodeAt(++i)&1023),o[n>>>2]|=(240|r>>>18)<<Qt[n++&3],o[n>>>2]|=(128|r>>>12&63)<<Qt[n++&3],o[n>>>2]|=(128|r>>>6&63)<<Qt[n++&3],o[n>>>2]|=(128|r&63)<<Qt[n++&3]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=o[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},ga.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=Ux[t&3],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},ga.prototype.hash=function(){var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4,n=this.h5,s=this.h6,o=this.h7,l=this.blocks,u,c,d,h,p,f,m,g,b,y,_;for(u=16;u<64;++u)p=l[u-15],c=(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3,p=l[u-2],d=(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10,l[u]=l[u-16]+c+l[u-7]+d<<0;for(_=t&a,u=0;u<64;u+=4)this.first?(this.is224?(g=300032,p=l[0]-1413257819,o=p-150054599<<0,r=p+24177077<<0):(g=704751109,p=l[0]-210244248,o=p-1521486534<<0,r=p+143694565<<0),this.first=!1):(c=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),g=e&t,h=g^e&a^_,m=i&n^~i&s,p=o+d+m+Xo[u]+l[u],f=c+h,o=r+p<<0,r=p+f<<0),c=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),b=r&e,h=b^r&t^g,m=s&o^~s&i,p=n+d+m+Xo[u+1]+l[u+1],f=c+h,s=a+p<<0,a=p+f<<0,c=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),y=a&r,h=y^a&e^b,m=n&s^~n&o,p=i+d+m+Xo[u+2]+l[u+2],f=c+h,n=t+p<<0,t=p+f<<0,c=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(n>>>6|n<<26)^(n>>>11|n<<21)^(n>>>25|n<<7),_=t&a,h=_^t&r^y,m=n&s^~n&o,p=i+d+m+Xo[u+3]+l[u+3],f=c+h,i=e+p<<0,e=p+f<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+a<<0,this.h3=this.h3+r<<0,this.h4=this.h4+i<<0,this.h5=this.h5+n<<0,this.h6=this.h6+s<<0,this.h7=this.h7+o<<0},ga.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4,n=this.h5,s=this.h6,o=this.h7,l=M[e>>>28&15]+M[e>>>24&15]+M[e>>>20&15]+M[e>>>16&15]+M[e>>>12&15]+M[e>>>8&15]+M[e>>>4&15]+M[e&15]+M[t>>>28&15]+M[t>>>24&15]+M[t>>>20&15]+M[t>>>16&15]+M[t>>>12&15]+M[t>>>8&15]+M[t>>>4&15]+M[t&15]+M[a>>>28&15]+M[a>>>24&15]+M[a>>>20&15]+M[a>>>16&15]+M[a>>>12&15]+M[a>>>8&15]+M[a>>>4&15]+M[a&15]+M[r>>>28&15]+M[r>>>24&15]+M[r>>>20&15]+M[r>>>16&15]+M[r>>>12&15]+M[r>>>8&15]+M[r>>>4&15]+M[r&15]+M[i>>>28&15]+M[i>>>24&15]+M[i>>>20&15]+M[i>>>16&15]+M[i>>>12&15]+M[i>>>8&15]+M[i>>>4&15]+M[i&15]+M[n>>>28&15]+M[n>>>24&15]+M[n>>>20&15]+M[n>>>16&15]+M[n>>>12&15]+M[n>>>8&15]+M[n>>>4&15]+M[n&15]+M[s>>>28&15]+M[s>>>24&15]+M[s>>>20&15]+M[s>>>16&15]+M[s>>>12&15]+M[s>>>8&15]+M[s>>>4&15]+M[s&15];return this.is224||(l+=M[o>>>28&15]+M[o>>>24&15]+M[o>>>20&15]+M[o>>>16&15]+M[o>>>12&15]+M[o>>>8&15]+M[o>>>4&15]+M[o&15]),l},ga.prototype.toString=ga.prototype.hex,ga.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,i=this.h4,n=this.h5,s=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,e&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),l},ga.prototype.array=ga.prototype.digest,ga.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},er();var Dx=(...e)=>Mx(e.join("_")),Fx=class{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:Dx})}makeDefaultKeyEncoder(e){this.keyEncoder=e}},zx=new Map,Bx=class oO extends Fx{constructor(t){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=t??new Map}lookup(t,a){return Promise.resolve(this.cache.get(this.keyEncoder(t,a))??null)}async update(t,a,r){this.cache.set(this.keyEncoder(t,a),r)}static global(){return new oO(zx)}};_i(),Ar(),Qg(),ca(),rr(),He(),kn(),ca(),Tn(),er(),kn();var Zx=Mt(Sx(),1),qx=Object.defineProperty,Vx=(e,t,a)=>t in e?qx(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,Wx=(e,t,a)=>(Vx(e,typeof t!="symbol"?t+"":t,a),a);function Hx(e,t){let a=Array.from({length:e.length},(r,i)=>({start:i,end:i+1}));for(;a.length>1;){let r=null;for(let i=0;i<a.length-1;i++){let n=e.slice(a[i].start,a[i+1].end),s=t.get(n.join(","));s!=null&&(r==null||s<r[0])&&(r=[s,i])}if(r!=null){let i=r[1];a[i]={start:a[i].start,end:a[i+1].end},a.splice(i+1,1)}else break}return a}function Gx(e,t){return e.length===1?[t.get(e.join(","))]:Hx(e,t).map(a=>t.get(e.slice(a.start,a.end).join(","))).filter(a=>a!=null)}function Jx(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Id=class{constructor(e,t){fr(this,"specialTokens"),fr(this,"inverseSpecialTokens"),fr(this,"patStr"),fr(this,"textEncoder",new TextEncoder),fr(this,"textDecoder",new TextDecoder("utf-8")),fr(this,"rankMap",new Map),fr(this,"textMap",new Map),this.patStr=e.pat_str;let a=e.bpe_ranks.split(`
`).filter(Boolean).reduce((r,i)=>{let[n,s,...o]=i.split(" "),l=Number.parseInt(s,10);return o.forEach((u,c)=>r[u]=l+c),r},{});for(let[r,i]of Object.entries(a)){let n=Zx.default.toByteArray(r);this.rankMap.set(n.join(","),i),this.textMap.set(i,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[i,n])=>(r[n]=this.textEncoder.encode(i),r),{})}encode(e,t=[],a="all"){let r=new RegExp(this.patStr,"ug"),i=Id.specialTokenRegex(Object.keys(this.specialTokens)),n=[],s=new Set(t==="all"?Object.keys(this.specialTokens):t),o=new Set(a==="all"?Object.keys(this.specialTokens).filter(u=>!s.has(u)):a);if(o.size>0){let u=Id.specialTokenRegex([...o]),c=e.match(u);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let l=0;for(;;){let u=null,c=l;for(;i.lastIndex=c,u=i.exec(e),!(u==null||s.has(u[0]));)c=u.index+1;let d=u?.index??e.length;for(let p of e.substring(l,d).matchAll(r)){let f=this.textEncoder.encode(p[0]),m=this.rankMap.get(f.join(","));if(m!=null){n.push(m);continue}n.push(...Gx(f,this.rankMap))}if(u==null)break;let h=this.specialTokens[u[0]];n.push(h),l=u.index+u[0].length}return n}decode(e){let t=[],a=0;for(let n=0;n<e.length;++n){let s=e[n],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(t.push(o),a+=o.length)}let r=new Uint8Array(a),i=0;for(let n of t)r.set(n,i),i+=n.length;return this.textDecoder.decode(r)}},r_=Id;Wx(r_,"specialTokenRegex",e=>new RegExp(e.map(t=>Jx(t)).join("|"),"g"));function Kx(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}kn();var Yo={},Xx=new Po({});async function Yx(e){return e in Yo||(Yo[e]=Xx.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(t=>t.json()).then(t=>new r_(t)).catch(t=>{throw delete Yo[e],t})),await Yo[e]}async function Qx(e){return Yx(Kx(e))}He();var eP=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e;function tP(e){return typeof e!="object"||!e?!1:!!("type"in e&&e.type==="function"&&"function"in e&&typeof e.function=="object"&&e.function&&"name"in e.function&&"parameters"in e.function)}var aP=()=>!1,i_=class extends ge{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??aP(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},rP=class extends i_{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...a}){let{cache:r,...i}=a;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r=="object"?this.cache=r:r?this.cache=Bx.global():this.cache=void 0,this.caller=new Po(a??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(r=>typeof r=="string"?r:r.type==="text"&&"text"in r?r.text:"").join("");let a=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await Qx("modelName"in this?eP(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{a=this._encoding.encode(t).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return a}static _convertInputToPromptValue(e){return typeof e=="string"?new yd(e):Array.isArray(e)?new bd(e.map(ha)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let a={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(a).filter(([r,i])=>i!==void 0).map(([r,i])=>`${r}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};rr(),jr(),Ar(),He(),pa(),pa(),He(),Ta();var zn=class extends ge{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let a=pe(t);return this.func&&await this.func(e,a),this._callWithConfig(r=>Promise.resolve(r),e,a)}async*transform(e,t){let a=pe(t),r,i=!0;for await(let n of this._transformStreamWithConfig(e,s=>s,a))if(yield n,i)if(r===void 0)r=n;else try{r=ko(r,n)}catch{r=void 0,i=!1}this.func&&r!==void 0&&await this.func(r,a)}static assign(e){return new md(new $n({steps:e}))}};ar(),_i(),Tr();function $d(e){let t=[];for(let a of e){let r=a;if(Array.isArray(a.content))for(let i=0;i<a.content.length;i++){let n=a.content[i];(P1(n)||A1(n))&&r===a&&(r=new a.constructor({...r,content:[...a.content.slice(0,i),S1(n),...a.content.slice(i+1)]}))}t.push(r)}return t}var iP=class Xr extends rP{constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(t){let[a,r]=super._separateRunnableConfigFromCallOptions(t);return r.signal=a.signal,[a,r]}async invoke(t,a){let r=Xr._convertInputToPromptValue(t);return(await this.generatePrompt([r],a,a?.callbacks)).generations[0][0].message}async*_streamResponseChunks(t,a,r){throw new Error("Not implemented.")}async*_streamIterator(t,a){if(this._streamResponseChunks===Xr.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(t,a);else{let r=Xr._convertInputToPromptValue(t).toChatMessages(),[i,n]=this._separateRunnableConfigFromCallOptionsCompat(a),s={...i.metadata,...this.getLsParams(n)},o=await Vt.configure(i.callbacks,this.callbacks,i.tags,this.tags,s,this.metadata,{verbose:this.verbose}),l={options:n,invocation_params:this?.invocationParams(n),batch_size:1},u=await o?.handleChatModelStart(this.toJSON(),[$d(r)],i.runId,void 0,l,void 0,void 0,i.runName),c,d;try{for await(let h of this._streamResponseChunks(r,n,u?.[0])){if(h.message.id==null){let p=u?.at(0)?.runId;p!=null&&h.message._updateId(`run-${p}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,c?c=c.concat(h):c=h,Hg(h.message)&&h.message.usage_metadata!==void 0&&(d={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}}catch(h){throw await Promise.all((u??[]).map(p=>p?.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h?.handleLLMEnd({generations:[[c]],llmOutput:d})))}}getLsParams(t){let a=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:t.stop,ls_provider:a}}async _generateUncached(t,a,r,i){let n=t.map(c=>c.map(ha)),s;if(i!==void 0&&i.length===n.length)s=i;else{let c={...r.metadata,...this.getLsParams(a)},d=await Vt.configure(r.callbacks,this.callbacks,r.tags,this.tags,c,this.metadata,{verbose:this.verbose}),h={options:a,invocation_params:this?.invocationParams(a),batch_size:1};s=await d?.handleChatModelStart(this.toJSON(),n.map($d),r.runId,void 0,h,void 0,void 0,r.runName)}let o=[],l=[];if(s?.[0].handlers.find(k1)&&!this.disableStreaming&&n.length===1&&this._streamResponseChunks!==Xr.prototype._streamResponseChunks)try{let c=await this._streamResponseChunks(n[0],a,s?.[0]),d,h;for await(let p of c){if(p.message.id==null){let f=s?.at(0)?.runId;f!=null&&p.message._updateId(`run-${f}`)}d===void 0?d=p:d=ko(d,p),Hg(p.message)&&p.message.usage_metadata!==void 0&&(h={tokenUsage:{promptTokens:p.message.usage_metadata.input_tokens,completionTokens:p.message.usage_metadata.output_tokens,totalTokens:p.message.usage_metadata.total_tokens}})}if(d===void 0)throw new Error("Received empty response from chat model call.");o.push([d]),await s?.[0].handleLLMEnd({generations:o,llmOutput:h})}catch(c){throw await s?.[0].handleLLMError(c),c}else{let c=await Promise.allSettled(n.map((d,h)=>this._generate(d,{...a,promptIndex:h},s?.[h])));await Promise.all(c.map(async(d,h)=>{if(d.status==="fulfilled"){let p=d.value;for(let f of p.generations){if(f.message.id==null){let m=s?.at(0)?.runId;m!=null&&f.message._updateId(`run-${m}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata}}return p.generations.length===1&&(p.generations[0].message.response_metadata={...p.llmOutput,...p.generations[0].message.response_metadata}),o[h]=p.generations,l[h]=p.llmOutput,s?.[h]?.handleLLMEnd({generations:[p.generations],llmOutput:p.llmOutput})}else return await s?.[h]?.handleLLMError(d.reason),Promise.reject(d.reason)}))}let u={generations:o,llmOutput:l.length?this._combineLLMOutput?.(...l):void 0};return Object.defineProperty(u,Mc,{value:s?{runIds:s?.map(c=>c.runId)}:void 0,configurable:!0}),u}async _generateCached({messages:t,cache:a,llmStringKey:r,parsedOptions:i,handledOptions:n}){let s=t.map(m=>m.map(ha)),o={...n.metadata,...this.getLsParams(i)},l=await Vt.configure(n.callbacks,this.callbacks,n.tags,this.tags,o,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this?.invocationParams(i),batch_size:1},c=await l?.handleChatModelStart(this.toJSON(),s.map($d),n.runId,void 0,u,void 0,void 0,n.runName),d=[],h=(await Promise.allSettled(s.map(async(m,g)=>{let b=Xr._convertInputToPromptValue(m).toString(),y=await a.lookup(b,r);return y==null&&d.push(g),y}))).map((m,g)=>({result:m,runManager:c?.[g]})).filter(({result:m})=>m.status==="fulfilled"&&m.value!=null||m.status==="rejected"),p=[];await Promise.all(h.map(async({result:m,runManager:g},b)=>{if(m.status==="fulfilled"){let y=m.value;return p[b]=y.map(_=>("message"in _&&mt(_.message)&&fo(_.message)&&(_.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),_.generationInfo={..._.generationInfo,tokenUsage:{}},_)),y.length&&await g?.handleLLMNewToken(y[0].text),g?.handleLLMEnd({generations:[y]},void 0,void 0,void 0,{cached:!0})}else return await g?.handleLLMError(m.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(m.reason)}));let f={generations:p,missingPromptIndices:d,startedRunManagers:c};return Object.defineProperty(f,Mc,{value:c?{runIds:c?.map(m=>m.runId)}:void 0,configurable:!0}),f}async generate(t,a,r){let i;Array.isArray(a)?i={stop:a}:i=a;let n=t.map(f=>f.map(ha)),[s,o]=this._separateRunnableConfigFromCallOptionsCompat(i);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(n,o,s);let{cache:l}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({messages:n,cache:l,llmStringKey:u,parsedOptions:o,handledOptions:s}),p={};if(d.length>0){let f=await this._generateUncached(d.map(m=>n[m]),o,s,h!==void 0?d.map(m=>h?.[m]):void 0);await Promise.all(f.generations.map(async(m,g)=>{let b=d[g];c[b]=m;let y=Xr._convertInputToPromptValue(n[b]).toString();return l.update(y,u,m)})),p=f.llmOutput??{}}return{generations:c,llmOutput:p}}invocationParams(t){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(t,a,r){let i=t.map(n=>n.toChatMessages());return this.generate(i,a,r)}async call(t,a,r){return(await this.generate([t.map(ha)],a,r)).generations[0][0].message}async callPrompt(t,a,r){let i=t.toChatMessages();return this.call(i,a,r)}async predictMessages(t,a,r){return this.call(t,a,r)}async predict(t,a,r){let i=new Pr(t),n=await this.call([i],a,r);if(typeof n.content!="string")throw new Error("Cannot use predict when output is not a string.");return n.content}withStructuredOutput(t,a){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(a?.strict)throw new Error('"strict" mode is not supported for this model by default.');let r=t,i=a?.name,n=f0(r)??"A function available to call.",s=a?.method,o=a?.includeRaw;if(s==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let l=i??"extract",u;Co(r)?u=[{type:"function",function:{name:l,description:n,parameters:Ro(r)}}]:("name"in r&&(l=r.name),u=[{type:"function",function:{name:l,description:n,parameters:r}}]);let c=this.bindTools(u),d=Lo.from(m=>{if(!m.tool_calls||m.tool_calls.length===0)throw new Error("No tool calls found in the response.");let g=m.tool_calls.find(b=>b.name===l);if(!g)throw new Error(`No tool call found with name ${l}.`);return g.args});if(!o)return c.pipe(d).withConfig({runName:"StructuredOutput"});let h=zn.assign({parsed:(m,g)=>d.invoke(m.raw,g)}),p=zn.assign({parsed:()=>null}),f=h.withFallbacks({fallbacks:[p]});return Ma.from([{raw:c},f]).withConfig({runName:"StructuredOutputRunnable"})}};rr(),jr(),Ar(),pa(),_i(),ca(),rr(),He(),Ta(),He(),Ta(),He(),Ta(),pa(),rr(),He(),uo();var nP=class extends ge{parseResultWithPrompt(e,t,a){return this.parseResult(e,a)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(a,r)=>this.parseResult([{text:a}],r?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(a,r)=>this.parseResult([{message:a,text:this._baseMessageToString(a)}],r?.callbacks),e,{...t,runType:"parser"})}},n_=class extends nP{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,a){return this.parse(e,a)}_type(){throw new Error("_type not implemented")}},Td=class extends Error{constructor(e,t,a,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=a,this.sendToLLM=r,r&&(a===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");lo(this,"OUTPUT_PARSING_FAILURE")}};No(),qt(),er(),jr();var sP=class extends n_{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},s_=class extends sP{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,a;for await(let r of e){if(typeof r!="string"&&typeof r.content!="string")throw new Error("Cannot handle non-string output.");let i;if(vc(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");i=new On({message:r,text:r.content})}else if(mt(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");i=new On({message:U1(r),text:r.content})}else i=new wn({text:r});a===void 0?a=i:a=a.concat(i);let n=await this.parsePartialResult([a]);n!=null&&!Si(n,t)&&(this.diff?yield this._diff(t,n):yield n,t=n)}}getFormatInstructions(){return""}};Ou(),ar(),Tr();var o_=class extends n_{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Ve.object(Object.fromEntries(Object.entries(e).map(([a,r])=>[a,Ve.string().describe(r)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Ro(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.trim(),a=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(r,i)=>`"${i.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await ud(this.schema,JSON.parse(a))}catch(t){throw new Td(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};em(),qg();var l_=class extends s_{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?uk(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Zg(e[0].text)}async parse(e){return Zg(e,JSON.parse)}getFormatInstructions(){return""}};jr(),Tn(),Ar(),He(),Ta(),ca(),Ou(),No(),Ar(),Ta(),yn(),Pi(),bc(),ar(),Tr(),He(),ar();function oP(e){return e!==void 0&&Array.isArray(e.lc_namespace)}function lP(e){return e!==void 0&&ge.isRunnable(e)&&"lc_name"in e.constructor&&typeof e.constructor.lc_name=="function"&&e.constructor.lc_name()==="RunnableToolLike"}function uP(e){return!!e&&typeof e=="object"&&"name"in e&&"schema"in e&&(Co(e.schema)||e.schema!=null&&typeof e.schema=="object"&&"type"in e.schema&&typeof e.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function cP(e){return uP(e)||lP(e)||oP(e)}var dP=class extends i_{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let a,r=pe(Wt(this.defaultConfig,t));return mn(e)?(a=e.args,r={...r,toolCall:e}):a=e,this.call(a,r)}async call(e,t,a){let r=mn(e)?e.args:e,i;if(Co(this.schema))try{i=await ud(this.schema,r)}catch(h){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${h.message}`),new co(p,JSON.stringify(e))}else{let h=Oe(r,this.schema);if(!h.valid){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${h.errors.map(f=>`${f.keywordLocation}: ${f.error}`).join(`
`)}`),new co(p,JSON.stringify(e))}i=r}let n=q1(t),s=await Vt.configure(n.callbacks,this.callbacks,n.tags||a,this.tags,n.metadata,this.metadata,{verbose:this.verbose})?.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),n.runId,void 0,void 0,void 0,n.runName);delete n.runId;let o;try{o=await this._call(i,s,n)}catch(h){throw await s?.handleToolError(h),h}let l,u;if(this.responseFormat==="content_and_artifact")if(Array.isArray(o)&&o.length===2)[l,u]=o;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(o)}`);else l=o;let c;mn(e)&&(c=e.id),!c&&x1(n)&&(c=n.toolCall.id);let d=pP({content:l,artifact:u,toolCallId:c,name:this.name,metadata:this.metadata});return await s?.handleToolEnd(d),d}},hP=class extends dP{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ve.object({input:Ve.string().optional()}).transform(t=>t.input)})}call(e,t){let a=typeof e=="string"||e==null?{input:e}:e;return super.call(a,t)}};function pP(e){let{content:t,artifact:a,toolCallId:r,metadata:i}=e;return r&&!N1(t)?typeof t=="string"||Array.isArray(t)&&t.every(n=>typeof n=="object")?new po({status:"success",content:t,artifact:a,tool_call_id:r,name:e.name,metadata:i}):new po({status:"success",content:fP(t),artifact:a,tool_call_id:r,name:e.name,metadata:i}):t}function fP(e){try{return JSON.stringify(e,null,2)??""}catch{return`${e}`}}da(),Bg(),$c(),er(),$a(),da(),yy(),da(),$c(),kn(),$a(),Tr();function mP(e,t){let a=typeof t=="number"?void 0:t;return{name:e.name,description:e.description,parameters:Ro(e.schema),...a?.strict!==void 0?{strict:a.strict}:{}}}Tr(),pa(),rr(),jr(),He(),da(),Tr(),ca(),ar(),Ig(),$a();function Nd(e){if(typeof e!="object"||e===null)return e;let t=Array.isArray(e)?[]:{};for(let a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=Nd(e[a]));return t}function u_(){return{v:1,id:t_(-2),ts:new Date().toISOString(),channel_values:{},channel_versions:{},versions_seen:{},pending_sends:[]}}function Qo(e){return{v:e.v,id:e.id,ts:e.ts,channel_values:{...e.channel_values},channel_versions:{...e.channel_versions},versions_seen:Nd(e.versions_seen),pending_sends:[...e.pending_sends]}}function c_(e,t){return typeof e=="number"&&typeof t=="number"?Math.sign(e-t):String(e).localeCompare(String(t))}function d_(...e){return e.reduce((t,a,r)=>r===0?a:c_(t,a)>=0?t:a)}var h_={[Tx]:-1,[Ko]:-2,[Nx]:-3,[Cx]:-4},Bn=class extends Error{constructor(e){super(e),this.name="InvalidNamespaceError"}};function gP(e){if(e.length===0)throw new Bn("Namespace cannot be empty.");for(let t of e){if(typeof t!="string")throw new Bn(`Invalid namespace label '${t}' found in ${e}. Namespace labels must be strings, but got ${typeof t}.`);if(t.includes("."))throw new Bn(`Invalid namespace label '${t}' found in ${e}. Namespace labels cannot contain periods ('.').`);if(t==="")throw new Bn(`Namespace labels cannot be empty strings. Got ${t} in ${e}`)}if(e[0]==="langgraph")throw new Bn(`Root label for namespace cannot be "langgraph". Got: ${e}`)}var yP=class{async get(e,t){return(await this.batch([{namespace:e,key:t}]))[0]}async search(e,t={}){let{filter:a,limit:r=10,offset:i=0,query:n}=t;return(await this.batch([{namespacePrefix:e,filter:a,limit:r,offset:i,query:n}]))[0]}async put(e,t,a,r){gP(e),await this.batch([{namespace:e,key:t,value:a,index:r}])}async delete(e,t){await this.batch([{namespace:e,key:t,value:null}])}async listNamespaces(e={}){let{prefix:t,suffix:a,maxDepth:r,limit:i=100,offset:n=0}=e,s=[];return t&&s.push({matchType:"prefix",path:t}),a&&s.push({matchType:"suffix",path:a}),(await this.batch([{matchConditions:s.length?s:void 0,maxDepth:r,limit:i,offset:n}]))[0]}start(){}stop(){}},bP=e=>"lg_name"in e&&e.lg_name==="AsyncBatchedStore"?e.store:e,_P=class extends yP{constructor(e){super(),Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"AsyncBatchedStore"}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextKey",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"running",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"processingTask",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.store=bP(e)}get isRunning(){return this.running}async batch(e){throw new Error("The `batch` method is not implemented on `AsyncBatchedStore`.\n Instead, it calls the `batch` method on the wrapped store.\n If you are seeing this error, something is wrong.")}async get(e,t){return this.enqueueOperation({namespace:e,key:t})}async search(e,t){let{filter:a,limit:r=10,offset:i=0,query:n}=t||{};return this.enqueueOperation({namespacePrefix:e,filter:a,limit:r,offset:i,query:n})}async put(e,t,a){return this.enqueueOperation({namespace:e,key:t,value:a})}async delete(e,t){return this.enqueueOperation({namespace:e,key:t,value:null})}start(){this.running||(this.running=!0,this.processingTask=this.processBatchQueue())}async stop(){this.running=!1,this.processingTask&&await this.processingTask}enqueueOperation(e){return new Promise((t,a)=>{let r=this.nextKey;this.nextKey+=1,this.queue.set(r,{operation:e,resolve:t,reject:a})})}async processBatchQueue(){for(;this.running;){if(await new Promise(t=>{setTimeout(t,0)}),this.queue.size===0)continue;let e=new Map(this.queue);this.queue.clear();try{let t=Array.from(e.values()).map(({operation:r})=>r),a=await this.store.batch(t);e.forEach(({resolve:r},i)=>{let n=Array.from(e.keys()).indexOf(i);r(a[n])})}catch(t){e.forEach(({reject:a})=>{a(t)})}}}toJSON(){return{queue:this.queue,nextKey:this.nextKey,running:this.running,store:"[LangGraphStore]"}}};function el(e){return e!=null&&e.lg_is_channel===!0}var tl=class{constructor(){Object.defineProperty(this,"ValueType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"UpdateType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lg_is_channel",{enumerable:!0,configurable:!0,writable:!0,value:!0})}consume(){return!1}};function al(e,t){let a=Object.fromEntries(Object.entries(e).filter(([,i])=>el(i))),r={};for(let i in a)if(Object.prototype.hasOwnProperty.call(a,i)){let n=t.channel_values[i];r[i]=a[i].fromCheckpoint(n)}return r}function Lr(e,t,a){let r;if(t===void 0)r=e.channel_values;else{r={};for(let i of Object.keys(t))try{r[i]=t[i].checkpoint()}catch(n){if(n.name!==ot.unminifiable_name)throw n}}return{v:1,id:t_(a),ts:new Date().toISOString(),channel_values:r,channel_versions:{...e.channel_versions},versions_seen:Nd(e.versions_seen),pending_sends:e.pending_sends??[]}}var Cd=class lO extends tl{constructor(t,a){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"BinaryOperatorAggregate"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"operator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initialValueFactory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.operator=t,this.initialValueFactory=a,this.value=a?.()}fromCheckpoint(t){let a=new lO(this.operator,this.initialValueFactory);return typeof t<"u"&&(a.value=t),a}update(t){let a=t;if(!a.length)return!1;this.value===void 0&&([this.value]=a,a=a.slice(1));for(let r of a)this.value!==void 0&&(this.value=this.operator(this.value,r));return!0}get(){if(this.value===void 0)throw new ot;return this.value}checkpoint(){if(this.value===void 0)throw new ot;return this.value}},Zn=class uO extends tl{constructor(){super(...arguments),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"LastValue"}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]})}fromCheckpoint(t){let a=new uO;return typeof t<"u"&&(a.value=[t]),a}update(t){if(t.length===0)return!1;if(t.length!==1)throw new xe("LastValue can only receive one value per step.",{lc_error_code:"INVALID_CONCURRENT_GRAPH_UPDATE"});return this.value=[t[t.length-1]],!0}get(){if(this.value.length===0)throw new ot;return this.value[0]}checkpoint(){if(this.value.length===0)throw new ot;return this.value[0]}},_e="__start__",se="__end__",Da="__input__",vP="__copy__",vt="__error__",Ni="__pregel_send",Rd="__pregel_call",Mr="__pregel_read",Te="__pregel_checkpointer",ir="__pregel_resuming",qn="__pregel_task_id",rl="__pregel_stream",wP="__pregel_resume_value",Ur="__pregel_scratchpad",il="__pregel_previous",OP="checkpoint_id",Ld="checkpoint_ns",kP="__pregel_node_finished",Nt="checkpoint_map",p_="__pregel_abort_signals",Ae="__interrupt__",Ct="__resume__",Md="__no_writes__",Vn="__return__",Wn="__previous__",Ci="__pregel_runtime_placeholder__",Se="langsmith:hidden",EP="langsmith:nostream",f_="__self__",Ri="__pregel_tasks",Rt="__pregel_push",nl="__pregel_pull",Lt="00000000-0000-0000-0000-000000000000",xP=[Se,Da,Ae,Ct,vt,Md,Ri,Ni,Mr,Te,rl,ir,qn,Rd,wP,Ur,il,Nt,Ld,OP],lt="|",Dr=":";function Ud(e){let t=e;return t!=null&&typeof t.node=="string"&&t.args!==void 0}var sl=class{constructor(e,t){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Send"}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.node=e,this.args=Hn(t)}toJSON(){return{lg_name:this.lg_name,node:this.node,args:this.args}}};function wt(e){return e instanceof sl}var ea=class{constructor(e){Object.defineProperty(this,"lg_name",{enumerable:!0,configurable:!0,writable:!0,value:"Command"}),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"graph",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resume",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"goto",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.resume=e.resume,this.graph=e.graph,this.update=e.update,e.goto&&(this.goto=Array.isArray(e.goto)?Hn(e.goto):[Hn(e.goto)])}_updateAsTuples(){return this.update&&typeof this.update=="object"&&!Array.isArray(this.update)?Object.entries(this.update):Array.isArray(this.update)&&this.update.every(e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="string")?this.update:[["__root__",this.update]]}toJSON(){let e;return typeof this.goto=="string"?e=this.goto:wt(this.goto)?e=this.goto.toJSON():e=this.goto?.map(t=>typeof t=="string"?t:t.toJSON()),{lg_name:this.lg_name,update:this.update,resume:this.resume,goto:e}}};Object.defineProperty(ea,"PARENT",{enumerable:!0,configurable:!0,writable:!0,value:"__parent__"});function ut(e){return typeof e!="object"||e==null?!1:"lg_name"in e&&e.lg_name==="Command"}function Hn(e,t=new Map){if(e!=null&&typeof e=="object"){if(t.has(e))return t.get(e);let a;if(Array.isArray(e))a=[],t.set(e,a),e.forEach((r,i)=>{a[i]=Hn(r,t)});else if(ut(e)&&!(e instanceof ea))a=new ea(e),t.set(e,a);else if(Ud(e)&&!(e instanceof sl))a=new sl(e.node,e.args),t.set(e,a);else if(ut(e)||wt(e))a=e,t.set(e,a);else if("lc_serializable"in e&&e.lc_serializable)a=e,t.set(e,a);else{a={},t.set(e,a);for(let[r,i]of Object.entries(e))a[r]=Hn(i,t)}return a}return e}var PP=class{constructor(e,t){Object.defineProperty(this,"runtime",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_promises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"lg_is_managed_value",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.config=e}static async initialize(e,t){throw new Error("Not implemented")}async promises(){return Promise.all(this._promises)}addPromise(e){this._promises.push(e)}},AP="__channel_key_placeholder__",SP=class extends Map{constructor(e){super(e?Array.from(e):void 0)}replaceRuntimeValues(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(a=>!a.runtime)){if(typeof t=="object"&&!Array.isArray(t))for(let[a,r]of Object.entries(t))for(let[i,n]of this.entries())n.runtime&&n.call(e)===r&&(t[a]={[Ci]:i});else if(typeof t=="object"&&"constructor"in t)for(let a of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let r=t[a];for(let[i,n]of this.entries())n.runtime&&n.call(e)===r&&(t[a]={[Ci]:i})}catch(r){if(r.name!==TypeError.name)throw r}}}replaceRuntimePlaceholders(e,t){if(!(this.size===0||!t)&&!Array.from(this.values()).every(a=>!a.runtime)){if(typeof t=="object"&&!Array.isArray(t)){for(let[a,r]of Object.entries(t))if(typeof r=="object"&&r!==null&&Ci in r){let i=r[Ci];typeof i=="string"&&(t[a]=this.get(i)?.call(e))}}else if(typeof t=="object"&&"constructor"in t)for(let a of Object.getOwnPropertyNames(Object.getPrototypeOf(t)))try{let r=t[a];if(typeof r=="object"&&r!==null&&Ci in r){let i=this.get(r[Ci]);i&&(t[a]=i.call(e))}}catch(r){if(r.name!==TypeError.name)throw r}}}};function ol(e){return!!(typeof e=="object"&&e&&"cls"in e&&"params"in e)}var jP=class cO extends PP{call(){}static async initialize(t,a){return Promise.resolve(new cO(t))}},IP=class{constructor(e){Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"AnnotationRoot"}),Object.defineProperty(this,"spec",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.spec=e}},Dd=function(e){return ol(e)?e:e?Fd(e):new Zn};Dd.Root=e=>new IP(e);function Fd(e){return typeof e=="object"&&e&&"reducer"in e&&e.reducer?new Cd(e.reducer,e.default):typeof e=="object"&&e&&"value"in e&&e.value?new Cd(e.value,e.default):new Zn}b0(),Ra(),la(),Pi();var $P=["tags","metadata","callbacks","configurable"],TP=["tags","metadata","callbacks","runName","maxConcurrency","recursionLimit","configurable","runId","outputKeys","streamMode","store","writer","interruptBefore","interruptAfter","signal"],NP=25;function m_(...e){let t={tags:[],metadata:{},callbacks:void 0,recursionLimit:NP,configurable:{}},a=gt.getRunnableConfig();if(a!==void 0){for(let[r,i]of Object.entries(a))if(i!==void 0)if($P.includes(r)){let n;Array.isArray(i)?n=[...i]:typeof i=="object"?r==="callbacks"&&"copy"in i&&typeof i.copy=="function"?n=i.copy():n={...i}:n=i,t[r]=n}else t[r]=i}for(let r of e)if(r!==void 0)for(let[i,n]of Object.entries(r))n!==void 0&&TP.includes(i)&&(t[i]=n);for(let[r,i]of Object.entries(t.configurable))t.metadata=t.metadata??{},!r.startsWith("__")&&(typeof i=="string"||typeof i=="number"||typeof i=="boolean")&&!(r in t.metadata)&&(t.metadata[r]=i);return t}function zd(e){return e.split(lt).filter(t=>!t.match(/^\d+$/)).map(t=>t.split(Dr)[0]).join(lt)}function CP(e){let t=e.split(lt);for(;t.length>1&&t[t.length-1].match(/^\d+$/);)t.pop();return t.slice(0,-1).join(lt)}var ya=class extends ge{constructor(e){super(),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"recurse",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.name=e.name??e.func.name,this.func=e.func,this.config=e.tags?{tags:e.tags}:void 0,this.trace=e.trace??this.trace,this.recurse=e.recurse??this.recurse}async _tracedInvoke(e,t,a){return new Promise((r,i)=>{let n=Pe(t,{callbacks:a?.getChild()});gt.runWithConfig(n,async()=>{try{let s=await this.func(e,n);r(s)}catch(s){i(s)}})})}async invoke(e,t){let a,r=m_(t),i=Wt(this.config,r);return this.trace?a=await this._callWithConfig(this._tracedInvoke,e,i):a=await gt.runWithConfig(i,async()=>this.func(e,i)),ge.isRunnable(a)&&this.recurse?await gt.runWithConfig(i,async()=>a.invoke(e,i)):a}};function*nr(e,t){if(t===void 0)yield*e;else for(let a of e)yield[t,a]}async function sr(e){let t=[];for await(let a of await e)t.push(a);return t}function Gn(e){let t=[];for(let a of e)t.push(a);return t}function Jn(e,t){return e?"configurable"in e?{...e,configurable:{...e.configurable,...t}}:{...e,configurable:t}:{configurable:t}}function RP(e){return e!=null&&typeof e=="function"&&e instanceof Object.getPrototypeOf(async function*(){}).constructor}function LP(e){return e!=null&&typeof e=="function"&&e instanceof Object.getPrototypeOf(function*(){}).constructor}var tI={[Symbol.for("LG_SKIP_WRITE")]:!0};function MP(e){return typeof e=="object"&&e?.[Symbol.for("LG_SKIP_WRITE")]!==void 0}var Fa={[Symbol.for("LG_PASSTHROUGH")]:!0};function ll(e){return typeof e=="object"&&e?.[Symbol.for("LG_PASSTHROUGH")]!==void 0}var Bd=Symbol("IS_WRITER"),Ge=class gp extends ya{constructor(t,a){let r=`ChannelWrite<${t.map(i=>wt(i)?i.node:"channel"in i?i.channel:"...").join(",")}>`;super({writes:t,name:r,tags:a,func:async(i,n)=>this._write(i,n??{})}),Object.defineProperty(this,"writes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.writes=t}async _write(t,a){let r=this.writes.map(i=>Zd(i)&&ll(i.value)?{mapper:i.mapper,value:t}:ul(i)&&ll(i.value)?{channel:i.channel,value:t,skipNone:i.skipNone,mapper:i.mapper}:i);return await gp.doWrite(a,r),t}static async doWrite(t,a){for(let n of a){if(ul(n)){if(n.channel===Ri)throw new xe("Cannot write to the reserved channel TASKS");if(ll(n.value))throw new xe("PASSTHROUGH value must be replaced")}if(Zd(n)&&ll(n.value))throw new xe("PASSTHROUGH value must be replaced")}let r=[];for(let n of a)if(wt(n))r.push([Ri,n]);else if(Zd(n)){let s=await n.mapper.invoke(n.value,t);s!=null&&s.length>0&&r.push(...s)}else if(ul(n)){let s=n.mapper!==void 0?await n.mapper.invoke(n.value,t):n.value;if(MP(s)||n.skipNone&&s===void 0)continue;r.push([n.channel,s])}else throw new Error(`Invalid write entry: ${JSON.stringify(n)}`);let i=t.configurable?.[Ni];i(r)}static isWriter(t){return t instanceof gp||Bd in t&&!!t[Bd]}static registerWriter(t){return Object.defineProperty(t,Bd,{value:!0})}};function ul(e){return e!==void 0&&typeof e.channel=="string"}function Zd(e){return e!==void 0&&!ul(e)&&ge.isRunnable(e.mapper)}var UP=class dO extends ya{constructor(t,a,r=!1){super({func:(i,n)=>dO.doRead(n,this.channel,this.fresh,this.mapper)}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"ChannelRead"}),Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fresh",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fresh=r,this.mapper=a,this.channel=t,this.name=Array.isArray(t)?`ChannelRead<${t.join(",")}>`:`ChannelRead<${t}>`}static doRead(t,a,r,i){let n=t.configurable?.[Mr];if(!n)throw new Error("Runnable is not configured with a read function. Make sure to call in the context of a Pregel process");return i?i(n(a,r)):n(a,r)}},Li=new zn,Mi=class Es extends Nr{constructor(t){let{channels:a,triggers:r,mapper:i,writers:n,bound:s,kwargs:o,metadata:l,retryPolicy:u,tags:c,subgraphs:d,ends:h}=t,p=[...t.config?.tags?t.config.tags:[],...c??[]];super({...t,bound:t.bound??Li,config:{...t.config?t.config:{},tags:p}}),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"PregelNode"}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:Li}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"subgraphs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channels=a,this.triggers=r,this.mapper=i,this.writers=n??this.writers,this.bound=s??this.bound,this.kwargs=o??this.kwargs,this.metadata=l??this.metadata,this.tags=p,this.retryPolicy=u,this.subgraphs=d,this.ends=h}getWriters(){let t=[...this.writers];for(;t.length>1&&t[t.length-1]instanceof Ge&&t[t.length-2]instanceof Ge;){let a=t.slice(-2),r=a[0].writes.concat(a[1].writes);t[t.length-2]=new Ge(r,a[0].config?.tags),t.pop()}return t}getNode(){let t=this.getWriters();if(!(this.bound===Li&&t.length===0))return this.bound===Li&&t.length===1?t[0]:this.bound===Li?new Ma({first:t[0],middle:t.slice(1,t.length-1),last:t[t.length-1],omitSequenceTags:!0}):t.length>0?new Ma({first:this.bound,middle:t.slice(0,t.length-1),last:t[t.length-1],omitSequenceTags:!0}):this.bound}join(t){if(!Array.isArray(t))throw new Error("channels must be a list");if(typeof this.channels!="object")throw new Error("all channels must be named when using .join()");return new Es({channels:{...this.channels,...Object.fromEntries(t.map(a=>[a,a]))},triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound,kwargs:this.kwargs,config:this.config,retryPolicy:this.retryPolicy})}pipe(t){return Ge.isWriter(t)?new Es({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:[...this.writers,t],bound:this.bound,config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):this.bound===Li?new Es({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:bt(t),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy}):new Es({channels:this.channels,triggers:this.triggers,mapper:this.mapper,writers:this.writers,bound:this.bound.pipe(t),config:this.config,kwargs:this.kwargs,retryPolicy:this.retryPolicy})}},za=class extends Error{constructor(e){super(e),this.name="GraphValidationError"}};function DP({nodes:e,channels:t,inputChannels:a,outputChannels:r,streamChannels:i,interruptAfterNodes:n,interruptBeforeNodes:s}){if(!t)throw new za("Channels not provided");let o=new Set,l=new Set;for(let[u,c]of Object.entries(e)){if(u===Ae)throw new za(`"Node name ${Ae} is reserved"`);if(c.constructor===Mi)c.triggers.forEach(d=>o.add(d));else throw new za(`Invalid node type ${typeof c}, expected PregelNode`)}for(let u of o)if(!(u in t))throw new za(`Subcribed channel '${String(u)}' not in channels`);if(Array.isArray(a)){if(a.every(u=>!o.has(u)))throw new za(`None of the input channels ${a} are subscribed to by any node`)}else if(!o.has(a))throw new za(`Input channel ${String(a)} is not subscribed to by any node`);Array.isArray(r)?r.forEach(u=>l.add(u)):l.add(r),i&&!Array.isArray(i)?l.add(i):Array.isArray(i)&&i.forEach(u=>l.add(u));for(let u of l)if(!(u in t))throw new za(`Output channel '${String(u)}' not in channels`);if(n&&n!=="*"){for(let u of n)if(!(u in e))throw new za(`Node ${String(u)} not in nodes`)}if(s&&s!=="*"){for(let u of s)if(!(u in e))throw new za(`Node ${String(u)} not in nodes`)}}function g_(e,t){if(Array.isArray(e)){for(let a of e)if(!(a in t))throw new Error(`Key ${String(a)} not found in channels`)}else if(!(e in t))throw new Error(`Key ${String(e)} not found in channels`)}la();function Fr(e,t,a=!0,r=!1){try{return e[t].get()}catch(i){if(i.name===ot.unminifiable_name){if(r)return i;if(a)return null}throw i}}function zr(e,t,a=!0){if(Array.isArray(t)){let r={};for(let i of t)try{r[i]=Fr(e,i,!a)}catch(n){if(n.name===ot.unminifiable_name)continue}return r}else return Fr(e,t)}function*FP(e,t){if(e.graph===ea.PARENT)throw new xe("There is no parent graph.");if(e.goto){let a;Array.isArray(e.goto)?a=e.goto:a=[e.goto];for(let r of a)if(wt(r))yield[Lt,Ri,r];else if(typeof r=="string")yield[Lt,`branch:to:${r}`,"__start__"];else throw new Error(`In Command.send, expected Send or string, got ${typeof r}`)}if(e.resume)if(typeof e.resume=="object"&&Object.keys(e.resume).length&&Object.keys(e.resume).every(ja))for(let[a,r]of Object.entries(e.resume)){let i=t.filter(n=>n[0]===a&&n[1]===Ct).map(n=>n[2]).slice(0,1)??[];i.push(r),yield[a,Ct,i]}else yield[Lt,Ct,e.resume];if(e.update){if(typeof e.update!="object"||!e.update)throw new Error("Expected cmd.update to be a dict mapping channel names to update values");if(Array.isArray(e.update))for(let[a,r]of e.update)yield[Lt,a,r];else for(let[a,r]of Object.entries(e.update))yield[Lt,a,r]}}function*y_(e,t){if(t!=null)if(Array.isArray(e)&&typeof t=="object"&&!Array.isArray(t))for(let a in t)e.includes(a)&&(yield[a,t[a]]);else{if(Array.isArray(e))throw new Error('Input chunk must be an object when "inputChannels" is an array');yield[e,t]}}function*qd(e,t,a){Array.isArray(e)?(t===!0||t.find(([r,i])=>e.includes(r)))&&(yield zr(a,e)):(t===!0||t.some(([r,i])=>r===e))&&(yield Fr(a,e))}function*b_(e,t,a){let r=t.filter(([o,l])=>(o.config===void 0||!o.config.tags?.includes(Se))&&l[0][0]!==vt&&l[0][0]!==Ae);if(!r.length)return;let i;r.some(([o])=>o.writes.some(([l,u])=>l===Vn))?i=r.flatMap(([o])=>o.writes.filter(([l,u])=>l===Vn).map(([l,u])=>[o.name,u])):Array.isArray(e)?i=r.flatMap(([o])=>{let{writes:l}=o,u={};for(let[c]of l)e.includes(c)&&(u[c]=(u[c]||0)+1);return Object.values(u).some(c=>c>1)?l.filter(([c])=>e.includes(c)).map(([c,d])=>[o.name,{[c]:d}]):[[o.name,Object.fromEntries(l.filter(([c])=>e.includes(c)))]]}):i=r.flatMap(([o])=>o.writes.filter(([l,u])=>l===e).map(([l,u])=>[o.name,u]));let n={};for(let[o,l]of i)o in n||(n[o]=[]),n[o].push(l);let s={};for(let o in n)if(n[o].length===1){let[l]=n[o];s[o]=l}else s[o]=n[o];a&&(s.__metadata__={cached:a}),yield s}function zP(e){return"steps"in e&&Array.isArray(e.steps)}function Vd(e){return"lg_is_pregel"in e&&e.lg_is_pregel===!0}function __(e){let t=[e];for(let a of t){if(Vd(a))return a;zP(a)&&t.push(...a.steps)}}var Kn={blue:{start:"\x1B[34m",end:"\x1B[0m"},green:{start:"\x1B[32m",end:"\x1B[0m"},yellow:{start:"\x1B[33;1m",end:"\x1B[0m"}},Xn=(e,t)=>`${e.start}${t}${e.end}`;function*v_(e,t){let a=new Date().toISOString();for(let{id:r,name:i,input:n,config:s,triggers:o,writes:l}of t){if(s?.tags?.includes(Se))continue;let u=l.filter(([c,d])=>c===r&&d===Ae).map(([,c])=>c);yield{type:"task",timestamp:a,step:e,payload:{id:r,name:i,input:n,triggers:o,interrupts:u}}}}function*BP(e,t,a){let r=new Date().toISOString();for(let[{id:i,name:n,config:s},o]of t)s?.tags?.includes(Se)||(yield{type:"task_result",timestamp:r,step:e,payload:{id:i,name:n,result:o.filter(([l])=>Array.isArray(a)?a.includes(l):l===a),interrupts:o.filter(l=>l[0]===Ae).map(l=>l[1])}})}function*ZP(e,t,a,r,i,n,s,o){function l(d){let h={};return d.callbacks!=null&&(h.callbacks=d.callbacks),d.configurable!=null&&(h.configurable=d.configurable),d.maxConcurrency!=null&&(h.max_concurrency=d.maxConcurrency),d.metadata!=null&&(h.metadata=d.metadata),d.recursionLimit!=null&&(h.recursion_limit=d.recursionLimit),d.runId!=null&&(h.run_id=d.runId),d.runName!=null&&(h.run_name=d.runName),d.tags!=null&&(h.tags=d.tags),h}let u=t.configurable?.checkpoint_ns,c={};for(let d of n){if(!(d.subgraphs?.length?d.subgraphs:[d.proc]).find(__))continue;let h=`${d.name}:${d.id}`;u&&(h=`${u}|${h}`),c[d.id]={configurable:{thread_id:t.configurable?.thread_id,checkpoint_ns:h}}}yield{type:"checkpoint",timestamp:new Date().toISOString(),step:e,payload:{config:l(t),values:zr(a,r),metadata:i,next:n.map(d=>d.name),tasks:w_(n,s,c),parentConfig:o?l(o):void 0}}}function w_(e,t,a){return e.map(r=>{let i=t.find(([o,l])=>o===r.id&&l===vt)?.[2],n=t.filter(([o,l])=>o===r.id&&l===Ae).map(([,,o])=>o);if(i)return{id:r.id,name:r.name,path:r.path,error:i,interrupts:n};let s=a?.[r.id];return{id:r.id,name:r.name,path:r.path,interrupts:n,...s!==void 0?{state:s}:{}}})}function qP(e,t,a){console.log([`${Xn(Kn.blue,`[${e}:checkpoint]`)}`,`\x1B[1m State at the end of step ${e}:\x1B[0m
`,JSON.stringify(zr(t,a),null,2)].join(""))}function O_(e,t){let a=t.length;console.log([`${Xn(Kn.blue,`[${e}:tasks]`)}`,`\x1B[1m Starting step ${e} with ${a} task${a===1?"":"s"}:\x1B[0m
`,t.map(r=>`- ${Xn(Kn.green,String(r.name))} -> ${JSON.stringify(r.input,null,2)}`).join(`
`)].join(""))}function VP(e,t,a){let r={};for(let[i,n]of t)a.includes(i)&&(r[i]||(r[i]=[]),r[i].push(n));console.log([`${Xn(Kn.blue,`[${e}:writes]`)}`,`\x1B[1m Finished step ${e} with writes to ${Object.keys(r).length} channel${Object.keys(r).length!==1?"s":""}:\x1B[0m
`,Object.entries(r).map(([i,n])=>`- ${Xn(Kn.yellow,i)} -> ${n.map(s=>JSON.stringify(s)).join(", ")}`).join(`
`)].join(""))}var WP=class{constructor({func:e,name:t,input:a,retry:r,callbacks:i}){Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__lg_type",{enumerable:!0,configurable:!0,writable:!0,value:"call"}),this.func=e,this.name=t,this.input=a,this.retry=r,this.callbacks=i}};function HP(e){return typeof e=="object"&&e!==null&&"__lg_type"in e&&e.__lg_type==="call"}function k_(e){let t=Object.values(e),a=t.length>0?typeof t[0]:void 0,r;return a==="number"?r=0:a==="string"&&(r=""),r}function Wd(e,t){if(Object.keys(e).length>0){let a=k_(t);return Object.fromEntries(Object.entries(t).filter(([r,i])=>i>(e[r]??a)))}else return t}function GP(e,t){return e&&!Array.isArray(e)&&!(e instanceof Date)&&typeof e=="object"?e:{[t]:e}}function or(e,t){return e===null?{configurable:t}:e?.configurable===void 0?{...e,configurable:t}:{...e,configurable:{...e.configurable,...t}}}function Ui(e,t){let a=t?.parents??{};return Object.keys(a).length>0?or(e,{[Nt]:{...a,[e.configurable?.checkpoint_ns??""]:e.configurable?.checkpoint_id}}):e}function Di(...e){if(e.length===1)return e[0];let t=new AbortController,a=()=>{t.abort(),e.forEach(r=>r.removeEventListener("abort",a))};return e.forEach(r=>r.addEventListener("abort",a)),e.some(r=>r.aborted)&&t.abort(),t.signal}function JP(e,t){let a=new ya({func:r=>t(...r),name:e,trace:!1,recurse:!1});return new Ma({name:e,first:a,last:new Ge([{channel:Vn,value:Fa}],[Se])})}function KP(e,t){return new ya({func:(a,r)=>t(a,r),name:e,trace:!1,recurse:!1})}var XP=e=>e!==void 0?e+1:1;function cl(e,t,a){let r=Object.values(e.channel_versions),i=r.length>0?typeof r[0]:void 0,n;i==="number"?n=0:i==="string"&&(n="");let s=e.versions_seen[Ae]??{},o=Object.entries(e.channel_versions).some(([u,c])=>c>(s[u]??n)),l=a.some(u=>t==="*"?!u.config?.tags?.includes(Se):t.includes(u.name));return o&&l}function dl(e,t,a,r,i,n,s=!1){let o=[],l=new Set;if(Array.isArray(n))o=n.filter(c=>r.get(c)),n=n.filter(c=>!r.get(c)),l=new Set(n.filter(c=>i.writes.some(([d,h])=>d===c)));else{for(let[c]of i.writes)if(c===n){l=new Set([c]);break}l=l||new Set}let u;if(s&&l.size>0){let c=Object.fromEntries(Object.entries(a).filter(([p,f])=>l.has(p))),d=Lr(t,c,-1),h=al(c,d);Ot(Qo(d),h,[i]),u=zr({...a,...h},n)}else u=zr(a,n);if(o.length>0)for(let c of o){let d=r.get(c);if(d){let h=d.call(e);u[c]=h}}return u}function Hd(e,t,a,r,i){for(let[n,s]of i)if([Rt,Ri].includes(n)&&s!=null){if(!wt(s))throw new xe(`Invalid packet type, expected SendProtocol, got ${JSON.stringify(s)}`);if(!(s.node in a))throw new xe(`Invalid node name "${s.node}" in Send packet`);r.replaceRuntimeValues(e,s.args)}t(i)}var YP=new Set([Md,Rt,Ct,Ae,Vn,vt]);function Ot(e,t,a,r){a.sort((d,h)=>{let p=d.path?.slice(0,3)||[],f=h.path?.slice(0,3)||[];for(let m=0;m<Math.min(p.length,f.length);m+=1){if(p[m]<f[m])return-1;if(p[m]>f[m])return 1}return p.length-f.length});let i=a.some(d=>d.triggers.length>0),n=Object.fromEntries(Object.entries(t).filter(([d,h])=>el(h)));for(let d of a){e.versions_seen[d.name]===void 0&&(e.versions_seen[d.name]={});for(let h of d.triggers)h in e.channel_versions&&(e.versions_seen[d.name][h]=e.channel_versions[h])}let s;Object.keys(e.channel_versions).length>0&&(s=d_(...Object.values(e.channel_versions)));let o=new Set(a.flatMap(d=>d.triggers).filter(d=>!xP.includes(d)));for(let d of o)d in n&&n[d].consume()&&r!==void 0&&(e.channel_versions[d]=r(s,n[d]));e.pending_sends?.length&&i&&(e.pending_sends=[]);let l={},u={};for(let d of a)for(let[h,p]of d.writes)YP.has(h)||(h===Ri?e.pending_sends.push({node:p.node,args:p.args}):h in n?h in l?l[h].push(p):l[h]=[p]:h in u?u[h].push(p):u[h]=[p]);s=void 0,Object.keys(e.channel_versions).length>0&&(s=d_(...Object.values(e.channel_versions)));let c=new Set;for(let[d,h]of Object.entries(l))if(d in n){let p;try{p=n[d].update(h)}catch(f){if(f.name===xe.unminifiable_name){let m=new xe(`Invalid update for channel "${d}" with values ${JSON.stringify(h)}: ${f.message}`);throw m.lc_error_code=f.lc_error_code,m}else throw f}p&&r!==void 0&&(e.channel_versions[d]=r(s,n[d])),c.add(d)}if(i)for(let d of Object.keys(n))c.has(d)||n[d].update([])&&r!==void 0&&(e.channel_versions[d]=r(s,n[d]));return u}function Yn(e,t,a,r,i,n,s,o){let l={};for(let u=0;u<e.pending_sends.length;u+=1){let c=Gd([Rt,u],e,t,a,r,i,n,s,o);c!==void 0&&(l[c.id]=c)}for(let u of Object.keys(a)){let c=Gd([nl,u],e,t,a,r,i,n,s,o);c!==void 0&&(l[c.id]=c)}return l}function Gd(e,t,a,r,i,n,s,o,l){let{step:u,checkpointer:c,manager:d}=l,h=s.configurable??{},p=h.checkpoint_ns??"";if(e[0]===Rt&&HP(e[e.length-1])){let f=e[e.length-1],m=JP(f.name,f.func),g=[Rt],b=p===""?f.name:`${p}${lt}${f.name}`,y=Ti(JSON.stringify([b,u.toString(),f.name,Rt,e[1],e[2]]),t.id),_=`${b}${Dr}${y}`,w={langgraph_step:u,langgraph_node:f.name,langgraph_triggers:g,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:_};if(o){let O=[];return{name:f.name,input:f.input,proc:m,writes:O,config:Pe(Wt(s,{metadata:w,store:l.store??s.store}),{runName:f.name,callbacks:d?.getChild(`graph:step:${u}`),configurable:{[qn]:y,[Ni]:j=>Hd(u,S=>O.push(...S),r,n,j),[Mr]:(j,S=!1)=>dl(u,t,i,n,{name:f.name,writes:O,triggers:g,path:e.slice(0,3)},j,S),[Te]:c??h[Te],[Nt]:{...h[Nt],[p]:t.id},[Ur]:Jd({pendingWrites:a??[],taskId:y,currentTaskInput:f.input}),[il]:t.channel_values[Wn],checkpoint_id:void 0,checkpoint_ns:_}}),triggers:g,retry_policy:f.retry,id:y,path:e.slice(0,3),writers:[]}}else return{id:y,name:f.name,interrupts:[],path:e.slice(0,3)}}else if(e[0]===Rt){let f=typeof e[1]=="number"?e[1]:parseInt(e[1],10);if(f>=t.pending_sends.length)return;let m=Ud(t.pending_sends[f])&&!wt(t.pending_sends[f])?new sl(t.pending_sends[f].node,t.pending_sends[f].args):t.pending_sends[f];if(!Ud(m)){console.warn(`Ignoring invalid packet ${JSON.stringify(m)} in pending sends.`);return}if(!(m.node in r)){console.warn(`Ignoring unknown node name ${m.node} in pending sends.`);return}let g=[Rt],b=p===""?m.node:`${p}${lt}${m.node}`,y=Ti(JSON.stringify([b,u.toString(),m.node,Rt,f.toString()]),t.id),_=`${b}${Dr}${y}`,w={langgraph_step:u,langgraph_node:m.node,langgraph_triggers:g,langgraph_path:e.slice(0,3),langgraph_checkpoint_ns:_};if(o){let O=r[m.node],j=O.getNode();if(j!==void 0){n.replaceRuntimePlaceholders(u,m.args),O.metadata!==void 0&&(w={...w,...O.metadata});let S=[];return{name:m.node,input:m.args,proc:j,subgraphs:O.subgraphs,writes:S,config:Pe(Wt(s,{metadata:w,tags:O.tags,store:l.store??s.store}),{runName:m.node,callbacks:d?.getChild(`graph:step:${u}`),configurable:{[qn]:y,[Ni]:E=>Hd(u,A=>S.push(...A),r,n,E),[Mr]:(E,A=!1)=>dl(u,t,i,n,{name:m.node,writes:S,triggers:g,path:e},E,A),[Te]:c??h[Te],[Nt]:{...h[Nt],[p]:t.id},[Ur]:Jd({pendingWrites:a??[],taskId:y,currentTaskInput:m.args}),[il]:t.channel_values[Wn],checkpoint_id:void 0,checkpoint_ns:_}}),triggers:g,retry_policy:O.retryPolicy,id:y,path:e,writers:O.getWriters()}}}else return{id:y,name:m.node,interrupts:[],path:e}}else if(e[0]===nl){let f=e[1].toString(),m=r[f];if(m===void 0)return;if(a?.length){let _=p===""?f:`${p}${lt}${f}`,w=Ti(JSON.stringify([_,u.toString(),f,nl,f]),t.id);if(a.some(O=>O[0]===w&&O[1]!==vt))return}let g=k_(t.channel_versions);if(g===void 0)return;let b=t.versions_seen[f]??{},y=m.triggers.filter(_=>{let w=Fr(i,_,!1,!0);return!(w instanceof Error&&w.name===ot.unminifiable_name)&&(t.channel_versions[_]??g)>(b[_]??g)}).sort();if(y.length>0){let _=QP(u,m,n,i,o);if(_===void 0)return;let w=p===""?f:`${p}${lt}${f}`,O=Ti(JSON.stringify([w,u.toString(),f,nl,y]),t.id),j=`${w}${Dr}${O}`,S={langgraph_step:u,langgraph_node:f,langgraph_triggers:y,langgraph_path:e,langgraph_checkpoint_ns:j};if(o){let E=m.getNode();if(E!==void 0){m.metadata!==void 0&&(S={...S,...m.metadata});let A=[];return{name:f,input:_,proc:E,subgraphs:m.subgraphs,writes:A,config:Pe(Wt(s,{metadata:S,tags:m.tags,store:l.store??s.store}),{runName:f,callbacks:d?.getChild(`graph:step:${u}`),configurable:{[qn]:O,[Ni]:x=>Hd(u,te=>{A.push(...te)},r,n,x),[Mr]:(x,te=!1)=>dl(u,t,i,n,{name:f,writes:A,triggers:y,path:e},x,te),[Te]:c??h[Te],[Nt]:{...h[Nt],[p]:t.id},[Ur]:Jd({pendingWrites:a??[],taskId:O,currentTaskInput:_}),[il]:t.channel_values[Wn],checkpoint_id:void 0,checkpoint_ns:j}}),triggers:y,retry_policy:m.retryPolicy,id:O,path:e,writers:m.getWriters()}}}else return{id:O,name:f,interrupts:[],path:e}}}}function QP(e,t,a,r,i){let n;if(typeof t.channels=="object"&&!Array.isArray(t.channels)){n={};for(let[s,o]of Object.entries(t.channels))if(t.triggers.includes(o))try{n[s]=Fr(r,o,!1)}catch(l){if(l.name===ot.unminifiable_name)return;throw l}else if(o in r)try{n[s]=Fr(r,o,!1)}catch(l){if(l.name===ot.unminifiable_name)continue;throw l}else n[s]=a.get(s)?.call(e)}else if(Array.isArray(t.channels)){let s=!1;for(let o of t.channels)try{n=Fr(r,o,!1),s=!0;break}catch(l){if(l.name===ot.unminifiable_name)continue;throw l}if(!s)return}else throw new Error(`Invalid channels type, expected list or dict, got ${t.channels}`);return i&&t.mapper!==void 0&&(n=t.mapper(n)),n}function Jd({pendingWrites:e,taskId:t,currentTaskInput:a}){let r=e.find(([n,s])=>n===Lt&&s===Ct)?.[2],i={callCounter:0,interruptCounter:-1,resume:e.filter(([n,s])=>n===t&&s===Ct).flatMap(([n,s,o])=>o),nullResume:r,subgraphCounter:0,currentTaskInput:a,consumeNullResume:()=>{if(i.nullResume)return delete i.nullResume,e.splice(e.findIndex(([n,s])=>n===Lt&&s===Ct),1),r}};return i}pa();var E_=class extends yt{constructor(e,t){let a=e.getReader(),r=t??new AbortController;super({start(i){return n();function n(){return a.read().then(({done:s,value:o})=>{if(s){i.close();return}return i.enqueue(o),n()})}}}),Object.defineProperty(this,"_abortController",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._abortController=r,this._reader=a}async cancel(e){this._abortController.abort(e),this._reader.releaseLock()}get signal(){return this._abortController.signal}},x_=class extends yt{get closed(){return this._closed}constructor(e){let t,a=new Promise(r=>{t=r});super({start:r=>{t(r)}}),Object.defineProperty(this,"modes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"controller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passthroughFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),a.then(r=>{this.controller=r}),this.passthroughFn=e.passthroughFn,this.modes=e.modes}push(e){this.passthroughFn?.(e),this.controller.enqueue(e)}close(){try{this.controller.close()}catch{}finally{this._closed=!0}}error(e){this.controller.error(e)}},hl=Symbol.for("INPUT_DONE"),Kd=Symbol.for("INPUT_RESUMING"),eA=25;function tA(...e){return new x_({passthroughFn:t=>{for(let a of e)a.modes.has(t[1])&&a.push(t)},modes:new Set(e.flatMap(t=>Array.from(t.modes)))})}var aA=class hO{get isResuming(){let t=Object.keys(this.checkpoint.channel_versions).length!==0,a=this.config.configurable?.[ir]!==void 0&&this.config.configurable?.[ir],r=this.input===null||this.input===void 0,i=ut(this.input)&&this.input.resume!=null,n=this.input===Kd;return t&&(a||r||i||n)}constructor(t){Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerGetNextVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"managed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointNamespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointPendingWrites",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"checkpointPreviousVersions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"step",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"skipDoneTasks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prevCheckpointConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"pending"}),Object.defineProperty(this,"tasks",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkpointerPromises",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"isNested",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_checkpointerChainedPromise",{enumerable:!0,configurable:!0,writable:!0,value:Promise.resolve()}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"toInterrupt",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.input=t.input,this.checkpointer=t.checkpointer,this.checkpointer!==void 0?this.checkpointerGetNextVersion=this.checkpointer.getNextVersion.bind(this.checkpointer):this.checkpointerGetNextVersion=XP,this.checkpoint=t.checkpoint,this.checkpointMetadata=t.checkpointMetadata,this.checkpointPreviousVersions=t.checkpointPreviousVersions,this.channels=t.channels,this.managed=t.managed,this.checkpointPendingWrites=t.checkpointPendingWrites,this.step=t.step,this.stop=t.stop,this.config=t.config,this.checkpointConfig=t.checkpointConfig,this.isNested=t.isNested,this.manager=t.manager,this.outputKeys=t.outputKeys,this.streamKeys=t.streamKeys,this.nodes=t.nodes,this.skipDoneTasks=t.skipDoneTasks,this.store=t.store,this.stream=t.stream,this.checkpointNamespace=t.checkpointNamespace,this.prevCheckpointConfig=t.prevCheckpointConfig,this.interruptAfter=t.interruptAfter,this.interruptBefore=t.interruptBefore,this.debug=t.debug}static async initialize(t){let{config:a,stream:r}=t;r!==void 0&&a.configurable?.[rl]!==void 0&&(r=tA(r,a.configurable[rl]));let i=a.configurable?!("checkpoint_id"in a.configurable):!0,n=a.configurable?.[Ur];a.configurable&&n&&(n.subgraphCounter>0&&(a=or(a,{[Ld]:[a.configurable[Ld],n.subgraphCounter.toString()].join(lt)})),n.subgraphCounter+=1);let s=Mr in(a.configurable??{});!s&&a.configurable?.checkpoint_ns!==void 0&&a.configurable?.checkpoint_ns!==""&&(a=or(a,{checkpoint_ns:"",checkpoint_id:void 0}));let o=a;a.configurable?.[Nt]!==void 0&&a.configurable?.[Nt]?.[a.configurable?.checkpoint_ns]&&(o=or(a,{checkpoint_id:a.configurable[Nt][a.configurable?.checkpoint_ns]}));let l=a.configurable?.checkpoint_ns?.split(lt)??[],u=await t.checkpointer?.getTuple(o)??{config:a,checkpoint:u_(),metadata:{source:"input",step:-2,writes:null,parents:{}},pendingWrites:[]};o={...a,...u.config,configurable:{checkpoint_ns:"",...a.configurable,...u.config.configurable}};let c=u.parentConfig,d=Qo(u.checkpoint),h={...u.metadata},p=u.pendingWrites??[],f=al(t.channelSpecs,d),m=(h.step??0)+1,g=m+(a.recursionLimit??eA)+1,b={...d.channel_versions},y=t.store?new _P(t.store):void 0;return y&&y.start(),new hO({input:t.input,config:a,checkpointer:t.checkpointer,checkpoint:d,checkpointMetadata:h,checkpointConfig:o,prevCheckpointConfig:c,checkpointNamespace:l,channels:f,managed:t.managed,isNested:s,manager:t.manager,skipDoneTasks:i,step:m,stop:g,checkpointPreviousVersions:b,checkpointPendingWrites:p,outputKeys:t.outputKeys??[],streamKeys:t.streamKeys??[],nodes:t.nodes,stream:r,store:y,interruptAfter:t.interruptAfter,interruptBefore:t.interruptBefore,debug:t.debug})}_checkpointerPutAfterPrevious(t){this._checkpointerChainedPromise=this._checkpointerChainedPromise.then(()=>this.checkpointer?.put(t.config,t.checkpoint,t.metadata,t.newVersions)),this.checkpointerPromises.push(this._checkpointerChainedPromise)}async updateManagedValues(t,a){let r=this.managed.get(t);r&&"update"in r&&typeof r.update=="function"&&await r.update(a)}putWrites(t,a){let r=a;if(r.length===0)return;r.every(([n])=>n in h_)&&(r=Array.from(new Map(r.map(n=>[n[0],n])).values()));for(let[n,s]of r){let o=this.checkpointPendingWrites.findIndex(l=>l[0]===t&&l[1]===n);n in h_&&o!==-1?this.checkpointPendingWrites[o]=[t,n,s]:this.checkpointPendingWrites.push([t,n,s])}let i=this.checkpointer?.putWrites({...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??"",checkpoint_id:this.checkpoint.id}},r,t);i!==void 0&&this.checkpointerPromises.push(i),this.tasks&&this._outputWrites(t,r)}_outputWrites(t,a,r=!1){let i=this.tasks[t];if(i!==void 0){if(i.config!==void 0&&(i.config.tags??[]).includes(Se))return;a.length>0&&a[0][0]!==vt&&a[0][0]!==Ae&&this._emit(Gn(nr(b_(this.outputKeys,[[i,a]],r),"updates"))),r||this._emit(Gn(nr(BP(this.step,[[i,a]],this.streamKeys),"debug")))}}async tick(t){this.store&&!this.store.isRunning&&this.store?.start();let{inputKeys:a=[]}=t;if(this.status!=="pending")throw new Error(`Cannot tick when status is no longer "pending". Current status: "${this.status}"`);if(![hl,Kd].includes(this.input))await this._first(a);else{if(this.toInterrupt.length>0)throw this.status="interrupt_before",new Dn;if(Object.values(this.tasks).every(n=>n.writes.length>0)){let n=Object.values(this.tasks).flatMap(l=>l.writes),s=Ot(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(let[l,u]of Object.entries(s))await this.updateManagedValues(l,u);let o=await sr(nr(qd(this.outputKeys,n,this.channels),"values"));if(this._emit(o),this.checkpointPendingWrites=[],await this._putCheckpoint({source:"loop",writes:b_(this.outputKeys,Object.values(this.tasks).map(l=>[l,l.writes])).next().value??null}),cl(this.checkpoint,this.interruptAfter,Object.values(this.tasks)))throw this.status="interrupt_after",new Dn;this.config.configurable?.[ir]!==void 0&&delete this.config.configurable?.[ir]}else return!1}if(this.step>this.stop)return this.status="out_of_steps",!1;let r=Yn(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step,checkpointer:this.checkpointer,isResuming:this.isResuming,manager:this.manager,store:this.store,stream:this.stream});if(this.tasks=r,this.checkpointer&&this._emit(await sr(nr(ZP(this.step-1,this.checkpointConfig,this.channels,this.streamKeys,this.checkpointMetadata,Object.values(this.tasks),this.checkpointPendingWrites,this.prevCheckpointConfig),"debug"))),Object.values(this.tasks).length===0)return this.status="done",!1;if(this.skipDoneTasks&&this.checkpointPendingWrites.length>0){for(let[n,s,o]of this.checkpointPendingWrites){if(s===vt||s===Ae||s===Ct)continue;let l=Object.values(this.tasks).find(u=>u.id===n);l&&l.writes.push([s,o])}for(let n of Object.values(this.tasks))n.writes.length>0&&this._outputWrites(n.id,n.writes,!0)}if(Object.values(this.tasks).every(n=>n.writes.length>0))return this.tick({inputKeys:a});if(cl(this.checkpoint,this.interruptBefore,Object.values(this.tasks)))throw this.status="interrupt_before",new Dn;let i=await sr(nr(v_(this.step,Object.values(this.tasks)),"debug"));return this._emit(i),!0}async finishAndHandleError(t){let a=this._suppressInterrupt(t);if((a||t===void 0)&&(this.output=zr(this.channels,this.outputKeys)),a){if(this.tasks!==void 0&&this.checkpointPendingWrites.length>0&&Object.values(this.tasks).some(r=>r.writes.length>0)){let r=Ot(this.checkpoint,this.channels,Object.values(this.tasks),this.checkpointerGetNextVersion);for(let[i,n]of Object.entries(r))await this.updateManagedValues(i,n);this._emit(Gn(nr(qd(this.outputKeys,Object.values(this.tasks).flatMap(i=>i.writes),this.channels),"values")))}this._emit([["updates",{[Ae]:t.interrupts}]])}return a}acceptPush(t,a,r){if(this.interruptAfter?.length>0&&cl(this.checkpoint,this.interruptAfter,[t])){this.toInterrupt.push(t);return}let i=Gd([Rt,t.path??[],a,t.id,r],this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,t.config??{},!0,{step:this.step,checkpointer:this.checkpointer,manager:this.manager,store:this.store,stream:this.stream});if(i){if(this.interruptBefore?.length>0&&cl(this.checkpoint,this.interruptBefore,[i])){this.toInterrupt.push(i);return}return this._emit(Gn(nr(v_(this.step,[i]),"debug"))),this.debug&&O_(this.step,[i]),this.tasks[i.id]=i,this.skipDoneTasks&&this._matchWrites({[i.id]:i}),i}}_suppressInterrupt(t){return Fn(t)&&!this.isNested}async _first(t){let{configurable:a}=this.config,r=a?.[Ur];if(r&&r.nullResume!==void 0&&this.putWrites(Lt,[[Ct,r.nullResume]]),ut(this.input)){if(this.input.resume!=null&&this.checkpointer==null)throw new Error("Cannot use Command(resume=...) without checkpointer");let s={};for(let[o,l,u]of FP(this.input,this.checkpointPendingWrites))s[o]===void 0&&(s[o]=[]),s[o].push([l,u]);if(Object.keys(s).length===0)throw new e_("Received empty Command input");for(let[o,l]of Object.entries(s))this.putWrites(o,l)}let i=(this.checkpointPendingWrites??[]).filter(s=>s[0]===Lt).map(s=>s.slice(1));i.length>0&&Ot(this.checkpoint,this.channels,[{name:Da,writes:i,triggers:[]}],this.checkpointerGetNextVersion);let n=ut(this.input)&&i.length>0;if(this.isResuming||n){for(let o of Object.keys(this.channels))if(this.checkpoint.channel_versions[o]!==void 0){let l=this.checkpoint.channel_versions[o];this.checkpoint.versions_seen[Ae]={...this.checkpoint.versions_seen[Ae],[o]:l}}let s=await sr(nr(qd(this.outputKeys,!0,this.channels),"values"));this._emit(s)}if(this.isResuming)this.input=Kd;else if(n)await this._putCheckpoint({source:"input",writes:{}}),this.input=hl;else{let s=await sr(y_(t,this.input));if(s.length>0){let o=Yn(this.checkpoint,this.checkpointPendingWrites,this.nodes,this.channels,this.managed,this.config,!0,{step:this.step});Ot(this.checkpoint,this.channels,Object.values(o).concat([{name:Da,writes:s,triggers:[]}]),this.checkpointerGetNextVersion),await this._putCheckpoint({source:"input",writes:Object.fromEntries(s)}),this.input=hl}else if(ir in(this.config.configurable??{}))this.input=hl;else throw new e_(`Received no input writes for ${JSON.stringify(t,null,2)}`)}this.isNested||(this.config=or(this.config,{[ir]:this.isResuming}))}_emit(t){for(let a of t)this.stream.modes.has(a[0])&&this.stream.push([this.checkpointNamespace,...a])}async _putCheckpoint(t){let a={...t,step:this.step,parents:this.config.configurable?.[Nt]??{}};if(this.checkpointer!==void 0){this.prevCheckpointConfig=this.checkpointConfig?.configurable?.checkpoint_id?this.checkpointConfig:void 0,this.checkpointMetadata=a,this.checkpoint=Lr(this.checkpoint,this.channels,this.step),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_ns:this.config.configurable?.checkpoint_ns??""}};let r={...this.checkpoint.channel_versions},i=Wd(this.checkpointPreviousVersions,r);this.checkpointPreviousVersions=r,this._checkpointerPutAfterPrevious({config:{...this.checkpointConfig},checkpoint:Qo(this.checkpoint),metadata:{...this.checkpointMetadata},newVersions:i}),this.checkpointConfig={...this.checkpointConfig,configurable:{...this.checkpointConfig.configurable,checkpoint_id:this.checkpoint.id}}}this.step+=1}_matchWrites(t){for(let[a,r,i]of this.checkpointPendingWrites){if(r===vt||r===Ae||r===Ct)continue;let n=Object.values(t).find(s=>s.id===a);n&&n.writes.push([r,i])}for(let a of Object.values(t))a.writes.length>0&&this._outputWrites(a.id,a.writes,!0)}};_i(),rr();function rA(e){return mt(e?.message)}var iA=class extends pn{constructor(e){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"StreamMessagesHandler"}),Object.defineProperty(this,"streamFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadatas",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"emittedChatModelRunIds",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"stableMessageIdMap",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.streamFn=e}_emit(e,t,a,r=!1){var i;if(r&&t.id!==void 0&&this.seen[t.id]!==void 0)return;let n=t.id;a!=null&&(R1(t)?n??(n=`run-${a}-tool-${t.tool_call_id}`):((n==null||n===`run-${a}`)&&(n=this.stableMessageIdMap[a]??n??`run-${a}`),(i=this.stableMessageIdMap)[a]??(i[a]=n))),n!==t.id&&(t.id=n,t.lc_kwargs.id=n),t.id!=null&&(this.seen[t.id]=t),this.streamFn([e[0],"messages",[t,e[1]]])}handleChatModelStart(e,t,a,r,i,n,s,o){s&&(!n||!n.includes(EP)&&!n.includes("nostream"))&&(this.metadatas[a]=[s.langgraph_checkpoint_ns.split("|"),{tags:n,name:o,...s}])}handleLLMNewToken(e,t,a,r,i,n){let s=n?.chunk;this.emittedChatModelRunIds[a]=!0,this.metadatas[a]!==void 0&&(rA(s)?this._emit(this.metadatas[a],s.message,a):this._emit(this.metadatas[a],new xr({content:e}),a))}handleLLMEnd(e,t){if(!this.emittedChatModelRunIds[t]){let a=e.generations?.[0]?.[0];mt(a?.message)&&this._emit(this.metadatas[t],a?.message,t,!0),delete this.emittedChatModelRunIds[t]}delete this.metadatas[t],delete this.stableMessageIdMap[t]}handleLLMError(e,t){delete this.metadatas[t]}handleChainStart(e,t,a,r,i,n,s,o){if(n!==void 0&&o===n.langgraph_node&&(i===void 0||!i.includes(Se))&&(this.metadatas[a]=[n.langgraph_checkpoint_ns.split("|"),{tags:i,name:o,...n}],typeof t=="object")){for(let l of Object.values(t))if((mt(l)||vc(l))&&l.id!==void 0)this.seen[l.id]=l;else if(Array.isArray(l))for(let u of l)(mt(u)||vc(u))&&u.id!==void 0&&(this.seen[u.id]=u)}}handleChainEnd(e,t){let a=this.metadatas[t];if(delete this.metadatas[t],a!==void 0){if(mt(e))this._emit(a,e,t,!0);else if(Array.isArray(e))for(let r of e)mt(r)&&this._emit(a,r,t,!0);else if(e!=null&&typeof e=="object"){for(let r of Object.values(e))if(mt(r))this._emit(a,r,t,!0);else if(Array.isArray(r))for(let i of r)mt(i)&&this._emit(a,i,t,!0)}}}handleChainError(e,t){delete this.metadatas[t]}},nA=500,sA=2,oA=128e3,lA=3,uA=[400,401,402,403,404,405,406,407,409],cA=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||e.name==="AbortError"||e?.code==="ECONNABORTED")return!1;let t=e?.response?.status??e?.status;return!(t&&uA.includes(+t)||e?.error?.code==="insufficient_quota")};async function P_(e,t,a,r){let i=e.retry_policy??t,n=i!==void 0?i.initialInterval??nA:0,s=0,o,l,{config:u}=e;for(a&&(u=or(u,a)),u={...u,signal:r};!r?.aborted;){e.writes.splice(0,e.writes.length),o=void 0;try{l=await e.proc.invoke(e.input,u);break}catch(c){if(o=c,o.pregelTaskId=e.id,Ix(o)){let p=u?.configurable?.checkpoint_ns,f=o.command;if(f.graph===p){for(let m of e.writers)await m.invoke(f,u);o=void 0;break}else if(f.graph===ea.PARENT){let m=CP(p);o.command=new ea({...o.command,graph:m})}}if(Jo(o)||i===void 0||(s+=1,s>=(i.maxAttempts??lA))||!(i.retryOn??cA)(o))break;n=Math.min(i.maxInterval??oA,n*(i.backoffFactor??sA));let d=i.jitter?Math.floor(n+Math.random()*1e3):n;await new Promise(p=>setTimeout(p,d));let h=o.name??o.constructor.unminifiable_name??o.constructor.name;(i?.logWarning??!0)&&console.log(`Retrying task "${String(e.name)}" after ${n.toFixed(2)}ms (attempt ${s}) after ${h}: ${o}`),u=or(u,{[ir]:!0})}}return{task:e,result:l,error:o,signalAborted:r?.aborted}}var Xd=Symbol.for("promiseAdded");function dA(){let e={next:()=>{},wait:Promise.resolve(Xd)};function t(a){e.next=()=>{e.wait=new Promise(t),a(Xd)}}return e.wait=new Promise(t),e}var hA=class{constructor({loop:e,nodeFinished:t}){Object.defineProperty(this,"nodeFinished",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.loop=e,this.nodeFinished=t}async tick(e={}){let{timeout:t,retryPolicy:a,onStepWrite:r,maxConcurrency:i}=e,n=new Set,s,o=new AbortController,l=Object.values(this.loop.tasks).filter(d=>d.writes.length===0),u=this._initializeAbortSignals({exceptionSignalController:o,timeout:t,signal:e.signal}),c=this._executeTasksWithRetry(l,{signals:u,retryPolicy:a,maxConcurrency:i});for await(let{task:d,error:h,signalAborted:p}of c)this._commit(d,h),Fn(h)||Jo(h)&&!Fn(s)?s=h:h&&(n.size===0||!p)&&(o.abort(),n.add(h));if(r?.(this.loop.step,Object.values(this.loop.tasks).map(d=>d.writes).flat()),n.size===1)throw Array.from(n)[0];if(n.size>1)throw new AggregateError(Array.from(n),`Multiple errors occurred during superstep ${this.loop.step}. See the "errors" field of this exception for more details.`);if(Fn(s)||Jo(s)&&this.loop.isNested)throw s}_initializeAbortSignals({exceptionSignalController:e,timeout:t,signal:a}){let r=this.loop.config.configurable?.[p_]??{},i=a&&r.composedAbortSignal&&a!==r.composedAbortSignal?Di(r.externalAbortSignal,a):r.externalAbortSignal??a,n=r.errorAbortSignal?Di(r.errorAbortSignal,e.signal):e.signal,s=t?AbortSignal.timeout(t):void 0,o=Di(...i?[i]:[],...s?[s]:[],n),l={externalAbortSignal:i,errorAbortSignal:n,timeoutAbortSignal:s,composedAbortSignal:o};return this.loop.config=or(this.loop.config,{[p_]:l}),l}async*_executeTasksWithRetry(e,t){let{retryPolicy:a,maxConcurrency:r,signals:i}=t??{},n=dA(),s={},o={executingTasksMap:s,barrier:n,retryPolicy:a,scheduleTask:async(h,p,f)=>this.loop.acceptPush(h,p,f)};if(i?.composedAbortSignal?.aborted)throw new Error("Abort");let l=0,u,c=i?.externalAbortSignal||i?.timeoutAbortSignal?Di(...i.externalAbortSignal?[i.externalAbortSignal]:[],...i.timeoutAbortSignal?[i.timeoutAbortSignal]:[]):void 0,d=c?new Promise((h,p)=>{u=()=>p(new Error("Abort")),c.addEventListener("abort",u,{once:!0})}):void 0;for(;(l===0||Object.keys(s).length>0)&&e.length;){for(;Object.values(s).length<(r??e.length)&&l<e.length;l+=1){let p=e[l];s[p.id]=P_(p,a,{[Rd]:A_?.bind(o,this,p)},i?.composedAbortSignal).catch(f=>({task:p,error:f,signalAborted:i?.composedAbortSignal?.aborted}))}let h=await Promise.race([...Object.values(s),...d?[d]:[],n.wait]);h!==Xd&&(yield h,delete s[h.task.id])}}_commit(e,t){if(t!==void 0)if(Fn(t)){if(t.interrupts.length){let a=t.interrupts.map(i=>[Ae,i]),r=e.writes.filter(i=>i[0]===Ct);r.length&&a.push(...r),this.loop.putWrites(e.id,a)}}else Jo(t)&&e.writes.length?this.loop.putWrites(e.id,e.writes):this.loop.putWrites(e.id,[[vt,{message:t.message,name:t.name}]]);else this.nodeFinished&&(e.config?.tags==null||!e.config.tags.includes(Se))&&this.nodeFinished(String(e.name)),e.writes.length===0&&e.writes.push([Md,null]),this.loop.putWrites(e.id,e.writes)}};async function A_(e,t,a,r,i,n={}){let s=t.config?.configurable?.[Ur];if(!s)throw new Error(`BUG: No scratchpad found on task ${t.name}__${t.id}`);let o=s.callCounter;s.callCounter+=1;let l=new WP({func:a,name:r,input:i,retry:n.retry,callbacks:n.callbacks}),u=await this.scheduleTask(t,o,l);if(!u)return;let c=this.executingTasksMap[u.id];if(c!==void 0)return c;if(u.writes.length>0){let d=u.writes.filter(([p])=>p===Vn),h=u.writes.filter(([p])=>p===vt);if(d.length>0){if(d.length===1)return Promise.resolve(d[0][1]);throw new Error(`BUG: multiple returns found for task ${u.name}__${u.id}`)}if(h.length>0){if(h.length===1){let p=h[0][1],f=p instanceof Error?p:new Error(String(p));return Promise.reject(f)}throw new Error(`BUG: multiple errors found for task ${u.name}__${u.id}`)}return}else{let d=P_(u,n.retry,{[Rd]:A_.bind(this,e,u)});return this.executingTasksMap[u.id]=d,this.barrier.next(),d.then(({result:h,error:p})=>p?Promise.reject(p):h)}}function pA(e){return typeof e=="string"}var fA=class{static subscribeTo(e,t){let{key:a,tags:r}={key:void 0,tags:void 0,...t??{}};if(Array.isArray(e)&&a!==void 0)throw new Error("Can't specify a key when subscribing to multiple channels");let i;pA(e)?a?i={[a]:e}:i=[e]:i=Object.fromEntries(e.map(s=>[s,s]));let n=Array.isArray(e)?e:[e];return new Mi({channels:i,triggers:n,tags:r})}static writeTo(e,t){let a=[];for(let r of e)a.push({channel:r,value:Fa,skipNone:!1});for(let[r,i]of Object.entries(t??{}))ge.isRunnable(i)||typeof i=="function"?a.push({channel:r,value:Fa,skipNone:!0,mapper:bt(i)}):a.push({channel:r,value:i,skipNone:!1});return new Ge(a)}},S_=class extends ge{static lc_name(){return"LangGraph"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langgraph","pregel"]}),Object.defineProperty(this,"lg_is_pregel",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoValidate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamMode",{enumerable:!0,configurable:!0,writable:!0,value:["values"]}),Object.defineProperty(this,"streamChannels",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptAfter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interruptBefore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stepTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"checkpointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryPolicy",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"store",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{streamMode:t}=e;t!=null&&!Array.isArray(t)&&(t=[t]),this.nodes=e.nodes,this.channels=e.channels,this.autoValidate=e.autoValidate??this.autoValidate,this.streamMode=t??this.streamMode,this.inputChannels=e.inputChannels,this.outputChannels=e.outputChannels,this.streamChannels=e.streamChannels??this.streamChannels,this.interruptAfter=e.interruptAfter,this.interruptBefore=e.interruptBefore,this.stepTimeout=e.stepTimeout??this.stepTimeout,this.debug=e.debug??this.debug,this.checkpointer=e.checkpointer,this.retryPolicy=e.retryPolicy,this.config=e.config,this.store=e.store,this.name=e.name,this.autoValidate&&this.validate()}withConfig(e){let t=Wt(this.config,e);return new this.constructor({...this,config:t})}validate(){return DP({nodes:this.nodes,channels:this.channels,outputChannels:this.outputChannels,inputChannels:this.inputChannels,streamChannels:this.streamChannels,interruptAfterNodes:this.interruptAfter,interruptBeforeNodes:this.interruptBefore}),this}get streamChannelsList(){return Array.isArray(this.streamChannels)?this.streamChannels:this.streamChannels?[this.streamChannels]:Object.keys(this.channels)}get streamChannelsAsIs(){return this.streamChannels?this.streamChannels:Object.keys(this.channels)}async getGraphAsync(e){return this.getGraph(e)}*getSubgraphs(e,t){for(let[a,r]of Object.entries(this.nodes)){if(e!==void 0&&!e.startsWith(a))continue;let i=r.subgraphs?.length?r.subgraphs:[r.bound];for(let n of i){let s=__(n);if(s!==void 0){if(a===e){yield[a,s];return}if(e===void 0&&(yield[a,s]),t){let o=e;e!==void 0&&(o=e.slice(a.length+1));for(let[l,u]of s.getSubgraphs(o,t))yield[`${a}${lt}${l}`,u]}}}}}async*getSubgraphsAsync(e,t){yield*this.getSubgraphs(e,t)}async _prepareStateSnapshot({config:e,saved:t,subgraphCheckpointer:a,applyPendingWrites:r=!1}){if(t===void 0)return{values:{},next:[],config:e,tasks:[]};let{managed:i}=await this.prepareSpecs(e,{skipManaged:!0}),n=al(this.channels,t.checkpoint);if(t.pendingWrites?.length){let h=t.pendingWrites.filter(([p,f])=>p===Lt).map(([p,f,m])=>[String(f),m]);h.length>0&&Ot(t.checkpoint,n,[{name:Da,writes:h,triggers:[]}])}let s=Object.values(Yn(t.checkpoint,t.pendingWrites,this.nodes,n,i,t.config,!0,{step:(t.metadata?.step??-1)+1,store:this.store})),o=await sr(this.getSubgraphsAsync()),l=t.config.configurable?.checkpoint_ns??"",u={};for(let h of s){let p=o.find(([m])=>m===h.name);if(!p)continue;let f=`${String(h.name)}${Dr}${h.id}`;if(l&&(f=`${l}${lt}${f}`),a===void 0){let m={configurable:{thread_id:t.config.configurable?.thread_id,checkpoint_ns:f}};u[h.id]=m}else{let m={configurable:{[Te]:a,thread_id:t.config.configurable?.thread_id,checkpoint_ns:f}},g=p[1];u[h.id]=await g.getState(m,{subgraphs:!0})}}if(r&&t.pendingWrites?.length){let h=Object.fromEntries(s.map(f=>[f.id,f]));for(let[f,m,g]of t.pendingWrites)[vt,Ae,Ko].includes(m)||f in h&&h[f].writes.push([String(m),g]);let p=s.filter(f=>f.writes.length>0);p.length>0&&Ot(t.checkpoint,n,p)}let c=t?.metadata;c&&t?.config?.configurable?.thread_id&&(c={...c,thread_id:t.config.configurable.thread_id});let d=s.filter(h=>h.writes.length===0).map(h=>h.name);return{values:zr(n,this.streamChannelsAsIs),next:d,tasks:w_(s,t?.pendingWrites??[],u),metadata:c,config:Ui(t.config,t.metadata),createdAt:t.checkpoint.ts,parentConfig:t.parentConfig}}async getState(e,t){let a=e.configurable?.[Te]??this.checkpointer;if(!a)throw new X0("No checkpointer set");let r=e.configurable?.checkpoint_ns??"";if(r!==""&&e.configurable?.[Te]===void 0){let s=zd(r);for await(let[o,l]of this.getSubgraphsAsync(s,!0))if(o===s)return await l.getState(Jn(e,{[Te]:a}),{subgraphs:t?.subgraphs});throw new Error(`Subgraph with namespace "${s}" not found.`)}let i=Wt(this.config,e),n=await a.getTuple(e);return await this._prepareStateSnapshot({config:i,saved:n,subgraphCheckpointer:t?.subgraphs?a:void 0,applyPendingWrites:!e.configurable?.checkpoint_id})}async*getStateHistory(e,t){let a=e.configurable?.[Te]??this.checkpointer;if(!a)throw new Error("No checkpointer set");let r=e.configurable?.checkpoint_ns??"";if(r!==""&&e.configurable?.[Te]===void 0){let n=zd(r);for await(let[s,o]of this.getSubgraphsAsync(n,!0))if(s===n){yield*o.getStateHistory(Jn(e,{[Te]:a}),t);return}throw new Error(`Subgraph with namespace "${n}" not found.`)}let i=Wt(this.config,e,{configurable:{checkpoint_ns:r}});for await(let n of a.list(i,t))yield this._prepareStateSnapshot({config:n.config,saved:n})}async bulkUpdateState(e,t){let a=e.configurable?.[Te]??this.checkpointer;if(!a)throw new X0("No checkpointer set");if(t.length===0)throw new Error("No supersteps provided");if(t.some(s=>s.updates.length===0))throw new Error("No updates provided");let r=e.configurable?.checkpoint_ns??"";if(r!==""&&e.configurable?.[Te]===void 0){let s=zd(r);for await(let[,o]of this.getSubgraphsAsync(s,!0))return await o.bulkUpdateState(Jn(e,{[Te]:a}),t);throw new Error(`Subgraph "${s}" not found`)}let i=async(s,o)=>{let l=this.config?Wt(this.config,s):s,u=await a.getTuple(l),c=u!==void 0?Qo(u.checkpoint):u_(),d={...u?.checkpoint.channel_versions},h=u?.metadata?.step??-1,p=Jn(l,{checkpoint_ns:l.configurable?.checkpoint_ns??""}),f=l.metadata??{};u?.config.configurable&&(p=Jn(l,u.config.configurable),f={...u.metadata,...f});let{values:m,asNode:g}=o[0];if(m==null&&g===void 0){if(o.length>1)throw new xe("Cannot create empty checkpoint with multiple updates");let E=await a.put(p,Lr(c,void 0,h),{source:"update",step:h+1,writes:{},parents:u?.metadata?.parents??{}},{});return Ui(E,u?u.metadata:void 0)}let b=al(this.channels,c),{managed:y}=await this.prepareSpecs(l,{skipManaged:!0});if(m===null&&g===se){if(o.length>1)throw new xe("Cannot apply multiple updates when clearing state");if(u){let A=Yn(c,u.pendingWrites||[],this.nodes,b,y,u.config,!0,{step:(u.metadata?.step??-1)+1,checkpointer:this.checkpointer||void 0,store:this.store}),x=(u.pendingWrites||[]).filter(te=>te[0]===Lt).map(te=>te.slice(1));x.length>0&&Ot(u.checkpoint,b,[{name:Da,writes:x,triggers:[]}]);for(let[te,Le,Xe]of u.pendingWrites||[])[vt,Ae,Ko].includes(Le)||te in A&&A[te].writes.push([Le,Xe]);Ot(c,b,Object.values(A))}let E=await a.put(p,Lr(c,void 0,h),{...f,source:"update",step:h+1,writes:{},parents:u?.metadata?.parents??{}},{});return Ui(E,u?u.metadata:void 0)}if(m==null&&g===vP){if(o.length>1)throw new xe("Cannot copy checkpoint with multiple updates");let E=await a.put(u?.parentConfig??p,Lr(c,void 0,h),{source:"fork",step:h+1,writes:{},parents:u?.metadata?.parents??{}},{});return Ui(E,u?u.metadata:void 0)}if(g===Da){if(o.length>1)throw new xe("Cannot apply multiple updates when updating as input");let E=await sr(y_(this.inputChannels,m));if(E.length===0)throw new xe(`Received no input writes for ${JSON.stringify(this.inputChannels,null,2)}`);Ot(c,b,[{name:Da,writes:E,triggers:[]}],a.getNextVersion.bind(this.checkpointer));let A=u?.metadata?.step!=null?u.metadata.step+1:-1,x=await a.put(p,Lr(c,b,A),{source:"input",step:A,writes:Object.fromEntries(E),parents:u?.metadata?.parents??{}},Wd(d,c.channel_versions));return await a.putWrites(x,E,Ti(Da,c.id)),Ui(x,u?u.metadata:void 0)}if(l.configurable?.checkpoint_id===void 0&&u?.pendingWrites!==void 0&&u.pendingWrites.length>0){let E=Yn(c,u.pendingWrites,this.nodes,b,y,u.config,!0,{store:this.store,checkpointer:this.checkpointer,step:(u.metadata?.step??-1)+1}),A=(u.pendingWrites??[]).filter(te=>te[0]===Lt).map(te=>te.slice(1));A.length>0&&Ot(u.checkpoint,b,[{name:Da,writes:A,triggers:[]}]);for(let[te,Le,Xe]of u.pendingWrites)[vt,Ae,Ko].includes(Le)||E[te]===void 0||E[te].writes.push([Le,Xe]);let x=Object.values(E).filter(te=>te.writes.length>0);x.length>0&&Ot(c,b,x)}let _=Object.values(c.versions_seen).map(E=>Object.values(E)).flat().find(E=>!!E),w=[];if(o.length===1){let{values:E,asNode:A}=o[0];if(A===void 0&&Object.keys(this.nodes).length===1)[A]=Object.keys(this.nodes);else if(A===void 0&&_===void 0)typeof this.inputChannels=="string"&&this.nodes[this.inputChannels]!==void 0&&(A=this.inputChannels);else if(A===void 0){let x=Object.entries(c.versions_seen).map(([te,Le])=>Object.values(Le).map(Xe=>[Xe,te])).flat().sort(([te],[Le])=>c_(te,Le));x&&(x.length===1?A=x[0][1]:x[x.length-1][0]!==x[x.length-2][0]&&(A=x[x.length-1][1]))}if(A===void 0)throw new xe('Ambiguous update, specify "asNode"');w.push({values:E,asNode:A})}else for(let{asNode:E,values:A}of o){if(E==null)throw new xe('"asNode" is required when applying multiple updates');w.push({values:A,asNode:E})}let O=[];for(let{asNode:E,values:A}of w){if(this.nodes[E]===void 0)throw new xe(`Node "${E.toString()}" does not exist`);let x=this.nodes[E].getWriters();if(!x.length)throw new xe(`No writers found for node "${E.toString()}"`);O.push({name:E,input:A,proc:x.length>1?Ma.from(x,{omitSequenceTags:!0}):x[0],writes:[],triggers:[Ae],id:Ti(Ae,c.id),writers:[]})}for(let E of O)await E.proc.invoke(E.input,Pe({...l,store:l?.store??this.store},{runName:l.runName??`${this.getName()}UpdateState`,configurable:{[Ni]:A=>E.writes.push(...A),[Mr]:(A,x=!1)=>dl(h,c,b,y,E,A,x)}}));for(let E of O){let A=E.writes.filter(x=>x[0]!==Rt);u!==void 0&&A.length>0&&await a.putWrites(p,A,E.id)}Ot(c,b,O,a.getNextVersion.bind(this.checkpointer));let j=Wd(d,c.channel_versions),S=await a.put(p,Lr(c,b,h+1),{source:"update",step:h+1,writes:Object.fromEntries(w.map(E=>[E.asNode,E.values])),parents:u?.metadata?.parents??{}},j);for(let E of O){let A=E.writes.filter(x=>x[0]===Rt);A.length>0&&await a.putWrites(S,A,E.id)}return Ui(S,u?u.metadata:void 0)},n=e;for(let{updates:s}of t)n=await i(n,s);return n}async updateState(e,t,a){return this.bulkUpdateState(e,[{updates:[{values:t,asNode:a}]}])}_defaults(e){let{debug:t,streamMode:a,inputKeys:r,outputKeys:i,interruptAfter:n,interruptBefore:s,...o}=e,l=!0,u=t!==void 0?t:this.debug,c=i;c===void 0?c=this.streamChannelsAsIs:g_(c,this.channels);let d=r;d===void 0?d=this.inputChannels:g_(d,this.channels);let h=s??this.interruptBefore??[],p=n??this.interruptAfter??[],f;a!==void 0?(f=Array.isArray(a)?a:[a],l=typeof a=="string"):(f=this.streamMode,l=!0),e.configurable?.[qn]!==void 0&&(f=["values"]);let m;this.checkpointer===!1?m=void 0:e!==void 0&&e.configurable?.[Te]!==void 0?m=e.configurable[Te]:m=this.checkpointer;let g=e.store??this.store;return[u,f,d,c,o,h,p,m,g,l]}async stream(e,t){let a=new AbortController,r={recursionLimit:this.config?.recursionLimit,...t,signal:t?.signal?Di(t.signal,a.signal):a.signal};return new E_(await super.stream(e,r),a)}streamEvents(e,t,a){let r=new AbortController,i={recursionLimit:this.config?.recursionLimit,callbacks:this.config?.callbacks,...t,signal:t?.signal?Di(t.signal,r.signal):r.signal};return new E_(super.streamEvents(e,i,a),r)}async prepareSpecs(e,t){let a={...e,store:this.store},r={},i={};for(let[s,o]of Object.entries(this.channels))el(o)?r[s]=o:t?.skipManaged?i[s]={cls:jP,params:{config:{}}}:i[s]=o;let n=new SP(await Object.entries(i).reduce(async(s,[o,l])=>{let u=await s,c;return ol(l)?("key"in l.params&&l.params.key===AP&&(l.params.key=o),c=await l.cls.initialize(a,l.params)):c=await l.initialize(a),c!==void 0&&u.push([o,c]),u},Promise.resolve([])));return{channelSpecs:r,managed:n}}async _validateInput(e){return e}async _validateConfigurable(e){return e}async*_streamIterator(e,t){let a=t?.subgraphs,r=m_(this.config,t);if(r.recursionLimit===void 0||r.recursionLimit<1)throw new Error('Passed "recursionLimit" must be at least 1.');if(this.checkpointer!==void 0&&this.checkpointer!==!1&&r.configurable===void 0)throw new Error('Checkpointer requires one or more of the following "configurable" keys: "thread_id", "checkpoint_ns", "checkpoint_id"');let i=await this._validateInput(e),{runId:n,...s}=r,[o,l,,u,c,d,h,p,f,m]=this._defaults(s);c.configurable=await this._validateConfigurable(c.configurable);let g=new x_({modes:new Set(l)});if(l.includes("messages")){let S=new iA(A=>g.push(A)),{callbacks:E}=c;if(E===void 0)c.callbacks=[S];else if(Array.isArray(E))c.callbacks=E.concat(S);else{let A=E.copy();A.addHandler(S,!0),c.callbacks=A}}l.includes("custom")&&(c.writer=S=>g.push([[],"custom",S]));let b=await(await $t(c))?.handleChainStart(this.toJSON(),GP(e,"input"),n,void 0,void 0,void 0,c?.runName??this.getName()),{channelSpecs:y,managed:_}=await this.prepareSpecs(c),w,O,j=(async()=>{try{w=await aA.initialize({input:i,config:c,checkpointer:p,nodes:this.nodes,channelSpecs:y,managed:_,outputKeys:u,streamKeys:this.streamChannelsAsIs,store:f,stream:g,interruptAfter:h,interruptBefore:d,manager:b,debug:this.debug});let S=new hA({loop:w,nodeFinished:c.configurable?.[kP]});t?.subgraphs&&(w.config.configurable={...w.config.configurable,[rl]:w.stream}),await this._runLoop({loop:w,runner:S,debug:o,config:c})}catch(S){O=S}finally{try{w&&await w.store?.stop(),await Promise.all([...w?.checkpointerPromises??[],...Array.from(_.values()).map(S=>S.promises())])}catch(S){O=O??S}O?g.error(O):g.close()}})();try{for await(let S of g){if(S===void 0)throw new Error("Data structure error.");let[E,A,x]=S;l.includes(A)&&(a&&!m?yield[E,A,x]:m?a?yield[E,x]:yield x:yield[A,x])}}catch(S){throw await b?.handleChainError(O),S}finally{await j}await b?.handleChainEnd(w?.output??{},n,void 0,void 0,void 0)}async invoke(e,t){let a=t?.streamMode??"values",r={...t,outputKeys:t?.outputKeys??this.outputChannels,streamMode:a},i=[],n=await this.stream(e,r);for await(let s of n)i.push(s);return a==="values"?i[i.length-1]:i}async _runLoop(e){let{loop:t,runner:a,debug:r,config:i}=e,n;try{for(;await t.tick({inputKeys:this.inputChannels});)r&&qP(t.checkpointMetadata.step,t.channels,this.streamChannelsList),r&&O_(t.step,Object.values(t.tasks)),await a.tick({timeout:this.stepTimeout,retryPolicy:this.retryPolicy,onStepWrite:(s,o)=>{r&&VP(s,o,this.streamChannelsList)},maxConcurrency:i.maxConcurrency,signal:i.signal});if(t.status==="out_of_steps")throw new jx([`Recursion limit of ${i.recursionLimit} reached`,"without hitting a stop condition. You can increase the",'limit by setting the "recursionLimit" config key.'].join(" "),{lc_error_code:"GRAPH_RECURSION_LIMIT"})}catch(s){if(n=s,!await t.finishAndHandleError(n))throw s}finally{n===void 0&&await t.finishAndHandleError()}}},Br=class pO extends tl{constructor(t=!0){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"EphemeralValue"}),Object.defineProperty(this,"guard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.guard=t}fromCheckpoint(t){let a=new pO(this.guard);return typeof t<"u"&&(a.value=[t]),a}update(t){if(t.length===0){let a=this.value.length>0;return this.value=[],a}if(t.length!==1&&this.guard)throw new xe("EphemeralValue can only receive one value per step.");return this.value=[t[t.length-1]],!0}get(){if(this.value.length===0)throw new ot;return this.value[0]}checkpoint(){if(this.value.length===0)throw new ot;return this.value[0]}},j_=class{constructor(e){Object.defineProperty(this,"path",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ends",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),ge.isRunnable(e.path)?this.path=e.path:this.path=bt(e.path).withConfig({runName:"Branch"}),this.ends=Array.isArray(e.pathMap)?e.pathMap.reduce((t,a)=>(t[a]=a,t),{}):e.pathMap}run(e,t){return Ge.registerWriter(new ya({name:"<branch_run>",trace:!1,func:async(a,r)=>{try{return await this._route(a,r,e,t)}catch(i){throw i.name===Y0.unminifiable_name&&console.warn(`[WARN]: 'NodeInterrupt' thrown in conditional edge. This is likely a bug in your graph implementation.
NodeInterrupt should only be thrown inside a node, not in edge conditions.`),i}}}))}async _route(e,t,a,r){let i=await this.path.invoke(r?r(t):e,t);Array.isArray(i)||(i=[i]);let n;if(this.ends?n=i.map(s=>wt(s)?s:this.ends[s]):n=i,n.some(s=>!s))throw new Error("Branch condition returned unknown or null destination");if(n.filter(wt).some(s=>s.node===se))throw new xe("Cannot send a packet to the END node");return await a(n,t)??e}},mA=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"branches",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"entryPoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"compiled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.nodes={},this.edges=new Set,this.branches={}}warnIfCompiled(e){this.compiled&&console.warn(e)}get allEdges(){return this.edges}addNode(...e){function t(r){return r.length>=1&&typeof r[0]!="string"}let a=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(a.length===0)throw new Error("No nodes provided in `addNode`");for(let[r,i,n]of a){for(let o of[lt,Dr])if(r.includes(o))throw new Error(`"${o}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),r in this.nodes)throw new Error(`Node \`${r}\` already present.`);if(r===se)throw new Error(`Node \`${r}\` is reserved.`);let s=bt(i);this.nodes[r]={runnable:s,metadata:n?.metadata,subgraphs:Vd(s)?[s]:n?.subgraphs,ends:n?.ends}}return this}addEdge(e,t){if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),e===se)throw new Error("END cannot be a start node");if(t===_e)throw new Error("START cannot be an end node");if(Array.from(this.edges).some(([a])=>a===e)&&!("channels"in this))throw new Error(`Already found path for ${e}. For multiple edges, use StateGraph.`);return this.edges.add([e,t]),this}addConditionalEdges(e,t,a){var r,i;let n=typeof e=="object"?e:{source:e,path:t,pathMap:a};if(this.warnIfCompiled("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph."),!ge.isRunnable(n.path)){let o=Array.isArray(n.pathMap)?n.pathMap.join(","):Object.keys(n.pathMap??{}).join(",");n.path=bt(n.path).withConfig({runName:`Branch<${n.source}${o!==""?`,${o}`:""}>`.slice(0,63)})}let s=n.path.getName()==="RunnableLambda"?"condition":n.path.getName();if(this.branches[n.source]&&this.branches[n.source][s])throw new Error(`Condition \`${s}\` already present for node \`${e}\``);return(r=this.branches)[i=n.source]??(r[i]={}),this.branches[n.source][s]=new j_(n),this}setEntryPoint(e){return this.warnIfCompiled("Setting the entry point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(_e,e)}setFinishPoint(e){return this.warnIfCompiled("Setting a finish point of a graph that has already been compiled. This will not be reflected in the compiled graph."),this.addEdge(e,se)}compile({checkpointer:e,interruptBefore:t,interruptAfter:a,name:r}={}){this.validate([...Array.isArray(t)?t:[],...Array.isArray(a)?a:[]]);let i=new I_({builder:this,checkpointer:e,interruptAfter:a,interruptBefore:t,autoValidate:!1,nodes:{},channels:{[_e]:new Br,[se]:new Br},inputChannels:_e,outputChannels:se,streamChannels:[],streamMode:"values",name:r});for(let[n,s]of Object.entries(this.nodes))i.attachNode(n,s);for(let[n,s]of this.edges)i.attachEdge(n,s);for(let[n,s]of Object.entries(this.branches))for(let[o,l]of Object.entries(s))i.attachBranch(n,o,l);return i.validate()}validate(e){let t=new Set([...this.allEdges].map(([r,i])=>r));for(let[r]of Object.entries(this.branches))t.add(r);for(let r of t)if(r!==_e&&!(r in this.nodes))throw new Error(`Found edge starting at unknown node \`${r}\``);let a=new Set([...this.allEdges].map(([r,i])=>i));for(let[r,i]of Object.entries(this.branches))for(let n of Object.values(i))if(n.ends!=null)for(let s of Object.values(n.ends))a.add(s);else{a.add(se);for(let s of Object.keys(this.nodes))s!==r&&a.add(s)}for(let r of Object.values(this.nodes))for(let i of r.ends??[])a.add(i);for(let r of Object.keys(this.nodes))if(!a.has(r))throw new $x([`Node \`${r}\` is not reachable.`,"","If you are returning Command objects from your node,",'make sure you are passing names of potential destination nodes as an "ends" array','into ".addNode(..., { ends: ["node1", "node2"] })".'].join(`
`),{lc_error_code:"UNREACHABLE_NODE"});for(let r of a)if(r!==se&&!(r in this.nodes))throw new Error(`Found edge ending at unknown node \`${r}\``);if(e){for(let r of e)if(!(r in this.nodes))throw new Error(`Interrupt node \`${r}\` is not present`)}this.compiled=!0}},I_=class extends S_{constructor({builder:e,...t}){super(t),Object.defineProperty(this,"builder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.builder=e}attachNode(e,t){this.channels[e]=new Br,this.nodes[e]=new Mi({channels:[],triggers:[],metadata:t.metadata,subgraphs:t.subgraphs,ends:t.ends}).pipe(t.runnable).pipe(new Ge([{channel:e,value:Fa}],[Se])),this.streamChannels.push(e)}attachEdge(e,t){if(t===se){if(e===_e)throw new Error("Cannot have an edge from START to END");this.nodes[e].writers.push(new Ge([{channel:se,value:Fa}],[Se]))}else this.nodes[t].triggers.push(e),this.nodes[t].channels.push(e)}attachBranch(e,t,a){e===_e&&!this.nodes[_e]&&(this.nodes[_e]=fA.subscribeTo(_e,{tags:[Se]})),this.nodes[e].pipe(a.run(i=>{let n=i.map(s=>wt(s)?s:{channel:s===se?se:`branch:${e}:${t}:${s}`,value:Fa});return new Ge(n,[Se])}));let r=a.ends?Object.values(a.ends):Object.keys(this.nodes);for(let i of r)if(i!==se){let n=`branch:${e}:${t}:${i}`;this.channels[n]=new Br,this.nodes[i].triggers.push(n),this.nodes[i].channels.push(n)}}async getGraphAsync(e){let t=e?.xray,a=new In,r={[_e]:a.addNode({schema:Ve.any()},_e)},i={},n={};t&&(n=Object.fromEntries((await sr(this.getSubgraphsAsync())).filter(l=>$_(l[1]))));function s(l,u,c,d=!1){if(u===se&&i[se]===void 0&&(i[se]=a.addNode({schema:Ve.any()},se)),r[l]!==void 0){if(i[u]===void 0)throw new Error(`End node ${u} not found!`);return a.addEdge(r[l],i[u],c!==u?c:void 0,d)}}for(let[l,u]of Object.entries(this.builder.nodes)){let c=Je(l),d=u.runnable,h=u.metadata??{};if(this.interruptBefore?.includes(l)&&this.interruptAfter?.includes(l)?h.__interrupt="before,after":this.interruptBefore?.includes(l)?h.__interrupt="before":this.interruptAfter?.includes(l)&&(h.__interrupt="after"),t){let p=typeof t=="number"?t-1:t,f=n[l]!==void 0?await n[l].getGraphAsync({...e,xray:p}):d.getGraph(e);if(f.trimFirstNode(),f.trimLastNode(),Object.keys(f.nodes).length>1){let m=function(_){return _?_.lc_runnable:!1},g=function(_,w){if(_!==void 0&&!ja(_))return _;if(m(w))try{let O=w.getName();return O=O.startsWith("Runnable")?O.slice(8):O,O}catch{return w.getName()}else return w.name??"UnknownSchema"},[b,y]=a.extend(f,c);if(b===void 0)throw new Error(`Could not extend subgraph "${l}" due to missing entrypoint.`);y!==void 0&&(r[c]={name:g(y.id,y.data),...y}),i[c]={name:g(b.id,b.data),...b}}else{let m=a.addNode(d,c,h);r[c]=m,i[c]=m}}else{let p=a.addNode(d,c,h);r[c]=p,i[c]=p}}let o=[...this.builder.allEdges].sort(([l],[u])=>l<u?-1:u>l?1:0);for(let[l,u]of o)s(Je(l),Je(u));for(let[l,u]of Object.entries(this.builder.branches)){let c={...Object.fromEntries(Object.keys(this.builder.nodes).filter(d=>d!==l).map(d=>[Je(d),Je(d)])),[se]:se};for(let d of Object.values(u)){let h;d.ends!==void 0?h=d.ends:h=c;for(let[p,f]of Object.entries(h))s(Je(l),Je(f),p,!0)}}for(let[l,u]of Object.entries(this.builder.nodes))if(u.ends!==void 0)for(let c of u.ends)s(Je(l),Je(c),void 0,!0);return a}getGraph(e){let t=e?.xray,a=new In,r={[_e]:a.addNode({schema:Ve.any()},_e)},i={},n={};t&&(n=Object.fromEntries(Gn(this.getSubgraphs()).filter(l=>$_(l[1]))));function s(l,u,c,d=!1){return u===se&&i[se]===void 0&&(i[se]=a.addNode({schema:Ve.any()},se)),a.addEdge(r[l],i[u],c!==u?c:void 0,d)}for(let[l,u]of Object.entries(this.builder.nodes)){let c=Je(l),d=u.runnable,h=u.metadata??{};if(this.interruptBefore?.includes(l)&&this.interruptAfter?.includes(l)?h.__interrupt="before,after":this.interruptBefore?.includes(l)?h.__interrupt="before":this.interruptAfter?.includes(l)&&(h.__interrupt="after"),t){let p=typeof t=="number"?t-1:t,f=n[l]!==void 0?n[l].getGraph({...e,xray:p}):d.getGraph(e);if(f.trimFirstNode(),f.trimLastNode(),Object.keys(f.nodes).length>1){let m=function(_){return _?_.lc_runnable:!1},g=function(_,w){if(_!==void 0&&!ja(_))return _;if(m(w))try{let O=w.getName();return O=O.startsWith("Runnable")?O.slice(8):O,O}catch{return w.getName()}else return w.name??"UnknownSchema"},[b,y]=a.extend(f,c);if(b===void 0)throw new Error(`Could not extend subgraph "${l}" due to missing entrypoint.`);y!==void 0&&(r[c]={name:g(y.id,y.data),...y}),i[c]={name:g(b.id,b.data),...b}}else{let m=a.addNode(d,c,h);r[c]=m,i[c]=m}}else{let p=a.addNode(d,c,h);r[c]=p,i[c]=p}}let o=[...this.builder.allEdges].sort(([l],[u])=>l<u?-1:u>l?1:0);for(let[l,u]of o)s(Je(l),Je(u));for(let[l,u]of Object.entries(this.builder.branches)){let c={...Object.fromEntries(Object.keys(this.builder.nodes).filter(d=>d!==l).map(d=>[Je(d),Je(d)])),[se]:se};for(let d of Object.values(u)){let h;d.ends!==void 0?h=d.ends:h=c;for(let[p,f]of Object.entries(h))s(Je(l),Je(f),p,!0)}}return a}};function $_(e){return typeof e.attachNode=="function"&&typeof e.attachEdge=="function"}function Je(e){return e==="subgraph"?`"${e}"`:e}var T_=(e,t)=>e.size===t.size&&[...e].every(a=>t.has(a)),gA=class fO extends tl{constructor(t){super(),Object.defineProperty(this,"lc_graph_name",{enumerable:!0,configurable:!0,writable:!0,value:"NamedBarrierValue"}),Object.defineProperty(this,"names",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.names=t,this.seen=new Set}fromCheckpoint(t){let a=new fO(this.names);return typeof t<"u"&&(a.seen=new Set(t)),a}update(t){let a=!1;for(let r of t)if(this.names.has(r))this.seen.has(r)||(this.seen.add(r),a=!0);else throw new xe(`Value ${JSON.stringify(r)} not in names ${JSON.stringify(this.names)}`);return a}get(){if(!T_(this.names,this.seen))throw new ot}checkpoint(){return[...this.seen]}consume(){return this.seen&&this.names&&T_(this.seen,this.names)?(this.seen=new Set,!0):!1}},N_=new WeakMap;function C_(e){return typeof e=="object"&&e!=null&&"_parse"in e&&typeof e._parse=="function"}function yA(e){return C_(e)&&"removeDefault"in e&&typeof e.removeDefault=="function"}function Ba(e){return C_(e)&&"partial"in e&&typeof e.partial=="function"}function bA(e,t){if(t.reducer&&!t.default){let a=yA(e)?e._def.defaultValue:void 0;a!=null&&(t.default=a)}return N_.set(e,t),e}function _A(e){return N_.get(e)}function Qn(e){let t={};for(let a in e.shape)if(Object.prototype.hasOwnProperty.call(e.shape,a)){let r=e.shape[a],i=_A(r);i?.reducer?t[a]=new Cd(i.reducer.fn,i.default):t[a]=new Zn}return t}var Za="__root__",vA=class extends mA{constructor(e,t){if(super(),Object.defineProperty(this,"channels",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"waitingEdges",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"_schemaDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_inputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_outputRuntimeDefinition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_configSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_configRuntimeSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),AA(e)){let a=Qn(e.state),r=e.input!=null?Qn(e.input):a,i=e.output!=null?Qn(e.output):a;this._schemaDefinition=a,this._schemaRuntimeDefinition=e.state,this._inputDefinition=r,this._inputRuntimeDefinition=e.input??e.state.partial(),this._outputDefinition=i,this._outputRuntimeDefinition=e.output??e.state}else if(Ba(e)){let a=Qn(e);this._schemaDefinition=a,this._schemaRuntimeDefinition=e,this._inputDefinition=a,this._inputRuntimeDefinition=e.partial(),this._outputDefinition=a,this._outputRuntimeDefinition=e}else if(PA(e))this._schemaDefinition=e.input.spec,this._inputDefinition=e.input.spec,this._outputDefinition=e.output.spec;else if(xA(e))this._schemaDefinition=e.stateSchema.spec,this._inputDefinition=e.input?.spec??this._schemaDefinition,this._outputDefinition=e.output?.spec??this._schemaDefinition;else if(kA(e)||R_(e)){let a=R_(e)?e.spec:e;this._schemaDefinition=a}else if(EA(e)){let a=wA(e.channels);this._schemaDefinition=a}else throw new Error("Invalid StateGraph input.");this._inputDefinition??(this._inputDefinition=this._schemaDefinition),this._outputDefinition??(this._outputDefinition=this._schemaDefinition),this._addSchema(this._schemaDefinition),this._addSchema(this._inputDefinition),this._addSchema(this._outputDefinition),Ba(t)&&(this._configRuntimeSchema=t.passthrough())}get allEdges(){return new Set([...this.edges,...Array.from(this.waitingEdges).flatMap(([e,t])=>e.map(a=>[a,t]))])}_addSchema(e){if(!this._schemaDefinitions.has(e)){this._schemaDefinitions.set(e,e);for(let[t,a]of Object.entries(e)){let r;if(typeof a=="function"?r=a():r=a,this.channels[t]!==void 0){if(this.channels[t]!==r&&!ol(r)&&r.lc_graph_name!=="LastValue")throw new Error(`Channel "${t}" already exists with a different type.`)}else this.channels[t]=r}}}addNode(...e){function t(r){return r.length>=1&&typeof r[0]!="string"}let a=t(e)?Array.isArray(e[0])?e[0]:Object.entries(e[0]):[[e[0],e[1],e[2]]];if(a.length===0)throw new Error("No nodes provided in `addNode`");for(let[r,i,n]of a){if(r in this.channels)throw new Error(`${r} is already being used as a state attribute (a.k.a. a channel), cannot also be used as a node name.`);for(let u of[lt,Dr])if(r.includes(u))throw new Error(`"${u}" is a reserved character and is not allowed in node names.`);if(this.warnIfCompiled("Adding a node to a graph that has already been compiled. This will not be reflected in the compiled graph."),r in this.nodes)throw new Error(`Node \`${r}\` already present.`);if(r===se||r===_e)throw new Error(`Node \`${r}\` is reserved.`);let s=this._schemaDefinition;n?.input!==void 0&&(Ba(n.input)?s=Qn(n.input):n.input.spec!==void 0&&(s=n.input.spec)),s!==void 0&&this._addSchema(s);let o;ge.isRunnable(i)?o=i:typeof i=="function"?o=new ya({func:i,name:r,trace:!1}):o=bt(i);let l={runnable:o,retryPolicy:n?.retryPolicy,metadata:n?.metadata,input:s??this._schemaDefinition,subgraphs:Vd(o)?[o]:n?.subgraphs,ends:n?.ends};this.nodes[r]=l}return this}addEdge(e,t){if(typeof e=="string")return super.addEdge(e,t);this.compiled&&console.warn("Adding an edge to a graph that has already been compiled. This will not be reflected in the compiled graph.");for(let a of e){if(a===se)throw new Error("END cannot be a start node");if(!Object.keys(this.nodes).some(r=>r===a))throw new Error(`Need to add a node named "${a}" first`)}if(t===se)throw new Error("END cannot be an end node");if(!Object.keys(this.nodes).some(a=>a===t))throw new Error(`Need to add a node named "${t}" first`);return this.waitingEdges.add([e,t]),this}addSequence(e){let t=Array.isArray(e)?e:Object.entries(e);if(t.length===0)throw new Error("Sequence requires at least one node.");let a;for(let[r,i,n]of t){if(r in this.nodes)throw new Error(`Node names must be unique: node with the name "${r}" already exists.`);let s=r;this.addNode(s,i,n),a!=null&&this.addEdge(a,s),a=s}return this}compile({checkpointer:e,store:t,interruptBefore:a,interruptAfter:r,name:i}={}){this.validate([...Array.isArray(a)?a:[],...Array.isArray(r)?r:[]]);let n=Object.keys(this._schemaDefinitions.get(this._outputDefinition)),s=n.length===1&&n[0]===Za?Za:n,o=Object.keys(this.channels),l=o.length===1&&o[0]===Za?Za:o,u=new OA({builder:this,checkpointer:e,interruptAfter:r,interruptBefore:a,autoValidate:!1,nodes:{},channels:{...this.channels,[_e]:new Br},inputChannels:_e,outputChannels:s,streamChannels:l,streamMode:"updates",store:t,name:i});u.attachNode(_e);for(let[c,d]of Object.entries(this.nodes))u.attachNode(c,d);u.attachBranch(_e,f_,L_(),{withReader:!1});for(let[c]of Object.entries(this.nodes))u.attachBranch(c,f_,L_(),{withReader:!1});for(let[c,d]of this.edges)u.attachEdge(c,d);for(let[c,d]of this.waitingEdges)u.attachEdge(c,d);for(let[c,d]of Object.entries(this.branches))for(let[h,p]of Object.entries(d))u.attachBranch(c,h,p);return u.validate()}};function wA(e){let t={};for(let[a,r]of Object.entries(e))if(a===Za)t[a]=Fd(r);else{let i=a;t[a]=Fd(r)}return t}var OA=class extends I_{attachNode(e,t){let a;e===_e?a=Object.entries(this.builder._schemaDefinitions.get(this.builder._inputDefinition)).filter(([o,l])=>!ol(l)).map(([o])=>o):a=Object.keys(this.builder.channels);function r(o){if(ut(o))return o.graph===ea.PARENT?null:o._updateAsTuples();if(Array.isArray(o)&&o.length>0&&o.some(l=>ut(l))){let l=[];for(let u of o)if(ut(u)){if(u.graph===ea.PARENT)continue;l.push(...u._updateAsTuples())}else l.push([Za,u]);return l}else if(o!=null)return[[Za,o]];return null}let i=e;function n(o){if(o){if(ut(o))return o.graph===ea.PARENT?null:o._updateAsTuples().filter(([l])=>a.includes(l));if(Array.isArray(o)&&o.length>0&&o.some(ut)){let l=[];for(let u of o)if(ut(u)){if(u.graph===ea.PARENT)continue;l.push(...u._updateAsTuples().filter(([c])=>a.includes(c)))}else{let c=n(u);c&&l.push(...c??[])}return l}else{if(typeof o=="object"&&!Array.isArray(o))return Object.entries(o).filter(([l])=>a.includes(l));{let l=Array.isArray(o)?"array":typeof o;throw new xe(`Expected node "${i.toString()}" to return an object or an array containing at least one Command object, received ${l}`,{lc_error_code:"INVALID_GRAPH_NODE_RETURN_VALUE"})}}}else return null}let s=[{value:Fa,mapper:new ya({func:a.length&&a[0]===Za?r:n,trace:!1,recurse:!1})}];if(e===_e)this.nodes[e]=new Mi({tags:[Se],triggers:[_e],channels:[_e],writers:[new Ge(s,[Se])]});else{let o=t?.input??this.builder._schemaDefinition,l=Object.fromEntries(Object.keys(this.builder._schemaDefinitions.get(o)).map(d=>[d,d])),u=Object.keys(l).length===1&&Za in l,c=`branch:to:${e}`;this.channels[c]=new Br(!1),this.nodes[e]=new Mi({triggers:[c],channels:u?Object.keys(l):l,writers:[new Ge(s,[Se])],mapper:u?void 0:d=>Object.fromEntries(Object.entries(d).filter(([h])=>h in l)),bound:t?.runnable,metadata:t?.metadata,retryPolicy:t?.retryPolicy,subgraphs:t?.subgraphs,ends:t?.ends})}}attachEdge(e,t){if(t!==se){if(typeof e=="string")this.nodes[e].writers.push(new Ge([{channel:`branch:to:${t}`,value:null}],[Se]));else if(Array.isArray(e)){let a=`join:${e.join("+")}:${t}`;this.channels[a]=new gA(new Set(e)),this.nodes[t].triggers.push(a);for(let r of e)this.nodes[r].writers.push(new Ge([{channel:a,value:r}],[Se]))}}}attachBranch(e,t,a,r={withReader:!0}){let i=async(n,s)=>{let o=n.filter(u=>u!==se);if(!o.length)return;let l=o.map(u=>wt(u)?u:{channel:`branch:to:${u}`,value:e});await Ge.doWrite({...s,tags:(s.tags??[]).concat([Se])},l)};this.nodes[e].writers.push(a.run(i,r.withReader?n=>UP.doRead(n,this.streamChannels??this.outputChannels,!0):void 0))}async _validateInput(e){let t=this.builder._inputRuntimeDefinition;if(ut(e)){let a=e;return e.update&&Ba(t)&&(a.update=t.parse(e.update)),a}return Ba(t)?t.parse(e):e}async _validateConfigurable(e){let t=this.builder._configRuntimeSchema;return Ba(t)&&t.parse(e),e}};function kA(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)&&Object.keys(e).length>0&&Object.values(e).every(t=>typeof t=="function"||el(t))}function R_(e){return typeof e=="object"&&e!==null&&"lc_graph_name"in e&&e.lc_graph_name==="AnnotationRoot"}function EA(e){return typeof e=="object"&&e!==null&&e.channels!==void 0}function xA(e){return typeof e=="object"&&e!==null&&e.stateSchema!==void 0}function PA(e){return typeof e=="object"&&e!==null&&e.stateSchema===void 0&&e.input!==void 0&&e.output!==void 0}function AA(e){return!(typeof e!="object"||e==null||!("state"in e)||!Ba(e.state)||"input"in e&&!Ba(e.input)||"output"in e&&!Ba(e.output))}function SA(e){if(wt(e))return[e];let t=[];ut(e)?t.push(e):Array.isArray(e)&&t.push(...e.filter(ut));let a=[];for(let r of t){if(r.graph===ea.PARENT)throw new Q0(r);wt(r.goto)||typeof r.goto=="string"?a.push(r.goto):Array.isArray(r.goto)&&a.push(...r.goto)}return a}function L_(){let e=new ya({func:SA,tags:[Se],trace:!1,recurse:!1,name:"<control_branch>"});return new j_({path:e})}la();var jA="__remove_all__";function M_(e,t){let a=Array.isArray(e)?e:[e],r=Array.isArray(t)?t:[t],i=a.map(ha),n=r.map(ha);for(let c of i)(c.id===null||c.id===void 0)&&(c.id=Ue(),c.lc_kwargs.id=c.id);let s;for(let c=0;c<n.length;c+=1){let d=n[c];(d.id===null||d.id===void 0)&&(d.id=Ue(),d.lc_kwargs.id=d.id),d.getType()==="remove"&&d.id===jA&&(s=c)}if(s!=null)return n.slice(s+1);let o=[...i],l=new Map(o.map((c,d)=>[c.id,d])),u=new Set;for(let c of n){let d=l.get(c.id);if(d!==void 0)c.getType()==="remove"?u.add(c.id):(u.delete(c.id),o[d]=c);else{if(c.getType()==="remove")throw new Error(`Attempting to delete a message with an ID that doesn't exist ('${c.id}')`);l.set(c.id,o.length),o.push(c)}}return o.filter(c=>!u.has(c.id))}var IA=function(e,t){let{name:a,checkpointer:r,store:i}=typeof e=="string"?{name:e,checkpointer:void 0,store:void 0}:e;if(RP(t)||LP(t))throw new Error("Generators are disallowed as entrypoints. For streaming responses, use config.write.");let n="updates",s=KP(a,t);function o(d){return typeof d=="object"&&d!==null&&"__lg_type"in d&&d.__lg_type==="__pregel_final"}let l=new ya({name:"pluckReturnValue",func:d=>o(d)?d.value:d}),u=new ya({name:"pluckSaveValue",func:d=>o(d)?d.save:d}),c=new Mi({bound:s,triggers:[_e],channels:[_e],writers:[new Ge([{channel:se,value:Fa,mapper:l},{channel:Wn,value:Fa,mapper:u}],[Se])]});return new S_({name:a,checkpointer:r,nodes:{[a]:c},channels:{[_e]:new Br,[se]:new Zn,[Wn]:new Zn},inputChannels:_e,outputChannels:se,streamChannels:se,streamMode:n,store:i})};IA.final=function({value:e,save:t}){return{value:e,save:t,__lg_type:"__pregel_final"}},Ra();var aI=Dd.Root({messages:Dd({reducer:M_,default:()=>[]})}),rI=Ve.object({messages:bA(Ve.custom(),{reducer:{schema:Ve.custom(),fn:M_},default:()=>[]})}),Yd="RFC3986",Qd={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},$A="RFC1738",TA=Array.isArray,ba=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),eh=1024,NA=(e,t,a,r,i)=>{if(e.length===0)return e;let n=e;if(typeof e=="symbol"?n=Symbol.prototype.toString.call(e):typeof e!="string"&&(n=String(e)),a==="iso-8859-1")return escape(n).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let s="";for(let o=0;o<n.length;o+=eh){let l=n.length>=eh?n.slice(o,o+eh):n,u=[];for(let c=0;c<l.length;++c){let d=l.charCodeAt(c);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||i===$A&&(d===40||d===41)){u[u.length]=l.charAt(c);continue}if(d<128){u[u.length]=ba[d];continue}if(d<2048){u[u.length]=ba[192|d>>6]+ba[128|d&63];continue}if(d<55296||d>=57344){u[u.length]=ba[224|d>>12]+ba[128|d>>6&63]+ba[128|d&63];continue}c+=1,d=65536+((d&1023)<<10|l.charCodeAt(c)&1023),u[u.length]=ba[240|d>>18]+ba[128|d>>12&63]+ba[128|d>>6&63]+ba[128|d&63]}s+=u.join("")}return s};function CA(e){return!e||typeof e!="object"?!1:!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))}function U_(e,t){if(TA(e)){let a=[];for(let r=0;r<e.length;r+=1)a.push(t(e[r]));return a}return t(e)}var RA=Object.prototype.hasOwnProperty,D_={brackets(e){return String(e)+"[]"},comma:"comma",indices(e,t){return String(e)+"["+t+"]"},repeat(e){return String(e)}},_a=Array.isArray,LA=Array.prototype.push,F_=function(e,t){LA.apply(e,_a(t)?t:[t])},MA=Date.prototype.toISOString,Ne={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:NA,encodeValuesOnly:!1,format:Yd,formatter:Qd[Yd],indices:!1,serializeDate(e){return MA.call(e)},skipNulls:!1,strictNullHandling:!1};function UA(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||typeof e=="symbol"||typeof e=="bigint"}var th={};function z_(e,t,a,r,i,n,s,o,l,u,c,d,h,p,f,m,g,b){let y=e,_=b,w=0,O=!1;for(;(_=_.get(th))!==void 0&&!O;){let x=_.get(e);if(w+=1,typeof x<"u"){if(x===w)throw new RangeError("Cyclic object value");O=!0}typeof _.get(th)>"u"&&(w=0)}if(typeof u=="function"?y=u(t,y):y instanceof Date?y=h?.(y):a==="comma"&&_a(y)&&(y=U_(y,function(x){return x instanceof Date?h?.(x):x})),y===null){if(n)return l&&!m?l(t,Ne.encoder,g,"key",p):t;y=""}if(UA(y)||CA(y)){if(l){let x=m?t:l(t,Ne.encoder,g,"key",p);return[f?.(x)+"="+f?.(l(y,Ne.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(y))]}let j=[];if(typeof y>"u")return j;let S;if(a==="comma"&&_a(y))m&&l&&(y=U_(y,l)),S=[{value:y.length>0?y.join(",")||null:void 0}];else if(_a(u))S=u;else{let x=Object.keys(y);S=c?x.sort(c):x}let E=o?String(t).replace(/\./g,"%2E"):String(t),A=r&&_a(y)&&y.length===1?E+"[]":E;if(i&&_a(y)&&y.length===0)return A+"[]";for(let x=0;x<S.length;++x){let te=S[x],Le=typeof te=="object"&&typeof te.value<"u"?te.value:y[te];if(s&&Le===null)continue;let Xe=d&&o?te.replace(/\./g,"%2E"):te,Wa=_a(y)?typeof a=="function"?a(A,Xe):A:A+(d?"."+Xe:"["+Xe+"]");b.set(e,w);let Oa=new WeakMap;Oa.set(th,b),F_(j,z_(Le,Wa,a,r,i,n,s,o,a==="comma"&&m&&_a(y)?null:l,u,c,d,h,p,f,m,g,Oa))}return j}function DA(e=Ne){if(typeof e.allowEmptyArrays<"u"&&typeof e.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof e.encodeDotInKeys<"u"&&typeof e.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(e.encoder!==null&&typeof e.encoder<"u"&&typeof e.encoder!="function")throw new TypeError("Encoder has to be a function.");let t=e.charset||Ne.charset;if(typeof e.charset<"u"&&e.charset!=="utf-8"&&e.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let a=Yd;if(typeof e.format<"u"){if(!RA.call(Qd,e.format))throw new TypeError("Unknown format option provided.");a=e.format}let r=Qd[a],i=Ne.filter;(typeof e.filter=="function"||_a(e.filter))&&(i=e.filter);let n;if(e.arrayFormat&&e.arrayFormat in D_?n=e.arrayFormat:"indices"in e?n=e.indices?"indices":"repeat":n=Ne.arrayFormat,"commaRoundTrip"in e&&typeof e.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let s=typeof e.allowDots>"u"?e.encodeDotInKeys?!0:Ne.allowDots:!!e.allowDots;return{addQueryPrefix:typeof e.addQueryPrefix=="boolean"?e.addQueryPrefix:Ne.addQueryPrefix,allowDots:s,allowEmptyArrays:typeof e.allowEmptyArrays=="boolean"?!!e.allowEmptyArrays:Ne.allowEmptyArrays,arrayFormat:n,charset:t,charsetSentinel:typeof e.charsetSentinel=="boolean"?e.charsetSentinel:Ne.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:typeof e.delimiter>"u"?Ne.delimiter:e.delimiter,encode:typeof e.encode=="boolean"?e.encode:Ne.encode,encodeDotInKeys:typeof e.encodeDotInKeys=="boolean"?e.encodeDotInKeys:Ne.encodeDotInKeys,encoder:typeof e.encoder=="function"?e.encoder:Ne.encoder,encodeValuesOnly:typeof e.encodeValuesOnly=="boolean"?e.encodeValuesOnly:Ne.encodeValuesOnly,filter:i,format:a,formatter:r,serializeDate:typeof e.serializeDate=="function"?e.serializeDate:Ne.serializeDate,skipNulls:typeof e.skipNulls=="boolean"?e.skipNulls:Ne.skipNulls,sort:typeof e.sort=="function"?e.sort:null,strictNullHandling:typeof e.strictNullHandling=="boolean"?e.strictNullHandling:Ne.strictNullHandling}}function FA(e,t={}){let a=e,r=DA(t),i,n;typeof r.filter=="function"?(n=r.filter,a=n("",a)):_a(r.filter)&&(n=r.filter,i=n);let s=[];if(typeof a!="object"||a===null)return"";let o=D_[r.arrayFormat],l=o==="comma"&&r.commaRoundTrip;i||(i=Object.keys(a)),r.sort&&i.sort(r.sort);let u=new WeakMap;for(let h=0;h<i.length;++h){let p=i[h];r.skipNulls&&a[p]===null||F_(s,z_(a[p],p,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,u))}let c=s.join(r.delimiter),d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),c.length>0?d+c:""}var Fi="4.104.0",B_=!1,es,Z_,zA,BA,ZA,q_,qA,ah,V_,W_,H_,G_,J_;function VA(e,t={auto:!1}){if(B_)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(es)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${es}'\``);B_=t.auto,es=e.kind,Z_=e.fetch,zA=e.Request,BA=e.Response,ZA=e.Headers,q_=e.FormData,qA=e.Blob,ah=e.File,V_=e.ReadableStream,W_=e.getMultipartRequestOptions,H_=e.getDefaultAgent,G_=e.fileFromPath,J_=e.isFsReadStream}var WA=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function HA({manuallyImported:e}={}){let t=e?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",a,r,i,n;try{a=fetch,r=Request,i=Response,n=Headers}catch(s){throw new Error(`this environment is missing the following Web Fetch API type: ${s.message}. ${t}`)}return{kind:"web",fetch:a,Request:r,Response:i,Headers:n,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(s,o)=>({...o,body:new WA(s)}),getDefaultAgent:s=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:s=>!1}}var K_=()=>{es||VA(HA(),{auto:!0})};K_();var G=class extends Error{},ct=class yp extends G{constructor(t,a,r,i){super(`${yp.makeMessage(t,a,r)}`),this.status=t,this.headers=i,this.request_id=i?.["x-request-id"],this.error=a;let n=a;this.code=n?.code,this.param=n?.param,this.type=n?.type}static makeMessage(t,a,r){let i=a?.message?typeof a.message=="string"?a.message:JSON.stringify(a.message):a?JSON.stringify(a):r;return t&&i?`${t} ${i}`:t?`${t} status code (no body)`:i||"(no status code or body)"}static generate(t,a,r,i){if(!t||!i)return new pl({message:r,cause:sh(a)});let n=a?.error;return t===400?new X_(t,n,r,i):t===401?new Y_(t,n,r,i):t===403?new Q_(t,n,r,i):t===404?new ev(t,n,r,i):t===409?new tv(t,n,r,i):t===422?new av(t,n,r,i):t===429?new rv(t,n,r,i):t>=500?new iv(t,n,r,i):new yp(t,n,r,i)}},kt=class extends ct{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},pl=class extends ct{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},fl=class extends pl{constructor({message:e}={}){super({message:e??"Request timed out."})}},X_=class extends ct{},Y_=class extends ct{},Q_=class extends ct{},ev=class extends ct{},tv=class extends ct{},av=class extends ct{},rv=class extends ct{},iv=class extends ct{},nv=class extends G{constructor(){super("Could not parse response content as the length limit was reached")}},sv=class extends G{constructor(){super("Could not parse response content as the request was rejected by the content filter")}},ml=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},Zr=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Et,gl=class{constructor(){Et.set(this,void 0),this.buffer=new Uint8Array,ml(this,Et,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,a=new Uint8Array(this.buffer.length+t.length);a.set(this.buffer),a.set(t,this.buffer.length),this.buffer=a;let r=[],i;for(;(i=GA(this.buffer,Zr(this,Et,"f")))!=null;){if(i.carriage&&Zr(this,Et,"f")==null){ml(this,Et,i.index,"f");continue}if(Zr(this,Et,"f")!=null&&(i.index!==Zr(this,Et,"f")+1||i.carriage)){r.push(this.decodeText(this.buffer.slice(0,Zr(this,Et,"f")-1))),this.buffer=this.buffer.slice(Zr(this,Et,"f")),ml(this,Et,null,"f");continue}let n=Zr(this,Et,"f")!==null?i.preceding-1:i.preceding,s=this.decodeText(this.buffer.slice(0,n));r.push(s),this.buffer=this.buffer.slice(i.index),ml(this,Et,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new G(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new G(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new G("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};Et=new WeakMap,gl.NEWLINE_CHARS=new Set([`
`,"\r"]),gl.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function GA(e,t){for(let a=t??0;a<e.length;a++){if(e[a]===10)return{preceding:a,index:a+1,carriage:!1};if(e[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function JA(e){for(let t=0;t<e.length-1;t++){if(e[t]===10&&e[t+1]===10||e[t]===13&&e[t+1]===13)return t+2;if(e[t]===13&&e[t+1]===10&&t+3<e.length&&e[t+2]===13&&e[t+3]===10)return t+4}return-1}function ov(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let a=await t.read();return a?.done&&t.releaseLock(),a}catch(a){throw t.releaseLock(),a}},async return(){let a=t.cancel();return t.releaseLock(),await a,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var ts=class xs{constructor(t,a){this.iterator=t,this.controller=a}static fromSSEResponse(t,a){let r=!1;async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(let s of KA(t,a))if(!n){if(s.data.startsWith("[DONE]")){n=!0;continue}if(s.event===null||s.event.startsWith("response.")||s.event.startsWith("transcript.")){let o;try{o=JSON.parse(s.data)}catch(l){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),l}if(o&&o.error)throw new ct(void 0,o.error,void 0,gv(t.headers));yield o}else{let o;try{o=JSON.parse(s.data)}catch(l){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),l}if(s.event=="error")throw new ct(void 0,o.error,o.message,void 0);yield{event:s.event,data:o}}}n=!0}catch(s){if(s instanceof Error&&s.name==="AbortError")return;throw s}finally{n||a.abort()}}return new xs(i,a)}static fromReadableStream(t,a){let r=!1;async function*i(){let s=new gl,o=ov(t);for await(let l of o)for(let u of s.decode(l))yield u;for(let l of s.flush())yield l}async function*n(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let o of i())s||o&&(yield JSON.parse(o));s=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{s||a.abort()}}return new xs(n,a)}[Symbol.asyncIterator](){return this.iterator()}tee(){let t=[],a=[],r=this.iterator(),i=n=>({next:()=>{if(n.length===0){let s=r.next();t.push(s),a.push(s)}return n.shift()}});return[new xs(()=>i(t),this.controller),new xs(()=>i(a),this.controller)]}toReadableStream(){let t=this,a,r=new TextEncoder;return new V_({async start(){a=t[Symbol.asyncIterator]()},async pull(i){try{let{value:n,done:s}=await a.next();if(s)return i.close();let o=r.encode(JSON.stringify(n)+`
`);i.enqueue(o)}catch(n){i.error(n)}},async cancel(){await a.return?.()}})}};async function*KA(e,t){if(!e.body)throw t.abort(),new G("Attempted to iterate over a response with no body");let a=new YA,r=new gl,i=ov(e.body);for await(let n of XA(i))for(let s of r.decode(n)){let o=a.decode(s);o&&(yield o)}for(let n of r.flush()){let s=a.decode(n);s&&(yield s)}}async function*XA(e){let t=new Uint8Array;for await(let a of e){if(a==null)continue;let r=a instanceof ArrayBuffer?new Uint8Array(a):typeof a=="string"?new TextEncoder().encode(a):a,i=new Uint8Array(t.length+r.length);i.set(t),i.set(r,t.length),t=i;let n;for(;(n=JA(t))!==-1;)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}var YA=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,a,r]=QA(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function QA(e,t){let a=e.indexOf(t);return a!==-1?[e.substring(0,a),t,e.substring(a+t.length)]:[e,"",""]}var lv=e=>e!=null&&typeof e=="object"&&typeof e.url=="string"&&typeof e.blob=="function",uv=e=>e!=null&&typeof e=="object"&&typeof e.name=="string"&&typeof e.lastModified=="number"&&yl(e),yl=e=>e!=null&&typeof e=="object"&&typeof e.size=="number"&&typeof e.type=="string"&&typeof e.text=="function"&&typeof e.slice=="function"&&typeof e.arrayBuffer=="function",eS=e=>uv(e)||lv(e)||J_(e);async function cv(e,t,a){if(e=await e,uv(e))return e;if(lv(e)){let i=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");let n=yl(i)?[await i.arrayBuffer()]:[i];return new ah(n,t,a)}let r=await tS(e);if(t||(t=rS(e)??"unknown_file"),!a?.type){let i=r[0]?.type;typeof i=="string"&&(a={...a,type:i})}return new ah(r,t,a)}async function tS(e){let t=[];if(typeof e=="string"||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(yl(e))t.push(await e.arrayBuffer());else if(iS(e))for await(let a of e)t.push(a);else throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${aS(e)}`);return t}function aS(e){return`[${Object.getOwnPropertyNames(e).map(t=>`"${t}"`).join(", ")}]`}function rS(e){return rh(e.name)||rh(e.filename)||rh(e.path)?.split(/[\\/]/).pop()}var rh=e=>{if(typeof e=="string")return e;if(typeof Buffer<"u"&&e instanceof Buffer)return String(e)},iS=e=>e!=null&&typeof e=="object"&&typeof e[Symbol.asyncIterator]=="function",dv=e=>e&&typeof e=="object"&&e.body&&e[Symbol.toStringTag]==="MultipartBody",qr=async e=>{let t=await nS(e.body);return W_(t,e)},nS=async e=>{let t=new q_;return await Promise.all(Object.entries(e||{}).map(([a,r])=>ih(t,a,r))),t},ih=async(e,t,a)=>{if(a!==void 0){if(a==null)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")e.append(t,String(a));else if(eS(a)){let r=await cv(a);e.append(t,r)}else if(Array.isArray(a))await Promise.all(a.map(r=>ih(e,t+"[]",r)));else if(typeof a=="object")await Promise.all(Object.entries(a).map(([r,i])=>ih(e,`${t}[${r}]`,i)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${a} instead`)}},sS=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},oS=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},bl;K_();async function hv(e){let{response:t}=e;if(e.options.stream)return lr("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):ts.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let a=t.headers.get("content-type")?.split(";")[0]?.trim();if(a?.includes("application/json")||a?.endsWith("+json")){let i=await t.json();return lr("response",t.status,t.url,t.headers,i),pv(i,t)}let r=await t.text();return lr("response",t.status,t.url,t.headers,r),r}function pv(e,t){return!e||typeof e!="object"||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}var fv=class mO extends Promise{constructor(t,a=hv){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=a}_thenUnwrap(t){return new mO(this.responsePromise,async a=>pv(t(await this.parseResponse(a),a),a.response))}asResponse(){return this.responsePromise.then(t=>t.response)}async withResponse(){let[t,a]=await Promise.all([this.parse(),this.asResponse()]);return{data:t,response:a,request_id:a.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(t,a){return this.parse().then(t,a)}catch(t){return this.parse().catch(t)}finally(t){return this.parse().finally(t)}},lS=class{constructor({baseURL:e,maxRetries:t=2,timeout:a=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=nh("maxRetries",t),this.timeout=nh("timeout",a),this.httpAgent=r,this.fetch=i??Z_}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...pS(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${yS()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,a){return this.request(Promise.resolve(a).then(async r=>{let i=r&&yl(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:i}}))}getAPIList(e,t,a){return this.requestAPIList(t,{method:"get",path:e,...a})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let a={...e},{method:r,path:i,query:n,headers:s={}}=a,o=ArrayBuffer.isView(a.body)||a.__binaryRequest&&typeof a.body=="string"?a.body:dv(a.body)?a.body.body:a.body?JSON.stringify(a.body,null,2):null,l=this.calculateContentLength(o),u=this.buildURL(i,n);"timeout"in a&&nh("timeout",a.timeout),a.timeout=a.timeout??this.timeout;let c=a.httpAgent??this.httpAgent??H_(u),d=a.timeout+1e3;typeof c?.options?.timeout=="number"&&d>(c.options.timeout??0)&&(c.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let h=this.buildHeaders({options:a,headers:s,contentLength:l,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...c&&{agent:c},signal:a.signal??null},url:u,timeout:a.timeout}}buildHeaders({options:e,headers:t,contentLength:a,retryCount:r}){let i={};a&&(i["content-length"]=a);let n=this.defaultHeaders(e);return Ov(i,n),Ov(i,t),dv(e.body)&&es!=="node"&&delete i["content-type"],vl(n,"x-stainless-retry-count")===void 0&&vl(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(r)),vl(n,"x-stainless-timeout")===void 0&&vl(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:a}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,a,r){return ct.generate(e,t,a,r)}request(e,t=null){return new fv(this.makeRequest(e,t))}async makeRequest(e,t){let a=await e,r=a.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(a);let{req:i,url:n,timeout:s}=this.buildRequest(a,{retryCount:r-t});if(await this.prepareRequest(i,{url:n,options:a}),lr("request",n,a,i.headers),a.signal?.aborted)throw new kt;let o=new AbortController,l=await this.fetchWithTimeout(n,i,s,o).catch(sh);if(l instanceof Error){if(a.signal?.aborted)throw new kt;if(t)return this.retryRequest(a,t);throw l.name==="AbortError"?new fl:new pl({cause:l})}let u=gv(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){let p=`retrying, ${t} attempts remaining`;return lr(`response (error; ${p})`,l.status,n,u),this.retryRequest(a,t,u)}let c=await l.text().catch(p=>sh(p).message),d=fS(c),h=d?void 0:c;throw lr(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,n,u,h),this.makeStatusError(l.status,d,h,u)}return{response:l,options:a,controller:o}}requestAPIList(e,t){let a=this.makeRequest(t,null);return new uS(this,a,e)}buildURL(e,t){let a=gS(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return vv(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,a])=>typeof a<"u").map(([t,a])=>{if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(a)}`;if(a===null)return`${encodeURIComponent(t)}=`;throw new G(`Cannot stringify type ${typeof a}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,a,r){let{signal:i,...n}=t||{};i&&i.addEventListener("abort",()=>r.abort());let s=setTimeout(()=>r.abort(),a),o={signal:r.signal,...n};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(s)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,a){let r,i=a?.["retry-after-ms"];if(i){let s=parseFloat(i);Number.isNaN(s)||(r=s)}let n=a?.["retry-after"];if(n&&!r){let s=parseFloat(n);Number.isNaN(s)?r=Date.parse(n)-Date.now():r=s*1e3}if(!(r&&0<=r&&r<60*1e3)){let s=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,s)}return await as(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let a=t-e,r=Math.min(.5*Math.pow(2,a),8),i=1-Math.random()*.25;return r*i*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Fi}`}},mv=class{constructor(e,t,a,r){bl.set(this,void 0),sS(this,bl,e,"f"),this.options=r,this.response=t,this.body=a}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new G("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let a=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[r,i]of a)e.url.searchParams.set(r,i);t.query=void 0,t.path=e.url.toString()}return await oS(this,bl,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(bl=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},uS=class extends fv{constructor(e,t,a){super(t,async r=>new a(e,r.response,await hv(r),r.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},gv=e=>new Proxy(Object.fromEntries(e.entries()),{get(t,a){let r=a.toString();return t[r.toLowerCase()]||t[r]}}),cS={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ke=e=>typeof e=="object"&&e!==null&&!vv(e)&&Object.keys(e).every(t=>wv(cS,t)),dS=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fi,"X-Stainless-OS":bv(Deno.build.os),"X-Stainless-Arch":yv(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fi,"X-Stainless-OS":bv(process.platform),"X-Stainless-Arch":yv(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let e=hS();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Fi,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function hS(){if(typeof navigator>"u"||!navigator)return null;let e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:t,pattern:a}of e){let r=a.exec(navigator.userAgent);if(r){let i=r[1]||0,n=r[2]||0,s=r[3]||0;return{browser:t,version:`${i}.${n}.${s}`}}}return null}var yv=e=>e==="x32"?"x32":e==="x86_64"||e==="x64"?"x64":e==="arm"?"arm":e==="aarch64"||e==="arm64"?"arm64":e?`other:${e}`:"unknown",bv=e=>(e=e.toLowerCase(),e.includes("ios")?"iOS":e==="android"?"Android":e==="darwin"?"MacOS":e==="win32"?"Windows":e==="freebsd"?"FreeBSD":e==="openbsd"?"OpenBSD":e==="linux"?"Linux":e?`Other:${e}`:"Unknown"),_v,pS=()=>_v??(_v=dS()),fS=e=>{try{return JSON.parse(e)}catch{return}},mS=/^[a-z][a-z0-9+.-]*:/i,gS=e=>mS.test(e),as=e=>new Promise(t=>setTimeout(t,e)),nh=(e,t)=>{if(typeof t!="number"||!Number.isInteger(t))throw new G(`${e} must be an integer`);if(t<0)throw new G(`${e} must be a positive integer`);return t},sh=e=>{if(e instanceof Error)return e;if(typeof e=="object"&&e!==null)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},_l=e=>{if(typeof process<"u")return process.env?.[e]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(e)?.trim()};function vv(e){if(!e)return!0;for(let t in e)return!1;return!0}function wv(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Ov(e,t){for(let a in t){if(!wv(t,a))continue;let r=a.toLowerCase();if(!r)continue;let i=t[a];i===null?delete e[r]:i!==void 0&&(e[r]=i)}}var kv=new Set(["authorization","api-key"]);function lr(e,...t){if(typeof process<"u"&&process?.env?.DEBUG==="true"){let a=t.map(r=>{if(!r)return r;if(r.headers){let n={...r,headers:{...r.headers}};for(let s in r.headers)kv.has(s.toLowerCase())&&(n.headers[s]="REDACTED");return n}let i=null;for(let n in r)kv.has(n.toLowerCase())&&(i??(i={...r}),i[n]="REDACTED");return i??r});console.log(`OpenAI:DEBUG:${e}`,...a)}}var yS=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),bS=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",_S=e=>typeof e?.get=="function",vl=(e,t)=>{let a=t.toLowerCase();if(_S(e)){let r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(i,n,s)=>n+s.toUpperCase());for(let i of[t,a,t.toUpperCase(),r]){let n=e.get(i);if(n)return n}}for(let[r,i]of Object.entries(e))if(r.toLowerCase()===a)return Array.isArray(i)?(i.length<=1||console.warn(`Received ${i.length} entries for the ${t} header, using the first entry.`),i[0]):i},vS=e=>{if(typeof Buffer<"u"){let t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}else{let t=atob(e),a=t.length,r=new Uint8Array(a);for(let i=0;i<a;i++)r[i]=t.charCodeAt(i);return Array.from(new Float32Array(r.buffer))}};function oh(e){return e!=null&&typeof e=="object"&&!Array.isArray(e)}var wl=class extends mv{constructor(e,t,a,r){super(e,t,a,r),this.data=a.data||[],this.object=a.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},Ce=class extends mv{constructor(e,t,a,r){super(e,t,a,r),this.data=a.data||[],this.has_more=a.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}},K=class{constructor(e){this._client=e}},Ev=class extends K{list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,wS,{query:t,...a})}},Ol=class extends K{constructor(){super(...arguments),this.messages=new Ev(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,a){return this._client.post(`/chat/completions/${e}`,{body:t,...a})}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/chat/completions",kl,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}},kl=class extends Ce{},wS=class extends Ce{};Ol.ChatCompletionsPage=kl,Ol.Messages=Ev;var El=class extends K{constructor(){super(...arguments),this.completions=new Ol(this._client)}};El.Completions=Ol,El.ChatCompletionsPage=kl;var xv=class extends K{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}},Pv=class extends K{create(e,t){return this._client.post("/audio/transcriptions",qr({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}},Av=class extends K{create(e,t){return this._client.post("/audio/translations",qr({body:e,...t,__metadata:{model:e.model}}))}},rs=class extends K{constructor(){super(...arguments),this.transcriptions=new Pv(this._client),this.translations=new Av(this._client),this.speech=new xv(this._client)}};rs.Transcriptions=Pv,rs.Translations=Av,rs.Speech=xv;var lh=class extends K{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/batches",uh,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},uh=class extends Ce{};lh.BatchesPage=uh;var ta=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},Ee=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},ch,xl,Pl,is,ns,Al,ss,qa,os,Sl,jl,zi,Sv,dh=class{constructor(){ch.add(this),this.controller=new AbortController,xl.set(this,void 0),Pl.set(this,()=>{}),is.set(this,()=>{}),ns.set(this,void 0),Al.set(this,()=>{}),ss.set(this,()=>{}),qa.set(this,{}),os.set(this,!1),Sl.set(this,!1),jl.set(this,!1),zi.set(this,!1),ta(this,xl,new Promise((e,t)=>{ta(this,Pl,e,"f"),ta(this,is,t,"f")}),"f"),ta(this,ns,new Promise((e,t)=>{ta(this,Al,e,"f"),ta(this,ss,t,"f")}),"f"),Ee(this,xl,"f").catch(()=>{}),Ee(this,ns,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},Ee(this,ch,"m",Sv).bind(this))},0)}_connected(){this.ended||(Ee(this,Pl,"f").call(this),this._emit("connect"))}get ended(){return Ee(this,os,"f")}get errored(){return Ee(this,Sl,"f")}get aborted(){return Ee(this,jl,"f")}abort(){this.controller.abort()}on(e,t){return(Ee(this,qa,"f")[e]||(Ee(this,qa,"f")[e]=[])).push({listener:t}),this}off(e,t){let a=Ee(this,qa,"f")[e];if(!a)return this;let r=a.findIndex(i=>i.listener===t);return r>=0&&a.splice(r,1),this}once(e,t){return(Ee(this,qa,"f")[e]||(Ee(this,qa,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,a)=>{ta(this,zi,!0,"f"),e!=="error"&&this.once("error",a),this.once(e,t)})}async done(){ta(this,zi,!0,"f"),await Ee(this,ns,"f")}_emit(e,...t){if(Ee(this,os,"f"))return;e==="end"&&(ta(this,os,!0,"f"),Ee(this,Al,"f").call(this));let a=Ee(this,qa,"f")[e];if(a&&(Ee(this,qa,"f")[e]=a.filter(r=>!r.once),a.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!Ee(this,zi,"f")&&!a?.length&&Promise.reject(r),Ee(this,is,"f").call(this,r),Ee(this,ss,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!Ee(this,zi,"f")&&!a?.length&&Promise.reject(r),Ee(this,is,"f").call(this,r),Ee(this,ss,"f").call(this,r),this._emit("end")}}_emitFinal(){}};xl=new WeakMap,Pl=new WeakMap,is=new WeakMap,ns=new WeakMap,Al=new WeakMap,ss=new WeakMap,qa=new WeakMap,os=new WeakMap,Sl=new WeakMap,jl=new WeakMap,zi=new WeakMap,ch=new WeakSet,Sv=function(e){if(ta(this,Sl,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new kt),e instanceof kt)return ta(this,jl,!0,"f"),this._emit("abort",e);if(e instanceof G)return this._emit("error",e);if(e instanceof Error){let t=new G(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new G(String(e)))};var q=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},xt=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},Ze,hh,va,Il,aa,Vr,Bi,Wr,$l,Pt,Tl,Nl,ls,us,cs,jv,Iv,$v,Tv,Nv,Cv,Rv,Zi=class Ps extends dh{constructor(){super(...arguments),Ze.add(this),hh.set(this,[]),va.set(this,{}),Il.set(this,{}),aa.set(this,void 0),Vr.set(this,void 0),Bi.set(this,void 0),Wr.set(this,void 0),$l.set(this,void 0),Pt.set(this,void 0),Tl.set(this,void 0),Nl.set(this,void 0),ls.set(this,void 0)}[(hh=new WeakMap,va=new WeakMap,Il=new WeakMap,aa=new WeakMap,Vr=new WeakMap,Bi=new WeakMap,Wr=new WeakMap,$l=new WeakMap,Pt=new WeakMap,Tl=new WeakMap,Nl=new WeakMap,ls=new WeakMap,Ze=new WeakSet,Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("event",i=>{let n=a.shift();n?n.resolve(i):t.push(i)}),this.on("end",()=>{r=!0;for(let i of a)i.resolve(void 0);a.length=0}),this.on("abort",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),this.on("error",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,n)=>a.push({resolve:i,reject:n})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(t){let a=new Ps;return a._run(()=>a._fromReadableStream(t)),a}async _fromReadableStream(t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let i=ts.fromReadableStream(t,this.controller);for await(let n of i)q(this,Ze,"m",us).call(this,n);if(i.controller.signal?.aborted)throw new kt;return this._addRun(q(this,Ze,"m",cs).call(this))}toReadableStream(){return new ts(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(t,a,r,i,n){let s=new Ps;return s._run(()=>s._runToolAssistantStream(t,a,r,i,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(t,a,r,i,n){let s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let o={...i,stream:!0},l=await t.submitToolOutputs(a,r,o,{...n,signal:this.controller.signal});this._connected();for await(let u of l)q(this,Ze,"m",us).call(this,u);if(l.controller.signal?.aborted)throw new kt;return this._addRun(q(this,Ze,"m",cs).call(this))}static createThreadAssistantStream(t,a,r){let i=new Ps;return i._run(()=>i._threadAssistantStream(t,a,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}static createAssistantStream(t,a,r,i){let n=new Ps;return n._run(()=>n._runAssistantStream(t,a,r,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),n}currentEvent(){return q(this,Tl,"f")}currentRun(){return q(this,Nl,"f")}currentMessageSnapshot(){return q(this,aa,"f")}currentRunStepSnapshot(){return q(this,ls,"f")}async finalRunSteps(){return await this.done(),Object.values(q(this,va,"f"))}async finalMessages(){return await this.done(),Object.values(q(this,Il,"f"))}async finalRun(){if(await this.done(),!q(this,Vr,"f"))throw Error("Final run was not received.");return q(this,Vr,"f")}async _createThreadAssistantStream(t,a,r){let i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let n={...a,stream:!0},s=await t.createAndRun(n,{...r,signal:this.controller.signal});this._connected();for await(let o of s)q(this,Ze,"m",us).call(this,o);if(s.controller.signal?.aborted)throw new kt;return this._addRun(q(this,Ze,"m",cs).call(this))}async _createAssistantStream(t,a,r,i){let n=i?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let s={...r,stream:!0},o=await t.create(a,s,{...i,signal:this.controller.signal});this._connected();for await(let l of o)q(this,Ze,"m",us).call(this,l);if(o.controller.signal?.aborted)throw new kt;return this._addRun(q(this,Ze,"m",cs).call(this))}static accumulateDelta(t,a){for(let[r,i]of Object.entries(a)){if(!t.hasOwnProperty(r)){t[r]=i;continue}let n=t[r];if(n==null){t[r]=i;continue}if(r==="index"||r==="type"){t[r]=i;continue}if(typeof n=="string"&&typeof i=="string")n+=i;else if(typeof n=="number"&&typeof i=="number")n+=i;else if(oh(n)&&oh(i))n=this.accumulateDelta(n,i);else if(Array.isArray(n)&&Array.isArray(i)){if(n.every(s=>typeof s=="string"||typeof s=="number")){n.push(...i);continue}for(let s of i){if(!oh(s))throw new Error(`Expected array delta entry to be an object but got: ${s}`);let o=s.index;if(o==null)throw console.error(s),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let l=n[o];l==null?n.push(s):n[o]=this.accumulateDelta(l,s)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${i}, accValue: ${n}`);t[r]=n}return t}_addRun(t){return t}async _threadAssistantStream(t,a,r){return await this._createThreadAssistantStream(a,t,r)}async _runAssistantStream(t,a,r,i){return await this._createAssistantStream(a,t,r,i)}async _runToolAssistantStream(t,a,r,i,n){return await this._createToolAssistantStream(r,t,a,i,n)}};us=function(e){if(!this.ended)switch(xt(this,Tl,e,"f"),q(this,Ze,"m",$v).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":q(this,Ze,"m",Rv).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":q(this,Ze,"m",Iv).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":q(this,Ze,"m",jv).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},cs=function(){if(this.ended)throw new G("stream has ended, this shouldn't happen");if(!q(this,Vr,"f"))throw Error("Final run has not been received");return q(this,Vr,"f")},jv=function(e){let[t,a]=q(this,Ze,"m",Nv).call(this,e,q(this,aa,"f"));xt(this,aa,t,"f"),q(this,Il,"f")[t.id]=t;for(let r of a){let i=t.content[r.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if(r.type=="text"&&r.text){let i=r.text,n=t.content[r.index];if(n&&n.type=="text")this._emit("textDelta",i,n.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=q(this,Bi,"f")){if(q(this,Wr,"f"))switch(q(this,Wr,"f").type){case"text":this._emit("textDone",q(this,Wr,"f").text,q(this,aa,"f"));break;case"image_file":this._emit("imageFileDone",q(this,Wr,"f").image_file,q(this,aa,"f"));break}xt(this,Bi,r.index,"f")}xt(this,Wr,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(q(this,Bi,"f")!==void 0){let r=e.data.content[q(this,Bi,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,q(this,aa,"f"));break;case"text":this._emit("textDone",r.text,q(this,aa,"f"));break}}q(this,aa,"f")&&this._emit("messageDone",e.data),xt(this,aa,void 0,"f")}},Iv=function(e){let t=q(this,Ze,"m",Tv).call(this,e);switch(xt(this,ls,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let a=e.data.delta;if(a.step_details&&a.step_details.type=="tool_calls"&&a.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let r of a.step_details.tool_calls)r.index==q(this,$l,"f")?this._emit("toolCallDelta",r,t.step_details.tool_calls[r.index]):(q(this,Pt,"f")&&this._emit("toolCallDone",q(this,Pt,"f")),xt(this,$l,r.index,"f"),xt(this,Pt,t.step_details.tool_calls[r.index],"f"),q(this,Pt,"f")&&this._emit("toolCallCreated",q(this,Pt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":xt(this,ls,void 0,"f"),e.data.step_details.type=="tool_calls"&&q(this,Pt,"f")&&(this._emit("toolCallDone",q(this,Pt,"f")),xt(this,Pt,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},$v=function(e){q(this,hh,"f").push(e),this._emit("event",e)},Tv=function(e){switch(e.event){case"thread.run.step.created":return q(this,va,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=q(this,va,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let a=e.data;if(a.delta){let r=Zi.accumulateDelta(t,a.delta);q(this,va,"f")[e.data.id]=r}return q(this,va,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":q(this,va,"f")[e.data.id]=e.data;break}if(q(this,va,"f")[e.data.id])return q(this,va,"f")[e.data.id];throw new Error("No snapshot available")},Nv=function(e,t){let a=[];switch(e.event){case"thread.message.created":return[e.data,a];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(let i of r.delta.content)if(i.index in t.content){let n=t.content[i.index];t.content[i.index]=q(this,Ze,"m",Cv).call(this,i,n)}else t.content[i.index]=i,a.push(i);return[t,a];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,a];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Cv=function(e,t){return Zi.accumulateDelta(t,e)},Rv=function(e){switch(xt(this,Nl,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":xt(this,Vr,e.data,"f"),q(this,Pt,"f")&&(this._emit("toolCallDone",q(this,Pt,"f")),xt(this,Pt,void 0,"f"));break;case"thread.run.cancelling":break}};var ph=class extends K{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/assistants/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/assistants",fh,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},fh=class extends Ce{};ph.AssistantsPage=fh;function Lv(e){return typeof e.parse=="function"}var qi=e=>e?.role==="assistant",Mv=e=>e?.role==="function",Uv=e=>e?.role==="tool";function OS(e,t){let a={...e};return Object.defineProperties(a,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),a}function mh(e){return e?.$brand==="auto-parseable-response-format"}function kS(e,{parser:t,callback:a}){let r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:a,enumerable:!1}}),r}function ds(e){return e?.$brand==="auto-parseable-tool"}function ES(e,t){return!t||!Dv(t)?{...e,choices:e.choices.map(a=>({...a,message:{...a.message,parsed:null,...a.message.tool_calls?{tool_calls:a.message.tool_calls}:void 0}}))}:gh(e,t)}function gh(e,t){let a=e.choices.map(r=>{if(r.finish_reason==="length")throw new nv;if(r.finish_reason==="content_filter")throw new sv;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:r.message.tool_calls?.map(i=>PS(t,i))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?xS(t,r.message.content):null}}});return{...e,choices:a}}function xS(e,t){return e.response_format?.type!=="json_schema"?null:e.response_format?.type==="json_schema"?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function PS(e,t){let a=e.tools?.find(r=>r.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:ds(a)?a.$parseRaw(t.function.arguments):a?.function.strict?JSON.parse(t.function.arguments):null}}}function AS(e,t){if(!e)return!1;let a=e.tools?.find(r=>r.function?.name===t.function.name);return ds(a)||a?.function.strict||!1}function Dv(e){return mh(e.response_format)?!0:e.tools?.some(t=>ds(t)||t.type==="function"&&t.function.strict===!0)??!1}function SS(e){for(let t of e??[]){if(t.type!=="function")throw new G(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(t.function.strict!==!0)throw new G(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var dt=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Ke,yh,Cl,bh,_h,vh,Fv,wh,zv=10,Bv=class extends dh{constructor(){super(...arguments),Ke.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Mv(e)||Uv(e))&&e.content)this._emit("functionCallResult",e.content);else if(qi(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(qi(e)&&e.tool_calls)for(let a of e.tool_calls)a.type==="function"&&this._emit("functionCall",a.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new G("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),dt(this,Ke,"m",yh).call(this)}async finalMessage(){return await this.done(),dt(this,Ke,"m",Cl).call(this)}async finalFunctionCall(){return await this.done(),dt(this,Ke,"m",bh).call(this)}async finalFunctionCallResult(){return await this.done(),dt(this,Ke,"m",_h).call(this)}async totalUsage(){return await this.done(),dt(this,Ke,"m",vh).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=dt(this,Ke,"m",Cl).call(this);t&&this._emit("finalMessage",t);let a=dt(this,Ke,"m",yh).call(this);a&&this._emit("finalContent",a);let r=dt(this,Ke,"m",bh).call(this);r&&this._emit("finalFunctionCall",r);let i=dt(this,Ke,"m",_h).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(n=>n.usage)&&this._emit("totalUsage",dt(this,Ke,"m",vh).call(this))}async _createChatCompletion(e,t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),dt(this,Ke,"m",Fv).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addChatCompletion(gh(i,t))}async _runChatCompletion(e,t,a){for(let r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,a)}async _runFunctions(e,t,a){let r="function",{function_call:i="auto",stream:n,...s}=t,o=typeof i!="string"&&i?.name,{maxChatCompletions:l=zv}=a||{},u={};for(let d of t.functions)u[d.name||d.function.name]=d;let c=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let h=(await this._createChatCompletion(e,{...s,function_call:i,functions:c,messages:[...this.messages]},a)).choices[0]?.message;if(!h)throw new G("missing message in ChatCompletion response");if(!h.function_call)return;let{name:p,arguments:f}=h.function_call,m=u[p];if(m){if(o&&o!==p){let _=`Invalid function_call: ${JSON.stringify(p)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:p,content:_});continue}}else{let _=`Invalid function_call: ${JSON.stringify(p)}. Available options are: ${c.map(w=>JSON.stringify(w.name)).join(", ")}. Please try again`;this._addMessage({role:r,name:p,content:_});continue}let g;try{g=Lv(m)?await m.parse(f):f}catch(_){this._addMessage({role:r,name:p,content:_ instanceof Error?_.message:String(_)});continue}let b=await m.function(g,this),y=dt(this,Ke,"m",wh).call(this,b);if(this._addMessage({role:r,name:p,content:y}),o)return}}async _runTools(e,t,a){let r="tool",{tool_choice:i="auto",stream:n,...s}=t,o=typeof i!="string"&&i?.function?.name,{maxChatCompletions:l=zv}=a||{},u=t.tools.map(h=>{if(ds(h)){if(!h.$callback)throw new G("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:h.$callback,name:h.function.name,description:h.function.description||"",parameters:h.function.parameters,parse:h.$parseRaw,strict:!0}}}return h}),c={};for(let h of u)h.type==="function"&&(c[h.function.name||h.function.function.name]=h.function);let d="tools"in t?u.map(h=>h.type==="function"?{type:"function",function:{name:h.function.name||h.function.function.name,parameters:h.function.parameters,description:h.function.description,strict:h.function.strict}}:h):void 0;for(let h of t.messages)this._addMessage(h,!1);for(let h=0;h<l;++h){let p=(await this._createChatCompletion(e,{...s,tool_choice:i,tools:d,messages:[...this.messages]},a)).choices[0]?.message;if(!p)throw new G("missing message in ChatCompletion response");if(!p.tool_calls?.length)return;for(let f of p.tool_calls){if(f.type!=="function")continue;let m=f.id,{name:g,arguments:b}=f.function,y=c[g];if(y){if(o&&o!==g){let j=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:m,content:j});continue}}else{let j=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${Object.keys(c).map(S=>JSON.stringify(S)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:m,content:j});continue}let _;try{_=Lv(y)?await y.parse(b):b}catch(j){let S=j instanceof Error?j.message:String(j);this._addMessage({role:r,tool_call_id:m,content:S});continue}let w=await y.function(_,this),O=dt(this,Ke,"m",wh).call(this,w);if(this._addMessage({role:r,tool_call_id:m,content:O}),o)return}}}};Ke=new WeakSet,yh=function(){return dt(this,Ke,"m",Cl).call(this).content??null},Cl=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(qi(t)){let{function_call:a,...r}=t,i={...r,content:t.content??null,refusal:t.refusal??null};return a&&(i.function_call=a),i}}throw new G("stream ended without producing a ChatCompletionMessage with role=assistant")},bh=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(qi(t)&&t?.function_call)return t.function_call;if(qi(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},_h=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Mv(t)&&t.content!=null||Uv(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(a=>a.role==="assistant"&&a.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},vh=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Fv=function(e){if(e.n!=null&&e.n>1)throw new G("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},wh=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Zv=class bp extends Bv{static runFunctions(t,a,r){let i=new bp,n={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(t,a,n)),i}static runTools(t,a,r){let i=new bp,n={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(t,a,n)),i}_addMessage(t,a=!0){super._addMessage(t,a),qi(t)&&t.content&&this._emit("content",t.content)}},Be={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},jS=class extends Error{},IS=class extends Error{};function $S(e,t=Be.ALL){if(typeof e!="string")throw new TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw new Error(`${e} is empty`);return TS(e.trim(),t)}var TS=(e,t)=>{let a=e.length,r=0,i=h=>{throw new jS(`${h} at position ${r}`)},n=h=>{throw new IS(`${h} at position ${r}`)},s=()=>(d(),r>=a&&i("Unexpected end of input"),e[r]==='"'?o():e[r]==="{"?l():e[r]==="["?u():e.substring(r,r+4)==="null"||Be.NULL&t&&a-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):e.substring(r,r+4)==="true"||Be.BOOL&t&&a-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):e.substring(r,r+5)==="false"||Be.BOOL&t&&a-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):e.substring(r,r+8)==="Infinity"||Be.INFINITY&t&&a-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):e.substring(r,r+9)==="-Infinity"||Be.MINUS_INFINITY&t&&1<a-r&&a-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):e.substring(r,r+3)==="NaN"||Be.NAN&t&&a-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):c()),o=()=>{let h=r,p=!1;for(r++;r<a&&(e[r]!=='"'||p&&e[r-1]==="\\");)p=e[r]==="\\"?!p:!1,r++;if(e.charAt(r)=='"')try{return JSON.parse(e.substring(h,++r-Number(p)))}catch(f){n(String(f))}else if(Be.STR&t)try{return JSON.parse(e.substring(h,r-Number(p))+'"')}catch{return JSON.parse(e.substring(h,e.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},l=()=>{r++,d();let h={};try{for(;e[r]!=="}";){if(d(),r>=a&&Be.OBJ&t)return h;let p=o();d(),r++;try{let f=s();Object.defineProperty(h,p,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(Be.OBJ&t)return h;throw f}d(),e[r]===","&&r++}}catch{if(Be.OBJ&t)return h;i("Expected '}' at end of object")}return r++,h},u=()=>{r++;let h=[];try{for(;e[r]!=="]";)h.push(s()),d(),e[r]===","&&r++}catch{if(Be.ARR&t)return h;i("Expected ']' at end of array")}return r++,h},c=()=>{if(r===0){e==="-"&&Be.NUM&t&&i("Not sure what '-' is");try{return JSON.parse(e)}catch(p){if(Be.NUM&t)try{return e[e.length-1]==="."?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch{}n(String(p))}}let h=r;for(e[r]==="-"&&r++;e[r]&&!",]}".includes(e[r]);)r++;r==a&&!(Be.NUM&t)&&i("Unterminated number literal");try{return JSON.parse(e.substring(h,r))}catch{e.substring(h,r)==="-"&&Be.NUM&t&&i("Not sure what '-' is");try{return JSON.parse(e.substring(h,e.lastIndexOf("e")))}catch(p){n(String(p))}}},d=()=>{for(;r<a&&` 
\r	`.includes(e[r]);)r++};return s()},qv=e=>$S(e,Be.ALL^Be.NUM),Vi=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},ve=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Re,Va,Wi,ur,Oh,Rl,kh,Eh,xh,Ll,Ph,Vv,Wv=class _p extends Bv{constructor(t){super(),Re.add(this),Va.set(this,void 0),Wi.set(this,void 0),ur.set(this,void 0),Vi(this,Va,t,"f"),Vi(this,Wi,[],"f")}get currentChatCompletionSnapshot(){return ve(this,ur,"f")}static fromReadableStream(t){let a=new _p(null);return a._run(()=>a._fromReadableStream(t)),a}static createChatCompletion(t,a,r){let i=new _p(a);return i._run(()=>i._runChatCompletion(t,{...a,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createChatCompletion(t,a,r){super._createChatCompletion;let i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),ve(this,Re,"m",Oh).call(this);let n=await t.chat.completions.create({...a,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let s of n)ve(this,Re,"m",kh).call(this,s);if(n.controller.signal?.aborted)throw new kt;return this._addChatCompletion(ve(this,Re,"m",Ll).call(this))}async _fromReadableStream(t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ve(this,Re,"m",Oh).call(this),this._connected();let i=ts.fromReadableStream(t,this.controller),n;for await(let s of i)n&&n!==s.id&&this._addChatCompletion(ve(this,Re,"m",Ll).call(this)),ve(this,Re,"m",kh).call(this,s),n=s.id;if(i.controller.signal?.aborted)throw new kt;return this._addChatCompletion(ve(this,Re,"m",Ll).call(this))}[(Va=new WeakMap,Wi=new WeakMap,ur=new WeakMap,Re=new WeakSet,Oh=function(){this.ended||Vi(this,ur,void 0,"f")},Rl=function(t){let a=ve(this,Wi,"f")[t.index];return a||(a={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},ve(this,Wi,"f")[t.index]=a,a)},kh=function(t){if(this.ended)return;let a=ve(this,Re,"m",Vv).call(this,t);this._emit("chunk",t,a);for(let r of t.choices){let i=a.choices[r.index];r.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",r.delta.content,i.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),r.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:i.message.refusal}),r.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:i.logprobs?.content??[]}),r.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});let n=ve(this,Re,"m",Rl).call(this,i);i.finish_reason&&(ve(this,Re,"m",xh).call(this,i),n.current_tool_call_index!=null&&ve(this,Re,"m",Eh).call(this,i,n.current_tool_call_index));for(let s of r.delta.tool_calls??[])n.current_tool_call_index!==s.index&&(ve(this,Re,"m",xh).call(this,i),n.current_tool_call_index!=null&&ve(this,Re,"m",Eh).call(this,i,n.current_tool_call_index)),n.current_tool_call_index=s.index;for(let s of r.delta.tool_calls??[]){let o=i.message.tool_calls?.[s.index];o?.type&&(o?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:o.function?.name,index:s.index,arguments:o.function.arguments,parsed_arguments:o.function.parsed_arguments,arguments_delta:s.function?.arguments??""}):o?.type)}}},Eh=function(t,a){if(ve(this,Re,"m",Rl).call(this,t).done_tool_calls.has(a))return;let r=t.message.tool_calls?.[a];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if(r.type==="function"){let i=ve(this,Va,"f")?.tools?.find(n=>n.type==="function"&&n.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:a,arguments:r.function.arguments,parsed_arguments:ds(i)?i.$parseRaw(r.function.arguments):i?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},xh=function(t){let a=ve(this,Re,"m",Rl).call(this,t);if(t.message.content&&!a.content_done){a.content_done=!0;let r=ve(this,Re,"m",Ph).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!a.refusal_done&&(a.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!a.logprobs_content_done&&(a.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!a.logprobs_refusal_done&&(a.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},Ll=function(){if(this.ended)throw new G("stream has ended, this shouldn't happen");let t=ve(this,ur,"f");if(!t)throw new G("request ended without sending any chunks");return Vi(this,ur,void 0,"f"),Vi(this,Wi,[],"f"),NS(t,ve(this,Va,"f"))},Ph=function(){let t=ve(this,Va,"f")?.response_format;return mh(t)?t:null},Vv=function(t){var a,r,i,n;let s=ve(this,ur,"f"),{choices:o,...l}=t;s?Object.assign(s,l):s=Vi(this,ur,{...l,choices:[]},"f");for(let{delta:u,finish_reason:c,index:d,logprobs:h=null,...p}of t.choices){let f=s.choices[d];if(f||(f=s.choices[d]={finish_reason:c,index:d,message:{},logprobs:h,...p}),h)if(!f.logprobs)f.logprobs=Object.assign({},h);else{let{content:O,refusal:j,...S}=h;Object.assign(f.logprobs,S),O&&((a=f.logprobs).content??(a.content=[]),f.logprobs.content.push(...O)),j&&((r=f.logprobs).refusal??(r.refusal=[]),f.logprobs.refusal.push(...j))}if(c&&(f.finish_reason=c,ve(this,Va,"f")&&Dv(ve(this,Va,"f")))){if(c==="length")throw new nv;if(c==="content_filter")throw new sv}if(Object.assign(f,p),!u)continue;let{content:m,refusal:g,function_call:b,role:y,tool_calls:_,...w}=u;if(Object.assign(f.message,w),g&&(f.message.refusal=(f.message.refusal||"")+g),y&&(f.message.role=y),b&&(f.message.function_call?(b.name&&(f.message.function_call.name=b.name),b.arguments&&((i=f.message.function_call).arguments??(i.arguments=""),f.message.function_call.arguments+=b.arguments)):f.message.function_call=b),m&&(f.message.content=(f.message.content||"")+m,!f.message.refusal&&ve(this,Re,"m",Ph).call(this)&&(f.message.parsed=qv(f.message.content))),_){f.message.tool_calls||(f.message.tool_calls=[]);for(let{index:O,id:j,type:S,function:E,...A}of _){let x=(n=f.message.tool_calls)[O]??(n[O]={});Object.assign(x,A),j&&(x.id=j),S&&(x.type=S),E&&(x.function??(x.function={name:E.name??"",arguments:""})),E?.name&&(x.function.name=E.name),E?.arguments&&(x.function.arguments+=E.arguments,AS(ve(this,Va,"f"),x)&&(x.function.parsed_arguments=qv(x.function.arguments)))}}}return s},Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("chunk",i=>{let n=a.shift();n?n.resolve(i):t.push(i)}),this.on("end",()=>{r=!0;for(let i of a)i.resolve(void 0);a.length=0}),this.on("abort",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),this.on("error",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,n)=>a.push({resolve:i,reject:n})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ts(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function NS(e,t){let{id:a,choices:r,created:i,model:n,system_fingerprint:s,...o}=e,l={...o,id:a,choices:r.map(({message:u,finish_reason:c,index:d,logprobs:h,...p})=>{if(!c)throw new G(`missing finish_reason for choice ${d}`);let{content:f=null,function_call:m,tool_calls:g,...b}=u,y=u.role;if(!y)throw new G(`missing role for choice ${d}`);if(m){let{arguments:_,name:w}=m;if(_==null)throw new G(`missing function_call.arguments for choice ${d}`);if(!w)throw new G(`missing function_call.name for choice ${d}`);return{...p,message:{content:f,function_call:{arguments:_,name:w},role:y,refusal:u.refusal??null},finish_reason:c,index:d,logprobs:h}}return g?{...p,index:d,finish_reason:c,logprobs:h,message:{...b,role:y,content:f,refusal:u.refusal??null,tool_calls:g.map((_,w)=>{let{function:O,type:j,id:S,...E}=_,{arguments:A,name:x,...te}=O||{};if(S==null)throw new G(`missing choices[${d}].tool_calls[${w}].id
${Ml(e)}`);if(j==null)throw new G(`missing choices[${d}].tool_calls[${w}].type
${Ml(e)}`);if(x==null)throw new G(`missing choices[${d}].tool_calls[${w}].function.name
${Ml(e)}`);if(A==null)throw new G(`missing choices[${d}].tool_calls[${w}].function.arguments
${Ml(e)}`);return{...E,id:S,type:j,function:{...te,name:x,arguments:A}}})}}:{...p,message:{...b,content:f,role:y,refusal:u.refusal??null},finish_reason:c,index:d,logprobs:h}}),created:i,model:n,object:"chat.completion",...s?{system_fingerprint:s}:{}};return ES(l,t)}function Ml(e){return JSON.stringify(e)}var Hv=class su extends Wv{static fromReadableStream(t){let a=new su(null);return a._run(()=>a._fromReadableStream(t)),a}static runFunctions(t,a,r){let i=new su(null),n={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return i._run(()=>i._runFunctions(t,a,n)),i}static runTools(t,a,r){let i=new su(a),n={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return i._run(()=>i._runTools(t,a,n)),i}},Gv=class extends K{parse(e,t){return SS(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(a=>gh(a,e))}runFunctions(e,t){return e.stream?Hv.runFunctions(this._client,e,t):Zv.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Hv.runTools(this._client,e,t):Zv.runTools(this._client,e,t)}stream(e,t){return Wv.createChatCompletion(this._client,e,t)}},Ah=class extends K{constructor(){super(...arguments),this.completions=new Gv(this._client)}};(function(e){e.Completions=Gv})(Ah||(Ah={}));var Jv=class extends K{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Kv=class extends K{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Ul=class extends K{constructor(){super(...arguments),this.sessions=new Jv(this._client),this.transcriptionSessions=new Kv(this._client)}};Ul.Sessions=Jv,Ul.TranscriptionSessions=Kv;var Sh=class extends K{create(e,t,a){return this._client.post(`/threads/${e}/messages`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/threads/${e}/messages/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,jh,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t,a){return this._client.delete(`/threads/${e}/messages/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},jh=class extends Ce{};Sh.MessagesPage=jh;var Ih=class extends K{retrieve(e,t,a,r={},i){return ke(r)?this.retrieve(e,t,a,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${a}`,{query:r,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,a={},r){return ke(a)?this.list(e,t,{},a):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,$h,{query:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}},$h=class extends Ce{};Ih.RunStepsPage=$h;var hs=class extends K{constructor(){super(...arguments),this.steps=new Ih(this._client)}create(e,t,a){let{include:r,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:i,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:t.stream??!1})}retrieve(e,t,a){return this._client.get(`/threads/${e}/runs/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Th,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}cancel(e,t,a){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t,a);return await this.poll(e,r.id,a)}createAndStream(e,t,a){return Zi.createAssistantStream(e,this._client.beta.threads.runs,t,a)}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let{data:i,response:n}=await this.retrieve(e,t,{...a,headers:{...a?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=n.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await as(s);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,a){return Zi.createAssistantStream(e,this._client.beta.threads.runs,t,a)}submitToolOutputs(e,t,a,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:a.stream??!1})}async submitToolOutputsAndPoll(e,t,a,r){let i=await this.submitToolOutputs(e,t,a,r);return await this.poll(e,i.id,r)}submitToolOutputsStream(e,t,a,r){return Zi.createToolAssistantStream(e,t,this._client.beta.threads.runs,a,r)}},Th=class extends Ce{};hs.RunsPage=Th,hs.Steps=Ih,hs.RunStepsPage=$h;var Hi=class extends K{constructor(){super(...arguments),this.runs=new hs(this._client),this.messages=new Sh(this._client)}create(e={},t){return ke(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/threads/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let a=await this.createAndRun(e,t);return await this.runs.poll(a.thread_id,a.id,t)}createAndRunStream(e,t){return Zi.createThreadAssistantStream(e,this._client.beta.threads,t)}};Hi.Runs=hs,Hi.RunsPage=Th,Hi.Messages=Sh,Hi.MessagesPage=jh;var Gi=class extends K{constructor(){super(...arguments),this.realtime=new Ul(this._client),this.chat=new Ah(this._client),this.assistants=new ph(this._client),this.threads=new Hi(this._client)}};Gi.Realtime=Ul,Gi.Assistants=ph,Gi.AssistantsPage=fh,Gi.Threads=Hi;var Xv=class extends K{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}},Yv=class extends K{retrieve(e,t,a){return this._client.get(`/containers/${e}/files/${t}/content`,{...a,headers:{Accept:"application/binary",...a?.headers},__binaryResponse:!0})}},Dl=class extends K{constructor(){super(...arguments),this.content=new Yv(this._client)}create(e,t,a){return this._client.post(`/containers/${e}/files`,qr({body:t,...a}))}retrieve(e,t,a){return this._client.get(`/containers/${e}/files/${t}`,a)}list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,Nh,{query:t,...a})}del(e,t,a){return this._client.delete(`/containers/${e}/files/${t}`,{...a,headers:{Accept:"*/*",...a?.headers}})}},Nh=class extends Ce{};Dl.FileListResponsesPage=Nh,Dl.Content=Yv;var ps=class extends K{constructor(){super(...arguments),this.files=new Dl(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/containers",Ch,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}},Ch=class extends Ce{};ps.ContainerListResponsesPage=Ch,ps.Files=Dl,ps.FileListResponsesPage=Nh;var Qv=class extends K{create(e,t){let a=!!e.encoding_format,r=a?e.encoding_format:"base64";a&&lr("Request","User defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return a?i:(lr("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(n=>(n&&n.data&&n.data.forEach(s=>{let o=s.embedding;s.embedding=vS(o)}),n)))}},Rh=class extends K{retrieve(e,t,a,r){return this._client.get(`/evals/${e}/runs/${t}/output_items/${a}`,r)}list(e,t,a={},r){return ke(a)?this.list(e,t,{},a):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Lh,{query:a,...r})}},Lh=class extends Ce{};Rh.OutputItemListResponsesPage=Lh;var fs=class extends K{constructor(){super(...arguments),this.outputItems=new Rh(this._client)}create(e,t,a){return this._client.post(`/evals/${e}/runs`,{body:t,...a})}retrieve(e,t,a){return this._client.get(`/evals/${e}/runs/${t}`,a)}list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Mh,{query:t,...a})}del(e,t,a){return this._client.delete(`/evals/${e}/runs/${t}`,a)}cancel(e,t,a){return this._client.post(`/evals/${e}/runs/${t}`,a)}},Mh=class extends Ce{};fs.RunListResponsesPage=Mh,fs.OutputItems=Rh,fs.OutputItemListResponsesPage=Lh;var ms=class extends K{constructor(){super(...arguments),this.runs=new fs(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,a){return this._client.post(`/evals/${e}`,{body:t,...a})}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/evals",Uh,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}},Uh=class extends Ce{};ms.EvalListResponsesPage=Uh,ms.Runs=fs,ms.RunListResponsesPage=Mh;var Dh=class extends K{create(e,t){return this._client.post("/files",qr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/files",Fh,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:a=30*60*1e3}={}){let r=new Set(["processed","error","deleted"]),i=Date.now(),n=await this.retrieve(e);for(;!n.status||!r.has(n.status);)if(await as(t),n=await this.retrieve(e),Date.now()-i>a)throw new fl({message:`Giving up on waiting for file ${e} to finish processing after ${a} milliseconds.`});return n}},Fh=class extends Ce{};Dh.FileObjectsPage=Fh;var ew=class extends K{},tw=class extends K{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}},zh=class extends K{constructor(){super(...arguments),this.graders=new tw(this._client)}};zh.Graders=tw;var Bh=class extends K{create(e,t,a){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Zh,{body:t,method:"post",...a})}retrieve(e,t={},a){return ke(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...a})}del(e,t,a){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,a)}},Zh=class extends wl{};Bh.PermissionCreateResponsesPage=Zh;var Fl=class extends K{constructor(){super(...arguments),this.permissions=new Bh(this._client)}};Fl.Permissions=Bh,Fl.PermissionCreateResponsesPage=Zh;var qh=class extends K{list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Vh,{query:t,...a})}},Vh=class extends Ce{};qh.FineTuningJobCheckpointsPage=Vh;var Ji=class extends K{constructor(){super(...arguments),this.checkpoints=new qh(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Wh,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},a){return ke(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Hh,{query:t,...a})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}},Wh=class extends Ce{},Hh=class extends Ce{};Ji.FineTuningJobsPage=Wh,Ji.FineTuningJobEventsPage=Hh,Ji.Checkpoints=qh,Ji.FineTuningJobCheckpointsPage=Vh;var cr=class extends K{constructor(){super(...arguments),this.methods=new ew(this._client),this.jobs=new Ji(this._client),this.checkpoints=new Fl(this._client),this.alpha=new zh(this._client)}};cr.Methods=ew,cr.Jobs=Ji,cr.FineTuningJobsPage=Wh,cr.FineTuningJobEventsPage=Hh,cr.Checkpoints=Fl,cr.Alpha=zh;var aw=class extends K{},Gh=class extends K{constructor(){super(...arguments),this.graderModels=new aw(this._client)}};Gh.GraderModels=aw;var rw=class extends K{createVariation(e,t){return this._client.post("/images/variations",qr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",qr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}},Jh=class extends K{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Kh,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Kh=class extends wl{};Jh.ModelsPage=Kh;var iw=class extends K{create(e,t){return this._client.post("/moderations",{body:e,...t})}};function CS(e,t){return!t||!LS(t)?{...e,output_parsed:null,output:e.output.map(a=>a.type==="function_call"?{...a,parsed_arguments:null}:a.type==="message"?{...a,content:a.content.map(r=>({...r,parsed:null}))}:a)}:nw(e,t)}function nw(e,t){let a=e.output.map(i=>{if(i.type==="function_call")return{...i,parsed_arguments:DS(t,i)};if(i.type==="message"){let n=i.content.map(s=>s.type==="output_text"?{...s,parsed:RS(t,s.text)}:s);return{...i,content:n}}return i}),r=Object.assign({},e,{output:a});return Object.getOwnPropertyDescriptor(e,"output_text")||sw(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(let i of r.output)if(i.type==="message"){for(let n of i.content)if(n.type==="output_text"&&n.parsed!==null)return n.parsed}return null}}),r}function RS(e,t){return e.text?.format?.type!=="json_schema"?null:"$parseRaw"in e.text?.format?(e.text?.format).$parseRaw(t):JSON.parse(t)}function LS(e){return!!mh(e.text?.format)}function MS(e){return e?.$brand==="auto-parseable-tool"}function US(e,t){return e.find(a=>a.type==="function"&&a.name===t)}function DS(e,t){let a=US(e.tools??[],t.name);return{...t,...t,parsed_arguments:MS(a)?a.$parseRaw(t.arguments):a?.strict?JSON.parse(t.arguments):null}}function sw(e){let t=[];for(let a of e.output)if(a.type==="message")for(let r of a.content)r.type==="output_text"&&t.push(r.text);e.output_text=t.join("")}var ow=class extends K{list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,BS,{query:t,...a})}},Ki=function(e,t,a,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,a):i?i.value=a:t.set(e,a),a},dr=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Xi,zl,hr,Bl,lw,uw,cw,dw,FS=class gO extends dh{constructor(t){super(),Xi.add(this),zl.set(this,void 0),hr.set(this,void 0),Bl.set(this,void 0),Ki(this,zl,t,"f")}static createResponse(t,a,r){let i=new gO(a);return i._run(()=>i._createOrRetrieveResponse(t,a,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createOrRetrieveResponse(t,a,r){let i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),dr(this,Xi,"m",lw).call(this);let n,s=null;"response_id"in a?(n=await t.responses.retrieve(a.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),s=a.starting_after??null):n=await t.responses.create({...a,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(let o of n)dr(this,Xi,"m",uw).call(this,o,s);if(n.controller.signal?.aborted)throw new kt;return dr(this,Xi,"m",cw).call(this)}[(zl=new WeakMap,hr=new WeakMap,Bl=new WeakMap,Xi=new WeakSet,lw=function(){this.ended||Ki(this,hr,void 0,"f")},uw=function(t,a){if(this.ended)return;let r=(n,s)=>{(a==null||s.sequence_number>a)&&this._emit(n,s)},i=dr(this,Xi,"m",dw).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{let n=i.output[t.output_index];if(!n)throw new G(`missing output at index ${t.output_index}`);if(n.type==="message"){let s=n.content[t.content_index];if(!s)throw new G(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new G(`expected content to be 'output_text', got ${s.type}`);r("response.output_text.delta",{...t,snapshot:s.text})}break}case"response.function_call_arguments.delta":{let n=i.output[t.output_index];if(!n)throw new G(`missing output at index ${t.output_index}`);n.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:n.arguments});break}default:r(t.type,t);break}},cw=function(){if(this.ended)throw new G("stream has ended, this shouldn't happen");let t=dr(this,hr,"f");if(!t)throw new G("request ended without sending any events");Ki(this,hr,void 0,"f");let a=zS(t,dr(this,zl,"f"));return Ki(this,Bl,a,"f"),a},dw=function(t){let a=dr(this,hr,"f");if(!a){if(t.type!=="response.created")throw new G(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return a=Ki(this,hr,t.response,"f"),a}switch(t.type){case"response.output_item.added":{a.output.push(t.item);break}case"response.content_part.added":{let r=a.output[t.output_index];if(!r)throw new G(`missing output at index ${t.output_index}`);r.type==="message"&&r.content.push(t.part);break}case"response.output_text.delta":{let r=a.output[t.output_index];if(!r)throw new G(`missing output at index ${t.output_index}`);if(r.type==="message"){let i=r.content[t.content_index];if(!i)throw new G(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new G(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{let r=a.output[t.output_index];if(!r)throw new G(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.completed":{Ki(this,hr,t.response,"f");break}}return a},Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("event",i=>{let n=a.shift();n?n.resolve(i):t.push(i)}),this.on("end",()=>{r=!0;for(let i of a)i.resolve(void 0);a.length=0}),this.on("abort",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),this.on("error",i=>{r=!0;for(let n of a)n.reject(i);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,n)=>a.push({resolve:i,reject:n})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let t=dr(this,Bl,"f");if(!t)throw new G("stream ended without producing a ChatCompletion");return t}};function zS(e,t){return CS(e,t)}var Xh=class extends K{constructor(){super(...arguments),this.inputItems=new ow(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(a=>("object"in a&&a.object==="response"&&sw(a),a))}retrieve(e,t={},a){return this._client.get(`/responses/${e}`,{query:t,...a,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(a=>nw(a,e))}stream(e,t){return FS.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}},BS=class extends Ce{};Xh.InputItems=ow;var hw=class extends K{create(e,t,a){return this._client.post(`/uploads/${e}/parts`,qr({body:t,...a}))}},Yh=class extends K{constructor(){super(...arguments),this.parts=new hw(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,a){return this._client.post(`/uploads/${e}/complete`,{body:t,...a})}};Yh.Parts=hw;var ZS=async e=>{let t=await Promise.allSettled(e),a=t.filter(i=>i.status==="rejected");if(a.length){for(let i of a)console.error(i.reason);throw new Error(`${a.length} promise(s) failed - see the above errors`)}let r=[];for(let i of t)i.status==="fulfilled"&&r.push(i.value);return r},Zl=class extends K{create(e,t,a){return this._client.post(`/vector_stores/${e}/files`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/vector_stores/${e}/files/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ke(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,ql,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t,a){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t,a);return await this.poll(e,r.id,a)}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let i=await this.retrieve(e,t,{...a,headers:r}).withResponse(),n=i.data;switch(n.status){case"in_progress":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=i.response.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await as(s);break;case"failed":case"completed":return n}}}async upload(e,t,a){let r=await this._client.files.create({file:t,purpose:"assistants"},a);return this.create(e,{file_id:r.id},a)}async uploadAndPoll(e,t,a){let r=await this.upload(e,t,a);return await this.poll(e,r.id,a)}content(e,t,a){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Qh,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},ql=class extends Ce{},Qh=class extends wl{};Zl.VectorStoreFilesPage=ql,Zl.FileContentResponsesPage=Qh;var pw=class extends K{create(e,t,a){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}cancel(e,t,a){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t);return await this.poll(e,r.id,a)}listFiles(e,t,a={},r){return ke(a)?this.listFiles(e,t,{},a):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,ql,{query:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let{data:i,response:n}=await this.retrieve(e,t,{...a,headers:r}).withResponse();switch(i.status){case"in_progress":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=n.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await as(s);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:a=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=r?.maxConcurrency??5,n=Math.min(i,t.length),s=this._client,o=t.values(),l=[...a];async function u(d){for(let h of d){let p=await s.files.create({file:h,purpose:"assistants"},r);l.push(p.id)}}let c=Array(n).fill(o).map(u);return await ZS(c),await this.createAndPoll(e,{file_ids:l})}},pr=class extends K{constructor(){super(...arguments),this.files=new Zl(this._client),this.fileBatches=new pw(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/vector_stores/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e={},t){return ke(e)?this.list({},e):this._client.getAPIList("/vector_stores",ep,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,a){return this._client.getAPIList(`/vector_stores/${e}/search`,tp,{body:t,method:"post",...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},ep=class extends Ce{},tp=class extends wl{};pr.VectorStoresPage=ep,pr.VectorStoreSearchResponsesPage=tp,pr.Files=Zl,pr.VectorStoreFilesPage=ql,pr.FileContentResponsesPage=Qh,pr.FileBatches=pw;var fw,ee=class extends lS{constructor({baseURL:e=_l("OPENAI_BASE_URL"),apiKey:t=_l("OPENAI_API_KEY"),organization:a=_l("OPENAI_ORG_ID")??null,project:r=_l("OPENAI_PROJECT_ID")??null,...i}={}){if(t===void 0)throw new G("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let n={apiKey:t,organization:a,project:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!n.dangerouslyAllowBrowser&&bS())throw new G(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:n.baseURL,timeout:n.timeout??6e5,httpAgent:n.httpAgent,maxRetries:n.maxRetries,fetch:n.fetch}),this.completions=new Xv(this),this.chat=new El(this),this.embeddings=new Qv(this),this.files=new Dh(this),this.images=new rw(this),this.audio=new rs(this),this.moderations=new iw(this),this.models=new Jh(this),this.fineTuning=new cr(this),this.graders=new Gh(this),this.vectorStores=new pr(this),this.beta=new Gi(this),this.batches=new lh(this),this.uploads=new Yh(this),this.responses=new Xh(this),this.evals=new ms(this),this.containers=new ps(this),this._options=n,this.apiKey=t,this.organization=a,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return FA(e,{arrayFormat:"brackets"})}};fw=ee,ee.OpenAI=fw,ee.DEFAULT_TIMEOUT=6e5,ee.OpenAIError=G,ee.APIError=ct,ee.APIConnectionError=pl,ee.APIConnectionTimeoutError=fl,ee.APIUserAbortError=kt,ee.NotFoundError=ev,ee.ConflictError=tv,ee.RateLimitError=rv,ee.BadRequestError=X_,ee.AuthenticationError=Y_,ee.InternalServerError=iv,ee.PermissionDeniedError=Q_,ee.UnprocessableEntityError=av,ee.toFile=cv,ee.fileFromPath=G_,ee.Completions=Xv,ee.Chat=El,ee.ChatCompletionsPage=kl,ee.Embeddings=Qv,ee.Files=Dh,ee.FileObjectsPage=Fh,ee.Images=rw,ee.Audio=rs,ee.Moderations=iw,ee.Models=Jh,ee.ModelsPage=Kh,ee.FineTuning=cr,ee.Graders=Gh,ee.VectorStores=pr,ee.VectorStoresPage=ep,ee.VectorStoreSearchResponsesPage=tp,ee.Beta=Gi,ee.Batches=lh,ee.BatchesPage=uh,ee.Uploads=Yh,ee.Responses=Xh,ee.Evals=ms,ee.EvalListResponsesPage=Uh,ee.Containers=ps,ee.ContainerListResponsesPage=Ch,jr(),$a(),ki(),ar();function mw(e,t){if(e.function===void 0)return;let a;if(t?.partial)try{a=_c(e.function.arguments??"{}")}catch{return}else try{a=JSON.parse(e.function.arguments)}catch(i){throw new Td([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${i.message}`].join(`
`))}let r={name:e.function.name,args:a,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function qS(e){if(e.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function VS(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}var WS=class extends s_{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let a=e[0].message,r;if(fo(a)&&a.tool_calls?.length?r=a.tool_calls.map(n=>{let{id:s,...o}=n;return this.returnId?{id:s,...o}:o}):a.additional_kwargs.tool_calls!==void 0&&(r=JSON.parse(JSON.stringify(a.additional_kwargs.tool_calls)).map(n=>mw(n,{returnId:this.returnId,partial:t}))),!r)return[];let i=[];for(let n of r)if(n!==void 0){let s={type:n.name,args:n.args,id:n.id};i.push(s)}return i}},gw=class extends WS{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await ax(this.zodSchema,e);if(t.success)return t.data;throw new Td(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(r=>r.type===this.keyName),a=t;if(t.length)return this.returnId||(a=t.map(r=>r.args)),this.returnSingle?a[0]:a}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(r=>r.type===this.keyName),a=t;return t.length?(this.returnId||(a=t.map(r=>r.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(r=>this._validateResult(r)))):void 0}};nd();var HS=Symbol("Let zodToJsonSchema decide on which parser to use"),yw={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},GS=e=>typeof e=="string"?{...yw,basePath:["#"],definitions:{},name:e}:{...yw,basePath:["#"],definitions:{},...e},ap=e=>"_def"in e?e._def:e;function JS(e){if(!e)return!0;for(let t in e)return!1;return!0}var KS=e=>{let t=GS(e),a=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:a,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([r,i])=>[ap(i),{def:ap(i),path:[...t.basePath,t.definitionPath,r],jsonSchema:void 0}]))}};function bw(e,t,a,r){r?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function be(e,t,a,r,i){e[t]=a,bw(e,t,r,i)}Ra();function XS(){return{}}Ra();function YS(e,t){let a={type:"array"};return e.type?._def?.typeName!==k.ZodAny&&(a.items=he(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&be(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&be(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(be(a,"minItems",e.exactLength.value,e.exactLength.message,t),be(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}function QS(e,t){let a={type:"integer",format:"int64"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"min":t.target==="jsonSchema7"?r.inclusive?be(a,"minimum",r.value,r.message,t):be(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),be(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?be(a,"maximum",r.value,r.message,t):be(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),be(a,"maximum",r.value,r.message,t));break;case"multipleOf":be(a,"multipleOf",r.value,r.message,t);break}return a}function ej(){return{type:"boolean"}}function tj(e,t){return he(e.type._def,t)}var aj=(e,t)=>he(e.innerType._def,t);function _w(e,t,a){let r=a??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((i,n)=>_w(e,t,i))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return rj(e,t)}}var rj=(e,t)=>{let a={type:"integer",format:"unix-time"};if(t.target==="openApi3")return a;for(let r of e.checks)switch(r.kind){case"min":be(a,"minimum",r.value,r.message,t);break;case"max":be(a,"maximum",r.value,r.message,t);break}return a};function ij(e,t){return{...he(e.innerType._def,t),default:e.defaultValue()}}function nj(e,t,a){return t.effectStrategy==="input"?he(e.schema._def,t,a):{}}function sj(e){return{type:"string",enum:[...e.values]}}var oj=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function lj(e,t){let a=[he(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),he(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(n=>!!n),r=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,i=[];return a.forEach(n=>{if(oj(n))i.push(...n.allOf),n.unevaluatedProperties===void 0&&(r=void 0);else{let s=n;if("additionalProperties"in n&&n.additionalProperties===!1){let{additionalProperties:o,...l}=n;s=l}else r=void 0;i.push(s)}}),i.length?{allOf:i,...r}:void 0}function uj(e,t){let a=typeof e.value;return a!=="bigint"&&a!=="number"&&a!=="boolean"&&a!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:a==="bigint"?"integer":a,enum:[e.value]}:{type:a==="bigint"?"integer":a,const:e.value}}Ra();var rp,Hr={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(rp===void 0&&(rp=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),rp),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function vw(e,t){let a={type:"string"};function r(i){return t.patternStrategy==="escape"?cj(i):i}if(e.checks)for(let i of e.checks)switch(i.kind){case"min":be(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,i.value):i.value,i.message,t);break;case"max":be(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":ra(a,"email",i.message,t);break;case"format:idn-email":ra(a,"idn-email",i.message,t);break;case"pattern:zod":ia(a,Hr.email,i.message,t);break}break;case"url":ra(a,"uri",i.message,t);break;case"uuid":ra(a,"uuid",i.message,t);break;case"regex":ia(a,i.regex,i.message,t);break;case"cuid":ia(a,Hr.cuid,i.message,t);break;case"cuid2":ia(a,Hr.cuid2,i.message,t);break;case"startsWith":ia(a,RegExp(`^${r(i.value)}`),i.message,t);break;case"endsWith":ia(a,RegExp(`${r(i.value)}$`),i.message,t);break;case"datetime":ra(a,"date-time",i.message,t);break;case"date":ra(a,"date",i.message,t);break;case"time":ra(a,"time",i.message,t);break;case"duration":ra(a,"duration",i.message,t);break;case"length":be(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,i.value):i.value,i.message,t),be(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,i.value):i.value,i.message,t);break;case"includes":{ia(a,RegExp(r(i.value)),i.message,t);break}case"ip":{i.version!=="v6"&&ra(a,"ipv4",i.message,t),i.version!=="v4"&&ra(a,"ipv6",i.message,t);break}case"emoji":ia(a,Hr.emoji,i.message,t);break;case"ulid":{ia(a,Hr.ulid,i.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{ra(a,"binary",i.message,t);break}case"contentEncoding:base64":{be(a,"contentEncoding","base64",i.message,t);break}case"pattern:zod":{ia(a,Hr.base64,i.message,t);break}}break}case"nanoid":ia(a,Hr.nanoid,i.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return a}var cj=e=>Array.from(e).map(t=>/[a-zA-Z0-9]/.test(t)?t:`\\${t}`).join(""),ra=(e,t,a,r)=>{e.format||e.anyOf?.some(i=>i.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&r.errorMessages&&{errorMessage:{format:a}}})):be(e,"format",t,a,r)},ia=(e,t,a,r)=>{e.pattern||e.allOf?.some(i=>i.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:ww(t,r),...a&&r.errorMessages&&{errorMessage:{pattern:a}}})):be(e,"pattern",ww(t,r),a,r)},ww=(e,t)=>{let a=typeof e=="function"?e():e;if(!t.applyRegexFlags||!a.flags)return a.source;let r={i:a.flags.includes("i"),m:a.flags.includes("m"),s:a.flags.includes("s")},i=r.i?a.source.toLowerCase():a.source,n="",s=!1,o=!1,l=!1;for(let u=0;u<i.length;u++){if(s){n+=i[u],s=!1;continue}if(r.i){if(o){if(i[u].match(/[a-z]/)){l?(n+=i[u],n+=`${i[u-2]}-${i[u]}`.toUpperCase(),l=!1):i[u+1]==="-"&&i[u+2]?.match(/[a-z]/)?(n+=i[u],l=!0):n+=`${i[u]}${i[u].toUpperCase()}`;continue}}else if(i[u].match(/[a-z]/)){n+=`[${i[u]}${i[u].toUpperCase()}]`;continue}}if(r.m){if(i[u]==="^"){n+=`(^|(?<=[\r
]))`;continue}else if(i[u]==="$"){n+=`($|(?=[\r
]))`;continue}}if(r.s&&i[u]==="."){n+=o?`${i[u]}\r
`:`[${i[u]}\r
]`;continue}n+=i[u],i[u]==="\\"?s=!0:o&&i[u]==="]"?o=!1:!o&&i[u]==="["&&(o=!0)}try{let u=new RegExp(n)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),a.source}return n};function Ow(e,t){if(t.target==="openApi3"&&e.keyType?._def.typeName===k.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,i)=>({...r,[i]:he(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",i]})??{}}),{}),additionalProperties:!1};let a={type:"object",additionalProperties:he(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if(t.target==="openApi3")return a;if(e.keyType?._def.typeName===k.ZodString&&e.keyType._def.checks?.length){let r=Object.entries(vw(e.keyType._def,t)).reduce((i,[n,s])=>n==="type"?i:{...i,[n]:s},{});return{...a,propertyNames:r}}else if(e.keyType?._def.typeName===k.ZodEnum)return{...a,propertyNames:{enum:e.keyType._def.values}};return a}function dj(e,t){if(t.mapStrategy==="record")return Ow(e,t);let a=he(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},r=he(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[a,r],minItems:2,maxItems:2}}}function hj(e){let t=e.values,a=Object.keys(e.values).filter(i=>typeof t[t[i]]!="number").map(i=>t[i]),r=Array.from(new Set(a.map(i=>typeof i)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:a}}function pj(){return{not:{}}}function fj(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Vl={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function mj(e,t){if(t.target==="openApi3")return kw(e,t);let a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every(r=>r._def.typeName in Vl&&(!r._def.checks||!r._def.checks.length))){let r=a.reduce((i,n)=>{let s=Vl[n._def.typeName];return s&&!i.includes(s)?[...i,s]:i},[]);return{type:r.length>1?r:r[0]}}else if(a.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=a.reduce((i,n)=>{let s=typeof n._def.value;switch(s){case"string":case"number":case"boolean":return[...i,s];case"bigint":return[...i,"integer"];case"object":if(n._def.value===null)return[...i,"null"];case"symbol":case"undefined":case"function":default:return i}},[]);if(r.length===a.length){let i=r.filter((n,s,o)=>o.indexOf(n)===s);return{type:i.length>1?i:i[0],enum:a.reduce((n,s)=>n.includes(s._def.value)?n:[...n,s._def.value],[])}}}else if(a.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:a.reduce((r,i)=>[...r,...i._def.values.filter(n=>!r.includes(n))],[])};return kw(e,t)}var kw=(e,t)=>{let a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((r,i)=>he(r._def,{...t,currentPath:[...t.currentPath,"anyOf",`${i}`]})).filter(r=>!!r&&(!t.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return a.length?{anyOf:a}:void 0};function gj(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"||t.nullableStrategy==="property"?{type:Vl[e.innerType._def.typeName],nullable:!0}:{type:[Vl[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){let r=he(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let a=he(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}function yj(e,t){let a={type:"number"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"int":a.type="integer",bw(a,"type",r.message,t);break;case"min":t.target==="jsonSchema7"?r.inclusive?be(a,"minimum",r.value,r.message,t):be(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),be(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?be(a,"maximum",r.value,r.message,t):be(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),be(a,"maximum",r.value,r.message,t));break;case"multipleOf":be(a,"multipleOf",r.value,r.message,t);break}return a}function bj(e,t){return t.removeAdditionalStrategy==="strict"?e.catchall._def.typeName==="ZodNever"?e.unknownKeys!=="strict":he(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:e.catchall._def.typeName==="ZodNever"?e.unknownKeys==="passthrough":he(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function _j(e,t){let a={type:"object",...Object.entries(e.shape()).reduce((r,[i,n])=>{if(n===void 0||n._def===void 0)return r;let s=[...t.currentPath,"properties",i],o=he(n._def,{...t,currentPath:s,propertyPath:s});return o===void 0?r:(t.openaiStrictMode&&n.isOptional()&&!n.isNullable()&&console.warn(`Zod field at \`${s.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...r.properties,[i]:o},required:n.isOptional()&&!t.openaiStrictMode?r.required:[...r.required,i]})},{properties:{},required:[]}),additionalProperties:bj(e,t)};return a.required.length||delete a.required,a}var vj=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return he(e.innerType._def,t);let a=he(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:{}},a]}:{}},wj=(e,t)=>{if(t.pipeStrategy==="input")return he(e.in._def,t);if(t.pipeStrategy==="output")return he(e.out._def,t);let a=he(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),r=he(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]});return{allOf:[a,r].filter(i=>i!==void 0)}};function Oj(e,t){return he(e.type._def,t)}function kj(e,t){let a={type:"array",uniqueItems:!0,items:he(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&be(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&be(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}function Ej(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((a,r)=>he(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[]),additionalItems:he(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((a,r)=>he(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[])}}function xj(){return{not:{}}}function Pj(){return{}}var Aj=(e,t)=>he(e.innerType._def,t);function he(e,t,a=!1){let r=t.seen.get(e);if(t.override){let s=t.override?.(e,t,r,a);if(s!==HS)return s}if(r&&!a){let s=Sj(r,t);if(s!==void 0)return"$ref"in s&&t.seenRefs.add(s.$ref),s}let i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);let n=Ij(e,e.typeName,t,a);return n&&$j(e,t,n),i.jsonSchema=n,n}var Sj=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let a=e.path.slice(t.basePath.length+1).join("_");return a!==t.name&&t.nameStrategy==="duplicate-ref"&&(t.definitions[a]=e.def),{$ref:[...t.basePath,t.definitionPath,a].join("/")};case"relative":return{$ref:jj(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,i)=>t.currentPath[i]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):t.$refStrategy==="seen"?{}:void 0}},jj=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")},Ij=(e,t,a,r)=>{switch(t){case k.ZodString:return vw(e,a);case k.ZodNumber:return yj(e,a);case k.ZodObject:return _j(e,a);case k.ZodBigInt:return QS(e,a);case k.ZodBoolean:return ej();case k.ZodDate:return _w(e,a);case k.ZodUndefined:return xj();case k.ZodNull:return fj(a);case k.ZodArray:return YS(e,a);case k.ZodUnion:case k.ZodDiscriminatedUnion:return mj(e,a);case k.ZodIntersection:return lj(e,a);case k.ZodTuple:return Ej(e,a);case k.ZodRecord:return Ow(e,a);case k.ZodLiteral:return uj(e,a);case k.ZodEnum:return sj(e);case k.ZodNativeEnum:return hj(e);case k.ZodNullable:return gj(e,a);case k.ZodOptional:return vj(e,a);case k.ZodMap:return dj(e,a);case k.ZodSet:return kj(e,a);case k.ZodLazy:return he(e.getter()._def,a);case k.ZodPromise:return Oj(e,a);case k.ZodNaN:case k.ZodNever:return pj();case k.ZodEffects:return nj(e,a,r);case k.ZodAny:return XS();case k.ZodUnknown:return Pj();case k.ZodDefault:return ij(e,a);case k.ZodBranded:return tj(e,a);case k.ZodReadonly:return Aj(e,a);case k.ZodCatch:return aj(e,a);case k.ZodPipeline:return wj(e,a);case k.ZodFunction:case k.ZodVoid:case k.ZodSymbol:return;default:return(i=>{})(t)}},$j=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a),Tj=(e,t)=>{let a=KS(t),r=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,i=he(e._def,r===void 0?a:{...a,currentPath:[...a.basePath,a.definitionPath,r]},!1)??{},n=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;n!==void 0&&(i.title=n);let s=(()=>{if(JS(a.definitions))return;let l={},u=new Set;for(let c=0;c<500;c++){let d=Object.entries(a.definitions).filter(([h])=>!u.has(h));if(d.length===0)break;for(let[h,p]of d)l[h]=he(ap(p),{...a,currentPath:[...a.basePath,a.definitionPath,h]},!0)??{},u.add(h)}return l})(),o=r===void 0?s?{...i,[a.definitionPath]:s}:i:a.nameStrategy==="duplicate-ref"?{...i,...s||a.seenRefs.size?{[a.definitionPath]:{...s,...a.seenRefs.size?{[r]:i}:void 0}}:void 0}:{$ref:[...a.$refStrategy==="relative"?[]:a.basePath,a.definitionPath,r].join("/"),[a.definitionPath]:{...s,[r]:i}};return a.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":a.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Ew(e,t){return Tj(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Nj(e,t,a){return OS({type:"json_schema",json_schema:{...a,name:t,strict:!0,schema:Ew(e,{name:t})}},r=>e.parse(JSON.parse(r)))}function Cj(e){return kS({type:"function",function:{name:e.name,parameters:Ew(e.parameters,{name:e.name}),strict:!0,...e.description?{description:e.description}:void 0}},{callback:e.function,parser:t=>e.parameters.parse(JSON.parse(t))})}function Rj(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:a,azureOpenAIApiKey:r,azureOpenAIBasePath:i,baseURL:n,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((r||s)&&i&&t)return`${i}/${t}`;if((r||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||s){if(!a)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${a}.openai.azure.com/openai/deployments/${t}`}return n}nd();function Wl(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function xw(e){let t;return e.constructor.name===fl.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===kt.name?(t=new Error(e.message),t.name="AbortError"):e.status===400&&e.message.includes("tool_calls")?t=Wl(e,"INVALID_TOOL_RESULTS"):e.status===401?t=Wl(e,"MODEL_AUTHENTICATION"):e.status===429?t=Wl(e,"MODEL_RATE_LIMIT"):e.status===404?t=Wl(e,"MODEL_NOT_FOUND"):t=e,t}function Lj(e){if(e)return e==="any"||e==="required"?"required":e==="auto"?"auto":e==="none"?"none":typeof e=="string"?{type:"function",function:{name:e}}:e}function Mj(e){return e.anyOf!==void 0&&Array.isArray(e.anyOf)}function Uj(e){let t=["namespace functions {",""];for(let a of e)a.description&&t.push(`// ${a.description}`),Object.keys(a.parameters.properties??{}).length>0?(t.push(`type ${a.name} = (_: {`),t.push(Pw(a.parameters,0)),t.push("}) => any;")):t.push(`type ${a.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join(`
`)}function Pw(e,t){let a=[];for(let[r,i]of Object.entries(e.properties??{}))i.description&&t<2&&a.push(`// ${i.description}`),e.required?.includes(r)?a.push(`${r}: ${Hl(i,t)},`):a.push(`${r}?: ${Hl(i,t)},`);return a.map(r=>" ".repeat(t)+r).join(`
`)}function Hl(e,t){if(Mj(e))return e.anyOf.map(a=>Hl(a,t)).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map(a=>`"${a}"`).join(" | "):"string";case"number":return e.enum?e.enum.map(a=>`${a}`).join(" | "):"number";case"integer":return e.enum?e.enum.map(a=>`${a}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Pw(e,t+2),"}"].join(`
`);case"array":return e.items?`${Hl(e.items,t)}[]`:"any[]";default:return""}}function Dj(e,t){let a;if(cP(e)){let r=Cj({name:e.name,parameters:e.schema,description:e.description});r.function.parameters?a={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...t?.strict!==void 0?{strict:t.strict}:{}}}:a={type:"function",function:mP(e,t)}}else a=e;return t?.strict!==void 0&&(a.function.strict=t.strict),a}function Fj(e){return e.role!=="system"&&e.role!=="developer"&&e.role!=="assistant"&&e.role!=="user"&&e.role!=="function"&&e.role!=="tool"&&console.warn(`Unknown message role: ${e.role}`),e.role}function Aw(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Ei.isInstance(e))throw new Error("Invalid generic chat message");return Fj(e)}default:throw new Error(`Unknown message type: ${t}`)}}function zj(e,t,a){let r=e.tool_calls;switch(e.role){case"assistant":{let i=[],n=[];for(let l of r??[])try{i.push(mw(l,{returnId:!0}))}catch(u){n.push(VS(l,u.message))}let s={function_call:e.function_call,tool_calls:r};a!==void 0&&(s.__raw_response=t);let o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(s.audio=e.audio),new Oi({content:e.content||"",tool_calls:i,invalid_tool_calls:n,additional_kwargs:s,response_metadata:o,id:t.id})}default:return new Ei(e.content||"",e.role??"unknown")}}function Bj(e,t,a,r){let i=e.role??a,n=e.content??"",s;e.function_call?s={function_call:e.function_call}:e.tool_calls?s={tool_calls:e.tool_calls}:s={},r&&(s.__raw_response=t),e.audio&&(s.audio={...e.audio,index:t.choices[0].index});let o={usage:{...t.usage}};if(i==="user")return new xc({content:n,response_metadata:o});if(i==="assistant"){let l=[];if(Array.isArray(e.tool_calls))for(let u of e.tool_calls)l.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new xr({content:n,tool_call_chunks:l,additional_kwargs:s,id:t.id,response_metadata:o})}else return i==="system"?new yo({content:n,response_metadata:o}):i==="developer"?new yo({content:n,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):i==="function"?new kc({content:n,additional_kwargs:s,name:e.name,response_metadata:o}):i==="tool"?new Wg({content:n,additional_kwargs:s,tool_call_id:e.tool_call_id,response_metadata:o}):new wc({content:n,role:i,response_metadata:o})}function Sw(e,t){return e.flatMap(a=>{let r=Aw(a);r==="system"&&t?.startsWith("o1")&&(r="developer");let i={role:r,content:a.content};if(a.name!=null&&(i.name=a.name),a.additional_kwargs.function_call!=null&&(i.function_call=a.additional_kwargs.function_call,i.content=null),fo(a)&&a.tool_calls?.length?(i.tool_calls=a.tool_calls.map(qS),i.content=null):(a.additional_kwargs.tool_calls!=null&&(i.tool_calls=a.additional_kwargs.tool_calls),a.tool_call_id!=null&&(i.tool_call_id=a.tool_call_id)),a.additional_kwargs.audio&&typeof a.additional_kwargs.audio=="object"&&"id"in a.additional_kwargs.audio){let n={role:"assistant",audio:{id:a.additional_kwargs.audio.id}};return[i,n]}return i})}function jw(e,t){return tP(e)?t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e:Dj(e,t)}var Zj=class extends iP{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??We("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??We("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??We("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??We("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??We("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??We("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??We("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??We("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){let a=this.azureOpenAIBasePath.split("/openai/deployments/");if(a.length===2){let[,r]=a;this.azureOpenAIApiDeploymentName=r}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.model==="o1"&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let a;return t?.strict!==void 0?a=t.strict:this.supportsStrictToolCalling!==void 0&&(a=this.supportsStrictToolCalling),this.bind({tools:e.map(r=>jw(r,{strict:a})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Gl(e.json_schema.schema)?Nj(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let a;e?.strict!==void 0?a=e.strict:this.supportsStrictToolCalling!==void 0&&(a=this.supportsStrictToolCalling);let r={};e?.stream_options!==void 0?r={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(r={stream_options:{include_usage:!0}});let i={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(s=>jw(s,{strict:a})):void 0,tool_choice:Lj(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...r,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(i.prediction=e.prediction);let n=e?.reasoning_effort??this.reasoningEffort;return n!==void 0&&(i.reasoning_effort=n),i}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,a){let r=Sw(e,this.model),i={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0},n,s=await this.completionWithRetry(i,t),o;for await(let l of s){let u=l?.choices?.[0];if(l.usage&&(o=l.usage),!u)continue;let{delta:c}=u;if(!c)continue;let d=Bj(c,l,n,this.__includeRawResponse);n=c.role??n;let h={prompt:t.promptIndex??0,completion:u.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let p={...h};u.finish_reason!=null&&(p.finish_reason=u.finish_reason,p.system_fingerprint=l.system_fingerprint,p.model_name=l.model),this.logprobs&&(p.logprobs=u.logprobs);let f=new On({message:d,text:d.content,generationInfo:p});yield f,await a?.handleLLMNewToken(f.text??"",h,void 0,void 0,void 0,{chunk:f})}if(o){let l={...o.prompt_tokens_details?.audio_tokens!==null&&{audio:o.prompt_tokens_details?.audio_tokens},...o.prompt_tokens_details?.cached_tokens!==null&&{cache_read:o.prompt_tokens_details?.cached_tokens}},u={...o.completion_tokens_details?.audio_tokens!==null&&{audio:o.completion_tokens_details?.audio_tokens},...o.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:o.completion_tokens_details?.reasoning_tokens}};yield new On({message:new xr({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(l).length>0&&{input_token_details:l},...Object.keys(u).length>0&&{output_token_details:u}}}),text:""})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,a){let r={},i=this.invocationParams(t),n=Sw(e,this.model);if(i.stream){let s=this._streamResponseChunks(e,t,a),o={};for await(let p of s){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};let f=p.generationInfo?.completion??0;o[f]===void 0?o[f]=p:o[f]=o[f].concat(p)}let l=Object.entries(o).sort(([p],[f])=>parseInt(p,10)-parseInt(f,10)).map(([p,f])=>f),{functions:u,function_call:c}=this.invocationParams(t),d=await this.getEstimatedTokenCountFromPrompt(e,u,c),h=await this.getNumTokensFromGenerations(l);return r.input_tokens=d,r.output_tokens=h,r.total_tokens=d+h,{generations:l,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}else{let s;t.response_format&&t.response_format.type==="json_schema"?s=await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options}):s=await this.completionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options});let{completion_tokens:o,prompt_tokens:l,total_tokens:u,prompt_tokens_details:c,completion_tokens_details:d}=s?.usage??{};o&&(r.output_tokens=(r.output_tokens??0)+o),l&&(r.input_tokens=(r.input_tokens??0)+l),u&&(r.total_tokens=(r.total_tokens??0)+u),(c?.audio_tokens!==null||c?.cached_tokens!==null)&&(r.input_token_details={...c?.audio_tokens!==null&&{audio:c?.audio_tokens},...c?.cached_tokens!==null&&{cache_read:c?.cached_tokens}}),(d?.audio_tokens!==null||d?.reasoning_tokens!==null)&&(r.output_token_details={...d?.audio_tokens!==null&&{audio:d?.audio_tokens},...d?.reasoning_tokens!==null&&{reasoning:d?.reasoning_tokens}});let h=[];for(let p of s?.choices??[]){let f={text:p.message?.content??"",message:zj(p.message??{role:"assistant"},s,this.__includeRawResponse)};f.generationInfo={...p.finish_reason?{finish_reason:p.finish_reason}:{},...p.logprobs?{logprobs:p.logprobs}:{}},fo(f.message)&&(f.message.usage_metadata=r),f.message=new Oi(Object.fromEntries(Object.entries(f.message).filter(([m])=>!m.startsWith("lc_")))),h.push(f)}return{generations:h,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,a){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&a!=="auto"){let i=Uj(t);r+=await this.getNumTokens(i),r+=9}return t&&e.find(i=>i._getType()==="system")&&(r-=4),a==="none"?r+=1:typeof a=="object"&&(r+=await this.getNumTokens(a.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>t.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)))).reduce((t,a)=>t+a,0)}async getNumTokensFromMessages(e){let t=0,a=0,r=0;this.model==="gpt-3.5-turbo-0301"?(a=4,r=-1):(a=3,r=1);let i=await Promise.all(e.map(async n=>{let s=await this.getNumTokens(n.content),o=await this.getNumTokens(Aw(n)),l=n.name!==void 0?r+await this.getNumTokens(n.name):0,u=s+a+o+l,c=n;if(c._getType()==="function"&&(u-=2),c.additional_kwargs?.function_call&&(u+=3),c?.additional_kwargs.function_call?.name&&(u+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(c.additional_kwargs.function_call)),u+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){let a=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,a)}catch(r){throw xw(r)}})}async betaParsedCompletionWithRetry(e,t){let a=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,a)}catch(r){throw xw(r)}})}_getClientOptions(e){if(!this.client){let a={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},r=Rj(a),i={...this.clientConfig,baseURL:r,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ee(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,a)=>(a&&a.tokenUsage&&(t.tokenUsage.completionTokens+=a.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=a.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=a.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let a,r,i,n;qj(e)?(a=e.schema,r=e.name,i=e.method,n=e.includeRaw):(a=e,r=t?.name,i=t?.method,n=t?.includeRaw);let s,o;if(t?.strict!==void 0&&i==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(i==="jsonMode")s=this.bind({response_format:{type:"json_object"}}),Gl(a)?o=o_.fromZodSchema(a):o=new l_;else if(i==="jsonSchema")s=this.bind({response_format:{type:"json_schema",json_schema:{name:r??"extract",description:a.description,schema:a,strict:t?.strict}}}),Gl(a)?o=o_.fromZodSchema(a):o=new l_;else{let d=r??"extract";if(Gl(a)){let h=id(a);s=this.bind({tools:[{type:"function",function:{name:d,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new gw({returnSingle:!0,keyName:d,zodSchema:a})}else{let h;typeof a.name=="string"&&typeof a.parameters=="object"&&a.parameters!=null?(h=a,d=a.name):(d=a.title??d,h={name:d,description:a.description??"",parameters:a}),s=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new gw({returnSingle:!0,keyName:d})}}if(!n)return s.pipe(o);let l=zn.assign({parsed:(d,h)=>o.invoke(d.raw,h)}),u=zn.assign({parsed:()=>null}),c=l.withFallbacks({fallbacks:[u]});return Ma.from([{raw:s},c])}};function Gl(e){return typeof e?.parse=="function"}function qj(e){return e!==void 0&&typeof e.schema=="object"}var Vj=class extends hP{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??We("OPENAI_API_KEY"),a=e?.organization??We("OPENAI_ORGANIZATION"),r={apiKey:t,organization:a,dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new ee(r),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(a=>a.url?{type:"image_url",image_url:a.url}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="string"&&a.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(a=>a.b64_json?{type:"image_url",image_url:{url:a.b64_json}}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="object"&&"url"in a.image_url&&typeof a.image_url.url=="string"&&a.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let i=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(i)}let a=await this.client.images.generate(t),r="";return this.dallEResponseFormat==="url"?[r]=a.data.map(i=>i.url).filter(i=>i!=="undefined"):[r]=a.data.map(i=>i.b64_json).filter(i=>i!=="undefined"),r}};Object.defineProperty(Vj,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Ra();var wa={ANALYSIS_MODEL:"x-ai/grok-4-fast",QUALITY_MODEL:"x-ai/grok-4-fast",MIN_QUALITY_SCORE:90,MAX_ITERATIONS:2},Gr=gi({summary:Ft().describe("A comprehensive summary of the video content (150-400 words)"),takeaways:Ms(Ft()).min(3).max(8).describe("Key insights and actionable takeaways for the audience"),key_facts:Ms(Ft()).min(3).max(6).describe("Important facts, statistics, or data points mentioned")}),gs=gi({rate:vu(["Fail","Refine","Pass"]).describe("Score for the quality aspect (Fail=poor, Refine=adequate, Pass=excellent)"),reason:Ft().describe("Reason for the score")}),Jl=gi({completeness:gs.describe("Rate for completeness: The entire transcript has been considered"),accuracy:gs.describe("Rate for accuracy: Content directly supported by transcript (no external additions)"),structure:gs.describe("Rate for structure: Summary, takeaways, and key_facts are properly formatted"),grammar:gs.describe("Rate for grammar: No typos, grammatical mistakes, appropriate wordings"),no_garbage:gs.describe("Rate for no_garbage: The promotional and meaningless content are removed")});function ys(e){let t=e;for(;t&&t._def&&t._def.typeName==="ZodEffects";)t=t._def.innerType;return t}function Iw(e){if(!e||!e._def)return null;let t=e._def;return t.typeName==="ZodEffects"&&t.effect&&t.effect.type==="describe"?t.effect.description:t.description||null}function ip(e){function t(n,s){if(!n||!n._def)return"Any";let o=ys(n)._def;return o.typeName==="ZodString"?"str":o.typeName==="ZodNumber"?"float":o.typeName==="ZodBoolean"?"bool":o.typeName==="ZodArray"?`list[${t(o.type,s)}]`:o.typeName==="ZodObject"?"dict":o.typeName==="ZodEnum"?`Literal[${o.values.map(l=>`"${l}"`).join(", ")}]`:o.typeName==="ZodOptional"||o.typeName==="ZodDefault"?t(o.innerType,s):"Any"}function a(n){if(!n||!n._def)return"";let s=ys(n)._def,o=[];return s.typeName==="ZodArray"&&(s.minLength&&o.push(`minItems=${s.minLength.value}`),s.maxLength&&o.push(`maxItems=${s.maxLength.value}`)),o.length>0?`(${o.join(", ")})`:""}function r(n,s={},o=""){let l=[],u=ys(n);if(!u._def||u._def.typeName!=="ZodObject")return{lines:l,refs:new Set};let c=u._def.shape;if(!c)return{lines:l,refs:new Set};let d=c();for(let[h,p]of Object.entries(d)){let f=ys(p),m=f._def,g=Iw(p),b=a(p),y=[];if(m.typeName==="ZodObject"){let _=`${o}${h}: dict`;g&&(_+=` = ${g}`),y.push(_);let w=r(f,s,o+"  ");y=y.concat(w.lines)}else{let _=t(p,s),w=`${o}${h}: ${_}`;b&&(w+=` ${b}`),g&&(w+=` = ${g}`),y.push(w)}l=l.concat(y)}return{lines:l,refs:new Set}}let{lines:i}=r(e);return i.join(`
`)}var Kl=class Yr{static _extractFieldInfo(t){let a={};if(t._def&&t._def.shape){let r=t._def.shape();for(let[i,n]of Object.entries(r)){let s=ys(n)._def;a[i]={description:Iw(n)||"",type:s.typeName,min_length:s.typeName==="ZodArray"&&s.minLength?s.minLength.value:void 0,max_length:s.typeName==="ZodArray"&&s.maxLength?s.maxLength.value:void 0,required:!0}}}return a}static _buildLengthSummary(t){let a=[];for(let[r,i]of Object.entries(t)){let n=r.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),s=i.min_length,o=i.max_length;if(r==="summary"){let l=i.description||"";l.includes("150-400 words")||l.includes("(150-400 words)")?a.push("Summary (150-400 words)"):a.push("Summary")}else s!==void 0&&o!==void 0&&a.push(`${n} (${s}-${o} items)`)}return a.join(", ")}static _buildLengthGuidelines(t){let a=[];for(let[r,i]of Object.entries(t)){let n=r.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),s=i.min_length,o=i.max_length;if(r==="summary"){let l=i.description||"";l.includes("150-400 words")||l.includes("(150-400 words)")?a.push("- Summary: 150-400 words"):a.push("- Summary: As specified in description")}else s!==void 0&&o!==void 0&&a.push(`- ${n}: ${s}-${o} items`)}return a}static buildAnalysisPrompt(){let t=ip(Gr),a=Yr._extractFieldInfo(Gr),r=[];for(let[i,n]of Object.entries(a)){if(!n.description)continue;let s=`- ${i.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase())}: ${n.description}`,o=n.min_length,l=n.max_length;o!==void 0&&l!==void 0&&(s+=` (${o}-${l} items)`),r.push(s)}return["Create a comprehensive analysis that strictly follows the transcript content.","","OUTPUT SCHEMA:",t,"","FIELD REQUIREMENTS:",r.join(`
`),"","CORE REQUIREMENTS:","- ACCURACY: Every claim must be directly supported by the transcript","- TONE: Write in objective, article-like style (avoid 'This video...', 'The speaker...')","- AVOID META-DESCRIPTIVE LANGUAGE: Do not use phrases like 'This analysis explores', etc. Write direct, factual content only","","CONTENT FILTERING:","- Remove all promotional content (speaker intros, calls-to-action, self-promotion)","- Keep only educational content","- Correct obvious typos naturally","","QUALITY CHECKS:","- Content matches transcript exactly (no external additions)","- All promotional content removed","- Typos corrected naturally, meaning preserved",`- Length balanced: ${Yr._buildLengthSummary(a)}`].join(`
`)}static buildQualityPrompt(){let t=ip(Jl),a=Yr._extractFieldInfo(Jl),r=[],i=1;for(let[o,l]of Object.entries(a)){let u=o.toUpperCase().replace(/_/g," "),c=l.description||"",d=c.includes(":")?c.split(":",2)[1].trim():c;r.push(`${i}. ${u}: ${d}`),i++}let n=Yr._extractFieldInfo(Gr),s=Yr._buildLengthGuidelines(n);return["Evaluate the analysis on the following aspects. Rate each 'Fail', 'Refine', or 'Pass' with a specific reason.","","ASPECTS:",r.join(`
`),"","LENGTH GUIDELINES:",s.join(`
`),"","QUALITY STANDARDS:","- Transcript-based content only","- Professional article-like tone","","Provide specific rates and reasons for each aspect.","","OUTPUT SCHEMA:",t].join(`
`)}static buildImprovementPrompt(){let t=ip(Gr),a=Yr._extractFieldInfo(Gr),r=[];for(let[i,n]of Object.entries(a)){if(!n.description)continue;let s=`- ${i.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase())}: ${n.description}`,o=n.min_length,l=n.max_length;o!==void 0&&l!==void 0&&(s+=` (${o}-${l} items)`),r.push(s)}return["Improve the analysis based on quality feedback while maintaining transcript accuracy.","","IMPROVEMENT PRIORITIES:","1. TRANSCRIPT ACCURACY: All content must be transcript-supported","2. PROMOTIONAL REMOVAL: Remove all intros, calls-to-action, self-promotion","3. WRITING STYLE: Use objective, article-like tone","4. AVOID META-DESCRIPTIVE LANGUAGE: Remove phrases like 'This analysis explores', etc.","5. TYPO CORRECTION: Fix obvious typos naturally","6. ARRAY FORMATTING: Return takeaways/key_facts as simple string arrays","","CONTENT TARGETS:",r.join(`
`),"","OUTPUT SCHEMA:",t].join(`
`)}},Yi=class ou{static calculateScore(t){let a={Fail:0,Refine:1,Pass:2},r=[t.completeness,t.accuracy,t.structure,t.grammar,t.no_garbage],i=r.reduce((s,o)=>s+a[o.rate],0),n=r.length*2;return Math.round(i/n*100)}static isAcceptable(t){return ou.calculateScore(t)>=wa.MIN_QUALITY_SCORE}static printQualityBreakdown(t){let a=ou.calculateScore(t);console.log("\u{1F4C8} Quality breakdown:"),console.log(`Completeness: ${t.completeness.rate} - ${t.completeness.reason}`),console.log(`Accuracy: ${t.accuracy.rate} - ${t.accuracy.reason}`),console.log(`Structure: ${t.structure.rate} - ${t.structure.reason}`),console.log(`Grammar: ${t.grammar.rate} - ${t.grammar.reason}`),console.log(`No Garbage: ${t.no_garbage.rate} - ${t.no_garbage.reason}`),console.log(`Total Score: ${a}%`),ou.isAcceptable(t)||console.log(`\u26A0\uFE0F  Quality below threshold (${wa.MIN_QUALITY_SCORE}%), refinement needed`)}},Wj=gi({transcript:Ft(),analysis_model:Ft().default(wa.ANALYSIS_MODEL),quality_model:Ft().default(wa.QUALITY_MODEL),analysis:Gr.nullable().default(null),quality:Jl.nullable().default(null),iteration_count:Rs().default(0),is_complete:Ls().default(!1),apiKey:Ft().optional(),progressCallback:_u().optional()});function $w(e,t){let a=typeof chrome<"u"&&chrome.runtime?chrome.runtime.getURL(""):"https://github.com/better-youtube-caption";return new Zj({model:e,apiKey:t,configuration:{baseURL:"https://openrouter.ai/api/v1",defaultHeaders:{"HTTP-Referer":a,"X-Title":"Better YouTube Caption"}},temperature:0})}async function Hj(e){let t=e.apiKey,a=e.progressCallback;a&&(e.quality&&e.analysis?a("\u{1F527} Refining analysis based on quality feedback..."):a(`\u{1F4DD} Generating initial analysis. Transcript length: ${e.transcript.length} characters`));let r=$w(e.analysis_model,t).withStructuredOutput(Gr,{method:"jsonMode"}),i,n;if(e.quality&&e.analysis){let s=`# Improve this video analysis based on the following feedback:
## Analysis:
${JSON.stringify(e.analysis,null,2)}
## Quality Assessment:
${JSON.stringify(e.quality,null,2)}
Please provide an improved version that addresses the specific issues identified above to improve the overall quality score.`,o=Kl.buildImprovementPrompt(),l=`${`Original Transcript:
${e.transcript}`}

${s}`;i=Wo.fromMessages([["system",o],["human","{improvement_prompt}"]]);try{let u=await i.pipe(r).invoke({improvement_prompt:l});return a&&a("\u2728 Analysis refined successfully"),{analysis:u,iteration_count:e.iteration_count+1}}catch(u){throw console.error("Refinement failed:",u),a&&a(`Error in refinement: ${u.message}`),new Error(`Analysis refinement failed: ${u.message}`)}}else{let s=Kl.buildAnalysisPrompt();i=Wo.fromMessages([["system",s],["human","{content}"]]);try{let o=await i.pipe(r).invoke({content:e.transcript});return a&&a("\u{1F4CA} Analysis completed"),{analysis:o,iteration_count:e.iteration_count+1}}catch(o){throw console.error("Generation failed:",o),a&&a(`Error in generation: ${o.message}`),new Error(`Analysis generation failed: ${o.message}`)}}}async function Gj(e){let t=e.apiKey,a=e.progressCallback;a&&(a("\u{1F50D} Performing quality check..."),a(`\u{1F50D} Using model: ${e.quality_model}`));let r=$w(e.quality_model,t).withStructuredOutput(Jl,{method:"jsonMode"});try{let i=Kl.buildQualityPrompt(),n=JSON.stringify(e.analysis,null,2),s=await Wo.fromMessages([["system",i],["human","{analysis_text}"]]).pipe(r).invoke({analysis_text:n});Yi.printQualityBreakdown(s);let o=Yi.calculateScore(s)>=wa.MIN_QUALITY_SCORE||e.iteration_count>=wa.MAX_ITERATIONS;return{quality:s,is_complete:o}}catch(i){throw console.error("Quality check failed:",i),a&&a(`Error in quality check: ${i.message}`),new Error(`Quality node failed: ${i.message}`)}}function Jj(e){if(e.is_complete)return console.log("\u{1F504} Workflow complete (is_complete=True)"),se;let t=e.quality?Yi.calculateScore(e.quality):0;return e.quality&&!Yi.isAcceptable(e.quality)&&e.iteration_count<wa.MAX_ITERATIONS?(console.log(`\u{1F504} Quality ${t}% below threshold ${wa.MIN_QUALITY_SCORE}%, refining (iteration ${e.iteration_count+1})`),"analysisNode"):(console.log(`\u{1F504} Workflow ending (quality: ${t}%, iterations: ${e.iteration_count})`),se)}function Kj(){return new vA(Wj).addNode("analysisNode",Hj).addNode("qualityNode",Gj).addEdge(_e,"analysisNode").addEdge("analysisNode","qualityNode").addConditionalEdges("qualityNode",Jj,{analysisNode:"analysisNode",[se]:se}).compile()}async function Tw(e,t,a){let r=Kj(),i={transcript:e.transcript,analysis_model:e.analysis_model||wa.ANALYSIS_MODEL,quality_model:e.quality_model||wa.QUALITY_MODEL,analysis:null,quality:null,iteration_count:0,is_complete:!1,apiKey:t,progressCallback:a},n=await r.invoke(i),s=n.quality?Yi.calculateScore(n.quality):0,o=Xj(n.analysis);return{analysis:n.analysis,quality:n.quality,iteration_count:n.iteration_count,quality_score:s,summary_text:o}}function Xj(e){let t=[];return t.push("## Summary"),t.push(""),t.push(e.summary),t.push(""),e.takeaways&&e.takeaways.length>0&&(t.push("## Key Takeaways"),t.push(""),e.takeaways.forEach(a=>{t.push(`- ${a}`)}),t.push("")),e.key_facts&&e.key_facts.length>0&&(t.push("## Key Facts"),t.push(""),e.key_facts.forEach(a=>{t.push(`- ${a}`)}),t.push("")),t.join(`
`)}typeof globalThis<"u"&&(globalThis.executeSummarizationWorkflow=Tw,globalThis.SummaryWorkflow={executeSummarizationWorkflow:Tw,PromptBuilder:Kl,QualityUtils:Yi})})();})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

mustache/mustache.mjs:
  (*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/js-sha256/hash.js:
  (**
   * [js-sha256]{@link https://github.com/emn178/js-sha256}
   *
   * @version 0.11.1
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2025
   * @license MIT
   *)
*/
//# sourceMappingURL=captionSummarizer.bundle.js.map
