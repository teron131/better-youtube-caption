(()=>{(()=>{var Vh=Object.create,Yr=Object.defineProperty,Xh=Object.getOwnPropertyDescriptor,Yh=Object.getOwnPropertyNames,Qh=Object.getPrototypeOf,ep=Object.prototype.hasOwnProperty,tp=(e,t,a)=>t in e?Yr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,M=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),pl=(e,t)=>{for(var a in t)Yr(e,a,{get:t[a],enumerable:!0})},ap=(e,t,a,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Yh(t))!ep.call(e,n)&&n!==a&&Yr(e,n,{get:()=>t[n],enumerable:!(r=Xh(t,n))||r.enumerable});return e},rt=(e,t,a)=>(a=e!=null?Vh(Qh(e)):{},ap(t||!e||!e.__esModule?Yr(a,"default",{value:e,enumerable:!0}):a,e)),oa=(e,t,a)=>tp(e,typeof t!="symbol"?t+"":t,a),rp=M((e,t)=>{"use strict";t.exports=function(a,r){if(typeof a!="string")throw new TypeError("Expected a string");return r=typeof r>"u"?"_":r,a.replace(/([a-z\d])([A-Z])/g,"$1"+r+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+r+"$2").toLowerCase()}}),np=M((e,t)=>{"use strict";var a=/[\p{Lu}]/u,r=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,o=new RegExp("^"+s.source),l=new RegExp(s.source+i.source,"gu"),u=new RegExp("\\d+"+i.source,"gu"),c=(f,m,g)=>{let _=!1,y=!1,b=!1;for(let w=0;w<f.length;w++){let O=f[w];_&&a.test(O)?(f=f.slice(0,w)+"-"+f.slice(w),_=!1,b=y,y=!0,w++):y&&b&&r.test(O)?(f=f.slice(0,w-1)+"-"+f.slice(w-1),b=y,y=!1,_=!0):(_=m(O)===O&&g(O)!==O,b=y,y=g(O)===O&&m(O)!==O)}return f},d=(f,m)=>(n.lastIndex=0,f.replace(n,g=>m(g))),h=(f,m)=>(l.lastIndex=0,u.lastIndex=0,f.replace(l,(g,_)=>m(_)).replace(u,g=>m(g))),p=(f,m)=>{if(!(typeof f=="string"||Array.isArray(f)))throw new TypeError("Expected the input to be `string | string[]`");if(m={pascalCase:!1,preserveConsecutiveUppercase:!1,...m},Array.isArray(f)?f=f.map(y=>y.trim()).filter(y=>y.length).join("-"):f=f.trim(),f.length===0)return"";let g=m.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(m.locale),_=m.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(m.locale);return f.length===1?m.pascalCase?_(f):g(f):(f!==g(f)&&(f=c(f,g,_)),f=f.replace(o,""),m.preserveConsecutiveUppercase?f=d(f,g):f=g(f),m.pascalCase&&(f=_(f.charAt(0))+f.slice(1)),h(f,_))};t.exports=p,t.exports.default=p}),ip=M((e,t)=>{function a(r,n){typeof n=="boolean"&&(n={forever:n}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=n||{},this._maxRetryTime=n&&n.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}t.exports=a,a.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},a.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},a.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var n=new Date().getTime();if(r&&n-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var i=this._timeouts.shift();if(i===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),i=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},i),this._options.unref&&this._timer.unref(),!0},a.prototype.attempt=function(r,n){this._fn=r,n&&(n.timeout&&(this._operationTimeout=n.timeout),n.cb&&(this._operationTimeoutCb=n.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){i._operationTimeoutCb()},i._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},a.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)},a.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)},a.prototype.start=a.prototype.try,a.prototype.errors=function(){return this._errors},a.prototype.attempts=function(){return this._attempts},a.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},n=null,i=0,s=0;s<this._errors.length;s++){var o=this._errors[s],l=o.message,u=(r[l]||0)+1;r[l]=u,u>=i&&(n=o,i=u)}return n}}),sp=M(e=>{var t=ip();e.operation=function(a){var r=e.timeouts(a);return new t(r,{forever:a&&(a.forever||a.retries===1/0),unref:a&&a.unref,maxRetryTime:a&&a.maxRetryTime})},e.timeouts=function(a){if(a instanceof Array)return[].concat(a);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in a)r[n]=a[n];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],s=0;s<r.retries;s++)i.push(this.createTimeout(s,r));return a&&a.forever&&!i.length&&i.push(this.createTimeout(s,r)),i.sort(function(o,l){return o-l}),i},e.createTimeout=function(a,r){var n=r.randomize?Math.random()+1:1,i=Math.round(n*Math.max(r.minTimeout,1)*Math.pow(r.factor,a));return i=Math.min(i,r.maxTimeout),i},e.wrap=function(a,r,n){if(r instanceof Array&&(n=r,r=null),!n){n=[];for(var i in a)typeof a[i]=="function"&&n.push(i)}for(var s=0;s<n.length;s++){var o=n[s],l=a[o];a[o]=function(u){var c=e.operation(r),d=Array.prototype.slice.call(arguments,1),h=d.pop();d.push(function(p){c.retry(p)||(p&&(arguments[0]=c.mainError()),h.apply(this,arguments))}),c.attempt(function(){u.apply(a,d)})}.bind(a,l),a[o].options=r}}}),op=M((e,t)=>{t.exports=sp()}),Mi=M((e,t)=>{"use strict";var a=op(),r=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],n=class extends Error{constructor(l){super(),l instanceof Error?(this.originalError=l,{message:l}=l):(this.originalError=new Error(l),this.originalError.stack=this.stack),this.name="AbortError",this.message=l}},i=(l,u,c)=>{let d=c.retries-(u-1);return l.attemptNumber=u,l.retriesLeft=d,l},s=l=>r.includes(l),o=(l,u)=>new Promise((c,d)=>{u={onFailedAttempt:()=>{},retries:10,...u};let h=a.operation(u);h.attempt(async p=>{try{c(await l(p))}catch(f){if(!(f instanceof Error)){d(new TypeError(`Non-error was thrown: "${f}". You should only throw errors.`));return}if(f instanceof n)h.stop(),d(f.originalError);else if(f instanceof TypeError&&!s(f.message))h.stop(),d(f);else{i(f,p,u);try{await u.onFailedAttempt(f)}catch(m){d(m);return}h.retry(f)||d(h.mainError())}}})});t.exports=o,t.exports.default=o,t.exports.AbortError=n}),lp=M((e,t)=>{"use strict";var a=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function i(u,c,d){this.fn=u,this.context=c,this.once=d||!1}function s(u,c,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var f=new i(d,h||u,p),m=r?r+c:c;return u._events[m]?u._events[m].fn?u._events[m]=[u._events[m],f]:u._events[m].push(f):(u._events[m]=f,u._eventsCount++),u}function o(u,c){--u._eventsCount===0?u._events=new n:delete u._events[c]}function l(){this._events=new n,this._eventsCount=0}l.prototype.eventNames=function(){var u=[],c,d;if(this._eventsCount===0)return u;for(d in c=this._events)a.call(c,d)&&u.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(c)):u},l.prototype.listeners=function(u){var c=r?r+u:u,d=this._events[c];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,p=d.length,f=new Array(p);h<p;h++)f[h]=d[h].fn;return f},l.prototype.listenerCount=function(u){var c=r?r+u:u,d=this._events[c];return d?d.fn?1:d.length:0},l.prototype.emit=function(u,c,d,h,p,f){var m=r?r+u:u;if(!this._events[m])return!1;var g=this._events[m],_=arguments.length,y,b;if(g.fn){switch(g.once&&this.removeListener(u,g.fn,void 0,!0),_){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,c),!0;case 3:return g.fn.call(g.context,c,d),!0;case 4:return g.fn.call(g.context,c,d,h),!0;case 5:return g.fn.call(g.context,c,d,h,p),!0;case 6:return g.fn.call(g.context,c,d,h,p,f),!0}for(b=1,y=new Array(_-1);b<_;b++)y[b-1]=arguments[b];g.fn.apply(g.context,y)}else{var w=g.length,O;for(b=0;b<w;b++)switch(g[b].once&&this.removeListener(u,g[b].fn,void 0,!0),_){case 1:g[b].fn.call(g[b].context);break;case 2:g[b].fn.call(g[b].context,c);break;case 3:g[b].fn.call(g[b].context,c,d);break;case 4:g[b].fn.call(g[b].context,c,d,h);break;default:if(!y)for(O=1,y=new Array(_-1);O<_;O++)y[O-1]=arguments[O];g[b].fn.apply(g[b].context,y)}}return!0},l.prototype.on=function(u,c,d){return s(this,u,c,d,!1)},l.prototype.once=function(u,c,d){return s(this,u,c,d,!0)},l.prototype.removeListener=function(u,c,d,h){var p=r?r+u:u;if(!this._events[p])return this;if(!c)return o(this,p),this;var f=this._events[p];if(f.fn)f.fn===c&&(!h||f.once)&&(!d||f.context===d)&&o(this,p);else{for(var m=0,g=[],_=f.length;m<_;m++)(f[m].fn!==c||h&&!f[m].once||d&&f[m].context!==d)&&g.push(f[m]);g.length?this._events[p]=g.length===1?g[0]:g:o(this,p)}return this},l.prototype.removeAllListeners=function(u){var c;return u?(c=r?r+u:u,this._events[c]&&o(this,c)):(this._events=new n,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=r,l.EventEmitter=l,typeof t<"u"&&(t.exports=l)}),up=M((e,t)=>{"use strict";t.exports=(a,r)=>(r=r||(()=>{}),a.then(n=>new Promise(i=>{i(r())}).then(()=>n),n=>new Promise(i=>{i(r())}).then(()=>{throw n})))}),cp=M((e,t)=>{"use strict";var a=up(),r=class extends Error{constructor(i){super(i),this.name="TimeoutError"}},n=(i,s,o)=>new Promise((l,u)=>{if(typeof s!="number"||s<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(s===1/0){l(i);return}let c=setTimeout(()=>{if(typeof o=="function"){try{l(o())}catch(p){u(p)}return}let d=typeof o=="string"?o:`Promise timed out after ${s} milliseconds`,h=o instanceof Error?o:new r(d);typeof i.cancel=="function"&&i.cancel(),u(h)},s);a(i.then(l,u),()=>{clearTimeout(c)})});t.exports=n,t.exports.default=n,t.exports.TimeoutError=r}),dp=M(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});function t(a,r,n){let i=0,s=a.length;for(;s>0;){let o=s/2|0,l=i+o;n(a[l],r)<=0?(i=++l,s-=o+1):s=o}return i}e.default=t}),hp=M(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=dp(),a=class{constructor(){this._queue=[]}enqueue(r,n){n=Object.assign({priority:0},n);let i={priority:n.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=n.priority){this._queue.push(i);return}let s=t.default(this._queue,i,(o,l)=>l.priority-o.priority);this._queue.splice(s,0,i)}dequeue(){return this._queue.shift()?.run}filter(r){return this._queue.filter(n=>n.priority===r.priority).map(n=>n.run)}get size(){return this._queue.length}};e.default=a}),Ui=M(e=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=lp(),a=cp(),r=hp(),n=()=>{},i=new a.TimeoutError,s=class extends t{constructor(o){var l,u,c,d;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=n,this._resolveIdle=n,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:r.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(u=(l=o.intervalCap)===null||l===void 0?void 0:l.toString())!==null&&u!==void 0?u:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(d=(c=o.interval)===null||c===void 0?void 0:c.toString())!==null&&d!==void 0?d:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=n,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=n,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let o=Date.now();if(this._intervalId===void 0){let l=this._intervalEnd-o;if(l<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},l)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let l=this._queue.dequeue();return l?(this.emit("active"),l(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,l={}){return new Promise((u,c)=>{let d=async()=>{this._pendingCount++,this._intervalCount++;try{let h=this._timeout===void 0&&l.timeout===void 0?o():a.default(Promise.resolve(o()),l.timeout===void 0?this._timeout:l.timeout,()=>{(l.throwOnTimeout===void 0?this._throwOnTimeout:l.throwOnTimeout)&&c(i)});u(await h)}catch(h){c(h)}this._next()};this._queue.enqueue(d,l),this._tryToStartAnother(),this.emit("add")})}async addAll(o,l){return Promise.all(o.map(async u=>this.add(u,l)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{let l=this._resolveEmpty;this._resolveEmpty=()=>{l(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{let l=this._resolveIdle;this._resolveIdle=()=>{l(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}};e.default=s}),Qr=M((e,t)=>{"use strict";var a="2.0.0",r=Number.MAX_SAFE_INTEGER||9007199254740991,n=16,i=250,s=["major","premajor","minor","preminor","patch","prepatch","prerelease"];t.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:i,MAX_SAFE_INTEGER:r,RELEASE_TYPES:s,SEMVER_SPEC_VERSION:a,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}}),en=M((e,t)=>{"use strict";var a=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};t.exports=a}),Ka=M((e,t)=>{"use strict";var{MAX_SAFE_COMPONENT_LENGTH:a,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:n}=Qr(),i=en();e=t.exports={};var s=e.re=[],o=e.safeRe=[],l=e.src=[],u=e.safeSrc=[],c=e.t={},d=0,h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",n],[h,r]],f=g=>{for(let[_,y]of p)g=g.split(`${_}*`).join(`${_}{0,${y}}`).split(`${_}+`).join(`${_}{1,${y}}`);return g},m=(g,_,y)=>{let b=f(_),w=d++;i(g,w,_),c[g]=w,l[w]=_,u[w]=b,s[w]=new RegExp(_,y?"g":void 0),o[w]=new RegExp(b,y?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),m("MAINVERSION",`(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${l[c.NONNUMERICIDENTIFIER]}|${l[c.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${l[c.NONNUMERICIDENTIFIER]}|${l[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${l[c.PRERELEASEIDENTIFIER]}(?:\\.${l[c.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${l[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[c.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${h}+`),m("BUILD",`(?:\\+(${l[c.BUILDIDENTIFIER]}(?:\\.${l[c.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${l[c.MAINVERSION]}${l[c.PRERELEASE]}?${l[c.BUILD]}?`),m("FULL",`^${l[c.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${l[c.MAINVERSIONLOOSE]}${l[c.PRERELEASELOOSE]}?${l[c.BUILD]}?`),m("LOOSE",`^${l[c.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${l[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${l[c.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:${l[c.PRERELEASE]})?${l[c.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:${l[c.PRERELEASELOOSE]})?${l[c.BUILD]}?)?)?`),m("XRANGE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${a}})(?:\\.(\\d{1,${a}}))?(?:\\.(\\d{1,${a}}))?`),m("COERCE",`${l[c.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",l[c.COERCEPLAIN]+`(?:${l[c.PRERELEASE]})?(?:${l[c.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",l[c.COERCE],!0),m("COERCERTLFULL",l[c.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${l[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${l[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${l[c.LONECARET]}${l[c.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${l[c.LONECARET]}${l[c.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${l[c.GTLT]}\\s*(${l[c.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]}|${l[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${l[c.XRANGEPLAIN]})\\s+-\\s+(${l[c.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${l[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[c.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}),zi=M((e,t)=>{"use strict";var a=Object.freeze({loose:!0}),r=Object.freeze({}),n=i=>i?typeof i!="object"?a:i:r;t.exports=n}),fl=M((e,t)=>{"use strict";var a=/^[0-9]+$/,r=(i,s)=>{if(typeof i=="number"&&typeof s=="number")return i===s?0:i<s?-1:1;let o=a.test(i),l=a.test(s);return o&&l&&(i=+i,s=+s),i===s?0:o&&!l?-1:l&&!o?1:i<s?-1:1},n=(i,s)=>r(s,i);t.exports={compareIdentifiers:r,rcompareIdentifiers:n}}),Le=M((e,t)=>{"use strict";var a=en(),{MAX_LENGTH:r,MAX_SAFE_INTEGER:n}=Qr(),{safeRe:i,t:s}=Ka(),o=zi(),{compareIdentifiers:l}=fl(),u=class Nt{constructor(d,h){if(h=o(h),d instanceof Nt){if(d.loose===!!h.loose&&d.includePrerelease===!!h.includePrerelease)return d;d=d.version}else if(typeof d!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof d}".`);if(d.length>r)throw new TypeError(`version is longer than ${r} characters`);a("SemVer",d,h),this.options=h,this.loose=!!h.loose,this.includePrerelease=!!h.includePrerelease;let p=d.trim().match(h.loose?i[s.LOOSE]:i[s.FULL]);if(!p)throw new TypeError(`Invalid Version: ${d}`);if(this.raw=d,this.major=+p[1],this.minor=+p[2],this.patch=+p[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");p[4]?this.prerelease=p[4].split(".").map(f=>{if(/^[0-9]+$/.test(f)){let m=+f;if(m>=0&&m<n)return m}return f}):this.prerelease=[],this.build=p[5]?p[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(d){if(a("SemVer.compare",this.version,this.options,d),!(d instanceof Nt)){if(typeof d=="string"&&d===this.version)return 0;d=new Nt(d,this.options)}return d.version===this.version?0:this.compareMain(d)||this.comparePre(d)}compareMain(d){return d instanceof Nt||(d=new Nt(d,this.options)),this.major<d.major?-1:this.major>d.major?1:this.minor<d.minor?-1:this.minor>d.minor?1:this.patch<d.patch?-1:this.patch>d.patch?1:0}comparePre(d){if(d instanceof Nt||(d=new Nt(d,this.options)),this.prerelease.length&&!d.prerelease.length)return-1;if(!this.prerelease.length&&d.prerelease.length)return 1;if(!this.prerelease.length&&!d.prerelease.length)return 0;let h=0;do{let p=this.prerelease[h],f=d.prerelease[h];if(a("prerelease compare",h,p,f),p===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(p===void 0)return-1;if(p!==f)return l(p,f)}while(++h)}compareBuild(d){d instanceof Nt||(d=new Nt(d,this.options));let h=0;do{let p=this.build[h],f=d.build[h];if(a("build compare",h,p,f),p===void 0&&f===void 0)return 0;if(f===void 0)return 1;if(p===void 0)return-1;if(p!==f)return l(p,f)}while(++h)}inc(d,h,p){if(d.startsWith("pre")){if(!h&&p===!1)throw new Error("invalid increment argument: identifier is empty");if(h){let f=`-${h}`.match(this.options.loose?i[s.PRERELEASELOOSE]:i[s.PRERELEASE]);if(!f||f[1]!==h)throw new Error(`invalid identifier: ${h}`)}}switch(d){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",h,p);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",h,p);break;case"prepatch":this.prerelease.length=0,this.inc("patch",h,p),this.inc("pre",h,p);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",h,p),this.inc("pre",h,p);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let f=Number(p)?1:0;if(this.prerelease.length===0)this.prerelease=[f];else{let m=this.prerelease.length;for(;--m>=0;)typeof this.prerelease[m]=="number"&&(this.prerelease[m]++,m=-2);if(m===-1){if(h===this.prerelease.join(".")&&p===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(f)}}if(h){let m=[h,f];p===!1&&(m=[h]),l(this.prerelease[0],h)===0?isNaN(this.prerelease[1])&&(this.prerelease=m):this.prerelease=m}break}default:throw new Error(`invalid increment argument: ${d}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};t.exports=u}),Ea=M((e,t)=>{"use strict";var a=Le(),r=(n,i,s=!1)=>{if(n instanceof a)return n;try{return new a(n,i)}catch(o){if(!s)return null;throw o}};t.exports=r}),pp=M((e,t)=>{"use strict";var a=Ea(),r=(n,i)=>{let s=a(n,i);return s?s.version:null};t.exports=r}),fp=M((e,t)=>{"use strict";var a=Ea(),r=(n,i)=>{let s=a(n.trim().replace(/^[=v]+/,""),i);return s?s.version:null};t.exports=r}),mp=M((e,t)=>{"use strict";var a=Le(),r=(n,i,s,o,l)=>{typeof s=="string"&&(l=o,o=s,s=void 0);try{return new a(n instanceof a?n.version:n,s).inc(i,o,l).version}catch{return null}};t.exports=r}),gp=M((e,t)=>{"use strict";var a=Ea(),r=(n,i)=>{let s=a(n,null,!0),o=a(i,null,!0),l=s.compare(o);if(l===0)return null;let u=l>0,c=u?s:o,d=u?o:s,h=!!c.prerelease.length;if(d.prerelease.length&&!h){if(!d.patch&&!d.minor)return"major";if(d.compareMain(c)===0)return d.minor&&!d.patch?"minor":"patch"}let p=h?"pre":"";return s.major!==o.major?p+"major":s.minor!==o.minor?p+"minor":s.patch!==o.patch?p+"patch":"prerelease"};t.exports=r}),yp=M((e,t)=>{"use strict";var a=Le(),r=(n,i)=>new a(n,i).major;t.exports=r}),_p=M((e,t)=>{"use strict";var a=Le(),r=(n,i)=>new a(n,i).minor;t.exports=r}),bp=M((e,t)=>{"use strict";var a=Le(),r=(n,i)=>new a(n,i).patch;t.exports=r}),vp=M((e,t)=>{"use strict";var a=Ea(),r=(n,i)=>{let s=a(n,i);return s&&s.prerelease.length?s.prerelease:null};t.exports=r}),nt=M((e,t)=>{"use strict";var a=Le(),r=(n,i,s)=>new a(n,s).compare(new a(i,s));t.exports=r}),wp=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(i,n,s);t.exports=r}),Op=M((e,t)=>{"use strict";var a=nt(),r=(n,i)=>a(n,i,!0);t.exports=r}),Di=M((e,t)=>{"use strict";var a=Le(),r=(n,i,s)=>{let o=new a(n,s),l=new a(i,s);return o.compare(l)||o.compareBuild(l)};t.exports=r}),Ep=M((e,t)=>{"use strict";var a=Di(),r=(n,i)=>n.sort((s,o)=>a(s,o,i));t.exports=r}),kp=M((e,t)=>{"use strict";var a=Di(),r=(n,i)=>n.sort((s,o)=>a(o,s,i));t.exports=r}),tn=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)>0;t.exports=r}),Fi=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)<0;t.exports=r}),ml=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)===0;t.exports=r}),gl=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)!==0;t.exports=r}),Bi=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)>=0;t.exports=r}),Zi=M((e,t)=>{"use strict";var a=nt(),r=(n,i,s)=>a(n,i,s)<=0;t.exports=r}),yl=M((e,t)=>{"use strict";var a=ml(),r=gl(),n=tn(),i=Bi(),s=Fi(),o=Zi(),l=(u,c,d,h)=>{switch(c){case"===":return typeof u=="object"&&(u=u.version),typeof d=="object"&&(d=d.version),u===d;case"!==":return typeof u=="object"&&(u=u.version),typeof d=="object"&&(d=d.version),u!==d;case"":case"=":case"==":return a(u,d,h);case"!=":return r(u,d,h);case">":return n(u,d,h);case">=":return i(u,d,h);case"<":return s(u,d,h);case"<=":return o(u,d,h);default:throw new TypeError(`Invalid operator: ${c}`)}};t.exports=l}),xp=M((e,t)=>{"use strict";var a=Le(),r=Ea(),{safeRe:n,t:i}=Ka(),s=(o,l)=>{if(o instanceof a)return o;if(typeof o=="number"&&(o=String(o)),typeof o!="string")return null;l=l||{};let u=null;if(!l.rtl)u=o.match(l.includePrerelease?n[i.COERCEFULL]:n[i.COERCE]);else{let m=l.includePrerelease?n[i.COERCERTLFULL]:n[i.COERCERTL],g;for(;(g=m.exec(o))&&(!u||u.index+u[0].length!==o.length);)(!u||g.index+g[0].length!==u.index+u[0].length)&&(u=g),m.lastIndex=g.index+g[1].length+g[2].length;m.lastIndex=-1}if(u===null)return null;let c=u[2],d=u[3]||"0",h=u[4]||"0",p=l.includePrerelease&&u[5]?`-${u[5]}`:"",f=l.includePrerelease&&u[6]?`+${u[6]}`:"";return r(`${c}.${d}.${h}${p}${f}`,l)};t.exports=s}),Ap=M((e,t)=>{"use strict";var a=class{constructor(){this.max=1e3,this.map=new Map}get(r){let n=this.map.get(r);if(n!==void 0)return this.map.delete(r),this.map.set(r,n),n}delete(r){return this.map.delete(r)}set(r,n){if(!this.delete(r)&&n!==void 0){if(this.map.size>=this.max){let i=this.map.keys().next().value;this.delete(i)}this.map.set(r,n)}return this}};t.exports=a}),it=M((e,t)=>{"use strict";var a=/\s+/g,r=class Ri{constructor(x,Z){if(Z=s(Z),x instanceof Ri)return x.loose===!!Z.loose&&x.includePrerelease===!!Z.includePrerelease?x:new Ri(x.raw,Z);if(x instanceof o)return this.raw=x.value,this.set=[[x]],this.formatted=void 0,this;if(this.options=Z,this.loose=!!Z.loose,this.includePrerelease=!!Z.includePrerelease,this.raw=x.trim().replace(a," "),this.set=this.raw.split("||").map(U=>this.parseRange(U.trim())).filter(U=>U.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let U=this.set[0];if(this.set=this.set.filter(q=>!_(q[0])),this.set.length===0)this.set=[U];else if(this.set.length>1){for(let q of this.set)if(q.length===1&&y(q[0])){this.set=[q];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let x=0;x<this.set.length;x++){x>0&&(this.formatted+="||");let Z=this.set[x];for(let U=0;U<Z.length;U++)U>0&&(this.formatted+=" "),this.formatted+=Z[U].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(x){let Z=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+x,U=i.get(Z);if(U)return U;let q=this.options.loose,L=q?c[d.HYPHENRANGELOOSE]:c[d.HYPHENRANGE];x=x.replace(L,qt(this.options.includePrerelease)),l("hyphen replace",x),x=x.replace(c[d.COMPARATORTRIM],h),l("comparator trim",x),x=x.replace(c[d.TILDETRIM],p),l("tilde trim",x),x=x.replace(c[d.CARETTRIM],f),l("caret trim",x);let V=x.split(" ").map(he=>w(he,this.options)).join(" ").split(/\s+/).map(he=>Tt(he,this.options));q&&(V=V.filter(he=>(l("loose invalid filter",he,this.options),!!he.match(c[d.COMPARATORLOOSE])))),l("range list",V);let le=new Map,ie=V.map(he=>new o(he,this.options));for(let he of ie){if(_(he))return[he];le.set(he.value,he)}le.size>1&&le.has("")&&le.delete("");let se=[...le.values()];return i.set(Z,se),se}intersects(x,Z){if(!(x instanceof Ri))throw new TypeError("a Range is required");return this.set.some(U=>b(U,Z)&&x.set.some(q=>b(q,Z)&&U.every(L=>q.every(V=>L.intersects(V,Z)))))}test(x){if(!x)return!1;if(typeof x=="string")try{x=new u(x,this.options)}catch{return!1}for(let Z=0;Z<this.set.length;Z++)if(jt(this.set[Z],x,this.options))return!0;return!1}};t.exports=r;var n=Ap(),i=new n,s=zi(),o=an(),l=en(),u=Le(),{safeRe:c,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=Ka(),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=Qr(),_=P=>P.value==="<0.0.0-0",y=P=>P.value==="",b=(P,x)=>{let Z=!0,U=P.slice(),q=U.pop();for(;Z&&U.length;)Z=U.every(L=>q.intersects(L,x)),q=U.pop();return Z},w=(P,x)=>(P=P.replace(c[d.BUILD],""),l("comp",P,x),P=j(P,x),l("caret",P),P=I(P,x),l("tildes",P),P=k(P,x),l("xrange",P),P=Zt(P,x),l("stars",P),P),O=P=>!P||P.toLowerCase()==="x"||P==="*",I=(P,x)=>P.trim().split(/\s+/).map(Z=>D(Z,x)).join(" "),D=(P,x)=>{let Z=x.loose?c[d.TILDELOOSE]:c[d.TILDE];return P.replace(Z,(U,q,L,V,le)=>{l("tilde",P,U,q,L,V,le);let ie;return O(q)?ie="":O(L)?ie=`>=${q}.0.0 <${+q+1}.0.0-0`:O(V)?ie=`>=${q}.${L}.0 <${q}.${+L+1}.0-0`:le?(l("replaceTilde pr",le),ie=`>=${q}.${L}.${V}-${le} <${q}.${+L+1}.0-0`):ie=`>=${q}.${L}.${V} <${q}.${+L+1}.0-0`,l("tilde return",ie),ie})},j=(P,x)=>P.trim().split(/\s+/).map(Z=>K(Z,x)).join(" "),K=(P,x)=>{l("caret",P,x);let Z=x.loose?c[d.CARETLOOSE]:c[d.CARET],U=x.includePrerelease?"-0":"";return P.replace(Z,(q,L,V,le,ie)=>{l("caret",P,q,L,V,le,ie);let se;return O(L)?se="":O(V)?se=`>=${L}.0.0${U} <${+L+1}.0.0-0`:O(le)?L==="0"?se=`>=${L}.${V}.0${U} <${L}.${+V+1}.0-0`:se=`>=${L}.${V}.0${U} <${+L+1}.0.0-0`:ie?(l("replaceCaret pr",ie),L==="0"?V==="0"?se=`>=${L}.${V}.${le}-${ie} <${L}.${V}.${+le+1}-0`:se=`>=${L}.${V}.${le}-${ie} <${L}.${+V+1}.0-0`:se=`>=${L}.${V}.${le}-${ie} <${+L+1}.0.0-0`):(l("no pr"),L==="0"?V==="0"?se=`>=${L}.${V}.${le}${U} <${L}.${V}.${+le+1}-0`:se=`>=${L}.${V}.${le}${U} <${L}.${+V+1}.0-0`:se=`>=${L}.${V}.${le} <${+L+1}.0.0-0`),l("caret return",se),se})},k=(P,x)=>(l("replaceXRanges",P,x),P.split(/\s+/).map(Z=>ve(Z,x)).join(" ")),ve=(P,x)=>{P=P.trim();let Z=x.loose?c[d.XRANGELOOSE]:c[d.XRANGE];return P.replace(Z,(U,q,L,V,le,ie)=>{l("xRange",P,U,q,L,V,le,ie);let se=O(L),he=se||O(V),Rt=he||O(le),Ht=Rt;return q==="="&&Ht&&(q=""),ie=x.includePrerelease?"-0":"",se?q===">"||q==="<"?U="<0.0.0-0":U="*":q&&Ht?(he&&(V=0),le=0,q===">"?(q=">=",he?(L=+L+1,V=0,le=0):(V=+V+1,le=0)):q==="<="&&(q="<",he?L=+L+1:V=+V+1),q==="<"&&(ie="-0"),U=`${q+L}.${V}.${le}${ie}`):he?U=`>=${L}.0.0${ie} <${+L+1}.0.0-0`:Rt&&(U=`>=${L}.${V}.0${ie} <${L}.${+V+1}.0-0`),l("xRange return",U),U})},Zt=(P,x)=>(l("replaceStars",P,x),P.trim().replace(c[d.STAR],"")),Tt=(P,x)=>(l("replaceGTE0",P,x),P.trim().replace(c[x.includePrerelease?d.GTE0PRE:d.GTE0],"")),qt=P=>(x,Z,U,q,L,V,le,ie,se,he,Rt,Ht)=>(O(U)?Z="":O(q)?Z=`>=${U}.0.0${P?"-0":""}`:O(L)?Z=`>=${U}.${q}.0${P?"-0":""}`:V?Z=`>=${Z}`:Z=`>=${Z}${P?"-0":""}`,O(se)?ie="":O(he)?ie=`<${+se+1}.0.0-0`:O(Rt)?ie=`<${se}.${+he+1}.0-0`:Ht?ie=`<=${se}.${he}.${Rt}-${Ht}`:P?ie=`<${se}.${he}.${+Rt+1}-0`:ie=`<=${ie}`,`${Z} ${ie}`.trim()),jt=(P,x,Z)=>{for(let U=0;U<P.length;U++)if(!P[U].test(x))return!1;if(x.prerelease.length&&!Z.includePrerelease){for(let U=0;U<P.length;U++)if(l(P[U].semver),P[U].semver!==o.ANY&&P[U].semver.prerelease.length>0){let q=P[U].semver;if(q.major===x.major&&q.minor===x.minor&&q.patch===x.patch)return!0}return!1}return!0}}),an=M((e,t)=>{"use strict";var a=Symbol("SemVer ANY"),r=class el{static get ANY(){return a}constructor(h,p){if(p=n(p),h instanceof el){if(h.loose===!!p.loose)return h;h=h.value}h=h.trim().split(/\s+/).join(" "),l("comparator",h,p),this.options=p,this.loose=!!p.loose,this.parse(h),this.semver===a?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(h){let p=this.options.loose?i[s.COMPARATORLOOSE]:i[s.COMPARATOR],f=h.match(p);if(!f)throw new TypeError(`Invalid comparator: ${h}`);this.operator=f[1]!==void 0?f[1]:"",this.operator==="="&&(this.operator=""),f[2]?this.semver=new u(f[2],this.options.loose):this.semver=a}toString(){return this.value}test(h){if(l("Comparator.test",h,this.options.loose),this.semver===a||h===a)return!0;if(typeof h=="string")try{h=new u(h,this.options)}catch{return!1}return o(h,this.operator,this.semver,this.options)}intersects(h,p){if(!(h instanceof el))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new c(h.value,p).test(this.value):h.operator===""?h.value===""?!0:new c(this.value,p).test(h.semver):(p=n(p),p.includePrerelease&&(this.value==="<0.0.0-0"||h.value==="<0.0.0-0")||!p.includePrerelease&&(this.value.startsWith("<0.0.0")||h.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&h.operator.startsWith(">")||this.operator.startsWith("<")&&h.operator.startsWith("<")||this.semver.version===h.semver.version&&this.operator.includes("=")&&h.operator.includes("=")||o(this.semver,"<",h.semver,p)&&this.operator.startsWith(">")&&h.operator.startsWith("<")||o(this.semver,">",h.semver,p)&&this.operator.startsWith("<")&&h.operator.startsWith(">")))}};t.exports=r;var n=zi(),{safeRe:i,t:s}=Ka(),o=yl(),l=en(),u=Le(),c=it()}),rn=M((e,t)=>{"use strict";var a=it(),r=(n,i,s)=>{try{i=new a(i,s)}catch{return!1}return i.test(n)};t.exports=r}),Ip=M((e,t)=>{"use strict";var a=it(),r=(n,i)=>new a(n,i).set.map(s=>s.map(o=>o.value).join(" ").trim().split(" "));t.exports=r}),Sp=M((e,t)=>{"use strict";var a=Le(),r=it(),n=(i,s,o)=>{let l=null,u=null,c=null;try{c=new r(s,o)}catch{return null}return i.forEach(d=>{c.test(d)&&(!l||u.compare(d)===-1)&&(l=d,u=new a(l,o))}),l};t.exports=n}),Pp=M((e,t)=>{"use strict";var a=Le(),r=it(),n=(i,s,o)=>{let l=null,u=null,c=null;try{c=new r(s,o)}catch{return null}return i.forEach(d=>{c.test(d)&&(!l||u.compare(d)===1)&&(l=d,u=new a(l,o))}),l};t.exports=n}),$p=M((e,t)=>{"use strict";var a=Le(),r=it(),n=tn(),i=(s,o)=>{s=new r(s,o);let l=new a("0.0.0");if(s.test(l)||(l=new a("0.0.0-0"),s.test(l)))return l;l=null;for(let u=0;u<s.set.length;++u){let c=s.set[u],d=null;c.forEach(h=>{let p=new a(h.semver.version);switch(h.operator){case">":p.prerelease.length===0?p.patch++:p.prerelease.push(0),p.raw=p.format();case"":case">=":(!d||n(p,d))&&(d=p);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${h.operator}`)}}),d&&(!l||n(l,d))&&(l=d)}return l&&s.test(l)?l:null};t.exports=i}),Tp=M((e,t)=>{"use strict";var a=it(),r=(n,i)=>{try{return new a(n,i).range||"*"}catch{return null}};t.exports=r}),qi=M((e,t)=>{"use strict";var a=Le(),r=an(),{ANY:n}=r,i=it(),s=rn(),o=tn(),l=Fi(),u=Zi(),c=Bi(),d=(h,p,f,m)=>{h=new a(h,m),p=new i(p,m);let g,_,y,b,w;switch(f){case">":g=o,_=u,y=l,b=">",w=">=";break;case"<":g=l,_=c,y=o,b="<",w="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(s(h,p,m))return!1;for(let O=0;O<p.set.length;++O){let I=p.set[O],D=null,j=null;if(I.forEach(K=>{K.semver===n&&(K=new r(">=0.0.0")),D=D||K,j=j||K,g(K.semver,D.semver,m)?D=K:y(K.semver,j.semver,m)&&(j=K)}),D.operator===b||D.operator===w||(!j.operator||j.operator===b)&&_(h,j.semver)||j.operator===w&&y(h,j.semver))return!1}return!0};t.exports=d}),jp=M((e,t)=>{"use strict";var a=qi(),r=(n,i,s)=>a(n,i,">",s);t.exports=r}),Rp=M((e,t)=>{"use strict";var a=qi(),r=(n,i,s)=>a(n,i,"<",s);t.exports=r}),Np=M((e,t)=>{"use strict";var a=it(),r=(n,i,s)=>(n=new a(n,s),i=new a(i,s),n.intersects(i,s));t.exports=r}),Cp=M((e,t)=>{"use strict";var a=rn(),r=nt();t.exports=(n,i,s)=>{let o=[],l=null,u=null,c=n.sort((f,m)=>r(f,m,s));for(let f of c)a(f,i,s)?(u=f,l||(l=f)):(u&&o.push([l,u]),u=null,l=null);l&&o.push([l,null]);let d=[];for(let[f,m]of o)f===m?d.push(f):!m&&f===c[0]?d.push("*"):m?f===c[0]?d.push(`<=${m}`):d.push(`${f} - ${m}`):d.push(`>=${f}`);let h=d.join(" || "),p=typeof i.raw=="string"?i.raw:String(i);return h.length<p.length?h:i}}),Lp=M((e,t)=>{"use strict";var a=it(),r=an(),{ANY:n}=r,i=rn(),s=nt(),o=(p,f,m={})=>{if(p===f)return!0;p=new a(p,m),f=new a(f,m);let g=!1;e:for(let _ of p.set){for(let y of f.set){let b=c(_,y,m);if(g=g||b!==null,b)continue e}if(g)return!1}return!0},l=[new r(">=0.0.0-0")],u=[new r(">=0.0.0")],c=(p,f,m)=>{if(p===f)return!0;if(p.length===1&&p[0].semver===n){if(f.length===1&&f[0].semver===n)return!0;m.includePrerelease?p=l:p=u}if(f.length===1&&f[0].semver===n){if(m.includePrerelease)return!0;f=u}let g=new Set,_,y;for(let k of p)k.operator===">"||k.operator===">="?_=d(_,k,m):k.operator==="<"||k.operator==="<="?y=h(y,k,m):g.add(k.semver);if(g.size>1)return null;let b;if(_&&y&&(b=s(_.semver,y.semver,m),b>0||b===0&&(_.operator!==">="||y.operator!=="<=")))return null;for(let k of g){if(_&&!i(k,String(_),m)||y&&!i(k,String(y),m))return null;for(let ve of f)if(!i(k,String(ve),m))return!1;return!0}let w,O,I,D,j=y&&!m.includePrerelease&&y.semver.prerelease.length?y.semver:!1,K=_&&!m.includePrerelease&&_.semver.prerelease.length?_.semver:!1;j&&j.prerelease.length===1&&y.operator==="<"&&j.prerelease[0]===0&&(j=!1);for(let k of f){if(D=D||k.operator===">"||k.operator===">=",I=I||k.operator==="<"||k.operator==="<=",_){if(K&&k.semver.prerelease&&k.semver.prerelease.length&&k.semver.major===K.major&&k.semver.minor===K.minor&&k.semver.patch===K.patch&&(K=!1),k.operator===">"||k.operator===">="){if(w=d(_,k,m),w===k&&w!==_)return!1}else if(_.operator===">="&&!i(_.semver,String(k),m))return!1}if(y){if(j&&k.semver.prerelease&&k.semver.prerelease.length&&k.semver.major===j.major&&k.semver.minor===j.minor&&k.semver.patch===j.patch&&(j=!1),k.operator==="<"||k.operator==="<="){if(O=h(y,k,m),O===k&&O!==y)return!1}else if(y.operator==="<="&&!i(y.semver,String(k),m))return!1}if(!k.operator&&(y||_)&&b!==0)return!1}return!(_&&I&&!y&&b!==0||y&&D&&!_&&b!==0||K||j)},d=(p,f,m)=>{if(!p)return f;let g=s(p.semver,f.semver,m);return g>0?p:g<0||f.operator===">"&&p.operator===">="?f:p},h=(p,f,m)=>{if(!p)return f;let g=s(p.semver,f.semver,m);return g<0?p:g>0||f.operator==="<"&&p.operator==="<="?f:p};t.exports=o}),Mp=M((e,t)=>{"use strict";var a=Ka(),r=Qr(),n=Le(),i=fl(),s=Ea(),o=pp(),l=fp(),u=mp(),c=gp(),d=yp(),h=_p(),p=bp(),f=vp(),m=nt(),g=wp(),_=Op(),y=Di(),b=Ep(),w=kp(),O=tn(),I=Fi(),D=ml(),j=gl(),K=Bi(),k=Zi(),ve=yl(),Zt=xp(),Tt=an(),qt=it(),jt=rn(),P=Ip(),x=Sp(),Z=Pp(),U=$p(),q=Tp(),L=qi(),V=jp(),le=Rp(),ie=Np(),se=Cp(),he=Lp();t.exports={parse:s,valid:o,clean:l,inc:u,diff:c,major:d,minor:h,patch:p,prerelease:f,compare:m,rcompare:g,compareLoose:_,compareBuild:y,sort:b,rsort:w,gt:O,lt:I,eq:D,neq:j,gte:K,lte:k,cmp:ve,coerce:Zt,Comparator:Tt,Range:qt,satisfies:jt,toComparators:P,maxSatisfying:x,minSatisfying:Z,minVersion:U,validRange:q,outside:L,gtr:V,ltr:le,intersects:ie,simplifyRange:se,subset:he,SemVer:n,re:a.re,src:a.src,tokens:a.t,SEMVER_SPEC_VERSION:r.SEMVER_SPEC_VERSION,RELEASE_TYPES:r.RELEASE_TYPES,compareIdentifiers:i.compareIdentifiers,rcompareIdentifiers:i.rcompareIdentifiers}}),Up=M((e,t)=>{"use strict";var a=(i=0)=>s=>`\x1B[${38+i};5;${s}m`,r=(i=0)=>(s,o,l)=>`\x1B[${38+i};2;${s};${o};${l}m`;function n(){let i=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(let[o,l]of Object.entries(s)){for(let[u,c]of Object.entries(l))s[u]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},l[u]=s[u],i.set(c[0],c[1]);Object.defineProperty(s,o,{value:l,enumerable:!1})}return Object.defineProperty(s,"codes",{value:i,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=a(),s.color.ansi16m=r(),s.bgColor.ansi256=a(10),s.bgColor.ansi16m=r(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,l,u)=>o===l&&l===u?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(l/255*5)+Math.round(u/255*5),enumerable:!1},hexToRgb:{value:o=>{let l=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!l)return[0,0,0];let{colorString:u}=l.groups;u.length===3&&(u=u.split("").map(d=>d+d).join(""));let c=Number.parseInt(u,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(t,"exports",{enumerable:!0,get:n})}),zp=M(e=>{"use strict";e.byteLength=l,e.toByteArray=c,e.fromByteArray=p;var t=[],a=[],r=typeof Uint8Array<"u"?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(i=0,s=n.length;i<s;++i)t[i]=n[i],a[n.charCodeAt(i)]=i;var i,s;a[45]=62,a[95]=63;function o(f){var m=f.length;if(m%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var g=f.indexOf("=");g===-1&&(g=m);var _=g===m?0:4-g%4;return[g,_]}function l(f){var m=o(f),g=m[0],_=m[1];return(g+_)*3/4-_}function u(f,m,g){return(m+g)*3/4-g}function c(f){var m,g=o(f),_=g[0],y=g[1],b=new r(u(f,_,y)),w=0,O=y>0?_-4:_,I;for(I=0;I<O;I+=4)m=a[f.charCodeAt(I)]<<18|a[f.charCodeAt(I+1)]<<12|a[f.charCodeAt(I+2)]<<6|a[f.charCodeAt(I+3)],b[w++]=m>>16&255,b[w++]=m>>8&255,b[w++]=m&255;return y===2&&(m=a[f.charCodeAt(I)]<<2|a[f.charCodeAt(I+1)]>>4,b[w++]=m&255),y===1&&(m=a[f.charCodeAt(I)]<<10|a[f.charCodeAt(I+1)]<<4|a[f.charCodeAt(I+2)]>>2,b[w++]=m>>8&255,b[w++]=m&255),b}function d(f){return t[f>>18&63]+t[f>>12&63]+t[f>>6&63]+t[f&63]}function h(f,m,g){for(var _,y=[],b=m;b<g;b+=3)_=(f[b]<<16&16711680)+(f[b+1]<<8&65280)+(f[b+2]&255),y.push(d(_));return y.join("")}function p(f){for(var m,g=f.length,_=g%3,y=[],b=16383,w=0,O=g-_;w<O;w+=b)y.push(h(f,w,w+b>O?O:w+b));return _===1?(m=f[g-1],y.push(t[m>>2]+t[m<<4&63]+"==")):_===2&&(m=(f[g-2]<<8)+f[g-1],y.push(t[m>>10]+t[m>>4&63]+t[m<<2&63]+"=")),y.join("")}});function _l(e,t=Hi){e=e.trim();let a=e.indexOf("```");if(a===-1)return t(e);let r=e.substring(a+3);r.startsWith(`json
`)?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith(`
`)&&(r=r.substring(1));let n=r.indexOf("```"),i=r;return n!==-1&&(i=r.substring(0,n)),t(i.trim())}function Hi(e){if(typeof e>"u")return null;try{return JSON.parse(e)}catch{}let t="",a=[],r=!1,n=!1;for(let i of e){if(r)i==='"'&&!n?r=!1:i===`
`&&!n?i="\\n":i==="\\"?n=!n:n=!1;else if(i==='"')r=!0,n=!1;else if(i==="{")a.push("}");else if(i==="[")a.push("]");else if(i==="}"||i==="]")if(a&&a[a.length-1]===i)a.pop();else return null;t+=i}r&&(t+='"');for(let i=a.length-1;i>=0;i-=1)t+=a[i];try{return JSON.parse(t)}catch{return null}}var Dp=rt(rp(),1),Zw=rt(np(),1);function Fp(e,t){return t?.[e]||(0,Dp.default)(e)}function Bp(e,t,a){let r={};for(let n in e)Object.hasOwn(e,n)&&(r[t(n,a)]=e[n]);return r}function bl(e){return Array.isArray(e)?[...e]:{...e}}function Zp(e,t){let a=bl(e);for(let[r,n]of Object.entries(t)){let[i,...s]=r.split(".").reverse(),o=a;for(let l of s.reverse()){if(o[l]===void 0)break;o[l]=bl(o[l]),o=o[l]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[n]})}return a}function vl(e){let t=Object.getPrototypeOf(e);return typeof e.lc_name=="function"&&(typeof t.lc_name!="function"||e.lc_name()!==t.lc_name())?e.lc_name():e.name}var Va=class Eh{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vl(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(t,...a){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(t||{}).filter(([r])=>this.lc_serializable_keys?.includes(r))):this.lc_kwargs=t??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Eh||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let t={},a={},r=Object.keys(this.lc_kwargs).reduce((n,i)=>(n[i]=i in this?this[i]:this.lc_kwargs[i],n),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(t,Reflect.get(n,"lc_aliases",this)),Object.assign(a,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return Object.keys(a).forEach(n=>{let i=this,s=r,[o,...l]=n.split(".").reverse();for(let u of l.reverse()){if(!(u in i)||i[u]===void 0)return;(!(u in s)||s[u]===void 0)&&(typeof i[u]=="object"&&i[u]!=null?s[u]={}:Array.isArray(i[u])&&(s[u]=[])),i=i[u],s=s[u]}o in i&&i[o]!==void 0&&(s[o]=s[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Bp(Object.keys(a).length?Zp(r,a):r,Fp,t)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function Xa(e){return typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"source_type"in e&&(e.source_type==="url"||e.source_type==="base64"||e.source_type==="text"||e.source_type==="id")}function qp(e){return Xa(e)&&e.source_type==="url"&&"url"in e&&typeof e.url=="string"}function Hp(e){return Xa(e)&&e.source_type==="base64"&&"data"in e&&typeof e.data=="string"}function Jp(e){if(Xa(e)){if(e.source_type==="url")return{type:"image_url",image_url:{url:e.url}};if(e.source_type==="base64"){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function ka(e,t){return typeof e=="string"?e===""?t:typeof t=="string"?e+t:Array.isArray(t)&&t.some(a=>Xa(a))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?nn(e,t)??[...e,...t]:t===""?e:Array.isArray(e)&&e.some(a=>Xa(a))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function Gp(e,t){return e==="error"||t==="error"?"error":"success"}function Wp(e,t){function a(r,n){if(typeof r!="object"||r===null||r===void 0)return r;if(n>=t)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(s=>a(s,n+1));let i={};for(let s of Object.keys(r))i[s]=a(r[s],n+1);return i}return JSON.stringify(a(e,0),null,2)}var la=class extends Va{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=Wp(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function Me(e,t){let a={...e};for(let[r,n]of Object.entries(t))if(a[r]==null)a[r]=n;else{if(n==null)continue;if(typeof a[r]!=typeof n||Array.isArray(a[r])!==Array.isArray(n))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof a[r]=="string"){if(r==="type")continue;["id","name","output_version","model_provider"].includes(r)?a[r]=n:a[r]+=n}else if(typeof a[r]=="object"&&!Array.isArray(a[r]))a[r]=Me(a[r],n);else if(Array.isArray(a[r]))a[r]=nn(a[r],n);else{if(a[r]===n)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return a}function nn(e,t){if(!(e===void 0&&t===void 0)){if(e===void 0||t===void 0)return e||t;{let a=[...e];for(let r of t)if(typeof r=="object"&&r!==null&&"index"in r&&typeof r.index=="number"){let n=a.findIndex(i=>{let s=typeof i=="object",o="index"in i&&i.index===r.index,l="id"in i&&"id"in r&&i?.id===r?.id,u=!("id"in i)||!i?.id||!("id"in r)||!r?.id;return s&&o&&(l||u)});n!==-1&&typeof a[n]=="object"&&a[n]!==null?a[n]=Me(a[n],r):a.push(r)}else{if(typeof r=="object"&&r!==null&&"text"in r&&r.text==="")continue;a.push(r)}return a}}}function Kp(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if(typeof e=="string"&&typeof t=="string")return e+t;if(Array.isArray(e)&&Array.isArray(t))return nn(e,t);if(typeof e=="object"&&typeof t=="object")return Me(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}var xa=class extends la{};function Vp(e){return typeof e.role=="string"}function sn(e){return typeof e?._getType=="function"}function Xp(e){return sn(e)&&typeof e.concat=="function"}function Yp(e){return e!=null&&typeof e=="object"&&"lc_direct_tool_output"in e&&e.lc_direct_tool_output===!0}var Ji=class extends la{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,a){typeof e=="string"&&(e={content:e,name:a,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Qp=class kh extends xa{constructor(t){super(t),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=t.tool_call_id,this.artifact=t.artifact,this.status=t.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(t){return new kh({content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),artifact:Kp(this.artifact,t.artifact),tool_call_id:this.tool_call_id,id:this.id??t.id,status:Gp(this.status,t.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function ef(e){let t=[],a=[];for(let r of e)if(r.function){let n=r.function.name;try{let i=JSON.parse(r.function.arguments),s={name:n||"",args:i||{},id:r.id};t.push(s)}catch{a.push({name:n,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[t,a]}var on=class extends la{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let a;if(typeof e=="string")a={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{a=e;let r=a.additional_kwargs?.tool_calls,n=a.tool_calls;r!=null&&r.length>0&&(n===void 0||n.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(r!=null&&n===void 0){let[i,s]=ef(r);a.tool_calls=i??[],a.invalid_tool_calls=s??[]}else a.tool_calls=a.tool_calls??[],a.invalid_tool_calls=a.invalid_tool_calls??[]}catch{a.tool_calls=[],a.invalid_tool_calls=[]}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a!="string"&&(this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=a.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};function ln(e){return e._getType()==="ai"}function wl(e){return e._getType()==="ai"}var Ya=class xh extends xa{constructor(t){let a;if(typeof t=="string")a={content:t,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(t.tool_call_chunks===void 0||t.tool_call_chunks.length===0)a={...t,tool_calls:t.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0};else{let r=(t.tool_call_chunks??[]).reduce((s,o)=>{let l=s.findIndex(([u])=>"id"in o&&o.id&&"index"in o&&o.index!==void 0?o.id===u.id&&o.index===u.index:"id"in o&&o.id?o.id===u.id:"index"in o&&o.index!==void 0?o.index===u.index:!1);return l!==-1?s[l].push(o):s.push([o]),s},[]),n=[],i=[];for(let s of r){let o={},l=s[0]?.name??"",u=s.map(h=>h.args||"").join(""),c=u.length?u:"{}",d=s[0]?.id;try{if(o=Hi(c),!d||o===null||typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");n.push({name:l,args:o,id:d,type:"tool_call"})}catch{i.push({name:l,args:c,id:d,error:"Malformed args.",type:"invalid_tool_call"})}}a={...t,tool_calls:n,invalid_tool_calls:i,usage_metadata:t.usage_metadata!==void 0?t.usage_metadata:void 0}}super(a),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=a.tool_call_chunks??this.tool_call_chunks,this.tool_calls=a.tool_calls??this.tool_calls,this.invalid_tool_calls=a.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=a.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(t){let a={content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),tool_call_chunks:[],id:this.id??t.id};if(this.tool_call_chunks!==void 0||t.tool_call_chunks!==void 0){let r=nn(this.tool_call_chunks,t.tool_call_chunks);r!==void 0&&r.length>0&&(a.tool_call_chunks=r)}if(this.usage_metadata!==void 0||t.usage_metadata!==void 0){let r={...(this.usage_metadata?.input_token_details?.audio!==void 0||t.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(t.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||t.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(t.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||t.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(t.usage_metadata?.input_token_details?.cache_creation??0)}},n={...(this.usage_metadata?.output_token_details?.audio!==void 0||t.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(t.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||t.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(t.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=t.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:i.input_tokens+s.input_tokens,output_tokens:i.output_tokens+s.output_tokens,total_tokens:i.total_tokens+s.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(n).length>0&&{output_token_details:n}};a.usage_metadata=o}return new xh(a)}},Gi=class Ah extends la{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Ah}constructor(t,a){typeof t=="string"&&(t={content:t,role:a}),super(t),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t.role}_getType(){return"generic"}static isInstance(t){return t._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},Ol=class Ih extends xa{static lc_name(){return"ChatMessageChunk"}constructor(t,a){typeof t=="string"&&(t={content:t,role:a}),super(t),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=t.role}_getType(){return"generic"}concat(t){return new Ih({content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),role:this.role,id:this.id??t.id})}get _printableFields(){return{...super._printableFields,role:this.role}}},El=class Sh extends xa{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(t){return new Sh({content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),name:this.name??"",id:this.id??t.id})}},Qa=class extends la{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}},kl=class Ph extends xa{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(t,a){super(t,a)}concat(t){return new Ph({content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),id:this.id??t.id})}},Wi=class extends la{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}},Ki=class $h extends xa{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(t,a){super(t,a)}concat(t){return new $h({content:ka(this.content,t.content),additional_kwargs:Me(this.additional_kwargs,t.additional_kwargs),response_metadata:Me(this.response_metadata,t.response_metadata),id:this.id??t.id})}};function xl(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function er(e){return!!(e&&typeof e=="object"&&"type"in e&&e.type==="tool_call")}function tf(e){return!!(e&&typeof e=="object"&&"toolCall"in e&&e.toolCall!=null&&typeof e.toolCall=="object"&&"id"in e.toolCall&&typeof e.toolCall.id=="string")}var Vi=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}},af=class extends la{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}};function rf(e){return er(e)?e:typeof e.id=="string"&&e.type==="function"&&typeof e.function=="object"&&e.function!==null&&"arguments"in e.function&&typeof e.function.arguments=="string"&&"name"in e.function&&typeof e.function.name=="string"?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function nf(e){return typeof e=="object"&&e!=null&&e.lc===1&&Array.isArray(e.id)&&e.kwargs!=null&&typeof e.kwargs=="object"}function Xi(e){let t,a;if(nf(e)){let r=e.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?t="user":r==="AIMessage"||r==="AIMessageChunk"?t="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?t="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?t="function":r==="ToolMessage"||r==="ToolMessageChunk"?t="tool":t="unknown",a=e.kwargs}else{let{type:r,...n}=e;t=r,a=n}if(t==="human"||t==="user")return new Qa(a);if(t==="ai"||t==="assistant"){let{tool_calls:r,...n}=a;if(!Array.isArray(r))return new on(a);let i=r.map(rf);return new on({...n,tool_calls:i})}else{if(t==="system")return new Wi(a);if(t==="developer")return new Wi({...a,additional_kwargs:{...a.additional_kwargs,__openai_role__:"developer"}});if(t==="tool"&&"tool_call_id"in a)return new Ji({...a,content:a.content,tool_call_id:a.tool_call_id,name:a.name});if(t==="remove"&&"id"in a&&typeof a.id=="string")return new af({...a,id:a.id});throw xl(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function tr(e){if(typeof e=="string")return new Qa(e);if(sn(e))return e;if(Array.isArray(e)){let[t,a]=e;return Xi({type:t,content:a})}else if(Vp(e)){let{role:t,...a}=e;return Xi({...a,type:t})}else return Xi(e)}function Al(e,t="Human",a="AI"){let r=[];for(let n of e){let i;if(n._getType()==="human")i=t;else if(n._getType()==="ai")i=a;else if(n._getType()==="system")i="System";else if(n._getType()==="function")i="Function";else if(n._getType()==="tool")i="Tool";else if(n._getType()==="generic")i=n.role;else throw new Error(`Got unsupported message type: ${n._getType()}`);let s=n.name?`${n.name}, `:"",o=typeof n.content=="string"?n.content:JSON.stringify(n.content,null,2);r.push(`${i}: ${s}${o}`)}return r.join(`
`)}function sf(e){let t=e._getType();if(t==="human")return new kl({...e});if(t==="ai"){let a={...e};return"tool_calls"in a&&(a={...a,tool_call_chunks:a.tool_calls?.map(r=>({...r,type:"tool_call_chunk",index:void 0,args:JSON.stringify(r.args)}))}),new Ya({...a})}else{if(t==="system")return new Ki({...e});if(t==="function")return new El({...e});if(Gi.isInstance(e))return new Ol({...e});throw new Error("Unknown message type.")}}var Lt={};pl(Lt,{BRAND:()=>jf,DIRTY:()=>Ia,EMPTY_PATH:()=>cf,INVALID:()=>H,NEVER:()=>mm,OK:()=>Ue,ParseStatus:()=>Be,Schema:()=>ae,ZodAny:()=>Pa,ZodArray:()=>da,ZodBigInt:()=>nr,ZodBoolean:()=>ir,ZodBranded:()=>rs,ZodCatch:()=>gr,ZodDate:()=>sr,ZodDefault:()=>mr,ZodDiscriminatedUnion:()=>jl,ZodEffects:()=>ot,ZodEnum:()=>pr,ZodError:()=>st,ZodFirstPartyTypeKind:()=>v,ZodFunction:()=>Nl,ZodIntersection:()=>cr,ZodIssueCode:()=>E,ZodLazy:()=>dr,ZodLiteral:()=>hr,ZodMap:()=>pn,ZodNaN:()=>mn,ZodNativeEnum:()=>fr,ZodNever:()=>Ut,ZodNull:()=>lr,ZodNullable:()=>Wt,ZodNumber:()=>rr,ZodObject:()=>et,ZodOptional:()=>wt,ZodParsedType:()=>S,ZodPipeline:()=>ns,ZodPromise:()=>Ta,ZodReadonly:()=>yr,ZodRecord:()=>Rl,ZodSchema:()=>ae,ZodSet:()=>fn,ZodString:()=>Sa,ZodSymbol:()=>dn,ZodTransformer:()=>ot,ZodTuple:()=>Gt,ZodType:()=>ae,ZodUndefined:()=>or,ZodUnion:()=>ur,ZodUnknown:()=>ca,ZodVoid:()=>hn,addIssueToContext:()=>A,any:()=>Ff,array:()=>Hf,bigint:()=>Lf,boolean:()=>Dl,coerce:()=>fm,custom:()=>Ml,date:()=>Mf,datetimeRegex:()=>Tl,defaultErrorMap:()=>Aa,discriminatedUnion:()=>Kf,effect:()=>Fl,enum:()=>nm,function:()=>tm,getErrorMap:()=>un,getParsedType:()=>Mt,instanceof:()=>Nf,intersection:()=>Vf,isAborted:()=>Qi,isAsync:()=>ar,isDirty:()=>es,isValid:()=>ua,late:()=>Rf,lazy:()=>am,literal:()=>rm,makeIssue:()=>cn,map:()=>Qf,nan:()=>Cf,nativeEnum:()=>im,never:()=>Zf,null:()=>Df,nullable:()=>lm,number:()=>zl,object:()=>Jf,objectUtil:()=>Yi,oboolean:()=>pm,onumber:()=>hm,optional:()=>om,ostring:()=>dm,pipeline:()=>cm,preprocess:()=>um,promise:()=>sm,quotelessJson:()=>of,record:()=>Yf,set:()=>em,setErrorMap:()=>uf,strictObject:()=>Gf,string:()=>Ul,symbol:()=>Uf,transformer:()=>Fl,tuple:()=>Xf,undefined:()=>zf,union:()=>Wf,unknown:()=>Bf,util:()=>oe,void:()=>qf});var oe;(function(e){e.assertEqual=n=>{};function t(n){}e.assertIs=t;function a(n){throw new Error}e.assertNever=a,e.arrayToEnum=n=>{let i={};for(let s of n)i[s]=s;return i},e.getValidEnumValues=n=>{let i=e.objectKeys(n).filter(o=>typeof n[n[o]]!="number"),s={};for(let o of i)s[o]=n[o];return e.objectValues(s)},e.objectValues=n=>e.objectKeys(n).map(function(i){return n[i]}),e.objectKeys=typeof Object.keys=="function"?n=>Object.keys(n):n=>{let i=[];for(let s in n)Object.prototype.hasOwnProperty.call(n,s)&&i.push(s);return i},e.find=(n,i)=>{for(let s of n)if(i(s))return s},e.isInteger=typeof Number.isInteger=="function"?n=>Number.isInteger(n):n=>typeof n=="number"&&Number.isFinite(n)&&Math.floor(n)===n;function r(n,i=" | "){return n.map(s=>typeof s=="string"?`'${s}'`:s).join(i)}e.joinValues=r,e.jsonStringifyReplacer=(n,i)=>typeof i=="bigint"?i.toString():i})(oe||(oe={}));var Yi;(function(e){e.mergeShapes=(t,a)=>({...t,...a})})(Yi||(Yi={}));var S=oe.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Mt=e=>{switch(typeof e){case"undefined":return S.undefined;case"string":return S.string;case"number":return Number.isNaN(e)?S.nan:S.number;case"boolean":return S.boolean;case"function":return S.function;case"bigint":return S.bigint;case"symbol":return S.symbol;case"object":return Array.isArray(e)?S.array:e===null?S.null:e.then&&typeof e.then=="function"&&e.catch&&typeof e.catch=="function"?S.promise:typeof Map<"u"&&e instanceof Map?S.map:typeof Set<"u"&&e instanceof Set?S.set:typeof Date<"u"&&e instanceof Date?S.date:S.object;default:return S.unknown}},E=oe.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),of=e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),st=class Th extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let a=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,a):this.__proto__=a,this.name="ZodError",this.issues=t}format(t){let a=t||function(i){return i.message},r={_errors:[]},n=i=>{for(let s of i.issues)if(s.code==="invalid_union")s.unionErrors.map(n);else if(s.code==="invalid_return_type")n(s.returnTypeError);else if(s.code==="invalid_arguments")n(s.argumentsError);else if(s.path.length===0)r._errors.push(a(s));else{let o=r,l=0;for(;l<s.path.length;){let u=s.path[l];l===s.path.length-1?(o[u]=o[u]||{_errors:[]},o[u]._errors.push(a(s))):o[u]=o[u]||{_errors:[]},o=o[u],l++}}};return n(this),r}static assert(t){if(!(t instanceof Th))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,oe.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=a=>a.message){let a={},r=[];for(let n of this.issues)if(n.path.length>0){let i=n.path[0];a[i]=a[i]||[],a[i].push(t(n))}else r.push(t(n));return{formErrors:r,fieldErrors:a}}get formErrors(){return this.flatten()}};st.create=e=>new st(e);var lf=(e,t)=>{let a;switch(e.code){case E.invalid_type:e.received===S.undefined?a="Required":a=`Expected ${e.expected}, received ${e.received}`;break;case E.invalid_literal:a=`Invalid literal value, expected ${JSON.stringify(e.expected,oe.jsonStringifyReplacer)}`;break;case E.unrecognized_keys:a=`Unrecognized key(s) in object: ${oe.joinValues(e.keys,", ")}`;break;case E.invalid_union:a="Invalid input";break;case E.invalid_union_discriminator:a=`Invalid discriminator value. Expected ${oe.joinValues(e.options)}`;break;case E.invalid_enum_value:a=`Invalid enum value. Expected ${oe.joinValues(e.options)}, received '${e.received}'`;break;case E.invalid_arguments:a="Invalid function arguments";break;case E.invalid_return_type:a="Invalid function return type";break;case E.invalid_date:a="Invalid date";break;case E.invalid_string:typeof e.validation=="object"?"includes"in e.validation?(a=`Invalid input: must include "${e.validation.includes}"`,typeof e.validation.position=="number"&&(a=`${a} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?a=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?a=`Invalid input: must end with "${e.validation.endsWith}"`:oe.assertNever(e.validation):e.validation!=="regex"?a=`Invalid ${e.validation}`:a="Invalid";break;case E.too_small:e.type==="array"?a=`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:e.type==="string"?a=`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:e.type==="number"?a=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="bigint"?a=`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:e.type==="date"?a=`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:a="Invalid input";break;case E.too_big:e.type==="array"?a=`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:e.type==="string"?a=`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:e.type==="number"?a=`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="bigint"?a=`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:e.type==="date"?a=`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:a="Invalid input";break;case E.custom:a="Invalid input";break;case E.invalid_intersection_types:a="Intersection results could not be merged";break;case E.not_multiple_of:a=`Number must be a multiple of ${e.multipleOf}`;break;case E.not_finite:a="Number must be finite";break;default:a=t.defaultError,oe.assertNever(e)}return{message:a}},Aa=lf,Il=Aa;function uf(e){Il=e}function un(){return Il}var cn=e=>{let{data:t,path:a,errorMaps:r,issueData:n}=e,i=[...a,...n.path||[]],s={...n,path:i};if(n.message!==void 0)return{...n,path:i,message:n.message};let o="",l=r.filter(u=>!!u).slice().reverse();for(let u of l)o=u(s,{data:t,defaultError:o}).message;return{...n,path:i,message:o}},cf=[];function A(e,t){let a=un(),r=cn({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,a,a===Aa?void 0:Aa].filter(n=>!!n)});e.common.issues.push(r)}var Be=class jh{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(t,a){let r=[];for(let n of a){if(n.status==="aborted")return H;n.status==="dirty"&&t.dirty(),r.push(n.value)}return{status:t.value,value:r}}static async mergeObjectAsync(t,a){let r=[];for(let n of a){let i=await n.key,s=await n.value;r.push({key:i,value:s})}return jh.mergeObjectSync(t,r)}static mergeObjectSync(t,a){let r={};for(let n of a){let{key:i,value:s}=n;if(i.status==="aborted"||s.status==="aborted")return H;i.status==="dirty"&&t.dirty(),s.status==="dirty"&&t.dirty(),i.value!=="__proto__"&&(typeof s.value<"u"||n.alwaysSet)&&(r[i.value]=s.value)}return{status:t.value,value:r}}},H=Object.freeze({status:"aborted"}),Ia=e=>({status:"dirty",value:e}),Ue=e=>({status:"valid",value:e}),Qi=e=>e.status==="aborted",es=e=>e.status==="dirty",ua=e=>e.status==="valid",ar=e=>typeof Promise<"u"&&e instanceof Promise,C;(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(C||(C={}));var vt=class{constructor(e,t,a,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=a,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Sl=(e,t)=>{if(ua(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let a=new st(e.common.issues);return this._error=a,this._error}}};function te(e){if(!e)return{};let{errorMap:t,invalid_type_error:a,required_error:r,description:n}=e;if(t&&(a||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return t?{errorMap:t,description:n}:{errorMap:(i,s)=>{let{message:o}=e;return i.code==="invalid_enum_value"?{message:o??s.defaultError}:typeof s.data>"u"?{message:o??r??s.defaultError}:i.code!=="invalid_type"?{message:s.defaultError}:{message:o??a??s.defaultError}},description:n}}var ae=class{get description(){return this._def.description}_getType(e){return Mt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Mt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Be,ctx:{common:e.parent.common,data:e.data,parsedType:Mt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(ar(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let a=this.safeParse(e,t);if(a.success)return a.data;throw a.error}safeParse(e,t){let a={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Mt(e)},r=this._parseSync({data:e,path:a.path,parent:a});return Sl(a,r)}"~validate"(e){let t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Mt(e)};if(!this["~standard"].async)try{let a=this._parseSync({data:e,path:[],parent:t});return ua(a)?{value:a.value}:{issues:t.common.issues}}catch(a){a?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>ua(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){let a=await this.safeParseAsync(e,t);if(a.success)return a.data;throw a.error}async safeParseAsync(e,t){let a={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Mt(e)},r=this._parse({data:e,path:a.path,parent:a}),n=await(ar(r)?r:Promise.resolve(r));return Sl(a,n)}refine(e,t){let a=r=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(r):t;return this._refinement((r,n)=>{let i=e(r),s=()=>n.addIssue({code:E.custom,...a(r)});return typeof Promise<"u"&&i instanceof Promise?i.then(o=>o?!0:(s(),!1)):i?!0:(s(),!1)})}refinement(e,t){return this._refinement((a,r)=>e(a)?!0:(r.addIssue(typeof t=="function"?t(a,r):t),!1))}_refinement(e){return new ot({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return wt.create(this,this._def)}nullable(){return Wt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return da.create(this)}promise(){return Ta.create(this,this._def)}or(e){return ur.create([this,e],this._def)}and(e){return cr.create(this,e,this._def)}transform(e){return new ot({...te(this._def),schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new mr({...te(this._def),innerType:this,defaultValue:t,typeName:v.ZodDefault})}brand(){return new rs({typeName:v.ZodBranded,type:this,...te(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new gr({...te(this._def),innerType:this,catchValue:t,typeName:v.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return ns.create(this,e)}readonly(){return yr.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},df=/^c[^\s-]{8,}$/i,hf=/^[0-9a-z]+$/,pf=/^[0-9A-HJKMNP-TV-Z]{26}$/i,ff=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,mf=/^[a-z0-9_-]{21}$/i,gf=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,yf=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,_f=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,bf="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",ts,vf=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,wf=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Of=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ef=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,kf=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,xf=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Pl="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Af=new RegExp(`^${Pl}$`);function $l(e){let t="[0-5]\\d";e.precision?t=`${t}\\.\\d{${e.precision}}`:e.precision==null&&(t=`${t}(\\.\\d+)?`);let a=e.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${t})${a}`}function If(e){return new RegExp(`^${$l(e)}$`)}function Tl(e){let t=`${Pl}T${$l(e)}`,a=[];return a.push(e.local?"Z?":"Z"),e.offset&&a.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${a.join("|")})`,new RegExp(`^${t}$`)}function Sf(e,t){return!!((t==="v4"||!t)&&vf.test(e)||(t==="v6"||!t)&&Of.test(e))}function Pf(e,t){if(!gf.test(e))return!1;try{let[a]=e.split(".");if(!a)return!1;let r=a.replace(/-/g,"+").replace(/_/g,"/").padEnd(a.length+(4-a.length%4)%4,"="),n=JSON.parse(atob(r));return!(typeof n!="object"||n===null||"typ"in n&&n?.typ!=="JWT"||!n.alg||t&&n.alg!==t)}catch{return!1}}function $f(e,t){return!!((t==="v4"||!t)&&wf.test(e)||(t==="v6"||!t)&&Ef.test(e))}var Sa=class Gr extends ae{_parse(t){if(this._def.coerce&&(t.data=String(t.data)),this._getType(t)!==S.string){let n=this._getOrReturnCtx(t);return A(n,{code:E.invalid_type,expected:S.string,received:n.parsedType}),H}let a=new Be,r;for(let n of this._def.checks)if(n.kind==="min")t.data.length<n.value&&(r=this._getOrReturnCtx(t,r),A(r,{code:E.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),a.dirty());else if(n.kind==="max")t.data.length>n.value&&(r=this._getOrReturnCtx(t,r),A(r,{code:E.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),a.dirty());else if(n.kind==="length"){let i=t.data.length>n.value,s=t.data.length<n.value;(i||s)&&(r=this._getOrReturnCtx(t,r),i?A(r,{code:E.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):s&&A(r,{code:E.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),a.dirty())}else if(n.kind==="email")_f.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"email",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="emoji")ts||(ts=new RegExp(bf,"u")),ts.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"emoji",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="uuid")ff.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"uuid",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="nanoid")mf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"nanoid",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="cuid")df.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"cuid",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="cuid2")hf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"cuid2",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="ulid")pf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"ulid",code:E.invalid_string,message:n.message}),a.dirty());else if(n.kind==="url")try{new URL(t.data)}catch{r=this._getOrReturnCtx(t,r),A(r,{validation:"url",code:E.invalid_string,message:n.message}),a.dirty()}else n.kind==="regex"?(n.regex.lastIndex=0,n.regex.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"regex",code:E.invalid_string,message:n.message}),a.dirty())):n.kind==="trim"?t.data=t.data.trim():n.kind==="includes"?t.data.includes(n.value,n.position)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),a.dirty()):n.kind==="toLowerCase"?t.data=t.data.toLowerCase():n.kind==="toUpperCase"?t.data=t.data.toUpperCase():n.kind==="startsWith"?t.data.startsWith(n.value)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:{startsWith:n.value},message:n.message}),a.dirty()):n.kind==="endsWith"?t.data.endsWith(n.value)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:{endsWith:n.value},message:n.message}),a.dirty()):n.kind==="datetime"?Tl(n).test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:"datetime",message:n.message}),a.dirty()):n.kind==="date"?Af.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:"date",message:n.message}),a.dirty()):n.kind==="time"?If(n).test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{code:E.invalid_string,validation:"time",message:n.message}),a.dirty()):n.kind==="duration"?yf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"duration",code:E.invalid_string,message:n.message}),a.dirty()):n.kind==="ip"?Sf(t.data,n.version)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"ip",code:E.invalid_string,message:n.message}),a.dirty()):n.kind==="jwt"?Pf(t.data,n.alg)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"jwt",code:E.invalid_string,message:n.message}),a.dirty()):n.kind==="cidr"?$f(t.data,n.version)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"cidr",code:E.invalid_string,message:n.message}),a.dirty()):n.kind==="base64"?kf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"base64",code:E.invalid_string,message:n.message}),a.dirty()):n.kind==="base64url"?xf.test(t.data)||(r=this._getOrReturnCtx(t,r),A(r,{validation:"base64url",code:E.invalid_string,message:n.message}),a.dirty()):oe.assertNever(n);return{status:a.value,value:t.data}}_regex(t,a,r){return this.refinement(n=>t.test(n),{validation:a,code:E.invalid_string,...C.errToObj(r)})}_addCheck(t){return new Gr({...this._def,checks:[...this._def.checks,t]})}email(t){return this._addCheck({kind:"email",...C.errToObj(t)})}url(t){return this._addCheck({kind:"url",...C.errToObj(t)})}emoji(t){return this._addCheck({kind:"emoji",...C.errToObj(t)})}uuid(t){return this._addCheck({kind:"uuid",...C.errToObj(t)})}nanoid(t){return this._addCheck({kind:"nanoid",...C.errToObj(t)})}cuid(t){return this._addCheck({kind:"cuid",...C.errToObj(t)})}cuid2(t){return this._addCheck({kind:"cuid2",...C.errToObj(t)})}ulid(t){return this._addCheck({kind:"ulid",...C.errToObj(t)})}base64(t){return this._addCheck({kind:"base64",...C.errToObj(t)})}base64url(t){return this._addCheck({kind:"base64url",...C.errToObj(t)})}jwt(t){return this._addCheck({kind:"jwt",...C.errToObj(t)})}ip(t){return this._addCheck({kind:"ip",...C.errToObj(t)})}cidr(t){return this._addCheck({kind:"cidr",...C.errToObj(t)})}datetime(t){return typeof t=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:t}):this._addCheck({kind:"datetime",precision:typeof t?.precision>"u"?null:t?.precision,offset:t?.offset??!1,local:t?.local??!1,...C.errToObj(t?.message)})}date(t){return this._addCheck({kind:"date",message:t})}time(t){return typeof t=="string"?this._addCheck({kind:"time",precision:null,message:t}):this._addCheck({kind:"time",precision:typeof t?.precision>"u"?null:t?.precision,...C.errToObj(t?.message)})}duration(t){return this._addCheck({kind:"duration",...C.errToObj(t)})}regex(t,a){return this._addCheck({kind:"regex",regex:t,...C.errToObj(a)})}includes(t,a){return this._addCheck({kind:"includes",value:t,position:a?.position,...C.errToObj(a?.message)})}startsWith(t,a){return this._addCheck({kind:"startsWith",value:t,...C.errToObj(a)})}endsWith(t,a){return this._addCheck({kind:"endsWith",value:t,...C.errToObj(a)})}min(t,a){return this._addCheck({kind:"min",value:t,...C.errToObj(a)})}max(t,a){return this._addCheck({kind:"max",value:t,...C.errToObj(a)})}length(t,a){return this._addCheck({kind:"length",value:t,...C.errToObj(a)})}nonempty(t){return this.min(1,C.errToObj(t))}trim(){return new Gr({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Gr({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Gr({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(t=>t.kind==="datetime")}get isDate(){return!!this._def.checks.find(t=>t.kind==="date")}get isTime(){return!!this._def.checks.find(t=>t.kind==="time")}get isDuration(){return!!this._def.checks.find(t=>t.kind==="duration")}get isEmail(){return!!this._def.checks.find(t=>t.kind==="email")}get isURL(){return!!this._def.checks.find(t=>t.kind==="url")}get isEmoji(){return!!this._def.checks.find(t=>t.kind==="emoji")}get isUUID(){return!!this._def.checks.find(t=>t.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(t=>t.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(t=>t.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(t=>t.kind==="cuid2")}get isULID(){return!!this._def.checks.find(t=>t.kind==="ulid")}get isIP(){return!!this._def.checks.find(t=>t.kind==="ip")}get isCIDR(){return!!this._def.checks.find(t=>t.kind==="cidr")}get isBase64(){return!!this._def.checks.find(t=>t.kind==="base64")}get isBase64url(){return!!this._def.checks.find(t=>t.kind==="base64url")}get minLength(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxLength(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}};Sa.create=e=>new Sa({checks:[],typeName:v.ZodString,coerce:e?.coerce??!1,...te(e)});function Tf(e,t){let a=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,n=a>r?a:r,i=Number.parseInt(e.toFixed(n).replace(".","")),s=Number.parseInt(t.toFixed(n).replace(".",""));return i%s/10**n}var rr=class tl extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){if(this._def.coerce&&(t.data=Number(t.data)),this._getType(t)!==S.number){let n=this._getOrReturnCtx(t);return A(n,{code:E.invalid_type,expected:S.number,received:n.parsedType}),H}let a,r=new Be;for(let n of this._def.checks)n.kind==="int"?oe.isInteger(t.data)||(a=this._getOrReturnCtx(t,a),A(a,{code:E.invalid_type,expected:"integer",received:"float",message:n.message}),r.dirty()):n.kind==="min"?(n.inclusive?t.data<n.value:t.data<=n.value)&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty()):n.kind==="max"?(n.inclusive?t.data>n.value:t.data>=n.value)&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty()):n.kind==="multipleOf"?Tf(t.data,n.value)!==0&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):n.kind==="finite"?Number.isFinite(t.data)||(a=this._getOrReturnCtx(t,a),A(a,{code:E.not_finite,message:n.message}),r.dirty()):oe.assertNever(n);return{status:r.value,value:t.data}}gte(t,a){return this.setLimit("min",t,!0,C.toString(a))}gt(t,a){return this.setLimit("min",t,!1,C.toString(a))}lte(t,a){return this.setLimit("max",t,!0,C.toString(a))}lt(t,a){return this.setLimit("max",t,!1,C.toString(a))}setLimit(t,a,r,n){return new tl({...this._def,checks:[...this._def.checks,{kind:t,value:a,inclusive:r,message:C.toString(n)}]})}_addCheck(t){return new tl({...this._def,checks:[...this._def.checks,t]})}int(t){return this._addCheck({kind:"int",message:C.toString(t)})}positive(t){return this._addCheck({kind:"min",value:0,inclusive:!1,message:C.toString(t)})}negative(t){return this._addCheck({kind:"max",value:0,inclusive:!1,message:C.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:0,inclusive:!0,message:C.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:0,inclusive:!0,message:C.toString(t)})}multipleOf(t,a){return this._addCheck({kind:"multipleOf",value:t,message:C.toString(a)})}finite(t){return this._addCheck({kind:"finite",message:C.toString(t)})}safe(t){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:C.toString(t)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:C.toString(t)})}get minValue(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxValue(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}get isInt(){return!!this._def.checks.find(t=>t.kind==="int"||t.kind==="multipleOf"&&oe.isInteger(t.value))}get isFinite(){let t=null,a=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(a===null||r.value>a)&&(a=r.value):r.kind==="max"&&(t===null||r.value<t)&&(t=r.value)}return Number.isFinite(a)&&Number.isFinite(t)}};rr.create=e=>new rr({checks:[],typeName:v.ZodNumber,coerce:e?.coerce||!1,...te(e)});var nr=class al extends ae{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){if(this._def.coerce)try{t.data=BigInt(t.data)}catch{return this._getInvalidInput(t)}if(this._getType(t)!==S.bigint)return this._getInvalidInput(t);let a,r=new Be;for(let n of this._def.checks)n.kind==="min"?(n.inclusive?t.data<n.value:t.data<=n.value)&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty()):n.kind==="max"?(n.inclusive?t.data>n.value:t.data>=n.value)&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty()):n.kind==="multipleOf"?t.data%n.value!==BigInt(0)&&(a=this._getOrReturnCtx(t,a),A(a,{code:E.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):oe.assertNever(n);return{status:r.value,value:t.data}}_getInvalidInput(t){let a=this._getOrReturnCtx(t);return A(a,{code:E.invalid_type,expected:S.bigint,received:a.parsedType}),H}gte(t,a){return this.setLimit("min",t,!0,C.toString(a))}gt(t,a){return this.setLimit("min",t,!1,C.toString(a))}lte(t,a){return this.setLimit("max",t,!0,C.toString(a))}lt(t,a){return this.setLimit("max",t,!1,C.toString(a))}setLimit(t,a,r,n){return new al({...this._def,checks:[...this._def.checks,{kind:t,value:a,inclusive:r,message:C.toString(n)}]})}_addCheck(t){return new al({...this._def,checks:[...this._def.checks,t]})}positive(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:C.toString(t)})}negative(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:C.toString(t)})}nonpositive(t){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:C.toString(t)})}nonnegative(t){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:C.toString(t)})}multipleOf(t,a){return this._addCheck({kind:"multipleOf",value:t,message:C.toString(a)})}get minValue(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t}get maxValue(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t}};nr.create=e=>new nr({checks:[],typeName:v.ZodBigInt,coerce:e?.coerce??!1,...te(e)});var ir=class extends ae{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==S.boolean){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.boolean,received:t.parsedType}),H}return Ue(e.data)}};ir.create=e=>new ir({typeName:v.ZodBoolean,coerce:e?.coerce||!1,...te(e)});var sr=class Rh extends ae{_parse(t){if(this._def.coerce&&(t.data=new Date(t.data)),this._getType(t)!==S.date){let n=this._getOrReturnCtx(t);return A(n,{code:E.invalid_type,expected:S.date,received:n.parsedType}),H}if(Number.isNaN(t.data.getTime())){let n=this._getOrReturnCtx(t);return A(n,{code:E.invalid_date}),H}let a=new Be,r;for(let n of this._def.checks)n.kind==="min"?t.data.getTime()<n.value&&(r=this._getOrReturnCtx(t,r),A(r,{code:E.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),a.dirty()):n.kind==="max"?t.data.getTime()>n.value&&(r=this._getOrReturnCtx(t,r),A(r,{code:E.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),a.dirty()):oe.assertNever(n);return{status:a.value,value:new Date(t.data.getTime())}}_addCheck(t){return new Rh({...this._def,checks:[...this._def.checks,t]})}min(t,a){return this._addCheck({kind:"min",value:t.getTime(),message:C.toString(a)})}max(t,a){return this._addCheck({kind:"max",value:t.getTime(),message:C.toString(a)})}get minDate(){let t=null;for(let a of this._def.checks)a.kind==="min"&&(t===null||a.value>t)&&(t=a.value);return t!=null?new Date(t):null}get maxDate(){let t=null;for(let a of this._def.checks)a.kind==="max"&&(t===null||a.value<t)&&(t=a.value);return t!=null?new Date(t):null}};sr.create=e=>new sr({checks:[],coerce:e?.coerce||!1,typeName:v.ZodDate,...te(e)});var dn=class extends ae{_parse(e){if(this._getType(e)!==S.symbol){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.symbol,received:t.parsedType}),H}return Ue(e.data)}};dn.create=e=>new dn({typeName:v.ZodSymbol,...te(e)});var or=class extends ae{_parse(e){if(this._getType(e)!==S.undefined){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.undefined,received:t.parsedType}),H}return Ue(e.data)}};or.create=e=>new or({typeName:v.ZodUndefined,...te(e)});var lr=class extends ae{_parse(e){if(this._getType(e)!==S.null){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.null,received:t.parsedType}),H}return Ue(e.data)}};lr.create=e=>new lr({typeName:v.ZodNull,...te(e)});var Pa=class extends ae{constructor(){super(...arguments),this._any=!0}_parse(e){return Ue(e.data)}};Pa.create=e=>new Pa({typeName:v.ZodAny,...te(e)});var ca=class extends ae{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ue(e.data)}};ca.create=e=>new ca({typeName:v.ZodUnknown,...te(e)});var Ut=class extends ae{_parse(e){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.never,received:t.parsedType}),H}};Ut.create=e=>new Ut({typeName:v.ZodNever,...te(e)});var hn=class extends ae{_parse(e){if(this._getType(e)!==S.undefined){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.void,received:t.parsedType}),H}return Ue(e.data)}};hn.create=e=>new hn({typeName:v.ZodVoid,...te(e)});var da=class Ni extends ae{_parse(t){let{ctx:a,status:r}=this._processInputParams(t),n=this._def;if(a.parsedType!==S.array)return A(a,{code:E.invalid_type,expected:S.array,received:a.parsedType}),H;if(n.exactLength!==null){let s=a.data.length>n.exactLength.value,o=a.data.length<n.exactLength.value;(s||o)&&(A(a,{code:s?E.too_big:E.too_small,minimum:o?n.exactLength.value:void 0,maximum:s?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(n.minLength!==null&&a.data.length<n.minLength.value&&(A(a,{code:E.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),n.maxLength!==null&&a.data.length>n.maxLength.value&&(A(a,{code:E.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),a.common.async)return Promise.all([...a.data].map((s,o)=>n.type._parseAsync(new vt(a,s,a.path,o)))).then(s=>Be.mergeArray(r,s));let i=[...a.data].map((s,o)=>n.type._parseSync(new vt(a,s,a.path,o)));return Be.mergeArray(r,i)}get element(){return this._def.type}min(t,a){return new Ni({...this._def,minLength:{value:t,message:C.toString(a)}})}max(t,a){return new Ni({...this._def,maxLength:{value:t,message:C.toString(a)}})}length(t,a){return new Ni({...this._def,exactLength:{value:t,message:C.toString(a)}})}nonempty(t){return this.min(1,t)}};da.create=(e,t)=>new da({type:e,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...te(t)});function $a(e){if(e instanceof et){let t={};for(let a in e.shape){let r=e.shape[a];t[a]=wt.create($a(r))}return new et({...e._def,shape:()=>t})}else return e instanceof da?new da({...e._def,type:$a(e.element)}):e instanceof wt?wt.create($a(e.unwrap())):e instanceof Wt?Wt.create($a(e.unwrap())):e instanceof Gt?Gt.create(e.items.map(t=>$a(t))):e}var et=class bt extends ae{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let t=this._def.shape(),a=oe.objectKeys(t);return this._cached={shape:t,keys:a},this._cached}_parse(t){if(this._getType(t)!==S.object){let l=this._getOrReturnCtx(t);return A(l,{code:E.invalid_type,expected:S.object,received:l.parsedType}),H}let{status:a,ctx:r}=this._processInputParams(t),{shape:n,keys:i}=this._getCached(),s=[];if(!(this._def.catchall instanceof Ut&&this._def.unknownKeys==="strip"))for(let l in r.data)i.includes(l)||s.push(l);let o=[];for(let l of i){let u=n[l],c=r.data[l];o.push({key:{status:"valid",value:l},value:u._parse(new vt(r,c,r.path,l)),alwaysSet:l in r.data})}if(this._def.catchall instanceof Ut){let l=this._def.unknownKeys;if(l==="passthrough")for(let u of s)o.push({key:{status:"valid",value:u},value:{status:"valid",value:r.data[u]}});else if(l==="strict")s.length>0&&(A(r,{code:E.unrecognized_keys,keys:s}),a.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let l=this._def.catchall;for(let u of s){let c=r.data[u];o.push({key:{status:"valid",value:u},value:l._parse(new vt(r,c,r.path,u)),alwaysSet:u in r.data})}}return r.common.async?Promise.resolve().then(async()=>{let l=[];for(let u of o){let c=await u.key,d=await u.value;l.push({key:c,value:d,alwaysSet:u.alwaysSet})}return l}).then(l=>Be.mergeObjectSync(a,l)):Be.mergeObjectSync(a,o)}get shape(){return this._def.shape()}strict(t){return C.errToObj,new bt({...this._def,unknownKeys:"strict",...t!==void 0?{errorMap:(a,r)=>{let n=this._def.errorMap?.(a,r).message??r.defaultError;return a.code==="unrecognized_keys"?{message:C.errToObj(t).message??n}:{message:n}}}:{}})}strip(){return new bt({...this._def,unknownKeys:"strip"})}passthrough(){return new bt({...this._def,unknownKeys:"passthrough"})}extend(t){return new bt({...this._def,shape:()=>({...this._def.shape(),...t})})}merge(t){return new bt({unknownKeys:t._def.unknownKeys,catchall:t._def.catchall,shape:()=>({...this._def.shape(),...t._def.shape()}),typeName:v.ZodObject})}setKey(t,a){return this.augment({[t]:a})}catchall(t){return new bt({...this._def,catchall:t})}pick(t){let a={};for(let r of oe.objectKeys(t))t[r]&&this.shape[r]&&(a[r]=this.shape[r]);return new bt({...this._def,shape:()=>a})}omit(t){let a={};for(let r of oe.objectKeys(this.shape))t[r]||(a[r]=this.shape[r]);return new bt({...this._def,shape:()=>a})}deepPartial(){return $a(this)}partial(t){let a={};for(let r of oe.objectKeys(this.shape)){let n=this.shape[r];t&&!t[r]?a[r]=n:a[r]=n.optional()}return new bt({...this._def,shape:()=>a})}required(t){let a={};for(let r of oe.objectKeys(this.shape))if(t&&!t[r])a[r]=this.shape[r];else{let n=this.shape[r];for(;n instanceof wt;)n=n._def.innerType;a[r]=n}return new bt({...this._def,shape:()=>a})}keyof(){return Cl(oe.objectKeys(this.shape))}};et.create=(e,t)=>new et({shape:()=>e,unknownKeys:"strip",catchall:Ut.create(),typeName:v.ZodObject,...te(t)}),et.strictCreate=(e,t)=>new et({shape:()=>e,unknownKeys:"strict",catchall:Ut.create(),typeName:v.ZodObject,...te(t)}),et.lazycreate=(e,t)=>new et({shape:e,unknownKeys:"strip",catchall:Ut.create(),typeName:v.ZodObject,...te(t)});var ur=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),a=this._def.options;function r(n){for(let s of n)if(s.result.status==="valid")return s.result;for(let s of n)if(s.result.status==="dirty")return t.common.issues.push(...s.ctx.common.issues),s.result;let i=n.map(s=>new st(s.ctx.common.issues));return A(t,{code:E.invalid_union,unionErrors:i}),H}if(t.common.async)return Promise.all(a.map(async n=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await n._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(r);{let n,i=[];for(let o of a){let l={...t,common:{...t.common,issues:[]},parent:null},u=o._parseSync({data:t.data,path:t.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!n&&(n={result:u,ctx:l}),l.common.issues.length&&i.push(l.common.issues)}if(n)return t.common.issues.push(...n.ctx.common.issues),n.result;let s=i.map(o=>new st(o));return A(t,{code:E.invalid_union,unionErrors:s}),H}}get options(){return this._def.options}};ur.create=(e,t)=>new ur({options:e,typeName:v.ZodUnion,...te(t)});var Jt=e=>e instanceof dr?Jt(e.schema):e instanceof ot?Jt(e.innerType()):e instanceof hr?[e.value]:e instanceof pr?e.options:e instanceof fr?oe.objectValues(e.enum):e instanceof mr?Jt(e._def.innerType):e instanceof or?[void 0]:e instanceof lr?[null]:e instanceof wt?[void 0,...Jt(e.unwrap())]:e instanceof Wt?[null,...Jt(e.unwrap())]:e instanceof rs||e instanceof yr?Jt(e.unwrap()):e instanceof gr?Jt(e._def.innerType):[],jl=class Nh extends ae{_parse(t){let{ctx:a}=this._processInputParams(t);if(a.parsedType!==S.object)return A(a,{code:E.invalid_type,expected:S.object,received:a.parsedType}),H;let r=this.discriminator,n=a.data[r],i=this.optionsMap.get(n);return i?a.common.async?i._parseAsync({data:a.data,path:a.path,parent:a}):i._parseSync({data:a.data,path:a.path,parent:a}):(A(a,{code:E.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),H)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(t,a,r){let n=new Map;for(let i of a){let s=Jt(i.shape[t]);if(!s.length)throw new Error(`A discriminator value for key \`${t}\` could not be extracted from all schema options`);for(let o of s){if(n.has(o))throw new Error(`Discriminator property ${String(t)} has duplicate value ${String(o)}`);n.set(o,i)}}return new Nh({typeName:v.ZodDiscriminatedUnion,discriminator:t,options:a,optionsMap:n,...te(r)})}};function as(e,t){let a=Mt(e),r=Mt(t);if(e===t)return{valid:!0,data:e};if(a===S.object&&r===S.object){let n=oe.objectKeys(t),i=oe.objectKeys(e).filter(o=>n.indexOf(o)!==-1),s={...e,...t};for(let o of i){let l=as(e[o],t[o]);if(!l.valid)return{valid:!1};s[o]=l.data}return{valid:!0,data:s}}else if(a===S.array&&r===S.array){if(e.length!==t.length)return{valid:!1};let n=[];for(let i=0;i<e.length;i++){let s=e[i],o=t[i],l=as(s,o);if(!l.valid)return{valid:!1};n.push(l.data)}return{valid:!0,data:n}}else return a===S.date&&r===S.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}var cr=class extends ae{_parse(e){let{status:t,ctx:a}=this._processInputParams(e),r=(n,i)=>{if(Qi(n)||Qi(i))return H;let s=as(n.value,i.value);return s.valid?((es(n)||es(i))&&t.dirty(),{status:t.value,value:s.data}):(A(a,{code:E.invalid_intersection_types}),H)};return a.common.async?Promise.all([this._def.left._parseAsync({data:a.data,path:a.path,parent:a}),this._def.right._parseAsync({data:a.data,path:a.path,parent:a})]).then(([n,i])=>r(n,i)):r(this._def.left._parseSync({data:a.data,path:a.path,parent:a}),this._def.right._parseSync({data:a.data,path:a.path,parent:a}))}};cr.create=(e,t,a)=>new cr({left:e,right:t,typeName:v.ZodIntersection,...te(a)});var Gt=class Ch extends ae{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==S.array)return A(r,{code:E.invalid_type,expected:S.array,received:r.parsedType}),H;if(r.data.length<this._def.items.length)return A(r,{code:E.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),H;!this._def.rest&&r.data.length>this._def.items.length&&(A(r,{code:E.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),a.dirty());let n=[...r.data].map((i,s)=>{let o=this._def.items[s]||this._def.rest;return o?o._parse(new vt(r,i,r.path,s)):null}).filter(i=>!!i);return r.common.async?Promise.all(n).then(i=>Be.mergeArray(a,i)):Be.mergeArray(a,n)}get items(){return this._def.items}rest(t){return new Ch({...this._def,rest:t})}};Gt.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Gt({items:e,typeName:v.ZodTuple,rest:null,...te(t)})};var Rl=class rl extends ae{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==S.object)return A(r,{code:E.invalid_type,expected:S.object,received:r.parsedType}),H;let n=[],i=this._def.keyType,s=this._def.valueType;for(let o in r.data)n.push({key:i._parse(new vt(r,o,r.path,o)),value:s._parse(new vt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?Be.mergeObjectAsync(a,n):Be.mergeObjectSync(a,n)}get element(){return this._def.valueType}static create(t,a,r){return a instanceof ae?new rl({keyType:t,valueType:a,typeName:v.ZodRecord,...te(r)}):new rl({keyType:Sa.create(),valueType:t,typeName:v.ZodRecord,...te(a)})}},pn=class extends ae{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==S.map)return A(a,{code:E.invalid_type,expected:S.map,received:a.parsedType}),H;let r=this._def.keyType,n=this._def.valueType,i=[...a.data.entries()].map(([s,o],l)=>({key:r._parse(new vt(a,s,a.path,[l,"key"])),value:n._parse(new vt(a,o,a.path,[l,"value"]))}));if(a.common.async){let s=new Map;return Promise.resolve().then(async()=>{for(let o of i){let l=await o.key,u=await o.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),s.set(l.value,u.value)}return{status:t.value,value:s}})}else{let s=new Map;for(let o of i){let l=o.key,u=o.value;if(l.status==="aborted"||u.status==="aborted")return H;(l.status==="dirty"||u.status==="dirty")&&t.dirty(),s.set(l.value,u.value)}return{status:t.value,value:s}}}};pn.create=(e,t,a)=>new pn({valueType:t,keyType:e,typeName:v.ZodMap,...te(a)});var fn=class nl extends ae{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.parsedType!==S.set)return A(r,{code:E.invalid_type,expected:S.set,received:r.parsedType}),H;let n=this._def;n.minSize!==null&&r.data.size<n.minSize.value&&(A(r,{code:E.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),a.dirty()),n.maxSize!==null&&r.data.size>n.maxSize.value&&(A(r,{code:E.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),a.dirty());let i=this._def.valueType;function s(l){let u=new Set;for(let c of l){if(c.status==="aborted")return H;c.status==="dirty"&&a.dirty(),u.add(c.value)}return{status:a.value,value:u}}let o=[...r.data.values()].map((l,u)=>i._parse(new vt(r,l,r.path,u)));return r.common.async?Promise.all(o).then(l=>s(l)):s(o)}min(t,a){return new nl({...this._def,minSize:{value:t,message:C.toString(a)}})}max(t,a){return new nl({...this._def,maxSize:{value:t,message:C.toString(a)}})}size(t,a){return this.min(t,a).max(t,a)}nonempty(t){return this.min(1,t)}};fn.create=(e,t)=>new fn({valueType:e,minSize:null,maxSize:null,typeName:v.ZodSet,...te(t)});var Nl=class Ci extends ae{constructor(){super(...arguments),this.validate=this.implement}_parse(t){let{ctx:a}=this._processInputParams(t);if(a.parsedType!==S.function)return A(a,{code:E.invalid_type,expected:S.function,received:a.parsedType}),H;function r(o,l){return cn({data:o,path:a.path,errorMaps:[a.common.contextualErrorMap,a.schemaErrorMap,un(),Aa].filter(u=>!!u),issueData:{code:E.invalid_arguments,argumentsError:l}})}function n(o,l){return cn({data:o,path:a.path,errorMaps:[a.common.contextualErrorMap,a.schemaErrorMap,un(),Aa].filter(u=>!!u),issueData:{code:E.invalid_return_type,returnTypeError:l}})}let i={errorMap:a.common.contextualErrorMap},s=a.data;if(this._def.returns instanceof Ta){let o=this;return Ue(async function(...l){let u=new st([]),c=await o._def.args.parseAsync(l,i).catch(h=>{throw u.addIssue(r(l,h)),u}),d=await Reflect.apply(s,this,c);return await o._def.returns._def.type.parseAsync(d,i).catch(h=>{throw u.addIssue(n(d,h)),u})})}else{let o=this;return Ue(function(...l){let u=o._def.args.safeParse(l,i);if(!u.success)throw new st([r(l,u.error)]);let c=Reflect.apply(s,this,u.data),d=o._def.returns.safeParse(c,i);if(!d.success)throw new st([n(c,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...t){return new Ci({...this._def,args:Gt.create(t).rest(ca.create())})}returns(t){return new Ci({...this._def,returns:t})}implement(t){return this.parse(t)}strictImplement(t){return this.parse(t)}static create(t,a,r){return new Ci({args:t||Gt.create([]).rest(ca.create()),returns:a||ca.create(),typeName:v.ZodFunction,...te(r)})}},dr=class extends ae{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};dr.create=(e,t)=>new dr({getter:e,typeName:v.ZodLazy,...te(t)});var hr=class extends ae{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:E.invalid_literal,expected:this._def.value}),H}return{status:"valid",value:e.data}}get value(){return this._def.value}};hr.create=(e,t)=>new hr({value:e,typeName:v.ZodLiteral,...te(t)});function Cl(e,t){return new pr({values:e,typeName:v.ZodEnum,...te(t)})}var pr=class il extends ae{_parse(t){if(typeof t.data!="string"){let a=this._getOrReturnCtx(t),r=this._def.values;return A(a,{expected:oe.joinValues(r),received:a.parsedType,code:E.invalid_type}),H}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(t.data)){let a=this._getOrReturnCtx(t),r=this._def.values;return A(a,{received:a.data,code:E.invalid_enum_value,options:r}),H}return Ue(t.data)}get options(){return this._def.values}get enum(){let t={};for(let a of this._def.values)t[a]=a;return t}get Values(){let t={};for(let a of this._def.values)t[a]=a;return t}get Enum(){let t={};for(let a of this._def.values)t[a]=a;return t}extract(t,a=this._def){return il.create(t,{...this._def,...a})}exclude(t,a=this._def){return il.create(this.options.filter(r=>!t.includes(r)),{...this._def,...a})}};pr.create=Cl;var fr=class extends ae{_parse(e){let t=oe.getValidEnumValues(this._def.values),a=this._getOrReturnCtx(e);if(a.parsedType!==S.string&&a.parsedType!==S.number){let r=oe.objectValues(t);return A(a,{expected:oe.joinValues(r),received:a.parsedType,code:E.invalid_type}),H}if(this._cache||(this._cache=new Set(oe.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let r=oe.objectValues(t);return A(a,{received:a.data,code:E.invalid_enum_value,options:r}),H}return Ue(e.data)}get enum(){return this._def.values}};fr.create=(e,t)=>new fr({values:e,typeName:v.ZodNativeEnum,...te(t)});var Ta=class extends ae{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==S.promise&&t.common.async===!1)return A(t,{code:E.invalid_type,expected:S.promise,received:t.parsedType}),H;let a=t.parsedType===S.promise?t.data:Promise.resolve(t.data);return Ue(a.then(r=>this._def.type.parseAsync(r,{path:t.path,errorMap:t.common.contextualErrorMap})))}};Ta.create=(e,t)=>new Ta({type:e,typeName:v.ZodPromise,...te(t)});var ot=class extends ae{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:a}=this._processInputParams(e),r=this._def.effect||null,n={addIssue:i=>{A(a,i),i.fatal?t.abort():t.dirty()},get path(){return a.path}};if(n.addIssue=n.addIssue.bind(n),r.type==="preprocess"){let i=r.transform(a.data,n);if(a.common.async)return Promise.resolve(i).then(async s=>{if(t.value==="aborted")return H;let o=await this._def.schema._parseAsync({data:s,path:a.path,parent:a});return o.status==="aborted"?H:o.status==="dirty"||t.value==="dirty"?Ia(o.value):o});{if(t.value==="aborted")return H;let s=this._def.schema._parseSync({data:i,path:a.path,parent:a});return s.status==="aborted"?H:s.status==="dirty"||t.value==="dirty"?Ia(s.value):s}}if(r.type==="refinement"){let i=s=>{let o=r.refinement(s,n);if(a.common.async)return Promise.resolve(o);if(o instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return s};if(a.common.async===!1){let s=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});return s.status==="aborted"?H:(s.status==="dirty"&&t.dirty(),i(s.value),{status:t.value,value:s.value})}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(s=>s.status==="aborted"?H:(s.status==="dirty"&&t.dirty(),i(s.value).then(()=>({status:t.value,value:s.value}))))}if(r.type==="transform")if(a.common.async===!1){let i=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});if(!ua(i))return H;let s=r.transform(i.value,n);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(i=>ua(i)?Promise.resolve(r.transform(i.value,n)).then(s=>({status:t.value,value:s})):H);oe.assertNever(r)}};ot.create=(e,t,a)=>new ot({schema:e,typeName:v.ZodEffects,effect:t,...te(a)}),ot.createWithPreprocess=(e,t,a)=>new ot({schema:t,effect:{type:"preprocess",transform:e},typeName:v.ZodEffects,...te(a)});var wt=class extends ae{_parse(e){return this._getType(e)===S.undefined?Ue(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};wt.create=(e,t)=>new wt({innerType:e,typeName:v.ZodOptional,...te(t)});var Wt=class extends ae{_parse(e){return this._getType(e)===S.null?Ue(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Wt.create=(e,t)=>new Wt({innerType:e,typeName:v.ZodNullable,...te(t)});var mr=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),a=t.data;return t.parsedType===S.undefined&&(a=this._def.defaultValue()),this._def.innerType._parse({data:a,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};mr.create=(e,t)=>new mr({innerType:e,typeName:v.ZodDefault,defaultValue:typeof t.default=="function"?t.default:()=>t.default,...te(t)});var gr=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),a={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:a.data,path:a.path,parent:{...a}});return ar(r)?r.then(n=>({status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new st(a.common.issues)},input:a.data})})):{status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new st(a.common.issues)},input:a.data})}}removeCatch(){return this._def.innerType}};gr.create=(e,t)=>new gr({innerType:e,typeName:v.ZodCatch,catchValue:typeof t.catch=="function"?t.catch:()=>t.catch,...te(t)});var mn=class extends ae{_parse(e){if(this._getType(e)!==S.nan){let t=this._getOrReturnCtx(e);return A(t,{code:E.invalid_type,expected:S.nan,received:t.parsedType}),H}return{status:"valid",value:e.data}}};mn.create=e=>new mn({typeName:v.ZodNaN,...te(e)});var jf=Symbol("zod_brand"),rs=class extends ae{_parse(e){let{ctx:t}=this._processInputParams(e),a=t.data;return this._def.type._parse({data:a,path:t.path,parent:t})}unwrap(){return this._def.type}},ns=class Lh extends ae{_parse(t){let{status:a,ctx:r}=this._processInputParams(t);if(r.common.async)return(async()=>{let n=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return n.status==="aborted"?H:n.status==="dirty"?(a.dirty(),Ia(n.value)):this._def.out._parseAsync({data:n.value,path:r.path,parent:r})})();{let n=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return n.status==="aborted"?H:n.status==="dirty"?(a.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:r.path,parent:r})}}static create(t,a){return new Lh({in:t,out:a,typeName:v.ZodPipeline})}},yr=class extends ae{_parse(e){let t=this._def.innerType._parse(e),a=r=>(ua(r)&&(r.value=Object.freeze(r.value)),r);return ar(t)?t.then(r=>a(r)):a(t)}unwrap(){return this._def.innerType}};yr.create=(e,t)=>new yr({innerType:e,typeName:v.ZodReadonly,...te(t)});function Ll(e,t){let a=typeof e=="function"?e(t):typeof e=="string"?{message:e}:e;return typeof a=="string"?{message:a}:a}function Ml(e,t={},a){return e?Pa.create().superRefine((r,n)=>{let i=e(r);if(i instanceof Promise)return i.then(s=>{if(!s){let o=Ll(t,r),l=o.fatal??a??!0;n.addIssue({code:"custom",...o,fatal:l})}});if(!i){let s=Ll(t,r),o=s.fatal??a??!0;n.addIssue({code:"custom",...s,fatal:o})}}):Pa.create()}var Rf={object:et.lazycreate},v;(function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"})(v||(v={}));var Nf=(e,t={message:`Input not instance of ${e.name}`})=>Ml(a=>a instanceof e,t),Ul=Sa.create,zl=rr.create,Cf=mn.create,Lf=nr.create,Dl=ir.create,Mf=sr.create,Uf=dn.create,zf=or.create,Df=lr.create,Ff=Pa.create,Bf=ca.create,Zf=Ut.create,qf=hn.create,Hf=da.create,Jf=et.create,Gf=et.strictCreate,Wf=ur.create,Kf=jl.create,Vf=cr.create,Xf=Gt.create,Yf=Rl.create,Qf=pn.create,em=fn.create,tm=Nl.create,am=dr.create,rm=hr.create,nm=pr.create,im=fr.create,sm=Ta.create,Fl=ot.create,om=wt.create,lm=Wt.create,um=ot.createWithPreprocess,cm=ns.create,dm=()=>Ul().optional(),hm=()=>zl().optional(),pm=()=>Dl().optional(),fm={string:e=>Sa.create({...e,coerce:!0}),number:e=>rr.create({...e,coerce:!0}),boolean:e=>ir.create({...e,coerce:!0}),bigint:e=>nr.create({...e,coerce:!0}),date:e=>sr.create({...e,coerce:!0})},mm=H,Bl=rt(Mi(),1),gm=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function ym(e){return typeof e=="string"&&gm.test(e)}var _r=ym;function _m(e){if(!_r(e))throw TypeError("Invalid UUID");var t,a=new Uint8Array(16);return a[0]=(t=parseInt(e.slice(0,8),16))>>>24,a[1]=t>>>16&255,a[2]=t>>>8&255,a[3]=t&255,a[4]=(t=parseInt(e.slice(9,13),16))>>>8,a[5]=t&255,a[6]=(t=parseInt(e.slice(14,18),16))>>>8,a[7]=t&255,a[8]=(t=parseInt(e.slice(19,23),16))>>>8,a[9]=t&255,a[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,a[11]=t/4294967296&255,a[12]=t>>>24&255,a[13]=t>>>16&255,a[14]=t>>>8&255,a[15]=t&255,a}var bm=_m,Te=[];for(gn=0;gn<256;++gn)Te.push((gn+256).toString(16).slice(1));var gn;function Zl(e,t=0){return(Te[e[t+0]]+Te[e[t+1]]+Te[e[t+2]]+Te[e[t+3]]+"-"+Te[e[t+4]]+Te[e[t+5]]+"-"+Te[e[t+6]]+Te[e[t+7]]+"-"+Te[e[t+8]]+Te[e[t+9]]+"-"+Te[e[t+10]]+Te[e[t+11]]+Te[e[t+12]]+Te[e[t+13]]+Te[e[t+14]]+Te[e[t+15]]).toLowerCase()}var yn,vm=new Uint8Array(16);function wm(){if(!yn&&(yn=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yn))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yn(vm)}function Om(e){e=unescape(encodeURIComponent(e));for(var t=[],a=0;a<e.length;++a)t.push(e.charCodeAt(a));return t}var Em="6ba7b810-9dad-11d1-80b4-00c04fd430c8",km="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function xm(e,t,a){function r(n,i,s,o){var l;if(typeof n=="string"&&(n=Om(n)),typeof i=="string"&&(i=bm(i)),((l=i)===null||l===void 0?void 0:l.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var u=new Uint8Array(16+n.length);if(u.set(i),u.set(n,i.length),u=a(u),u[6]=u[6]&15|t,u[8]=u[8]&63|128,s){o=o||0;for(var c=0;c<16;++c)s[o+c]=u[c];return s}return Zl(u)}try{r.name=e}catch{}return r.DNS=Em,r.URL=km,r}var Am=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ql={randomUUID:Am};function Im(e,t,a){if(ql.randomUUID&&!t&&!e)return ql.randomUUID();e=e||{};var r=e.random||(e.rng||wm)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){a=a||0;for(var n=0;n<16;++n)t[a+n]=r[n];return t}return Zl(r)}var ze=Im;function Sm(e,t,a,r){switch(e){case 0:return t&a^~t&r;case 1:return t^a^r;case 2:return t&a^t&r^a&r;case 3:return t^a^r}}function is(e,t){return e<<t|e>>>32-t}function Pm(e){var t=[1518500249,1859775393,2400959708,3395469782],a=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof e=="string"){var r=unescape(encodeURIComponent(e));e=[];for(var n=0;n<r.length;++n)e.push(r.charCodeAt(n))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,s=Math.ceil(i/16),o=new Array(s),l=0;l<s;++l){for(var u=new Uint32Array(16),c=0;c<16;++c)u[c]=e[l*64+c*4]<<24|e[l*64+c*4+1]<<16|e[l*64+c*4+2]<<8|e[l*64+c*4+3];o[l]=u}o[s-1][14]=(e.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(e.length-1)*8&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var f=16;f<80;++f)h[f]=is(h[f-3]^h[f-8]^h[f-14]^h[f-16],1);for(var m=a[0],g=a[1],_=a[2],y=a[3],b=a[4],w=0;w<80;++w){var O=Math.floor(w/20),I=is(m,5)+Sm(O,g,_,y)+b+t[O]+h[w]>>>0;b=y,y=_,_=is(g,30)>>>0,g=m,m=I}a[0]=a[0]+m>>>0,a[1]=a[1]+g>>>0,a[2]=a[2]+_>>>0,a[3]=a[3]+y>>>0,a[4]=a[4]+b>>>0}return[a[0]>>24&255,a[0]>>16&255,a[0]>>8&255,a[0]&255,a[1]>>24&255,a[1]>>16&255,a[1]>>8&255,a[1]&255,a[2]>>24&255,a[2]>>16&255,a[2]>>8&255,a[2]&255,a[3]>>24&255,a[3]>>16&255,a[3]>>8&255,a[3]&255,a[4]>>24&255,a[4]>>16&255,a[4]>>8&255,a[4]&255]}var $m=Pm,Tm=xm("v5",80,$m),Hl=Tm,jm=class{getStore(){}run(e,t){return t()}},ss=Symbol.for("ls:tracing_async_local_storage"),Rm=new jm,Nm=class{getInstance(){return globalThis[ss]??Rm}initializeGlobalInstance(e){globalThis[ss]===void 0&&(globalThis[ss]=e)}},Cm=new Nm;function Lm(e=!1){let t=Cm.getInstance().getStore();if(!e&&t===void 0)throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return t}var qw=Symbol.for("langsmith:traceable:root");function os(e){return typeof e=="function"&&"langsmith:traceable"in e}var Jl={};pl(Jl,{JsonPatchError:()=>be,_areEquals:()=>vr,applyOperation:()=>pa,applyPatch:()=>br,applyReducer:()=>Dm,deepClone:()=>Um,getValueByPointer:()=>_n,validate:()=>Vl,validator:()=>bn});var Mm=Object.prototype.hasOwnProperty;function ls(e,t){return Mm.call(e,t)}function us(e){if(Array.isArray(e)){let a=new Array(e.length);for(let r=0;r<a.length;r++)a[r]=""+r;return a}if(Object.keys)return Object.keys(e);let t=[];for(let a in e)ls(e,a)&&t.push(a);return t}function tt(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function cs(e){let t=0,a=e.length,r;for(;t<a;){if(r=e.charCodeAt(t),r>=48&&r<=57){t++;continue}return!1}return!0}function ha(e){return e.indexOf("/")===-1&&e.indexOf("~")===-1?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Gl(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function ds(e){if(e===void 0)return!0;if(e){if(Array.isArray(e)){for(let a=0,r=e.length;a<r;a++)if(ds(e[a]))return!0}else if(typeof e=="object"){let a=us(e),r=a.length;for(var t=0;t<r;t++)if(ds(e[a[t]]))return!0}}return!1}function Wl(e,t){let a=[e];for(let r in t){let n=typeof t[r]=="object"?JSON.stringify(t[r],null,2):t[r];typeof n<"u"&&a.push(`${r}: ${n}`)}return a.join(`
`)}var Kl=class extends Error{constructor(e,t,a,r,n){super(Wl(e,{name:t,index:a,operation:r,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=Wl(e,{name:t,index:a,operation:r,tree:n})}},be=Kl,Um=tt,ja={add:function(e,t,a){return e[t]=this.value,{newDocument:a}},remove:function(e,t,a){var r=e[t];return delete e[t],{newDocument:a,removed:r}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:function(e,t,a){let r=_n(a,this.path);r&&(r=tt(r));let n=pa(a,{op:"remove",path:this.from}).removed;return pa(a,{op:"add",path:this.path,value:n}),{newDocument:a,removed:r}},copy:function(e,t,a){let r=_n(a,this.from);return pa(a,{op:"add",path:this.path,value:tt(r)}),{newDocument:a}},test:function(e,t,a){return{newDocument:a,test:vr(e[t],this.value)}},_get:function(e,t,a){return this.value=e[t],{newDocument:a}}},zm={add:function(e,t,a){return cs(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:a,index:t}},remove:function(e,t,a){var r=e.splice(t,1);return{newDocument:a,removed:r[0]}},replace:function(e,t,a){var r=e[t];return e[t]=this.value,{newDocument:a,removed:r}},move:ja.move,copy:ja.copy,test:ja.test,_get:ja._get};function _n(e,t){if(t=="")return e;var a={op:"_get",path:t};return pa(e,a),a.value}function pa(e,t,a=!1,r=!0,n=!0,i=0){if(a&&(typeof a=="function"?a(t,0,e,t.path):bn(t,0)),t.path===""){let s={newDocument:e};if(t.op==="add")return s.newDocument=t.value,s;if(t.op==="replace")return s.newDocument=t.value,s.removed=e,s;if(t.op==="move"||t.op==="copy")return s.newDocument=_n(e,t.from),t.op==="move"&&(s.removed=e),s;if(t.op==="test"){if(s.test=vr(e,t.value),s.test===!1)throw new be("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return s.newDocument=e,s}else{if(t.op==="remove")return s.removed=e,s.newDocument=null,s;if(t.op==="_get")return t.value=e,s;if(a)throw new be("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return s}}else{r||(e=tt(e));let s=(t.path||"").split("/"),o=e,l=1,u=s.length,c,d,h;for(typeof a=="function"?h=a:h=bn;;){if(d=s[l],d&&d.indexOf("~")!=-1&&(d=Gl(d)),n&&(d=="__proto__"||d=="prototype"&&l>0&&s[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(a&&c===void 0&&(o[d]===void 0?c=s.slice(0,l).join("/"):l==u-1&&(c=t.path),c!==void 0&&h(t,0,e,c)),l++,Array.isArray(o)){if(d==="-")d=o.length;else{if(a&&!cs(d))throw new be("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);cs(d)&&(d=~~d)}if(l>=u){if(a&&t.op==="add"&&d>o.length)throw new be("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);let p=zm[t.op].call(t,o,d,e);if(p.test===!1)throw new be("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return p}}else if(l>=u){let p=ja[t.op].call(t,o,d,e);if(p.test===!1)throw new be("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return p}if(o=o[d],a&&l<u&&(!o||typeof o!="object"))throw new be("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function br(e,t,a,r=!0,n=!0){if(a&&!Array.isArray(t))throw new be("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=tt(e));let i=new Array(t.length);for(let s=0,o=t.length;s<o;s++)i[s]=pa(e,t[s],a,!0,n,s),e=i[s].newDocument;return i.newDocument=e,i}function Dm(e,t,a){let r=pa(e,t);if(r.test===!1)throw new be("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument}function bn(e,t,a,r){if(typeof e!="object"||e===null||Array.isArray(e))throw new be("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,a);if(ja[e.op]){if(typeof e.path!="string")throw new be("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,a);if(e.path.indexOf("/")!==0&&e.path.length>0)throw new be('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,a);if((e.op==="move"||e.op==="copy")&&typeof e.from!="string")throw new be("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,a);if((e.op==="add"||e.op==="replace"||e.op==="test")&&e.value===void 0)throw new be("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,a);if((e.op==="add"||e.op==="replace"||e.op==="test")&&ds(e.value))throw new be("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,a);if(a){if(e.op=="add"){var n=e.path.split("/").length,i=r.split("/").length;if(n!==i+1&&n!==i)throw new be("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,a)}else if(e.op==="replace"||e.op==="remove"||e.op==="_get"){if(e.path!==r)throw new be("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,a)}else if(e.op==="move"||e.op==="copy"){var s={op:"_get",path:e.from,value:void 0},o=Vl([s],a);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new be("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,a)}}}else throw new be("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,a)}function Vl(e,t,a){try{if(!Array.isArray(e))throw new be("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)br(tt(t),tt(e),a||!0);else{a=a||bn;for(var r=0;r<e.length;r++)a(e[r],r,t,void 0)}}catch(n){if(n instanceof be)return n;throw n}}function vr(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){var a=Array.isArray(e),r=Array.isArray(t),n,i,s;if(a&&r){if(i=e.length,i!=t.length)return!1;for(n=i;n--!==0;)if(!vr(e[n],t[n]))return!1;return!0}if(a!=r)return!1;var o=Object.keys(e);if(i=o.length,i!==Object.keys(t).length)return!1;for(n=i;n--!==0;)if(!t.hasOwnProperty(o[n]))return!1;for(n=i;n--!==0;)if(s=o[n],!vr(e[s],t[s]))return!1;return!0}return e!==e&&t!==t}function Xl(e,t,a,r,n){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var i=us(t),s=us(e),o=!1,l=!1,u=s.length-1;u>=0;u--){var c=s[u],d=e[c];if(ls(t,c)&&!(t[c]===void 0&&d!==void 0&&Array.isArray(t)===!1)){var h=t[c];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?Xl(d,h,a,r+"/"+ha(c),n):d!==h&&(o=!0,n&&a.push({op:"test",path:r+"/"+ha(c),value:tt(d)}),a.push({op:"replace",path:r+"/"+ha(c),value:tt(h)}))}else Array.isArray(e)===Array.isArray(t)?(n&&a.push({op:"test",path:r+"/"+ha(c),value:tt(d)}),a.push({op:"remove",path:r+"/"+ha(c)}),l=!0):(n&&a.push({op:"test",path:r,value:e}),a.push({op:"replace",path:r,value:t}),o=!0)}if(!(!l&&i.length==s.length))for(var u=0;u<i.length;u++){var c=i[u];!ls(e,c)&&t[c]!==void 0&&a.push({op:"add",path:r+"/"+ha(c),value:tt(t[c])})}}}function Fm(e,t,a=!1){var r=[];return Xl(e,t,r,"",a),r}var Hw={...Jl,JsonPatchError:Kl,deepClone:tt,escapePathComponent:ha,unescapePathComponent:Gl},Bm="gen_ai.operation.name",Zm="gen_ai.system",Yl="gen_ai.request.model",qm="gen_ai.response.model",Ql="gen_ai.usage.input_tokens",eu="gen_ai.usage.output_tokens",tu="gen_ai.usage.total_tokens",Hm="gen_ai.request.max_tokens",Jm="gen_ai.request.temperature",Gm="gen_ai.request.top_p",Wm="gen_ai.request.frequency_penalty",Km="gen_ai.request.presence_penalty",Vm="gen_ai.response.finish_reasons",Xm="gen_ai.prompt",Ym="gen_ai.completion",Qm="gen_ai.request.extra_query",eg="gen_ai.request.extra_body",tg="gen_ai.serialized.name",ag="gen_ai.serialized.signature",rg="gen_ai.serialized.doc",ng="gen_ai.response.id",ig="gen_ai.response.service_tier",sg="gen_ai.response.system_fingerprint",og="gen_ai.usage.input_token_details",lg="gen_ai.usage.output_token_details",ug="langsmith.trace.session_id",cg="langsmith.trace.session_name",dg="langsmith.span.kind",hg="langsmith.trace.name",pg="langsmith.metadata",au="langsmith.span.tags",fg="langsmith.request.streaming",mg="langsmith.request.headers",gg=(...e)=>fetch(...e),ru=Symbol.for("ls:fetch_implementation"),yg=()=>{let e=globalThis[ru];return e?typeof e=="function"&&"Headers"in e&&"Request"in e&&"Response"in e:!1},_g=e=>async(...t)=>{if(e||Ze("DEBUG")==="true"){let[r,n]=t;console.log(`\u2192 ${n?.method||"GET"} ${r}`)}let a=await(globalThis[ru]??gg)(...t);return(e||Ze("DEBUG")==="true")&&console.log(`\u2190 ${a.status} ${a.statusText} ${a.url}`),a},nu=()=>Ze("PROJECT")??Ot("LANGCHAIN_SESSION")??"default",iu="0.3.77",zt,bg=()=>typeof window<"u"&&typeof window.document<"u",vg=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",wg=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),su=()=>typeof Deno<"u",Og=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!su(),ou=()=>zt||(typeof Bun<"u"?zt="bun":bg()?zt="browser":Og()?zt="node":vg()?zt="webworker":wg()?zt="jsdom":su()?zt="deno":zt="other",zt),hs;function lu(){if(hs===void 0){let e=ou(),t=kg();hs={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:iu,...t}}return hs}function uu(){let e=Eg(),t={},a=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[r,n]of Object.entries(e))typeof n=="string"&&!a.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?t.revision_id=n:t[r]=n);return t}function Eg(){let e={};try{if(typeof process<"u"&&process.env)for(let[t,a]of Object.entries(process.env))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&a!=null&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&typeof a=="string"?e[t]=a.slice(0,2)+"*".repeat(a.length-4)+a.slice(-2):e[t]=a)}catch{}return e}function Ot(e){try{return typeof process<"u"?process.env?.[e]:void 0}catch{return}}function Ze(e){return Ot(`LANGSMITH_${e}`)||Ot(`LANGCHAIN_${e}`)}var ps;function kg(){if(ps!==void 0)return ps;let e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(let a of e){let r=Ot(a);r!==void 0&&(t[a]=r)}return ps=t,t}function cu(){return Ot("OTEL_ENABLED")==="true"||Ze("OTEL_ENABLED")==="true"}var xg=class{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){!this.hasWarned&&cu()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0);let a;if(t.length===1&&typeof t[0]=="function"?a=t[0]:t.length===2&&typeof t[1]=="function"?a=t[1]:t.length===3&&typeof t[2]=="function"&&(a=t[2]),typeof a=="function")return a()}},Ag=class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new xg})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},Ig=class{active(){return{}}with(e,t){return t()}},fs=Symbol.for("ls:otel_trace"),ms=Symbol.for("ls:otel_context"),du=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),Sg=new Ag,Pg=new Ig,$g=class{getTraceInstance(){return globalThis[fs]??Sg}getContextInstance(){return globalThis[ms]??Pg}initializeGlobalInstances(e){globalThis[fs]===void 0&&(globalThis[fs]=e.trace),globalThis[ms]===void 0&&(globalThis[ms]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[du]=e}getDefaultOTLPTracerComponents(){return globalThis[du]??void 0}},gs=new $g;function hu(){return gs.getTraceInstance()}function Tg(){return gs.getContextInstance()}function jg(){return gs.getDefaultOTLPTracerComponents()}var Rg={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};function Ng(e){return Rg[e]||e}var Cg=class{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(let a of e)try{if(!a.run)continue;if(a.operation==="post"){let r=this.createSpanForRun(a,a.run,t.get(a.id));r&&!a.run.end_time&&this.spans.set(a.id,r)}else this.updateSpanForRun(a,a.run)}catch(r){console.error(`Error processing operation ${a.id}:`,r)}}createSpanForRun(e,t,a){let r=a&&hu().getSpan(a);if(r)try{return this.finishSpanSetup(r,t,e)}catch(n){console.error(`Failed to create span for run ${e.id}:`,n);return}}finishSpanSetup(e,t,a){return this.setSpanAttributes(e,t,a),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{let a=this.spans.get(e.id);if(!a){console.debug(`No span found for run ${e.id} during update`);return}this.setSpanAttributes(a,t,e),t.error?(a.setStatus({code:2}),a.recordException(new Error(t.error))):a.setStatus({code:1});let r=t.end_time;r&&(a.end(new Date(r)),this.spans.delete(e.id))}catch(a){console.error(`Failed to update span for run ${e.id}:`,a)}}extractModelName(e){if(e.extra?.metadata){let t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){let a=t.invocation_params;if(a.model)return a.model;if(a.model_name)return a.model_name}}}setSpanAttributes(e,t,a){if("run_type"in t&&t.run_type){e.setAttribute(dg,t.run_type);let s=Ng(t.run_type||"chain");e.setAttribute(Bm,s)}"name"in t&&t.name&&e.setAttribute(hg,t.name),"session_id"in t&&t.session_id&&e.setAttribute(ug,t.session_id),"session_name"in t&&t.session_name&&e.setAttribute(cg,t.session_name),this.setGenAiSystem(e,t);let r=this.extractModelName(t);r&&e.setAttribute(Yl,r),"prompt_tokens"in t&&typeof t.prompt_tokens=="number"&&e.setAttribute(Ql,t.prompt_tokens),"completion_tokens"in t&&typeof t.completion_tokens=="number"&&e.setAttribute(eu,t.completion_tokens),"total_tokens"in t&&typeof t.total_tokens=="number"&&e.setAttribute(tu,t.total_tokens),this.setInvocationParameters(e,t);let n=t.extra?.metadata||{};for(let[s,o]of Object.entries(n))o!=null&&e.setAttribute(`${pg}.${s}`,String(o));let i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(au,i.join(", ")):i&&e.setAttribute(au,String(i)),"serialized"in t&&typeof t.serialized=="object"){let s=t.serialized;s.name&&e.setAttribute(tg,String(s.name)),s.signature&&e.setAttribute(ag,String(s.signature)),s.doc&&e.setAttribute(rg,String(s.doc))}this.setIOAttributes(e,a)}setGenAiSystem(e,t){let a="langchain",r=this.extractModelName(t);if(r){let n=r.toLowerCase();n.includes("anthropic")||n.startsWith("claude")?a="anthropic":n.includes("bedrock")?a="aws.bedrock":n.includes("azure")&&n.includes("openai")?a="az.ai.openai":n.includes("azure")&&n.includes("inference")?a="az.ai.inference":n.includes("cohere")?a="cohere":n.includes("deepseek")?a="deepseek":n.includes("gemini")?a="gemini":n.includes("groq")?a="groq":n.includes("watson")||n.includes("ibm")?a="ibm.watsonx.ai":n.includes("mistral")?a="mistral_ai":n.includes("gpt")||n.includes("openai")?a="openai":n.includes("perplexity")||n.includes("sonar")?a="perplexity":n.includes("vertex")?a="vertex_ai":(n.includes("xai")||n.includes("grok"))&&(a="xai")}e.setAttribute(Zm,a)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;let a=t.extra.metadata.invocation_params;a.max_tokens!==void 0&&e.setAttribute(Hm,a.max_tokens),a.temperature!==void 0&&e.setAttribute(Jm,a.temperature),a.top_p!==void 0&&e.setAttribute(Gm,a.top_p),a.frequency_penalty!==void 0&&e.setAttribute(Wm,a.frequency_penalty),a.presence_penalty!==void 0&&e.setAttribute(Km,a.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{let a=t.run.inputs;typeof a=="object"&&a!==null&&(a.model&&Array.isArray(a.messages)&&e.setAttribute(Yl,a.model),a.stream!==void 0&&e.setAttribute(fg,a.stream),a.extra_headers&&e.setAttribute(mg,JSON.stringify(a.extra_headers)),a.extra_query&&e.setAttribute(Qm,JSON.stringify(a.extra_query)),a.extra_body&&e.setAttribute(eg,JSON.stringify(a.extra_body))),e.setAttribute(Xm,JSON.stringify(a))}catch(a){console.debug(`Failed to process inputs for run ${t.id}`,a)}if(t.run.outputs)try{let a=t.run.outputs,r=this.getUnifiedRunTokens(a);if(r&&(e.setAttribute(Ql,r[0]),e.setAttribute(eu,r[1]),e.setAttribute(tu,r[0]+r[1])),a&&typeof a=="object"){if(a.model&&e.setAttribute(qm,String(a.model)),a.id&&e.setAttribute(ng,a.id),a.choices&&Array.isArray(a.choices)){let n=a.choices.map(i=>i.finish_reason).filter(i=>i).map(String);n.length>0&&e.setAttribute(Vm,n.join(", "))}if(a.service_tier&&e.setAttribute(ig,a.service_tier),a.system_fingerprint&&e.setAttribute(sg,a.system_fingerprint),a.usage_metadata&&typeof a.usage_metadata=="object"){let n=a.usage_metadata;n.input_token_details&&e.setAttribute(og,JSON.stringify(n.input_token_details)),n.output_token_details&&e.setAttribute(lg,JSON.stringify(n.output_token_details))}}e.setAttribute(Ym,JSON.stringify(a))}catch(a){console.debug(`Failed to process outputs for run ${t.id}`,a)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;let a=Object.keys(e);for(let i of a){let s=e[i];if(!(!s||typeof s!="object")&&(t=this.extractUnifiedRunTokens(s.usage_metadata),t||s.lc===1&&s.kwargs&&typeof s.kwargs=="object"&&(t=this.extractUnifiedRunTokens(s.kwargs.usage_metadata),t)))return t}let r=e.generations||[];if(!Array.isArray(r))return null;let n=Array.isArray(r[0])?r.flat():r;for(let i of n)if(typeof i=="object"&&i.message&&typeof i.message=="object"&&i.message.kwargs&&typeof i.message.kwargs=="object"&&(t=this.extractUnifiedRunTokens(i.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return!e||typeof e!="object"||typeof e.input_tokens!="number"||typeof e.output_tokens!="number"?null:[e.input_tokens,e.output_tokens]}},Lg=rt(Mi(),1),ys=rt(Ui(),1),Mg=[429,500,502,503,504],pu=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in ys.default?this.queue=new ys.default.default({concurrency:this.maxConcurrency}):this.queue=new ys.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let a=this.onFailedResponseHook;return this.queue.add(()=>(0,Lg.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{async onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.name==="TimeoutError"||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let n=r?.response;if(a&&await a(n))return;let i=n?.status??r?.status;if(i&&!Mg.includes(+i))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise((r,n)=>{e.signal?.addEventListener("abort",()=>{n(new Error("AbortError"))})})]):this.call(t,...a)}};function fu(e){return typeof e?._getType=="function"}function mu(e){let t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var Ug=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function ee(e,t){if(!Ug.test(e)){let a=t!==void 0?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`;throw new Error(a)}return e}var gu={};function _s(e){gu[e]||(console.warn(e),gu[e]=!0)}var Jw=rt(Mp(),1);function Kt(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);let[t,a]=e.split(":"),r=a||"latest";if(t.includes("/")){let[n,i]=t.split("/",2);if(!n||!i)throw new Error(`Invalid identifier format: ${e}`);return[n,i,r]}else{if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}}var zg=class extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}};async function F(e,t,a){let r;if(e.ok){a&&(r=await e.text());return}if(e.status===403)try{(await e.json())?.error==="org_scoped_key_requires_workspace"&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch{let s=new Error(`${e.status} ${e.statusText}`);throw s.status=e?.status,s}if(r===void 0)try{r=await e.text()}catch{r=""}let n=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${r}`;if(e.status===409)throw new zg(n);let i=new Error(n);throw i.status=e.status,i}var yu="ERR_CONFLICTING_ENDPOINTS",Dg=class extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:yu}),this.name="ConflictingEndpointsError"}};function Fg(e){return typeof e=="object"&&e!==null&&e.code===yu}var _u="[...]",Bg={result:"[Circular]"},vn=[],Ra=[],Zg=new TextEncoder;function qg(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function wn(e){return Zg.encode(e)}function bu(e){if(e&&typeof e=="object"&&e!==null){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if(typeof e=="bigint")return e.toString();return e}function Hg(e){return function(t,a){if(e){let r=e.call(this,t,a);if(r!==void 0)return r}return bu(a)}}function Ke(e,t,a,r,n){try{let i=JSON.stringify(e,Hg(a),r);return wn(i)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),wn("[Unserializable]");Ze("SUPPRESS_CIRCULAR_JSON_WARNINGS")!=="true"&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),typeof n>"u"&&(n=qg()),vs(e,"",0,[],void 0,0,n);let s;try{Ra.length===0?s=JSON.stringify(e,a,r):s=JSON.stringify(e,Jg(a),r)}catch{return wn("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;vn.length!==0;){let o=vn.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return wn(s)}}function bs(e,t,a,r){var n=Object.getOwnPropertyDescriptor(r,a);n.get!==void 0?n.configurable?(Object.defineProperty(r,a,{value:e}),vn.push([r,a,t,n])):Ra.push([t,a,e]):(r[a]=e,vn.push([r,a,t]))}function vs(e,t,a,r,n,i,s){i+=1;var o;if(typeof e=="object"&&e!==null){for(o=0;o<r.length;o++)if(r[o]===e){bs(Bg,e,t,n);return}if(typeof s.depthLimit<"u"&&i>s.depthLimit){bs(_u,e,t,n);return}if(typeof s.edgesLimit<"u"&&a+1>s.edgesLimit){bs(_u,e,t,n);return}if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)vs(e[o],o,o,r,e,i,s);else{e=bu(e);var l=Object.keys(e);for(o=0;o<l.length;o++){var u=l[o];vs(e[u],u,o,r,e,i,s)}}r.pop()}}function Jg(e){return e=typeof e<"u"?e:function(t,a){return a},function(t,a){if(Ra.length>0)for(var r=0;r<Ra.length;r++){var n=Ra[r];if(n[1]===t&&n[0]===a){a=n[2],Ra.splice(r,1);break}}return e.call(this,t,a)}}function vu(e,t){let a=lu(),r=t??uu(),n=e.extra??{},i=n.metadata;return e.extra={...n,runtime:{...a,...n?.runtime},metadata:{...r,...r.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??r.revision_id}:{},...i}},e}var Gg=e=>{let t=e?.toString()??Ze("TRACING_SAMPLING_RATE");if(t===void 0)return;let a=parseFloat(t);if(a<0||a>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${a}`);return a},Wg=e=>{let t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function Kg(e){let t=[];for await(let a of e)t.push(a);return t}function On(e){if(e!==void 0)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var Vg=async e=>{if(e?.status===429){let t=parseInt(e.headers.get("retry-after")??"10",10)*1e3;if(t>0)return await new Promise(a=>setTimeout(a,t)),!0}return!1};function wu(e){return typeof e=="number"?Number(e.toFixed(4)):e}var Xg=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,a=new Promise(n=>{t=n}),r=Ke(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:a,size:r}),this.sizeBytes+=r,a}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let a=[],r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0&&a.length<t;){let n=this.items.shift();n&&(a.push(n),r+=n.size,this.sizeBytes-=n.size)}if(a.length===0&&this.items.length>0){let n=this.items.shift();a.push(n),r+=n.size,this.sizeBytes-=n.size}return[a.map(n=>({action:n.action,item:n.payload,otelContext:n.otelContext,apiKey:n.apiKey,apiUrl:n.apiUrl})),()=>a.forEach(n=>n.itemPromiseResolve())]}},Yg=24*1024*1024,Qg=1e4,ey=100,Ou="https://api.smith.langchain.com",Eu=class sl{get _fetch(){return this.fetchImplementation||_g(this.debug)}constructor(t={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Xg}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Ot("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Ot("LANGSMITH_DEBUG")==="true"});let a=sl.getDefaultClientConfig();if(this.tracingSampleRate=Gg(t.tracingSamplingRate),this.apiUrl=On(t.apiUrl??a.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=On(t.apiKey??a.apiKey),this.webUrl=On(t.webUrl??a.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=On(t.workspaceId??Ze("WORKSPACE_ID")),this.timeout_ms=t.timeout_ms??9e4,this.caller=new pu({...t.callerOptions??{},maxRetries:4,debug:t.debug??this.debug}),this.traceBatchConcurrency=t.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=t.debug??this.debug,this.fetchImplementation=t.fetchImplementation,this.batchIngestCaller=new pu({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...t.callerOptions??{},onFailedResponseHook:Vg,debug:t.debug??this.debug}),this.hideInputs=t.hideInputs??t.anonymizer??a.hideInputs,this.hideOutputs=t.hideOutputs??t.anonymizer??a.hideOutputs,this.autoBatchTracing=t.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=t.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=t.batchSizeBytesLimit,this.batchSizeLimit=t.batchSizeLimit,this.fetchOptions=t.fetchOptions||{},this.manualFlushMode=t.manualFlushMode??this.manualFlushMode,cu()&&(this.langSmithToOTELTranslator=new Cg),this.cachedLSEnvVarsForMetadata=uu()}static getDefaultClientConfig(){let t=Ze("API_KEY"),a=Ze("ENDPOINT")??Ou,r=Ze("HIDE_INPUTS")==="true",n=Ze("HIDE_OUTPUTS")==="true";return{apiUrl:a,apiKey:t,webUrl:void 0,hideInputs:r,hideOutputs:n}}getHostUrl(){return this.webUrl?this.webUrl:Wg(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let t={"User-Agent":`langsmith-js/${iu}`};return this.apiKey&&(t["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(t["x-tenant-id"]=this.workspaceId),t}_getPlatformEndpointPath(t){return this.apiUrl.slice(-3)!=="/v1"&&this.apiUrl.slice(-4)!=="/v1/"?`/v1/platform/${t}`:`/platform/${t}`}async processInputs(t){return this.hideInputs===!1?t:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(t):t}async processOutputs(t){return this.hideOutputs===!1?t:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(t):t}async prepareRunCreateOrUpdateInputs(t){let a={...t};return a.inputs!==void 0&&(a.inputs=await this.processInputs(a.inputs)),a.outputs!==void 0&&(a.outputs=await this.processOutputs(a.outputs)),a}async _getResponse(t,a){let r=a?.toString()??"",n=`${this.apiUrl}${t}?${r}`;return await this.caller.call(async()=>{let i=await this._fetch(n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,`fetch ${t}`),i})}async _get(t,a){return(await this._getResponse(t,a)).json()}async*_getPaginated(t,a=new URLSearchParams,r){let n=Number(a.get("offset"))||0,i=Number(a.get("limit"))||100;for(;;){a.set("offset",String(n)),a.set("limit",String(i));let s=`${this.apiUrl}${t}?${a}`,o=await this.caller.call(async()=>{let u=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(u,`fetch ${t}`),u}),l=r?r(await o.json()):await o.json();if(l.length===0||(yield l,l.length<i))break;n+=l.length}}async*_getCursorPaginatedList(t,a=null,r="POST",n="runs"){let i=a?{...a}:{};for(;;){let s=JSON.stringify(i),o=await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}${t}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(u,`fetch ${t}`),u})).json();if(!o||!o[n])break;yield o[n];let l=o.cursors;if(!l||!l.next)break;i.cursor=l.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(t,a=!1){if(this.tracingSampleRate===void 0)return t;if(a){let r=[];for(let n of t)this.filteredPostUuids.has(n.trace_id)?n.id===n.trace_id&&this.filteredPostUuids.delete(n.trace_id):r.push(n);return r}else{let r=[];for(let n of t){let i=n.trace_id??n.id;this.filteredPostUuids.has(i)||(n.id===i?this._shouldSample()?r.push(n):this.filteredPostUuids.add(i):r.push(n))}return r}}async _getBatchSizeLimitBytes(){let t=await this._ensureServerInfo();return this.batchSizeBytesLimit??t.batch_ingest_config?.size_limit_bytes??Yg}async _getBatchSizeLimit(){let t=await this._ensureServerInfo();return this.batchSizeLimit??t.batch_ingest_config?.size_limit??ey}async _getDatasetExamplesMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:a}){let r=[];for(;this.autoBatchQueue.items.length>0;){let[n,i]=this.autoBatchQueue.pop({upToSizeBytes:t,upToSize:a});if(!n.length){i();break}let s=n.reduce((u,c)=>{let d=c.apiUrl??this.apiUrl,h=c.apiKey??this.apiKey,p=c.apiKey===this.apiKey&&c.apiUrl===this.apiUrl?"default":`${d}|${h}`;return u[p]||(u[p]=[]),u[p].push(c),u},{}),o=[];for(let[u,c]of Object.entries(s)){let d=this._processBatch(c,{apiUrl:u==="default"?void 0:u.split("|")[0],apiKey:u==="default"?void 0:u.split("|")[1]});o.push(d)}let l=Promise.all(o).finally(i);r.push(l)}return Promise.all(r)}async _processBatch(t,a){if(t.length)try{if(this.langSmithToOTELTranslator!==void 0)this._sendBatchToOTELTranslator(t);else{let r={runCreates:t.filter(i=>i.action==="create").map(i=>i.item),runUpdates:t.filter(i=>i.action==="update").map(i=>i.item)},n=await this._ensureServerInfo();if(n?.batch_ingest_config?.use_multipart_endpoint){let i=n?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(r,{...a,useGzip:i})}else await this.batchIngestRuns(r,a)}}catch(r){console.error("Error exporting batch:",r)}}_sendBatchToOTELTranslator(t){if(this.langSmithToOTELTranslator!==void 0){let a=new Map,r=[];for(let n of t)n.item.id&&n.otelContext&&(a.set(n.item.id,n.otelContext),n.action==="create"?r.push({operation:"post",id:n.item.id,trace_id:n.item.trace_id??n.item.id,run:n.item}):r.push({operation:"patch",id:n.item.id,trace_id:n.item.trace_id??n.item.id,run:n.item}));this.langSmithToOTELTranslator.exportBatch(r,a)}}async processRunOperation(t){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,t.item=vu(t.item,this.cachedLSEnvVarsForMetadata);let a=this.autoBatchQueue.push(t);if(this.manualFlushMode)return a;let r=await this._getBatchSizeLimitBytes(),n=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>n)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:n}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:n})},this.autoBatchAggregationDelayMs)),a}async _getServerInfo(){let t=await(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Qg),...this.fetchOptions});return await F(a,"get server info"),a})).json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${t.status??"Unspecified status code"} ${t.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(t=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),t))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let t=await this._getBatchSizeLimitBytes(),a=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:t,batchSizeLimit:a})}_cloneCurrentOTELContext(){let t=hu(),a=Tg();if(this.langSmithToOTELTranslator!==void 0){let r=t.getActiveSpan();if(r)return t.setSpan(a.active(),r)}}async createRun(t,a){if(!this._filterForSampling([t]).length)return;let r={...this.headers,"Content-Type":"application/json"},n=t.project_name;delete t.project_name;let i=await this.prepareRunCreateOrUpdateInputs({session_name:n,...t,start_time:t.start_time??Date.now()});if(this.autoBatchTracing&&i.trace_id!==void 0&&i.dotted_order!==void 0){let l=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:l,apiKey:a?.apiKey,apiUrl:a?.apiUrl}).catch(console.error);return}let s=vu(i,this.cachedLSEnvVarsForMetadata);a?.apiKey!==void 0&&(r["x-api-key"]=a.apiKey),a?.workspaceId!==void 0&&(r["x-tenant-id"]=a.workspaceId);let o=Ke(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{let l=await this._fetch(`${a?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(l,"create run",!0),l})}async batchIngestRuns({runCreates:t,runUpdates:a},r){if(t===void 0&&a===void 0)return;let n=await Promise.all(t?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[]),i=await Promise.all(a?.map(l=>this.prepareRunCreateOrUpdateInputs(l))??[]);if(n.length>0&&i.length>0){let l=n.reduce((c,d)=>(d.id&&(c[d.id]=d),c),{}),u=[];for(let c of i)c.id!==void 0&&l[c.id]?l[c.id]={...l[c.id],...c}:u.push(c);n=Object.values(l),i=u}let s={post:n,patch:i};if(!s.post.length&&!s.patch.length)return;let o={post:[],patch:[]};for(let l of["post","patch"]){let u=l,c=s[u].reverse(),d=c.pop();for(;d!==void 0;)o[u].push(d),d=c.pop()}if(o.post.length>0||o.patch.length>0){let l=o.post.map(u=>u.id).concat(o.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(Ke(o,`Ingesting runs with ids: ${l}`),r)}}async _postBatchIngestRuns(t,a){let r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};a?.apiKey!==void 0&&(r["x-api-key"]=a.apiKey),await this.batchIngestCaller.call(async()=>{let n=await this._fetch(`${a?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await F(n,"batch create run",!0),n})}async multipartIngestRuns({runCreates:t,runUpdates:a},r){if(t===void 0&&a===void 0)return;let n={},i=[];for(let u of t??[]){let c=await this.prepareRunCreateOrUpdateInputs(u);c.id!==void 0&&c.attachments!==void 0&&(n[c.id]=c.attachments),delete c.attachments,i.push(c)}let s=[];for(let u of a??[])s.push(await this.prepareRunCreateOrUpdateInputs(u));if(i.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(u=>u.trace_id===void 0||u.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&s.length>0){let u=i.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),c=[];for(let d of s)d.id!==void 0&&u[d.id]?u[d.id]={...u[d.id],...d}:c.push(d);i=Object.values(u),s=c}if(i.length===0&&s.length===0)return;let o=[],l=[];for(let[u,c]of[["post",i],["patch",s]])for(let d of c){let{inputs:h,outputs:p,events:f,extra:m,error:g,serialized:_,attachments:y,...b}=d,w={inputs:h,outputs:p,events:f,extra:m,error:g,serialized:_},O=Ke(b,`Serializing for multipart ingestion of run with id: ${b.id}`);l.push({name:`${u}.${b.id}`,payload:new Blob([O],{type:`application/json; length=${O.length}`})});for(let[I,D]of Object.entries(w)){if(D===void 0)continue;let j=Ke(D,`Serializing ${I} for multipart ingestion of run with id: ${b.id}`);l.push({name:`${u}.${b.id}.${I}`,payload:new Blob([j],{type:`application/json; length=${j.length}`})})}if(b.id!==void 0){let I=n[b.id];if(I){delete n[b.id];for(let[D,j]of Object.entries(I)){let K,k;if(Array.isArray(j)?[K,k]=j:(K=j.mimeType,k=j.data),D.includes(".")){console.warn(`Skipping attachment '${D}' for run ${b.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${b.id}.${D}`,payload:new Blob([k],{type:`${K}; length=${k.byteLength}`})})}}}o.push(`trace=${b.trace_id},id=${b.id}`)}await this._sendMultipartRequest(l,o.join("; "),r)}async _createNodeFetchBody(t,a){let r=[];for(let n of t)r.push(new Blob([`--${a}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${n.name}"\r
`,`Content-Type: ${n.payload.type}\r
\r
`])),r.push(n.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${a}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(t,a){let r=new TextEncoder;return new ReadableStream({async start(n){let i=async s=>{typeof s=="string"?n.enqueue(r.encode(s)):n.enqueue(s)};for(let s of t){await i(`--${a}\r
`),await i(`Content-Disposition: form-data; name="${s.name}"\r
`),await i(`Content-Type: ${s.payload.type}\r
\r
`);let o=s.payload.stream().getReader();try{let l;for(;!(l=await o.read()).done;)n.enqueue(l.value)}finally{o.releaseLock()}await i(`\r
`)}await i(`--${a}--\r
`),n.close()}})}async _sendMultipartRequest(t,a,r){let n="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=yg(),s=()=>this._createNodeFetchBody(t,n),o=()=>this._createMultipartStream(t,n),l=async u=>this.batchIngestCaller.call(async()=>{let c=await u(),d={...this.headers,"Content-Type":`multipart/form-data; boundary=${n}`};r?.apiKey!==void 0&&(d["x-api-key"]=r.apiKey);let h=c;r?.useGzip&&typeof c=="object"&&"pipeThrough"in c&&(h=c.pipeThrough(new CompressionStream("gzip")),d["Content-Encoding"]="gzip");let p=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:d,body:h,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(p,"Failed to send multipart request",!0),p});try{let u,c=!1;!i&&!this.multipartStreamingDisabled&&ou()!=="bun"?(c=!0,u=await l(o)):u=await l(s),(!this.multipartStreamingDisabled||c)&&u.status===422&&(r?.apiUrl??this.apiUrl)!==Ou&&(console.warn(`Streaming multipart upload to ${r?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${a}".`),this.multipartStreamingDisabled=!0,u=await l(s))}catch(u){console.warn(`${u.message.trim()}

Context: ${a}`)}}async updateRun(t,a,r){ee(t),a.inputs&&(a.inputs=await this.processInputs(a.inputs)),a.outputs&&(a.outputs=await this.processOutputs(a.outputs));let n={...a,id:t};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&n.trace_id!==void 0&&n.dotted_order!==void 0){let o=this._cloneCurrentOTELContext();if(a.end_time!==void 0&&n.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:n,otelContext:o,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}else this.processRunOperation({action:"update",item:n,otelContext:o,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error);return}let i={...this.headers,"Content-Type":"application/json"};r?.apiKey!==void 0&&(i["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(i["x-tenant-id"]=r.workspaceId);let s=Ke(a,`Serializing payload to update run with id: ${t}`);await this.caller.call(async()=>{let o=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/${t}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"update run",!0),o})}async readRun(t,{loadChildRuns:a}={loadChildRuns:!1}){ee(t);let r=await this._get(`/runs/${t}`);return a&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:t,run:a,projectOpts:r}){if(a!==void 0){let n;a.session_id?n=a.session_id:r?.projectName?n=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?n=r?.projectId:n=(await this.readProject({projectName:Ze("PROJECT")||"default"})).id;let i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${n}/r/${a.id}?poll=true`}else if(t!==void 0){let n=await this.readRun(t);if(!n.app_path)throw new Error(`Run ${t} has no app_path`);return`${this.getHostUrl()}${n.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(t){let a=await Kg(this.listRuns({isRoot:!1,projectId:t.session_id,traceId:t.trace_id})),r={},n={};a.sort((i,s)=>(i?.dotted_order??"").localeCompare(s?.dotted_order??""));for(let i of a){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(t.dotted_order??"")&&i.id!==t.id&&(i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),n[i.id]=i)}t.child_runs=r[t.id]||[];for(let i in r)i!==t.id&&(n[i].child_runs=r[i]);return t}async*listRuns(t){let{projectId:a,projectName:r,parentRunId:n,traceId:i,referenceExampleId:s,startTime:o,executionOrder:l,isRoot:u,runType:c,error:d,id:h,query:p,filter:f,traceFilter:m,treeFilter:g,limit:_,select:y,order:b}=t,w=[];if(a&&(w=Array.isArray(a)?a:[a]),r){let j=Array.isArray(r)?r:[r],K=await Promise.all(j.map(k=>this.readProject({projectName:k}).then(ve=>ve.id)));w.push(...K)}let O=["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],I={session:w.length?w:null,run_type:c,reference_example:s,query:p,filter:f,trace_filter:m,tree_filter:g,execution_order:l,parent_run:n,start_time:o?o.toISOString():null,error:d,id:h,limit:_,trace:i,select:y||O,is_root:u,order:b};I.select.includes("child_run_ids")&&_s("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let D=0;for await(let j of this._getCursorPaginatedList("/runs/query",I))if(_){if(D>=_)break;if(j.length+D>_){yield*j.slice(0,_-D);break}D+=j.length,yield*j}else yield*j}async*listGroupRuns(t){let{projectId:a,projectName:r,groupBy:n,filter:i,startTime:s,endTime:o,limit:l,offset:u}=t,c={session_id:a||(await this.readProject({projectName:r})).id,group_by:n,filter:i,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(l)||100},d=Number(u)||0,h="/runs/group",p=`${this.apiUrl}${h}`;for(;;){let f={...c,offset:d},m=Object.fromEntries(Object.entries(f).filter(([w,O])=>O!==void 0)),g=JSON.stringify(m),_=await(await this.caller.call(async()=>{let w=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await F(w,`Failed to fetch ${h}`),w})).json(),{groups:y,total:b}=_;if(y.length===0)break;for(let w of y)yield w;if(d+=y.length,d>=b)break}}async getRunStats({id:t,trace:a,parentRun:r,runType:n,projectNames:i,projectIds:s,referenceExampleIds:o,startTime:l,endTime:u,error:c,query:d,filter:h,traceFilter:p,treeFilter:f,isRoot:m,dataSourceType:g}){let _=s||[];i&&(_=[...s||[],...await Promise.all(i.map(w=>this.readProject({projectName:w}).then(O=>O.id)))]);let y=Object.fromEntries(Object.entries({id:t,trace:a,parent_run:r,run_type:n,session:_,reference_example:o,start_time:l,end_time:u,error:c,query:d,filter:h,trace_filter:p,tree_filter:f,is_root:m,data_source_type:g}).filter(([w,O])=>O!==void 0)),b=JSON.stringify(y);return await(await this.caller.call(async()=>{let w=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await F(w,"get run stats"),w})).json()}async shareRun(t,{shareId:a}={}){let r={run_id:t,share_token:a||ze()};ee(t);let n=JSON.stringify(r),i=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await F(s,"share run"),s})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(t){ee(t),await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"unshare run",!0),a})}async readRunSharedLink(t){ee(t);let a=await(await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/runs/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(r,"read run shared link"),r})).json();if(!(a===null||!("share_token"in a)))return`${this.getHostUrl()}/public/${a.share_token}/r`}async listSharedRuns(t,{runIds:a}={}){let r=new URLSearchParams({share_token:t});if(a!==void 0)for(let n of a)r.append("id",n);return ee(t),await(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/public/${t}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"list shared runs"),n})).json()}async readDatasetSharedSchema(t,a){if(!t&&!a)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:a})).id),ee(t);let r=await(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"read dataset shared schema"),n})).json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(t,a){if(!t&&!a)throw new Error("Either datasetId or datasetName must be given");t||(t=(await this.readDataset({datasetName:a})).id);let r={dataset_id:t};ee(t);let n=JSON.stringify(r),i=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await F(s,"share dataset"),s})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(t){ee(t),await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/datasets/${t}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"unshare dataset",!0),a})}async readSharedDataset(t){return ee(t),await(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/public/${t}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"read shared dataset"),a})).json()}async listSharedExamples(t,a){let r={};a?.exampleIds&&(r.id=a.exampleIds);let n=new URLSearchParams;Object.entries(r).forEach(([o,l])=>{Array.isArray(l)?l.forEach(u=>n.append(o,u)):n.append(o,l)});let i=await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/public/${t}/examples?${n.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(o,"list shared examples"),o}),s=await i.json();if(!i.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:t,description:a=null,metadata:r=null,upsert:n=!1,projectExtra:i=null,referenceDatasetId:s=null}){let o=n?"?upsert=true":"",l=`${this.apiUrl}/sessions${o}`,u=i||{};r&&(u.metadata=r);let c={name:t,extra:u,description:a};s!==null&&(c.reference_dataset_id=s);let d=JSON.stringify(c);return await(await this.caller.call(async()=>{let h=await this._fetch(l,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:d});return await F(h,"create project"),h})).json()}async updateProject(t,{name:a=null,description:r=null,metadata:n=null,projectExtra:i=null,endTime:s=null}){let o=`${this.apiUrl}/sessions/${t}`,l=i;n&&(l={...l||{},metadata:n});let u=JSON.stringify({name:a,extra:l,description:r,end_time:s?new Date(s).toISOString():null});return await(await this.caller.call(async()=>{let c=await this._fetch(o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(c,"update project"),c})).json()}async hasProject({projectId:t,projectName:a}){let r="/sessions",n=new URLSearchParams;if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)ee(t),r+=`/${t}`;else if(a!==void 0)n.append("name",a);else throw new Error("Must provide projectName or projectId");let i=await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}${r}?${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(s,"has project"),s});try{let s=await i.json();return i.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:t,projectName:a,includeStats:r}){let n="/sessions",i=new URLSearchParams;if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(t!==void 0)ee(t),n+=`/${t}`;else if(a!==void 0)i.append("name",a);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());let s=await this._get(n,i),o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${t}, name=${a}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:t,projectName:a}){if(t===void 0&&a===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:t,projectName:a}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${r.id}`}async getDatasetUrl({datasetId:t,datasetName:a}){if(t===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:t,datasetName:a}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let t=new URLSearchParams({limit:"1"});for await(let a of this._getPaginated("/sessions",t))return this._tenantId=a[0].tenant_id,a[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:t,name:a,nameContains:r,referenceDatasetId:n,referenceDatasetName:i,includeStats:s,datasetVersion:o,referenceFree:l,metadata:u}={}){let c=new URLSearchParams;if(t!==void 0)for(let d of t)c.append("id",d);if(a!==void 0&&c.append("name",a),r!==void 0&&c.append("name_contains",r),n!==void 0)c.append("reference_dataset",n);else if(i!==void 0){let d=await this.readDataset({datasetName:i});c.append("reference_dataset",d.id)}s!==void 0&&c.append("include_stats",s.toString()),o!==void 0&&c.append("dataset_version",o),l!==void 0&&c.append("reference_free",l.toString()),u!==void 0&&c.append("metadata",JSON.stringify(u));for await(let d of this._getPaginated("/sessions",c))yield*d}async deleteProject({projectId:t,projectName:a}){let r;if(t===void 0&&a===void 0)throw new Error("Must provide projectName or projectId");if(t!==void 0&&a!==void 0)throw new Error("Must provide either projectName or projectId, not both");t===void 0?r=(await this.readProject({projectName:a})).id:r=t,ee(r),await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,`delete session ${r} (${a})`,!0),n})}async uploadCsv({csvFile:t,fileName:a,inputKeys:r,outputKeys:n,description:i,dataType:s,name:o}){let l=`${this.apiUrl}/datasets/upload`,u=new FormData;return u.append("file",t,a),r.forEach(c=>{u.append("input_keys",c)}),n.forEach(c=>{u.append("output_keys",c)}),i&&u.append("description",i),s&&u.append("data_type",s),o&&u.append("name",o),await(await this.caller.call(async()=>{let c=await this._fetch(l,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(c,"upload CSV"),c})).json()}async createDataset(t,{description:a,dataType:r,inputsSchema:n,outputsSchema:i,metadata:s}={}){let o={name:t,description:a,extra:s?{metadata:s}:void 0};r&&(o.data_type=r),n&&(o.inputs_schema_definition=n),i&&(o.outputs_schema_definition=i);let l=JSON.stringify(o);return await(await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await F(u,"create dataset"),u})).json()}async readDataset({datasetId:t,datasetName:a}){let r="/datasets",n=new URLSearchParams({limit:"1"});if(t&&a)throw new Error("Must provide either datasetName or datasetId, not both");if(t)ee(t),r+=`/${t}`;else if(a)n.append("name",a);else throw new Error("Must provide datasetName or datasetId");let i=await this._get(r,n),s;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${t}, name=${a}] not found`);s=i[0]}else s=i;return s}async hasDataset({datasetId:t,datasetName:a}){try{return await this.readDataset({datasetId:t,datasetName:a}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:t,datasetName:a,fromVersion:r,toVersion:n}){let i=t;if(i===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:a})).id);let s=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof n=="string"?n:n.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:t,datasetName:a}){let r="/datasets";if(t===void 0)if(a!==void 0)t=(await this.readDataset({datasetName:a})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${t}/openai_ft`)).text()).trim().split(`
`).map(n=>JSON.parse(n))}async*listDatasets({limit:t=100,offset:a=0,datasetIds:r,datasetName:n,datasetNameContains:i,metadata:s}={}){let o="/datasets",l=new URLSearchParams({limit:t.toString(),offset:a.toString()});if(r!==void 0)for(let u of r)l.append("id",u);n!==void 0&&l.append("name",n),i!==void 0&&l.append("name_contains",i),s!==void 0&&l.append("metadata",JSON.stringify(s));for await(let u of this._getPaginated(o,l))yield*u}async updateDataset(t){let{datasetId:a,datasetName:r,...n}=t;if(!a&&!r)throw new Error("Must provide either datasetName or datasetId");let i=a??(await this.readDataset({datasetName:r})).id;ee(i);let s=JSON.stringify(n);return await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"update dataset"),o})).json()}async updateDatasetTag(t){let{datasetId:a,datasetName:r,asOf:n,tag:i}=t;if(!a&&!r)throw new Error("Must provide either datasetName or datasetId");let s=a??(await this.readDataset({datasetName:r})).id;ee(s);let o=JSON.stringify({as_of:typeof n=="string"?n:n.toISOString(),tag:i});await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(l,"update dataset tags",!0),l})}async deleteDataset({datasetId:t,datasetName:a}){let r="/datasets",n=t;if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(a!==void 0&&(n=(await this.readDataset({datasetName:a})).id),n!==void 0)ee(n),r+=`/${n}`;else throw new Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{let i=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,`delete ${r}`,!0),i})}async indexDataset({datasetId:t,datasetName:a,tag:r}){let n=t;if(!n&&!a)throw new Error("Must provide either datasetName or datasetId");if(n&&a)throw new Error("Must provide either datasetName or datasetId, not both");n||(n=(await this.readDataset({datasetName:a})).id),ee(n);let i=JSON.stringify({tag:r});await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/datasets/${n}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await F(s,"index dataset"),s})).json()}async similarExamples(t,a,r,{filter:n}={}){let i={limit:r,inputs:t};n!==void 0&&(i.filter=n),ee(a);let s=JSON.stringify(i);return(await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${a}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await F(o,"fetch similar examples"),o})).json()).examples}async createExample(t,a,r){if(ku(t)&&(a!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let n=a?r?.datasetId:t.dataset_id,i=a?r?.datasetName:t.dataset_name;if(n===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(n!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");n===void 0&&(n=(await this.readDataset({datasetName:i})).id);let s=(a?r?.createdAt:t.created_at)||new Date,o;ku(t)?o=t:o={inputs:t,outputs:a,created_at:s?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};let l=await this._uploadExamplesMultipart(n,[o]);return await this.readExample(l.example_ids?.[0]??ze())}async createExamples(t){if(Array.isArray(t)){if(t.length===0)return[];let _=t,y=_[0].dataset_id,b=_[0].dataset_name;if(y===void 0&&b===void 0)throw new Error("Must provide either datasetName or datasetId");if(y!==void 0&&b!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");y===void 0&&(y=(await this.readDataset({datasetName:b})).id);let w=await this._uploadExamplesMultipart(y,_);return await Promise.all(w.example_ids.map(O=>this.readExample(O)))}let{inputs:a,outputs:r,metadata:n,splits:i,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:l,attachments:u,exampleIds:c,datasetId:d,datasetName:h}=t;if(a===void 0)throw new Error("Must provide inputs when using legacy parameters");let p=d,f=h;if(p===void 0&&f===void 0)throw new Error("Must provide either datasetName or datasetId");if(p!==void 0&&f!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");p===void 0&&(p=(await this.readDataset({datasetName:f})).id);let m=a.map((_,y)=>({dataset_id:p,inputs:_,outputs:r?.[y],metadata:n?.[y],split:i?.[y],id:c?.[y],attachments:u?.[y],source_run_id:s?.[y],use_source_run_io:o?.[y],use_source_run_attachments:l?.[y]})),g=await this._uploadExamplesMultipart(p,m);return await Promise.all(g.example_ids.map(_=>this.readExample(_)))}async createLLMExample(t,a,r){return this.createExample({input:t},{output:a},r)}async createChatExample(t,a,r){let n=t.map(s=>fu(s)?mu(s):s),i=fu(a)?mu(a):a;return this.createExample({input:n},{output:i},r)}async readExample(t){ee(t);let a=`/examples/${t}`,r=await this._get(a),{attachment_urls:n,...i}=r,s=i;return n&&(s.attachments=Object.entries(n).reduce((o,[l,u])=>(o[l.slice(11)]={presigned_url:u.presigned_url,mime_type:u.mime_type},o),{})),s}async*listExamples({datasetId:t,datasetName:a,exampleIds:r,asOf:n,splits:i,inlineS3Urls:s,metadata:o,limit:l,offset:u,filter:c,includeAttachments:d}={}){let h;if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0)h=t;else if(a!==void 0)h=(await this.readDataset({datasetName:a})).id;else throw new Error("Must provide a datasetName or datasetId");let p=new URLSearchParams({dataset:h}),f=n?typeof n=="string"?n:n?.toISOString():void 0;f&&p.append("as_of",f);let m=s??!0;if(p.append("inline_s3_urls",m.toString()),r!==void 0)for(let _ of r)p.append("id",_);if(i!==void 0)for(let _ of i)p.append("splits",_);if(o!==void 0){let _=JSON.stringify(o);p.append("metadata",_)}l!==void 0&&p.append("limit",l.toString()),u!==void 0&&p.append("offset",u.toString()),c!==void 0&&p.append("filter",c),d===!0&&["attachment_urls","outputs","metadata"].forEach(_=>p.append("select",_));let g=0;for await(let _ of this._getPaginated("/examples",p)){for(let y of _){let{attachment_urls:b,...w}=y,O=w;b&&(O.attachments=Object.entries(b).reduce((I,[D,j])=>(I[D.slice(11)]={presigned_url:j.presigned_url,mime_type:j.mime_type||void 0},I),{})),yield O,g++}if(l!==void 0&&g>=l)break}}async deleteExample(t){ee(t);let a=`/examples/${t}`;await this.caller.call(async()=>{let r=await this._fetch(this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(r,`delete ${a}`,!0),r})}async updateExample(t,a){let r;a?r=t:r=t.id,ee(r);let n;a?n={id:r,...a}:n=t;let i;return n.dataset_id!==void 0?i=n.dataset_id:i=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[n])}async updateExamples(t){let a;return t[0].dataset_id===void 0?a=(await this.readExample(t[0].id)).dataset_id:a=t[0].dataset_id,this._updateExamplesMultipart(a,t)}async readDatasetVersion({datasetId:t,datasetName:a,asOf:r,tag:n}){let i;if(t?i=t:i=(await this.readDataset({datasetName:a})).id,ee(i),r&&n||!r&&!n)throw new Error("Exactly one of asOf and tag must be specified.");let s=new URLSearchParams;return r!==void 0&&s.append("as_of",typeof r=="string"?r:r.toISOString()),n!==void 0&&s.append("tag",n),await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(o,"read dataset version"),o})).json()}async listDatasetSplits({datasetId:t,datasetName:a,asOf:r}){let n;if(t===void 0&&a===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?n=(await this.readDataset({datasetName:a})).id:n=t,ee(n);let i=new URLSearchParams,s=r?typeof r=="string"?r:r?.toISOString():void 0;return s&&i.append("as_of",s),await this._get(`/datasets/${n}/splits`,i)}async updateDatasetSplits({datasetId:t,datasetName:a,splitName:r,exampleIds:n,remove:i=!1}){let s;if(t===void 0&&a===void 0)throw new Error("Must provide dataset name or ID");if(t!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");t===void 0?s=(await this.readDataset({datasetName:a})).id:s=t,ee(s);let o={split_name:r,examples:n.map(u=>(ee(u),u)),remove:i},l=JSON.stringify(o);await this.caller.call(async()=>{let u=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await F(u,"update dataset splits",!0),u})}async evaluateRun(t,a,{sourceInfo:r,loadChildRuns:n,referenceExample:i}={loadChildRuns:!1}){_s("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof t=="string")s=await this.readRun(t,{loadChildRuns:n});else if(typeof t=="object"&&"id"in t)s=t;else throw new Error(`Invalid run type: ${typeof t}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(i=await this.readExample(s.reference_example_id));let o=await a.evaluateRun(s,i),[l,u]=await this._logEvaluationFeedback(o,s,r);return u[0]}async createFeedback(t,a,{score:r,value:n,correction:i,comment:s,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:u,feedbackId:c,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){if(!t&&!h)throw new Error("One of runId or projectId must be provided");if(t&&h)throw new Error("Only one of runId or projectId can be provided");let f={type:l??"api",metadata:o??{}};u!==void 0&&f?.metadata!==void 0&&!f.metadata.__run&&(f.metadata.__run={run_id:u}),f?.metadata!==void 0&&f.metadata.__run?.run_id!==void 0&&ee(f.metadata.__run.run_id);let m={id:c??ze(),run_id:t,key:a,score:wu(r),value:n,correction:i,comment:s,feedback_source:f,comparative_experiment_id:p,feedbackConfig:d,session_id:h},g=JSON.stringify(m),_=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{let y=await this._fetch(_,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:g});return await F(y,"create feedback",!0),y}),m}async updateFeedback(t,{score:a,value:r,correction:n,comment:i}){let s={};a!=null&&(s.score=wu(a)),r!=null&&(s.value=r),n!=null&&(s.correction=n),i!=null&&(s.comment=i),ee(t);let o=JSON.stringify(s);await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/feedback/${t}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(l,"update feedback",!0),l})}async readFeedback(t){ee(t);let a=`/feedback/${t}`;return await this._get(a)}async deleteFeedback(t){ee(t);let a=`/feedback/${t}`;await this.caller.call(async()=>{let r=await this._fetch(this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(r,`delete ${a}`,!0),r})}async*listFeedback({runIds:t,feedbackKeys:a,feedbackSourceTypes:r}={}){let n=new URLSearchParams;if(t)for(let i of t)ee(i),n.append("run",i);if(a)for(let i of a)n.append("key",i);if(r)for(let i of r)n.append("source",i);for await(let i of this._getPaginated("/feedback",n))yield*i}async createPresignedFeedbackToken(t,a,{expiration:r,feedbackConfig:n}={}){let i={run_id:t,feedback_key:a,feedback_config:n};r?typeof r=="string"?i.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(i.expires_in=r):i.expires_in={hours:3};let s=JSON.stringify(i);return await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"create presigned feedback token"),o})).json()}async createComparativeExperiment({name:t,experimentIds:a,referenceDatasetId:r,createdAt:n,description:i,metadata:s,id:o}){if(a.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:a[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let l={id:o,name:t,experiment_ids:a,reference_dataset_id:r,description:i,created_at:(n??new Date)?.toISOString(),extra:{}};s&&(l.extra.metadata=s);let u=JSON.stringify(l);return(await this.caller.call(async()=>{let c=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(c,"create comparative experiment"),c})).json()}async*listPresignedFeedbackTokens(t){ee(t);let a=new URLSearchParams({run_id:t});for await(let r of this._getPaginated("/feedback/tokens",a))yield*r}_selectEvalResults(t){let a;return"results"in t?a=t.results:Array.isArray(t)?a=t:a=[t],a}async _logEvaluationFeedback(t,a,r){let n=this._selectEvalResults(t),i=[];for(let s of n){let o=r||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let l=null;s.targetRunId?l=s.targetRunId:a&&(l=a.id),i.push(await this.createFeedback(l,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[n,i]}async logEvaluationFeedback(t,a,r){let[n]=await this._logEvaluationFeedback(t,a,r);return n}async*listAnnotationQueues(t={}){let{queueIds:a,name:r,nameContains:n,limit:i}=t,s=new URLSearchParams;a&&a.forEach((l,u)=>{ee(l,`queueIds[${u}]`),s.append("ids",l)}),r&&s.append("name",r),n&&s.append("name_contains",n),s.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(let l of this._getPaginated("/annotation-queues",s))if(yield*l,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(t){let{name:a,description:r,queueId:n,rubricInstructions:i}=t,s={name:a,description:r,id:n||ze(),rubric_instructions:i},o=JSON.stringify(Object.fromEntries(Object.entries(s).filter(([l,u])=>u!==void 0)));return(await this.caller.call(async()=>{let l=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await F(l,"create annotation queue"),l})).json()}async readAnnotationQueue(t){return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"read annotation queue"),a})).json()}async updateAnnotationQueue(t,a){let{name:r,description:n,rubricInstructions:i}=a,s=JSON.stringify({name:r,description:n,rubric_instructions:i});await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"update annotation queue",!0),o})}async deleteAnnotationQueue(t){await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"delete annotation queue",!0),a})}async addRunsToAnnotationQueue(t,a){let r=JSON.stringify(a.map((n,i)=>ee(n,`runIds[${i}]`).toString()));await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await F(n,"add runs to annotation queue",!0),n})}async getRunFromAnnotationQueue(t,a){let r=`/annotation-queues/${ee(t,"queueId")}/run`;return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}${r}/${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(n,"get run from annotation queue"),n})).json()}async deleteRunFromAnnotationQueue(t,a){await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}/runs/${ee(a,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(t){return(await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}/annotation-queues/${ee(t,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(a,"get size from annotation queue"),a})).json()}async _currentTenantIsOwner(t){let a=await this._getSettings();return t=="-"||a.tenant_handle===t}async _ownerConflictError(t,a){let r=await this._getSettings();return new Error(`Cannot ${t} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${a}`)}async _getLatestCommitHash(t){let a=await(await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/commits/${t}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(r,"get latest commit hash"),r})).json();if(a.commits.length!==0)return a.commits[0].commit_hash}async _likeOrUnlikePrompt(t,a){let[r,n,i]=Kt(t),s=JSON.stringify({like:a});return(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/likes/${r}/${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,`${a?"like":"unlike"} prompt`),o})).json()}async _getPromptUrl(t){let[a,r,n]=Kt(t);if(await this._currentTenantIsOwner(a)){let i=await this._getSettings();return n!=="latest"?`${this.getHostUrl()}/prompts/${r}/${n.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${i.id}`}else return n!=="latest"?`${this.getHostUrl()}/hub/${a}/${r}/${n.substring(0,8)}`:`${this.getHostUrl()}/hub/${a}/${r}`}async promptExists(t){return!!await this.getPrompt(t)}async likePrompt(t){return this._likeOrUnlikePrompt(t,!0)}async unlikePrompt(t){return this._likeOrUnlikePrompt(t,!1)}async*listCommits(t){for await(let a of this._getPaginated(`/commits/${t}/`,new URLSearchParams,r=>r.commits))yield*a}async*listPrompts(t){let a=new URLSearchParams;a.append("sort_field",t?.sortField??"updated_at"),a.append("sort_direction","desc"),a.append("is_archived",(!!t?.isArchived).toString()),t?.isPublic!==void 0&&a.append("is_public",t.isPublic.toString()),t?.query&&a.append("query",t.query);for await(let r of this._getPaginated("/repos",a,n=>n.repos))yield*r}async getPrompt(t){let[a,r,n]=Kt(t),i=await(await this.caller.call(async()=>{let s=await this._fetch(`${this.apiUrl}/repos/${a}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return s?.status===404?null:(await F(s,"get prompt"),s)}))?.json();return i?.repo?i.repo:null}async createPrompt(t,a){let r=await this._getSettings();if(a?.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[n,i,s]=Kt(t);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("create a prompt",n);let o={repo_handle:i,...a?.description&&{description:a.description},...a?.readme&&{readme:a.readme},...a?.tags&&{tags:a.tags},is_public:!!a?.isPublic},l=JSON.stringify(o),u=await this.caller.call(async()=>{let d=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await F(d,"create prompt"),d}),{repo:c}=await u.json();return c}async createCommit(t,a,r){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[n,i,s]=Kt(t),o=r?.parentCommitHash==="latest"||!r?.parentCommitHash?await this._getLatestCommitHash(`${n}/${i}`):r?.parentCommitHash,l={manifest:JSON.parse(JSON.stringify(a)),parent_commit:o},u=JSON.stringify(l),c=await(await this.caller.call(async()=>{let d=await this._fetch(`${this.apiUrl}/commits/${n}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await F(d,"create commit"),d})).json();return this._getPromptUrl(`${n}/${i}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updateExamplesMultipart(t,a=[]){return this._updateExamplesMultipart(t,a)}async _updateExamplesMultipart(t,a=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let i of a){let s=i.id,o={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},l=Ke(o,`Serializing body for example with id: ${s}`),u=new Blob([l],{type:"application/json"});if(r.append(s,u),i.inputs){let c=Ke(i.inputs,`Serializing inputs for example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.inputs`,d)}if(i.outputs){let c=Ke(i.outputs,`Serializing outputs whle updating example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.outputs`,d)}if(i.attachments)for(let[c,d]of Object.entries(i.attachments)){let h,p;Array.isArray(d)?[h,p]=d:(h=d.mimeType,p=d.data);let f=new Blob([p],{type:`${h}; length=${p.byteLength}`});r.append(`${s}.attachment.${c}`,f)}if(i.attachments_operations){let c=Ke(i.attachments_operations,`Serializing attachments while updating example with id: ${s}`),d=new Blob([c],{type:"application/json"});r.append(`${s}.attachments_operations`,d)}}let n=t??a[0]?.dataset_id;return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${n}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await F(i,"update examples"),i})).json()}async uploadExamplesMultipart(t,a=[]){return this._uploadExamplesMultipart(t,a)}async _uploadExamplesMultipart(t,a=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let n of a){let i=(n.id??ze()).toString(),s={created_at:n.created_at,...n.metadata&&{metadata:n.metadata},...n.split&&{split:n.split},...n.source_run_id&&{source_run_id:n.source_run_id},...n.use_source_run_io&&{use_source_run_io:n.use_source_run_io},...n.use_source_run_attachments&&{use_source_run_attachments:n.use_source_run_attachments}},o=Ke(s,`Serializing body for uploaded example with id: ${i}`),l=new Blob([o],{type:"application/json"});if(r.append(i,l),n.inputs){let u=Ke(n.inputs,`Serializing inputs for uploaded example with id: ${i}`),c=new Blob([u],{type:"application/json"});r.append(`${i}.inputs`,c)}if(n.outputs){let u=Ke(n.outputs,`Serializing outputs for uploaded example with id: ${i}`),c=new Blob([u],{type:"application/json"});r.append(`${i}.outputs`,c)}if(n.attachments)for(let[u,c]of Object.entries(n.attachments)){let d,h;Array.isArray(c)?[d,h]=c:(d=c.mimeType,h=c.data);let p=new Blob([h],{type:`${d}; length=${h.byteLength}`});r.append(`${i}.attachment.${u}`,p)}}return(await this.caller.call(async()=>{let n=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${t}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await F(n,"upload examples"),n})).json()}async updatePrompt(t,a){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[r,n]=Kt(t);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let i={};if(a?.description!==void 0&&(i.description=a.description),a?.readme!==void 0&&(i.readme=a.readme),a?.tags!==void 0&&(i.tags=a.tags),a?.isPublic!==void 0&&(i.is_public=a.isPublic),a?.isArchived!==void 0&&(i.is_archived=a.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");let s=JSON.stringify(i);return(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await F(o,"update prompt"),o})).json()}async deletePrompt(t){if(!await this.promptExists(t))throw new Error("Prompt does not exist, you must create it first.");let[a,r,n]=Kt(t);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("delete a prompt",a);return(await this.caller.call(async()=>{let i=await this._fetch(`${this.apiUrl}/repos/${a}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(i,"delete prompt"),i})).json()}async pullPromptCommit(t,a){let[r,n,i]=Kt(t),s=await(await this.caller.call(async()=>{let o=await this._fetch(`${this.apiUrl}/commits/${r}/${n}/${i}${a?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await F(o,"pull prompt commit"),o})).json();return{owner:r,repo:n,commit_hash:s.commit_hash,manifest:s.manifest,examples:s.examples}}async _pullPrompt(t,a){let r=await this.pullPromptCommit(t,{includeModel:a?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(t,a){return await this.promptExists(t)?a&&Object.keys(a).some(r=>r!=="object")&&await this.updatePrompt(t,{description:a?.description,readme:a?.readme,tags:a?.tags,isPublic:a?.isPublic}):await this.createPrompt(t,{description:a?.description,readme:a?.readme,tags:a?.tags,isPublic:a?.isPublic}),a?.object?await this.createCommit(t,a?.object,{parentCommitHash:a?.parentCommitHash}):await this._getPromptUrl(t)}async clonePublicDataset(t,a={}){let{sourceApiUrl:r=this.apiUrl,datasetName:n}=a,[i,s]=this.parseTokenOrUrl(t,r),o=new sl({apiUrl:i,apiKey:"placeholder"}),l=await o.readSharedDataset(s),u=n||l.name;try{if(await this.hasDataset({datasetId:u})){console.log(`Dataset ${u} already exists in your tenant. Skipping.`);return}}catch{}let c=await o.listSharedExamples(s),d=await this.createDataset(u,{description:l.description,dataType:l.data_type||"kv",inputsSchema:l.inputs_schema_definition??void 0,outputsSchema:l.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map(h=>h.inputs),outputs:c.flatMap(h=>h.outputs?[h.outputs]:[]),datasetId:d.id})}catch(h){throw console.error(`An error occurred while creating dataset ${u}. You should delete it manually.`),h}}parseTokenOrUrl(t,a,r=2,n="dataset"){try{return ee(t),[a,t]}catch{}try{let i=new URL(t).pathname.split("/").filter(s=>s!=="");if(i.length>=r){let s=i[i.length-r];return[a,s]}else throw new Error(`Invalid public ${n} URL: ${t}`)}catch{throw new Error(`Invalid public ${n} URL or token: ${t}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:t})=>t),this.batchIngestCaller.queue.onIdle()]),this.langSmithToOTELTranslator!==void 0&&await jg()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}};function ku(e){return"dataset_id"in e||"dataset_name"in e}var ty=e=>e!==void 0?e:!!["TRACING_V2","TRACING"].find(t=>Ze(t)==="true"),ws=Symbol.for("lc:context_variables");function ay(e){return e.replace(/[-:.]/g,"")}function xu(e,t,a=1){let r=a.toFixed(0).slice(0,3).padStart(3,"0"),n=`${new Date(e).toISOString().slice(0,-1)}${r}Z`;return{dottedOrder:ay(n)+t,microsecondPrecisionDatestring:n}}var Au=class Mh{constructor(t,a,r,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=t,this.tags=a,this.project_name=r,this.replicas=n}static fromHeader(t){let a=t.split(","),r={},n=[],i,s;for(let o of a){let[l,u]=o.split("="),c=decodeURIComponent(u);l==="langsmith-metadata"?r=JSON.parse(c):l==="langsmith-tags"?n=c.split(","):l==="langsmith-project"?i=c:l==="langsmith-replicas"&&(s=JSON.parse(c))}return new Mh(r,n,i,s)}toHeader(){let t=[];return this.metadata&&Object.keys(this.metadata).length>0&&t.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&t.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&t.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),t.join(",")}},En=class Ct{constructor(t){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),ry(t)){Object.assign(this,{...t});return}let a=Ct.getDefaultConfig(),{metadata:r,...n}=t,i=n.client??Ct.getSharedClient(),s={...r,...n?.extra?.metadata};if(n.extra={...n.extra,metadata:s},Object.assign(this,{...a,...n,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=ly(this.replicas),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){let{dottedOrder:o,microsecondPrecisionDatestring:l}=xu(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o,this._serialized_start_time=l}}set metadata(t){this.extra={...this.extra,metadata:{...this.extra?.metadata,...t}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:ze(),run_type:"chain",project_name:nu(),child_runs:[],api_url:Ot("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ot("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return Ct.sharedClient||(Ct.sharedClient=new Eu),Ct.sharedClient}createChild(t){let a=this.child_execution_order+1,r=new Ct({...t,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:a,child_execution_order:a});ws in this&&(r[ws]=this[ws]);let n=Symbol.for("lc:child_config"),i=t.extra?.[n]??this.extra[n];if(iy(i)){let l={...i},u=ny(l.callbacks)?l.callbacks.copy?.():void 0;u&&(Object.assign(u,{_parentRunId:r.id}),u.handlers?.find(Iu)?.updateFromRunTree?.(r),l.callbacks=u),r.extra[n]=l}let s=new Set,o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,a),o=o.parent_run;return this.child_runs.push(r),r}async end(t,a,r=Date.now(),n){this.outputs=this.outputs??t,this.error=this.error??a,this.end_time=this.end_time??r,n&&Object.keys(n).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...n}}:{metadata:n})}_convertToCreate(t,a,r=!0){let n=t.extra??{};if(n?.runtime?.library===void 0&&(n.runtime||(n.runtime={}),a))for(let[o,l]of Object.entries(a))n.runtime[o]||(n.runtime[o]=l);let i,s;return r?(s=t.parent_run?.id??t.parent_run_id,i=[]):(i=t.child_runs.map(o=>this._convertToCreate(o,a,r)),s=void 0),{id:t.id,name:t.name,start_time:t._serialized_start_time??t.start_time,end_time:t.end_time,run_type:t.run_type,reference_example_id:t.reference_example_id,extra:n,serialized:t.serialized,error:t.error,inputs:t.inputs,outputs:t.outputs,session_name:t.project_name,child_runs:i,parent_run_id:s,trace_id:t.trace_id,dotted_order:t.dotted_order,tags:t.tags,attachments:t.attachments,events:t.events}}_remapForProject(t,a,r=!0){let n=this._convertToCreate(this,a,r);if(t===this.project_name)return n;let i=c=>Hl(`${c}:${t}`,Hl.DNS),s=i(n.id),o=n.trace_id?i(n.trace_id):void 0,l=n.parent_run_id?i(n.parent_run_id):void 0,u;if(n.dotted_order){let c=sy(n.dotted_order),d=[];for(let p=0;p<c.length-1;p++){let[f,m]=c[p],g=i(m);d.push(f.toISOString().replace(/[-:]/g,"").replace(".","")+g)}let[h]=c[c.length-1];d.push(h.toISOString().replace(/[-:]/g,"").replace(".","")+s),u=d.join(".")}else u=void 0;return{...n,id:s,trace_id:o,parent_run_id:l,dotted_order:u,session_name:t}}async postRun(t=!0){try{let a=lu();if(this.replicas&&this.replicas.length>0)for(let{projectName:r,apiKey:n,apiUrl:i,workspaceId:s}of this.replicas){let o=this._remapForProject(r??this.project_name,a,!0);await this.client.createRun(o,{apiKey:n,apiUrl:i,workspaceId:s})}else{let r=this._convertToCreate(this,a,t);await this.client.createRun(r)}if(!t){_s("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let r of this.child_runs)await r.postRun(!1)}}catch(a){console.error(`Error in postRun for run ${this.id}:`,a)}}async patchRun(t){if(this.replicas&&this.replicas.length>0)for(let{projectName:a,apiKey:r,apiUrl:n,workspaceId:i,updates:s}of this.replicas){let o=this._remapForProject(a??this.project_name),l={id:o.id,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...s};t?.excludeInputs||(l.inputs=o.inputs),await this.client.updateRun(o.id,l,{apiKey:r,apiUrl:n,workspaceId:i})}else try{let a={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};t?.excludeInputs||(a.inputs=this.inputs),await this.client.updateRun(this.id,a)}catch(a){console.error(`Error in patchRun for run ${this.id}`,a)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(t){this.events||(this.events=[]),typeof t=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:t}):this.events.push({...t,time:t.time??new Date().toISOString()})}static fromRunnableConfig(t,a){let r=t?.callbacks,n,i,s,o=ty();if(r){let l=r?.getParentRunId?.()??"",u=r?.handlers?.find(c=>c?.name=="langchain_tracer");n=u?.getRun?.(l),i=u?.projectName,s=u?.client,o=o||!!u}return n?new Ct({name:n.name,id:n.id,trace_id:n.trace_id,dotted_order:n.dotted_order,client:s,tracingEnabled:o,project_name:i,tags:[...new Set((n?.tags??[]).concat(t?.tags??[]))],extra:{metadata:{...n?.extra?.metadata,...t?.metadata}}}).createChild(a):new Ct({...a,client:s,tracingEnabled:o,project_name:i})}static fromDottedOrder(t){return this.fromHeaders({"langsmith-trace":t})}static fromHeaders(t,a){let r="get"in t&&typeof t.get=="function"?{"langsmith-trace":t.get("langsmith-trace"),baggage:t.get("baggage")}:t,n=r["langsmith-trace"];if(!n||typeof n!="string")return;let i=n.trim(),s=i.split(".").map(u=>{let[c,d]=u.split("Z");return{strTime:c,time:Date.parse(c+"Z"),uuid:d}}),o=s[0].uuid,l={...a,name:a?.name??"parent",run_type:a?.run_type??"chain",start_time:a?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:i};if(r.baggage&&typeof r.baggage=="string"){let u=Au.fromHeader(r.baggage);l.metadata=u.metadata,l.tags=u.tags,l.project_name=u.project_name,l.replicas=u.replicas}return new Ct(l)}toHeaders(t){let a={"langsmith-trace":this.dotted_order,baggage:new Au(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(t)for(let[r,n]of Object.entries(a))t.set(r,n);return a}};Object.defineProperty(En,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function ry(e){return e!=null&&typeof e.createChild=="function"&&typeof e.postRun=="function"}function Iu(e){return typeof e=="object"&&e!=null&&typeof e.name=="string"&&e.name==="langchain_tracer"}function Su(e){return Array.isArray(e)&&e.some(t=>Iu(t))}function ny(e){return typeof e=="object"&&e!=null&&Array.isArray(e.handlers)}function iy(e){return e!=null&&typeof e.callbacks=="object"&&(Su(e.callbacks?.handlers)||Su(e.callbacks))}function sy(e){return e.split(".").map(t=>{let a=t.slice(0,-36),r=t.slice(-36),n=parseInt(a.slice(0,4)),i=parseInt(a.slice(4,6))-1,s=parseInt(a.slice(6,8)),o=parseInt(a.slice(9,11)),l=parseInt(a.slice(11,13)),u=parseInt(a.slice(13,15)),c=parseInt(a.slice(15,21));return[new Date(n,i,s,o,l,u,c/1e3),r]})}function oy(){let e=Ot("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{let t=JSON.parse(e);if(Array.isArray(t)){let a=[];for(let r of t){if(typeof r!="object"||r===null){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof r}`);continue}if(typeof r.api_url!="string"){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_url}`);continue}if(typeof r.api_key!="string"){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof r.api_key}`);continue}a.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key})}return a}else if(typeof t=="object"&&t!==null){uy(t);let a=[];for(let[r,n]of Object.entries(t)){let i=r.replace(/\/$/,"");if(typeof n=="string")a.push({apiUrl:i,apiKey:n});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got ${typeof n}`);continue}}return a}else return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof t}`),[]}catch(t){if(Fg(t))throw t;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS \u2013 must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}function ly(e){return e?e.map(t=>Array.isArray(t)?{projectName:t[0],updates:t[1]}:t):oy()}function uy(e){if(Object.keys(e).length>0&&Ze("ENDPOINT"))throw new Dg}var cy=()=>typeof window<"u"&&typeof window.document<"u",dy=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",hy=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&navigator.userAgent.includes("jsdom"),Os=()=>typeof Deno<"u",py=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!Os(),fy=()=>{let e;return cy()?e="browser":py()?e="node":dy()?e="webworker":hy()?e="jsdom":Os()?e="deno":e="other",e},Es;function my(){return Es===void 0&&(Es={library:"langchain-js",runtime:fy()}),Es}function Re(e){try{return typeof process<"u"?process.env?.[e]:Os()?Deno?.env.get(e):void 0}catch{return}}var gy=class{};function yy(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}var ks=class Uh extends gy{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,vl(this.constructor)]}constructor(t){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Re("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=t||{},t&&(this.ignoreLLM=t.ignoreLLM??this.ignoreLLM,this.ignoreChain=t.ignoreChain??this.ignoreChain,this.ignoreAgent=t.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=t.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=t.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=t.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(t._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Va.prototype.toJSON.call(this)}toJSONNotImplemented(){return Va.prototype.toJSONNotImplemented.call(this)}static fromMethods(t){class a extends Uh{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ze()}),Object.assign(this,t)}}return new a}},_y=e=>{let t=e;return t!==void 0&&typeof t.copy=="function"&&typeof t.name=="string"&&typeof t.awaitHandlers=="boolean"},by=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e};function xs(e,t){if(e)return new En({...e,start_time:e._serialized_start_time??e.start_time,parent_run:xs(t),child_runs:e.child_runs.map(a=>xs(a)).filter(a=>a!==void 0),extra:{...e.extra,runtime:my()},tracingEnabled:!1})}function As(e,t){return e&&!Array.isArray(e)&&typeof e=="object"?e:{[t]:e}}function wr(e){return typeof e._addRunToRunMap=="function"}var Or=class extends ks{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(e!==void 0)return this.usesRunTreeMap?by(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let{dottedOrder:t,microsecondPrecisionDatestring:a}=xu(new Date(e.start_time).getTime(),e.id,e.execution_order),r={...e},n=this.getRunById(r.parent_run_id);if(r.parent_run_id!==void 0?n&&(this._addChildRun(n,r),n.child_execution_order=Math.max(n.child_execution_order,r.child_execution_order),r.trace_id=n.trace_id,n.dotted_order!==void 0&&(r.dotted_order=[n.dotted_order,t].join("."),r._serialized_start_time=a)):(r.trace_id=r.id,r.dotted_order=t,r._serialized_start_time=a),this.usesRunTreeMap){let i=xs(r,n);i!==void 0&&this.runTreeMap.set(r.id,i)}else this.runMap.set(r.id,r);return r}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,a,r,n,i,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c=s?{...n,metadata:s}:n,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:i||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,a,r,n,i,s,o){let l=this.getRunById(a)??this._createRunForLLMStart(e,t,a,r,n,i,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,a,r,n,i,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c=s?{...n,metadata:s}:n,d={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:i||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,a,r,n,i,s,o){let l=this.getRunById(a)??this._createRunForChatModelStart(e,t,a,r,n,i,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t,a,r,n){let i=this.getRunById(t);if(!i||i?.run_type!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.outputs=e,i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...n},await this.onLLMEnd?.(i),await this._endTrace(i),i}async handleLLMError(e,t,a,r,n){let i=this.getRunById(t);if(!i||i?.run_type!=="llm")throw new Error("No LLM run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),i.extra={...i.extra,...n},await this.onLLMError?.(i),await this._endTrace(i),i}_createRunForChainStart(e,t,a,r,n,i,s,o){let l=this._getExecutionOrder(r),u=Date.now(),c={id:a,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(c)}async handleChainStart(e,t,a,r,n,i,s,o){let l=this.getRunById(a)??this._createRunForChainStart(e,t,a,r,n,i,s,o);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,a,r,n){let i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=As(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),n?.inputs!==void 0&&(i.inputs=As(n.inputs,"input")),await this.onChainEnd?.(i),await this._endTrace(i),i}async handleChainError(e,t,a,r,n){let i=this.getRunById(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),n?.inputs!==void 0&&(i.inputs=As(n.inputs,"input")),await this.onChainError?.(i),await this._endTrace(i),i}_createRunForToolStart(e,t,a,r,n,i,s){let o=this._getExecutionOrder(r),l=Date.now(),u={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,a,r,n,i,s){let o=this.getRunById(a)??this._createRunForToolStart(e,t,a,r,n,i,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="tool")throw new Error("No tool run to end");return a.end_time=Date.now(),a.outputs={output:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await this.onToolEnd?.(a),await this._endTrace(a),a}async handleToolError(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="tool")throw new Error("No tool run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await this.onToolError?.(a),await this._endTrace(a),a}async handleAgentAction(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="chain")return;let r=a;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(a)}async handleAgentEnd(e,t){let a=this.getRunById(t);!a||a?.run_type!=="chain"||(a.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(a))}_createRunForRetrieverStart(e,t,a,r,n,i,s){let o=this._getExecutionOrder(r),l=Date.now(),u={id:a,name:s??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,a,r,n,i,s){let o=this.getRunById(a)??this._createRunForRetrieverStart(e,t,a,r,n,i,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="retriever")throw new Error("No retriever run to end");return a.end_time=Date.now(),a.outputs={documents:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await this.onRetrieverEnd?.(a),await this._endTrace(a),a}async handleRetrieverError(e,t){let a=this.getRunById(t);if(!a||a?.run_type!=="retriever")throw new Error("No retriever run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await this.onRetrieverError?.(a),await this._endTrace(a),a}async handleText(e,t){let a=this.getRunById(t);!a||a?.run_type!=="chain"||(a.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(a))}async handleLLMNewToken(e,t,a,r,n,i){let s=this.getRunById(a);if(!s||s?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:i?.chunk}),s}},Pu=rt(Up(),1);function De(e,t){return`${e.open}${t}${e.close}`}function at(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function $u(e){return typeof e=="string"?e.trim():e==null?e:at(e,e.toString())}function Vt(e){if(!e.end_time)return"";let t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}var{color:qe}=Pu.default,Tu=class extends Or{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],a=e;for(;a.parent_run_id;){let r=this.runMap.get(a.parent_run_id);if(r)t.push(r),a=r;else break}return t}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((a,r,n)=>{let i=`${a.execution_order}:${a.run_type}:${a.name}`;return r===n.length-1?De(Pu.default.bold,i):i}).join(" > ");return De(qe.grey,t)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.green,"[chain/start]")} [${t}] Entering Chain run with input: ${at(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.cyan,"[chain/end]")} [${t}] [${Vt(e)}] Exiting Chain run with output: ${at(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.red,"[chain/error]")} [${t}] [${Vt(e)}] Chain run errored with error: ${at(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),a="prompts"in e.inputs?{prompts:e.inputs.prompts.map(r=>r.trim())}:e.inputs;console.log(`${De(qe.green,"[llm/start]")} [${t}] Entering LLM run with input: ${at(a,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.cyan,"[llm/end]")} [${t}] [${Vt(e)}] Exiting LLM run with output: ${at(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.red,"[llm/error]")} [${t}] [${Vt(e)}] LLM run errored with error: ${at(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.green,"[tool/start]")} [${t}] Entering Tool run with input: "${$u(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.cyan,"[tool/end]")} [${t}] [${Vt(e)}] Exiting Tool run with output: "${$u(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.red,"[tool/error]")} [${t}] [${Vt(e)}] Tool run errored with error: ${at(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${at(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.cyan,"[retriever/end]")} [${t}] [${Vt(e)}] Exiting Retriever run with output: ${at(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${De(qe.red,"[retriever/error]")} [${t}] [${Vt(e)}] Retriever run errored with error: ${at(e.error,"[error]")}`)}onAgentAction(e){let t=e,a=this.getBreadcrumbs(e);console.log(`${De(qe.blue,"[agent/action]")} [${a}] Agent selected action: ${at(t.actions[t.actions.length-1],"[action]")}`)}},Is,vy=()=>{if(Is===void 0){let e=Re("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};Is=new Eu(e)}return Is},Ss=class zh extends Or{constructor(t={}){super(t),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});let{exampleId:a,projectName:r,client:n,replicas:i}=t;this.projectName=r??nu(),this.replicas=i,this.exampleId=a,this.client=n??vy();let s=zh.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(t){}async onRunCreate(t){await this.getRunTreeWithTracingConfig(t.id)?.postRun()}async onRunUpdate(t){await this.getRunTreeWithTracingConfig(t.id)?.patchRun()}getRun(t){return this.runTreeMap.get(t)}updateFromRunTree(t){this.runTreeMap.set(t.id,t);let a=t,r=new Set;for(;a.parent_run&&!(r.has(a.id)||(r.add(a.id),!a.parent_run));)a=a.parent_run;r.clear();let n=[a];for(;n.length>0;){let i=n.shift();!i||r.has(i.id)||(r.add(i.id),this.runTreeMap.set(i.id,i),i.child_runs&&n.push(...i.child_runs))}this.client=t.client??this.client,this.replicas=t.replicas??this.replicas,this.projectName=t.project_name??this.projectName,this.exampleId=t.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(t){let a=this.runTreeMap.get(t);if(a)return new En({...a,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return Lm(!0)}catch{return}}},Ps=rt(Ui(),1),ju=Symbol.for("ls:tracing_async_local_storage"),kn=Symbol.for("lc:context_variables"),wy=e=>{globalThis[ju]=e},Er=()=>globalThis[ju],kr;function Oy(){let e="default"in Ps.default?Ps.default.default:Ps.default;return new e({autoStart:!0,concurrency:1})}function Ey(){return typeof kr>"u"&&(kr=Oy()),kr}async function we(e,t){if(t===!0){let a=Er();a!==void 0?await a.run(void 0,async()=>e()):await e()}else kr=Ey(),kr.add(async()=>{let a=Er();a!==void 0?await a.run(void 0,async()=>e()):await e()})}var ky=e=>e!==void 0?e:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Re(t)==="true");function Ru(e){let t=Er();return t===void 0?void 0:t.getStore()?.[kn]?.[e]}var xy=Symbol("lc:configure_hooks"),Ay=()=>Ru(xy)||[];function Iy(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}var Sy=class{setHandler(e){return this.setHandlers([e])}},xn=class{constructor(e,t,a,r,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>we(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,a,r,n){await Promise.all(this.handlers.map(i=>we(async()=>{try{await i.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}},Py=class extends xn{getChild(e){let t=new Et(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}},Nu=class extends xn{async handleLLMNewToken(e,t,a,r,n,i){await Promise.all(this.handlers.map(s=>we(async()=>{if(!s.ignoreLLM)try{await s.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMNewToken: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMError(e,t,a,r,n){await Promise.all(this.handlers.map(i=>we(async()=>{if(!i.ignoreLLM)try{await i.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,n)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMError: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleLLMEnd(e,t,a,r,n){await Promise.all(this.handlers.map(i=>we(async()=>{if(!i.ignoreLLM)try{await i.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,n)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleLLMEnd: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}},$y=class extends xn{getChild(e){let t=new Et(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,a,r,n){await Promise.all(this.handlers.map(i=>we(async()=>{if(!i.ignoreChain)try{await i.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleChainEnd(e,t,a,r,n){await Promise.all(this.handlers.map(i=>we(async()=>{if(!i.ignoreChain)try{await i.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n)}catch(s){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${s}`),i.raiseError)throw s}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Ty=class extends xn{getChild(e){let t=new Et(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>we(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Et=class Wr extends Sy{constructor(t,a){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=a?.handlers??this.handlers,this.inheritableHandlers=a?.inheritableHandlers??this.inheritableHandlers,this.tags=a?.tags??this.tags,this.inheritableTags=a?.inheritableTags??this.inheritableTags,this.metadata=a?.metadata??this.metadata,this.inheritableMetadata=a?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=t}getParentRunId(){return this._parentRunId}async handleLLMStart(t,a,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(a.map(async(u,c)=>{let d=c===0&&r?r:ze();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return wr(h)&&h._createRunForLLMStart(t,[u],d,this._parentRunId,i,this.tags,this.metadata,l),we(async()=>{try{await h.handleLLMStart?.(t,[u],d,this._parentRunId,i,this.tags,this.metadata,l)}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new Nu(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(t,a,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(a.map(async(u,c)=>{let d=c===0&&r?r:ze();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return wr(h)&&h._createRunForChatModelStart(t,[u],d,this._parentRunId,i,this.tags,this.metadata,l),we(async()=>{try{if(h.handleChatModelStart)await h.handleChatModelStart?.(t,[u],d,this._parentRunId,i,this.tags,this.metadata,l);else if(h.handleLLMStart){let p=Al(u);await h.handleLLMStart?.(t,[p],d,this._parentRunId,i,this.tags,this.metadata,l)}}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new Nu(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(t,a,r=ze(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreChain)return wr(l)&&l._createRunForChainStart(t,a,r,this._parentRunId,this.tags,this.metadata,n,o),we(async()=>{try{await l.handleChainStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,n,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleChainStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new $y(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(t,a,r=ze(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreAgent)return wr(l)&&l._createRunForToolStart(t,a,r,this._parentRunId,this.tags,this.metadata,o),we(async()=>{try{await l.handleToolStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleToolStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new Ty(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(t,a,r=ze(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(l=>{if(!l.ignoreRetriever)return wr(l)&&l._createRunForRetrieverStart(t,a,r,this._parentRunId,this.tags,this.metadata,o),we(async()=>{try{await l.handleRetrieverStart?.(t,a,r,this._parentRunId,this.tags,this.metadata,o)}catch(u){if((l.raiseError?console.error:console.warn)(`Error in handler ${l.constructor.name}, handleRetrieverStart: ${u}`),l.raiseError)throw u}},l.awaitHandlers)})),new Py(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(t,a,r,n,i){await Promise.all(this.handlers.map(s=>we(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(t,a,r,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(t,a=!0){this.handlers.push(t),a&&this.inheritableHandlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter(a=>a!==t),this.inheritableHandlers=this.inheritableHandlers.filter(a=>a!==t)}setHandlers(t,a=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of t)this.addHandler(r,a)}addTags(t,a=!0){this.removeTags(t),this.tags.push(...t),a&&this.inheritableTags.push(...t)}removeTags(t){this.tags=this.tags.filter(a=>!t.includes(a)),this.inheritableTags=this.inheritableTags.filter(a=>!t.includes(a))}addMetadata(t,a=!0){this.metadata={...this.metadata,...t},a&&(this.inheritableMetadata={...this.inheritableMetadata,...t})}removeMetadata(t){for(let a of Object.keys(t))delete this.metadata[a],delete this.inheritableMetadata[a]}copy(t=[],a=!0){let r=new Wr(this._parentRunId);for(let n of this.handlers){let i=this.inheritableHandlers.includes(n);r.addHandler(n,i)}for(let n of this.tags){let i=this.inheritableTags.includes(n);r.addTags([n],i)}for(let n of Object.keys(this.metadata)){let i=Object.keys(this.inheritableMetadata).includes(n);r.addMetadata({[n]:this.metadata[n]},i)}for(let n of t)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===n.name)||r.addHandler(n,a);return r}static fromHandlers(t){class a extends ks{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ze()}),Object.assign(this,t)}}let r=new this;return r.addHandler(new a),r}static configure(t,a,r,n,i,s,o){return this._configureSync(t,a,r,n,i,s,o)}static _configureSync(t,a,r,n,i,s,o){let l;(t||a)&&(Array.isArray(t)||!t?(l=new Wr,l.setHandlers(t?.map(An)??[],!0)):l=t,l=l.copy(Array.isArray(a)?a.map(An):a?.handlers,!1));let u=Re("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=Ss.getTraceableRunTree()?.tracingEnabled||ky(),d=c||(Re("LANGCHAIN_TRACING")??!1);if(u||d){if(l||(l=new Wr),u&&!l.handlers.some(h=>h.name===Tu.prototype.name)){let h=new Tu;l.addHandler(h,!0)}if(d&&!l.handlers.some(h=>h.name==="langchain_tracer")&&c){let h=new Ss;l.addHandler(h,!0)}if(c){let h=Ss.getTraceableRunTree();h&&l._parentRunId===void 0&&(l._parentRunId=h.id,l.handlers.find(p=>p.name==="langchain_tracer")?.updateFromRunTree(h))}}for(let{contextVar:h,inheritable:p=!0,handlerClass:f,envVar:m}of Ay()){let g=m&&Re(m)==="true"&&f,_,y=h!==void 0?Ru(h):void 0;y&&_y(y)?_=y:g&&(_=new f({})),_!==void 0&&(l||(l=new Wr),l.handlers.some(b=>b.name===_.name)||l.addHandler(_,p))}return(r||n)&&l&&(l.addTags(r??[]),l.addTags(n??[],!1)),(i||s)&&l&&(l.addMetadata(i??{}),l.addMetadata(s??{},!1)),l}};function An(e){return"name"in e?e:ks.fromMethods(e)}var jy=class{getStore(){}run(e,t){return t()}enterWith(e){}},Ry=new jy,Cu=Symbol.for("lc:child_config"),Ny=class{getInstance(){return Er()??Ry}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[Cu]}runWithConfig(e,t,a){let r=Et._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),n=this.getInstance(),i=n.getStore(),s=r?.getParentRunId(),o=r?.handlers?.find(u=>u?.name==="langchain_tracer"),l;return o&&s?l=o.getRunTreeWithTracingConfig(s):a||(l=new En({name:"<runnable_lambda>",tracingEnabled:!1})),l&&(l.extra={...l.extra,[Cu]:e}),i!==void 0&&i[kn]!==void 0&&(l===void 0&&(l={}),l[kn]=i[kn]),n.run(l,t)}initializeGlobalInstance(e){Er()===void 0&&wy(e)}},Xt=new Ny,$s=25;async function lt(e){return Et._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Ts(...e){let t={};for(let a of e.filter(r=>!!r))for(let r of Object.keys(a))if(r==="metadata")t[r]={...t[r],...a[r]};else if(r==="tags"){let n=t[r]??[];t[r]=[...new Set(n.concat(a[r]??[]))]}else if(r==="configurable")t[r]={...t[r],...a[r]};else if(r==="timeout")t.timeout===void 0?t.timeout=a.timeout:a.timeout!==void 0&&(t.timeout=Math.min(t.timeout,a.timeout));else if(r==="signal")t.signal===void 0?t.signal=a.signal:a.signal!==void 0&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,a.signal]):t.signal=a.signal);else if(r==="callbacks"){let n=t.callbacks,i=a.callbacks;if(Array.isArray(i))if(!n)t.callbacks=i;else if(Array.isArray(n))t.callbacks=n.concat(i);else{let s=n.copy();for(let o of i)s.addHandler(An(o),!0);t.callbacks=s}else if(i)if(!n)t.callbacks=i;else if(Array.isArray(n)){let s=i.copy();for(let o of n)s.addHandler(An(o),!0);t.callbacks=s}else t.callbacks=new Et(i._parentRunId,{handlers:n.handlers.concat(i.handlers),inheritableHandlers:n.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(n.tags.concat(i.tags))),inheritableTags:Array.from(new Set(n.inheritableTags.concat(i.inheritableTags))),metadata:{...n.metadata,...i.metadata}})}else{let n=r;t[n]=a[n]??t[n]}return t}var Cy=new Set(["string","number","boolean"]);function ce(e){let t=Xt.getRunnableConfig(),a={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){let{runId:r,runName:n,...i}=t;a=Object.entries(i).reduce((s,[o,l])=>(l!==void 0&&(s[o]=l),s),a)}if(e&&(a=Object.entries(e).reduce((r,[n,i])=>(i!==void 0&&(r[n]=i),r),a)),a?.configurable)for(let r of Object.keys(a.configurable))Cy.has(typeof a.configurable[r])&&!a.metadata?.[r]&&(a.metadata||(a.metadata={}),a.metadata[r]=a.configurable[r]);if(a.timeout!==void 0){if(a.timeout<=0)throw new Error("Timeout must be a positive number");let r=AbortSignal.timeout(a.timeout);a.signal!==void 0?"any"in AbortSignal&&(a.signal=AbortSignal.any([a.signal,r])):a.signal=r,delete a.timeout}return a}function Ne(e={},{callbacks:t,maxConcurrency:a,recursionLimit:r,runName:n,configurable:i,runId:s}={}){let o=ce(e);return t!==void 0&&(delete o.runName,o.callbacks=t),r!==void 0&&(o.recursionLimit=r),a!==void 0&&(o.maxConcurrency=a),n!==void 0&&(o.runName=n),i!==void 0&&(o.configurable={...o.configurable,...i}),s!==void 0&&delete o.runId,o}function Na(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function Yt(e,t){if(t===void 0)return e;let a;return Promise.race([e.catch(r=>{if(!t?.aborted)throw r}),new Promise((r,n)=>{a=()=>{n(new Error("Aborted"))},t.addEventListener("abort",a),t.aborted&&n(new Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",a))}var kt=class ol extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let t=await this.reader.read();return t.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:t.value}}catch(t){throw this.reader.releaseLock(),t}}async return(){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}return{done:!0,value:void 0}}async throw(t){if(this.ensureReader(),this.locked){let a=this.reader.cancel();this.reader.releaseLock(),await a}throw t}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){let a=t.getReader();return new ol({start(r){return n();function n(){return a.read().then(({done:i,value:s})=>{if(i){r.close();return}return r.enqueue(s),n()})}},cancel(){a.releaseLock()}})}static fromAsyncGenerator(t){return new ol({async pull(a){let{value:r,done:n}=await t.next();n&&a.close(),a.enqueue(r)},async cancel(a){await t.return(a)}})}};function Lu(e,t=2){let a=Array.from({length:t},()=>[]);return a.map(async function*(r){for(;;)if(r.length===0){let n=await e.next();for(let i of a)i.push(n)}else{if(r[0].done)return;yield r.shift().value}})}function In(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if(typeof e=="string"&&typeof t=="string"||typeof e=="number"&&typeof t=="number")return e+t;if("concat"in e&&typeof e.concat=="function")return e.concat(t);if(typeof e=="object"&&typeof t=="object"){let a={...e};for(let[r,n]of Object.entries(t))r in a&&!Array.isArray(a[r])?a[r]=In(a[r],n):a[r]=n;return a}else throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}var Ca=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,a)=>{Xt.runWithConfig(Na(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,a):this.firstResult.then(r=>t(void 0),a)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?Xt.runWithConfig(Na(this.config),this.signal?async()=>Yt(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function Ly(e,t,a,r,...n){let i=new Ca({generator:t,startSetup:a,signal:r}),s=await i.setup;return{output:e(i,s,...n),setup:s}}var Qt=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),a=br({},t);return new Mu({ops:t,state:a[a.length-1].newDocument})}},Mu=class ll extends Qt{constructor(t){super(t),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=t.state}concat(t){let a=this.ops.concat(t.ops),r=br(this.state,t.ops);return new ll({ops:a,state:r[r.length-1].newDocument})}static fromRunLogPatch(t){let a=br({},t.ops);return new ll({ops:t.ops,state:a[a.length-1].newDocument})}},My=e=>e.name==="log_stream_tracer";async function Uu(e,t){if(t==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:a}=e;if(["retriever","llm","prompt"].includes(e.run_type))return a;if(!(Object.keys(a).length===1&&a?.input===""))return a.input}async function zu(e,t){let{outputs:a}=e;return t==="original"||["retriever","llm","prompt"].includes(e.run_type)?a:a!==void 0&&Object.keys(a).length===1&&a?.output!==void 0?a.output:a}function Uy(e){return e!==void 0&&e.message!==void 0}var Du=class extends Or{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],a=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(a=a||t.find(r=>this.includeTags?.includes(r))!==void 0),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(a=a&&t.every(r=>!this.excludeTags?.includes(r))),a}async*tapOutputIterable(e,t){for await(let a of t){if(e!==this.rootId){let r=this.keyMapByRunId[e];r&&await this.writer.write(new Qt({ops:[{op:"add",path:`/logs/${r}/streamed_output/-`,value:a}]}))}yield a}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Qt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let a={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(a.inputs=await Uu(e,this._schemaFormat)),await this.writer.write(new Qt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:a}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let a=[];this._schemaFormat==="streaming_events"&&a.push({op:"replace",path:`/logs/${t}/inputs`,value:await Uu(e,this._schemaFormat)}),a.push({op:"add",path:`/logs/${t}/final_output`,value:await zu(e,this._schemaFormat)}),e.end_time!==void 0&&a.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let r=new Qt({ops:a});await this.writer.write(r)}finally{if(e.id===this.rootId){let t=new Qt({ops:[{op:"replace",path:"/final_output",value:await zu(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,a){let r=this.keyMapByRunId[e.id];if(r===void 0)return;let n=e.inputs.messages!==void 0,i;n?Uy(a?.chunk)?i=a?.chunk:i=new Ya({id:`run-${e.id}`,content:t}):i=t;let s=new Qt({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:i}]});await this.writer.write(s)}},Fu="__run",Sn=class Dh{constructor(t){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=t.text,this.generationInfo=t.generationInfo}concat(t){return new Dh({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo}})}},Pn=class Fh extends Sn{constructor(t){super(t),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=t.message}concat(t){return new Fh({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};function $n({name:e,serialized:t}){return e!==void 0?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}var zy=e=>e.name==="event_stream_tracer",Dy=class extends Or{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=kt.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],a=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(a=a||t.find(r=>this.includeTags?.includes(r))!==void 0),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(a=a&&t.every(r=>!this.excludeTags?.includes(r))),a}async*tapOutputIterable(e,t){let a=await t.next();if(a.done)return;let r=this.runInfoMap.get(e);if(r===void 0){yield a.value;return}function n(s,o){return s==="llm"&&typeof o=="string"?new Sn({text:o}):o}let i=this.tappedPromises.get(e);if(i===void 0){let s;i=new Promise(o=>{s=o}),this.tappedPromises.set(e,i);try{let o={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...o,data:{chunk:n(r.runType,a.value)}},r),yield a.value;for await(let l of t)r.runType!=="tool"&&r.runType!=="retriever"&&await this.send({...o,data:{chunk:n(r.runType,l)}},r),yield l}finally{s()}}else{yield a.value;for await(let s of t)yield s}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let a=this.tappedPromises.get(e.run_id);a!==void 0?a.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=$n(e),a=e.inputs.messages!==void 0?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:a,inputs:e.inputs};this.runInfoMap.set(e.id,r);let n=`on_${a}_start`;await this.send({event:n,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,a){let r=this.runInfoMap.get(e.id),n,i;if(r===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(r.runType==="chat_model")i="on_chat_model_stream",a?.chunk===void 0?n=new Ya({content:t,id:`run-${e.id}`}):n=a.chunk.message;else if(r.runType==="llm")i="on_llm_stream",a?.chunk===void 0?n=new Sn({text:t}):n=a.chunk;else throw new Error(`Unexpected run type ${r.runType}`);await this.send({event:i,data:{chunk:n},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let a;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let r=e.outputs?.generations,n;if(t.runType==="chat_model"){for(let i of r??[]){if(n!==void 0)break;n=i[0]?.message}a="on_chat_model_end"}else if(t.runType==="llm")n={generations:r?.map(i=>i.map(s=>({text:s.text,generationInfo:s.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},a="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:a,data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=$n(e),a=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},n={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(n={},r.inputs={}):e.inputs.input!==void 0?(n.input=e.inputs.input,r.inputs=e.inputs.input):(n.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${a}_start`,data:n,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let a=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},n={output:e.outputs?.output??e.outputs,input:r};r.input&&Object.keys(r).length===1&&(n.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:a,data:n,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=$n(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,a),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},a)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let a=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=$n(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,a){let r=this.runInfoMap.get(a);if(r===void 0)throw new Error(`handleCustomEvent: Run ID ${a} not found in run map.`);await this.send({event:"on_custom_event",run_id:a,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}},Fy=rt(Mi(),1),js=rt(Ui(),1),By=[400,401,402,403,404,405,406,407,409],Zy=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||e.name==="AbortError"||e?.code==="ECONNABORTED")throw e;let t=e?.response?.status??e?.status;if(t&&By.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){let a=new Error(e?.message);throw a.name="InsufficientQuotaError",a}},Rs=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Zy;let t="default"in js.default?js.default.default:js.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Fy.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise((r,n)=>{e.signal?.addEventListener("abort",()=>{n(new Error("AbortError"))})})]):this.call(t,...a)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}},Bu=class extends Or{constructor({config:e,onStart:t,onEnd:a,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=a,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Ns(e){return e?e.lc_runnable:!1}var qy=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let a=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,r=e.tags??[];return this.includeNames!==void 0&&(a=a||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(a=a||this.includeTypes.includes(t)),this.includeTags!==void 0&&(a=a||r.some(n=>this.includeTags?.includes(n))),this.excludeNames!==void 0&&(a=a&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(a=a&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(a=a&&r.every(n=>!this.excludeTags?.includes(n))),a}};function Cs(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}var Hy=["*","_","`"];function Jy(e){let t="";for(let[a,r]of Object.entries(e))t+=`	classDef ${a} ${r};
`;return t}function Gy(e,t,a){let{firstNode:r,lastNode:n,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=a??{},u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){let p="default",f={[p]:"{0}({1})"};r!==void 0&&(f[r]="{0}([{1}]):::first"),n!==void 0&&(f[n]="{0}([{1}]):::last");for(let[m,g]of Object.entries(e)){let _=g.name.split(":").pop()??"",y=Hy.some(w=>_.startsWith(w)&&_.endsWith(w))?`<p>${_}</p>`:_;Object.keys(g.metadata??{}).length&&(y+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([w,O])=>`${w} = ${O}`).join(`
`)}</em></small>`);let b=(f[m]??f[p]).replace("{0}",Cs(m)).replace("{1}",y);u+=`	${b}
`}}let c={};for(let p of t){let f=p.source.split(":"),m=p.target.split(":"),g=f.filter((_,y)=>_===m[y]).join(":");c[g]||(c[g]=[]),c[g].push(p)}let d=new Set;function h(p,f){let m=p.length===1&&p[0].source===p[0].target;if(f&&!m){let g=f.split(":").pop();if(d.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(g),u+=`	subgraph ${g}
`}for(let g of p){let{source:_,target:y,data:b,conditional:w}=g,O="";if(b!==void 0){let I=b,D=I.split(" ");D.length>l&&(I=Array.from({length:Math.ceil(D.length/l)},(j,K)=>D.slice(K*l,(K+1)*l).join(" ")).join("&nbsp;<br>&nbsp;")),O=w?` -. &nbsp;${I}&nbsp; .-> `:` -- &nbsp;${I}&nbsp; --> `}else O=w?" -.-> ":" --> ";u+=`	${Cs(_)}${O}${Cs(y)};
`}for(let g in c)g.startsWith(`${f}:`)&&g!==f&&h(c[g],g);f&&!m&&(u+=`	end
`)}h(c[""]??[],"");for(let p in c)!p.includes(":")&&p!==""&&h(c[p],p);return s&&(u+=Jy(i??{})),u}async function Wy(e,t){return Ky(e,{...t,imageType:"png"})}async function Ky(e,t){let a=t?.backgroundColor??"white",r=t?.imageType??"png",n=btoa(e);a!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(a)||(a=`!${a}`));let i=`https://mermaid.ink/img/${n}?bgColor=${a}&type=${r}`,s=await fetch(i);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}var Gw=Object.freeze({status:"aborted"});function Tn(e,t,a){function r(o,l){var u;Object.defineProperty(o,"_zod",{value:o._zod??{},enumerable:!1}),(u=o._zod).traits??(u.traits=new Set),o._zod.traits.add(e),t(o,l);for(let c in s.prototype)c in o||Object.defineProperty(o,c,{value:s.prototype[c].bind(o)});o._zod.constr=s,o._zod.def=l}let n=a?.Parent??Object;class i extends n{}Object.defineProperty(i,"name",{value:e});function s(o){var l;let u=a?.Parent?new i:this;r(u,o),(l=u._zod).deferred??(l.deferred=[]);for(let c of u._zod.deferred)c();return u}return Object.defineProperty(s,"init",{value:r}),Object.defineProperty(s,Symbol.hasInstance,{value:o=>a?.Parent&&o instanceof a.Parent?!0:o?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}var Ww=Symbol("zod_brand"),jn=class extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}},Zu={};function Rn(e){return e&&Object.assign(Zu,e),Zu}function Vy(e){let t=Object.values(e).filter(a=>typeof a=="number");return Object.entries(e).filter(([a,r])=>t.indexOf(+a)===-1).map(([a,r])=>r)}function Xy(e,t){return typeof t=="bigint"?t.toString():t}function Yy(e){return{get value(){{let t=e();return Object.defineProperty(this,"value",{value:t}),t}throw new Error("cached value already set")}}}var qu=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{},Kw=Yy(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{let e=Function;return new e(""),!0}catch{return!1}});function Nn(e,t,a){let r=new e._zod.constr(t??e._zod.def);return(!t||a?.parent)&&(r._zod.parent=e),r}function Qy(e){let t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}var Vw={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function Ls(e,t=0){for(let a=t;a<e.issues.length;a++)if(e.issues[a]?.continue!==!0)return!0;return!1}function Cn(e){return typeof e=="string"?e:e?.message}function Ln(e,t,a){let r={...e,path:e.path??[]};if(!e.message){let n=Cn(e.inst?._zod.def?.error?.(e))??Cn(t?.error?.(e))??Cn(a.customError?.(e))??Cn(a.localeError?.(e))??"Invalid input";r.message=n}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}var Hu=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get(){return JSON.stringify(t,Xy,2)},enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},e0=Tn("$ZodError",Hu),Mn=Tn("$ZodError",Hu,{Parent:Error}),t0=e=>(t,a,r,n)=>{let i=r?Object.assign(r,{async:!1}):{async:!1},s=t._zod.run({value:a,issues:[]},i);if(s instanceof Promise)throw new jn;if(s.issues.length){let o=new(n?.Err??e)(s.issues.map(l=>Ln(l,i,Rn())));throw qu(o,n?.callee),o}return s.value},a0=t0(Mn),r0=e=>async(t,a,r,n)=>{let i=r?Object.assign(r,{async:!0}):{async:!0},s=t._zod.run({value:a,issues:[]},i);if(s instanceof Promise&&(s=await s),s.issues.length){let o=new(n?.Err??e)(s.issues.map(l=>Ln(l,i,Rn())));throw qu(o,n?.callee),o}return s.value},n0=r0(Mn),i0=e=>(t,a,r)=>{let n=r?{...r,async:!1}:{async:!1},i=t._zod.run({value:a,issues:[]},n);if(i instanceof Promise)throw new jn;return i.issues.length?{success:!1,error:new(e??e0)(i.issues.map(s=>Ln(s,n,Rn())))}:{success:!0,data:i.value}},s0=i0(Mn),o0=e=>async(t,a,r)=>{let n=r?Object.assign(r,{async:!0}):{async:!0},i=t._zod.run({value:a,issues:[]},n);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(s=>Ln(s,n,Rn())))}:{success:!0,data:i.value}},l0=o0(Mn),u0={major:4,minor:0,patch:0},c0=Tn("$ZodType",(e,t)=>{var a;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=u0;let r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(let n of r)for(let i of n._zod.onattach)i(e);if(r.length===0)(a=e._zod).deferred??(a.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{let n=(i,s,o)=>{let l=Ls(i),u;for(let c of s){if(c._zod.def.when){if(!c._zod.def.when(i))continue}else if(l)continue;let d=i.issues.length,h=c._zod.check(i);if(h instanceof Promise&&o?.async===!1)throw new jn;if(u||h instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await h,i.issues.length!==d&&(l||(l=Ls(i,d)))});else{if(i.issues.length===d)continue;l||(l=Ls(i,d))}}return u?u.then(()=>i):i};e._zod.run=(i,s)=>{let o=e._zod.parse(i,s);if(o instanceof Promise){if(s.async===!1)throw new jn;return o.then(l=>n(l,r,s))}return n(o,r,s)}}e["~standard"]={validate:n=>{try{let i=s0(e,n);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return l0(e,n).then(i=>i.success?{value:i.data}:{issues:i.error?.issues})}},vendor:"zod",version:1}}),d0=Tn("$ZodNever",(e,t)=>{c0.init(e,t),e._zod.parse=(a,r)=>(a.issues.push({expected:"never",code:"invalid_type",input:a.value,inst:e}),a)}),Xw=Symbol("ZodOutput"),Yw=Symbol("ZodInput"),Ju=class{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){let a=t[0];if(this._map.set(e,a),a&&typeof a=="object"&&"id"in a){if(this._idmap.has(a.id))throw new Error(`ID ${a.id} already exists in the registry`);this._idmap.set(a.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&typeof t=="object"&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let a={...this.get(t)??{}};return delete a.id,{...a,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}};function h0(){return new Ju}var ea=h0();function p0(e,t){return new e({type:"never",...Qy(t)})}var Gu=class{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??ea,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var a;let r=e._zod.def,n={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},i=this.seen.get(e);if(i)return i.count++,t.schemaPath.includes(e)&&(i.cycle=t.path),i.schema;let s={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,s);let o=e._zod.toJSONSchema?.();if(o)s.schema=o;else{let u={...t,schemaPath:[...t.schemaPath,e],path:t.path},c=e._zod.parent;if(c)s.ref=c,this.process(c,u),this.seen.get(c).isParent=!0;else{let d=s.schema;switch(r.type){case"string":{let h=d;h.type="string";let{minimum:p,maximum:f,format:m,patterns:g,contentEncoding:_}=e._zod.bag;if(typeof p=="number"&&(h.minLength=p),typeof f=="number"&&(h.maxLength=f),m&&(h.format=n[m]??m,h.format===""&&delete h.format),_&&(h.contentEncoding=_),g&&g.size>0){let y=[...g];y.length===1?h.pattern=y[0].source:y.length>1&&(s.schema.allOf=[...y.map(b=>({...this.target==="draft-7"?{type:"string"}:{},pattern:b.source}))])}break}case"number":{let h=d,{minimum:p,maximum:f,format:m,multipleOf:g,exclusiveMaximum:_,exclusiveMinimum:y}=e._zod.bag;typeof m=="string"&&m.includes("int")?h.type="integer":h.type="number",typeof y=="number"&&(h.exclusiveMinimum=y),typeof p=="number"&&(h.minimum=p,typeof y=="number"&&(y>=p?delete h.minimum:delete h.exclusiveMinimum)),typeof _=="number"&&(h.exclusiveMaximum=_),typeof f=="number"&&(h.maximum=f,typeof _=="number"&&(_<=f?delete h.maximum:delete h.exclusiveMaximum)),typeof g=="number"&&(h.multipleOf=g);break}case"boolean":{let h=d;h.type="boolean";break}case"bigint":{if(this.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema");break}case"symbol":{if(this.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema");break}case"null":{d.type="null";break}case"any":break;case"unknown":break;case"undefined":{if(this.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema");break}case"void":{if(this.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema");break}case"never":{d.not={};break}case"date":{if(this.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema");break}case"array":{let h=d,{minimum:p,maximum:f}=e._zod.bag;typeof p=="number"&&(h.minItems=p),typeof f=="number"&&(h.maxItems=f),h.type="array",h.items=this.process(r.element,{...u,path:[...u.path,"items"]});break}case"object":{let h=d;h.type="object",h.properties={};let p=r.shape;for(let g in p)h.properties[g]=this.process(p[g],{...u,path:[...u.path,"properties",g]});let f=new Set(Object.keys(p)),m=new Set([...f].filter(g=>{let _=r.shape[g]._zod;return this.io==="input"?_.optin===void 0:_.optout===void 0}));m.size>0&&(h.required=Array.from(m)),r.catchall?._zod.def.type==="never"?h.additionalProperties=!1:r.catchall?r.catchall&&(h.additionalProperties=this.process(r.catchall,{...u,path:[...u.path,"additionalProperties"]})):this.io==="output"&&(h.additionalProperties=!1);break}case"union":{let h=d;h.anyOf=r.options.map((p,f)=>this.process(p,{...u,path:[...u.path,"anyOf",f]}));break}case"intersection":{let h=d,p=this.process(r.left,{...u,path:[...u.path,"allOf",0]}),f=this.process(r.right,{...u,path:[...u.path,"allOf",1]}),m=_=>"allOf"in _&&Object.keys(_).length===1,g=[...m(p)?p.allOf:[p],...m(f)?f.allOf:[f]];h.allOf=g;break}case"tuple":{let h=d;h.type="array";let p=r.items.map((g,_)=>this.process(g,{...u,path:[...u.path,"prefixItems",_]}));if(this.target==="draft-2020-12"?h.prefixItems=p:h.items=p,r.rest){let g=this.process(r.rest,{...u,path:[...u.path,"items"]});this.target==="draft-2020-12"?h.items=g:h.additionalItems=g}r.rest&&(h.items=this.process(r.rest,{...u,path:[...u.path,"items"]}));let{minimum:f,maximum:m}=e._zod.bag;typeof f=="number"&&(h.minItems=f),typeof m=="number"&&(h.maxItems=m);break}case"record":{let h=d;h.type="object",h.propertyNames=this.process(r.keyType,{...u,path:[...u.path,"propertyNames"]}),h.additionalProperties=this.process(r.valueType,{...u,path:[...u.path,"additionalProperties"]});break}case"map":{if(this.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema");break}case"set":{if(this.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema");break}case"enum":{let h=d,p=Vy(r.entries);p.every(f=>typeof f=="number")&&(h.type="number"),p.every(f=>typeof f=="string")&&(h.type="string"),h.enum=p;break}case"literal":{let h=d,p=[];for(let f of r.values)if(f===void 0){if(this.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof f=="bigint"){if(this.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");p.push(Number(f))}else p.push(f);if(p.length!==0)if(p.length===1){let f=p[0];h.type=f===null?"null":typeof f,h.const=f}else p.every(f=>typeof f=="number")&&(h.type="number"),p.every(f=>typeof f=="string")&&(h.type="string"),p.every(f=>typeof f=="boolean")&&(h.type="string"),p.every(f=>f===null)&&(h.type="null"),h.enum=p;break}case"file":{let h=d,p={type:"string",format:"binary",contentEncoding:"binary"},{minimum:f,maximum:m,mime:g}=e._zod.bag;f!==void 0&&(p.minLength=f),m!==void 0&&(p.maxLength=m),g?g.length===1?(p.contentMediaType=g[0],Object.assign(h,p)):h.anyOf=g.map(_=>({...p,contentMediaType:_})):Object.assign(h,p);break}case"transform":{if(this.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema");break}case"nullable":{let h=this.process(r.innerType,u);d.anyOf=[h,{type:"null"}];break}case"nonoptional":{this.process(r.innerType,u),s.ref=r.innerType;break}case"success":{let h=d;h.type="boolean";break}case"default":{this.process(r.innerType,u),s.ref=r.innerType,d.default=JSON.parse(JSON.stringify(r.defaultValue));break}case"prefault":{this.process(r.innerType,u),s.ref=r.innerType,this.io==="input"&&(d._prefault=JSON.parse(JSON.stringify(r.defaultValue)));break}case"catch":{this.process(r.innerType,u),s.ref=r.innerType;let h;try{h=r.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}d.default=h;break}case"nan":{if(this.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema");break}case"template_literal":{let h=d,p=e._zod.pattern;if(!p)throw new Error("Pattern not found in template literal");h.type="string",h.pattern=p.source;break}case"pipe":{let h=this.io==="input"?r.in._zod.def.type==="transform"?r.out:r.in:r.out;this.process(h,u),s.ref=h;break}case"readonly":{this.process(r.innerType,u),s.ref=r.innerType,d.readOnly=!0;break}case"promise":{this.process(r.innerType,u),s.ref=r.innerType;break}case"optional":{this.process(r.innerType,u),s.ref=r.innerType;break}case"lazy":{let h=e._zod.innerType;this.process(h,u),s.ref=h;break}case"custom":{if(this.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema");break}default:}}}let l=this.metadataRegistry.get(e);return l&&Object.assign(s.schema,l),this.io==="input"&&Oe(e)&&(delete s.schema.examples,delete s.schema.default),this.io==="input"&&s.schema._prefault&&((a=s.schema).default??(a.default=s.schema._prefault)),delete s.schema._prefault,this.seen.get(e).schema}emit(e,t){let a={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},r=this.seen.get(e);if(!r)throw new Error("Unprocessed schema. This is a bug in Zod.");let n=u=>{let c=this.target==="draft-2020-12"?"$defs":"definitions";if(a.external){let p=a.external.registry.get(u[0])?.id,f=a.external.uri??(g=>g);if(p)return{ref:f(p)};let m=u[1].defId??u[1].schema.id??`schema${this.counter++}`;return u[1].defId=m,{defId:m,ref:`${f("__shared")}#/${c}/${m}`}}if(u[1]===r)return{ref:"#"};let d=`#/${c}/`,h=u[1].schema.id??`__schema${this.counter++}`;return{defId:h,ref:d+h}},i=u=>{if(u[1].schema.$ref)return;let c=u[1],{ref:d,defId:h}=n(u);c.def={...c.schema},h&&(c.defId=h);let p=c.schema;for(let f in p)delete p[f];p.$ref=d};if(a.cycles==="throw")for(let u of this.seen.entries()){let c=u[1];if(c.cycle)throw new Error(`Cycle detected: #/${c.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(let u of this.seen.entries()){let c=u[1];if(e===u[0]){i(u);continue}if(a.external){let d=a.external.registry.get(u[0])?.id;if(e!==u[0]&&d){i(u);continue}}if(this.metadataRegistry.get(u[0])?.id){i(u);continue}if(c.cycle){i(u);continue}if(c.count>1&&a.reused==="ref"){i(u);continue}}let s=(u,c)=>{let d=this.seen.get(u),h=d.def??d.schema,p={...h};if(d.ref===null)return;let f=d.ref;if(d.ref=null,f){s(f,c);let m=this.seen.get(f).schema;m.$ref&&c.target==="draft-7"?(h.allOf=h.allOf??[],h.allOf.push(m)):(Object.assign(h,m),Object.assign(h,p))}d.isParent||this.override({zodSchema:u,jsonSchema:h,path:d.path??[]})};for(let u of[...this.seen.entries()].reverse())s(u[0],{target:this.target});let o={};if(this.target==="draft-2020-12"?o.$schema="https://json-schema.org/draft/2020-12/schema":this.target==="draft-7"?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),a.external?.uri){let u=a.external.registry.get(e)?.id;if(!u)throw new Error("Schema is missing an `id` property");o.$id=a.external.uri(u)}Object.assign(o,r.def);let l=a.external?.defs??{};for(let u of this.seen.entries()){let c=u[1];c.def&&c.defId&&(l[c.defId]=c.def)}a.external||Object.keys(l).length>0&&(this.target==="draft-2020-12"?o.$defs=l:o.definitions=l);try{return JSON.parse(JSON.stringify(o))}catch{throw new Error("Error converting schema to JSON.")}}};function Wu(e,t){if(e instanceof Ju){let r=new Gu(t),n={};for(let o of e._idmap.entries()){let[l,u]=o;r.process(u)}let i={},s={registry:e,uri:t?.uri,defs:n};for(let o of e._idmap.entries()){let[l,u]=o;i[l]=r.emit(u,{...t,external:s})}if(Object.keys(n).length>0){let o=r.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[o]:n}}return{schemas:i}}let a=new Gu(t);return a.process(e),a.emit(e,t)}function Oe(e,t){let a=t??{seen:new Set};if(a.seen.has(e))return!1;a.seen.add(e);let r=e._zod.def;switch(r.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":return!1;case"array":return Oe(r.element,a);case"object":{for(let n in r.shape)if(Oe(r.shape[n],a))return!0;return!1}case"union":{for(let n of r.options)if(Oe(n,a))return!0;return!1}case"intersection":return Oe(r.left,a)||Oe(r.right,a);case"tuple":{for(let n of r.items)if(Oe(n,a))return!0;return!!(r.rest&&Oe(r.rest,a))}case"record":return Oe(r.keyType,a)||Oe(r.valueType,a);case"map":return Oe(r.keyType,a)||Oe(r.valueType,a);case"set":return Oe(r.valueType,a);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":return Oe(r.innerType,a);case"lazy":return Oe(r.getter(),a);case"default":return Oe(r.innerType,a);case"prefault":return Oe(r.innerType,a);case"custom":return!1;case"transform":return!0;case"pipe":return Oe(r.in,a)||Oe(r.out,a);case"success":return!1;case"catch":return!1;default:}throw new Error(`Unknown schema type: ${r.type}`)}var f0=Symbol("Let zodToJsonSchema decide on which parser to use"),Ku={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},m0=e=>typeof e=="string"?{...Ku,name:e}:{...Ku,...e},g0=e=>{let t=m0(e),a=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([r,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,r],jsonSchema:void 0}]))}};function Vu(e,t,a,r){r?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function pe(e,t,a,r,n){e[t]=a,Vu(e,t,r,n)}var Xu=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")};function He(e){if(e.target!=="openAi")return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:e.$refStrategy==="relative"?Xu(t,e.currentPath):t.join("/")}}function y0(e,t){let a={type:"array"};return e.type?._def&&e.type?._def?.typeName!==v.ZodAny&&(a.items=de(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&pe(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&pe(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(pe(a,"minItems",e.exactLength.value,e.exactLength.message,t),pe(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}function _0(e,t){let a={type:"integer",format:"int64"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"min":t.target==="jsonSchema7"?r.inclusive?pe(a,"minimum",r.value,r.message,t):pe(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),pe(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?pe(a,"maximum",r.value,r.message,t):pe(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),pe(a,"maximum",r.value,r.message,t));break;case"multipleOf":pe(a,"multipleOf",r.value,r.message,t);break}return a}function b0(){return{type:"boolean"}}function Yu(e,t){return de(e.type._def,t)}var v0=(e,t)=>de(e.innerType._def,t);function Qu(e,t,a){let r=a??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,i)=>Qu(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return w0(e,t)}}var w0=(e,t)=>{let a={type:"integer",format:"unix-time"};if(t.target==="openApi3")return a;for(let r of e.checks)switch(r.kind){case"min":pe(a,"minimum",r.value,r.message,t);break;case"max":pe(a,"maximum",r.value,r.message,t);break}return a};function O0(e,t){return{...de(e.innerType._def,t),default:e.defaultValue()}}function E0(e,t){return t.effectStrategy==="input"?de(e.schema._def,t):He(t)}function k0(e){return{type:"string",enum:Array.from(e.values)}}var x0=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function A0(e,t){let a=[de(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),de(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(i=>!!i),r=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,n=[];return a.forEach(i=>{if(x0(i))n.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let s=i;if("additionalProperties"in i&&i.additionalProperties===!1){let{additionalProperties:o,...l}=i;s=l}else r=void 0;n.push(s)}}),n.length?{allOf:n,...r}:void 0}function I0(e,t){let a=typeof e.value;return a!=="bigint"&&a!=="number"&&a!=="boolean"&&a!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:a==="bigint"?"integer":a,enum:[e.value]}:{type:a==="bigint"?"integer":a,const:e.value}}var Ms,ut={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ms===void 0&&(Ms=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ms),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function ec(e,t){let a={type:"string"};if(e.checks)for(let r of e.checks)switch(r.kind){case"min":pe(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,r.value):r.value,r.message,t);break;case"max":pe(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":ct(a,"email",r.message,t);break;case"format:idn-email":ct(a,"idn-email",r.message,t);break;case"pattern:zod":Fe(a,ut.email,r.message,t);break}break;case"url":ct(a,"uri",r.message,t);break;case"uuid":ct(a,"uuid",r.message,t);break;case"regex":Fe(a,r.regex,r.message,t);break;case"cuid":Fe(a,ut.cuid,r.message,t);break;case"cuid2":Fe(a,ut.cuid2,r.message,t);break;case"startsWith":Fe(a,RegExp(`^${Us(r.value,t)}`),r.message,t);break;case"endsWith":Fe(a,RegExp(`${Us(r.value,t)}$`),r.message,t);break;case"datetime":ct(a,"date-time",r.message,t);break;case"date":ct(a,"date",r.message,t);break;case"time":ct(a,"time",r.message,t);break;case"duration":ct(a,"duration",r.message,t);break;case"length":pe(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,r.value):r.value,r.message,t),pe(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,r.value):r.value,r.message,t);break;case"includes":{Fe(a,RegExp(Us(r.value,t)),r.message,t);break}case"ip":{r.version!=="v6"&&ct(a,"ipv4",r.message,t),r.version!=="v4"&&ct(a,"ipv6",r.message,t);break}case"base64url":Fe(a,ut.base64url,r.message,t);break;case"jwt":Fe(a,ut.jwt,r.message,t);break;case"cidr":{r.version!=="v6"&&Fe(a,ut.ipv4Cidr,r.message,t),r.version!=="v4"&&Fe(a,ut.ipv6Cidr,r.message,t);break}case"emoji":Fe(a,ut.emoji(),r.message,t);break;case"ulid":{Fe(a,ut.ulid,r.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{ct(a,"binary",r.message,t);break}case"contentEncoding:base64":{pe(a,"contentEncoding","base64",r.message,t);break}case"pattern:zod":{Fe(a,ut.base64,r.message,t);break}}break}case"nanoid":Fe(a,ut.nanoid,r.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return a}function Us(e,t){return t.patternStrategy==="escape"?P0(e):e}var S0=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function P0(e){let t="";for(let a=0;a<e.length;a++)S0.has(e[a])||(t+="\\"),t+=e[a];return t}function ct(e,t,a,r){e.format||e.anyOf?.some(n=>n.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&r.errorMessages&&{errorMessage:{format:a}}})):pe(e,"format",t,a,r)}function Fe(e,t,a,r){e.pattern||e.allOf?.some(n=>n.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:tc(t,r),...a&&r.errorMessages&&{errorMessage:{pattern:a}}})):pe(e,"pattern",tc(t,r),a,r)}function tc(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let a={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},r=a.i?e.source.toLowerCase():e.source,n="",i=!1,s=!1,o=!1;for(let l=0;l<r.length;l++){if(i){n+=r[l],i=!1;continue}if(a.i){if(s){if(r[l].match(/[a-z]/)){o?(n+=r[l],n+=`${r[l-2]}-${r[l]}`.toUpperCase(),o=!1):r[l+1]==="-"&&r[l+2]?.match(/[a-z]/)?(n+=r[l],o=!0):n+=`${r[l]}${r[l].toUpperCase()}`;continue}}else if(r[l].match(/[a-z]/)){n+=`[${r[l]}${r[l].toUpperCase()}]`;continue}}if(a.m){if(r[l]==="^"){n+=`(^|(?<=[\r
]))`;continue}else if(r[l]==="$"){n+=`($|(?=[\r
]))`;continue}}if(a.s&&r[l]==="."){n+=s?`${r[l]}\r
`:`[${r[l]}\r
]`;continue}n+=r[l],r[l]==="\\"?i=!0:s&&r[l]==="]"?s=!1:!s&&r[l]==="["&&(s=!0)}try{new RegExp(n)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return n}function ac(e,t){if(t.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),t.target==="openApi3"&&e.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:de(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??He(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let a={type:"object",additionalProperties:de(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if(t.target==="openApi3")return a;if(e.keyType?._def.typeName===v.ZodString&&e.keyType._def.checks?.length){let{type:r,...n}=ec(e.keyType._def,t);return{...a,propertyNames:n}}else{if(e.keyType?._def.typeName===v.ZodEnum)return{...a,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===v.ZodBranded&&e.keyType._def.type._def.typeName===v.ZodString&&e.keyType._def.type._def.checks?.length){let{type:r,...n}=Yu(e.keyType._def,t);return{...a,propertyNames:n}}}return a}function $0(e,t){if(t.mapStrategy==="record")return ac(e,t);let a=de(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||He(t),r=de(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||He(t);return{type:"array",maxItems:125,items:{type:"array",items:[a,r],minItems:2,maxItems:2}}}function T0(e){let t=e.values,a=Object.keys(e.values).filter(n=>typeof t[t[n]]!="number").map(n=>t[n]),r=Array.from(new Set(a.map(n=>typeof n)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:a}}function j0(e){return e.target==="openAi"?void 0:{not:He({...e,currentPath:[...e.currentPath,"not"]})}}function R0(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Un={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function N0(e,t){if(t.target==="openApi3")return rc(e,t);let a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every(r=>r._def.typeName in Un&&(!r._def.checks||!r._def.checks.length))){let r=a.reduce((n,i)=>{let s=Un[i._def.typeName];return s&&!n.includes(s)?[...n,s]:n},[]);return{type:r.length>1?r:r[0]}}else if(a.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=a.reduce((n,i)=>{let s=typeof i._def.value;switch(s){case"string":case"number":case"boolean":return[...n,s];case"bigint":return[...n,"integer"];case"object":if(i._def.value===null)return[...n,"null"];case"symbol":case"undefined":case"function":default:return n}},[]);if(r.length===a.length){let n=r.filter((i,s,o)=>o.indexOf(i)===s);return{type:n.length>1?n:n[0],enum:a.reduce((i,s)=>i.includes(s._def.value)?i:[...i,s._def.value],[])}}}else if(a.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:a.reduce((r,n)=>[...r,...n._def.values.filter(i=>!r.includes(i))],[])};return rc(e,t)}var rc=(e,t)=>{let a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((r,n)=>de(r._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(r=>!!r&&(!t.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return a.length?{anyOf:a}:void 0};function C0(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"?{type:Un[e.innerType._def.typeName],nullable:!0}:{type:[Un[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){let r=de(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let a=de(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}function L0(e,t){let a={type:"number"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"int":a.type="integer",Vu(a,"type",r.message,t);break;case"min":t.target==="jsonSchema7"?r.inclusive?pe(a,"minimum",r.value,r.message,t):pe(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),pe(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?pe(a,"maximum",r.value,r.message,t):pe(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),pe(a,"maximum",r.value,r.message,t));break;case"multipleOf":pe(a,"multipleOf",r.value,r.message,t);break}return a}function M0(e,t){let a=t.target==="openAi",r={type:"object",properties:{}},n=[],i=e.shape();for(let o in i){let l=i[o];if(l===void 0||l._def===void 0)continue;let u=z0(l);u&&a&&(l._def.typeName==="ZodOptional"&&(l=l._def.innerType),l.isNullable()||(l=l.nullable()),u=!1);let c=de(l._def,{...t,currentPath:[...t.currentPath,"properties",o],propertyPath:[...t.currentPath,"properties",o]});c!==void 0&&(r.properties[o]=c,u||n.push(o))}n.length&&(r.required=n);let s=U0(e,t);return s!==void 0&&(r.additionalProperties=s),r}function U0(e,t){if(e.catchall._def.typeName!=="ZodNever")return de(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return t.removeAdditionalStrategy==="strict"?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}function z0(e){try{return e.isOptional()}catch{return!0}}var D0=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return de(e.innerType._def,t);let a=de(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:He(t)},a]}:He(t)},F0=(e,t)=>{if(t.pipeStrategy==="input")return de(e.in._def,t);if(t.pipeStrategy==="output")return de(e.out._def,t);let a=de(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),r=de(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]});return{allOf:[a,r].filter(n=>n!==void 0)}};function B0(e,t){return de(e.type._def,t)}function Z0(e,t){let a={type:"array",uniqueItems:!0,items:de(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&pe(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&pe(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}function q0(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((a,r)=>de(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[]),additionalItems:de(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((a,r)=>de(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[])}}function H0(e){return{not:He(e)}}function J0(e){return He(e)}var G0=(e,t)=>de(e.innerType._def,t),W0=(e,t,a)=>{switch(t){case v.ZodString:return ec(e,a);case v.ZodNumber:return L0(e,a);case v.ZodObject:return M0(e,a);case v.ZodBigInt:return _0(e,a);case v.ZodBoolean:return b0();case v.ZodDate:return Qu(e,a);case v.ZodUndefined:return H0(a);case v.ZodNull:return R0(a);case v.ZodArray:return y0(e,a);case v.ZodUnion:case v.ZodDiscriminatedUnion:return N0(e,a);case v.ZodIntersection:return A0(e,a);case v.ZodTuple:return q0(e,a);case v.ZodRecord:return ac(e,a);case v.ZodLiteral:return I0(e,a);case v.ZodEnum:return k0(e);case v.ZodNativeEnum:return T0(e);case v.ZodNullable:return C0(e,a);case v.ZodOptional:return D0(e,a);case v.ZodMap:return $0(e,a);case v.ZodSet:return Z0(e,a);case v.ZodLazy:return()=>e.getter()._def;case v.ZodPromise:return B0(e,a);case v.ZodNaN:case v.ZodNever:return j0(a);case v.ZodEffects:return E0(e,a);case v.ZodAny:return He(a);case v.ZodUnknown:return J0(a);case v.ZodDefault:return O0(e,a);case v.ZodBranded:return Yu(e,a);case v.ZodReadonly:return G0(e,a);case v.ZodCatch:return v0(e,a);case v.ZodPipeline:return F0(e,a);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(r=>{})(t)}};function de(e,t,a=!1){let r=t.seen.get(e);if(t.override){let o=t.override?.(e,t,r,a);if(o!==f0)return o}if(r&&!a){let o=K0(r,t);if(o!==void 0)return o}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=W0(e,e.typeName,t),s=typeof i=="function"?de(i(),t):i;if(s&&V0(e,t,s),t.postProcess){let o=t.postProcess(s,e,t);return n.jsonSchema=s,o}return n.jsonSchema=s,s}var K0=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Xu(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((a,r)=>t.currentPath[r]===a)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),He(t)):t.$refStrategy==="seen"?He(t):void 0}},V0=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a),nc=(e,t)=>{let a=g0(t),r=typeof t=="object"&&t.definitions?Object.entries(t.definitions).reduce((l,[u,c])=>({...l,[u]:de(c._def,{...a,currentPath:[...a.basePath,a.definitionPath,u]},!0)??He(a)}),{}):void 0,n=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,i=de(e._def,n===void 0?a:{...a,currentPath:[...a.basePath,a.definitionPath,n]},!1)??He(a),s=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;s!==void 0&&(i.title=s),a.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[a.openAiAnyTypeName]||(r[a.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:a.$refStrategy==="relative"?"1":[...a.basePath,a.definitionPath,a.openAiAnyTypeName].join("/")}}));let o=n===void 0?r?{...i,[a.definitionPath]:r}:i:{$ref:[...a.$refStrategy==="relative"?[]:a.basePath,a.definitionPath,n].join("/"),[a.definitionPath]:{...r,[n]:i}};return a.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(a.target==="jsonSchema2019-09"||a.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),a.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function La(e,t){let a=typeof e;if(a!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let r=e.length;if(r!==t.length)return!1;for(let n=0;n<r;n++)if(!La(e[n],t[n]))return!1;return!0}if(a==="object"){if(!e||!t)return e===t;let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let i of r)if(!La(e[i],t[i]))return!1;return!0}return e===t}function dt(e){return encodeURI(X0(e))}function X0(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}var Y0={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Q0={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},e_={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0},t_=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function xr(e,t=Object.create(null),a=t_,r=""){if(e&&typeof e=="object"&&!Array.isArray(e)){let i=e.$id||e.id;if(i){let s=new URL(i,a.href);s.hash.length>1?t[s.href]=e:(s.hash="",r===""?a=s:xr(e,t,a))}}else if(e!==!0&&e!==!1)return t;let n=a.href+(r?"#"+r:"");if(t[n]!==void 0)throw new Error(`Duplicate schema URI "${n}".`);if(t[n]=e,e===!0||e===!1)return t;if(e.__absolute_uri__===void 0&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:n}),e.$ref&&e.__absolute_ref__===void 0){let i=new URL(e.$ref,a.href);i.hash=i.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:i.href})}if(e.$recursiveRef&&e.__absolute_recursive_ref__===void 0){let i=new URL(e.$recursiveRef,a.href);i.hash=i.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:i.href})}if(e.$anchor){let i=new URL("#"+e.$anchor,a.href);t[i.href]=e}for(let i in e){if(e_[i])continue;let s=`${r}/${dt(i)}`,o=e[i];if(Array.isArray(o)){if(Y0[i]){let l=o.length;for(let u=0;u<l;u++)xr(o[u],t,a,`${s}/${u}`)}}else if(Q0[i])for(let l in o)xr(o[l],t,a,`${s}/${dt(l)}`);else xr(o,t,a,s)}return t}var a_=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,r_=[0,31,28,31,30,31,30,31,31,30,31,30,31],n_=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,i_=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,s_=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,o_=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,l_=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,u_=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,c_=/^(?:\/(?:[^~/]|~0|~1)*)*$/,d_=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,h_=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,p_=e=>{if(e[0]==='"')return!1;let[t,a,...r]=e.split("@");return!t||!a||r.length!==0||t.length>64||a.length>253||t[0]==="."||t.endsWith(".")||t.includes("..")||!/^[a-z0-9.-]+$/i.test(a)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)?!1:a.split(".").every(n=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(n))},f_=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,m_=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,g_=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e));function xt(e){return e.test.bind(e)}var ic={date:sc,time:oc.bind(void 0,!1),"date-time":b_,duration:g_,uri:O_,"uri-reference":xt(s_),"uri-template":xt(o_),url:xt(l_),email:p_,hostname:xt(i_),ipv4:xt(f_),ipv6:xt(m_),regex:k_,uuid:xt(u_),"json-pointer":xt(c_),"json-pointer-uri-fragment":xt(d_),"relative-json-pointer":xt(h_)};function y_(e){return e%4===0&&(e%100!==0||e%400===0)}function sc(e){let t=e.match(a_);if(!t)return!1;let a=+t[1],r=+t[2],n=+t[3];return r>=1&&r<=12&&n>=1&&n<=(r==2&&y_(a)?29:r_[r])}function oc(e,t){let a=t.match(n_);if(!a)return!1;let r=+a[1],n=+a[2],i=+a[3],s=!!a[5];return(r<=23&&n<=59&&i<=59||r==23&&n==59&&i==60)&&(!e||s)}var __=/t|\s/i;function b_(e){let t=e.split(__);return t.length==2&&sc(t[0])&&oc(!0,t[1])}var v_=/\/|:/,w_=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function O_(e){return v_.test(e)&&w_.test(e)}var E_=/[^\\]\\Z/;function k_(e){if(E_.test(e))return!1;try{return new RegExp(e,"u"),!0}catch{return!1}}var lc;(function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"})(lc||(lc={}));function x_(e){let t=0,a=e.length,r=0,n;for(;r<a;)t++,n=e.charCodeAt(r++),n>=55296&&n<=56319&&r<a&&(n=e.charCodeAt(r),(n&64512)==56320&&r++);return t}function ge(e,t,a="2019-09",r=xr(t),n=!0,i=null,s="#",o="#",l=Object.create(null)){if(t===!0)return{valid:!0,errors:[]};if(t===!1)return{valid:!1,errors:[{instanceLocation:s,keyword:"false",keywordLocation:s,error:"False boolean schema."}]};let u=typeof e,c;switch(u){case"boolean":case"number":case"string":c=u;break;case"object":e===null?c="null":Array.isArray(e)?c="array":c="object";break;default:throw new Error(`Instances of "${u}" type are not supported.`)}let{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:f,const:m,enum:g,required:_,not:y,anyOf:b,allOf:w,oneOf:O,if:I,then:D,else:j,format:K,properties:k,patternProperties:ve,additionalProperties:Zt,unevaluatedProperties:Tt,minProperties:qt,maxProperties:jt,propertyNames:P,dependentRequired:x,dependentSchemas:Z,dependencies:U,prefixItems:q,items:L,additionalItems:V,unevaluatedItems:le,contains:ie,minContains:se,maxContains:he,minItems:Rt,maxItems:Ht,uniqueItems:Dw,minimum:va,maximum:wa,exclusiveMinimum:Hr,exclusiveMaximum:Jr,multipleOf:Si,minLength:Pi,maxLength:$i,pattern:wh,__absolute_ref__:Ti,__absolute_recursive_ref__:Fw}=t,T=[];if(p===!0&&i===null&&(i=t),h==="#"){let G=i===null?r[Fw]:i,z=`${o}/$recursiveRef`,ne=ge(e,i===null?t:i,a,r,n,G,s,z,l);ne.valid||T.push({instanceLocation:s,keyword:"$recursiveRef",keywordLocation:z,error:"A subschema had errors."},...ne.errors)}if(d!==void 0){let G=r[Ti||d];if(G===void 0){let R=`Unresolved $ref "${d}".`;throw Ti&&Ti!==d&&(R+=`  Absolute URI "${Ti}".`),R+=`
Known schemas:
- ${Object.keys(r).join(`
- `)}`,new Error(R)}let z=`${o}/$ref`,ne=ge(e,G,a,r,n,i,s,z,l);if(ne.valid||T.push({instanceLocation:s,keyword:"$ref",keywordLocation:z,error:"A subschema had errors."},...ne.errors),a==="4"||a==="7")return{valid:T.length===0,errors:T}}if(Array.isArray(f)){let G=f.length,z=!1;for(let ne=0;ne<G;ne++)if(c===f[ne]||f[ne]==="integer"&&c==="number"&&e%1===0&&e===e){z=!0;break}z||T.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f.join('", "')}".`})}else f==="integer"?(c!=="number"||e%1||e!==e)&&T.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f}".`}):f!==void 0&&c!==f&&T.push({instanceLocation:s,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${c}" is invalid. Expected "${f}".`});if(m!==void 0&&(c==="object"||c==="array"?La(e,m)||T.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):e!==m&&T.push({instanceLocation:s,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),g!==void 0&&(c==="object"||c==="array"?g.some(G=>La(e,G))||T.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(G=>e===G)||T.push({instanceLocation:s,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),y!==void 0){let G=`${o}/not`;ge(e,y,a,r,n,i,s,G).valid&&T.push({instanceLocation:s,keyword:"not",keywordLocation:G,error:'Instance matched "not" schema.'})}let ji=[];if(b!==void 0){let G=`${o}/anyOf`,z=T.length,ne=!1;for(let R=0;R<b.length;R++){let $=b[R],Y=Object.create(l),X=ge(e,$,a,r,n,p===!0?i:null,s,`${G}/${R}`,Y);T.push(...X.errors),ne=ne||X.valid,X.valid&&ji.push(Y)}ne?T.length=z:T.splice(z,0,{instanceLocation:s,keyword:"anyOf",keywordLocation:G,error:"Instance does not match any subschemas."})}if(w!==void 0){let G=`${o}/allOf`,z=T.length,ne=!0;for(let R=0;R<w.length;R++){let $=w[R],Y=Object.create(l),X=ge(e,$,a,r,n,p===!0?i:null,s,`${G}/${R}`,Y);T.push(...X.errors),ne=ne&&X.valid,X.valid&&ji.push(Y)}ne?T.length=z:T.splice(z,0,{instanceLocation:s,keyword:"allOf",keywordLocation:G,error:"Instance does not match every subschema."})}if(O!==void 0){let G=`${o}/oneOf`,z=T.length,ne=O.filter((R,$)=>{let Y=Object.create(l),X=ge(e,R,a,r,n,p===!0?i:null,s,`${G}/${$}`,Y);return T.push(...X.errors),X.valid&&ji.push(Y),X.valid}).length;ne===1?T.length=z:T.splice(z,0,{instanceLocation:s,keyword:"oneOf",keywordLocation:G,error:`Instance does not match exactly one subschema (${ne} matches).`})}if((c==="object"||c==="array")&&Object.assign(l,...ji),I!==void 0){let G=`${o}/if`;if(ge(e,I,a,r,n,i,s,G,l).valid){if(D!==void 0){let z=ge(e,D,a,r,n,i,s,`${o}/then`,l);z.valid||T.push({instanceLocation:s,keyword:"if",keywordLocation:G,error:'Instance does not match "then" schema.'},...z.errors)}}else if(j!==void 0){let z=ge(e,j,a,r,n,i,s,`${o}/else`,l);z.valid||T.push({instanceLocation:s,keyword:"if",keywordLocation:G,error:'Instance does not match "else" schema.'},...z.errors)}}if(c==="object"){if(_!==void 0)for(let R of _)R in e||T.push({instanceLocation:s,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${R}".`});let G=Object.keys(e);if(qt!==void 0&&G.length<qt&&T.push({instanceLocation:s,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${qt} properties.`}),jt!==void 0&&G.length>jt&&T.push({instanceLocation:s,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${jt} properties.`}),P!==void 0){let R=`${o}/propertyNames`;for(let $ in e){let Y=`${s}/${dt($)}`,X=ge($,P,a,r,n,i,Y,R);X.valid||T.push({instanceLocation:s,keyword:"propertyNames",keywordLocation:R,error:`Property name "${$}" does not match schema.`},...X.errors)}}if(x!==void 0){let R=`${o}/dependantRequired`;for(let $ in x)if($ in e){let Y=x[$];for(let X of Y)X in e||T.push({instanceLocation:s,keyword:"dependentRequired",keywordLocation:R,error:`Instance has "${$}" but does not have "${X}".`})}}if(Z!==void 0)for(let R in Z){let $=`${o}/dependentSchemas`;if(R in e){let Y=ge(e,Z[R],a,r,n,i,s,`${$}/${dt(R)}`,l);Y.valid||T.push({instanceLocation:s,keyword:"dependentSchemas",keywordLocation:$,error:`Instance has "${R}" but does not match dependant schema.`},...Y.errors)}}if(U!==void 0){let R=`${o}/dependencies`;for(let $ in U)if($ in e){let Y=U[$];if(Array.isArray(Y))for(let X of Y)X in e||T.push({instanceLocation:s,keyword:"dependencies",keywordLocation:R,error:`Instance has "${$}" but does not have "${X}".`});else{let X=ge(e,Y,a,r,n,i,s,`${R}/${dt($)}`);X.valid||T.push({instanceLocation:s,keyword:"dependencies",keywordLocation:R,error:`Instance has "${$}" but does not match dependant schema.`},...X.errors)}}}let z=Object.create(null),ne=!1;if(k!==void 0){let R=`${o}/properties`;for(let $ in k){if(!($ in e))continue;let Y=`${s}/${dt($)}`,X=ge(e[$],k[$],a,r,n,i,Y,`${R}/${dt($)}`);if(X.valid)l[$]=z[$]=!0;else if(ne=n,T.push({instanceLocation:s,keyword:"properties",keywordLocation:R,error:`Property "${$}" does not match schema.`},...X.errors),ne)break}}if(!ne&&ve!==void 0){let R=`${o}/patternProperties`;for(let $ in ve){let Y=new RegExp($,"u"),X=ve[$];for(let We in e){if(!Y.test(We))continue;let Bw=`${s}/${dt(We)}`,Oh=ge(e[We],X,a,r,n,i,Bw,`${R}/${dt($)}`);Oh.valid?l[We]=z[We]=!0:(ne=n,T.push({instanceLocation:s,keyword:"patternProperties",keywordLocation:R,error:`Property "${We}" matches pattern "${$}" but does not match associated schema.`},...Oh.errors))}}}if(!ne&&Zt!==void 0){let R=`${o}/additionalProperties`;for(let $ in e){if(z[$])continue;let Y=`${s}/${dt($)}`,X=ge(e[$],Zt,a,r,n,i,Y,R);X.valid?l[$]=!0:(ne=n,T.push({instanceLocation:s,keyword:"additionalProperties",keywordLocation:R,error:`Property "${$}" does not match additional properties schema.`},...X.errors))}}else if(!ne&&Tt!==void 0){let R=`${o}/unevaluatedProperties`;for(let $ in e)if(!l[$]){let Y=`${s}/${dt($)}`,X=ge(e[$],Tt,a,r,n,i,Y,R);X.valid?l[$]=!0:T.push({instanceLocation:s,keyword:"unevaluatedProperties",keywordLocation:R,error:`Property "${$}" does not match unevaluated properties schema.`},...X.errors)}}}else if(c==="array"){Ht!==void 0&&e.length>Ht&&T.push({instanceLocation:s,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${Ht}).`}),Rt!==void 0&&e.length<Rt&&T.push({instanceLocation:s,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${Rt}).`});let G=e.length,z=0,ne=!1;if(q!==void 0){let R=`${o}/prefixItems`,$=Math.min(q.length,G);for(;z<$;z++){let Y=ge(e[z],q[z],a,r,n,i,`${s}/${z}`,`${R}/${z}`);if(l[z]=!0,!Y.valid&&(ne=n,T.push({instanceLocation:s,keyword:"prefixItems",keywordLocation:R,error:"Items did not match schema."},...Y.errors),ne))break}}if(L!==void 0){let R=`${o}/items`;if(Array.isArray(L)){let $=Math.min(L.length,G);for(;z<$;z++){let Y=ge(e[z],L[z],a,r,n,i,`${s}/${z}`,`${R}/${z}`);if(l[z]=!0,!Y.valid&&(ne=n,T.push({instanceLocation:s,keyword:"items",keywordLocation:R,error:"Items did not match schema."},...Y.errors),ne))break}}else for(;z<G;z++){let $=ge(e[z],L,a,r,n,i,`${s}/${z}`,R);if(l[z]=!0,!$.valid&&(ne=n,T.push({instanceLocation:s,keyword:"items",keywordLocation:R,error:"Items did not match schema."},...$.errors),ne))break}if(!ne&&V!==void 0){let $=`${o}/additionalItems`;for(;z<G;z++){let Y=ge(e[z],V,a,r,n,i,`${s}/${z}`,$);l[z]=!0,Y.valid||(ne=n,T.push({instanceLocation:s,keyword:"additionalItems",keywordLocation:$,error:"Items did not match additional items schema."},...Y.errors))}}}if(ie!==void 0)if(G===0&&se===void 0)T.push({instanceLocation:s,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(se!==void 0&&G<se)T.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${G}) than minContains (${se}).`});else{let R=`${o}/contains`,$=T.length,Y=0;for(let X=0;X<G;X++){let We=ge(e[X],ie,a,r,n,i,`${s}/${X}`,R);We.valid?(l[X]=!0,Y++):T.push(...We.errors)}Y>=(se||0)&&(T.length=$),se===void 0&&he===void 0&&Y===0?T.splice($,0,{instanceLocation:s,keyword:"contains",keywordLocation:R,error:"Array does not contain item matching schema."}):se!==void 0&&Y<se?T.push({instanceLocation:s,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${se} items matching schema. Only ${Y} items were found.`}):he!==void 0&&Y>he&&T.push({instanceLocation:s,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${he} items matching schema. ${Y} items were found.`})}if(!ne&&le!==void 0){let R=`${o}/unevaluatedItems`;for(z;z<G;z++){if(l[z])continue;let $=ge(e[z],le,a,r,n,i,`${s}/${z}`,R);l[z]=!0,$.valid||T.push({instanceLocation:s,keyword:"unevaluatedItems",keywordLocation:R,error:"Items did not match unevaluated items schema."},...$.errors)}}if(Dw)for(let R=0;R<G;R++){let $=e[R],Y=typeof $=="object"&&$!==null;for(let X=0;X<G;X++){if(R===X)continue;let We=e[X];($===We||Y&&typeof We=="object"&&We!==null&&La($,We))&&(T.push({instanceLocation:s,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${R} and ${X}.`}),R=Number.MAX_SAFE_INTEGER,X=Number.MAX_SAFE_INTEGER)}}}else if(c==="number"){if(a==="4"?(va!==void 0&&(Hr===!0&&e<=va||e<va)&&T.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${Hr?"or equal to ":""} ${va}.`}),wa!==void 0&&(Jr===!0&&e>=wa||e>wa)&&T.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${Jr?"or equal to ":""} ${wa}.`})):(va!==void 0&&e<va&&T.push({instanceLocation:s,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${va}.`}),wa!==void 0&&e>wa&&T.push({instanceLocation:s,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${wa}.`}),Hr!==void 0&&e<=Hr&&T.push({instanceLocation:s,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${Hr}.`}),Jr!==void 0&&e>=Jr&&T.push({instanceLocation:s,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${Jr}.`})),Si!==void 0){let G=e%Si;Math.abs(0-G)>=11920929e-14&&Math.abs(Si-G)>=11920929e-14&&T.push({instanceLocation:s,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${Si}.`})}}else if(c==="string"){let G=Pi===void 0&&$i===void 0?0:x_(e);Pi!==void 0&&G<Pi&&T.push({instanceLocation:s,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${G} < ${Pi}).`}),$i!==void 0&&G>$i&&T.push({instanceLocation:s,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${G} > ${$i}).`}),wh!==void 0&&!new RegExp(wh,"u").test(e)&&T.push({instanceLocation:s,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),K!==void 0&&ic[K]&&!ic[K](e)&&T.push({instanceLocation:s,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${K}".`})}return{valid:T.length===0,errors:T}}function At(e){if(typeof e!="object"||e===null)return!1;let t=e;if(!("_zod"in t))return!1;let a=t._zod;return typeof a=="object"&&a!==null&&"def"in a}function Dt(e){if(typeof e!="object"||e===null)return!1;let t=e;if(!("_def"in t)||"_zod"in t)return!1;let a=t._def;return typeof a=="object"&&a!=null&&"typeName"in a}function zn(e){return!e||typeof e!="object"||Array.isArray(e)?!1:!!(At(e)||Dt(e))}async function A_(e,t){if(At(e))try{return{success:!0,data:await n0(e,t)}}catch(a){return{success:!1,error:a}}if(Dt(e))return e.safeParse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function zs(e,t){if(At(e))return a0(e,t);if(Dt(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function uc(e){if(At(e))return ea.get(e)?.description;if(Dt(e)||"description"in e&&typeof e.description=="string")return e.description}function I_(e){return zn(e)?Dt(e)?e._def.typeName==="ZodString":At(e)?e._zod.def.type==="string":!1:!1}function Ar(e){return At(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="object":!1}function cc(e){return At(e)?typeof e=="object"&&e!==null&&"_zod"in e&&typeof e._zod=="object"&&e._zod!==null&&"def"in e._zod&&typeof e._zod.def=="object"&&e._zod.def!==null&&"type"in e._zod.def&&e._zod.def.type==="array":!1}function Ds(e,t=!1){if(Dt(e))return e.strict();if(Ar(e)){let a=e._zod.def.shape;if(t)for(let[i,s]of Object.entries(e._zod.def.shape)){if(Ar(s)){let l=Ds(s,t);a[i]=l}else if(cc(s)){let l=s._zod.def.element;Ar(l)&&(l=Ds(l,t)),a[i]=Nn(s,{...s._zod.def,element:l})}else a[i]=s;let o=ea.get(s);o&&ea.add(a[i],o)}let r=Nn(e,{...e._zod.def,shape:a,catchall:p0(d0)}),n=ea.get(e);return n&&ea.add(r,n),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function S_(e){return Dt(e)&&"typeName"in e._def&&e._def.typeName==="ZodEffects"}function P_(e){return At(e)&&e._zod.def.type==="pipe"}function Ir(e,t=!1){if(Dt(e))return S_(e)?Ir(e._def.schema,t):e;if(At(e)){let a=e;if(P_(e)&&(a=Ir(e._zod.def.in,t)),t){if(Ar(a)){let n=a._zod.def.shape;for(let[i,s]of Object.entries(a._zod.def.shape))n[i]=Ir(s,t);a=Nn(a,{...a._zod.def,shape:n})}else if(cc(a)){let n=Ir(a._zod.def.element,t);a=Nn(a,{...a._zod.def,element:n})}}let r=ea.get(e);return r&&ea.add(a,r),a}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Dn(e){if(At(e)){let t=Ir(e,!0);if(Ar(t)){let a=Ds(t,!0);return Wu(a)}else return Wu(e)}return Dt(e)?nc(e):e}function $_(e,t){if(e!==void 0&&!_r(e))return e;if(Ns(t))try{let a=t.getName();return a=a.startsWith("Runnable")?a.slice(8):a,a}catch{return t.getName()}else return t.name??"UnknownSchema"}function T_(e){return Ns(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Dn(e.data.schema),title:e.data.name}}}var dc=class Bh{constructor(t){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=t?.nodes??this.nodes,this.edges=t?.edges??this.edges}toJSON(){let t={};return Object.values(this.nodes).forEach((a,r)=>{t[a.id]=_r(a.id)?r:a.id}),{nodes:Object.values(this.nodes).map(a=>({id:t[a.id],...T_(a)})),edges:this.edges.map(a=>{let r={source:t[a.source],target:t[a.target]};return typeof a.data<"u"&&(r.data=a.data),typeof a.conditional<"u"&&(r.conditional=a.conditional),r})}}addNode(t,a,r){if(a!==void 0&&this.nodes[a]!==void 0)throw new Error(`Node with id ${a} already exists`);let n=a??ze(),i={id:n,data:t,name:$_(a,t),metadata:r};return this.nodes[n]=i,i}removeNode(t){delete this.nodes[t.id],this.edges=this.edges.filter(a=>a.source!==t.id&&a.target!==t.id)}addEdge(t,a,r,n){if(this.nodes[t.id]===void 0)throw new Error(`Source node ${t.id} not in graph`);if(this.nodes[a.id]===void 0)throw new Error(`Target node ${a.id} not in graph`);let i={source:t.id,target:a.id,data:r,conditional:n};return this.edges.push(i),i}firstNode(){return hc(this)}lastNode(){return pc(this)}extend(t,a=""){let r=a;Object.values(t.nodes).map(l=>l.id).every(_r)&&(r="");let n=l=>r?`${r}:${l}`:l;Object.entries(t.nodes).forEach(([l,u])=>{this.nodes[n(l)]={...u,id:n(l)}});let i=t.edges.map(l=>({...l,source:n(l.source),target:n(l.target)}));this.edges=[...this.edges,...i];let s=t.firstNode(),o=t.lastNode();return[s?{id:n(s.id),data:s.data}:void 0,o?{id:n(o.id),data:o.data}:void 0]}trimFirstNode(){let t=this.firstNode();t&&hc(this,[t.id])&&this.removeNode(t)}trimLastNode(){let t=this.lastNode();t&&pc(this,[t.id])&&this.removeNode(t)}reid(){let t=Object.fromEntries(Object.values(this.nodes).map(n=>[n.id,n.name])),a=new Map;Object.values(t).forEach(n=>{a.set(n,(a.get(n)||0)+1)});let r=n=>{let i=t[n];return _r(n)&&a.get(i)===1?i:n};return new Bh({nodes:Object.fromEntries(Object.entries(this.nodes).map(([n,i])=>[r(n),{...i,id:r(n)}])),edges:this.edges.map(n=>({...n,source:r(n.source),target:r(n.target)}))})}drawMermaid(t){let{withStyles:a,curveStyle:r,nodeColors:n={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=t??{},s=this.reid(),o=s.firstNode(),l=s.lastNode();return Gy(s.nodes,s.edges,{firstNode:o?.id,lastNode:l?.id,withStyles:a,curveStyle:r,nodeColors:n,wrapLabelNWords:i})}async drawMermaidPng(t){let a=this.drawMermaid(t);return Wy(a,{backgroundColor:t?.backgroundColor})}};function hc(e,t=[]){let a=new Set(e.edges.filter(n=>!t.includes(n.source)).map(n=>n.target)),r=[];for(let n of Object.values(e.nodes))!t.includes(n.id)&&!a.has(n.id)&&r.push(n);return r.length===1?r[0]:void 0}function pc(e,t=[]){let a=new Set(e.edges.filter(n=>!t.includes(n.target)).map(n=>n.source)),r=[];for(let n of Object.values(e.nodes))!t.includes(n.id)&&!a.has(n.id)&&r.push(n);return r.length===1?r[0]:void 0}function j_(e){let t=new TextEncoder,a=new ReadableStream({async start(r){for await(let n of e)r.enqueue(t.encode(`event: data
data: ${JSON.stringify(n)}

`));r.enqueue(t.encode(`event: end

`)),r.close()}});return kt.fromReadableStream(a)}function fc(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.iterator]=="function"&&typeof e.next=="function"}var R_=e=>e!=null&&typeof e=="object"&&"next"in e&&typeof e.next=="function";function Fs(e){return typeof e=="object"&&e!==null&&typeof e[Symbol.asyncIterator]=="function"}function*mc(e,t){for(;;){let{value:a,done:r}=Xt.runWithConfig(Na(e),t.next.bind(t),!0);if(r)break;yield a}}async function*Bs(e,t){let a=t[Symbol.asyncIterator]();for(;;){let{value:r,done:n}=await Xt.runWithConfig(Na(e),a.next.bind(t),!0);if(n)break;yield r}}function Ae(e,t){return e&&!Array.isArray(e)&&!(e instanceof Date)&&typeof e=="object"?e:{[t]:e}}var Ie=class extends Va{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Sr({bound:this,kwargs:e,config:{}})}map(){return new N_({bound:this})}withRetry(e){return new gc({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Sr({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new M_({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ce);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let a=Object.fromEntries(Object.entries(e).filter(([r])=>r!=="runId"));return Array.from({length:t},(r,n)=>ce(n===0?e:a))}return Array.from({length:t},()=>ce(e))}async batch(e,t,a){let r=this._getOptionsList(t??{},e.length),n=r[0]?.maxConcurrency??a?.maxConcurrency,i=new Rs({maxConcurrency:n,onFailedAttempt:o=>{throw o}}),s=e.map((o,l)=>i.call(async()=>{try{return await this.invoke(o,r[l])}catch(u){if(a?.returnExceptions)return u;throw u}}));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let a=ce(t),r=new Ca({generator:this._streamIterator(e,a),config:a});return await r.setup,kt.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=ce(e):t=ce({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let a={...e};return delete a.callbacks,delete a.tags,delete a.metadata,delete a.runName,delete a.configurable,delete a.recursionLimit,delete a.maxConcurrency,delete a.runId,delete a.timeout,delete a.signal,[t,a]}async _callWithConfig(e,t,a){let r=ce(a),n=await(await lt(r))?.handleChainStart(this.toJSON(),Ae(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName());delete r.runId;let i;try{let s=e.call(this,t,r,n);i=await Yt(s,a?.signal)}catch(s){throw await n?.handleChainError(s),s}return await n?.handleChainEnd(Ae(i,"output")),i}async _batchWithConfig(e,t,a,r){let n=this._getOptionsList(a??{},t.length),i=await Promise.all(n.map(lt)),s=await Promise.all(i.map(async(l,u)=>{let c=await l?.handleChainStart(this.toJSON(),Ae(t[u],"input"),n[u].runId,n[u].runType,void 0,void 0,n[u].runName??this.getName());return delete n[u].runId,c})),o;try{let l=e.call(this,t,n,s,r);o=await Yt(l,n?.[0]?.signal)}catch(l){throw await Promise.all(s.map(u=>u?.handleChainError(l))),l}return await Promise.all(s.map(l=>l?.handleChainEnd(Ae(o,"output")))),o}_concatOutputChunks(e,t){return In(e,t)}async*_transformStreamWithConfig(e,t,a){let r,n=!0,i,s=!0,o=ce(a),l=await lt(o),u=this;async function*c(){for await(let h of e){if(n)if(r===void 0)r=h;else try{r=u._concatOutputChunks(r,h)}catch{r=void 0,n=!1}yield h}}let d;try{let h=await Ly(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),a?.signal,o);delete o.runId,d=h.setup;let p=d?.handlers.find(zy),f=h.output;p!==void 0&&d!==void 0&&(f=p.tapOutputIterable(d.runId,f));let m=d?.handlers.find(My);m!==void 0&&d!==void 0&&(f=m.tapOutputIterable(d.runId,f));for await(let g of f)if(yield g,s)if(i===void 0)i=g;else try{i=this._concatOutputChunks(i,g)}catch{i=void 0,s=!1}}catch(h){throw await d?.handleChainError(h,void 0,void 0,void 0,{inputs:Ae(r,"input")}),h}await d?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:Ae(r,"input")})}getGraph(e){let t=new dc,a=t.addNode({name:`${this.getName()}Input`,schema:Lt.any()}),r=t.addNode(this),n=t.addNode({name:`${this.getName()}Output`,schema:Lt.any()});return t.addEdge(a,r),t.addEdge(r,n),t}pipe(e){return new Fn({first:this,last:fa(e)})}pick(e){return this.pipe(new U_(e))}assign(e){return this.pipe(new yc(new Bn({steps:e})))}async*transform(e,t){let a;for await(let r of e)a===void 0?a=r:a=this._concatOutputChunks(a,r);yield*this._streamIterator(a,ce(t))}async*streamLog(e,t,a){let r=new Du({...a,autoClose:!1,_schemaFormat:"original"}),n=ce(t);yield*this._streamLog(e,r,n)}async*_streamLog(e,t,a){let{callbacks:r}=a;if(r===void 0)a.callbacks=[t];else if(Array.isArray(r))a.callbacks=r.concat([t]);else{let o=r.copy();o.addHandler(t,!0),a.callbacks=o}let n=this.stream(e,a);async function i(){try{let o=await n;for await(let l of o){let u=new Qt({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(u)}}finally{await t.writer.close()}}let s=i();try{for await(let o of t)yield o}finally{await s}}streamEvents(e,t,a){let r;if(t.version==="v1")r=this._streamEventsV1(e,t,a);else if(t.version==="v2")r=this._streamEventsV2(e,t,a);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?j_(r):kt.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,a){let r=new Dy({...a,autoClose:!1}),n=ce(t),i=n.runId??ze();n.runId=i;let s=n.callbacks;if(s===void 0)n.callbacks=[r];else if(Array.isArray(s))n.callbacks=s.concat(r);else{let p=s.copy();p.addHandler(r,!0),n.callbacks=p}let o=new AbortController,l=this;async function u(){let p,f=null;try{t?.signal?"any"in AbortSignal?p=AbortSignal.any([o.signal,t.signal]):(p=t.signal,f=()=>{o.abort()},t.signal.addEventListener("abort",f,{once:!0})):p=o.signal;let m=await l.stream(e,{...n,signal:p}),g=r.tapOutputIterable(i,m);for await(let _ of g)if(o.signal.aborted)break}finally{await r.finish(),p&&f&&p.removeEventListener("abort",f)}}let c=u(),d=!1,h;try{for await(let p of r){if(!d){p.data.input=e,d=!0,h=p.run_id,yield p;continue}p.run_id===h&&p.event.endsWith("_end")&&p.data?.input&&delete p.data.input,yield p}}finally{o.abort(),await c}}async*_streamEventsV1(e,t,a){let r,n=!1,i=ce(t),s=i.tags??[],o=i.metadata??{},l=i.runName??this.getName(),u=new Du({...a,autoClose:!1,_schemaFormat:"streaming_events"}),c=new qy({...a}),d=this._streamLog(e,u,i);for await(let p of d){if(r?r=r.concat(p):r=Mu.fromRunLogPatch(p),r.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!n){n=!0;let _={...r.state},y={run_id:_.id,event:`on_${_.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};c.includeEvent(y,_.type)&&(yield y)}let f=p.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),m=[...new Set(f)];for(let _ of m){let y,b={},w=r.state.logs[_];if(w.end_time===void 0?w.streamed_output.length>0?y="stream":y="start":y="end",y==="start")w.inputs!==void 0&&(b.input=w.inputs);else if(y==="end")w.inputs!==void 0&&(b.input=w.inputs),b.output=w.final_output;else if(y==="stream"){let O=w.streamed_output.length;if(O!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${O} instead. Encountered in: "${w.name}"`);b={chunk:w.streamed_output[0]},w.streamed_output=[]}yield{event:`on_${w.type}_${y}`,name:w.name,run_id:w.id,tags:w.tags,metadata:w.metadata,data:b}}let{state:g}=r;if(g.streamed_output.length>0){let _=g.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${g.name}"`);let y={chunk:g.streamed_output[0]};g.streamed_output=[];let b={event:`on_${g.type}_stream`,run_id:g.id,tags:s,metadata:o,name:l,data:y};c.includeEvent(b,g.type)&&(yield b)}}let h=r?.state;if(h!==void 0){let p={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};c.includeEvent(p,h.type)&&(yield p)}}static isRunnable(e){return Ns(e)}withListeners({onStart:e,onEnd:t,onError:a}){return new Sr({bound:this,config:{},configFactories:[r=>({callbacks:[new Bu({config:r,onStart:e,onEnd:t,onError:a})]})]})}asTool(e){return z_(this,e)}},Sr=class Zh extends Ie{static lc_name(){return"RunnableBinding"}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=t.bound,this.kwargs=t.kwargs,this.config=t.config,this.configFactories=t.configFactories}getName(t){return this.bound.getName(t)}async _mergeConfig(...t){let a=Ts(this.config,...t);return Ts(a,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(a))):[])}bind(t){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...t},config:this.config})}withConfig(t){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...t}})}withRetry(t){return new gc({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:t?.stopAfterAttempt,...t})}async invoke(t,a){return this.bound.invoke(t,await this._mergeConfig(ce(a),this.kwargs))}async batch(t,a,r){let n=Array.isArray(a)?await Promise.all(a.map(async i=>this._mergeConfig(ce(i),this.kwargs))):await this._mergeConfig(ce(a),this.kwargs);return this.bound.batch(t,n,r)}_concatOutputChunks(t,a){return this.bound._concatOutputChunks(t,a)}async*_streamIterator(t,a){yield*this.bound._streamIterator(t,await this._mergeConfig(ce(a),this.kwargs))}async stream(t,a){return this.bound.stream(t,await this._mergeConfig(ce(a),this.kwargs))}async*transform(t,a){yield*this.bound.transform(t,await this._mergeConfig(ce(a),this.kwargs))}streamEvents(t,a,r){let n=this,i=async function*(){yield*n.bound.streamEvents(t,{...await n._mergeConfig(ce(a),n.kwargs),version:a.version},r)};return kt.fromAsyncGenerator(i())}static isRunnableBinding(t){return t.bound&&Ie.isRunnable(t.bound)}withListeners({onStart:t,onEnd:a,onError:r}){return new Zh({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new Bu({config:n,onStart:t,onEnd:a,onError:r})]})]})}},N_=class ul extends Ie{static lc_name(){return"RunnableEach"}constructor(t){super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=t.bound}bind(t){return new ul({bound:this.bound.bind(t)})}async invoke(t,a){return this._callWithConfig(this._invoke.bind(this),t,a)}async _invoke(t,a,r){return this.bound.batch(t,Ne(a,{callbacks:r?.getChild()}))}withListeners({onStart:t,onEnd:a,onError:r}){return new ul({bound:this.bound.withListeners({onStart:t,onEnd:a,onError:r})})}},gc=class extends Sr{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,a){let r=e>1?`retry:attempt:${e}`:void 0;return Ne(t,{callbacks:a?.getChild(r)})}async _invoke(e,t,a){return(0,Bl.default)(r=>super.invoke(e,this._patchConfigForRetry(r,t,a)),{onFailedAttempt:r=>this.onFailedAttempt(r,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,a,r){let n={};try{await(0,Bl.default)(async i=>{let s=e.map((d,h)=>h).filter(d=>n[d.toString()]===void 0||n[d.toString()]instanceof Error),o=s.map(d=>e[d]),l=s.map(d=>this._patchConfigForRetry(i,t?.[d],a?.[d])),u=await super.batch(o,l,{...r,returnExceptions:!0}),c;for(let d=0;d<u.length;d+=1){let h=u[d],p=s[d];h instanceof Error&&c===void 0&&(c=h,c.input=o[d]),n[p.toString()]=h}if(c)throw c;return u},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if(r?.returnExceptions!==!0)throw i}return Object.keys(n).sort((i,s)=>parseInt(i,10)-parseInt(s,10)).map(i=>n[parseInt(i,10)])}async batch(e,t,a){return this._batchWithConfig(this._batch.bind(this),e,t,a)}},Fn=class Kr extends Ie{static lc_name(){return"RunnableSequence"}constructor(t){super(t),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=t.first,this.middle=t.middle??this.middle,this.last=t.last,this.name=t.name,this.omitSequenceTags=t.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(t,a){let r=ce(a),n=await(await lt(r))?.handleChainStart(this.toJSON(),Ae(t,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i=t,s;try{let o=[this.first,...this.middle];for(let l=0;l<o.length;l+=1){let u=o[l].invoke(i,Ne(r,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await Yt(u,a?.signal)}if(a?.signal?.aborted)throw new Error("Aborted");s=await this.last.invoke(i,Ne(r,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(o){throw await n?.handleChainError(o),o}return await n?.handleChainEnd(Ae(s,"output")),s}async batch(t,a,r){let n=this._getOptionsList(a??{},t.length),i=await Promise.all(n.map(lt)),s=await Promise.all(i.map(async(l,u)=>{let c=await l?.handleChainStart(this.toJSON(),Ae(t[u],"input"),n[u].runId,void 0,void 0,void 0,n[u].runName);return delete n[u].runId,c})),o=t;try{for(let l=0;l<this.steps.length;l+=1){let u=this.steps[l].batch(o,s.map((c,d)=>{let h=c?.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`);return Ne(n[d],{callbacks:h})}),r);o=await Yt(u,n[0]?.signal)}}catch(l){throw await Promise.all(s.map(u=>u?.handleChainError(l))),l}return await Promise.all(s.map(l=>l?.handleChainEnd(Ae(o,"output")))),o}_concatOutputChunks(t,a){return this.last._concatOutputChunks(t,a)}async*_streamIterator(t,a){let r=await lt(a),{runId:n,...i}=a??{},s=await r?.handleChainStart(this.toJSON(),Ae(t,"input"),n,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last],l=!0,u;async function*c(){yield t}try{let d=o[0].transform(c(),Ne(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let h=1;h<o.length;h+=1)d=await o[h].transform(d,Ne(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${h+1}`)}));for await(let h of d)if(a?.signal?.throwIfAborted(),yield h,l)if(u===void 0)u=h;else try{u=this._concatOutputChunks(u,h)}catch{u=void 0,l=!1}}catch(d){throw await s?.handleChainError(d),d}await s?.handleChainEnd(Ae(u,"output"))}getGraph(t){let a=new dc,r=null;return this.steps.forEach((n,i)=>{let s=n.getGraph(t);i!==0&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),a.extend(s);let o=s.firstNode();if(!o)throw new Error(`Runnable ${n} has no first node`);r&&a.addEdge(r,o),r=s.lastNode()}),a}pipe(t){return Kr.isRunnableSequence(t)?new Kr({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new Kr({first:this.first,middle:[...this.middle,this.last],last:fa(t),name:this.name})}static isRunnableSequence(t){return Array.isArray(t.middle)&&Ie.isRunnable(t)}static from([t,...a],r){let n={};return typeof r=="string"?n.name=r:r!==void 0&&(n=r),new Kr({...n,first:fa(t),middle:a.slice(0,-1).map(fa),last:fa(a[a.length-1])})}},Bn=class qh extends Ie{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[a,r]of Object.entries(t.steps))this.steps[a]=fa(r)}static from(t){return new qh({steps:t})}async invoke(t,a){let r=ce(a),n=await(await lt(r))?.handleChainStart(this.toJSON(),{input:t},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let i={};try{let s=Object.entries(this.steps).map(async([o,l])=>{i[o]=await l.invoke(t,Ne(r,{callbacks:n?.getChild(`map:key:${o}`)}))});await Yt(Promise.all(s),a?.signal)}catch(s){throw await n?.handleChainError(s),s}return await n?.handleChainEnd(i),i}async*_transform(t,a,r){let n={...this.steps},i=Lu(t,Object.keys(n).length),s=new Map(Object.entries(n).map(([o,l],u)=>{let c=l.transform(i[u],Ne(r,{callbacks:a?.getChild(`map:key:${o}`)}));return[o,c.next().then(d=>({key:o,gen:c,result:d}))]}));for(;s.size;){let o=Promise.race(s.values()),{key:l,result:u,gen:c}=await Yt(o,r?.signal);s.delete(l),u.done||(yield{[l]:u.value},s.set(l,c.next().then(d=>({key:l,gen:c,result:d}))))}}transform(t,a){return this._transformStreamWithConfig(t,this._transform.bind(this),a)}async stream(t,a){async function*r(){yield t}let n=ce(a),i=new Ca({generator:this.transform(r(),n),config:n});return await i.setup,kt.fromAsyncGenerator(i)}},C_=class Hh extends Ie{constructor(t){if(super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!os(t.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=t.func}async invoke(t,a){let[r]=this._getOptionsList(a??{},1),n=await lt(r),i=this.func(Ne(r,{callbacks:n}),t);return Yt(i,r?.signal)}async*_streamIterator(t,a){let[r]=this._getOptionsList(a??{},1),n=await this.invoke(t,a);if(Fs(n)){for await(let i of n)r?.signal?.throwIfAborted(),yield i;return}if(R_(n)){for(;;){r?.signal?.throwIfAborted();let i=n.next();if(i.done)break;yield i.value}return}yield n}static from(t){return new Hh({func:t})}};function L_(e){if(os(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Zs=class Jh extends Ie{static lc_name(){return"RunnableLambda"}constructor(t){if(os(t.func))return C_.from(t.func);super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),L_(t.func),this.func=t.func}static from(t){return new Jh({func:t})}async _invoke(t,a,r){return new Promise((n,i)=>{let s=Ne(a,{callbacks:r?.getChild(),recursionLimit:(a?.recursionLimit??$s)-1});Xt.runWithConfig(Na(s),async()=>{try{let o=await this.func(t,{...s});if(o&&Ie.isRunnable(o)){if(a?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(t,{...s,recursionLimit:(s.recursionLimit??$s)-1})}else if(Fs(o)){let l;for await(let u of Bs(s,o))if(a?.signal?.throwIfAborted(),l===void 0)l=u;else try{l=this._concatOutputChunks(l,u)}catch{l=u}o=l}else if(fc(o)){let l;for(let u of mc(s,o))if(a?.signal?.throwIfAborted(),l===void 0)l=u;else try{l=this._concatOutputChunks(l,u)}catch{l=u}o=l}n(o)}catch(o){i(o)}})})}async invoke(t,a){return this._callWithConfig(this._invoke.bind(this),t,a)}async*_transform(t,a,r){let n;for await(let o of t)if(n===void 0)n=o;else try{n=this._concatOutputChunks(n,o)}catch{n=o}let i=Ne(r,{callbacks:a?.getChild(),recursionLimit:(r?.recursionLimit??$s)-1}),s=await new Promise((o,l)=>{Xt.runWithConfig(Na(i),async()=>{try{let u=await this.func(n,{...i,config:i});o(u)}catch(u){l(u)}})});if(s&&Ie.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await s.stream(n,i);for await(let l of o)yield l}else if(Fs(s))for await(let o of Bs(i,s))r?.signal?.throwIfAborted(),yield o;else if(fc(s))for(let o of mc(i,s))r?.signal?.throwIfAborted(),yield o;else yield s}transform(t,a){return this._transformStreamWithConfig(t,this._transform.bind(this),a)}async stream(t,a){async function*r(){yield t}let n=ce(a),i=new Ca({generator:this.transform(r(),n),config:n});return await i.setup,kt.fromAsyncGenerator(i)}},M_=class extends Ie{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let a=ce(t),r=await lt(a),{runId:n,...i}=a,s=await r?.handleChainStart(this.toJSON(),Ae(e,"input"),n,void 0,void 0,void 0,i?.runName),o=Ne(i,{callbacks:s?.getChild()});return await Xt.runWithConfig(o,async()=>{let l;for(let u of this.runnables()){a?.signal?.throwIfAborted();try{let c=await u.invoke(e,o);return await s?.handleChainEnd(Ae(c,"output")),c}catch(c){l===void 0&&(l=c)}}throw l===void 0?new Error("No error stored at end of fallback."):(await s?.handleChainError(l),l)})}async*_streamIterator(e,t){let a=ce(t),r=await lt(a),{runId:n,...i}=a,s=await r?.handleChainStart(this.toJSON(),Ae(e,"input"),n,void 0,void 0,void 0,i?.runName),o,l;for(let c of this.runnables()){a?.signal?.throwIfAborted();let d=Ne(i,{callbacks:s?.getChild()});try{let h=await c.stream(e,d);l=Bs(d,h);break}catch(h){o===void 0&&(o=h)}}if(l===void 0){let c=o??new Error("No error stored at end of fallback.");throw await s?.handleChainError(c),c}let u;try{for await(let c of l){yield c;try{u=u===void 0?u:this._concatOutputChunks(u,c)}catch{u=void 0}}}catch(c){throw await s?.handleChainError(c),c}await s?.handleChainEnd(Ae(u,"output"))}async batch(e,t,a){if(a?.returnExceptions)throw new Error("Not implemented.");let r=this._getOptionsList(t??{},e.length),n=await Promise.all(r.map(o=>lt(o))),i=await Promise.all(n.map(async(o,l)=>{let u=await o?.handleChainStart(this.toJSON(),Ae(e[l],"input"),r[l].runId,void 0,void 0,void 0,r[l].runName);return delete r[l].runId,u})),s;for(let o of this.runnables()){r[0].signal?.throwIfAborted();try{let l=await o.batch(e,i.map((u,c)=>Ne(r[c],{callbacks:u?.getChild()})),a);return await Promise.all(i.map((u,c)=>u?.handleChainEnd(Ae(l[c],"output")))),l}catch(l){s===void 0&&(s=l)}}throw s?(await Promise.all(i.map(o=>o?.handleChainError(s))),s):new Error("No error stored at end of fallbacks.")}};function fa(e){if(typeof e=="function")return new Zs({func:e});if(Ie.isRunnable(e))return e;if(!Array.isArray(e)&&typeof e=="object"){let t={};for(let[a,r]of Object.entries(e))t[a]=fa(r);return new Bn({steps:t})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var yc=class extends Ie{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Bn&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let a=await this.mapper.invoke(e,t);return{...e,...a}}async*_transform(e,t,a){let r=this.mapper.getStepsKeys(),[n,i]=Lu(e),s=this.mapper.transform(i,Ne(a,{callbacks:t?.getChild()})),o=s.next();for await(let l of n){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let u=Object.fromEntries(Object.entries(l).filter(([c])=>!r.includes(c)));Object.keys(u).length>0&&(yield u)}yield(await o).value;for await(let l of s)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*a(){yield e}let r=ce(t),n=new Ca({generator:this.transform(a(),r),config:r});return await n.setup,kt.fromAsyncGenerator(n)}},U_=class extends Ie{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(a=>[a,e[a]]).filter(a=>a[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let a=await this._pick(t);a!==void 0&&(yield a)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*a(){yield e}let r=ce(t),n=new Ca({generator:this.transform(a(),r),config:r});return await n.setup,kt.fromAsyncGenerator(n)}},_c=class extends Sr{constructor(e){let t=Fn.from([Zs.from(async a=>{let r;if(er(a))try{r=await zs(this.schema,a.args)}catch{throw new Vi("Received tool input did not match expected schema",JSON.stringify(a.args))}else r=a;return r}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function z_(e,t){let a=t.name??e.getName(),r=t.description??uc(t.schema);return I_(t.schema)?new _c({name:a,description:r,schema:Lt.object({input:Lt.string()}).transform(n=>n.input),bound:e}):new _c({name:a,description:r,schema:t.schema,bound:e})}var qs="RFC3986",Hs={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},D_="RFC1738",F_=Array.isArray,It=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Js=1024,B_=(e,t,a,r,n)=>{if(e.length===0)return e;let i=e;if(typeof e=="symbol"?i=Symbol.prototype.toString.call(e):typeof e!="string"&&(i=String(e)),a==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let s="";for(let o=0;o<i.length;o+=Js){let l=i.length>=Js?i.slice(o,o+Js):i,u=[];for(let c=0;c<l.length;++c){let d=l.charCodeAt(c);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||n===D_&&(d===40||d===41)){u[u.length]=l.charAt(c);continue}if(d<128){u[u.length]=It[d];continue}if(d<2048){u[u.length]=It[192|d>>6]+It[128|d&63];continue}if(d<55296||d>=57344){u[u.length]=It[224|d>>12]+It[128|d>>6&63]+It[128|d&63];continue}c+=1,d=65536+((d&1023)<<10|l.charCodeAt(c)&1023),u[u.length]=It[240|d>>18]+It[128|d>>12&63]+It[128|d>>6&63]+It[128|d&63]}s+=u.join("")}return s};function Z_(e){return!e||typeof e!="object"?!1:!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))}function bc(e,t){if(F_(e)){let a=[];for(let r=0;r<e.length;r+=1)a.push(t(e[r]));return a}return t(e)}var q_=Object.prototype.hasOwnProperty,vc={brackets(e){return String(e)+"[]"},comma:"comma",indices(e,t){return String(e)+"["+t+"]"},repeat(e){return String(e)}},St=Array.isArray,H_=Array.prototype.push,wc=function(e,t){H_.apply(e,St(t)?t:[t])},J_=Date.prototype.toISOString,Ee={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:B_,encodeValuesOnly:!1,format:qs,formatter:Hs[qs],indices:!1,serializeDate(e){return J_.call(e)},skipNulls:!1,strictNullHandling:!1};function G_(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||typeof e=="symbol"||typeof e=="bigint"}var Gs={};function Oc(e,t,a,r,n,i,s,o,l,u,c,d,h,p,f,m,g,_){let y=e,b=_,w=0,O=!1;for(;(b=b.get(Gs))!==void 0&&!O;){let k=b.get(e);if(w+=1,typeof k<"u"){if(k===w)throw new RangeError("Cyclic object value");O=!0}typeof b.get(Gs)>"u"&&(w=0)}if(typeof u=="function"?y=u(t,y):y instanceof Date?y=h?.(y):a==="comma"&&St(y)&&(y=bc(y,function(k){return k instanceof Date?h?.(k):k})),y===null){if(i)return l&&!m?l(t,Ee.encoder,g,"key",p):t;y=""}if(G_(y)||Z_(y)){if(l){let k=m?t:l(t,Ee.encoder,g,"key",p);return[f?.(k)+"="+f?.(l(y,Ee.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(y))]}let I=[];if(typeof y>"u")return I;let D;if(a==="comma"&&St(y))m&&l&&(y=bc(y,l)),D=[{value:y.length>0?y.join(",")||null:void 0}];else if(St(u))D=u;else{let k=Object.keys(y);D=c?k.sort(c):k}let j=o?String(t).replace(/\./g,"%2E"):String(t),K=r&&St(y)&&y.length===1?j+"[]":j;if(n&&St(y)&&y.length===0)return K+"[]";for(let k=0;k<D.length;++k){let ve=D[k],Zt=typeof ve=="object"&&typeof ve.value<"u"?ve.value:y[ve];if(s&&Zt===null)continue;let Tt=d&&o?ve.replace(/\./g,"%2E"):ve,qt=St(y)?typeof a=="function"?a(K,Tt):K:K+(d?"."+Tt:"["+Tt+"]");_.set(e,w);let jt=new WeakMap;jt.set(Gs,_),wc(I,Oc(Zt,qt,a,r,n,i,s,o,a==="comma"&&m&&St(y)?null:l,u,c,d,h,p,f,m,g,jt))}return I}function W_(e=Ee){if(typeof e.allowEmptyArrays<"u"&&typeof e.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof e.encodeDotInKeys<"u"&&typeof e.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(e.encoder!==null&&typeof e.encoder<"u"&&typeof e.encoder!="function")throw new TypeError("Encoder has to be a function.");let t=e.charset||Ee.charset;if(typeof e.charset<"u"&&e.charset!=="utf-8"&&e.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let a=qs;if(typeof e.format<"u"){if(!q_.call(Hs,e.format))throw new TypeError("Unknown format option provided.");a=e.format}let r=Hs[a],n=Ee.filter;(typeof e.filter=="function"||St(e.filter))&&(n=e.filter);let i;if(e.arrayFormat&&e.arrayFormat in vc?i=e.arrayFormat:"indices"in e?i=e.indices?"indices":"repeat":i=Ee.arrayFormat,"commaRoundTrip"in e&&typeof e.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let s=typeof e.allowDots>"u"?e.encodeDotInKeys?!0:Ee.allowDots:!!e.allowDots;return{addQueryPrefix:typeof e.addQueryPrefix=="boolean"?e.addQueryPrefix:Ee.addQueryPrefix,allowDots:s,allowEmptyArrays:typeof e.allowEmptyArrays=="boolean"?!!e.allowEmptyArrays:Ee.allowEmptyArrays,arrayFormat:i,charset:t,charsetSentinel:typeof e.charsetSentinel=="boolean"?e.charsetSentinel:Ee.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:typeof e.delimiter>"u"?Ee.delimiter:e.delimiter,encode:typeof e.encode=="boolean"?e.encode:Ee.encode,encodeDotInKeys:typeof e.encodeDotInKeys=="boolean"?e.encodeDotInKeys:Ee.encodeDotInKeys,encoder:typeof e.encoder=="function"?e.encoder:Ee.encoder,encodeValuesOnly:typeof e.encodeValuesOnly=="boolean"?e.encodeValuesOnly:Ee.encodeValuesOnly,filter:n,format:a,formatter:r,serializeDate:typeof e.serializeDate=="function"?e.serializeDate:Ee.serializeDate,skipNulls:typeof e.skipNulls=="boolean"?e.skipNulls:Ee.skipNulls,sort:typeof e.sort=="function"?e.sort:null,strictNullHandling:typeof e.strictNullHandling=="boolean"?e.strictNullHandling:Ee.strictNullHandling}}function K_(e,t={}){let a=e,r=W_(t),n,i;typeof r.filter=="function"?(i=r.filter,a=i("",a)):St(r.filter)&&(i=r.filter,n=i);let s=[];if(typeof a!="object"||a===null)return"";let o=vc[r.arrayFormat],l=o==="comma"&&r.commaRoundTrip;n||(n=Object.keys(a)),r.sort&&n.sort(r.sort);let u=new WeakMap;for(let h=0;h<n.length;++h){let p=n[h];r.skipNulls&&a[p]===null||wc(s,Oc(a[p],p,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,u))}let c=s.join(r.delimiter),d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),c.length>0?d+c:""}var Ma="4.104.0",Ec=!1,Pr,kc,V_,X_,Y_,xc,Q_,Ws,Ac,Ic,Sc,Pc,$c;function eb(e,t={auto:!1}){if(Ec)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(Pr)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${Pr}'\``);Ec=t.auto,Pr=e.kind,kc=e.fetch,V_=e.Request,X_=e.Response,Y_=e.Headers,xc=e.FormData,Q_=e.Blob,Ws=e.File,Ac=e.ReadableStream,Ic=e.getMultipartRequestOptions,Sc=e.getDefaultAgent,Pc=e.fileFromPath,$c=e.isFsReadStream}var tb=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function ab({manuallyImported:e}={}){let t=e?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",a,r,n,i;try{a=fetch,r=Request,n=Response,i=Headers}catch(s){throw new Error(`this environment is missing the following Web Fetch API type: ${s.message}. ${t}`)}return{kind:"web",fetch:a,Request:r,Response:n,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(s,o)=>({...o,body:new tb(s)}),getDefaultAgent:s=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:s=>!1}}var Tc=()=>{Pr||eb(ab(),{auto:!0})};Tc();var J=class extends Error{},Je=class cl extends J{constructor(t,a,r,n){super(`${cl.makeMessage(t,a,r)}`),this.status=t,this.headers=n,this.request_id=n?.["x-request-id"],this.error=a;let i=a;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(t,a,r){let n=a?.message?typeof a.message=="string"?a.message:JSON.stringify(a.message):a?JSON.stringify(a):r;return t&&n?`${t} ${n}`:t?`${t} status code (no body)`:n||"(no status code or body)"}static generate(t,a,r,n){if(!t||!n)return new Zn({message:r,cause:Ys(a)});let i=a?.error;return t===400?new jc(t,i,r,n):t===401?new Rc(t,i,r,n):t===403?new Nc(t,i,r,n):t===404?new Cc(t,i,r,n):t===409?new Lc(t,i,r,n):t===422?new Mc(t,i,r,n):t===429?new Uc(t,i,r,n):t>=500?new zc(t,i,r,n):new cl(t,i,r,n)}},Ve=class extends Je{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},Zn=class extends Je{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},qn=class extends Zn{constructor({message:e}={}){super({message:e??"Request timed out."})}},jc=class extends Je{},Rc=class extends Je{},Nc=class extends Je{},Cc=class extends Je{},Lc=class extends Je{},Mc=class extends Je{},Uc=class extends Je{},zc=class extends Je{},Dc=class extends J{constructor(){super("Could not parse response content as the length limit was reached")}},Fc=class extends J{constructor(){super("Could not parse response content as the request was rejected by the content filter")}},Hn=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},ma=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Xe,Jn=class{constructor(){Xe.set(this,void 0),this.buffer=new Uint8Array,Hn(this,Xe,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e,a=new Uint8Array(this.buffer.length+t.length);a.set(this.buffer),a.set(t,this.buffer.length),this.buffer=a;let r=[],n;for(;(n=rb(this.buffer,ma(this,Xe,"f")))!=null;){if(n.carriage&&ma(this,Xe,"f")==null){Hn(this,Xe,n.index,"f");continue}if(ma(this,Xe,"f")!=null&&(n.index!==ma(this,Xe,"f")+1||n.carriage)){r.push(this.decodeText(this.buffer.slice(0,ma(this,Xe,"f")-1))),this.buffer=this.buffer.slice(ma(this,Xe,"f")),Hn(this,Xe,null,"f");continue}let i=ma(this,Xe,"f")!==null?n.preceding-1:n.preceding,s=this.decodeText(this.buffer.slice(0,i));r.push(s),this.buffer=this.buffer.slice(n.index),Hn(this,Xe,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new J(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new J(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new J("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}};Xe=new WeakMap,Jn.NEWLINE_CHARS=new Set([`
`,"\r"]),Jn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function rb(e,t){for(let a=t??0;a<e.length;a++){if(e[a]===10)return{preceding:a,index:a+1,carriage:!1};if(e[a]===13)return{preceding:a,index:a+1,carriage:!0}}return null}function nb(e){for(let t=0;t<e.length-1;t++){if(e[t]===10&&e[t+1]===10||e[t]===13&&e[t+1]===13)return t+2;if(e[t]===13&&e[t+1]===10&&t+3<e.length&&e[t+2]===13&&e[t+3]===10)return t+4}return-1}function Bc(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let a=await t.read();return a?.done&&t.releaseLock(),a}catch(a){throw t.releaseLock(),a}},async return(){let a=t.cancel();return t.releaseLock(),await a,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var $r=class Vr{constructor(t,a){this.iterator=t,this.controller=a}static fromSSEResponse(t,a){let r=!1;async function*n(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let s of ib(t,a))if(!i){if(s.data.startsWith("[DONE]")){i=!0;continue}if(s.event===null||s.event.startsWith("response.")||s.event.startsWith("transcript.")){let o;try{o=JSON.parse(s.data)}catch(l){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),l}if(o&&o.error)throw new Je(void 0,o.error,void 0,Xc(t.headers));yield o}else{let o;try{o=JSON.parse(s.data)}catch(l){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),l}if(s.event=="error")throw new Je(void 0,o.error,o.message,void 0);yield{event:s.event,data:o}}}i=!0}catch(s){if(s instanceof Error&&s.name==="AbortError")return;throw s}finally{i||a.abort()}}return new Vr(n,a)}static fromReadableStream(t,a){let r=!1;async function*n(){let s=new Jn,o=Bc(t);for await(let l of o)for(let u of s.decode(l))yield u;for(let l of s.flush())yield l}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let o of n())s||o&&(yield JSON.parse(o));s=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{s||a.abort()}}return new Vr(i,a)}[Symbol.asyncIterator](){return this.iterator()}tee(){let t=[],a=[],r=this.iterator(),n=i=>({next:()=>{if(i.length===0){let s=r.next();t.push(s),a.push(s)}return i.shift()}});return[new Vr(()=>n(t),this.controller),new Vr(()=>n(a),this.controller)]}toReadableStream(){let t=this,a,r=new TextEncoder;return new Ac({async start(){a=t[Symbol.asyncIterator]()},async pull(n){try{let{value:i,done:s}=await a.next();if(s)return n.close();let o=r.encode(JSON.stringify(i)+`
`);n.enqueue(o)}catch(i){n.error(i)}},async cancel(){await a.return?.()}})}};async function*ib(e,t){if(!e.body)throw t.abort(),new J("Attempted to iterate over a response with no body");let a=new ob,r=new Jn,n=Bc(e.body);for await(let i of sb(n))for(let s of r.decode(i)){let o=a.decode(s);o&&(yield o)}for(let i of r.flush()){let s=a.decode(i);s&&(yield s)}}async function*sb(e){let t=new Uint8Array;for await(let a of e){if(a==null)continue;let r=a instanceof ArrayBuffer?new Uint8Array(a):typeof a=="string"?new TextEncoder().encode(a):a,n=new Uint8Array(t.length+r.length);n.set(t),n.set(r,t.length),t=n;let i;for(;(i=nb(t))!==-1;)yield t.slice(0,i),t=t.slice(i)}t.length>0&&(yield t)}var ob=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let n={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],n}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,a,r]=lb(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function lb(e,t){let a=e.indexOf(t);return a!==-1?[e.substring(0,a),t,e.substring(a+t.length)]:[e,"",""]}var Zc=e=>e!=null&&typeof e=="object"&&typeof e.url=="string"&&typeof e.blob=="function",qc=e=>e!=null&&typeof e=="object"&&typeof e.name=="string"&&typeof e.lastModified=="number"&&Gn(e),Gn=e=>e!=null&&typeof e=="object"&&typeof e.size=="number"&&typeof e.type=="string"&&typeof e.text=="function"&&typeof e.slice=="function"&&typeof e.arrayBuffer=="function",ub=e=>qc(e)||Zc(e)||$c(e);async function Hc(e,t,a){if(e=await e,qc(e))return e;if(Zc(e)){let n=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=Gn(n)?[await n.arrayBuffer()]:[n];return new Ws(i,t,a)}let r=await cb(e);if(t||(t=hb(e)??"unknown_file"),!a?.type){let n=r[0]?.type;typeof n=="string"&&(a={...a,type:n})}return new Ws(r,t,a)}async function cb(e){let t=[];if(typeof e=="string"||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Gn(e))t.push(await e.arrayBuffer());else if(pb(e))for await(let a of e)t.push(a);else throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${db(e)}`);return t}function db(e){return`[${Object.getOwnPropertyNames(e).map(t=>`"${t}"`).join(", ")}]`}function hb(e){return Ks(e.name)||Ks(e.filename)||Ks(e.path)?.split(/[\\/]/).pop()}var Ks=e=>{if(typeof e=="string")return e;if(typeof Buffer<"u"&&e instanceof Buffer)return String(e)},pb=e=>e!=null&&typeof e=="object"&&typeof e[Symbol.asyncIterator]=="function",Jc=e=>e&&typeof e=="object"&&e.body&&e[Symbol.toStringTag]==="MultipartBody",ga=async e=>{let t=await fb(e.body);return Ic(t,e)},fb=async e=>{let t=new xc;return await Promise.all(Object.entries(e||{}).map(([a,r])=>Vs(t,a,r))),t},Vs=async(e,t,a)=>{if(a!==void 0){if(a==null)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")e.append(t,String(a));else if(ub(a)){let r=await Hc(a);e.append(t,r)}else if(Array.isArray(a))await Promise.all(a.map(r=>Vs(e,t+"[]",r)));else if(typeof a=="object")await Promise.all(Object.entries(a).map(([r,n])=>Vs(e,`${t}[${r}]`,n)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${a} instead`)}},mb=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},gb=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Wn;Tc();async function Gc(e){let{response:t}=e;if(e.options.stream)return ta("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):$r.fromSSEResponse(t,e.controller);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let a=t.headers.get("content-type")?.split(";")[0]?.trim();if(a?.includes("application/json")||a?.endsWith("+json")){let n=await t.json();return ta("response",t.status,t.url,t.headers,n),Wc(n,t)}let r=await t.text();return ta("response",t.status,t.url,t.headers,r),r}function Wc(e,t){return!e||typeof e!="object"||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}var Kc=class Gh extends Promise{constructor(t,a=Gc){super(r=>{r(null)}),this.responsePromise=t,this.parseResponse=a}_thenUnwrap(t){return new Gh(this.responsePromise,async a=>Wc(t(await this.parseResponse(a),a),a.response))}asResponse(){return this.responsePromise.then(t=>t.response)}async withResponse(){let[t,a]=await Promise.all([this.parse(),this.asResponse()]);return{data:t,response:a,request_id:a.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(t,a){return this.parse().then(t,a)}catch(t){return this.parse().catch(t)}finally(t){return this.parse().finally(t)}},yb=class{constructor({baseURL:e,maxRetries:t=2,timeout:a=6e5,httpAgent:r,fetch:n}){this.baseURL=e,this.maxRetries=Xs("maxRetries",t),this.timeout=Xs("timeout",a),this.httpAgent=r,this.fetch=n??kc}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ob(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ab()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,a){return this.request(Promise.resolve(a).then(async r=>{let n=r&&Gn(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:n}}))}getAPIList(e,t,a){return this.requestAPIList(t,{method:"get",path:e,...a})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let a={...e},{method:r,path:n,query:i,headers:s={}}=a,o=ArrayBuffer.isView(a.body)||a.__binaryRequest&&typeof a.body=="string"?a.body:Jc(a.body)?a.body.body:a.body?JSON.stringify(a.body,null,2):null,l=this.calculateContentLength(o),u=this.buildURL(n,i);"timeout"in a&&Xs("timeout",a.timeout),a.timeout=a.timeout??this.timeout;let c=a.httpAgent??this.httpAgent??Sc(u),d=a.timeout+1e3;typeof c?.options?.timeout=="number"&&d>(c.options.timeout??0)&&(c.options.timeout=d),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let h=this.buildHeaders({options:a,headers:s,contentLength:l,retryCount:t});return{req:{method:r,...o&&{body:o},headers:h,...c&&{agent:c},signal:a.signal??null},url:u,timeout:a.timeout}}buildHeaders({options:e,headers:t,contentLength:a,retryCount:r}){let n={};a&&(n["content-length"]=a);let i=this.defaultHeaders(e);return rd(n,i),rd(n,t),Jc(e.body)&&Pr!=="node"&&delete n["content-type"],Vn(i,"x-stainless-retry-count")===void 0&&Vn(t,"x-stainless-retry-count")===void 0&&(n["x-stainless-retry-count"]=String(r)),Vn(i,"x-stainless-timeout")===void 0&&Vn(t,"x-stainless-timeout")===void 0&&e.timeout&&(n["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(n,t),n}async prepareOptions(e){}async prepareRequest(e,{url:t,options:a}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,a,r){return Je.generate(e,t,a,r)}request(e,t=null){return new Kc(this.makeRequest(e,t))}async makeRequest(e,t){let a=await e,r=a.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(a);let{req:n,url:i,timeout:s}=this.buildRequest(a,{retryCount:r-t});if(await this.prepareRequest(n,{url:i,options:a}),ta("request",i,a,n.headers),a.signal?.aborted)throw new Ve;let o=new AbortController,l=await this.fetchWithTimeout(i,n,s,o).catch(Ys);if(l instanceof Error){if(a.signal?.aborted)throw new Ve;if(t)return this.retryRequest(a,t);throw l.name==="AbortError"?new qn:new Zn({cause:l})}let u=Xc(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){let p=`retrying, ${t} attempts remaining`;return ta(`response (error; ${p})`,l.status,i,u),this.retryRequest(a,t,u)}let c=await l.text().catch(p=>Ys(p).message),d=Eb(c),h=d?void 0:c;throw ta(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,i,u,h),this.makeStatusError(l.status,d,h,u)}return{response:l,options:a,controller:o}}requestAPIList(e,t){let a=this.makeRequest(t,null);return new _b(this,a,e)}buildURL(e,t){let a=xb(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return td(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,a])=>typeof a<"u").map(([t,a])=>{if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(a)}`;if(a===null)return`${encodeURIComponent(t)}=`;throw new J(`Cannot stringify type ${typeof a}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,a,r){let{signal:n,...i}=t||{};n&&n.addEventListener("abort",()=>r.abort());let s=setTimeout(()=>r.abort(),a),o={signal:r.signal,...i};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(s)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,a){let r,n=a?.["retry-after-ms"];if(n){let s=parseFloat(n);Number.isNaN(s)||(r=s)}let i=a?.["retry-after"];if(i&&!r){let s=parseFloat(i);Number.isNaN(s)?r=Date.parse(i)-Date.now():r=s*1e3}if(!(r&&0<=r&&r<60*1e3)){let s=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,s)}return await Tr(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let a=t-e,r=Math.min(.5*Math.pow(2,a),8),n=1-Math.random()*.25;return r*n*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ma}`}},Vc=class{constructor(e,t,a,r){Wn.set(this,void 0),mb(this,Wn,e,"f"),this.options=r,this.response=t,this.body=a}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new J("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let a=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[r,n]of a)e.url.searchParams.set(r,n);t.query=void 0,t.path=e.url.toString()}return await gb(this,Wn,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Wn=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},_b=class extends Kc{constructor(e,t,a){super(t,async r=>new a(e,r.response,await Gc(r),r.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},Xc=e=>new Proxy(Object.fromEntries(e.entries()),{get(t,a){let r=a.toString();return t[r.toLowerCase()]||t[r]}}),bb={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ye=e=>typeof e=="object"&&e!==null&&!td(e)&&Object.keys(e).every(t=>ad(bb,t)),vb=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ma,"X-Stainless-OS":Qc(Deno.build.os),"X-Stainless-Arch":Yc(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ma,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ma,"X-Stainless-OS":Qc(process.platform),"X-Stainless-Arch":Yc(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let e=wb();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ma,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ma,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function wb(){if(typeof navigator>"u"||!navigator)return null;let e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:t,pattern:a}of e){let r=a.exec(navigator.userAgent);if(r){let n=r[1]||0,i=r[2]||0,s=r[3]||0;return{browser:t,version:`${n}.${i}.${s}`}}}return null}var Yc=e=>e==="x32"?"x32":e==="x86_64"||e==="x64"?"x64":e==="arm"?"arm":e==="aarch64"||e==="arm64"?"arm64":e?`other:${e}`:"unknown",Qc=e=>(e=e.toLowerCase(),e.includes("ios")?"iOS":e==="android"?"Android":e==="darwin"?"MacOS":e==="win32"?"Windows":e==="freebsd"?"FreeBSD":e==="openbsd"?"OpenBSD":e==="linux"?"Linux":e?`Other:${e}`:"Unknown"),ed,Ob=()=>ed??(ed=vb()),Eb=e=>{try{return JSON.parse(e)}catch{return}},kb=/^[a-z][a-z0-9+.-]*:/i,xb=e=>kb.test(e),Tr=e=>new Promise(t=>setTimeout(t,e)),Xs=(e,t)=>{if(typeof t!="number"||!Number.isInteger(t))throw new J(`${e} must be an integer`);if(t<0)throw new J(`${e} must be a positive integer`);return t},Ys=e=>{if(e instanceof Error)return e;if(typeof e=="object"&&e!==null)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},Kn=e=>{if(typeof process<"u")return process.env?.[e]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(e)?.trim()};function td(e){if(!e)return!0;for(let t in e)return!1;return!0}function ad(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function rd(e,t){for(let a in t){if(!ad(t,a))continue;let r=a.toLowerCase();if(!r)continue;let n=t[a];n===null?delete e[r]:n!==void 0&&(e[r]=n)}}var nd=new Set(["authorization","api-key"]);function ta(e,...t){if(typeof process<"u"&&process?.env?.DEBUG==="true"){let a=t.map(r=>{if(!r)return r;if(r.headers){let i={...r,headers:{...r.headers}};for(let s in r.headers)nd.has(s.toLowerCase())&&(i.headers[s]="REDACTED");return i}let n=null;for(let i in r)nd.has(i.toLowerCase())&&(n??(n={...r}),n[i]="REDACTED");return n??r});console.log(`OpenAI:DEBUG:${e}`,...a)}}var Ab=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),Ib=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Sb=e=>typeof e?.get=="function",Vn=(e,t)=>{let a=t.toLowerCase();if(Sb(e)){let r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(n,i,s)=>i+s.toUpperCase());for(let n of[t,a,t.toUpperCase(),r]){let i=e.get(n);if(i)return i}}for(let[r,n]of Object.entries(e))if(r.toLowerCase()===a)return Array.isArray(n)?(n.length<=1||console.warn(`Received ${n.length} entries for the ${t} header, using the first entry.`),n[0]):n},Pb=e=>{if(typeof Buffer<"u"){let t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}else{let t=atob(e),a=t.length,r=new Uint8Array(a);for(let n=0;n<a;n++)r[n]=t.charCodeAt(n);return Array.from(new Float32Array(r.buffer))}};function Qs(e){return e!=null&&typeof e=="object"&&!Array.isArray(e)}var Xn=class extends Vc{constructor(e,t,a,r){super(e,t,a,r),this.data=a.data||[],this.object=a.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}},ke=class extends Vc{constructor(e,t,a,r){super(e,t,a,r),this.data=a.data||[],this.has_more=a.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){let e=this.getPaginatedItems();if(!e.length)return null;let t=e[e.length-1]?.id;return t?{params:{after:t}}:null}},W=class{constructor(e){this._client=e}},id=class extends W{list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,$b,{query:t,...a})}},Yn=class extends W{constructor(){super(...arguments),this.messages=new id(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,a){return this._client.post(`/chat/completions/${e}`,{body:t,...a})}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/chat/completions",Qn,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}},Qn=class extends ke{},$b=class extends ke{};Yn.ChatCompletionsPage=Qn,Yn.Messages=id;var ei=class extends W{constructor(){super(...arguments),this.completions=new Yn(this._client)}};ei.Completions=Yn,ei.ChatCompletionsPage=Qn;var sd=class extends W{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}},od=class extends W{create(e,t){return this._client.post("/audio/transcriptions",ga({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}},ld=class extends W{create(e,t){return this._client.post("/audio/translations",ga({body:e,...t,__metadata:{model:e.model}}))}},jr=class extends W{constructor(){super(...arguments),this.transcriptions=new od(this._client),this.translations=new ld(this._client),this.speech=new sd(this._client)}};jr.Transcriptions=od,jr.Translations=ld,jr.Speech=sd;var eo=class extends W{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/batches",to,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},to=class extends ke{};eo.BatchesPage=to;var ht=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},_e=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},ao,ti,ai,Rr,Nr,ri,Cr,Ft,Lr,ni,ii,Ua,ud,ro=class{constructor(){ao.add(this),this.controller=new AbortController,ti.set(this,void 0),ai.set(this,()=>{}),Rr.set(this,()=>{}),Nr.set(this,void 0),ri.set(this,()=>{}),Cr.set(this,()=>{}),Ft.set(this,{}),Lr.set(this,!1),ni.set(this,!1),ii.set(this,!1),Ua.set(this,!1),ht(this,ti,new Promise((e,t)=>{ht(this,ai,e,"f"),ht(this,Rr,t,"f")}),"f"),ht(this,Nr,new Promise((e,t)=>{ht(this,ri,e,"f"),ht(this,Cr,t,"f")}),"f"),_e(this,ti,"f").catch(()=>{}),_e(this,Nr,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},_e(this,ao,"m",ud).bind(this))},0)}_connected(){this.ended||(_e(this,ai,"f").call(this),this._emit("connect"))}get ended(){return _e(this,Lr,"f")}get errored(){return _e(this,ni,"f")}get aborted(){return _e(this,ii,"f")}abort(){this.controller.abort()}on(e,t){return(_e(this,Ft,"f")[e]||(_e(this,Ft,"f")[e]=[])).push({listener:t}),this}off(e,t){let a=_e(this,Ft,"f")[e];if(!a)return this;let r=a.findIndex(n=>n.listener===t);return r>=0&&a.splice(r,1),this}once(e,t){return(_e(this,Ft,"f")[e]||(_e(this,Ft,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,a)=>{ht(this,Ua,!0,"f"),e!=="error"&&this.once("error",a),this.once(e,t)})}async done(){ht(this,Ua,!0,"f"),await _e(this,Nr,"f")}_emit(e,...t){if(_e(this,Lr,"f"))return;e==="end"&&(ht(this,Lr,!0,"f"),_e(this,ri,"f").call(this));let a=_e(this,Ft,"f")[e];if(a&&(_e(this,Ft,"f")[e]=a.filter(r=>!r.once),a.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!_e(this,Ua,"f")&&!a?.length&&Promise.reject(r),_e(this,Rr,"f").call(this,r),_e(this,Cr,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!_e(this,Ua,"f")&&!a?.length&&Promise.reject(r),_e(this,Rr,"f").call(this,r),_e(this,Cr,"f").call(this,r),this._emit("end")}}_emitFinal(){}};ti=new WeakMap,ai=new WeakMap,Rr=new WeakMap,Nr=new WeakMap,ri=new WeakMap,Cr=new WeakMap,Ft=new WeakMap,Lr=new WeakMap,ni=new WeakMap,ii=new WeakMap,Ua=new WeakMap,ao=new WeakSet,ud=function(e){if(ht(this,ni,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Ve),e instanceof Ve)return ht(this,ii,!0,"f"),this._emit("abort",e);if(e instanceof J)return this._emit("error",e);if(e instanceof Error){let t=new J(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new J(String(e)))};var B=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Ye=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},je,no,Pt,si,pt,ya,za,_a,oi,Qe,li,ui,Mr,Ur,zr,cd,dd,hd,pd,fd,md,gd,Da=class Xr extends ro{constructor(){super(...arguments),je.add(this),no.set(this,[]),Pt.set(this,{}),si.set(this,{}),pt.set(this,void 0),ya.set(this,void 0),za.set(this,void 0),_a.set(this,void 0),oi.set(this,void 0),Qe.set(this,void 0),li.set(this,void 0),ui.set(this,void 0),Mr.set(this,void 0)}[(no=new WeakMap,Pt=new WeakMap,si=new WeakMap,pt=new WeakMap,ya=new WeakMap,za=new WeakMap,_a=new WeakMap,oi=new WeakMap,Qe=new WeakMap,li=new WeakMap,ui=new WeakMap,Mr=new WeakMap,je=new WeakSet,Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("event",n=>{let i=a.shift();i?i.resolve(n):t.push(n)}),this.on("end",()=>{r=!0;for(let n of a)n.resolve(void 0);a.length=0}),this.on("abort",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),this.on("error",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((n,i)=>a.push({resolve:n,reject:i})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(t){let a=new Xr;return a._run(()=>a._fromReadableStream(t)),a}async _fromReadableStream(t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let n=$r.fromReadableStream(t,this.controller);for await(let i of n)B(this,je,"m",Ur).call(this,i);if(n.controller.signal?.aborted)throw new Ve;return this._addRun(B(this,je,"m",zr).call(this))}toReadableStream(){return new $r(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(t,a,r,n,i){let s=new Xr;return s._run(()=>s._runToolAssistantStream(t,a,r,n,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(t,a,r,n,i){let s=i?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let o={...n,stream:!0},l=await t.submitToolOutputs(a,r,o,{...i,signal:this.controller.signal});this._connected();for await(let u of l)B(this,je,"m",Ur).call(this,u);if(l.controller.signal?.aborted)throw new Ve;return this._addRun(B(this,je,"m",zr).call(this))}static createThreadAssistantStream(t,a,r){let n=new Xr;return n._run(()=>n._threadAssistantStream(t,a,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(t,a,r,n){let i=new Xr;return i._run(()=>i._runAssistantStream(t,a,r,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return B(this,li,"f")}currentRun(){return B(this,ui,"f")}currentMessageSnapshot(){return B(this,pt,"f")}currentRunStepSnapshot(){return B(this,Mr,"f")}async finalRunSteps(){return await this.done(),Object.values(B(this,Pt,"f"))}async finalMessages(){return await this.done(),Object.values(B(this,si,"f"))}async finalRun(){if(await this.done(),!B(this,ya,"f"))throw Error("Final run was not received.");return B(this,ya,"f")}async _createThreadAssistantStream(t,a,r){let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let i={...a,stream:!0},s=await t.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(let o of s)B(this,je,"m",Ur).call(this,o);if(s.controller.signal?.aborted)throw new Ve;return this._addRun(B(this,je,"m",zr).call(this))}async _createAssistantStream(t,a,r,n){let i=n?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let s={...r,stream:!0},o=await t.create(a,s,{...n,signal:this.controller.signal});this._connected();for await(let l of o)B(this,je,"m",Ur).call(this,l);if(o.controller.signal?.aborted)throw new Ve;return this._addRun(B(this,je,"m",zr).call(this))}static accumulateDelta(t,a){for(let[r,n]of Object.entries(a)){if(!t.hasOwnProperty(r)){t[r]=n;continue}let i=t[r];if(i==null){t[r]=n;continue}if(r==="index"||r==="type"){t[r]=n;continue}if(typeof i=="string"&&typeof n=="string")i+=n;else if(typeof i=="number"&&typeof n=="number")i+=n;else if(Qs(i)&&Qs(n))i=this.accumulateDelta(i,n);else if(Array.isArray(i)&&Array.isArray(n)){if(i.every(s=>typeof s=="string"||typeof s=="number")){i.push(...n);continue}for(let s of n){if(!Qs(s))throw new Error(`Expected array delta entry to be an object but got: ${s}`);let o=s.index;if(o==null)throw console.error(s),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let l=i[o];l==null?i.push(s):i[o]=this.accumulateDelta(l,s)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${n}, accValue: ${i}`);t[r]=i}return t}_addRun(t){return t}async _threadAssistantStream(t,a,r){return await this._createThreadAssistantStream(a,t,r)}async _runAssistantStream(t,a,r,n){return await this._createAssistantStream(a,t,r,n)}async _runToolAssistantStream(t,a,r,n,i){return await this._createToolAssistantStream(r,t,a,n,i)}};Ur=function(e){if(!this.ended)switch(Ye(this,li,e,"f"),B(this,je,"m",hd).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":B(this,je,"m",gd).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":B(this,je,"m",dd).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":B(this,je,"m",cd).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},zr=function(){if(this.ended)throw new J("stream has ended, this shouldn't happen");if(!B(this,ya,"f"))throw Error("Final run has not been received");return B(this,ya,"f")},cd=function(e){let[t,a]=B(this,je,"m",fd).call(this,e,B(this,pt,"f"));Ye(this,pt,t,"f"),B(this,si,"f")[t.id]=t;for(let r of a){let n=t.content[r.index];n?.type=="text"&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if(r.type=="text"&&r.text){let n=r.text,i=t.content[r.index];if(i&&i.type=="text")this._emit("textDelta",n,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=B(this,za,"f")){if(B(this,_a,"f"))switch(B(this,_a,"f").type){case"text":this._emit("textDone",B(this,_a,"f").text,B(this,pt,"f"));break;case"image_file":this._emit("imageFileDone",B(this,_a,"f").image_file,B(this,pt,"f"));break}Ye(this,za,r.index,"f")}Ye(this,_a,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(B(this,za,"f")!==void 0){let r=e.data.content[B(this,za,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,B(this,pt,"f"));break;case"text":this._emit("textDone",r.text,B(this,pt,"f"));break}}B(this,pt,"f")&&this._emit("messageDone",e.data),Ye(this,pt,void 0,"f")}},dd=function(e){let t=B(this,je,"m",pd).call(this,e);switch(Ye(this,Mr,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let a=e.data.delta;if(a.step_details&&a.step_details.type=="tool_calls"&&a.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let r of a.step_details.tool_calls)r.index==B(this,oi,"f")?this._emit("toolCallDelta",r,t.step_details.tool_calls[r.index]):(B(this,Qe,"f")&&this._emit("toolCallDone",B(this,Qe,"f")),Ye(this,oi,r.index,"f"),Ye(this,Qe,t.step_details.tool_calls[r.index],"f"),B(this,Qe,"f")&&this._emit("toolCallCreated",B(this,Qe,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ye(this,Mr,void 0,"f"),e.data.step_details.type=="tool_calls"&&B(this,Qe,"f")&&(this._emit("toolCallDone",B(this,Qe,"f")),Ye(this,Qe,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},hd=function(e){B(this,no,"f").push(e),this._emit("event",e)},pd=function(e){switch(e.event){case"thread.run.step.created":return B(this,Pt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=B(this,Pt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let a=e.data;if(a.delta){let r=Da.accumulateDelta(t,a.delta);B(this,Pt,"f")[e.data.id]=r}return B(this,Pt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":B(this,Pt,"f")[e.data.id]=e.data;break}if(B(this,Pt,"f")[e.data.id])return B(this,Pt,"f")[e.data.id];throw new Error("No snapshot available")},fd=function(e,t){let a=[];switch(e.event){case"thread.message.created":return[e.data,a];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(let n of r.delta.content)if(n.index in t.content){let i=t.content[n.index];t.content[n.index]=B(this,je,"m",md).call(this,n,i)}else t.content[n.index]=n,a.push(n);return[t,a];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,a];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},md=function(e,t){return Da.accumulateDelta(t,e)},gd=function(e){switch(Ye(this,ui,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Ye(this,ya,e.data,"f"),B(this,Qe,"f")&&(this._emit("toolCallDone",B(this,Qe,"f")),Ye(this,Qe,void 0,"f"));break;case"thread.run.cancelling":break}};var io=class extends W{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/assistants/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/assistants",so,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},so=class extends ke{};io.AssistantsPage=so;function yd(e){return typeof e.parse=="function"}var Fa=e=>e?.role==="assistant",_d=e=>e?.role==="function",bd=e=>e?.role==="tool";function Tb(e,t){let a={...e};return Object.defineProperties(a,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),a}function oo(e){return e?.$brand==="auto-parseable-response-format"}function jb(e,{parser:t,callback:a}){let r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:a,enumerable:!1}}),r}function Dr(e){return e?.$brand==="auto-parseable-tool"}function Rb(e,t){return!t||!vd(t)?{...e,choices:e.choices.map(a=>({...a,message:{...a.message,parsed:null,...a.message.tool_calls?{tool_calls:a.message.tool_calls}:void 0}}))}:lo(e,t)}function lo(e,t){let a=e.choices.map(r=>{if(r.finish_reason==="length")throw new Dc;if(r.finish_reason==="content_filter")throw new Fc;return{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:r.message.tool_calls?.map(n=>Cb(t,n))??void 0}:void 0,parsed:r.message.content&&!r.message.refusal?Nb(t,r.message.content):null}}});return{...e,choices:a}}function Nb(e,t){return e.response_format?.type!=="json_schema"?null:e.response_format?.type==="json_schema"?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function Cb(e,t){let a=e.tools?.find(r=>r.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:Dr(a)?a.$parseRaw(t.function.arguments):a?.function.strict?JSON.parse(t.function.arguments):null}}}function Lb(e,t){if(!e)return!1;let a=e.tools?.find(r=>r.function?.name===t.function.name);return Dr(a)||a?.function.strict||!1}function vd(e){return oo(e.response_format)?!0:e.tools?.some(t=>Dr(t)||t.type==="function"&&t.function.strict===!0)??!1}function Mb(e){for(let t of e??[]){if(t.type!=="function")throw new J(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(t.function.strict!==!0)throw new J(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Ge=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Ce,uo,ci,co,ho,po,wd,fo,Od=10,Ed=class extends ro{constructor(){super(...arguments),Ce.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(_d(e)||bd(e))&&e.content)this._emit("functionCallResult",e.content);else if(Fa(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Fa(e)&&e.tool_calls)for(let a of e.tool_calls)a.type==="function"&&this._emit("functionCall",a.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new J("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Ge(this,Ce,"m",uo).call(this)}async finalMessage(){return await this.done(),Ge(this,Ce,"m",ci).call(this)}async finalFunctionCall(){return await this.done(),Ge(this,Ce,"m",co).call(this)}async finalFunctionCallResult(){return await this.done(),Ge(this,Ce,"m",ho).call(this)}async totalUsage(){return await this.done(),Ge(this,Ce,"m",po).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=Ge(this,Ce,"m",ci).call(this);t&&this._emit("finalMessage",t);let a=Ge(this,Ce,"m",uo).call(this);a&&this._emit("finalContent",a);let r=Ge(this,Ce,"m",co).call(this);r&&this._emit("finalFunctionCall",r);let n=Ge(this,Ce,"m",ho).call(this);n!=null&&this._emit("finalFunctionCallResult",n),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",Ge(this,Ce,"m",po).call(this))}async _createChatCompletion(e,t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Ge(this,Ce,"m",wd).call(this,t);let n=await e.chat.completions.create({...t,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addChatCompletion(lo(n,t))}async _runChatCompletion(e,t,a){for(let r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,a)}async _runFunctions(e,t,a){let r="function",{function_call:n="auto",stream:i,...s}=t,o=typeof n!="string"&&n?.name,{maxChatCompletions:l=Od}=a||{},u={};for(let d of t.functions)u[d.name||d.function.name]=d;let c=t.functions.map(d=>({name:d.name||d.function.name,parameters:d.parameters,description:d.description}));for(let d of t.messages)this._addMessage(d,!1);for(let d=0;d<l;++d){let h=(await this._createChatCompletion(e,{...s,function_call:n,functions:c,messages:[...this.messages]},a)).choices[0]?.message;if(!h)throw new J("missing message in ChatCompletion response");if(!h.function_call)return;let{name:p,arguments:f}=h.function_call,m=u[p];if(m){if(o&&o!==p){let b=`Invalid function_call: ${JSON.stringify(p)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:p,content:b});continue}}else{let b=`Invalid function_call: ${JSON.stringify(p)}. Available options are: ${c.map(w=>JSON.stringify(w.name)).join(", ")}. Please try again`;this._addMessage({role:r,name:p,content:b});continue}let g;try{g=yd(m)?await m.parse(f):f}catch(b){this._addMessage({role:r,name:p,content:b instanceof Error?b.message:String(b)});continue}let _=await m.function(g,this),y=Ge(this,Ce,"m",fo).call(this,_);if(this._addMessage({role:r,name:p,content:y}),o)return}}async _runTools(e,t,a){let r="tool",{tool_choice:n="auto",stream:i,...s}=t,o=typeof n!="string"&&n?.function?.name,{maxChatCompletions:l=Od}=a||{},u=t.tools.map(h=>{if(Dr(h)){if(!h.$callback)throw new J("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:h.$callback,name:h.function.name,description:h.function.description||"",parameters:h.function.parameters,parse:h.$parseRaw,strict:!0}}}return h}),c={};for(let h of u)h.type==="function"&&(c[h.function.name||h.function.function.name]=h.function);let d="tools"in t?u.map(h=>h.type==="function"?{type:"function",function:{name:h.function.name||h.function.function.name,parameters:h.function.parameters,description:h.function.description,strict:h.function.strict}}:h):void 0;for(let h of t.messages)this._addMessage(h,!1);for(let h=0;h<l;++h){let p=(await this._createChatCompletion(e,{...s,tool_choice:n,tools:d,messages:[...this.messages]},a)).choices[0]?.message;if(!p)throw new J("missing message in ChatCompletion response");if(!p.tool_calls?.length)return;for(let f of p.tool_calls){if(f.type!=="function")continue;let m=f.id,{name:g,arguments:_}=f.function,y=c[g];if(y){if(o&&o!==g){let I=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:m,content:I});continue}}else{let I=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${Object.keys(c).map(D=>JSON.stringify(D)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:m,content:I});continue}let b;try{b=yd(y)?await y.parse(_):_}catch(I){let D=I instanceof Error?I.message:String(I);this._addMessage({role:r,tool_call_id:m,content:D});continue}let w=await y.function(b,this),O=Ge(this,Ce,"m",fo).call(this,w);if(this._addMessage({role:r,tool_call_id:m,content:O}),o)return}}}};Ce=new WeakSet,uo=function(){return Ge(this,Ce,"m",ci).call(this).content??null},ci=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(Fa(t)){let{function_call:a,...r}=t,n={...r,content:t.content??null,refusal:t.refusal??null};return a&&(n.function_call=a),n}}throw new J("stream ended without producing a ChatCompletionMessage with role=assistant")},co=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Fa(t)&&t?.function_call)return t.function_call;if(Fa(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ho=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(_d(t)&&t.content!=null||bd(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(a=>a.role==="assistant"&&a.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},po=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},wd=function(e){if(e.n!=null&&e.n>1)throw new J("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},fo=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var kd=class dl extends Ed{static runFunctions(t,a,r){let n=new dl,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(t,a,i)),n}static runTools(t,a,r){let n=new dl,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(t,a,i)),n}_addMessage(t,a=!0){super._addMessage(t,a),Fa(t)&&t.content&&this._emit("content",t.content)}},Se={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},Ub=class extends Error{},zb=class extends Error{};function Db(e,t=Se.ALL){if(typeof e!="string")throw new TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw new Error(`${e} is empty`);return Fb(e.trim(),t)}var Fb=(e,t)=>{let a=e.length,r=0,n=h=>{throw new Ub(`${h} at position ${r}`)},i=h=>{throw new zb(`${h} at position ${r}`)},s=()=>(d(),r>=a&&n("Unexpected end of input"),e[r]==='"'?o():e[r]==="{"?l():e[r]==="["?u():e.substring(r,r+4)==="null"||Se.NULL&t&&a-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):e.substring(r,r+4)==="true"||Se.BOOL&t&&a-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):e.substring(r,r+5)==="false"||Se.BOOL&t&&a-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):e.substring(r,r+8)==="Infinity"||Se.INFINITY&t&&a-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):e.substring(r,r+9)==="-Infinity"||Se.MINUS_INFINITY&t&&1<a-r&&a-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):e.substring(r,r+3)==="NaN"||Se.NAN&t&&a-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):c()),o=()=>{let h=r,p=!1;for(r++;r<a&&(e[r]!=='"'||p&&e[r-1]==="\\");)p=e[r]==="\\"?!p:!1,r++;if(e.charAt(r)=='"')try{return JSON.parse(e.substring(h,++r-Number(p)))}catch(f){i(String(f))}else if(Se.STR&t)try{return JSON.parse(e.substring(h,r-Number(p))+'"')}catch{return JSON.parse(e.substring(h,e.lastIndexOf("\\"))+'"')}n("Unterminated string literal")},l=()=>{r++,d();let h={};try{for(;e[r]!=="}";){if(d(),r>=a&&Se.OBJ&t)return h;let p=o();d(),r++;try{let f=s();Object.defineProperty(h,p,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(Se.OBJ&t)return h;throw f}d(),e[r]===","&&r++}}catch{if(Se.OBJ&t)return h;n("Expected '}' at end of object")}return r++,h},u=()=>{r++;let h=[];try{for(;e[r]!=="]";)h.push(s()),d(),e[r]===","&&r++}catch{if(Se.ARR&t)return h;n("Expected ']' at end of array")}return r++,h},c=()=>{if(r===0){e==="-"&&Se.NUM&t&&n("Not sure what '-' is");try{return JSON.parse(e)}catch(p){if(Se.NUM&t)try{return e[e.length-1]==="."?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch{}i(String(p))}}let h=r;for(e[r]==="-"&&r++;e[r]&&!",]}".includes(e[r]);)r++;r==a&&!(Se.NUM&t)&&n("Unterminated number literal");try{return JSON.parse(e.substring(h,r))}catch{e.substring(h,r)==="-"&&Se.NUM&t&&n("Not sure what '-' is");try{return JSON.parse(e.substring(h,e.lastIndexOf("e")))}catch(p){i(String(p))}}},d=()=>{for(;r<a&&` 
\r	`.includes(e[r]);)r++};return s()},xd=e=>Db(e,Se.ALL^Se.NUM),Ba=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},me=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},xe,Bt,Za,aa,mo,di,go,yo,_o,hi,bo,Ad,Id=class hl extends Ed{constructor(t){super(),xe.add(this),Bt.set(this,void 0),Za.set(this,void 0),aa.set(this,void 0),Ba(this,Bt,t,"f"),Ba(this,Za,[],"f")}get currentChatCompletionSnapshot(){return me(this,aa,"f")}static fromReadableStream(t){let a=new hl(null);return a._run(()=>a._fromReadableStream(t)),a}static createChatCompletion(t,a,r){let n=new hl(a);return n._run(()=>n._runChatCompletion(t,{...a,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(t,a,r){super._createChatCompletion;let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),me(this,xe,"m",mo).call(this);let i=await t.chat.completions.create({...a,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let s of i)me(this,xe,"m",go).call(this,s);if(i.controller.signal?.aborted)throw new Ve;return this._addChatCompletion(me(this,xe,"m",hi).call(this))}async _fromReadableStream(t,a){let r=a?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),me(this,xe,"m",mo).call(this),this._connected();let n=$r.fromReadableStream(t,this.controller),i;for await(let s of n)i&&i!==s.id&&this._addChatCompletion(me(this,xe,"m",hi).call(this)),me(this,xe,"m",go).call(this,s),i=s.id;if(n.controller.signal?.aborted)throw new Ve;return this._addChatCompletion(me(this,xe,"m",hi).call(this))}[(Bt=new WeakMap,Za=new WeakMap,aa=new WeakMap,xe=new WeakSet,mo=function(){this.ended||Ba(this,aa,void 0,"f")},di=function(t){let a=me(this,Za,"f")[t.index];return a||(a={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},me(this,Za,"f")[t.index]=a,a)},go=function(t){if(this.ended)return;let a=me(this,xe,"m",Ad).call(this,t);this._emit("chunk",t,a);for(let r of t.choices){let n=a.choices[r.index];r.delta.content!=null&&n.message?.role==="assistant"&&n.message?.content&&(this._emit("content",r.delta.content,n.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:n.message.content,parsed:n.message.parsed})),r.delta.refusal!=null&&n.message?.role==="assistant"&&n.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:n.message.refusal}),r.logprobs?.content!=null&&n.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:n.logprobs?.content??[]}),r.logprobs?.refusal!=null&&n.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:n.logprobs?.refusal??[]});let i=me(this,xe,"m",di).call(this,n);n.finish_reason&&(me(this,xe,"m",_o).call(this,n),i.current_tool_call_index!=null&&me(this,xe,"m",yo).call(this,n,i.current_tool_call_index));for(let s of r.delta.tool_calls??[])i.current_tool_call_index!==s.index&&(me(this,xe,"m",_o).call(this,n),i.current_tool_call_index!=null&&me(this,xe,"m",yo).call(this,n,i.current_tool_call_index)),i.current_tool_call_index=s.index;for(let s of r.delta.tool_calls??[]){let o=n.message.tool_calls?.[s.index];o?.type&&(o?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:o.function?.name,index:s.index,arguments:o.function.arguments,parsed_arguments:o.function.parsed_arguments,arguments_delta:s.function?.arguments??""}):o?.type)}}},yo=function(t,a){if(me(this,xe,"m",di).call(this,t).done_tool_calls.has(a))return;let r=t.message.tool_calls?.[a];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if(r.type==="function"){let n=me(this,Bt,"f")?.tools?.find(i=>i.type==="function"&&i.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:a,arguments:r.function.arguments,parsed_arguments:Dr(n)?n.$parseRaw(r.function.arguments):n?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},_o=function(t){let a=me(this,xe,"m",di).call(this,t);if(t.message.content&&!a.content_done){a.content_done=!0;let r=me(this,xe,"m",bo).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!a.refusal_done&&(a.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!a.logprobs_content_done&&(a.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!a.logprobs_refusal_done&&(a.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},hi=function(){if(this.ended)throw new J("stream has ended, this shouldn't happen");let t=me(this,aa,"f");if(!t)throw new J("request ended without sending any chunks");return Ba(this,aa,void 0,"f"),Ba(this,Za,[],"f"),Bb(t,me(this,Bt,"f"))},bo=function(){let t=me(this,Bt,"f")?.response_format;return oo(t)?t:null},Ad=function(t){var a,r,n,i;let s=me(this,aa,"f"),{choices:o,...l}=t;s?Object.assign(s,l):s=Ba(this,aa,{...l,choices:[]},"f");for(let{delta:u,finish_reason:c,index:d,logprobs:h=null,...p}of t.choices){let f=s.choices[d];if(f||(f=s.choices[d]={finish_reason:c,index:d,message:{},logprobs:h,...p}),h)if(!f.logprobs)f.logprobs=Object.assign({},h);else{let{content:O,refusal:I,...D}=h;Object.assign(f.logprobs,D),O&&((a=f.logprobs).content??(a.content=[]),f.logprobs.content.push(...O)),I&&((r=f.logprobs).refusal??(r.refusal=[]),f.logprobs.refusal.push(...I))}if(c&&(f.finish_reason=c,me(this,Bt,"f")&&vd(me(this,Bt,"f")))){if(c==="length")throw new Dc;if(c==="content_filter")throw new Fc}if(Object.assign(f,p),!u)continue;let{content:m,refusal:g,function_call:_,role:y,tool_calls:b,...w}=u;if(Object.assign(f.message,w),g&&(f.message.refusal=(f.message.refusal||"")+g),y&&(f.message.role=y),_&&(f.message.function_call?(_.name&&(f.message.function_call.name=_.name),_.arguments&&((n=f.message.function_call).arguments??(n.arguments=""),f.message.function_call.arguments+=_.arguments)):f.message.function_call=_),m&&(f.message.content=(f.message.content||"")+m,!f.message.refusal&&me(this,xe,"m",bo).call(this)&&(f.message.parsed=xd(f.message.content))),b){f.message.tool_calls||(f.message.tool_calls=[]);for(let{index:O,id:I,type:D,function:j,...K}of b){let k=(i=f.message.tool_calls)[O]??(i[O]={});Object.assign(k,K),I&&(k.id=I),D&&(k.type=D),j&&(k.function??(k.function={name:j.name??"",arguments:""})),j?.name&&(k.function.name=j.name),j?.arguments&&(k.function.arguments+=j.arguments,Lb(me(this,Bt,"f"),k)&&(k.function.parsed_arguments=xd(k.function.arguments)))}}}return s},Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("chunk",n=>{let i=a.shift();i?i.resolve(n):t.push(n)}),this.on("end",()=>{r=!0;for(let n of a)n.resolve(void 0);a.length=0}),this.on("abort",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),this.on("error",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((n,i)=>a.push({resolve:n,reject:i})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new $r(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function Bb(e,t){let{id:a,choices:r,created:n,model:i,system_fingerprint:s,...o}=e,l={...o,id:a,choices:r.map(({message:u,finish_reason:c,index:d,logprobs:h,...p})=>{if(!c)throw new J(`missing finish_reason for choice ${d}`);let{content:f=null,function_call:m,tool_calls:g,..._}=u,y=u.role;if(!y)throw new J(`missing role for choice ${d}`);if(m){let{arguments:b,name:w}=m;if(b==null)throw new J(`missing function_call.arguments for choice ${d}`);if(!w)throw new J(`missing function_call.name for choice ${d}`);return{...p,message:{content:f,function_call:{arguments:b,name:w},role:y,refusal:u.refusal??null},finish_reason:c,index:d,logprobs:h}}return g?{...p,index:d,finish_reason:c,logprobs:h,message:{..._,role:y,content:f,refusal:u.refusal??null,tool_calls:g.map((b,w)=>{let{function:O,type:I,id:D,...j}=b,{arguments:K,name:k,...ve}=O||{};if(D==null)throw new J(`missing choices[${d}].tool_calls[${w}].id
${pi(e)}`);if(I==null)throw new J(`missing choices[${d}].tool_calls[${w}].type
${pi(e)}`);if(k==null)throw new J(`missing choices[${d}].tool_calls[${w}].function.name
${pi(e)}`);if(K==null)throw new J(`missing choices[${d}].tool_calls[${w}].function.arguments
${pi(e)}`);return{...j,id:D,type:I,function:{...ve,name:k,arguments:K}}})}}:{...p,message:{..._,content:f,role:y,refusal:u.refusal??null},finish_reason:c,index:d,logprobs:h}}),created:n,model:i,object:"chat.completion",...s?{system_fingerprint:s}:{}};return Rb(l,t)}function pi(e){return JSON.stringify(e)}var Sd=class Li extends Id{static fromReadableStream(t){let a=new Li(null);return a._run(()=>a._fromReadableStream(t)),a}static runFunctions(t,a,r){let n=new Li(null),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(t,a,i)),n}static runTools(t,a,r){let n=new Li(a),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(t,a,i)),n}},Pd=class extends W{parse(e,t){return Mb(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(a=>lo(a,e))}runFunctions(e,t){return e.stream?Sd.runFunctions(this._client,e,t):kd.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Sd.runTools(this._client,e,t):kd.runTools(this._client,e,t)}stream(e,t){return Id.createChatCompletion(this._client,e,t)}},vo=class extends W{constructor(){super(...arguments),this.completions=new Pd(this._client)}};(function(e){e.Completions=Pd})(vo||(vo={}));var $d=class extends W{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},Td=class extends W{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}},fi=class extends W{constructor(){super(...arguments),this.sessions=new $d(this._client),this.transcriptionSessions=new Td(this._client)}};fi.Sessions=$d,fi.TranscriptionSessions=Td;var wo=class extends W{create(e,t,a){return this._client.post(`/threads/${e}/messages`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/threads/${e}/messages/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Oo,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t,a){return this._client.delete(`/threads/${e}/messages/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},Oo=class extends ke{};wo.MessagesPage=Oo;var Eo=class extends W{retrieve(e,t,a,r={},n){return ye(r)?this.retrieve(e,t,a,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${a}`,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t,a={},r){return ye(a)?this.list(e,t,{},a):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,ko,{query:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}},ko=class extends ke{};Eo.RunStepsPage=ko;var Fr=class extends W{constructor(){super(...arguments),this.steps=new Eo(this._client)}create(e,t,a){let{include:r,...n}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:n,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers},stream:t.stream??!1})}retrieve(e,t,a){return this._client.get(`/threads/${e}/runs/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,xo,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}cancel(e,t,a){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t,a);return await this.poll(e,r.id,a)}createAndStream(e,t,a){return Da.createAssistantStream(e,this._client.beta.threads.runs,t,a)}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let{data:n,response:i}=await this.retrieve(e,t,{...a,headers:{...a?.headers,...r}}).withResponse();switch(n.status){case"queued":case"in_progress":case"cancelling":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=i.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await Tr(s);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return n}}}stream(e,t,a){return Da.createAssistantStream(e,this._client.beta.threads.runs,t,a)}submitToolOutputs(e,t,a,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:a.stream??!1})}async submitToolOutputsAndPoll(e,t,a,r){let n=await this.submitToolOutputs(e,t,a,r);return await this.poll(e,n.id,r)}submitToolOutputsStream(e,t,a,r){return Da.createToolAssistantStream(e,t,this._client.beta.threads.runs,a,r)}},xo=class extends ke{};Fr.RunsPage=xo,Fr.Steps=Eo,Fr.RunStepsPage=ko;var qa=class extends W{constructor(){super(...arguments),this.runs=new Fr(this._client),this.messages=new wo(this._client)}create(e={},t){return ye(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/threads/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){let a=await this.createAndRun(e,t);return await this.runs.poll(a.thread_id,a.id,t)}createAndRunStream(e,t){return Da.createThreadAssistantStream(e,this._client.beta.threads,t)}};qa.Runs=Fr,qa.RunsPage=xo,qa.Messages=wo,qa.MessagesPage=Oo;var Ha=class extends W{constructor(){super(...arguments),this.realtime=new fi(this._client),this.chat=new vo(this._client),this.assistants=new io(this._client),this.threads=new qa(this._client)}};Ha.Realtime=fi,Ha.Assistants=io,Ha.AssistantsPage=so,Ha.Threads=qa;var jd=class extends W{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}},Rd=class extends W{retrieve(e,t,a){return this._client.get(`/containers/${e}/files/${t}/content`,{...a,headers:{Accept:"application/binary",...a?.headers},__binaryResponse:!0})}},mi=class extends W{constructor(){super(...arguments),this.content=new Rd(this._client)}create(e,t,a){return this._client.post(`/containers/${e}/files`,ga({body:t,...a}))}retrieve(e,t,a){return this._client.get(`/containers/${e}/files/${t}`,a)}list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,Ao,{query:t,...a})}del(e,t,a){return this._client.delete(`/containers/${e}/files/${t}`,{...a,headers:{Accept:"*/*",...a?.headers}})}},Ao=class extends ke{};mi.FileListResponsesPage=Ao,mi.Content=Rd;var Br=class extends W{constructor(){super(...arguments),this.files=new mi(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/containers",Io,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}},Io=class extends ke{};Br.ContainerListResponsesPage=Io,Br.Files=mi,Br.FileListResponsesPage=Ao;var Nd=class extends W{create(e,t){let a=!!e.encoding_format,r=a?e.encoding_format:"base64";a&&ta("Request","User defined encoding_format:",e.encoding_format);let n=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return a?n:(ta("response","Decoding base64 embeddings to float32 array"),n._thenUnwrap(i=>(i&&i.data&&i.data.forEach(s=>{let o=s.embedding;s.embedding=Pb(o)}),i)))}},So=class extends W{retrieve(e,t,a,r){return this._client.get(`/evals/${e}/runs/${t}/output_items/${a}`,r)}list(e,t,a={},r){return ye(a)?this.list(e,t,{},a):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Po,{query:a,...r})}},Po=class extends ke{};So.OutputItemListResponsesPage=Po;var Zr=class extends W{constructor(){super(...arguments),this.outputItems=new So(this._client)}create(e,t,a){return this._client.post(`/evals/${e}/runs`,{body:t,...a})}retrieve(e,t,a){return this._client.get(`/evals/${e}/runs/${t}`,a)}list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,$o,{query:t,...a})}del(e,t,a){return this._client.delete(`/evals/${e}/runs/${t}`,a)}cancel(e,t,a){return this._client.post(`/evals/${e}/runs/${t}`,a)}},$o=class extends ke{};Zr.RunListResponsesPage=$o,Zr.OutputItems=So,Zr.OutputItemListResponsesPage=Po;var qr=class extends W{constructor(){super(...arguments),this.runs=new Zr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,a){return this._client.post(`/evals/${e}`,{body:t,...a})}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/evals",To,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}},To=class extends ke{};qr.EvalListResponsesPage=To,qr.Runs=Zr,qr.RunListResponsesPage=$o;var jo=class extends W{create(e,t){return this._client.post("/files",ga({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/files",Ro,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:a=30*60*1e3}={}){let r=new Set(["processed","error","deleted"]),n=Date.now(),i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await Tr(t),i=await this.retrieve(e),Date.now()-n>a)throw new qn({message:`Giving up on waiting for file ${e} to finish processing after ${a} milliseconds.`});return i}},Ro=class extends ke{};jo.FileObjectsPage=Ro;var Cd=class extends W{},Ld=class extends W{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}},No=class extends W{constructor(){super(...arguments),this.graders=new Ld(this._client)}};No.Graders=Ld;var Co=class extends W{create(e,t,a){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Lo,{body:t,method:"post",...a})}retrieve(e,t={},a){return ye(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...a})}del(e,t,a){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,a)}},Lo=class extends Xn{};Co.PermissionCreateResponsesPage=Lo;var gi=class extends W{constructor(){super(...arguments),this.permissions=new Co(this._client)}};gi.Permissions=Co,gi.PermissionCreateResponsesPage=Lo;var Mo=class extends W{list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Uo,{query:t,...a})}},Uo=class extends ke{};Mo.FineTuningJobCheckpointsPage=Uo;var Ja=class extends W{constructor(){super(...arguments),this.checkpoints=new Mo(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",zo,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},a){return ye(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Do,{query:t,...a})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}},zo=class extends ke{},Do=class extends ke{};Ja.FineTuningJobsPage=zo,Ja.FineTuningJobEventsPage=Do,Ja.Checkpoints=Mo,Ja.FineTuningJobCheckpointsPage=Uo;var ra=class extends W{constructor(){super(...arguments),this.methods=new Cd(this._client),this.jobs=new Ja(this._client),this.checkpoints=new gi(this._client),this.alpha=new No(this._client)}};ra.Methods=Cd,ra.Jobs=Ja,ra.FineTuningJobsPage=zo,ra.FineTuningJobEventsPage=Do,ra.Checkpoints=gi,ra.Alpha=No;var Md=class extends W{},Fo=class extends W{constructor(){super(...arguments),this.graderModels=new Md(this._client)}};Fo.GraderModels=Md;var Ud=class extends W{createVariation(e,t){return this._client.post("/images/variations",ga({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",ga({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}},Bo=class extends W{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Zo,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Zo=class extends Xn{};Bo.ModelsPage=Zo;var zd=class extends W{create(e,t){return this._client.post("/moderations",{body:e,...t})}};function Zb(e,t){return!t||!Hb(t)?{...e,output_parsed:null,output:e.output.map(a=>a.type==="function_call"?{...a,parsed_arguments:null}:a.type==="message"?{...a,content:a.content.map(r=>({...r,parsed:null}))}:a)}:Dd(e,t)}function Dd(e,t){let a=e.output.map(n=>{if(n.type==="function_call")return{...n,parsed_arguments:Wb(t,n)};if(n.type==="message"){let i=n.content.map(s=>s.type==="output_text"?{...s,parsed:qb(t,s.text)}:s);return{...n,content:i}}return n}),r=Object.assign({},e,{output:a});return Object.getOwnPropertyDescriptor(e,"output_text")||Fd(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(let n of r.output)if(n.type==="message"){for(let i of n.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function qb(e,t){return e.text?.format?.type!=="json_schema"?null:"$parseRaw"in e.text?.format?(e.text?.format).$parseRaw(t):JSON.parse(t)}function Hb(e){return!!oo(e.text?.format)}function Jb(e){return e?.$brand==="auto-parseable-tool"}function Gb(e,t){return e.find(a=>a.type==="function"&&a.name===t)}function Wb(e,t){let a=Gb(e.tools??[],t.name);return{...t,...t,parsed_arguments:Jb(a)?a.$parseRaw(t.arguments):a?.strict?JSON.parse(t.arguments):null}}function Fd(e){let t=[];for(let a of e.output)if(a.type==="message")for(let r of a.content)r.type==="output_text"&&t.push(r.text);e.output_text=t.join("")}var Bd=class extends W{list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Xb,{query:t,...a})}},Ga=function(e,t,a,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,a):n?n.value=a:t.set(e,a),a},na=function(e,t,a,r){if(a==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return a==="m"?r:a==="a"?r.call(e):r?r.value:t.get(e)},Wa,yi,ia,_i,Zd,qd,Hd,Jd,Kb=class Wh extends ro{constructor(t){super(),Wa.add(this),yi.set(this,void 0),ia.set(this,void 0),_i.set(this,void 0),Ga(this,yi,t,"f")}static createResponse(t,a,r){let n=new Wh(a);return n._run(()=>n._createOrRetrieveResponse(t,a,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(t,a,r){let n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),na(this,Wa,"m",Zd).call(this);let i,s=null;"response_id"in a?(i=await t.responses.retrieve(a.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),s=a.starting_after??null):i=await t.responses.create({...a,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(let o of i)na(this,Wa,"m",qd).call(this,o,s);if(i.controller.signal?.aborted)throw new Ve;return na(this,Wa,"m",Hd).call(this)}[(yi=new WeakMap,ia=new WeakMap,_i=new WeakMap,Wa=new WeakSet,Zd=function(){this.ended||Ga(this,ia,void 0,"f")},qd=function(t,a){if(this.ended)return;let r=(i,s)=>{(a==null||s.sequence_number>a)&&this._emit(i,s)},n=na(this,Wa,"m",Jd).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{let i=n.output[t.output_index];if(!i)throw new J(`missing output at index ${t.output_index}`);if(i.type==="message"){let s=i.content[t.content_index];if(!s)throw new J(`missing content at index ${t.content_index}`);if(s.type!=="output_text")throw new J(`expected content to be 'output_text', got ${s.type}`);r("response.output_text.delta",{...t,snapshot:s.text})}break}case"response.function_call_arguments.delta":{let i=n.output[t.output_index];if(!i)throw new J(`missing output at index ${t.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:i.arguments});break}default:r(t.type,t);break}},Hd=function(){if(this.ended)throw new J("stream has ended, this shouldn't happen");let t=na(this,ia,"f");if(!t)throw new J("request ended without sending any events");Ga(this,ia,void 0,"f");let a=Vb(t,na(this,yi,"f"));return Ga(this,_i,a,"f"),a},Jd=function(t){let a=na(this,ia,"f");if(!a){if(t.type!=="response.created")throw new J(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return a=Ga(this,ia,t.response,"f"),a}switch(t.type){case"response.output_item.added":{a.output.push(t.item);break}case"response.content_part.added":{let r=a.output[t.output_index];if(!r)throw new J(`missing output at index ${t.output_index}`);r.type==="message"&&r.content.push(t.part);break}case"response.output_text.delta":{let r=a.output[t.output_index];if(!r)throw new J(`missing output at index ${t.output_index}`);if(r.type==="message"){let n=r.content[t.content_index];if(!n)throw new J(`missing content at index ${t.content_index}`);if(n.type!=="output_text")throw new J(`expected content to be 'output_text', got ${n.type}`);n.text+=t.delta}break}case"response.function_call_arguments.delta":{let r=a.output[t.output_index];if(!r)throw new J(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.completed":{Ga(this,ia,t.response,"f");break}}return a},Symbol.asyncIterator)](){let t=[],a=[],r=!1;return this.on("event",n=>{let i=a.shift();i?i.resolve(n):t.push(n)}),this.on("end",()=>{r=!0;for(let n of a)n.resolve(void 0);a.length=0}),this.on("abort",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),this.on("error",n=>{r=!0;for(let i of a)i.reject(n);a.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((n,i)=>a.push({resolve:n,reject:i})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let t=na(this,_i,"f");if(!t)throw new J("stream ended without producing a ChatCompletion");return t}};function Vb(e,t){return Zb(e,t)}var qo=class extends W{constructor(){super(...arguments),this.inputItems=new Bd(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(a=>("object"in a&&a.object==="response"&&Fd(a),a))}retrieve(e,t={},a){return this._client.get(`/responses/${e}`,{query:t,...a,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(a=>Dd(a,e))}stream(e,t){return Kb.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}},Xb=class extends ke{};qo.InputItems=Bd;var Gd=class extends W{create(e,t,a){return this._client.post(`/uploads/${e}/parts`,ga({body:t,...a}))}},Ho=class extends W{constructor(){super(...arguments),this.parts=new Gd(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,a){return this._client.post(`/uploads/${e}/complete`,{body:t,...a})}};Ho.Parts=Gd;var Yb=async e=>{let t=await Promise.allSettled(e),a=t.filter(n=>n.status==="rejected");if(a.length){for(let n of a)console.error(n.reason);throw new Error(`${a.length} promise(s) failed - see the above errors`)}let r=[];for(let n of t)n.status==="fulfilled"&&r.push(n.value);return r},bi=class extends W{create(e,t,a){return this._client.post(`/vector_stores/${e}/files`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/vector_stores/${e}/files/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}update(e,t,a,r){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},a){return ye(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,vi,{query:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}del(e,t,a){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t,a);return await this.poll(e,r.id,a)}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let n=await this.retrieve(e,t,{...a,headers:r}).withResponse(),i=n.data;switch(i.status){case"in_progress":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=n.response.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await Tr(s);break;case"failed":case"completed":return i}}}async upload(e,t,a){let r=await this._client.files.create({file:t,purpose:"assistants"},a);return this.create(e,{file_id:r.id},a)}async uploadAndPoll(e,t,a){let r=await this.upload(e,t,a);return await this.poll(e,r.id,a)}content(e,t,a){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Jo,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},vi=class extends ke{},Jo=class extends Xn{};bi.VectorStoreFilesPage=vi,bi.FileContentResponsesPage=Jo;var Wd=class extends W{create(e,t,a){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}retrieve(e,t,a){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}cancel(e,t,a){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}async createAndPoll(e,t,a){let r=await this.create(e,t);return await this.poll(e,r.id,a)}listFiles(e,t,a={},r){return ye(a)?this.listFiles(e,t,{},a):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,vi,{query:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,a){let r={...a?.headers,"X-Stainless-Poll-Helper":"true"};for(a?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=a.pollIntervalMs.toString());;){let{data:n,response:i}=await this.retrieve(e,t,{...a,headers:r}).withResponse();switch(n.status){case"in_progress":let s=5e3;if(a?.pollIntervalMs)s=a.pollIntervalMs;else{let o=i.headers.get("openai-poll-after-ms");if(o){let l=parseInt(o);isNaN(l)||(s=l)}}await Tr(s);break;case"failed":case"cancelled":case"completed":return n}}}async uploadAndPoll(e,{files:t,fileIds:a=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let n=r?.maxConcurrency??5,i=Math.min(n,t.length),s=this._client,o=t.values(),l=[...a];async function u(d){for(let h of d){let p=await s.files.create({file:h,purpose:"assistants"},r);l.push(p.id)}}let c=Array(i).fill(o).map(u);return await Yb(c),await this.createAndPoll(e,{file_ids:l})}},sa=class extends W{constructor(){super(...arguments),this.files=new bi(this._client),this.fileBatches=new Wd(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,a){return this._client.post(`/vector_stores/${e}`,{body:t,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e={},t){return ye(e)?this.list({},e):this._client.getAPIList("/vector_stores",Go,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,a){return this._client.getAPIList(`/vector_stores/${e}/search`,Wo,{body:t,method:"post",...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}},Go=class extends ke{},Wo=class extends Xn{};sa.VectorStoresPage=Go,sa.VectorStoreSearchResponsesPage=Wo,sa.Files=bi,sa.VectorStoreFilesPage=vi,sa.FileContentResponsesPage=Jo,sa.FileBatches=Wd;var Kd,Q=class extends yb{constructor({baseURL:e=Kn("OPENAI_BASE_URL"),apiKey:t=Kn("OPENAI_API_KEY"),organization:a=Kn("OPENAI_ORG_ID")??null,project:r=Kn("OPENAI_PROJECT_ID")??null,...n}={}){if(t===void 0)throw new J("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let i={apiKey:t,organization:a,project:r,...n,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Ib())throw new J(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new jd(this),this.chat=new ei(this),this.embeddings=new Nd(this),this.files=new jo(this),this.images=new Ud(this),this.audio=new jr(this),this.moderations=new zd(this),this.models=new Bo(this),this.fineTuning=new ra(this),this.graders=new Fo(this),this.vectorStores=new sa(this),this.beta=new Ha(this),this.batches=new eo(this),this.uploads=new Ho(this),this.responses=new qo(this),this.evals=new qr(this),this.containers=new Br(this),this._options=i,this.apiKey=t,this.organization=a,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return K_(e,{arrayFormat:"brackets"})}};Kd=Q,Q.OpenAI=Kd,Q.DEFAULT_TIMEOUT=6e5,Q.OpenAIError=J,Q.APIError=Je,Q.APIConnectionError=Zn,Q.APIConnectionTimeoutError=qn,Q.APIUserAbortError=Ve,Q.NotFoundError=Cc,Q.ConflictError=Lc,Q.RateLimitError=Uc,Q.BadRequestError=jc,Q.AuthenticationError=Rc,Q.InternalServerError=zc,Q.PermissionDeniedError=Nc,Q.UnprocessableEntityError=Mc,Q.toFile=Hc,Q.fileFromPath=Pc,Q.Completions=jd,Q.Chat=ei,Q.ChatCompletionsPage=Qn,Q.Embeddings=Nd,Q.Files=jo,Q.FileObjectsPage=Ro,Q.Images=Ud,Q.Audio=jr,Q.Moderations=zd,Q.Models=Bo,Q.ModelsPage=Zo,Q.FineTuning=ra,Q.Graders=Fo,Q.VectorStores=sa,Q.VectorStoresPage=Go,Q.VectorStoreSearchResponsesPage=Wo,Q.Beta=Ha,Q.Batches=eo,Q.BatchesPage=to,Q.Uploads=Ho,Q.Responses=qo,Q.Evals=qr,Q.EvalListResponsesPage=To,Q.Containers=Br,Q.ContainerListResponsesPage=Io;var Qb=typeof window=="object"?window:{},re="0123456789abcdef".split(""),ev=[-2147483648,8388608,32768,128],ft=[24,16,8,0],Pe=[];function mt(e){e?(Pe[0]=Pe[16]=Pe[1]=Pe[2]=Pe[3]=Pe[4]=Pe[5]=Pe[6]=Pe[7]=Pe[8]=Pe[9]=Pe[10]=Pe[11]=Pe[12]=Pe[13]=Pe[14]=Pe[15]=0,this.blocks=Pe):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}mt.prototype.update=function(e){if(!this.finalized){var t=typeof e!="string";t&&e.constructor===Qb.ArrayBuffer&&(e=new Uint8Array(e));for(var a,r=0,n,i=e.length||0,s=this.blocks;r<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(n=this.start;r<i&&n<64;++r)s[n>>2]|=e[r]<<ft[n++&3];else for(n=this.start;r<i&&n<64;++r)a=e.charCodeAt(r),a<128?s[n>>2]|=a<<ft[n++&3]:a<2048?(s[n>>2]|=(192|a>>6)<<ft[n++&3],s[n>>2]|=(128|a&63)<<ft[n++&3]):a<55296||a>=57344?(s[n>>2]|=(224|a>>12)<<ft[n++&3],s[n>>2]|=(128|a>>6&63)<<ft[n++&3],s[n>>2]|=(128|a&63)<<ft[n++&3]):(a=65536+((a&1023)<<10|e.charCodeAt(++r)&1023),s[n>>2]|=(240|a>>18)<<ft[n++&3],s[n>>2]|=(128|a>>12&63)<<ft[n++&3],s[n>>2]|=(128|a>>6&63)<<ft[n++&3],s[n>>2]|=(128|a&63)<<ft[n++&3]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=s[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},mt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=ev[t&3],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},mt.prototype.hash=function(){var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4,i,s,o,l=this.blocks;for(s=16;s<80;++s)o=l[s-3]^l[s-8]^l[s-14]^l[s-16],l[s]=o<<1|o>>>31;for(s=0;s<20;s+=5)i=t&a|~t&r,o=e<<5|e>>>27,n=o+i+n+1518500249+l[s]<<0,t=t<<30|t>>>2,i=e&t|~e&a,o=n<<5|n>>>27,r=o+i+r+1518500249+l[s+1]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=r<<5|r>>>27,a=o+i+a+1518500249+l[s+2]<<0,n=n<<30|n>>>2,i=r&n|~r&e,o=a<<5|a>>>27,t=o+i+t+1518500249+l[s+3]<<0,r=r<<30|r>>>2,i=a&r|~a&n,o=t<<5|t>>>27,e=o+i+e+1518500249+l[s+4]<<0,a=a<<30|a>>>2;for(;s<40;s+=5)i=t^a^r,o=e<<5|e>>>27,n=o+i+n+1859775393+l[s]<<0,t=t<<30|t>>>2,i=e^t^a,o=n<<5|n>>>27,r=o+i+r+1859775393+l[s+1]<<0,e=e<<30|e>>>2,i=n^e^t,o=r<<5|r>>>27,a=o+i+a+1859775393+l[s+2]<<0,n=n<<30|n>>>2,i=r^n^e,o=a<<5|a>>>27,t=o+i+t+1859775393+l[s+3]<<0,r=r<<30|r>>>2,i=a^r^n,o=t<<5|t>>>27,e=o+i+e+1859775393+l[s+4]<<0,a=a<<30|a>>>2;for(;s<60;s+=5)i=t&a|t&r|a&r,o=e<<5|e>>>27,n=o+i+n-1894007588+l[s]<<0,t=t<<30|t>>>2,i=e&t|e&a|t&a,o=n<<5|n>>>27,r=o+i+r-1894007588+l[s+1]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=r<<5|r>>>27,a=o+i+a-1894007588+l[s+2]<<0,n=n<<30|n>>>2,i=r&n|r&e|n&e,o=a<<5|a>>>27,t=o+i+t-1894007588+l[s+3]<<0,r=r<<30|r>>>2,i=a&r|a&n|r&n,o=t<<5|t>>>27,e=o+i+e-1894007588+l[s+4]<<0,a=a<<30|a>>>2;for(;s<80;s+=5)i=t^a^r,o=e<<5|e>>>27,n=o+i+n-899497514+l[s]<<0,t=t<<30|t>>>2,i=e^t^a,o=n<<5|n>>>27,r=o+i+r-899497514+l[s+1]<<0,e=e<<30|e>>>2,i=n^e^t,o=r<<5|r>>>27,a=o+i+a-899497514+l[s+2]<<0,n=n<<30|n>>>2,i=r^n^e,o=a<<5|a>>>27,t=o+i+t-899497514+l[s+3]<<0,r=r<<30|r>>>2,i=a^r^n,o=t<<5|t>>>27,e=o+i+e-899497514+l[s+4]<<0,a=a<<30|a>>>2;this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+a<<0,this.h3=this.h3+r<<0,this.h4=this.h4+n<<0},mt.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4;return re[e>>28&15]+re[e>>24&15]+re[e>>20&15]+re[e>>16&15]+re[e>>12&15]+re[e>>8&15]+re[e>>4&15]+re[e&15]+re[t>>28&15]+re[t>>24&15]+re[t>>20&15]+re[t>>16&15]+re[t>>12&15]+re[t>>8&15]+re[t>>4&15]+re[t&15]+re[a>>28&15]+re[a>>24&15]+re[a>>20&15]+re[a>>16&15]+re[a>>12&15]+re[a>>8&15]+re[a>>4&15]+re[a&15]+re[r>>28&15]+re[r>>24&15]+re[r>>20&15]+re[r>>16&15]+re[r>>12&15]+re[r>>8&15]+re[r>>4&15]+re[r&15]+re[n>>28&15]+re[n>>24&15]+re[n>>20&15]+re[n>>16&15]+re[n>>12&15]+re[n>>8&15]+re[n>>4&15]+re[n&15]},mt.prototype.toString=mt.prototype.hex,mt.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4;return[e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,a>>24&255,a>>16&255,a>>8&255,a&255,r>>24&255,r>>16&255,r>>8&255,r&255,n>>24&255,n>>16&255,n>>8&255,n&255]},mt.prototype.array=mt.prototype.digest,mt.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var Vd=!1,tv=e=>(Vd||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","\u2514> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join(`
`)),Vd=!0),new mt(!0).update(e).hex()),N="0123456789abcdef".split(""),av=[-2147483648,8388608,32768,128],gt=[24,16,8,0],wi=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],$e=[];function $t(e,t){t?($e[0]=$e[16]=$e[1]=$e[2]=$e[3]=$e[4]=$e[5]=$e[6]=$e[7]=$e[8]=$e[9]=$e[10]=$e[11]=$e[12]=$e[13]=$e[14]=$e[15]=0,this.blocks=$e):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}$t.prototype.update=function(e){if(!this.finalized){var t,a=typeof e;if(a!=="string"){if(a==="object"){if(e===null)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(e)))throw new Error(ERROR)}else throw new Error(ERROR);t=!0}for(var r,n=0,i,s=e.length,o=this.blocks;n<s;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(i=this.start;n<s&&i<64;++n)o[i>>>2]|=e[n]<<gt[i++&3];else for(i=this.start;n<s&&i<64;++n)r=e.charCodeAt(n),r<128?o[i>>>2]|=r<<gt[i++&3]:r<2048?(o[i>>>2]|=(192|r>>>6)<<gt[i++&3],o[i>>>2]|=(128|r&63)<<gt[i++&3]):r<55296||r>=57344?(o[i>>>2]|=(224|r>>>12)<<gt[i++&3],o[i>>>2]|=(128|r>>>6&63)<<gt[i++&3],o[i>>>2]|=(128|r&63)<<gt[i++&3]):(r=65536+((r&1023)<<10|e.charCodeAt(++n)&1023),o[i>>>2]|=(240|r>>>18)<<gt[i++&3],o[i>>>2]|=(128|r>>>12&63)<<gt[i++&3],o[i>>>2]|=(128|r>>>6&63)<<gt[i++&3],o[i>>>2]|=(128|r&63)<<gt[i++&3]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},$t.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=av[t&3],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},$t.prototype.hash=function(){var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4,i=this.h5,s=this.h6,o=this.h7,l=this.blocks,u,c,d,h,p,f,m,g,_,y,b;for(u=16;u<64;++u)p=l[u-15],c=(p>>>7|p<<25)^(p>>>18|p<<14)^p>>>3,p=l[u-2],d=(p>>>17|p<<15)^(p>>>19|p<<13)^p>>>10,l[u]=l[u-16]+c+l[u-7]+d<<0;for(b=t&a,u=0;u<64;u+=4)this.first?(this.is224?(g=300032,p=l[0]-1413257819,o=p-150054599<<0,r=p+24177077<<0):(g=704751109,p=l[0]-210244248,o=p-1521486534<<0,r=p+143694565<<0),this.first=!1):(c=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),d=(n>>>6|n<<26)^(n>>>11|n<<21)^(n>>>25|n<<7),g=e&t,h=g^e&a^b,m=n&i^~n&s,p=o+d+m+wi[u]+l[u],f=c+h,o=r+p<<0,r=p+f<<0),c=(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),d=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),_=r&e,h=_^r&t^g,m=s&o^~s&n,p=i+d+m+wi[u+1]+l[u+1],f=c+h,s=a+p<<0,a=p+f<<0,c=(a>>>2|a<<30)^(a>>>13|a<<19)^(a>>>22|a<<10),d=(s>>>6|s<<26)^(s>>>11|s<<21)^(s>>>25|s<<7),y=a&r,h=y^a&e^_,m=i&s^~i&o,p=n+d+m+wi[u+2]+l[u+2],f=c+h,i=t+p<<0,t=p+f<<0,c=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),d=(i>>>6|i<<26)^(i>>>11|i<<21)^(i>>>25|i<<7),b=t&a,h=b^t&r^y,m=i&s^~i&o,p=n+d+m+wi[u+3]+l[u+3],f=c+h,n=e+p<<0,e=p+f<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+a<<0,this.h3=this.h3+r<<0,this.h4=this.h4+n<<0,this.h5=this.h5+i<<0,this.h6=this.h6+s<<0,this.h7=this.h7+o<<0},$t.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4,i=this.h5,s=this.h6,o=this.h7,l=N[e>>>28&15]+N[e>>>24&15]+N[e>>>20&15]+N[e>>>16&15]+N[e>>>12&15]+N[e>>>8&15]+N[e>>>4&15]+N[e&15]+N[t>>>28&15]+N[t>>>24&15]+N[t>>>20&15]+N[t>>>16&15]+N[t>>>12&15]+N[t>>>8&15]+N[t>>>4&15]+N[t&15]+N[a>>>28&15]+N[a>>>24&15]+N[a>>>20&15]+N[a>>>16&15]+N[a>>>12&15]+N[a>>>8&15]+N[a>>>4&15]+N[a&15]+N[r>>>28&15]+N[r>>>24&15]+N[r>>>20&15]+N[r>>>16&15]+N[r>>>12&15]+N[r>>>8&15]+N[r>>>4&15]+N[r&15]+N[n>>>28&15]+N[n>>>24&15]+N[n>>>20&15]+N[n>>>16&15]+N[n>>>12&15]+N[n>>>8&15]+N[n>>>4&15]+N[n&15]+N[i>>>28&15]+N[i>>>24&15]+N[i>>>20&15]+N[i>>>16&15]+N[i>>>12&15]+N[i>>>8&15]+N[i>>>4&15]+N[i&15]+N[s>>>28&15]+N[s>>>24&15]+N[s>>>20&15]+N[s>>>16&15]+N[s>>>12&15]+N[s>>>8&15]+N[s>>>4&15]+N[s&15];return this.is224||(l+=N[o>>>28&15]+N[o>>>24&15]+N[o>>>20&15]+N[o>>>16&15]+N[o>>>12&15]+N[o>>>8&15]+N[o>>>4&15]+N[o&15]),l},$t.prototype.toString=$t.prototype.hex,$t.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,a=this.h2,r=this.h3,n=this.h4,i=this.h5,s=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,e&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255,a>>>24&255,a>>>16&255,a>>>8&255,a&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255,i>>>24&255,i>>>16&255,i>>>8&255,i&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,o&255),l},$t.prototype.array=$t.prototype.digest,$t.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e};var rv=(...e)=>tv(e.join("_")),nv=class{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:rv})}makeDefaultKeyEncoder(e){this.keyEncoder=e}},iv=new Map,sv=class Kh extends nv{constructor(t){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=t??new Map}lookup(t,a){return Promise.resolve(this.cache.get(this.keyEncoder(t,a))??null)}async update(t,a,r){this.cache.set(this.keyEncoder(t,a),r)}static global(){return new Kh(iv)}},Xd=class extends Va{},ov=class extends Xd{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Qa(this.value)]}},lv=class extends Xd{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Al(this.messages)}toChatMessages(){return this.messages}},uv=rt(zp(),1),cv=Object.defineProperty,dv=(e,t,a)=>t in e?cv(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,hv=(e,t,a)=>(dv(e,typeof t!="symbol"?t+"":t,a),a);function pv(e,t){let a=Array.from({length:e.length},(r,n)=>({start:n,end:n+1}));for(;a.length>1;){let r=null;for(let n=0;n<a.length-1;n++){let i=e.slice(a[n].start,a[n+1].end),s=t.get(i.join(","));s!=null&&(r==null||s<r[0])&&(r=[s,n])}if(r!=null){let n=r[1];a[n]={start:a[n].start,end:a[n+1].end},a.splice(n+1,1)}else break}return a}function fv(e,t){return e.length===1?[t.get(e.join(","))]:pv(e,t).map(a=>t.get(e.slice(a.start,a.end).join(","))).filter(a=>a!=null)}function mv(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Ko=class{constructor(e,t){oa(this,"specialTokens"),oa(this,"inverseSpecialTokens"),oa(this,"patStr"),oa(this,"textEncoder",new TextEncoder),oa(this,"textDecoder",new TextDecoder("utf-8")),oa(this,"rankMap",new Map),oa(this,"textMap",new Map),this.patStr=e.pat_str;let a=e.bpe_ranks.split(`
`).filter(Boolean).reduce((r,n)=>{let[i,s,...o]=n.split(" "),l=Number.parseInt(s,10);return o.forEach((u,c)=>r[u]=l+c),r},{});for(let[r,n]of Object.entries(a)){let i=uv.default.toByteArray(r);this.rankMap.set(i.join(","),n),this.textMap.set(n,i)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[n,i])=>(r[i]=this.textEncoder.encode(n),r),{})}encode(e,t=[],a="all"){let r=new RegExp(this.patStr,"ug"),n=Ko.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set(t==="all"?Object.keys(this.specialTokens):t),o=new Set(a==="all"?Object.keys(this.specialTokens).filter(u=>!s.has(u)):a);if(o.size>0){let u=Ko.specialTokenRegex([...o]),c=e.match(u);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let l=0;for(;;){let u=null,c=l;for(;n.lastIndex=c,u=n.exec(e),!(u==null||s.has(u[0]));)c=u.index+1;let d=u?.index??e.length;for(let p of e.substring(l,d).matchAll(r)){let f=this.textEncoder.encode(p[0]),m=this.rankMap.get(f.join(","));if(m!=null){i.push(m);continue}i.push(...fv(f,this.rankMap))}if(u==null)break;let h=this.specialTokens[u[0]];i.push(h),l=u.index+u[0].length}return i}decode(e){let t=[],a=0;for(let i=0;i<e.length;++i){let s=e[i],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(t.push(o),a+=o.length)}let r=new Uint8Array(a),n=0;for(let i of t)r.set(i,n),n+=i.length;return this.textDecoder.decode(r)}},Yd=Ko;hv(Yd,"specialTokenRegex",e=>new RegExp(e.map(t=>mv(t)).join("|"),"g"));function gv(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}var Oi={},yv=new Rs({});async function _v(e){return e in Oi||(Oi[e]=yv.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(t=>t.json()).then(t=>new Yd(t)).catch(t=>{throw delete Oi[e],t})),await Oi[e]}async function bv(e){return _v(gv(e))}var vv=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e;function wv(e){return typeof e!="object"||!e?!1:!!("type"in e&&e.type==="function"&&"function"in e&&typeof e.function=="object"&&e.function&&"name"in e.function&&"parameters"in e.function)}var Ov=()=>!1,Qd=class extends Ie{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Ov(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},Ev=class extends Qd{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...a}){let{cache:r,...n}=a;super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r=="object"?this.cache=r:r?this.cache=sv.global():this.cache=void 0,this.caller=new Rs(a??{})}async getNumTokens(e){let t;typeof e=="string"?t=e:t=e.map(r=>typeof r=="string"?r:r.type==="text"&&"text"in r?r.text:"").join("");let a=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await bv("modelName"in this?vv(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{a=this._encoding.encode(t).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return a}static _convertInputToPromptValue(e){return typeof e=="string"?new ov(e):Array.isArray(e)?new lv(e.map(tr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let a={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(a).filter(([r,n])=>n!==void 0).map(([r,n])=>`${r}:${JSON.stringify(n)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}},Ei=class extends Ie{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let a=ce(t);return this.func&&await this.func(e,a),this._callWithConfig(r=>Promise.resolve(r),e,a)}async*transform(e,t){let a=ce(t),r,n=!0;for await(let i of this._transformStreamWithConfig(e,s=>s,a))if(yield i,n)if(r===void 0)r=i;else try{r=In(r,i)}catch{r=void 0,n=!1}this.func&&r!==void 0&&await this.func(r,a)}static assign(e){return new yc(new Bn({steps:e}))}};function Vo(e){let t=[];for(let a of e){let r=a;if(Array.isArray(a.content))for(let n=0;n<a.content.length;n++){let i=a.content[n];(qp(i)||Hp(i))&&r===a&&(r=new a.constructor({...r,content:[...a.content.slice(0,n),Jp(i),...a.content.slice(n+1)]}))}t.push(r)}return t}var kv=class Oa extends Ev{constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(t){let[a,r]=super._separateRunnableConfigFromCallOptions(t);return r.signal=a.signal,[a,r]}async invoke(t,a){let r=Oa._convertInputToPromptValue(t);return(await this.generatePrompt([r],a,a?.callbacks)).generations[0][0].message}async*_streamResponseChunks(t,a,r){throw new Error("Not implemented.")}async*_streamIterator(t,a){if(this._streamResponseChunks===Oa.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(t,a);else{let r=Oa._convertInputToPromptValue(t).toChatMessages(),[n,i]=this._separateRunnableConfigFromCallOptionsCompat(a),s={...n.metadata,...this.getLsParams(i)},o=await Et.configure(n.callbacks,this.callbacks,n.tags,this.tags,s,this.metadata,{verbose:this.verbose}),l={options:i,invocation_params:this?.invocationParams(i),batch_size:1},u=await o?.handleChatModelStart(this.toJSON(),[Vo(r)],n.runId,void 0,l,void 0,void 0,n.runName),c,d;try{for await(let h of this._streamResponseChunks(r,i,u?.[0])){if(h.message.id==null){let p=u?.at(0)?.runId;p!=null&&h.message._updateId(`run-${p}`)}h.message.response_metadata={...h.generationInfo,...h.message.response_metadata},yield h.message,c?c=c.concat(h):c=h,wl(h.message)&&h.message.usage_metadata!==void 0&&(d={tokenUsage:{promptTokens:h.message.usage_metadata.input_tokens,completionTokens:h.message.usage_metadata.output_tokens,totalTokens:h.message.usage_metadata.total_tokens}})}}catch(h){throw await Promise.all((u??[]).map(p=>p?.handleLLMError(h))),h}await Promise.all((u??[]).map(h=>h?.handleLLMEnd({generations:[[c]],llmOutput:d})))}}getLsParams(t){let a=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:t.stop,ls_provider:a}}async _generateUncached(t,a,r,n){let i=t.map(c=>c.map(tr)),s;if(n!==void 0&&n.length===i.length)s=n;else{let c={...r.metadata,...this.getLsParams(a)},d=await Et.configure(r.callbacks,this.callbacks,r.tags,this.tags,c,this.metadata,{verbose:this.verbose}),h={options:a,invocation_params:this?.invocationParams(a),batch_size:1};s=await d?.handleChatModelStart(this.toJSON(),i.map(Vo),r.runId,void 0,h,void 0,void 0,r.runName)}let o=[],l=[];if(s?.[0].handlers.find(yy)&&!this.disableStreaming&&i.length===1&&this._streamResponseChunks!==Oa.prototype._streamResponseChunks)try{let c=await this._streamResponseChunks(i[0],a,s?.[0]),d,h;for await(let p of c){if(p.message.id==null){let f=s?.at(0)?.runId;f!=null&&p.message._updateId(`run-${f}`)}d===void 0?d=p:d=In(d,p),wl(p.message)&&p.message.usage_metadata!==void 0&&(h={tokenUsage:{promptTokens:p.message.usage_metadata.input_tokens,completionTokens:p.message.usage_metadata.output_tokens,totalTokens:p.message.usage_metadata.total_tokens}})}if(d===void 0)throw new Error("Received empty response from chat model call.");o.push([d]),await s?.[0].handleLLMEnd({generations:o,llmOutput:h})}catch(c){throw await s?.[0].handleLLMError(c),c}else{let c=await Promise.allSettled(i.map((d,h)=>this._generate(d,{...a,promptIndex:h},s?.[h])));await Promise.all(c.map(async(d,h)=>{if(d.status==="fulfilled"){let p=d.value;for(let f of p.generations){if(f.message.id==null){let m=s?.at(0)?.runId;m!=null&&f.message._updateId(`run-${m}`)}f.message.response_metadata={...f.generationInfo,...f.message.response_metadata}}return p.generations.length===1&&(p.generations[0].message.response_metadata={...p.llmOutput,...p.generations[0].message.response_metadata}),o[h]=p.generations,l[h]=p.llmOutput,s?.[h]?.handleLLMEnd({generations:[p.generations],llmOutput:p.llmOutput})}else return await s?.[h]?.handleLLMError(d.reason),Promise.reject(d.reason)}))}let u={generations:o,llmOutput:l.length?this._combineLLMOutput?.(...l):void 0};return Object.defineProperty(u,Fu,{value:s?{runIds:s?.map(c=>c.runId)}:void 0,configurable:!0}),u}async _generateCached({messages:t,cache:a,llmStringKey:r,parsedOptions:n,handledOptions:i}){let s=t.map(m=>m.map(tr)),o={...i.metadata,...this.getLsParams(n)},l=await Et.configure(i.callbacks,this.callbacks,i.tags,this.tags,o,this.metadata,{verbose:this.verbose}),u={options:n,invocation_params:this?.invocationParams(n),batch_size:1},c=await l?.handleChatModelStart(this.toJSON(),s.map(Vo),i.runId,void 0,u,void 0,void 0,i.runName),d=[],h=(await Promise.allSettled(s.map(async(m,g)=>{let _=Oa._convertInputToPromptValue(m).toString(),y=await a.lookup(_,r);return y==null&&d.push(g),y}))).map((m,g)=>({result:m,runManager:c?.[g]})).filter(({result:m})=>m.status==="fulfilled"&&m.value!=null||m.status==="rejected"),p=[];await Promise.all(h.map(async({result:m,runManager:g},_)=>{if(m.status==="fulfilled"){let y=m.value;return p[_]=y.map(b=>("message"in b&&sn(b.message)&&ln(b.message)&&(b.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),b.generationInfo={...b.generationInfo,tokenUsage:{}},b)),y.length&&await g?.handleLLMNewToken(y[0].text),g?.handleLLMEnd({generations:[y]},void 0,void 0,void 0,{cached:!0})}else return await g?.handleLLMError(m.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(m.reason)}));let f={generations:p,missingPromptIndices:d,startedRunManagers:c};return Object.defineProperty(f,Fu,{value:c?{runIds:c?.map(m=>m.runId)}:void 0,configurable:!0}),f}async generate(t,a,r){let n;Array.isArray(a)?n={stop:a}:n=a;let i=t.map(f=>f.map(tr)),[s,o]=this._separateRunnableConfigFromCallOptionsCompat(n);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(i,o,s);let{cache:l}=this,u=this._getSerializedCacheKeyParametersForCall(o),{generations:c,missingPromptIndices:d,startedRunManagers:h}=await this._generateCached({messages:i,cache:l,llmStringKey:u,parsedOptions:o,handledOptions:s}),p={};if(d.length>0){let f=await this._generateUncached(d.map(m=>i[m]),o,s,h!==void 0?d.map(m=>h?.[m]):void 0);await Promise.all(f.generations.map(async(m,g)=>{let _=d[g];c[_]=m;let y=Oa._convertInputToPromptValue(i[_]).toString();return l.update(y,u,m)})),p=f.llmOutput??{}}return{generations:c,llmOutput:p}}invocationParams(t){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(t,a,r){let n=t.map(i=>i.toChatMessages());return this.generate(n,a,r)}async call(t,a,r){return(await this.generate([t.map(tr)],a,r)).generations[0][0].message}async callPrompt(t,a,r){let n=t.toChatMessages();return this.call(n,a,r)}async predictMessages(t,a,r){return this.call(t,a,r)}async predict(t,a,r){let n=new Qa(t),i=await this.call([n],a,r);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(t,a){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(a?.strict)throw new Error('"strict" mode is not supported for this model by default.');let r=t,n=a?.name,i=uc(r)??"A function available to call.",s=a?.method,o=a?.includeRaw;if(s==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let l=n??"extract",u;zn(r)?u=[{type:"function",function:{name:l,description:i,parameters:Dn(r)}}]:("name"in r&&(l=r.name),u=[{type:"function",function:{name:l,description:i,parameters:r}}]);let c=this.bindTools(u),d=Zs.from(m=>{if(!m.tool_calls||m.tool_calls.length===0)throw new Error("No tool calls found in the response.");let g=m.tool_calls.find(_=>_.name===l);if(!g)throw new Error(`No tool call found with name ${l}.`);return g.args});if(!o)return c.pipe(d).withConfig({runName:"StructuredOutput"});let h=Ei.assign({parsed:(m,g)=>d.invoke(m.raw,g)}),p=Ei.assign({parsed:()=>null}),f=h.withFallbacks({fallbacks:[p]});return Fn.from([{raw:c},f]).withConfig({runName:"StructuredOutputRunnable"})}},xv=class extends Ie{parseResultWithPrompt(e,t,a){return this.parseResult(e,a)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(a,r)=>this.parseResult([{text:a}],r?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(a,r)=>this.parseResult([{message:a,text:this._baseMessageToString(a)}],r?.callbacks),e,{...t,runType:"parser"})}},eh=class extends xv{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,a){return this.parse(e,a)}_type(){throw new Error("_type not implemented")}},Xo=class extends Error{constructor(e,t,a,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=a,this.sendToLLM=r,r&&(a===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");xl(this,"OUTPUT_PARSING_FAILURE")}},Av=class extends eh{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},th=class extends Av{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,a;for await(let r of e){if(typeof r!="string"&&typeof r.content!="string")throw new Error("Cannot handle non-string output.");let n;if(Xp(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");n=new Pn({message:r,text:r.content})}else if(sn(r)){if(typeof r.content!="string")throw new Error("Cannot handle non-string message output.");n=new Pn({message:sf(r),text:r.content})}else n=new Sn({text:r});a===void 0?a=n:a=a.concat(n);let i=await this.parsePartialResult([a]);i!=null&&!La(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}},ah=class extends eh{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=Lt.object(Object.fromEntries(Object.entries(e).map(([a,r])=>[a,Lt.string().describe(r)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Dn(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.trim(),a=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(r,n)=>`"${n.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await zs(this.schema,JSON.parse(a))}catch(t){throw new Xo(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},rh=class extends th{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?Fm(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return _l(e[0].text)}async parse(e){return _l(e,JSON.parse)}getFormatInstructions(){return""}};function nh(e,t){if(e.function===void 0)return;let a;if(t?.partial)try{a=Hi(e.function.arguments??"{}")}catch{return}else try{a=JSON.parse(e.function.arguments)}catch(n){throw new Xo([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${n.message}`].join(`
`))}let r={name:e.function.name,args:a,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function Iv(e){if(e.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function Sv(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}var Pv=class extends th{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let a=e[0].message,r;if(ln(a)&&a.tool_calls?.length?r=a.tool_calls.map(i=>{let{id:s,...o}=i;return this.returnId?{id:s,...o}:o}):a.additional_kwargs.tool_calls!==void 0&&(r=JSON.parse(JSON.stringify(a.additional_kwargs.tool_calls)).map(i=>nh(i,{returnId:this.returnId,partial:t}))),!r)return[];let n=[];for(let i of r)if(i!==void 0){let s={type:i.name,args:i.args,id:i.id};n.push(s)}return n}},ih=class extends Pv{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await A_(this.zodSchema,e);if(t.success)return t.data;throw new Xo(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(r=>r.type===this.keyName),a=t;if(t.length)return this.returnId||(a=t.map(r=>r.args)),this.returnSingle?a[0]:a}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(r=>r.type===this.keyName),a=t;return t.length?(this.returnId||(a=t.map(r=>r.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(r=>this._validateResult(r)))):void 0}},$v=Symbol("Let zodToJsonSchema decide on which parser to use"),sh={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Tv=e=>typeof e=="string"?{...sh,basePath:["#"],definitions:{},name:e}:{...sh,basePath:["#"],definitions:{},...e},Yo=e=>"_def"in e?e._def:e;function jv(e){if(!e)return!0;for(let t in e)return!1;return!0}var Rv=e=>{let t=Tv(e),a=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:a,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([r,n])=>[Yo(n),{def:Yo(n),path:[...t.basePath,t.definitionPath,r],jsonSchema:void 0}]))}};function oh(e,t,a,r){r?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function fe(e,t,a,r,n){e[t]=a,oh(e,t,r,n)}function Nv(){return{}}function Cv(e,t){let a={type:"array"};return e.type?._def?.typeName!==v.ZodAny&&(a.items=ue(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&fe(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&fe(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(fe(a,"minItems",e.exactLength.value,e.exactLength.message,t),fe(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}function Lv(e,t){let a={type:"integer",format:"int64"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"min":t.target==="jsonSchema7"?r.inclusive?fe(a,"minimum",r.value,r.message,t):fe(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),fe(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?fe(a,"maximum",r.value,r.message,t):fe(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),fe(a,"maximum",r.value,r.message,t));break;case"multipleOf":fe(a,"multipleOf",r.value,r.message,t);break}return a}function Mv(){return{type:"boolean"}}function Uv(e,t){return ue(e.type._def,t)}var zv=(e,t)=>ue(e.innerType._def,t);function lh(e,t,a){let r=a??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,i)=>lh(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Dv(e,t)}}var Dv=(e,t)=>{let a={type:"integer",format:"unix-time"};if(t.target==="openApi3")return a;for(let r of e.checks)switch(r.kind){case"min":fe(a,"minimum",r.value,r.message,t);break;case"max":fe(a,"maximum",r.value,r.message,t);break}return a};function Fv(e,t){return{...ue(e.innerType._def,t),default:e.defaultValue()}}function Bv(e,t,a){return t.effectStrategy==="input"?ue(e.schema._def,t,a):{}}function Zv(e){return{type:"string",enum:[...e.values]}}var qv=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function Hv(e,t){let a=[ue(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),ue(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(i=>!!i),r=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,n=[];return a.forEach(i=>{if(qv(i))n.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let s=i;if("additionalProperties"in i&&i.additionalProperties===!1){let{additionalProperties:o,...l}=i;s=l}else r=void 0;n.push(s)}}),n.length?{allOf:n,...r}:void 0}function Jv(e,t){let a=typeof e.value;return a!=="bigint"&&a!=="number"&&a!=="boolean"&&a!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:a==="bigint"?"integer":a,enum:[e.value]}:{type:a==="bigint"?"integer":a,const:e.value}}var Qo,ba={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Qo===void 0&&(Qo=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Qo),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function uh(e,t){let a={type:"string"};function r(n){return t.patternStrategy==="escape"?Gv(n):n}if(e.checks)for(let n of e.checks)switch(n.kind){case"min":fe(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,n.value):n.value,n.message,t);break;case"max":fe(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":yt(a,"email",n.message,t);break;case"format:idn-email":yt(a,"idn-email",n.message,t);break;case"pattern:zod":_t(a,ba.email,n.message,t);break}break;case"url":yt(a,"uri",n.message,t);break;case"uuid":yt(a,"uuid",n.message,t);break;case"regex":_t(a,n.regex,n.message,t);break;case"cuid":_t(a,ba.cuid,n.message,t);break;case"cuid2":_t(a,ba.cuid2,n.message,t);break;case"startsWith":_t(a,RegExp(`^${r(n.value)}`),n.message,t);break;case"endsWith":_t(a,RegExp(`${r(n.value)}$`),n.message,t);break;case"datetime":yt(a,"date-time",n.message,t);break;case"date":yt(a,"date",n.message,t);break;case"time":yt(a,"time",n.message,t);break;case"duration":yt(a,"duration",n.message,t);break;case"length":fe(a,"minLength",typeof a.minLength=="number"?Math.max(a.minLength,n.value):n.value,n.message,t),fe(a,"maxLength",typeof a.maxLength=="number"?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"includes":{_t(a,RegExp(r(n.value)),n.message,t);break}case"ip":{n.version!=="v6"&&yt(a,"ipv4",n.message,t),n.version!=="v4"&&yt(a,"ipv6",n.message,t);break}case"emoji":_t(a,ba.emoji,n.message,t);break;case"ulid":{_t(a,ba.ulid,n.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{yt(a,"binary",n.message,t);break}case"contentEncoding:base64":{fe(a,"contentEncoding","base64",n.message,t);break}case"pattern:zod":{_t(a,ba.base64,n.message,t);break}}break}case"nanoid":_t(a,ba.nanoid,n.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return a}var Gv=e=>Array.from(e).map(t=>/[a-zA-Z0-9]/.test(t)?t:`\\${t}`).join(""),yt=(e,t,a,r)=>{e.format||e.anyOf?.some(n=>n.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&r.errorMessages&&{errorMessage:{format:a}}})):fe(e,"format",t,a,r)},_t=(e,t,a,r)=>{e.pattern||e.allOf?.some(n=>n.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:ch(t,r),...a&&r.errorMessages&&{errorMessage:{pattern:a}}})):fe(e,"pattern",ch(t,r),a,r)},ch=(e,t)=>{let a=typeof e=="function"?e():e;if(!t.applyRegexFlags||!a.flags)return a.source;let r={i:a.flags.includes("i"),m:a.flags.includes("m"),s:a.flags.includes("s")},n=r.i?a.source.toLowerCase():a.source,i="",s=!1,o=!1,l=!1;for(let u=0;u<n.length;u++){if(s){i+=n[u],s=!1;continue}if(r.i){if(o){if(n[u].match(/[a-z]/)){l?(i+=n[u],i+=`${n[u-2]}-${n[u]}`.toUpperCase(),l=!1):n[u+1]==="-"&&n[u+2]?.match(/[a-z]/)?(i+=n[u],l=!0):i+=`${n[u]}${n[u].toUpperCase()}`;continue}}else if(n[u].match(/[a-z]/)){i+=`[${n[u]}${n[u].toUpperCase()}]`;continue}}if(r.m){if(n[u]==="^"){i+=`(^|(?<=[\r
]))`;continue}else if(n[u]==="$"){i+=`($|(?=[\r
]))`;continue}}if(r.s&&n[u]==="."){i+=o?`${n[u]}\r
`:`[${n[u]}\r
]`;continue}i+=n[u],n[u]==="\\"?s=!0:o&&n[u]==="]"?o=!1:!o&&n[u]==="["&&(o=!0)}try{let u=new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),a.source}return i};function dh(e,t){if(t.target==="openApi3"&&e.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:ue(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??{}}),{}),additionalProperties:!1};let a={type:"object",additionalProperties:ue(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if(t.target==="openApi3")return a;if(e.keyType?._def.typeName===v.ZodString&&e.keyType._def.checks?.length){let r=Object.entries(uh(e.keyType._def,t)).reduce((n,[i,s])=>i==="type"?n:{...n,[i]:s},{});return{...a,propertyNames:r}}else if(e.keyType?._def.typeName===v.ZodEnum)return{...a,propertyNames:{enum:e.keyType._def.values}};return a}function Wv(e,t){if(t.mapStrategy==="record")return dh(e,t);let a=ue(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},r=ue(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[a,r],minItems:2,maxItems:2}}}function Kv(e){let t=e.values,a=Object.keys(e.values).filter(n=>typeof t[t[n]]!="number").map(n=>t[n]),r=Array.from(new Set(a.map(n=>typeof n)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:a}}function Vv(){return{not:{}}}function Xv(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var ki={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Yv(e,t){if(t.target==="openApi3")return hh(e,t);let a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every(r=>r._def.typeName in ki&&(!r._def.checks||!r._def.checks.length))){let r=a.reduce((n,i)=>{let s=ki[i._def.typeName];return s&&!n.includes(s)?[...n,s]:n},[]);return{type:r.length>1?r:r[0]}}else if(a.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=a.reduce((n,i)=>{let s=typeof i._def.value;switch(s){case"string":case"number":case"boolean":return[...n,s];case"bigint":return[...n,"integer"];case"object":if(i._def.value===null)return[...n,"null"];case"symbol":case"undefined":case"function":default:return n}},[]);if(r.length===a.length){let n=r.filter((i,s,o)=>o.indexOf(i)===s);return{type:n.length>1?n:n[0],enum:a.reduce((i,s)=>i.includes(s._def.value)?i:[...i,s._def.value],[])}}}else if(a.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:a.reduce((r,n)=>[...r,...n._def.values.filter(i=>!r.includes(i))],[])};return hh(e,t)}var hh=(e,t)=>{let a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((r,n)=>ue(r._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(r=>!!r&&(!t.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return a.length?{anyOf:a}:void 0};function Qv(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"||t.nullableStrategy==="property"?{type:ki[e.innerType._def.typeName],nullable:!0}:{type:[ki[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){let r=ue(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let a=ue(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}function ew(e,t){let a={type:"number"};if(!e.checks)return a;for(let r of e.checks)switch(r.kind){case"int":a.type="integer",oh(a,"type",r.message,t);break;case"min":t.target==="jsonSchema7"?r.inclusive?fe(a,"minimum",r.value,r.message,t):fe(a,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(a.exclusiveMinimum=!0),fe(a,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?fe(a,"maximum",r.value,r.message,t):fe(a,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(a.exclusiveMaximum=!0),fe(a,"maximum",r.value,r.message,t));break;case"multipleOf":fe(a,"multipleOf",r.value,r.message,t);break}return a}function tw(e,t){return t.removeAdditionalStrategy==="strict"?e.catchall._def.typeName==="ZodNever"?e.unknownKeys!=="strict":ue(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:e.catchall._def.typeName==="ZodNever"?e.unknownKeys==="passthrough":ue(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function aw(e,t){let a={type:"object",...Object.entries(e.shape()).reduce((r,[n,i])=>{if(i===void 0||i._def===void 0)return r;let s=[...t.currentPath,"properties",n],o=ue(i._def,{...t,currentPath:s,propertyPath:s});return o===void 0?r:(t.openaiStrictMode&&i.isOptional()&&!i.isNullable()&&console.warn(`Zod field at \`${s.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...r.properties,[n]:o},required:i.isOptional()&&!t.openaiStrictMode?r.required:[...r.required,n]})},{properties:{},required:[]}),additionalProperties:tw(e,t)};return a.required.length||delete a.required,a}var rw=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return ue(e.innerType._def,t);let a=ue(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:{}},a]}:{}},nw=(e,t)=>{if(t.pipeStrategy==="input")return ue(e.in._def,t);if(t.pipeStrategy==="output")return ue(e.out._def,t);let a=ue(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),r=ue(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]});return{allOf:[a,r].filter(n=>n!==void 0)}};function iw(e,t){return ue(e.type._def,t)}function sw(e,t){let a={type:"array",uniqueItems:!0,items:ue(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&fe(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&fe(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}function ow(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((a,r)=>ue(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[]),additionalItems:ue(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((a,r)=>ue(a._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((a,r)=>r===void 0?a:[...a,r],[])}}function lw(){return{not:{}}}function uw(){return{}}var cw=(e,t)=>ue(e.innerType._def,t);function ue(e,t,a=!1){let r=t.seen.get(e);if(t.override){let s=t.override?.(e,t,r,a);if(s!==$v)return s}if(r&&!a){let s=dw(r,t);if(s!==void 0)return"$ref"in s&&t.seenRefs.add(s.$ref),s}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=pw(e,e.typeName,t,a);return i&&fw(e,t,i),n.jsonSchema=i,i}var dw=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let a=e.path.slice(t.basePath.length+1).join("_");return a!==t.name&&t.nameStrategy==="duplicate-ref"&&(t.definitions[a]=e.def),{$ref:[...t.basePath,t.definitionPath,a].join("/")};case"relative":return{$ref:hw(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,n)=>t.currentPath[n]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):t.$refStrategy==="seen"?{}:void 0}},hw=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")},pw=(e,t,a,r)=>{switch(t){case v.ZodString:return uh(e,a);case v.ZodNumber:return ew(e,a);case v.ZodObject:return aw(e,a);case v.ZodBigInt:return Lv(e,a);case v.ZodBoolean:return Mv();case v.ZodDate:return lh(e,a);case v.ZodUndefined:return lw();case v.ZodNull:return Xv(a);case v.ZodArray:return Cv(e,a);case v.ZodUnion:case v.ZodDiscriminatedUnion:return Yv(e,a);case v.ZodIntersection:return Hv(e,a);case v.ZodTuple:return ow(e,a);case v.ZodRecord:return dh(e,a);case v.ZodLiteral:return Jv(e,a);case v.ZodEnum:return Zv(e);case v.ZodNativeEnum:return Kv(e);case v.ZodNullable:return Qv(e,a);case v.ZodOptional:return rw(e,a);case v.ZodMap:return Wv(e,a);case v.ZodSet:return sw(e,a);case v.ZodLazy:return ue(e.getter()._def,a);case v.ZodPromise:return iw(e,a);case v.ZodNaN:case v.ZodNever:return Vv();case v.ZodEffects:return Bv(e,a,r);case v.ZodAny:return Nv();case v.ZodUnknown:return uw();case v.ZodDefault:return Fv(e,a);case v.ZodBranded:return Uv(e,a);case v.ZodReadonly:return cw(e,a);case v.ZodCatch:return zv(e,a);case v.ZodPipeline:return nw(e,a);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(n=>{})(t)}},fw=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a),mw=(e,t)=>{let a=Rv(t),r=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,n=ue(e._def,r===void 0?a:{...a,currentPath:[...a.basePath,a.definitionPath,r]},!1)??{},i=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;i!==void 0&&(n.title=i);let s=(()=>{if(jv(a.definitions))return;let l={},u=new Set;for(let c=0;c<500;c++){let d=Object.entries(a.definitions).filter(([h])=>!u.has(h));if(d.length===0)break;for(let[h,p]of d)l[h]=ue(Yo(p),{...a,currentPath:[...a.basePath,a.definitionPath,h]},!0)??{},u.add(h)}return l})(),o=r===void 0?s?{...n,[a.definitionPath]:s}:n:a.nameStrategy==="duplicate-ref"?{...n,...s||a.seenRefs.size?{[a.definitionPath]:{...s,...a.seenRefs.size?{[r]:n}:void 0}}:void 0}:{$ref:[...a.$refStrategy==="relative"?[]:a.basePath,a.definitionPath,r].join("/"),[a.definitionPath]:{...s,[r]:n}};return a.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":a.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function ph(e,t){return mw(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function gw(e,t,a){return Tb({type:"json_schema",json_schema:{...a,name:t,strict:!0,schema:ph(e,{name:t})}},r=>e.parse(JSON.parse(r)))}function yw(e){return jb({type:"function",function:{name:e.name,parameters:ph(e.parameters,{name:e.name}),strict:!0,...e.description?{description:e.description}:void 0}},{callback:e.function,parser:t=>e.parameters.parse(JSON.parse(t))})}function _w(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:a,azureOpenAIApiKey:r,azureOpenAIBasePath:n,baseURL:i,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((r||s)&&n&&t)return`${n}/${t}`;if((r||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||s){if(!a)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${a}.openai.azure.com/openai/deployments/${t}`}return i}function bw(e){return e!==void 0&&Array.isArray(e.lc_namespace)}function vw(e){return e!==void 0&&Ie.isRunnable(e)&&"lc_name"in e.constructor&&typeof e.constructor.lc_name=="function"&&e.constructor.lc_name()==="RunnableToolLike"}function ww(e){return!!e&&typeof e=="object"&&"name"in e&&"schema"in e&&(zn(e.schema)||e.schema!=null&&typeof e.schema=="object"&&"type"in e.schema&&typeof e.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function Ow(e){return ww(e)||vw(e)||bw(e)}function Ew(e,t){let a=typeof t=="number"?void 0:t;return{name:e.name,description:e.description,parameters:Dn(e.schema),...a?.strict!==void 0?{strict:a.strict}:{}}}function xi(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function fh(e){let t;return e.constructor.name===qn.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===Ve.name?(t=new Error(e.message),t.name="AbortError"):e.status===400&&e.message.includes("tool_calls")?t=xi(e,"INVALID_TOOL_RESULTS"):e.status===401?t=xi(e,"MODEL_AUTHENTICATION"):e.status===429?t=xi(e,"MODEL_RATE_LIMIT"):e.status===404?t=xi(e,"MODEL_NOT_FOUND"):t=e,t}function kw(e){if(e)return e==="any"||e==="required"?"required":e==="auto"?"auto":e==="none"?"none":typeof e=="string"?{type:"function",function:{name:e}}:e}function xw(e){return e.anyOf!==void 0&&Array.isArray(e.anyOf)}function Aw(e){let t=["namespace functions {",""];for(let a of e)a.description&&t.push(`// ${a.description}`),Object.keys(a.parameters.properties??{}).length>0?(t.push(`type ${a.name} = (_: {`),t.push(mh(a.parameters,0)),t.push("}) => any;")):t.push(`type ${a.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join(`
`)}function mh(e,t){let a=[];for(let[r,n]of Object.entries(e.properties??{}))n.description&&t<2&&a.push(`// ${n.description}`),e.required?.includes(r)?a.push(`${r}: ${Ai(n,t)},`):a.push(`${r}?: ${Ai(n,t)},`);return a.map(r=>" ".repeat(t)+r).join(`
`)}function Ai(e,t){if(xw(e))return e.anyOf.map(a=>Ai(a,t)).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map(a=>`"${a}"`).join(" | "):"string";case"number":return e.enum?e.enum.map(a=>`${a}`).join(" | "):"number";case"integer":return e.enum?e.enum.map(a=>`${a}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",mh(e,t+2),"}"].join(`
`);case"array":return e.items?`${Ai(e.items,t)}[]`:"any[]";default:return""}}function Iw(e,t){let a;if(Ow(e)){let r=yw({name:e.name,parameters:e.schema,description:e.description});r.function.parameters?a={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...t?.strict!==void 0?{strict:t.strict}:{}}}:a={type:"function",function:Ew(e,t)}}else a=e;return t?.strict!==void 0&&(a.function.strict=t.strict),a}function Sw(e){return e.role!=="system"&&e.role!=="developer"&&e.role!=="assistant"&&e.role!=="user"&&e.role!=="function"&&e.role!=="tool"&&console.warn(`Unknown message role: ${e.role}`),e.role}function gh(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Gi.isInstance(e))throw new Error("Invalid generic chat message");return Sw(e)}default:throw new Error(`Unknown message type: ${t}`)}}function Pw(e,t,a){let r=e.tool_calls;switch(e.role){case"assistant":{let n=[],i=[];for(let l of r??[])try{n.push(nh(l,{returnId:!0}))}catch(u){i.push(Sv(l,u.message))}let s={function_call:e.function_call,tool_calls:r};a!==void 0&&(s.__raw_response=t);let o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(s.audio=e.audio),new on({content:e.content||"",tool_calls:n,invalid_tool_calls:i,additional_kwargs:s,response_metadata:o,id:t.id})}default:return new Gi(e.content||"",e.role??"unknown")}}function $w(e,t,a,r){let n=e.role??a,i=e.content??"",s;e.function_call?s={function_call:e.function_call}:e.tool_calls?s={tool_calls:e.tool_calls}:s={},r&&(s.__raw_response=t),e.audio&&(s.audio={...e.audio,index:t.choices[0].index});let o={usage:{...t.usage}};if(n==="user")return new kl({content:i,response_metadata:o});if(n==="assistant"){let l=[];if(Array.isArray(e.tool_calls))for(let u of e.tool_calls)l.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new Ya({content:i,tool_call_chunks:l,additional_kwargs:s,id:t.id,response_metadata:o})}else return n==="system"?new Ki({content:i,response_metadata:o}):n==="developer"?new Ki({content:i,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):n==="function"?new El({content:i,additional_kwargs:s,name:e.name,response_metadata:o}):n==="tool"?new Qp({content:i,additional_kwargs:s,tool_call_id:e.tool_call_id,response_metadata:o}):new Ol({content:i,role:n,response_metadata:o})}function yh(e,t){return e.flatMap(a=>{let r=gh(a);r==="system"&&t?.startsWith("o1")&&(r="developer");let n={role:r,content:a.content};if(a.name!=null&&(n.name=a.name),a.additional_kwargs.function_call!=null&&(n.function_call=a.additional_kwargs.function_call,n.content=null),ln(a)&&a.tool_calls?.length?(n.tool_calls=a.tool_calls.map(Iv),n.content=null):(a.additional_kwargs.tool_calls!=null&&(n.tool_calls=a.additional_kwargs.tool_calls),a.tool_call_id!=null&&(n.tool_call_id=a.tool_call_id)),a.additional_kwargs.audio&&typeof a.additional_kwargs.audio=="object"&&"id"in a.additional_kwargs.audio){let i={role:"assistant",audio:{id:a.additional_kwargs.audio.id}};return[n,i]}return n})}function _h(e,t){return wv(e)?t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e:Iw(e,t)}var Tw=class extends kv{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??Re("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Re("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Re("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Re("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Re("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Re("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Re("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??Re("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){let a=this.azureOpenAIBasePath.split("/openai/deployments/");if(a.length===2){let[,r]=a;this.azureOpenAIApiDeploymentName=r}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.model==="o1"&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let a;return t?.strict!==void 0?a=t.strict:this.supportsStrictToolCalling!==void 0&&(a=this.supportsStrictToolCalling),this.bind({tools:e.map(r=>_h(r,{strict:a})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&Ii(e.json_schema.schema)?gw(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let a;e?.strict!==void 0?a=e.strict:this.supportsStrictToolCalling!==void 0&&(a=this.supportsStrictToolCalling);let r={};e?.stream_options!==void 0?r={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(r={stream_options:{include_usage:!0}});let n={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(s=>_h(s,{strict:a})):void 0,tool_choice:kw(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...r,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(n.prediction=e.prediction);let i=e?.reasoning_effort??this.reasoningEffort;return i!==void 0&&(n.reasoning_effort=i),n}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,a){let r=yh(e,this.model),n={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0},i,s=await this.completionWithRetry(n,t),o;for await(let l of s){let u=l?.choices?.[0];if(l.usage&&(o=l.usage),!u)continue;let{delta:c}=u;if(!c)continue;let d=$w(c,l,i,this.__includeRawResponse);i=c.role??i;let h={prompt:t.promptIndex??0,completion:u.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let p={...h};u.finish_reason!=null&&(p.finish_reason=u.finish_reason,p.system_fingerprint=l.system_fingerprint,p.model_name=l.model),this.logprobs&&(p.logprobs=u.logprobs);let f=new Pn({message:d,text:d.content,generationInfo:p});yield f,await a?.handleLLMNewToken(f.text??"",h,void 0,void 0,void 0,{chunk:f})}if(o){let l={...o.prompt_tokens_details?.audio_tokens!==null&&{audio:o.prompt_tokens_details?.audio_tokens},...o.prompt_tokens_details?.cached_tokens!==null&&{cache_read:o.prompt_tokens_details?.cached_tokens}},u={...o.completion_tokens_details?.audio_tokens!==null&&{audio:o.completion_tokens_details?.audio_tokens},...o.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:o.completion_tokens_details?.reasoning_tokens}};yield new Pn({message:new Ya({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(l).length>0&&{input_token_details:l},...Object.keys(u).length>0&&{output_token_details:u}}}),text:""})}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,a){let r={},n=this.invocationParams(t),i=yh(e,this.model);if(n.stream){let s=this._streamResponseChunks(e,t,a),o={};for await(let p of s){p.message.response_metadata={...p.generationInfo,...p.message.response_metadata};let f=p.generationInfo?.completion??0;o[f]===void 0?o[f]=p:o[f]=o[f].concat(p)}let l=Object.entries(o).sort(([p],[f])=>parseInt(p,10)-parseInt(f,10)).map(([p,f])=>f),{functions:u,function_call:c}=this.invocationParams(t),d=await this.getEstimatedTokenCountFromPrompt(e,u,c),h=await this.getNumTokensFromGenerations(l);return r.input_tokens=d,r.output_tokens=h,r.total_tokens=d+h,{generations:l,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}else{let s;t.response_format&&t.response_format.type==="json_schema"?s=await this.betaParsedCompletionWithRetry({...n,stream:!1,messages:i},{signal:t?.signal,...t?.options}):s=await this.completionWithRetry({...n,stream:!1,messages:i},{signal:t?.signal,...t?.options});let{completion_tokens:o,prompt_tokens:l,total_tokens:u,prompt_tokens_details:c,completion_tokens_details:d}=s?.usage??{};o&&(r.output_tokens=(r.output_tokens??0)+o),l&&(r.input_tokens=(r.input_tokens??0)+l),u&&(r.total_tokens=(r.total_tokens??0)+u),(c?.audio_tokens!==null||c?.cached_tokens!==null)&&(r.input_token_details={...c?.audio_tokens!==null&&{audio:c?.audio_tokens},...c?.cached_tokens!==null&&{cache_read:c?.cached_tokens}}),(d?.audio_tokens!==null||d?.reasoning_tokens!==null)&&(r.output_token_details={...d?.audio_tokens!==null&&{audio:d?.audio_tokens},...d?.reasoning_tokens!==null&&{reasoning:d?.reasoning_tokens}});let h=[];for(let p of s?.choices??[]){let f={text:p.message?.content??"",message:Pw(p.message??{role:"assistant"},s,this.__includeRawResponse)};f.generationInfo={...p.finish_reason?{finish_reason:p.finish_reason}:{},...p.logprobs?{logprobs:p.logprobs}:{}},ln(f.message)&&(f.message.usage_metadata=r),f.message=new on(Object.fromEntries(Object.entries(f.message).filter(([m])=>!m.startsWith("lc_")))),h.push(f)}return{generations:h,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,a){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&a!=="auto"){let n=Aw(t);r+=await this.getNumTokens(n),r+=9}return t&&e.find(n=>n._getType()==="system")&&(r-=4),a==="none"?r+=1:typeof a=="object"&&(r+=await this.getNumTokens(a.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async t=>t.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([t.message])).countPerMessage[0]:await this.getNumTokens(t.message.content)))).reduce((t,a)=>t+a,0)}async getNumTokensFromMessages(e){let t=0,a=0,r=0;this.model==="gpt-3.5-turbo-0301"?(a=4,r=-1):(a=3,r=1);let n=await Promise.all(e.map(async i=>{let s=await this.getNumTokens(i.content),o=await this.getNumTokens(gh(i)),l=i.name!==void 0?r+await this.getNumTokens(i.name):0,u=s+a+o+l,c=i;if(c._getType()==="function"&&(u-=2),c.additional_kwargs?.function_call&&(u+=3),c?.additional_kwargs.function_call?.name&&(u+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(c.additional_kwargs.function_call)),u+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:n}}async completionWithRetry(e,t){let a=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,a)}catch(r){throw fh(r)}})}async betaParsedCompletionWithRetry(e,t){let a=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,a)}catch(r){throw fh(r)}})}_getClientOptions(e){if(!this.client){let a={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},r=_w(a),n={...this.clientConfig,baseURL:r,timeout:this.timeout,maxRetries:0};n.baseURL||delete n.baseURL,this.client=new Q(n)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,a)=>(a&&a.tokenUsage&&(t.tokenUsage.completionTokens+=a.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=a.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=a.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let a,r,n,i;jw(e)?(a=e.schema,r=e.name,n=e.method,i=e.includeRaw):(a=e,r=t?.name,n=t?.method,i=t?.includeRaw);let s,o;if(t?.strict!==void 0&&n==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(n==="jsonMode")s=this.bind({response_format:{type:"json_object"}}),Ii(a)?o=ah.fromZodSchema(a):o=new rh;else if(n==="jsonSchema")s=this.bind({response_format:{type:"json_schema",json_schema:{name:r??"extract",description:a.description,schema:a,strict:t?.strict}}}),Ii(a)?o=ah.fromZodSchema(a):o=new rh;else{let d=r??"extract";if(Ii(a)){let h=nc(a);s=this.bind({tools:[{type:"function",function:{name:d,description:h.description,parameters:h}}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new ih({returnSingle:!0,keyName:d,zodSchema:a})}else{let h;typeof a.name=="string"&&typeof a.parameters=="object"&&a.parameters!=null?(h=a,d=a.name):(d=a.title??d,h={name:d,description:a.description??"",parameters:a}),s=this.bind({tools:[{type:"function",function:h}],tool_choice:{type:"function",function:{name:d}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new ih({returnSingle:!0,keyName:d})}}if(!i)return s.pipe(o);let l=Ei.assign({parsed:(d,h)=>o.invoke(d.raw,h)}),u=Ei.assign({parsed:()=>null}),c=l.withFallbacks({fallbacks:[u]});return Fn.from([{raw:s},c])}};function Ii(e){return typeof e?.parse=="function"}function jw(e){return e!==void 0&&typeof e.schema=="object"}var Rw=class extends Qd{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let a,r=ce(Ts(this.defaultConfig,t));return er(e)?(a=e.args,r={...r,toolCall:e}):a=e,this.call(a,r)}async call(e,t,a){let r=er(e)?e.args:e,n;if(zn(this.schema))try{n=await zs(this.schema,r)}catch(h){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${h.message}`),new Vi(p,JSON.stringify(e))}else{let h=ge(r,this.schema);if(!h.valid){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${h.errors.map(f=>`${f.keywordLocation}: ${f.error}`).join(`
`)}`),new Vi(p,JSON.stringify(e))}n=r}let i=Iy(t),s=await Et.configure(i.callbacks,this.callbacks,i.tags||a,this.tags,i.metadata,this.metadata,{verbose:this.verbose})?.handleToolStart(this.toJSON(),typeof e=="string"?e:JSON.stringify(e),i.runId,void 0,void 0,void 0,i.runName);delete i.runId;let o;try{o=await this._call(n,s,i)}catch(h){throw await s?.handleToolError(h),h}let l,u;if(this.responseFormat==="content_and_artifact")if(Array.isArray(o)&&o.length===2)[l,u]=o;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(o)}`);else l=o;let c;er(e)&&(c=e.id),!c&&tf(i)&&(c=i.toolCall.id);let d=Cw({content:l,artifact:u,toolCallId:c,name:this.name,metadata:this.metadata});return await s?.handleToolEnd(d),d}},Nw=class extends Rw{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Lt.object({input:Lt.string().optional()}).transform(t=>t.input)})}call(e,t){let a=typeof e=="string"||e==null?{input:e}:e;return super.call(a,t)}};function Cw(e){let{content:t,artifact:a,toolCallId:r,metadata:n}=e;return r&&!Yp(t)?typeof t=="string"||Array.isArray(t)&&t.every(i=>typeof i=="object")?new Ji({status:"success",content:t,artifact:a,tool_call_id:r,name:e.name,metadata:n}):new Ji({status:"success",content:Lw(t),artifact:a,tool_call_id:r,name:e.name,metadata:n}):t}function Lw(e){try{return JSON.stringify(e,null,2)??""}catch{return`${e}`}}var Mw=class extends Nw{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??Re("OPENAI_API_KEY"),a=e?.organization??Re("OPENAI_ORGANIZATION"),r={apiKey:t,organization:a,dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new Q(r),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(a=>a.url?{type:"image_url",image_url:a.url}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="string"&&a.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(a=>a.b64_json?{type:"image_url",image_url:{url:a.b64_json}}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="object"&&"url"in a.image_url&&typeof a.image_url.url=="string"&&a.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let n=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(n)}let a=await this.client.images.generate(t),r="";return this.dallEResponseFormat==="url"?[r]=a.data.map(n=>n.url).filter(n=>n!=="undefined"):[r]=a.data.map(n=>n.b64_json).filter(n=>n!=="undefined"),r}};Object.defineProperty(Mw,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var bh={MODEL:"google/gemini-2.5-flash-lite",MAX_SEGMENTS_PER_CHUNK:50,CHUNK_SENTINEL:"<<<__CHUNK_END__>>>"};function vh(e,t){let a=[],r=e.length,n=0;for(;n<r;){let i=Math.min(n+t,r);a.push([n,i]),n=i}return a}function Uw(e,t,a,r){if(!e||!t.length)return t;let n=e.split(a),i=vh(t,r);for(;n.length<i.length;)n.push("");let s=[];for(let o=0;o<i.length;o++){let[l,u]=i[o],c=t.slice(l,u),d=(n[o]||"").trim().split(`
`).filter(h=>h.trim());for(let h=0;h<c.length;h++){let p=c[h],f=h<d.length?d[h].trim():p.text;s.push({text:f||p.text,startMs:p.startMs,endMs:p.endMs,startTimeText:p.startTimeText})}}return s}async function zw(e,t,a,r,n=null){if(!e?.length)throw new Error("No transcript segments provided");let{MODEL:i,MAX_SEGMENTS_PER_CHUNK:s,CHUNK_SENTINEL:o}=bh,l=`You are correcting segments of a YouTube video transcript. These segments could be from anywhere in the video (beginning, middle, or end). Use the video title and description for context.

CRITICAL CONSTRAINTS:
- Only fix typos and grammar. Do NOT change meaning or structure.
- PRESERVE ALL NEWLINES: each line is a distinct transcript segment.
- Do NOT add, remove, or merge lines. Keep the same number of lines.
- MAINTAIN SIMILAR LINE LENGTHS: Each output line should be approximately the same character count as its corresponding input line (\xB110% tolerance). Do NOT expand short lines into long paragraphs. Do NOT condense long lines significantly. Keep each line concise.
- If a sentence is broken across lines, keep it broken the same way.
- PRESERVE THE ORIGINAL LANGUAGE: output must be in the same language as the input transcript.
- Focus on minimal corrections: fix typos, correct grammar errors, but keep expansions/additions to an absolute minimum.

EXAMPLES OF CORRECT BEHAVIOR:

Input:
up to 900. From 900 up to 1,100.
If you sold at the reasonable
valuations, when the gains that already
been had, you missed out big time. I

Output:
up to $900. From $900 up to $1,100.
If you sold at the reasonable
valuations, when the gains that already
had been had, you missed out big time. I`,u=`Video Title: ${t||""}
Video Description: ${a||""}

Transcript Chunk:`,c=vh(e,s),d=Date.now();console.log(`
${"=".repeat(80)}`),console.log("CHUNK ARRANGEMENT"),console.log(`${"=".repeat(80)}`),console.log(`Total segments: ${e.length}`),console.log(`Total chunks: ${c.length}`),console.log(`
Chunk details:`),c.forEach(([b,w],O)=>{let I=w-b;console.log(`  Chunk ${O+1}: segments ${b}-${w-1} (${I} segments)`)}),console.log(`${"=".repeat(80)}
`),console.log(`Processing ${c.length} chunks in parallel...`);let h=new Tw({model:i,apiKey:r,configuration:{baseURL:"https://openrouter.ai/api/v1",defaultHeaders:{"HTTP-Referer":typeof chrome<"u"&&chrome.runtime?chrome.runtime.getURL(""):"https://github.com/better-youtube-caption","X-Title":"Better YouTube Caption"}},temperature:0,useResponsesApi:!0,reasoning:{effort:"minimal"},extraBody:{include_reasoning:!1,provider:{sort:"throughput"}}}),p=[],f=[];for(let b=0;b<c.length;b++){let[w,O]=c[b],I=e.slice(w,O),D=I.length,j=I.map(k=>(k.text||"").split(/\s+/).join(" ")).join(`
`),K=[new Wi(l),new Qa(`${u}
${j}`)];p.push(K),f.push({chunkIdx:b+1,startIdx:w,endIdx:O,expectedLineCount:D})}let m;try{m=await h.batch(p)}catch(b){throw console.error("Batch processing failed:",b),new Error(`LLM batch refinement failed: ${b.message}`)}let g=[];for(let b=0;b<m.length;b++){let w=m[b],O=f[b],I=O.chunkIdx,D=O.expectedLineCount,j=w.content;w.content_blocks&&w.content_blocks.length>0&&(j=w.content_blocks[0].text||j);let K=j.trim().split(`
`),k=K.length;console.log(`  Chunk ${I} completed: received ${k} lines (expected ${D})`),k!==D&&console.warn(`  \u26A0\uFE0F  WARNING: Line count mismatch in chunk ${I}!`),g.push(...K),g.push(o),n&&n(I,c.length)}console.log(`All chunks completed in ${((Date.now()-d)/1e3).toFixed(2)}s`);let _=g.join(`
`),y=Uw(_,e,o,s);return console.log(`Refinement complete: ${y.length} segments`),y}typeof globalThis<"u"&&(globalThis.refineTranscriptWithLLM=zw,globalThis.REFINER_CONFIG=bh)})();})();
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/js-sha256/hash.js:
  (**
   * [js-sha256]{@link https://github.com/emn178/js-sha256}
   *
   * @version 0.11.1
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2025
   * @license MIT
   *)
*/
//# sourceMappingURL=captionRefiner.bundle.js.map
